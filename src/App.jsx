import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
import {
  ShieldCheck,
  LayoutDashboard,
  FileText,
  Users,
  Box,
  Search,
  Bell,
  Plus,
  Filter,
  Download,
  CheckCircle2,
  AlertTriangle,
  Clock,
  Share2,
  Lock,
  FileSignature,
  X,
  ChevronRight,
  Activity,
  Sun,
  Moon,
  Calendar,
  MapPin,
  Building2,
  Tag,
  Info,
  ChevronDown,
  Loader2,
  History,
  Settings,
  Command,
  Sparkles,
  UploadCloud,
  BarChart3,
  ClipboardList,
  Map as MapIcon,
  LocateFixed,
  Zap,
  ArrowUpRight,
  QrCode,
  ScanLine,
  Printer,
  Copy,
  Wifi,
  WifiOff,
  Camera,
  CameraOff,
  LogOut,
  ServerCog,
  Gauge,
} from 'lucide-react';
import QRCode from 'qrcode';
import { jsPDF } from 'jspdf';
import {
  aooTemplateCatalog,
  defaultInspectionTemplates,
  defaultTemplateBlueprints,
  defaultTemplateListings,
  templateCategoryOptions,
  templateRegimeOptions,
} from './aooTemplates';
import InCertLogo from './InCertLogo';
import OperationsCenterView from './OperationsCenterView';
import { rankBidEntries } from './lib/opsScoring';
import { isSupabaseConfigured, supabase } from './lib/supabaseClient';

const AUDIT_EXECUTION_MODES = {
  INCERT_TEMPLATE: 'incert_template',
  AUDITOR_SOFTWARE: 'auditor_software',
};

const EXTERNAL_AUDIT_REVIEW_STATUSES = {
  NOT_REQUIRED: 'not_required',
  PENDING_EVIDENCE: 'pending_evidence',
  PENDING_REVIEW: 'pending_review',
  APPROVED: 'approved',
  REJECTED: 'rejected',
};

const USER_ROLE_OPTIONS = [
  { id: 'company', label: 'Company' },
  { id: 'auditor', label: 'Auditor' },
  { id: 'third_party', label: 'Audit Company' },
  { id: 'insurer', label: 'Insurer' },
  { id: 'incert', label: 'InCert' },
];

const USER_ROLE_TAB_ACCESS = {
  company: ['dashboard', 'onboarding', 'assets', 'vault', 'marketplace', 'accountancy', 'help'],
  auditor: ['marketplace', 'accountancy', 'help'],
  third_party: ['marketplace', 'accountancy', 'help'],
  insurer: ['marketplace', 'help'],
  incert: ['dashboard', 'onboarding', 'assets', 'vault', 'providers', 'marketplace', 'accountancy', 'ops', 'templates', 'help'],
};

const SUPABASE_ENV_CONFIGURED = isSupabaseConfigured;
const SUPPORTED_REGIMES = Array.from(
  new Set(templateRegimeOptions.map((regime) => String(regime || '').trim().toUpperCase()).filter(Boolean))
);
const FALLBACK_PROVIDER_REGIMES = SUPPORTED_REGIMES.length > 0 ? SUPPORTED_REGIMES : ['LOLER', 'PUWER', 'PSSR'];

// --- INITIAL MOCK DATA ---
const initialAssets = [
  {
    id: 'AST-001',
    name: 'Passenger Lift A',
    site: 'London HQ',
    class: 'Lift',
    regime: 'LOLER',
    nextDue: '2026-03-15',
  },
  {
    id: 'AST-002',
    name: 'Goods Lift B',
    site: 'Manchester Depot',
    class: 'Lift',
    regime: 'LOLER',
    nextDue: '2026-02-10',
  },
  {
    id: 'AST-003',
    name: 'Forklift FL-01',
    site: 'Birmingham Whse',
    class: 'Lifting Eq.',
    regime: 'LOLER',
    nextDue: '2026-04-22',
  },
  {
    id: 'AST-004',
    name: 'Air Compressor',
    site: 'London HQ',
    class: 'Pressure Vessel',
    regime: 'PSSR',
    nextDue: '2026-05-10',
  },
  {
    id: 'AST-005',
    name: 'Pallet Stacker',
    site: 'Manchester Depot',
    class: 'Work Eq.',
    regime: 'PUWER',
    nextDue: '2026-02-28',
  },
];

const initialCertificates = [
  {
    id: 'CERT-2025-8831',
    assetId: 'AST-001',
    assetName: 'Passenger Lift A',
    regime: 'LOLER',
    provider: 'Bureau Veritas UK',
    issueDate: '2025-09-15',
    expiryDate: '2026-03-15',
    hash: 'e3b0...2b855',
  },
  {
    id: 'CERT-2025-7210',
    assetId: 'AST-003',
    assetName: 'Forklift FL-01',
    regime: 'LOLER',
    provider: 'Allianz Eng',
    issueDate: '2025-10-22',
    expiryDate: '2026-04-22',
    hash: '8d96...6c92',
  },
  {
    id: 'CERT-2024-1102',
    assetId: 'AST-002',
    assetName: 'Goods Lift B',
    regime: 'LOLER',
    provider: 'Bureau Veritas UK',
    issueDate: '2024-08-10',
    expiryDate: '2025-08-10',
    hash: 'f2ca...6fd2',
  },
  {
    id: 'CERT-2025-9921',
    assetId: 'AST-004',
    assetName: 'Air Compressor',
    regime: 'PSSR',
    provider: 'Zurich Resilience',
    issueDate: '2025-05-10',
    expiryDate: '2026-05-10',
    hash: 'b94d...de9',
  },
];

const mockProviders = [
  {
    id: 'PRV-1',
    name: 'Bureau Veritas UK',
    tier: 'UKAS Accredited',
    employmentModel: 'direct',
    regimes: ['LOLER', 'PUWER', 'PSSR'],
    activeJobs: 12,
    maxConcurrentJobs: 16,
    rating: 4.9,
    avgResponseMins: 42,
    completedAudits: 1480,
    completionRate: 98,
    baseLocation: 'London',
    availability: {
      weekdays: [1, 2, 3, 4, 5],
      weekend: true,
    },
    rateCards: {
      LOLER: { hourlyRate: 94, minimumCallout: 220, travelPerKm: 1.45, platformFeePct: 0.45 },
      PUWER: { hourlyRate: 88, minimumCallout: 190, travelPerKm: 1.35, platformFeePct: 0.45 },
      PSSR: { hourlyRate: 112, minimumCallout: 260, travelPerKm: 1.55, platformFeePct: 0.45 },
    },
  },
  {
    id: 'PRV-2',
    name: 'Allianz Engineering',
    tier: 'Insurer Network',
    employmentModel: 'direct',
    regimes: ['LOLER', 'PSSR'],
    activeJobs: 5,
    maxConcurrentJobs: 10,
    rating: 4.7,
    avgResponseMins: 58,
    completedAudits: 1025,
    completionRate: 96,
    baseLocation: 'Manchester',
    availability: {
      weekdays: [1, 2, 3, 4, 5],
      weekend: false,
    },
    rateCards: {
      LOLER: { hourlyRate: 89, minimumCallout: 200, travelPerKm: 1.2, platformFeePct: 0.45 },
      PSSR: { hourlyRate: 104, minimumCallout: 240, travelPerKm: 1.35, platformFeePct: 0.45 },
    },
  },
  {
    id: 'PRV-3',
    name: 'Zurich Resilience',
    tier: 'Insurer Network',
    employmentModel: 'direct',
    regimes: ['PSSR'],
    activeJobs: 2,
    maxConcurrentJobs: 8,
    rating: 4.6,
    avgResponseMins: 73,
    completedAudits: 610,
    completionRate: 95,
    baseLocation: 'Birmingham',
    availability: {
      weekdays: [1, 2, 3, 4, 5, 6],
      weekend: true,
    },
    rateCards: {
      PSSR: { hourlyRate: 108, minimumCallout: 250, travelPerKm: 1.4, platformFeePct: 0.45 },
    },
  },
  {
    id: 'PRV-4',
    name: 'NorthStar Inspection Partners',
    tier: 'Audit Company Network',
    employmentModel: 'third_party',
    thirdPartyOrganizationId: 'TP-001',
    thirdPartyMarginPct: 0.1,
    regimes: ['LOLER', 'PUWER', 'PSSR'],
    activeJobs: 4,
    maxConcurrentJobs: 12,
    rating: 4.8,
    avgResponseMins: 47,
    completedAudits: 790,
    completionRate: 97,
    baseLocation: 'Leeds',
    availability: {
      weekdays: [1, 2, 3, 4, 5, 6],
      weekend: true,
    },
    rateCards: {
      LOLER: { hourlyRate: 92, minimumCallout: 210, travelPerKm: 1.35, platformFeePct: 0.45 },
      PUWER: { hourlyRate: 86, minimumCallout: 190, travelPerKm: 1.25, platformFeePct: 0.45 },
      PSSR: { hourlyRate: 109, minimumCallout: 255, travelPerKm: 1.45, platformFeePct: 0.45 },
    },
  },
];

const thirdPartyOrganizations = [
  {
    id: 'TP-001',
    name: 'NorthStar Inspection Partners',
    marginPct: 0.1,
    assignmentLead: 'NorthStar Operations Desk',
    auditors: [
      { id: 'TPA-001', name: 'Hannah Briggs', regimes: ['LOLER', 'PUWER'] },
      { id: 'TPA-002', name: 'Rahul Menon', regimes: ['PSSR', 'PUWER'] },
      { id: 'TPA-003', name: 'Elaine Carter', regimes: ['LOLER', 'PSSR'] },
    ],
  },
];

const mockTemplatePreviewAssetRefs = [
  { assetId: 'AST-001', assetName: 'Passenger Lift A', site: 'London HQ' },
  { assetId: 'AST-002', assetName: 'Goods Lift B', site: 'Manchester Depot' },
  { assetId: 'AST-003', assetName: 'Forklift FL-01', site: 'Birmingham Whse' },
  { assetId: 'AST-004', assetName: 'Air Compressor', site: 'London HQ' },
  { assetId: 'AST-005', assetName: 'Pallet Stacker', site: 'Manchester Depot' },
];

function buildAooTemplatePreviewJobs() {
  const baseCreatedAt = new Date('2026-02-22T09:00:00Z');

  return aooTemplateCatalog.map((template, index) => {
    const assetRef = mockTemplatePreviewAssetRefs[index % mockTemplatePreviewAssetRefs.length];
    const controlCount = Array.isArray(template?.questions)
      ? template.questions.filter((question) => String(question?.type || '').toLowerCase() === 'boolean').length
      : 4;
    const createdAt = new Date(baseCreatedAt.getTime() - index * 24 * 60 * 60 * 1000);
    const dueDate = new Date(baseCreatedAt.getTime() + (7 + index) * 24 * 60 * 60 * 1000);
    const dispatchedAt = new Date(createdAt.getTime() + 20 * 60 * 1000);
    const offerExpiresAt = new Date(createdAt.getTime() + 95 * 60 * 1000);
    const acceptedAt = new Date(createdAt.getTime() + 50 * 60 * 1000);

    return {
      id: `JOB-${String(2001 + index).padStart(4, '0')}`,
      companyName: 'Acme Logistics',
      companyId: 'acme-logistics',
      assetId: assetRef.assetId,
      assetName: `${assetRef.assetName} (${template.name})`,
      site: assetRef.site,
      regime: String(template?.regime || 'LOLER').toUpperCase(),
      inspectionTemplateId: `TPL-AOO-${String(index + 1).padStart(2, '0')}`,
      inspectionTemplateName: template.name,
      status: 'in_progress',
      dueDate: dueDate.toISOString().slice(0, 10),
      budget: 240 + controlCount * 18,
      createdAt: createdAt.toISOString().slice(0, 10),
      matchedAuditorId: 'PRV-1',
      notes: `Template preview job for ${template.name}. Open Template in Auditor Portal to review ${controlCount} checklist controls.`,
      scope: {
        template: 'aoo_template_preview',
        assetCount: 1,
        estimatedHours: Number((Math.max(1.5, controlCount * 0.35)).toFixed(1)),
        complexity: index % 4 === 0 ? 'restricted' : 'standard',
        equipment: index % 3 === 0 ? 'specialist_instruments' : 'none',
        travelKm: 8 + (index % 5) * 3,
        weekendAccess: index % 6 === 0,
        expedite: index % 7 === 0,
      },
      dispatch: {
        slaMinutes: 360,
        dispatchDeadlineAt: new Date(createdAt.getTime() + 360 * 60 * 1000).toISOString(),
        dispatchedAt: dispatchedAt.toISOString(),
        offerExpiresAt: offerExpiresAt.toISOString(),
        acceptedAt: acceptedAt.toISOString(),
        attempts: 1,
      },
      documents: [],
      timeline: [
        { label: 'Template preview job created', at: createdAt.toISOString().slice(0, 10), actor: 'InCert Seed Data' },
        { label: 'Offer accepted', at: acceptedAt.toISOString().slice(0, 16).replace('T', ' '), actor: 'Bureau Veritas UK' },
        {
          label: `Audit started (${template.templateId})`,
          at: new Date(acceptedAt.getTime() + 30 * 60 * 1000).toISOString().slice(0, 16).replace('T', ' '),
          actor: 'Bureau Veritas UK',
        },
      ],
    };
  });
}

const initialMarketplaceJobs = [
  {
    id: 'JOB-1001',
    companyName: 'Acme Logistics',
    assetId: 'AST-002',
    assetName: 'Goods Lift B',
    site: 'Manchester Depot',
    regime: 'LOLER',
    status: 'open',
    dueDate: '2026-03-01',
    budget: 420,
    createdAt: '2026-02-20',
    matchedAuditorId: null,
    notes: 'Critical lift in dispatch zone. Evening access preferred.',
    scope: {
      template: 'urgent_defect_followup',
      assetCount: 1,
      estimatedHours: 2.5,
      complexity: 'out_of_hours',
      equipment: 'none',
      travelKm: 14,
      weekendAccess: false,
      expedite: true,
    },
    pricing: {
      labour: 276,
      travel: 20,
      equipment: 0,
      expedite: 53,
      platformFee: 38,
      total: 387,
    },
    dispatch: {
      slaMinutes: 120,
      dispatchDeadlineAt: '2026-02-20T12:00:00Z',
      dispatchedAt: null,
      offerExpiresAt: null,
      acceptedAt: null,
      attempts: 0,
    },
    documents: [],
    timeline: [
      { label: 'Job advertised', at: '2026-02-20', actor: 'Acme Logistics' },
      { label: 'Instant quote generated (Â£387)', at: '2026-02-20', actor: 'InCert Pricing Engine' },
    ],
  },
  {
    id: 'JOB-1002',
    companyName: 'Acme Logistics',
    assetId: 'AST-004',
    assetName: 'Air Compressor',
    site: 'London HQ',
    regime: 'PSSR',
    status: 'assigned',
    dueDate: '2026-03-10',
    budget: 360,
    createdAt: '2026-02-18',
    matchedAuditorId: 'PRV-1',
    notes: 'Written Scheme check and pressure relief validation.',
    scope: {
      template: 'written_scheme_review',
      assetCount: 1,
      estimatedHours: 3.5,
      complexity: 'standard',
      equipment: 'specialist_instruments',
      travelKm: 9,
      weekendAccess: false,
      expedite: false,
    },
    pricing: {
      labour: 351,
      travel: 13,
      equipment: 120,
      expedite: 0,
      platformFee: 48,
      total: 532,
    },
    dispatch: {
      slaMinutes: 360,
      dispatchDeadlineAt: '2026-02-18T15:00:00Z',
      dispatchedAt: '2026-02-18T10:05:00Z',
      offerExpiresAt: '2026-02-18T11:35:00Z',
      acceptedAt: '2026-02-18T10:38:00Z',
      attempts: 1,
    },
    documents: [],
    timeline: [
      { label: 'Job advertised', at: '2026-02-18', actor: 'Acme Logistics' },
      { label: 'Offer sent to Bureau Veritas UK', at: '2026-02-18 10:05', actor: 'InCert Match Engine' },
      { label: 'Auditor accepted offer', at: '2026-02-18 10:38', actor: 'Bureau Veritas UK' },
    ],
  },
  {
    id: 'JOB-1003',
    companyName: 'Acme Logistics',
    assetId: 'AST-003',
    assetName: 'Forklift FL-01',
    site: 'Birmingham Whse',
    regime: 'LOLER',
    status: 'in_progress',
    dueDate: '2026-02-26',
    budget: 290,
    createdAt: '2026-02-15',
    matchedAuditorId: 'PRV-2',
    notes: 'Audit in loading bay, supervisor escort required.',
    scope: {
      template: 'portfolio_sweep',
      assetCount: 2,
      estimatedHours: 3.1,
      complexity: 'restricted',
      equipment: 'none',
      travelKm: 22,
      weekendAccess: false,
      expedite: false,
    },
    pricing: {
      labour: 301,
      travel: 30,
      equipment: 0,
      expedite: 0,
      platformFee: 33,
      total: 364,
    },
    dispatch: {
      slaMinutes: 360,
      dispatchDeadlineAt: '2026-02-15T15:00:00Z',
      dispatchedAt: '2026-02-15T08:44:00Z',
      offerExpiresAt: '2026-02-15T10:14:00Z',
      acceptedAt: '2026-02-15T09:02:00Z',
      attempts: 1,
    },
    documents: ['pre-checklist.pdf'],
    timeline: [
      { label: 'Job advertised', at: '2026-02-15', actor: 'Acme Logistics' },
      { label: 'Auditor accepted job', at: '2026-02-16', actor: 'Allianz Engineering' },
      { label: 'Audit started', at: '2026-02-21', actor: 'Allianz Engineering' },
    ],
  },
  {
    id: 'JOB-1004',
    companyName: 'Acme Logistics',
    assetId: 'AST-005',
    assetName: 'Pallet Stacker',
    site: 'Manchester Depot',
    regime: 'PUWER',
    status: 'offered',
    dueDate: '2026-03-05',
    budget: 276,
    createdAt: '2026-02-21',
    matchedAuditorId: 'PRV-1',
    notes: 'Quarterly PUWER program with supervisor sign-off required.',
    scope: {
      template: 'portfolio_sweep',
      assetCount: 1,
      estimatedHours: 2,
      complexity: 'standard',
      equipment: 'none',
      travelKm: 18,
      weekendAccess: false,
      expedite: false,
    },
    pricing: {
      labour: 188,
      travel: 25,
      equipment: 0,
      expedite: 0,
      platformFee: 21,
      total: 234,
    },
    dispatch: {
      slaMinutes: 360,
      dispatchDeadlineAt: '2026-02-21T15:00:00Z',
      dispatchedAt: '2026-02-21T10:10:00Z',
      offerExpiresAt: '2026-02-21T11:40:00Z',
      acceptedAt: null,
      attempts: 1,
    },
    documents: [],
    timeline: [
      { label: 'Job advertised', at: '2026-02-21', actor: 'Acme Logistics' },
      { label: 'Offer sent to Bureau Veritas UK', at: '2026-02-21 10:10', actor: 'InCert Match Engine' },
    ],
  },
  ...buildAooTemplatePreviewJobs(),
];

const ASSET_STORAGE_KEY = 'incert.assets.v1';
const MARKETPLACE_JOBS_STORAGE_KEY = 'incert.marketplaceJobs.v2';
const THEME_STORAGE_KEY = 'incert.theme.v1';
const INSPECTION_LOG_STORAGE_KEY = 'incert.inspectionLogs.v1';
const RECURRING_PROGRAMMES_STORAGE_KEY = 'incert.recurringProgrammes.v1';
const PUBLIC_SITE_CONFIG_STORAGE_KEY = 'incert.publicSiteConfig.v1';
const ONBOARDING_TASKS_STORAGE_KEY = 'incert.onboardingTasks.v1';
const FINANCE_INVOICES_STORAGE_KEY = 'incert.financeInvoices.v1';
const PAYOUT_RUNS_STORAGE_KEY = 'incert.payoutRuns.v1';
const INSPECTION_TEMPLATES_STORAGE_KEY = 'incert.inspectionTemplates.v2';
const INTEGRATION_CONNECTIONS_STORAGE_KEY = 'incert.integrationConnections.v1';
const API_CLIENTS_STORAGE_KEY = 'incert.apiClients.v1';
const WEBHOOK_ENDPOINTS_STORAGE_KEY = 'incert.webhookEndpoints.v1';
const ENTERPRISE_SSO_PROVIDERS_STORAGE_KEY = 'incert.enterpriseSsoProviders.v1';
const ENTERPRISE_ACCESS_POLICIES_STORAGE_KEY = 'incert.enterpriseAccessPolicies.v1';
const TEMPLATE_BLUEPRINTS_STORAGE_KEY = 'incert.templateBlueprints.v2';
const TEMPLATE_LISTINGS_STORAGE_KEY = 'incert.templateListings.v2';
const LICENCE_GRANTS_STORAGE_KEY = 'incert.licenceGrants.v1';
const AUDIT_RUNS_STORAGE_KEY = 'incert.auditRuns.v1';
const AUDIT_FINDINGS_STORAGE_KEY = 'incert.auditFindings.v1';
const AUDIT_ACTIONS_STORAGE_KEY = 'incert.auditActions.v1';
const REPORT_ARTIFACTS_STORAGE_KEY = 'incert.reportArtifacts.v1';
const SHARE_LINKS_STORAGE_KEY = 'incert.shareLinks.v1';
const MARKETPLACE_BID_BOARD_STORAGE_KEY = 'incert.marketplaceBidBoard.v1';
const DISPATCH_SLA_EVENTS_STORAGE_KEY = 'incert.dispatchSlaEvents.v1';
const EVIDENCE_AI_JOBS_STORAGE_KEY = 'incert.evidenceAiJobs.v1';
const REGULATOR_VERIFICATION_REQUESTS_STORAGE_KEY = 'incert.regulatorVerificationRequests.v1';
const ANALYTICS_RISK_SIGNALS_STORAGE_KEY = 'incert.analyticsRiskSignals.v1';
const WEBHOOK_DELIVERY_EVENTS_STORAGE_KEY = 'incert.webhookDeliveryEvents.v1';
const MOBILE_AUDIT_SESSIONS_STORAGE_KEY = 'incert.mobileAuditSessions.v1';
const ENTERPRISE_SECURITY_EVENTS_STORAGE_KEY = 'incert.enterpriseSecurityEvents.v1';
const QA_HARNESS_RUNS_STORAGE_KEY = 'incert.qaHarnessRuns.v1';
const RELEASE_GATE_RESULTS_STORAGE_KEY = 'incert.releaseGateResults.v1';
const TENANT_INVITES_STORAGE_KEY = 'incert.tenantInvites.v1';
const EVIDENCE_PROVENANCE_EVENTS_STORAGE_KEY = 'incert.evidenceProvenanceEvents.v1';
const AUTH_RUNTIME_MODE_STORAGE_KEY = 'incert.authRuntimeMode.v1';
const AUTH_SESSION_STORAGE_KEY = 'incert.authSession.v1';
const DEBUG_ROLE_STORAGE_KEY = 'incert.debugRole.v1';
const DEBUG_SNAPSHOT_VERSION_STORAGE_KEY = 'incert.debugSnapshotVersion.v1';

const defaultPublicSiteConfig = {
  siteTitle: 'Acme Logistics Compliance Portal',
  siteSlug: 'acme-logistics',
  supportEmail: 'compliance@acme-logistics.example',
  verificationPath: '/verify',
  launchStatus: 'draft',
  launchDate: '',
  updatedAt: '',
};

const defaultOnboardingTasks = [
  { id: 'org-profile', label: 'Configure organisation profile and branding', completed: false },
  { id: 'role-invites', label: 'Invite dutyholder, site manager, and finance users', completed: false },
  { id: 'asset-import', label: 'Import initial sites and statutory assets', completed: false },
  { id: 'first-booking', label: 'Create first inspection/audit booking', completed: false },
  { id: 'vault-verification', label: 'Verify first certificate in Evidence Vault', completed: false },
];

const defaultAuthSession = {
  isAuthenticated: false,
  email: '',
  fullName: '',
  accountType: 'company',
  signedInAt: '',
};

const PUBLIC_SITE_PAGE_BLUEPRINTS = [
  {
    id: 'home',
    label: 'Home',
    purpose: 'Explain why InCert and convert operators/auditors quickly.',
    headline: 'Book statutory audits and inspections across your estate in minutes.',
    primaryCta: 'Request a pilot',
    secondaryCta: 'Join as an auditor',
    trustCues: ['Digitally signed certificates', 'Audit-ready evidence packs', 'Verified auditors/providers'],
  },
  {
    id: 'how-it-works',
    label: 'How it works',
    purpose: 'Teach request -> dispatch -> completion -> verifiable evidence workflow.',
    headline: 'From request to verifiable evidence - end to end.',
    primaryCta: 'See a sample audit pack',
    secondaryCta: 'Talk to sales',
    trustCues: ['Flow diagram', 'Secure storage', 'Access logs'],
  },
  {
    id: 'portals',
    label: 'Portals',
    purpose: 'Show company, auditor, admin, and insurer portals.',
    headline: 'Portals included.',
    primaryCta: 'Create account',
    secondaryCta: 'See how it works',
    trustCues: ['Company', 'Auditor', 'Admin', 'Insurer'],
  },
  {
    id: 'facilities',
    label: 'For Facilities',
    purpose: 'Sell compliance operations outcomes to operator admins.',
    headline: 'Stop chasing PDFs. Start running compliance.',
    primaryCta: 'Upload your asset register',
    secondaryCta: 'Download procurement pack',
    trustCues: ['PO & VAT invoicing', 'Multi-site controls', 'Retention rules'],
  },
  {
    id: 'auditors',
    label: 'For Auditors',
    purpose: 'Recruit and activate high-quality auditor capacity.',
    headline: 'Find work that fits your coverage, availability, and rates.',
    primaryCta: 'Create auditor profile',
    secondaryCta: 'See example job',
    trustCues: ['Credential passport', 'Fast payout', 'Client evidence access'],
  },
  {
    id: 'pricing',
    label: 'Pricing',
    purpose: 'Clarify pricing model and remove buyer friction.',
    headline: 'Transparent pricing for estates and audit firms.',
    primaryCta: 'Start pilot pricing',
    secondaryCta: 'Enterprise consultation',
    trustCues: ['No lock-in', 'Pay per booking or subscription', 'Clear VAT-ready invoices'],
  },
  {
    id: 'trust',
    label: 'Trust & Compliance',
    purpose: 'Answer security, legal, and evidence integrity objections.',
    headline: 'Evidence integrity and access controls by design.',
    primaryCta: 'View security overview',
    secondaryCta: 'Ask compliance questions',
    trustCues: ['Signing + verification', 'RBAC + MFA', 'Audit logs'],
  },
  {
    id: 'resources',
    label: 'Resources',
    purpose: 'Capture demand via templates, guides, and compliance checklists.',
    headline: 'Templates, guides, and checklists.',
    primaryCta: 'Get the audit scope template',
    secondaryCta: 'Subscribe to updates',
    trustCues: ['HSE citation references', 'Regime playbooks', 'Procurement packs'],
  },
];

const PUBLIC_TRUST_MODULES = [
  {
    id: 'evidence-integrity',
    title: 'Evidence integrity',
    description: 'Every certificate has a verification page and immutable version history.',
  },
  {
    id: 'secure-records',
    title: 'Secure electronic records',
    description: 'Records are securely stored with access trails and exportable audit packs.',
  },
  {
    id: 'credentialled-network',
    title: 'Credentialled network',
    description: 'Providers and auditors are vetted, credentialed, and expiry-tracked.',
  },
  {
    id: 'payments-safety',
    title: 'Payments safety',
    description: 'SCA-ready payment and payout controls align with regulated partner workflows.',
  },
];

const PUBLIC_FOOTER_LINKS = ['Security', 'Legal', 'Privacy', 'Status', 'Contact', 'Careers'];

const ONBOARDING_PERSONA_FLOWS = [
  {
    id: 'operator-admin',
    label: 'Operator Admin',
    goal: 'Onboard organisation, import estate data, set controls, and launch bookings.',
    steps: [
      {
        title: 'Set up your organisation',
        microcopy: 'Start with the basics. You can add sites, roles, and procurement rules next.',
        details: ['Organisation identity + VAT status', 'Registered address + primary contact'],
        cta: 'Continue',
      },
      {
        title: 'Invite your facilities team',
        microcopy: 'Assign roles to control booking, evidence, and payment approvals.',
        details: ['Roles: admin, site manager, compliance viewer, finance', 'Send role-based invites'],
        cta: 'Send invites',
      },
      {
        title: 'Add your sites',
        microcopy: 'Multi-site teams can upload addresses and access constraints in one pass.',
        details: ['Upload CSV or add manually', 'Capture working hours, site contact, and access notes'],
        cta: 'Save sites',
      },
      {
        title: 'Import your asset register',
        microcopy: 'Map columns, detect duplicates, and generate due-date calendars.',
        details: ['CSV/XLSX import', 'Map regime tags and inspection dates'],
        cta: 'Import and validate',
      },
      {
        title: 'Set compliance policies',
        microcopy: 'Define lead times, evidence requirements, and retention profile defaults.',
        details: ['Default booking lead times', 'Evidence attachment requirements'],
        cta: 'Save policies',
      },
      {
        title: 'Request audit or inspection',
        microcopy: 'Define scope once, then use instant pricing and dispatch.',
        details: ['Scope builder -> pricing -> scheduling -> PO/payment', 'Confirm request and dispatch'],
        cta: 'Get instant price',
      },
      {
        title: 'Use Evidence Vault',
        microcopy: 'Share time-limited evidence links and generate audit packs by regime/site.',
        details: ['Filter by site/regime/status', 'Generate packs + secure share links'],
        cta: 'Create share link',
      },
      {
        title: 'Pay and reconcile',
        microcopy: 'Match POs, download VAT invoices, and track payout status.',
        details: ['Approval queue for invoices', 'Reconciliation exports'],
        cta: 'Approve payment',
      },
    ],
  },
  {
    id: 'site-manager',
    label: 'Site Manager',
    goal: 'Run local visit coordination, access readiness, and completion confirmations.',
    steps: [
      {
        title: 'My site dashboard',
        microcopy: "See today's visits, overdue assets, and site-specific priorities.",
        details: ['Visit timeline', 'Overdue and due-soon asset list'],
        cta: 'Confirm access details',
      },
      {
        title: 'Upcoming visit details',
        microcopy: 'Share induction, keys, permits, and escort instructions with the assigned auditor.',
        details: ['Upload site pack', 'Set contact and handover notes'],
        cta: 'Send site pack',
      },
      {
        title: 'On-site completion',
        microcopy: 'Mark completion and upload any local evidence requested during the visit.',
        details: ['Completion confirmation', 'Add local photos/notes'],
        cta: 'Confirm completion',
      },
    ],
  },
  {
    id: 'auditor',
    label: 'Auditor',
    goal: 'Create profile, pass vetting, accept jobs, deliver findings, and receive payout.',
    steps: [
      {
        title: 'Create auditor profile',
        microcopy: 'Set coverage, regimes, sectors, travel policy, and pricing.',
        details: ['Coverage regions + travel radius', 'Rates, minimums, and expense rules'],
        cta: 'Save and continue',
      },
      {
        title: 'Upload credentials',
        microcopy: 'Provide competence and independence evidence required for assignment.',
        details: ['CV, certifications, insurance, references', 'Conflicts and independence declaration'],
        cta: 'Submit for review',
      },
      {
        title: 'Set availability',
        microcopy: 'Enable on-demand requests and set your acceptance policy.',
        details: ['Calendar sync and blackout dates', 'Auto-accept thresholds'],
        cta: 'Enable availability',
      },
      {
        title: 'Use job offer inbox',
        microcopy: 'Accept in-window offers before automatic re-offer.',
        details: ['Offer scope, payout, and travel estimate', 'Accept or decline with reason'],
        cta: 'Accept offer',
      },
      {
        title: 'Access client evidence',
        microcopy: 'Download time-limited evidence packs with full access logging.',
        details: ['Pack download', 'Request additional evidence'],
        cta: 'Download pack',
      },
      {
        title: 'Submit findings',
        microcopy: 'Attach findings to assets/certificates for traceability.',
        details: ['Structured findings + report upload', 'Signed submission'],
        cta: 'Submit and sign',
      },
      {
        title: 'Review payout',
        microcopy: 'Track completion-based payout and remittance details.',
        details: ['Payout status', 'Remittance advice'],
        cta: 'View remittance advice',
      },
    ],
  },
  {
    id: 'auditor-admin',
    label: 'Auditor Admin',
    goal: 'Manage team operations, quality, pricing policies, and utilisation.',
    steps: [
      {
        title: 'Firm profile',
        microcopy: 'Set legal details, service lines, and organisation defaults.',
        details: ['Firm identity profile', 'Core compliance settings'],
        cta: 'Save profile',
      },
      {
        title: 'Team management',
        microcopy: 'Invite auditors and assign operational permissions.',
        details: ['Roster controls', 'Role-based access'],
        cta: 'Manage team',
      },
      {
        title: 'Rate cards and SLAs',
        microcopy: 'Publish rates, acceptance windows, and cancellation policy.',
        details: ['Rate card library', 'Acceptance/response thresholds'],
        cta: 'Update rates',
      },
      {
        title: 'QA sampling',
        microcopy: 'Random sampling protects audit integrity and operator trust.',
        details: ['Sampling policy', 'Outcome scoring'],
        cta: 'Run QA sample',
      },
      {
        title: 'Consolidated invoicing',
        microcopy: 'Review billing batches and payout summaries.',
        details: ['Invoice grouping', 'Payout mapping'],
        cta: 'Review billing',
      },
      {
        title: 'Utilisation analytics',
        microcopy: 'Track workload, acceptance, and completion performance.',
        details: ['Utilisation trends', 'Conversion and SLA metrics'],
        cta: 'View analytics',
      },
    ],
  },
  {
    id: 'provider-admin',
    label: 'Provider Admin',
    goal: 'Set coverage, credentials, inspector roster, and billing/payout controls.',
    steps: [
      {
        title: 'Provider profile',
        microcopy: 'Configure service coverage by asset class and regime.',
        details: ['Coverage regions', 'Asset-class capabilities'],
        cta: 'Save provider profile',
      },
      {
        title: 'Credentials and accreditation',
        microcopy: 'Upload competence records, insurance, and accreditation evidence.',
        details: ['UKAS/accreditation records', 'Insurance documentation'],
        cta: 'Submit credentials',
      },
      {
        title: 'Inspector roster',
        microcopy: 'Manage named inspectors and availability windows.',
        details: ['Inspector assignment rules', 'Availability and leave data'],
        cta: 'Update roster',
      },
      {
        title: 'Rate cards + minimums',
        microcopy: 'Configure pricing by regime, location, and urgency.',
        details: ['Regional cards', 'Minimum callout and travel rules'],
        cta: 'Publish rates',
      },
      {
        title: 'Mobile capture and templates',
        microcopy: 'Map report templates and evidence schema to delivery standards.',
        details: ['Template mapping', 'Mandatory evidence blocks'],
        cta: 'Enable templates',
      },
      {
        title: 'Billing and payout settings',
        microcopy: 'Set invoicing and remittance preferences.',
        details: ['Invoice contacts', 'Bank and payout settings'],
        cta: 'Save billing settings',
      },
    ],
  },
  {
    id: 'finance-purchasing',
    label: 'Finance & Purchasing',
    goal: 'Control PO workflows, approvals, VAT invoices, and cost allocation.',
    steps: [
      {
        title: 'Procurement rules',
        microcopy: 'Define PO requirements and approval thresholds.',
        details: ['PO mandatory/optional', 'Approver chain thresholds'],
        cta: 'Save rules',
      },
      {
        title: 'Supplier/payee setup',
        microcopy: 'Map suppliers, payees, and cost centre defaults.',
        details: ['Supplier profiles', 'Payee and ledger mapping'],
        cta: 'Configure suppliers',
      },
      {
        title: 'Invoice approval queue',
        microcopy: 'Approve or hold invoices with policy checks and context.',
        details: ['Policy exceptions', 'Approval history'],
        cta: 'Review invoices',
      },
      {
        title: 'VAT invoice downloads',
        microcopy: 'Download VAT-ready invoices with complete reference fields.',
        details: ['VAT fields and PO references', 'Download archive'],
        cta: 'Download VAT invoices',
      },
      {
        title: 'Exports and ERP sync',
        microcopy: 'Push reconciled billing data to finance systems.',
        details: ['CSV export', 'ERP sync handoff'],
        cta: 'Export data',
      },
    ],
  },
];

const ONBOARDING_TRACKS = [
  {
    id: 'company',
    title: 'Company onboarding baseline',
    summary: 'Minimum data capture for operator launch.',
    checks: [
      'Organisation identity, VAT status, invoice email, procurement rules',
      'Sites with access constraints and operating windows',
      'Asset register ingest and role assignment',
      'Default SLAs plus evidence preferences',
    ],
  },
  {
    id: 'auditor',
    title: 'Auditor vetting baseline',
    summary: 'KYC, credentials, and manual quality workflow.',
    checks: [
      'Identity + legal business details',
      'Credentials and sample audit output',
      'Coverage and travel profile',
      'Automated document presence/expiry checks',
      'Manual review interview and reference verification',
    ],
  },
  {
    id: 'provider',
    title: 'Provider competence baseline',
    summary: 'Provider onboarding plus inspector/coverage controls.',
    checks: [
      'Inspector roster with named competence',
      'Regime + asset class mapping',
      'Template-field mapping (including LOLER/PSSR required fields)',
      'Accreditation and insurance validation',
    ],
  },
];

const defaultIntegrationConnections = [
  { id: 'INT-ERP-SAP', name: 'SAP S/4HANA', category: 'ERP', status: 'not_connected', endpoint: '', lastSyncAt: '' },
  { id: 'INT-CMMS-MAXIMO', name: 'IBM Maximo', category: 'CMMS', status: 'not_connected', endpoint: '', lastSyncAt: '' },
  { id: 'INT-EAM-MAINTAINX', name: 'MaintainX', category: 'EAM', status: 'not_connected', endpoint: '', lastSyncAt: '' },
];

const defaultApiClients = [
  {
    id: 'API-0001',
    name: 'Acme ERP Integration Client',
    status: 'active',
    scopes: ['jobs.read', 'jobs.write', 'evidence.read'],
    secretFingerprint: 'fp_8f27f1',
    secretRotatedAt: '2026-02-25T09:14:00Z',
    createdAt: '2026-02-20T08:10:00Z',
  },
];

const defaultWebhookEndpoints = [
  {
    id: 'WEP-0001',
    name: 'Acme ERP Completion Hook',
    status: 'active',
    targetUrl: 'https://api.acme-logistics.example/incert/completion',
    lastDeliveredAt: '2026-02-25T10:15:00Z',
  },
  {
    id: 'WEP-0002',
    name: 'Insurer Verification Hook',
    status: 'active',
    targetUrl: 'https://insurer.example/hooks/verification',
    lastDeliveredAt: '',
  },
];

const defaultEnterpriseSsoProviders = [
  {
    id: 'SSO-0001',
    providerName: 'Microsoft Entra ID',
    status: 'configured',
    domain: 'acme-logistics.example',
    updatedAt: '2026-02-24T12:45:00Z',
  },
];

const defaultEnterpriseAccessPolicies = [
  {
    id: 'POL-0001',
    name: 'Require MFA for privileged roles',
    status: 'enabled',
    updatedAt: '2026-02-24T12:45:00Z',
  },
  {
    id: 'POL-0002',
    name: 'Restrict access by verified domain',
    status: 'enabled',
    updatedAt: '2026-02-24T12:45:00Z',
  },
];

const defaultLicenceGrants = [
  {
    id: 'LIC-0001',
    listingId: 'LST-0001',
    buyerOrgId: 'acme-logistics',
    licenceType: 'multi_use',
    seats: 25,
    usesRemaining: null,
    allowedExports: ['pdf', 'json', 'csv'],
    watermarkRules: 'none',
    canFork: false,
    startAt: '2026-02-15T00:00:00Z',
    endAt: '2027-02-15T00:00:00Z',
  },
];

const defaultAuditRuns = [
  {
    id: 'RUN-0001',
    auditJobId: 'JOB-1003',
    templateId: 'TPLX-0001',
    templateVersion: '1.1',
    startedAt: '2026-02-16T08:30:00Z',
    completedAt: '2026-02-16T10:40:00Z',
    status: 'completed',
    offlineSyncState: 'synced',
    gpsPolicy: 'optional',
    requiredEvidenceRemaining: 0,
    requiredSignaturesRemaining: 0,
  },
];

const defaultAuditFindings = [
  {
    id: 'FND-0001',
    auditRunId: 'RUN-0001',
    severity: 'high',
    taxonomyCode: 'HS-EGRESS',
    description: 'Emergency egress route partially obstructed near loading bay.',
    linkedBlockId: 'blk_egress_01',
    photos: 2,
    riskScore: 16,
    status: 'open',
  },
];

const defaultAuditActions = [
  {
    id: 'ACT-0001',
    findingId: 'FND-0001',
    assignee: 'Site Manager',
    dueDate: '2026-03-01',
    status: 'open',
    evidenceRequired: true,
    closureSignoff: 'auditor',
    closureEvidenceCount: 0,
  },
];

const defaultReportArtifacts = [
  {
    id: 'RPT-0001',
    auditRunId: 'RUN-0001',
    version: 1,
    pdfUri: 'storage://incert-reports/RUN-0001/v1/report.pdf',
    htmlUri: 'storage://incert-reports/RUN-0001/v1/report.html',
    hash: 'sha256:run0001v1',
    signature: 'sig:incert:run0001:v1',
    status: 'valid',
    signedPdfUrl: 'https://signed.incert.example/reports/RUN-0001/v1.pdf',
    signedHtmlUrl: 'https://signed.incert.example/reports/RUN-0001/v1.html',
    createdAt: '2026-02-16T10:45:00Z',
  },
];

const defaultShareLinks = [
  {
    id: 'SHR-0001',
    reportArtifactId: 'RPT-0001',
    scopeJson: '{"site":"Birmingham Whse","regime":"LOLER"}',
    expiresAt: '2026-03-16T10:45:00Z',
    accessPolicy: 'read_only',
    auditLogEnabled: true,
    url: 'https://portal.incert.example/share/SHR-0001',
  },
];

const defaultMarketplaceBidBoard = [
  {
    id: 'BID-0001',
    requestId: 'JOB-1001',
    providerOrgName: 'NorthStar Inspection Partners',
    strategy: 'best_value',
    totalExVat: 372,
    vatAmount: 74.4,
    leadTimeHours: 12,
    qualityScore: 91,
    rankScore: 88,
    status: 'submitted',
    submittedAt: '2026-02-24T09:20:00Z',
    assignedAuditor: 'Hannah Briggs',
    assignmentStatus: 'assigned',
  },
  {
    id: 'BID-0002',
    requestId: 'JOB-1001',
    providerOrgName: 'Bureau Veritas UK',
    strategy: 'best_value',
    totalExVat: 388,
    vatAmount: 77.6,
    leadTimeHours: 9,
    qualityScore: 95,
    rankScore: 90,
    status: 'awarded',
    submittedAt: '2026-02-24T09:35:00Z',
    assignedAuditor: 'R. Menon',
    assignmentStatus: 'accepted',
  },
];

const defaultDispatchSlaEvents = [
  {
    id: 'SLA-0001',
    requestId: 'JOB-1001',
    eventType: 'offer_sent',
    eventAt: '2026-02-24T09:35:00Z',
    minutesFromOpen: 18,
    isBreach: false,
  },
  {
    id: 'SLA-0002',
    requestId: 'JOB-1001',
    eventType: 'offer_accepted',
    eventAt: '2026-02-24T09:48:00Z',
    minutesFromOpen: 31,
    isBreach: false,
  },
];

const defaultEvidenceAiJobs = [
  {
    id: 'EAI-0001',
    evidenceRef: 'evidence://JOB-1003/pre-checklist.pdf',
    model: 'gpt-5-mini',
    status: 'completed',
    extractionSummary: 'Detected 3 controls with pass/fail outcomes and 1 advisory note.',
    confidenceScore: 0.93,
    createdAt: '2026-02-24T10:00:00Z',
    completedAt: '2026-02-24T10:02:30Z',
    reviewDecision: 'accepted',
  },
  {
    id: 'EAI-0002',
    evidenceRef: 'evidence://JOB-1002/compressor-photos.zip',
    model: 'gpt-5-mini',
    status: 'queued',
    extractionSummary: '',
    confidenceScore: 0,
    createdAt: '2026-02-25T11:14:00Z',
    completedAt: '',
    reviewDecision: 'pending',
  },
];

const defaultRegulatorVerificationRequests = [
  {
    id: 'VRQ-0001',
    requestor: 'Insurer Desk',
    referenceId: 'CERT-2025-9921',
    status: 'open',
    requestedAt: '2026-02-25T08:40:00Z',
    dueAt: '2026-03-01T17:00:00Z',
    latestEvent: 'Evidence package requested',
  },
];

const defaultAnalyticsRiskSignals = [
  {
    id: 'RSK-0001',
    organization: 'Acme Logistics',
    signal: 'repeat_high_severity_findings',
    riskLevel: 'high',
    confidence: 0.86,
    triggeredAt: '2026-02-25T12:05:00Z',
  },
  {
    id: 'RSK-0002',
    organization: 'Acme Logistics',
    signal: 'dispatch_sla_near_breach',
    riskLevel: 'medium',
    confidence: 0.74,
    triggeredAt: '2026-02-25T12:22:00Z',
  },
];

const defaultWebhookDeliveryEvents = [
  {
    id: 'WEB-0001',
    endpointLabel: 'SAP Completion Webhook',
    status: 'delivered',
    attempts: 1,
    lastAttemptAt: '2026-02-25T10:15:00Z',
    latencyMs: 284,
  },
  {
    id: 'WEB-0002',
    endpointLabel: 'Insurer Verification Hook',
    status: 'failed',
    attempts: 3,
    lastAttemptAt: '2026-02-25T10:42:00Z',
    latencyMs: 0,
  },
];

const defaultMobileAuditSessions = [
  {
    id: 'MAS-0001',
    jobId: 'JOB-1003',
    deviceName: 'iPhone 15 - BVUK-01',
    attestationStatus: 'verified',
    syncStatus: 'synced',
    startedAt: '2026-02-25T09:00:00Z',
    closedAt: '',
  },
];

const defaultEnterpriseSecurityEvents = [
  {
    id: 'SEC-0001',
    eventType: 'sso_policy_updated',
    severity: 'low',
    actor: 'incert.admin@incert.local',
    occurredAt: '2026-02-25T07:30:00Z',
  },
  {
    id: 'SEC-0002',
    eventType: 'suspicious_login_blocked',
    severity: 'high',
    actor: 'system.guard',
    occurredAt: '2026-02-25T11:02:00Z',
  },
];

const defaultQaHarnessRuns = [
  {
    id: 'QAR-0001',
    suiteName: 'Marketplace Core',
    status: 'passed',
    branch: 'main',
    startedAt: '2026-02-25T06:15:00Z',
    completedAt: '2026-02-25T06:19:00Z',
    passRate: 100,
  },
];

const defaultReleaseGateResults = [
  {
    id: 'RLG-0001',
    gateName: 'Security checks',
    status: 'passed',
    evaluatedAt: '2026-02-25T06:21:00Z',
    notes: 'No critical findings.',
  },
  {
    id: 'RLG-0002',
    gateName: 'Data migrations',
    status: 'pending',
    evaluatedAt: '2026-02-25T06:22:00Z',
    notes: 'Waiting for production Supabase project.',
  },
];

const defaultTenantInvites = [
  {
    id: 'INV-0001',
    email: 'facilities.manager@acme-logistics.example',
    role: 'dutyholder_admin',
    status: 'pending',
    sentAt: '2026-02-25T14:10:00Z',
    acceptedAt: '',
  },
];

const defaultEvidenceProvenanceEvents = [
  {
    id: 'PRV-0001',
    evidenceRef: 'evidence://JOB-1003/pre-checklist.pdf',
    eventType: 'file_uploaded',
    hash: 'sha256:prechecklist1003',
    deviceMetadata: 'ios:camera:v15',
    createdAt: '2026-02-25T09:12:00Z',
  },
  {
    id: 'PRV-0002',
    evidenceRef: 'evidence://JOB-1003/pre-checklist.pdf',
    eventType: 'ai_extracted',
    hash: 'sha256:prechecklist1003',
    deviceMetadata: 'server:ai-pipeline',
    createdAt: '2026-02-25T09:13:00Z',
  },
];

const defaultAuthRuntimeMode = 'mock';

function parseISODate(value) {
  if (!value || typeof value !== 'string') {
    return null;
  }

  const [year, month, day] = value.split('-').map(Number);
  if (!year || !month || !day) {
    return null;
  }

  const parsed = new Date(year, month - 1, day);
  if (Number.isNaN(parsed.getTime())) {
    return null;
  }

  return parsed;
}

function startOfToday() {
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate());
}

function daysUntil(dateString) {
  const dueDate = parseISODate(dateString);
  if (!dueDate) {
    return null;
  }

  const today = startOfToday();
  const msInDay = 1000 * 60 * 60 * 24;
  return Math.ceil((dueDate.getTime() - today.getTime()) / msInDay);
}

function deriveAssetStatus(nextDue) {
  const delta = daysUntil(nextDue);

  if (delta === null) {
    return 'warning';
  }

  if (delta < 0) {
    return 'overdue';
  }

  if (delta <= 30) {
    return 'warning';
  }

  return 'compliant';
}

function deriveCertificateStatus(expiryDate) {
  const delta = daysUntil(expiryDate);
  if (delta === null) {
    return 'expired';
  }
  return delta < 0 ? 'expired' : 'valid';
}

function formatDateLabel(dateString) {
  const date = parseISODate(dateString);
  if (!date) {
    return 'Invalid date';
  }

  return new Intl.DateTimeFormat('en-GB', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
  }).format(date);
}

function formatRelativeDueLabel(dateString) {
  const delta = daysUntil(dateString);
  if (delta === null) {
    return 'Date unknown';
  }
  if (delta < 0) {
    const absolute = Math.abs(delta);
    return absolute === 1 ? '1 day overdue' : `${absolute} days overdue`;
  }
  if (delta === 0) {
    return 'Due today';
  }
  if (delta === 1) {
    return 'Due tomorrow';
  }
  return `${delta} days remaining`;
}

function getAppBaseUrl() {
  if (typeof window === 'undefined') {
    return 'https://app.incert.local';
  }
  return `${window.location.origin}${window.location.pathname}`;
}

function buildAssetDeepLink(assetId) {
  return `${getAppBaseUrl()}#asset=${encodeURIComponent(String(assetId || '').trim())}`;
}

function buildCertificateDeepLink(certificateId) {
  return `${getAppBaseUrl()}#certificate=${encodeURIComponent(String(certificateId || '').trim())}`;
}

function parseInCertScanValue(rawValue) {
  const value = String(rawValue || '').trim();
  if (!value) {
    return null;
  }

  const parseCandidate = (candidate) => {
    const normalized = String(candidate || '').trim();
    if (!normalized) {
      return null;
    }

    const assetMatch = normalized.match(/AST-\d{3,}/i);
    if (assetMatch) {
      return { type: 'asset', id: assetMatch[0].toUpperCase() };
    }

    const certificateMatch = normalized.match(/CERT-\d{4}-\d{3,}/i);
    if (certificateMatch) {
      return { type: 'certificate', id: certificateMatch[0].toUpperCase() };
    }

    return null;
  };

  const directMatch = parseCandidate(value);
  if (directMatch) {
    return directMatch;
  }

  const hashValue = value.replace(/^#/, '');
  if (hashValue) {
    const hashParams = new URLSearchParams(hashValue);
    const hashAsset = hashParams.get('asset') || hashParams.get('assetId');
    if (hashAsset) {
      const parsedAsset = parseCandidate(hashAsset);
      if (parsedAsset) {
        return parsedAsset;
      }
    }
    const hashCertificate = hashParams.get('certificate') || hashParams.get('certificateId') || hashParams.get('cert');
    if (hashCertificate) {
      const parsedCertificate = parseCandidate(hashCertificate);
      if (parsedCertificate) {
        return parsedCertificate;
      }
    }
  }

  try {
    const parsedUrl = new URL(value);
    const searchAsset = parsedUrl.searchParams.get('asset') || parsedUrl.searchParams.get('assetId');
    if (searchAsset) {
      const parsedAsset = parseCandidate(searchAsset);
      if (parsedAsset) {
        return parsedAsset;
      }
    }

    const searchCertificate =
      parsedUrl.searchParams.get('certificate') ||
      parsedUrl.searchParams.get('certificateId') ||
      parsedUrl.searchParams.get('cert');
    if (searchCertificate) {
      const parsedCertificate = parseCandidate(searchCertificate);
      if (parsedCertificate) {
        return parsedCertificate;
      }
    }

    const urlHash = parsedUrl.hash.replace(/^#/, '');
    if (urlHash) {
      const parsedHash = parseInCertScanValue(urlHash);
      if (parsedHash) {
        return parsedHash;
      }
    }
  } catch {
    // Value is not a URL.
  }

  return null;
}

function extractBarcodeRawValue(detection) {
  if (!detection || typeof detection !== 'object') {
    return '';
  }

  const candidates = [
    detection.rawValue,
    detection.displayValue,
    detection.value,
    detection.rawData,
  ];

  const firstReadable = candidates.find(
    (candidate) => typeof candidate === 'string' && candidate.trim().length > 0
  );

  return firstReadable ? firstReadable.trim() : '';
}

function escapeHtml(value) {
  return String(value || '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function createPseudoHash(input) {
  const source = String(input || '');
  let hash = 0;
  for (let index = 0; index < source.length; index += 1) {
    hash = (hash << 5) - hash + source.charCodeAt(index);
    hash |= 0;
  }
  const first = Math.abs(hash).toString(16).padStart(8, '0');
  const second = Math.abs(hash * 2654435761).toString(16).padStart(8, '0');
  return `${first.slice(0, 4)}...${second.slice(-4)}`;
}

function downloadAuditPackPdf({ assets, certificates }) {
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 44;
  let y = margin + 18;

  const pushRow = (text, spacing = 18, options = {}) => {
    if (y + spacing > pageHeight - margin) {
      doc.addPage();
      y = margin + 8;
    }
    doc.text(text, margin, y, options);
    y += spacing;
  };

  const compliantCount = assets.filter((asset) => asset.status === 'compliant').length;
  const warningCount = assets.filter((asset) => asset.status === 'warning').length;
  const overdueCount = assets.filter((asset) => asset.status === 'overdue').length;
  const validCertificates = certificates.filter((certificate) => certificate.status === 'valid').length;
  const expiredCertificates = certificates.filter((certificate) => certificate.status !== 'valid').length;

  doc.setFillColor(236, 254, 255);
  doc.rect(0, 0, pageWidth, 110, 'F');
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(22);
  doc.setTextColor(15, 23, 42);
  doc.text('InCert Audit Pack', margin, 56);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  doc.setTextColor(51, 65, 85);
  doc.text(`Generated ${new Date().toLocaleString('en-GB')}`, margin, 76);
  doc.text('Organisation: Acme Logistics', margin, 92);

  y = 145;
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(13);
  doc.setTextColor(15, 23, 42);
  pushRow('Estate Summary', 20);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  pushRow(`Assets total: ${assets.length}`);
  pushRow(`Compliant: ${compliantCount} | Warning: ${warningCount} | Overdue: ${overdueCount}`);
  pushRow(`Certificates valid: ${validCertificates} | Expired: ${expiredCertificates}`);

  y += 8;
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(13);
  pushRow('Asset Status Detail', 20);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10.5);
  assets.forEach((asset) => {
    pushRow(
      `${asset.id} | ${asset.name} | ${asset.site} | ${asset.regime} | Due ${asset.nextDue} | ${asset.status.toUpperCase()}`,
      16
    );
  });

  doc.addPage();
  y = margin + 18;
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(13);
  pushRow('Certificate Register', 20);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10.5);
  certificates.forEach((certificate) => {
    pushRow(
      `${certificate.id} | ${certificate.assetId} | ${certificate.provider} | Issue ${certificate.issueDate} | Expiry ${certificate.expiryDate} | ${certificate.status.toUpperCase()}`,
      16
    );
    pushRow(`  Hash ${certificate.hash}`, 15);
  });

  doc.save(`InCert-Audit-Pack-${new Date().toISOString().slice(0, 10)}.pdf`);
}

function downloadCertificatePdf(certificate) {
  if (!certificate) {
    return;
  }

  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const width = doc.internal.pageSize.getWidth();
  const margin = 46;
  const bodyWidth = width - margin * 2;
  const statusLabel = certificate.status === 'valid' ? 'Valid' : 'Expired';

  doc.setFillColor(239, 246, 255);
  doc.rect(0, 0, width, 124, 'F');
  doc.setDrawColor(6, 182, 212);
  doc.setLineWidth(1.6);
  doc.roundedRect(margin, margin, bodyWidth, 500, 14, 14, 'S');

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(25);
  doc.setTextColor(15, 23, 42);
  doc.text('InCert Certificate', margin + 18, 82);
  doc.setFontSize(10.5);
  doc.setTextColor(71, 85, 105);
  doc.text('Platform-issued compliance evidence', margin + 18, 102);
  doc.text(`Certificate ID: ${certificate.id}`, width - margin - 195, 82);
  doc.text(`Status: ${statusLabel}`, width - margin - 195, 100);

  let y = 158;
  const row = (label, value) => {
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.setTextColor(100, 116, 139);
    doc.text(label, margin + 18, y);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    doc.setTextColor(15, 23, 42);
    doc.text(String(value || '-'), margin + 150, y);
    y += 28;
  };

  row('Asset ID', certificate.assetId);
  row('Asset Name', certificate.assetName);
  row('Regime', certificate.regime);
  row('Issued By', certificate.provider);
  row('Issue Date', formatDateLabel(certificate.issueDate));
  row('Expiry Date', formatDateLabel(certificate.expiryDate));
  row('SHA-256 Fingerprint', certificate.hash);
  row('Verification URL', buildCertificateDeepLink(certificate.id));

  y += 24;
  doc.setDrawColor(148, 163, 184);
  doc.setLineWidth(1);
  doc.line(margin + 18, y, margin + 210, y);
  doc.line(width - margin - 210, y, width - margin - 18, y);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(9.5);
  doc.setTextColor(71, 85, 105);
  doc.text('Provider signature', margin + 18, y + 14);
  doc.text('InCert verification stamp', width - margin - 210, y + 14);

  doc.setFontSize(9);
  doc.text(
    `Generated ${new Date().toLocaleString('en-GB')} by InCert`,
    margin + 18,
    565
  );

  doc.save(`${certificate.id}.pdf`);
}

function buildTrendPoints(baseValue, count = 12) {
  return Array.from({ length: count }).map((_, index) => {
    const oscillation = Math.sin((index + 1) * 0.8) * 6;
    const lift = (index / count) * 3;
    return Math.max(52, Math.min(100, Math.round(baseValue - 5 + oscillation + lift)));
  });
}

const MARKETPLACE_SCOPE_TEMPLATES = [
  {
    id: 'portfolio_sweep',
    label: 'Portfolio Sweep',
    description: 'Standard recurring compliance checks across known assets.',
    baseHours: 1.8,
    perAssetHours: 0.7,
  },
  {
    id: 'urgent_defect_followup',
    label: 'Urgent Defect Follow-up',
    description: 'Fast verification after a high-severity defect finding.',
    baseHours: 2.2,
    perAssetHours: 0.9,
  },
  {
    id: 'insurer_verification',
    label: 'Insurer Verification',
    description: 'Evidence-heavy validation for insurer/auditor requests.',
    baseHours: 2.6,
    perAssetHours: 1.1,
  },
  {
    id: 'written_scheme_review',
    label: 'Written Scheme Review',
    description: 'PSSR focused scope including WSE checks and signatures.',
    baseHours: 3.1,
    perAssetHours: 1.2,
  },
];

const ACCESS_COMPLEXITY_MULTIPLIERS = {
  standard: 1,
  restricted: 1.22,
  out_of_hours: 1,
};

const EQUIPMENT_SURCHARGES = {
  none: 0,
  specialist_instruments: 120,
  rope_access: 160,
  confined_space: 210,
};

const REGIME_MULTIPLIERS = {
  HS: 1.05,
  FRA: 1.08,
  LOLER: 1,
  PUWER: 0.94,
  PSSR: 1.16,
  COSHH: 1.02,
  ASBESTOS: 1.14,
  LEGIONELLA: 1.08,
  ELECTRICAL: 1.03,
  SCAFFOLD: 1.06,
  FOOD: 1.01,
  WORKPLACE: 0.98,
  SUPPLEMENTAL: 0.96,
  MACHINE: 0.97,
  FIRE_DOOR: 0.99,
  RETAIL: 0.95,
  HOSPITALITY: 0.97,
  WAREHOUSE: 1.04,
  CONSTRUCTION: 1.12,
  EDUCATION: 0.96,
  HEALTHCARE: 1.09,
  MYSTERY: 0.9,
  PEN_TEST: 1.2,
};

const REGIME_HOURS_MULTIPLIERS = {
  HS: 1.06,
  FRA: 1.08,
  LOLER: 1,
  PUWER: 0.96,
  PSSR: 1.18,
  COSHH: 1.03,
  ASBESTOS: 1.14,
  LEGIONELLA: 1.08,
  ELECTRICAL: 1.04,
  SCAFFOLD: 1.06,
  FOOD: 1.02,
  WORKPLACE: 0.98,
  SUPPLEMENTAL: 0.96,
  MACHINE: 0.97,
  FIRE_DOOR: 1,
  RETAIL: 0.95,
  HOSPITALITY: 0.97,
  WAREHOUSE: 1.05,
  CONSTRUCTION: 1.12,
  EDUCATION: 0.97,
  HEALTHCARE: 1.1,
  MYSTERY: 0.9,
  PEN_TEST: 1.22,
};

const REGION_HOURLY_RATE = {
  london: 96,
  manchester: 86,
  birmingham: 84,
  other: 82,
};

const DEFAULT_RATE_CARD = {
  hourlyRate: 88,
  minimumCallout: 200,
  travelPerKm: 1.25,
  platformFeePct: 0.45,
};

const DEFAULT_PRICING_MODEL_VERSION = 'pricing-model-2026-02-22-v6';
const DEFAULT_VAT_RATE = 0.2;
const PRICING_ENGINE_CONFIG = {
  travelTimeMultiplier: 0.6,
  customerMileageRatePerMile: 1.45,
  auditorMileageRatePerMile: 0.95,
  minAuditorHourlyRate: 25,
  maxAuditorHourlyRate: 50,
  defaultAuditorPerformanceIndex: 0.56,
  minAuditorBillableHours: 2,
  auditorEquipmentPayoutRatio: 0.4,
  baseTakeRate: 0.46,
  urgencyTakeRateDelta: 0.05,
  sweepTakeRateUpliftPerExtraAsset: 0.01,
  sweepTakeRateUpliftCap: 0.05,
  portfolioSweepAssetMultiplierPerExtraAsset: 0.1,
  portfolioSweepAssetMultiplierCap: 0.5,
  takeRateFloor: 0.3,
  premiumTakeRateFloor: 0.4,
  takeRateCeiling: 0.85,
  marketHourlyRateByRegime: {
    HS: 132,
    FRA: 138,
    LOLER: 128,
    PUWER: 118,
    PSSR: 148,
    COSHH: 134,
    ASBESTOS: 150,
    LEGIONELLA: 140,
    ELECTRICAL: 136,
    SCAFFOLD: 137,
    FOOD: 130,
    WORKPLACE: 124,
    SUPPLEMENTAL: 120,
    MACHINE: 122,
    FIRE_DOOR: 126,
    RETAIL: 118,
    HOSPITALITY: 122,
    WAREHOUSE: 134,
    CONSTRUCTION: 146,
    EDUCATION: 120,
    HEALTHCARE: 142,
    MYSTERY: 110,
    PEN_TEST: 168,
  },
  marketOpsPremiumPct: 0.08,
  marketOpsPremiumPctPremium: 0.12,
  urgencyLabourMultiplier: 1.25,
  outOfHoursLabourMultiplier: 1.5,
  holdbackPct: 0.05,
  disputeReservePct: 0.015,
  thirdPartyMarginPct: 0.1,
  externalSoftwareWithholdPct: 0.03,
};

function roundMoney(value) {
  return Math.round(Number(value || 0));
}

function clampNumber(value, minimum, maximum) {
  return Math.min(maximum, Math.max(minimum, value));
}

function formatCurrencyGBP(value) {
  return new Intl.NumberFormat('en-GB', {
    style: 'currency',
    currency: 'GBP',
    maximumFractionDigits: 0,
  }).format(Number(value || 0));
}

function formatPercentage(value) {
  return `${Math.round(Number(value || 0) * 100)}%`;
}

function normalizeUserRole(value, fallback = 'company') {
  const role = String(value || '').toLowerCase();
  return USER_ROLE_OPTIONS.some((option) => option.id === role) ? role : fallback;
}

function mapSupabaseRoleToUserRole(role) {
  const normalized = String(role || '').toLowerCase();
  if (!normalized) {
    return 'company';
  }

  if (normalized === 'platform_admin') {
    return 'incert';
  }
  if (normalized === 'insurer_viewer') {
    return 'insurer';
  }
  if (normalized === 'provider_admin') {
    return 'third_party';
  }
  if (normalized === 'inspector' || normalized === 'auditor_viewer') {
    return 'auditor';
  }
  return 'company';
}

function mapRequestStatusToMarketplaceStatus(status) {
  const normalized = String(status || '').toLowerCase();
  if (normalized === 'offered') {
    return 'offered';
  }
  if (normalized === 'scheduled') {
    return 'assigned';
  }
  if (normalized === 'completed') {
    return 'completed';
  }
  return 'open';
}

function mapJobStatusToMarketplaceStatus(status) {
  const normalized = String(status || '').toLowerCase();
  if (normalized === 'pending') {
    return 'offered';
  }
  if (normalized === 'accepted') {
    return 'assigned';
  }
  if (normalized === 'in_progress') {
    return 'in_progress';
  }
  if (normalized === 'submitted') {
    return 'awaiting_review';
  }
  if (normalized === 'verified') {
    return 'completed';
  }
  if (normalized === 'rejected') {
    return 'awaiting_review';
  }
  return 'open';
}

function mapOrgTypeToProviderTier(orgType) {
  const normalized = String(orgType || '').toLowerCase();
  if (normalized === 'provider') {
    return 'Accredited Provider';
  }
  if (normalized === 'auditor') {
    return 'Audit Company Network';
  }
  if (normalized === 'insurer') {
    return 'Insurer Network';
  }
  if (normalized === 'platform') {
    return 'Platform Network';
  }
  return 'Provider Network';
}

function normalizeAuditExecutionMode(value) {
  return String(value || '').toLowerCase() === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
    ? AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
    : AUDIT_EXECUTION_MODES.INCERT_TEMPLATE;
}

function resolveExternalAuditReviewStatus(job, executionMode = normalizeAuditExecutionMode(job?.auditExecutionMode)) {
  if (executionMode !== AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE) {
    return EXTERNAL_AUDIT_REVIEW_STATUSES.NOT_REQUIRED;
  }

  const requestedStatus = String(job?.externalAuditReviewStatus || '').toLowerCase();
  if (Object.values(EXTERNAL_AUDIT_REVIEW_STATUSES).includes(requestedStatus)) {
    return requestedStatus;
  }

  if (job?.status === 'completed') {
    return EXTERNAL_AUDIT_REVIEW_STATUSES.APPROVED;
  }
  if (job?.status === 'awaiting_review') {
    return EXTERNAL_AUDIT_REVIEW_STATUSES.PENDING_REVIEW;
  }
  if (Array.isArray(job?.documents) && job.documents.length > 0) {
    return EXTERNAL_AUDIT_REVIEW_STATUSES.PENDING_REVIEW;
  }

  return EXTERNAL_AUDIT_REVIEW_STATUSES.PENDING_EVIDENCE;
}

function getExternalAuditReviewStatusLabel(value) {
  const status = String(value || '').toLowerCase();
  const labels = {
    [EXTERNAL_AUDIT_REVIEW_STATUSES.NOT_REQUIRED]: 'Not required',
    [EXTERNAL_AUDIT_REVIEW_STATUSES.PENDING_EVIDENCE]: 'Awaiting evidence',
    [EXTERNAL_AUDIT_REVIEW_STATUSES.PENDING_REVIEW]: 'Pending InCert review',
    [EXTERNAL_AUDIT_REVIEW_STATUSES.APPROVED]: 'Approved',
    [EXTERNAL_AUDIT_REVIEW_STATUSES.REJECTED]: 'Changes required',
  };
  return labels[status] || 'Pending review';
}

function getAuditExecutionModeLabel(value) {
  return normalizeAuditExecutionMode(value) === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
    ? 'Auditor software'
    : 'InCert template';
}

function getThirdPartyOrganizationById(organizationId) {
  const targetId = String(organizationId || '').trim();
  if (!targetId) {
    return null;
  }
  return (
    thirdPartyOrganizations.find((organization) => String(organization?.id || '').trim() === targetId) || null
  );
}

function isThirdPartyProvider(provider) {
  return String(provider?.employmentModel || '').toLowerCase() === 'third_party';
}

function getProviderThirdPartyMarginPct(provider) {
  if (!isThirdPartyProvider(provider)) {
    return 0;
  }
  const orgMargin = Number(getThirdPartyOrganizationById(provider?.thirdPartyOrganizationId)?.marginPct);
  const providerMargin = Number(provider?.thirdPartyMarginPct);
  const resolvedMargin = Number.isFinite(providerMargin)
    ? providerMargin
    : Number.isFinite(orgMargin)
      ? orgMargin
      : PRICING_ENGINE_CONFIG.thirdPartyMarginPct;
  return clampNumber(resolvedMargin, 0, 0.25);
}

function getThirdPartyAssignableAuditors(provider, regime = '') {
  if (!isThirdPartyProvider(provider)) {
    return [];
  }
  const organization = getThirdPartyOrganizationById(provider?.thirdPartyOrganizationId);
  if (!organization || !Array.isArray(organization.auditors)) {
    return [];
  }
  const targetRegime = String(regime || '').trim().toUpperCase();
  return organization.auditors.filter((auditor) => {
    if (!targetRegime) {
      return true;
    }
    return Array.isArray(auditor?.regimes) && auditor.regimes.includes(targetRegime);
  });
}

function resolveJobAssignedAuditorLabel(job, fallbackProviderName = 'Assigned provider') {
  const fieldAuditor = String(job?.assignedFieldAuditorName || '').trim();
  const providerName = String(fallbackProviderName || '').trim() || 'Assigned provider';
  if (!fieldAuditor) {
    return providerName;
  }
  if (fieldAuditor.toLowerCase() === providerName.toLowerCase()) {
    return providerName;
  }
  return `${fieldAuditor} (${providerName})`;
}

function formatDateTimeLabel(value) {
  if (!value) {
    return 'n/a';
  }
  const parsed = new Date(value);
  if (Number.isNaN(parsed.getTime())) {
    return 'n/a';
  }
  return new Intl.DateTimeFormat('en-GB', {
    day: '2-digit',
    month: 'short',
    hour: '2-digit',
    minute: '2-digit',
  }).format(parsed);
}

function minutesUntil(value, nowTimestamp = Date.now()) {
  if (!value) {
    return null;
  }
  const target = new Date(value).getTime();
  if (Number.isNaN(target)) {
    return null;
  }
  return Math.floor((target - nowTimestamp) / 60000);
}

function getScopeTemplate(scopeTemplateId) {
  return (
    MARKETPLACE_SCOPE_TEMPLATES.find((template) => template.id === scopeTemplateId) ||
    MARKETPLACE_SCOPE_TEMPLATES[0]
  );
}

function getScopeTemplateLabel(scopeTemplateId) {
  return getScopeTemplate(scopeTemplateId)?.label || 'Audit scope';
}

function estimateScopeHours(scopeTemplateId, assetCount, weekendAccess) {
  const template = getScopeTemplate(scopeTemplateId);
  const safeAssetCount = Math.max(1, Number(assetCount || 1));
  const base = template.baseHours + (safeAssetCount - 1) * template.perAssetHours;
  const weekendAdjustment = weekendAccess ? 0.35 : 0;
  return Math.max(1.5, Math.round((base + weekendAdjustment) * 10) / 10);
}

function buildMarketplaceQuoteId(jobId, version) {
  const safeJobId = String(jobId || 'TMP').toUpperCase().replace(/[^A-Z0-9-]/g, '');
  return `QTE-${safeJobId}-V${String(Math.max(1, Number(version || 1))).padStart(2, '0')}`;
}

function buildMarketplaceRateCardVersionId(regime, site) {
  const region = getSiteRegion(site);
  return `rc-${region}-${String(regime || 'LOLER').toLowerCase()}-v1`;
}

function getNextWeeklyPayoutDate(fromDate = new Date()) {
  const target = new Date(fromDate);
  target.setHours(0, 0, 0, 0);
  const day = target.getDay();
  let delta = (5 - day + 7) % 7;
  if (delta === 0) {
    delta = 7;
  }
  target.setDate(target.getDate() + delta);
  return target.toISOString().slice(0, 10);
}

function addDays(dateString, days) {
  const parsed = parseISODate(dateString);
  if (!parsed) {
    return dateString;
  }
  parsed.setDate(parsed.getDate() + days);
  return parsed.toISOString().slice(0, 10);
}

function buildSeedValue(seedSource) {
  return String(seedSource || '')
    .split('')
    .reduce((sum, char) => sum + char.charCodeAt(0), 0);
}

function resolveSeededLagDays(seedSource, minDays = 1, maxDays = 7) {
  const safeMin = Math.max(0, Math.trunc(Number(minDays || 0)));
  const safeMax = Math.max(safeMin, Math.trunc(Number(maxDays || safeMin)));
  const range = safeMax - safeMin + 1;
  if (range <= 1) {
    return safeMin;
  }
  return safeMin + (buildSeedValue(seedSource) % range);
}

function resolveCollectionBackedPayoutDate(collectionDate, seedSource, fallbackDate = '', fixedLagDays = null) {
  const normalizedCollectionDate = String(collectionDate || '').slice(0, 10);
  const normalizedFallbackDate = String(fallbackDate || '').slice(0, 10) || new Date().toISOString().slice(0, 10);
  const anchorDate = parseISODate(normalizedCollectionDate) ? normalizedCollectionDate : normalizedFallbackDate;
  const lagDays = Number.isFinite(fixedLagDays)
    ? Math.max(0, Math.trunc(Number(fixedLagDays)))
    : resolveSeededLagDays(seedSource, 1, 7);
  return addDays(anchorDate, lagDays);
}

function buildIsoTimestampFromDate(dateString, seedSource, baseHour = 9, hourRange = 8, minuteFactor = 11) {
  const normalizedDate = String(dateString || '').slice(0, 10);
  const parsedDate = parseISODate(normalizedDate);
  if (!parsedDate) {
    return '';
  }
  const seed = buildSeedValue(seedSource);
  const safeHourRange = Math.max(1, Math.trunc(Number(hourRange || 1)));
  const hour = Math.max(0, Math.min(23, Math.trunc(Number(baseHour || 0)) + (seed % safeHourRange)));
  const minute = (seed * Math.max(1, Math.trunc(Number(minuteFactor || 1)))) % 60;
  const year = parsedDate.getFullYear();
  const month = parsedDate.getMonth();
  const day = parsedDate.getDate();
  return new Date(Date.UTC(year, month, day, hour, minute, 0, 0)).toISOString();
}

function buildMarketplacePricingLock({ jobId, quote, lockedAt, lockedBy }) {
  if (!quote) {
    return null;
  }

  const lockTimestamp = lockedAt || new Date().toISOString();
  return {
    pricingLockId: `LOCK-${jobId}-${quote.quoteVersion}`,
    bookingId: `BOOK-${jobId}`,
    quoteId: quote.quoteId,
    lockedAt: lockTimestamp,
    lockedBy: lockedBy || 'InCert Dispatch Engine',
  };
}

function resolveExternalSoftwareWithholdPct(job, fallback = PRICING_ENGINE_CONFIG.externalSoftwareWithholdPct) {
  if (normalizeAuditExecutionMode(job?.auditExecutionMode) !== AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE) {
    return 0;
  }
  const configuredValue = Number(job?.externalSoftwareWithholdPct);
  const resolved = Number.isFinite(configuredValue) ? configuredValue : Number(fallback || 0);
  return clampNumber(resolved, 0, 0.25);
}

function getAuditorPayoutOptions(pricing, externalSoftwareWithholdPct = PRICING_ENGINE_CONFIG.externalSoftwareWithholdPct) {
  const incertTemplateExVat = roundMoney(pricing?.providerPayoutExVat || 0);
  const ownSoftwareExVat = roundMoney(incertTemplateExVat * (1 - clampNumber(externalSoftwareWithholdPct, 0, 0.25)));
  return {
    incertTemplateExVat,
    ownSoftwareExVat,
    minExVat: Math.min(incertTemplateExVat, ownSoftwareExVat),
    maxExVat: Math.max(incertTemplateExVat, ownSoftwareExVat),
  };
}

function buildMarketplaceSettlement(pricing, options = {}) {
  if (!pricing) {
    return null;
  }

  const completedAt = options.completedAt ? new Date(options.completedAt) : new Date();
  const scheduledPayoutDate = getNextWeeklyPayoutDate(completedAt);
  const holdbackReleaseDate = addDays(scheduledPayoutDate, 10);
  const externalSoftwareWithholdPct = clampNumber(Number(options.externalSoftwareWithholdPct || 0), 0, 0.25);
  const holdbackAmount = roundMoney(pricing.providerPayoutExVat * PRICING_ENGINE_CONFIG.holdbackPct);
  const disputeReserveAmount = roundMoney(pricing.providerPayoutExVat * PRICING_ENGINE_CONFIG.disputeReservePct);
  const externalSoftwareWithholdAmount = roundMoney(pricing.providerPayoutExVat * externalSoftwareWithholdPct);
  const grossProviderAmount = pricing.providerPayoutExVat + pricing.providerVatAmount;

  return {
    payoutEvent: 'EVIDENCE_ISSUED',
    payoutStatus: options.payoutStatus || 'pending_completion',
    holdbackPct: PRICING_ENGINE_CONFIG.holdbackPct,
    disputeReservePct: PRICING_ENGINE_CONFIG.disputeReservePct,
    externalSoftwareWithholdPct,
    holdbackAmount,
    disputeReserveAmount,
    externalSoftwareWithholdAmount,
    providerAmountExVat: pricing.providerPayoutExVat,
    providerVatAmount: pricing.providerVatAmount,
    platformFeeExVat: pricing.platformFeeExVat,
    platformVatAmount: pricing.platformVatAmount,
    netProviderScheduled: roundMoney(
      Math.max(0, grossProviderAmount - holdbackAmount - disputeReserveAmount - externalSoftwareWithholdAmount)
    ),
    scheduledPayoutDate: options.scheduledPayoutDate || scheduledPayoutDate,
    holdbackReleaseDate: options.holdbackReleaseDate || holdbackReleaseDate,
    updatedAt: new Date().toISOString(),
  };
}

function buildDefaultMarketplaceScope() {
  return {
    template: 'portfolio_sweep',
    assetCount: 1,
    estimatedHours: 2,
    complexity: 'standard',
    equipment: 'none',
    travelKm: 12,
    weekendAccess: false,
    expedite: false,
  };
}

function normalizeMarketplaceScope(scope) {
  const fallback = buildDefaultMarketplaceScope();
  const nextScope = scope && typeof scope === 'object' ? scope : fallback;
  return {
    template: nextScope.template || fallback.template,
    assetCount: Math.max(1, Number(nextScope.assetCount || fallback.assetCount)),
    estimatedHours: Math.max(1, Number(nextScope.estimatedHours || fallback.estimatedHours)),
    complexity: nextScope.complexity || fallback.complexity,
    equipment: nextScope.equipment || fallback.equipment,
    travelKm: Math.max(0, Number(nextScope.travelKm || fallback.travelKm)),
    weekendAccess: Boolean(nextScope.weekendAccess),
    expedite: Boolean(nextScope.expedite),
  };
}

function resolveMinimumTakeRate(scope) {
  if (!scope || typeof scope !== 'object') {
    return PRICING_ENGINE_CONFIG.takeRateFloor;
  }

  if (
    scope.expedite ||
    scope.weekendAccess ||
    scope.complexity === 'restricted' ||
    scope.complexity === 'out_of_hours'
  ) {
    return PRICING_ENGINE_CONFIG.premiumTakeRateFloor;
  }

  return PRICING_ENGINE_CONFIG.takeRateFloor;
}

function computeAuditorPerformanceIndex(auditor) {
  if (!auditor || typeof auditor !== 'object') {
    return PRICING_ENGINE_CONFIG.defaultAuditorPerformanceIndex;
  }

  const ratingScore = clampNumber((Number(auditor.rating || 4.2) - 3.5) / 1.5, 0, 1);
  const completionScore = clampNumber((Number(auditor.completionRate || 94) - 85) / 15, 0, 1);
  const responseScore = clampNumber((120 - Number(auditor.avgResponseMins || 80)) / 90, 0, 1);
  const maxConcurrentJobs = Math.max(1, Number(auditor.maxConcurrentJobs || 8));
  const loadScore = clampNumber(1 - Number(auditor.activeJobs || 0) / maxConcurrentJobs, 0, 1);

  return Number((ratingScore * 0.4 + completionScore * 0.3 + responseScore * 0.2 + loadScore * 0.1).toFixed(3));
}

function resolveAuditorHourlyRate({ auditor, travelMiles, isOutOfHours, isExpedite, siteRegion }) {
  const performanceIndex = computeAuditorPerformanceIndex(auditor);
  const distanceScore = clampNumber(Number(travelMiles || 0) / 45, 0, 1);
  const regionalAcceptanceScore = auditor
    ? getSiteRegion(auditor.baseLocation) === siteRegion
      ? 0.04
      : 0.1
    : 0.06;
  const urgencyScore = isExpedite ? 0.08 : 0;
  const outOfHoursScore = isOutOfHours ? 0.07 : 0;
  const blendedIndex = clampNumber(
    performanceIndex * 0.65 + distanceScore * 0.2 + regionalAcceptanceScore + urgencyScore + outOfHoursScore,
    0,
    1
  );
  const hourlyRate = clampNumber(
    PRICING_ENGINE_CONFIG.minAuditorHourlyRate +
      (PRICING_ENGINE_CONFIG.maxAuditorHourlyRate - PRICING_ENGINE_CONFIG.minAuditorHourlyRate) * blendedIndex,
    PRICING_ENGINE_CONFIG.minAuditorHourlyRate,
    PRICING_ENGINE_CONFIG.maxAuditorHourlyRate
  );

  return {
    auditorHourlyRate: Number(hourlyRate.toFixed(2)),
    auditorPerformanceIndex: performanceIndex,
    hourlyBandIndex: Number(blendedIndex.toFixed(3)),
  };
}

function calculateMarketplaceQuote({ scope, regime, site, auditor = null }) {
  const normalizedScope = normalizeMarketplaceScope(scope);
  const complexityMultiplier =
    ACCESS_COMPLEXITY_MULTIPLIERS[normalizedScope.complexity] || ACCESS_COMPLEXITY_MULTIPLIERS.standard;
  const equipmentSurcharge = EQUIPMENT_SURCHARGES[normalizedScope.equipment] || 0;
  const regimeMultiplier = REGIME_MULTIPLIERS[regime] || 1;
  const siteRegion = getSiteRegion(site);
  const isOutOfHours = normalizedScope.complexity === 'out_of_hours' || normalizedScope.weekendAccess;
  const isPortfolioSweep = normalizedScope.template === 'portfolio_sweep';
  const extraAssetCount = Math.max(0, normalizedScope.assetCount - 1);
  const portfolioSweepMultiplier = isPortfolioSweep
    ? 1 +
      Math.min(
        PRICING_ENGINE_CONFIG.portfolioSweepAssetMultiplierCap,
        extraAssetCount * PRICING_ENGINE_CONFIG.portfolioSweepAssetMultiplierPerExtraAsset
      )
    : 1;
  const urgencyMultiplier = normalizedScope.expedite ? PRICING_ENGINE_CONFIG.urgencyLabourMultiplier : 1;
  const outOfHoursMultiplier = isOutOfHours ? PRICING_ENGINE_CONFIG.outOfHoursLabourMultiplier : 1;
  const regimeHoursMultiplier = REGIME_HOURS_MULTIPLIERS[regime] || 1;

  const travelMiles = normalizedScope.travelKm * 0.621371;
  const travelHours = travelMiles / 28;
  const chargeableTravelHours = travelHours * PRICING_ENGINE_CONFIG.travelTimeMultiplier;
  const onSiteHours = normalizedScope.estimatedHours;
  const chargeableHours = onSiteHours + chargeableTravelHours;
  const billableHours = Math.max(
    PRICING_ENGINE_CONFIG.minAuditorBillableHours,
    chargeableHours * complexityMultiplier * regimeHoursMultiplier * portfolioSweepMultiplier
  );
  const { auditorHourlyRate, auditorPerformanceIndex, hourlyBandIndex } = resolveAuditorHourlyRate({
    auditor,
    travelMiles,
    isOutOfHours,
    isExpedite: normalizedScope.expedite,
    siteRegion,
  });
  const auditorBaseLabourPayout = roundMoney(billableHours * auditorHourlyRate);
  const urgencySurcharge = roundMoney(auditorBaseLabourPayout * (urgencyMultiplier - 1));
  const outOfHoursSurcharge = roundMoney((auditorBaseLabourPayout + urgencySurcharge) * (outOfHoursMultiplier - 1));
  const auditorLabourPayout = auditorBaseLabourPayout + urgencySurcharge + outOfHoursSurcharge;
  const customerTravel = roundMoney(travelMiles * PRICING_ENGINE_CONFIG.customerMileageRatePerMile);
  const auditorTravelPayout = roundMoney(travelMiles * PRICING_ENGINE_CONFIG.auditorMileageRatePerMile);
  const customerEquipmentCharge = roundMoney(equipmentSurcharge * portfolioSweepMultiplier);
  const auditorEquipmentPayout = roundMoney(customerEquipmentCharge * PRICING_ENGINE_CONFIG.auditorEquipmentPayoutRatio);
  const providerCompCore = auditorLabourPayout + auditorEquipmentPayout;
  const directAuditorPayout = providerCompCore + auditorTravelPayout;
  const thirdPartyMarginPct = getProviderThirdPartyMarginPct(auditor);
  const thirdPartyPartnerFee = roundMoney(directAuditorPayout * thirdPartyMarginPct);
  const providerComp = directAuditorPayout + thirdPartyPartnerFee;

  const minimumTakeRate = resolveMinimumTakeRate(normalizedScope);
  const baseTakeRate = clampNumber(
    PRICING_ENGINE_CONFIG.baseTakeRate + (normalizedScope.expedite ? PRICING_ENGINE_CONFIG.urgencyTakeRateDelta : 0),
    minimumTakeRate,
    PRICING_ENGINE_CONFIG.takeRateCeiling
  );
  const sweepTakeRateUplift = isPortfolioSweep
    ? Math.min(
        PRICING_ENGINE_CONFIG.sweepTakeRateUpliftCap,
        extraAssetCount * PRICING_ENGINE_CONFIG.sweepTakeRateUpliftPerExtraAsset
      )
    : 0;
  const effectiveTargetTakeRate = clampNumber(
    baseTakeRate + sweepTakeRateUplift,
    minimumTakeRate,
    PRICING_ENGINE_CONFIG.takeRateCeiling
  );

  const platformFeeCoreNoSweepRaw = providerCompCore / (1 - baseTakeRate) - providerCompCore;
  const platformFeeCoreNoSweep = roundMoney(Math.max(0, platformFeeCoreNoSweepRaw));
  const platformFeeCoreTargetRaw = providerCompCore / (1 - effectiveTargetTakeRate) - providerCompCore;
  const platformFeeCoreTarget = roundMoney(Math.max(0, platformFeeCoreTargetRaw));
  const travelMargin = Math.max(0, customerTravel - auditorTravelPayout);
  const platformFeeNoSweep = roundMoney(platformFeeCoreNoSweep + travelMargin);
  const platformFeeTarget = roundMoney(platformFeeCoreTarget + travelMargin);
  const sweepUpsell = Math.max(0, platformFeeTarget - platformFeeNoSweep);

  const marketHourlyRate = PRICING_ENGINE_CONFIG.marketHourlyRateByRegime[regime] || PRICING_ENGINE_CONFIG.marketHourlyRateByRegime.LOLER;
  const marketLabourCharge = roundMoney(Math.max(220, billableHours * marketHourlyRate));
  const marketOpsPremiumPct =
    minimumTakeRate >= PRICING_ENGINE_CONFIG.premiumTakeRateFloor
      ? PRICING_ENGINE_CONFIG.marketOpsPremiumPctPremium
      : PRICING_ENGINE_CONFIG.marketOpsPremiumPct;
  const marketOpsPremium = roundMoney((marketLabourCharge + customerTravel + customerEquipmentCharge) * marketOpsPremiumPct);
  const marketSubtotalBenchmark = marketLabourCharge + customerTravel + customerEquipmentCharge + marketOpsPremium;
  const minimumTakeSubtotal = roundMoney(providerComp / (1 - minimumTakeRate));
  const subtotalBenchmarkFloor = Math.max(marketSubtotalBenchmark, minimumTakeSubtotal);
  const targetSubtotalExVat = providerComp + platformFeeTarget;
  const goingRateAlignment = Math.max(0, subtotalBenchmarkFloor - targetSubtotalExVat);

  const platformFee = roundMoney(platformFeeTarget + goingRateAlignment);
  const subtotalExVat = providerComp + platformFee;
  const providerVatAmount = roundMoney(providerComp * DEFAULT_VAT_RATE);
  const platformVatAmount = roundMoney(platformFee * DEFAULT_VAT_RATE);
  const vatAmount = providerVatAmount + platformVatAmount;
  const total = subtotalExVat + vatAmount;

  const lineItems = [
    { code: 'AUDITOR_LABOUR', label: 'Auditor labour payout', amountExVat: auditorBaseLabourPayout },
    ...(urgencySurcharge > 0 ? [{ code: 'URGENCY', label: 'Urgency surcharge', amountExVat: urgencySurcharge }] : []),
    ...(outOfHoursSurcharge > 0
      ? [{ code: 'OUT_OF_HOURS', label: 'Out-of-hours surcharge', amountExVat: outOfHoursSurcharge }]
      : []),
    {
      code: 'TRAVEL_MILEAGE',
      label: `Travel mileage (customer @ Â£${PRICING_ENGINE_CONFIG.customerMileageRatePerMile.toFixed(2)}/mile)`,
      amountExVat: customerTravel,
    },
    ...(customerEquipmentCharge > 0
      ? [{ code: 'EQUIPMENT', label: 'Equipment surcharge', amountExVat: customerEquipmentCharge }]
      : []),
    ...(thirdPartyPartnerFee > 0
      ? [{ code: 'THIRD_PARTY_PARTNER', label: 'Audit company coordination fee', amountExVat: thirdPartyPartnerFee }]
      : []),
    {
      code: 'SYSTEM_CHARGE',
      label: 'Platform/documentation operations fee',
      amountExVat: platformFeeNoSweep,
    },
    ...(sweepUpsell > 0 ? [{ code: 'SWEEP_UPSELL', label: 'Portfolio sweep upsell', amountExVat: sweepUpsell }] : []),
    ...(goingRateAlignment > 0
      ? [{ code: 'GOING_RATE_ALIGNMENT', label: 'Going-rate alignment', amountExVat: goingRateAlignment }]
      : []),
  ];

  return {
    labour: auditorBaseLabourPayout,
    travel: customerTravel,
    equipment: customerEquipmentCharge,
    expedite: urgencySurcharge + outOfHoursSurcharge,
    platformFee,
    platformFeeExVat: platformFee,
    providerPayoutExVat: providerComp,
    directAuditorPayoutExVat: directAuditorPayout,
    thirdPartyPartnerFeeExVat: thirdPartyPartnerFee,
    thirdPartyMarginPct,
    thirdPartyOrganizationId: String(auditor?.thirdPartyOrganizationId || ''),
    thirdPartyOrganizationName: String(
      getThirdPartyOrganizationById(auditor?.thirdPartyOrganizationId)?.name || ''
    ),
    auditorTravelPayoutExVat: auditorTravelPayout,
    auditorEquipmentPayoutExVat: auditorEquipmentPayout,
    auditorHourlyRate,
    auditorBillableHours: Number(billableHours.toFixed(2)),
    auditorPerformanceIndex,
    hourlyBandIndex,
    providerVatAmount,
    platformVatAmount,
    subtotalExVat,
    vatRate: DEFAULT_VAT_RATE,
    vatAmount,
    total,
    quoteVersion: 1,
    quoteId: buildMarketplaceQuoteId('TMP', 1),
    pricingModelVersion: DEFAULT_PRICING_MODEL_VERSION,
    rateCardVersionId: buildMarketplaceRateCardVersionId(regime, site),
    mappingEstimateTimestamp: new Date().toISOString(),
    validUntil: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
    routeEstimate: {
      miles: roundMoney(travelMiles),
      travelHours: Number(travelHours.toFixed(2)),
      chargeableTravelHours: Number(chargeableTravelHours.toFixed(2)),
      onSiteHours: Number(onSiteHours.toFixed(2)),
      chargeableHours: Number(chargeableHours.toFixed(2)),
    },
    effectiveTakeRate: Number((platformFee / Math.max(1, subtotalExVat)).toFixed(4)),
    assumptions: [
      `${normalizedScope.assetCount} asset(s)`,
      `${normalizedScope.expedite ? 'ASAP' : 'Scheduled'} dispatch`,
      `${isOutOfHours ? 'Out-of-hours capable' : 'Weekday access'}`,
      `Auditor payout band Â£${PRICING_ENGINE_CONFIG.minAuditorHourlyRate}-Â£${PRICING_ENGINE_CONFIG.maxAuditorHourlyRate}/hour`,
      `Resolved payout rate Â£${auditorHourlyRate.toFixed(2)}/hour over ${Number(billableHours.toFixed(2))}h`,
      `Mileage charge Â£${PRICING_ENGINE_CONFIG.customerMileageRatePerMile.toFixed(2)}/mile, payout Â£${PRICING_ENGINE_CONFIG.auditorMileageRatePerMile.toFixed(2)}/mile`,
      `Minimum platform take ${formatPercentage(minimumTakeRate)}`,
      isPortfolioSweep
        ? `Portfolio sweep multiplier x${portfolioSweepMultiplier.toFixed(2)} (${extraAssetCount} extra asset(s))`
        : 'Single-asset pricing profile',
      `Market benchmark labour Â£${marketHourlyRate}/hour with ${Math.round(marketOpsPremiumPct * 100)}% ops premium`,
      ...(goingRateAlignment > 0 ? [`Going-rate alignment ${formatCurrencyGBP(goingRateAlignment)} ex VAT`] : []),
      `Mileage margin contribution ${formatCurrencyGBP(travelMargin)} ex VAT`,
      ...(thirdPartyPartnerFee > 0
        ? [`Audit company margin ${formatCurrencyGBP(thirdPartyPartnerFee)} ex VAT (${formatPercentage(thirdPartyMarginPct)})`]
        : []),
      `Travel ${roundMoney(travelMiles)} miles (chargeable ${Number(chargeableTravelHours.toFixed(2))}h)`,
    ],
    lineItems,
  };
}

function normalizeMarketplacePricing(pricing, context) {
  const baseQuote = calculateMarketplaceQuote({
    scope: context.scope,
    regime: context.regime,
    site: context.site,
  });

  const fromInput = pricing && typeof pricing === 'object' ? pricing : {};
  const isStructuredQuote =
    fromInput &&
    typeof fromInput.quoteId === 'string' &&
    typeof fromInput.subtotalExVat === 'number' &&
    typeof fromInput.vatAmount === 'number';
  const isCurrentModelQuote = fromInput.pricingModelVersion === DEFAULT_PRICING_MODEL_VERSION;
  const useLegacyValues = isStructuredQuote && isCurrentModelQuote;
  const jobId = context.jobId || 'TMP';
  const quoteVersion = Math.max(1, Number((useLegacyValues ? fromInput.quoteVersion : fromInput.quoteVersion || 1) || 1));

  if (!useLegacyValues) {
    return {
      ...baseQuote,
      quoteVersion,
      quoteId: buildMarketplaceQuoteId(jobId, quoteVersion),
      pricingModelVersion: DEFAULT_PRICING_MODEL_VERSION,
      rateCardVersionId: fromInput.rateCardVersionId || baseQuote.rateCardVersionId,
      mappingEstimateTimestamp: fromInput.mappingEstimateTimestamp || baseQuote.mappingEstimateTimestamp || new Date().toISOString(),
      assumptions: Array.isArray(fromInput.assumptions) ? fromInput.assumptions : baseQuote.assumptions,
      lineItems: Array.isArray(fromInput.lineItems) ? fromInput.lineItems : baseQuote.lineItems,
      validUntil: fromInput.validUntil || baseQuote.validUntil,
    };
  }

  const fromLegacy = fromInput;

  const legacyLabour = roundMoney(fromLegacy.labour ?? baseQuote.labour);
  const legacyTravel = roundMoney(fromLegacy.travel ?? baseQuote.travel);
  const legacyEquipment = roundMoney(fromLegacy.equipment ?? baseQuote.equipment);
  const legacyExpedite = roundMoney(fromLegacy.expedite ?? baseQuote.expedite);
  const legacyPlatformFee = roundMoney(fromLegacy.platformFee ?? baseQuote.platformFee);
  const legacySubtotal =
    roundMoney(
      fromLegacy.subtotalExVat ??
        (fromLegacy.total && !isStructuredQuote
          ? fromLegacy.total
          : legacyLabour + legacyTravel + legacyEquipment + legacyExpedite + legacyPlatformFee)
    );
  const legacyVat = roundMoney(fromLegacy.vatAmount ?? legacySubtotal * DEFAULT_VAT_RATE);
  const legacyTotal = roundMoney(
    isStructuredQuote
      ? fromLegacy.total ?? legacySubtotal + legacyVat
      : fromLegacy.totalIncVat ?? legacySubtotal + legacyVat
  );
  return {
    ...baseQuote,
    ...fromLegacy,
    quoteVersion,
    quoteId: fromLegacy.quoteId || buildMarketplaceQuoteId(jobId, quoteVersion),
    pricingModelVersion: DEFAULT_PRICING_MODEL_VERSION,
    rateCardVersionId: fromLegacy.rateCardVersionId || buildMarketplaceRateCardVersionId(context.regime, context.site),
    mappingEstimateTimestamp: fromLegacy.mappingEstimateTimestamp || new Date().toISOString(),
    labour: legacyLabour,
    travel: legacyTravel,
    equipment: legacyEquipment,
    expedite: legacyExpedite,
    platformFee: legacyPlatformFee,
    platformFeeExVat: roundMoney(fromLegacy.platformFeeExVat ?? legacyPlatformFee),
    subtotalExVat: legacySubtotal,
    vatRate: Number(fromLegacy.vatRate ?? DEFAULT_VAT_RATE),
    vatAmount: legacyVat,
    total: legacyTotal,
    providerPayoutExVat: roundMoney(
      fromLegacy.providerPayoutExVat ??
        Math.max(0, legacySubtotal - roundMoney(fromLegacy.platformFeeExVat ?? legacyPlatformFee))
    ),
    providerVatAmount: roundMoney(fromLegacy.providerVatAmount ?? legacyVat - roundMoney(fromLegacy.platformVatAmount ?? 0)),
    platformVatAmount: roundMoney(fromLegacy.platformVatAmount ?? roundMoney(legacyPlatformFee * DEFAULT_VAT_RATE)),
    effectiveTakeRate: Number(
      (
        roundMoney(fromLegacy.platformFeeExVat ?? legacyPlatformFee) /
        Math.max(1, legacySubtotal)
      ).toFixed(4)
    ),
    assumptions: Array.isArray(fromLegacy.assumptions) ? fromLegacy.assumptions : baseQuote.assumptions,
    lineItems: Array.isArray(fromLegacy.lineItems) ? fromLegacy.lineItems : baseQuote.lineItems,
    validUntil: fromLegacy.validUntil || baseQuote.validUntil,
  };
}

function buildAdjustedMarketplaceQuote({ previousQuote, jobId, adjustmentType, amountExVatDelta, reasonCode, evidenceRef }) {
  const quoteVersion = Math.max(1, Number(previousQuote?.quoteVersion || 1)) + 1;
  const nextSubtotalExVat = roundMoney(Math.max(0, Number(previousQuote?.subtotalExVat || 0) + Number(amountExVatDelta || 0)));
  const carryForwardTakeRate = clampNumber(
    Number(previousQuote?.effectiveTakeRate || PRICING_ENGINE_CONFIG.baseTakeRate),
    PRICING_ENGINE_CONFIG.takeRateFloor,
    PRICING_ENGINE_CONFIG.takeRateCeiling
  );
  const nextPlatformFeeFloor = roundMoney(nextSubtotalExVat * PRICING_ENGINE_CONFIG.takeRateFloor);
  const nextPlatformFeeCeiling = roundMoney(nextSubtotalExVat * PRICING_ENGINE_CONFIG.takeRateCeiling);
  const nextPlatformFee = roundMoney(
    clampNumber(
      nextSubtotalExVat * carryForwardTakeRate,
      nextPlatformFeeFloor,
      nextPlatformFeeCeiling
    )
  );
  const nextProviderPayout = Math.max(0, nextSubtotalExVat - nextPlatformFee);
  const nextProviderVat = roundMoney(nextProviderPayout * DEFAULT_VAT_RATE);
  const nextPlatformVat = roundMoney(nextPlatformFee * DEFAULT_VAT_RATE);
  const nextVatAmount = nextProviderVat + nextPlatformVat;
  const nextTotal = nextSubtotalExVat + nextVatAmount;

  const adjustmentItem = {
    code: `ADJUSTMENT_${String(adjustmentType || 'manual').toUpperCase()}`,
    label: `Adjustment (${String(reasonCode || adjustmentType || 'manual').replace(/_/g, ' ')})`,
    amountExVat: roundMoney(amountExVatDelta),
    metadata: {
      evidenceRef: evidenceRef || '',
      appliedAt: new Date().toISOString(),
    },
  };

  return {
    ...previousQuote,
    quoteVersion,
    quoteId: buildMarketplaceQuoteId(jobId, quoteVersion),
    subtotalExVat: nextSubtotalExVat,
    platformFee: nextPlatformFee,
    platformFeeExVat: nextPlatformFee,
    providerPayoutExVat: nextProviderPayout,
    providerVatAmount: nextProviderVat,
    platformVatAmount: nextPlatformVat,
    vatAmount: nextVatAmount,
    total: nextTotal,
    effectiveTakeRate: Number((nextPlatformFee / Math.max(1, nextSubtotalExVat)).toFixed(4)),
    mappingEstimateTimestamp: new Date().toISOString(),
    assumptions: [
      ...(Array.isArray(previousQuote?.assumptions) ? previousQuote.assumptions : []),
      `Adjustment ${String(adjustmentType || 'manual').replace(/_/g, ' ')} ${amountExVatDelta >= 0 ? '+' : ''}${formatCurrencyGBP(amountExVatDelta)} ex VAT`,
    ].slice(-6),
    lineItems: [...(Array.isArray(previousQuote?.lineItems) ? previousQuote.lineItems : []), adjustmentItem],
  };
}

function getMarketplaceJobScope(job) {
  if (job?.scope) {
    return normalizeMarketplaceScope(job.scope);
  }

  return normalizeMarketplaceScope({
    template: 'portfolio_sweep',
    assetCount: 1,
    estimatedHours: 2.2,
    complexity: 'standard',
    equipment: 'none',
    travelKm: 12,
    weekendAccess: false,
    expedite: false,
  });
}

function getMarketplaceJobPricing(job) {
  const scope = getMarketplaceJobScope(job);
  const pricingSource =
    job?.pricing && typeof job.pricing === 'object'
      ? job.pricing
      : job?.budget
        ? { total: roundMoney(job.budget) }
        : null;
  return normalizeMarketplacePricing(pricingSource, {
    scope,
    regime: job?.regime,
    site: job?.site,
    jobId: job?.id,
  });
}

function getMarketplaceJobPricingHistory(job, currentPricing) {
  const pricingSnapshot = currentPricing || getMarketplaceJobPricing(job);
  if (!Array.isArray(job?.pricingHistory) || job.pricingHistory.length === 0) {
    return [pricingSnapshot];
  }

  return job.pricingHistory.map((quoteEntry, index) =>
    normalizeMarketplacePricing(quoteEntry, {
      scope: getMarketplaceJobScope(job),
      regime: job?.regime,
      site: job?.site,
      jobId: job?.id,
      quoteVersion: index + 1,
    })
  );
}

function getMarketplaceJobPricingAdjustments(job) {
  if (!Array.isArray(job?.pricingAdjustments)) {
    return [];
  }

  return job.pricingAdjustments
    .filter((item) => item && typeof item === 'object')
    .map((item, index) => ({
      adjustmentId: item.adjustmentId || `ADJ-${job?.id || 'JOB'}-${index + 1}`,
      type: item.type || 'manual',
      reasonCode: item.reasonCode || 'manual_adjustment',
      amountExVatDelta: roundMoney(item.amountExVatDelta),
      evidenceRef: item.evidenceRef || '',
      approvedByUserId: item.approvedByUserId || 'ops_user',
      quoteIdFrom: item.quoteIdFrom || '',
      quoteIdTo: item.quoteIdTo || '',
      createdAt: item.createdAt || new Date().toISOString(),
    }));
}

function getMarketplaceJobPricingLock(job, currentPricing) {
  const pricingSnapshot = currentPricing || getMarketplaceJobPricing(job);
  if (job?.pricingLock && typeof job.pricingLock === 'object') {
    return {
      pricingLockId: job.pricingLock.pricingLockId || `LOCK-${job?.id || 'JOB'}-${pricingSnapshot.quoteVersion}`,
      bookingId: job.pricingLock.bookingId || `BOOK-${job?.id || 'JOB'}`,
      quoteId: job.pricingLock.quoteId || pricingSnapshot.quoteId,
      lockedAt: job.pricingLock.lockedAt || new Date().toISOString(),
      lockedBy: job.pricingLock.lockedBy || 'InCert Dispatch Engine',
    };
  }

  const dispatch = getMarketplaceJobDispatch(job);
  if (!dispatch.acceptedAt) {
    return null;
  }

  return buildMarketplacePricingLock({
    jobId: job?.id || 'JOB',
    quote: pricingSnapshot,
    lockedAt: dispatch.acceptedAt,
    lockedBy: 'Dispatch acceptance',
  });
}

function getMarketplaceJobSettlement(job, currentPricing) {
  const pricingSnapshot = currentPricing || getMarketplaceJobPricing(job);
  const externalSoftwareWithholdPct = resolveExternalSoftwareWithholdPct(job);
  if (job?.settlement && typeof job.settlement === 'object') {
    const persistedExternalPct = clampNumber(
      Number(job.settlement.externalSoftwareWithholdPct ?? externalSoftwareWithholdPct),
      0,
      0.25
    );
    const holdbackAmount = roundMoney(
      job.settlement.holdbackAmount ??
        pricingSnapshot.providerPayoutExVat * PRICING_ENGINE_CONFIG.holdbackPct
    );
    const disputeReserveAmount = roundMoney(
      job.settlement.disputeReserveAmount ??
        pricingSnapshot.providerPayoutExVat * PRICING_ENGINE_CONFIG.disputeReservePct
    );
    const persistedExternalAmount = roundMoney(
      job.settlement.externalSoftwareWithholdAmount ??
        pricingSnapshot.providerPayoutExVat * persistedExternalPct
    );
    return {
      ...buildMarketplaceSettlement(pricingSnapshot, { externalSoftwareWithholdPct }),
      ...job.settlement,
      providerAmountExVat: roundMoney(job.settlement.providerAmountExVat ?? pricingSnapshot.providerPayoutExVat),
      providerVatAmount: roundMoney(job.settlement.providerVatAmount ?? pricingSnapshot.providerVatAmount),
      platformFeeExVat: roundMoney(job.settlement.platformFeeExVat ?? pricingSnapshot.platformFeeExVat),
      platformVatAmount: roundMoney(job.settlement.platformVatAmount ?? pricingSnapshot.platformVatAmount),
      externalSoftwareWithholdPct: persistedExternalPct,
      externalSoftwareWithholdAmount: persistedExternalAmount,
      holdbackAmount,
      disputeReserveAmount,
      netProviderScheduled: roundMoney(
        job.settlement.netProviderScheduled ??
          (pricingSnapshot.providerPayoutExVat +
            pricingSnapshot.providerVatAmount -
            holdbackAmount -
            disputeReserveAmount -
            persistedExternalAmount)
      ),
    };
  }

  const dispatch = getMarketplaceJobDispatch(job);
  if (job?.status === 'completed') {
    return buildMarketplaceSettlement(pricingSnapshot, {
      payoutStatus: 'scheduled',
      completedAt: dispatch.acceptedAt || new Date().toISOString(),
      externalSoftwareWithholdPct,
    });
  }

  if (job?.status === 'awaiting_review') {
    return buildMarketplaceSettlement(pricingSnapshot, {
      payoutStatus: 'pending_review',
      completedAt: dispatch.acceptedAt || new Date().toISOString(),
      externalSoftwareWithholdPct,
    });
  }

  if (dispatch.acceptedAt) {
    return buildMarketplaceSettlement(pricingSnapshot, {
      payoutStatus: 'pending_completion',
      completedAt: dispatch.acceptedAt,
      externalSoftwareWithholdPct,
    });
  }

  return null;
}

function resolveDispatchSlaMinutes(scope) {
  if (scope.expedite) {
    return 120;
  }
  if (scope.weekendAccess) {
    return 240;
  }
  return 360;
}

function resolveOfferTtlMinutes(scope) {
  return scope.expedite ? 45 : 90;
}

function getMarketplaceJobDispatch(job) {
  const scope = getMarketplaceJobScope(job);
  const dispatch = job?.dispatch && typeof job.dispatch === 'object' ? job.dispatch : {};
  const createdAtDate = parseISODate(job?.createdAt || '');
  const baseDate = createdAtDate || new Date();
  const slaMinutes = Math.max(30, Number(dispatch.slaMinutes || resolveDispatchSlaMinutes(scope)));
  const defaultDeadlineAt = new Date(baseDate.getTime() + slaMinutes * 60000).toISOString();

  return {
    slaMinutes,
    dispatchDeadlineAt: dispatch.dispatchDeadlineAt || defaultDeadlineAt,
    dispatchedAt: dispatch.dispatchedAt || null,
    offerExpiresAt: dispatch.offerExpiresAt || null,
    acceptedAt: dispatch.acceptedAt || null,
    attempts: Math.max(0, Number(dispatch.attempts || 0)),
  };
}

function isOfferExpired(job, nowTimestamp = Date.now()) {
  if (job?.status !== 'offered') {
    return false;
  }
  const dispatch = getMarketplaceJobDispatch(job);
  if (!dispatch.offerExpiresAt) {
    return false;
  }
  const offerExpiry = new Date(dispatch.offerExpiresAt).getTime();
  if (Number.isNaN(offerExpiry)) {
    return false;
  }
  return offerExpiry <= nowTimestamp;
}

function getTimelineStamp(date = new Date()) {
  return new Intl.DateTimeFormat('en-GB', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  })
    .format(date)
    .replace(',', '');
}

function extractStructuredNoteValue(notes, label) {
  const noteText = String(notes || '');
  if (!noteText) {
    return '';
  }

  const pattern = new RegExp(`^${label}:\\s*(.+)$`, 'im');
  const match = noteText.match(pattern);
  return match ? String(match[1] || '').trim() : '';
}

function getNextInvoiceId(invoices) {
  const highest = invoices.reduce((max, invoice) => {
    const value = Number(String(invoice.id || '').replace(/[^0-9]/g, ''));
    if (Number.isNaN(value)) {
      return max;
    }
    return Math.max(max, value);
  }, 1000);

  return `INV-${String(highest + 1).padStart(5, '0')}`;
}

function getNextPayoutRunId(payoutRuns) {
  const highest = payoutRuns.reduce((max, run) => {
    const value = Number(String(run.id || '').replace(/[^0-9]/g, ''));
    if (Number.isNaN(value)) {
      return max;
    }
    return Math.max(max, value);
  }, 500);

  return `PAY-${String(highest + 1).padStart(5, '0')}`;
}

function getNextTemplateId(templates) {
  const highest = templates.reduce((max, template) => {
    const value = Number(String(template.id || '').replace(/[^0-9]/g, ''));
    if (Number.isNaN(value)) {
      return max;
    }
    return Math.max(max, value);
  }, 0);

  return `TPL-CUSTOM-${String(highest + 1).padStart(3, '0')}`;
}

function getNextEntityId(collection, prefix, minValue = 1, padding = 4) {
  const highest = collection.reduce((max, item) => {
    const value = Number(String(item?.id || '').replace(/[^0-9]/g, ''));
    if (Number.isNaN(value)) {
      return max;
    }
    return Math.max(max, value);
  }, minValue - 1);
  return `${prefix}-${String(highest + 1).padStart(padding, '0')}`;
}

function getDefaultChecklistControlsByRegime(regime) {
  const normalized = String(regime || '').toUpperCase();
  if (normalized === 'LOLER') {
    return [
      'Asset identification and SWL verified',
      'Safety devices and guards checked',
      'Operator controls and emergency stop tested',
      'Load path and environment free from hazards',
    ];
  }
  if (normalized === 'PUWER') {
    return [
      'Work equipment suitable for task',
      'Controls and isolation points tested',
      'Guards/interlocks present and effective',
      'Operator instructions and signage available',
    ];
  }
  if (normalized === 'PSSR') {
    return [
      'Written scheme in date and available',
      'Pressure boundaries visually checked',
      'Relief devices set and in calibration',
      'Associated controls and alarms verified',
    ];
  }
  return [
    'Site access and permit verified',
    'Primary controls checked',
    'Evidence captured',
    'Findings and actions reviewed',
  ];
}

function normalizeCompanyIdentifier(value) {
  return String(value || '')
    .trim()
    .toLowerCase()
    .replace(/&/g, 'and')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function normalizeFinanceIdentityKey(value) {
  return String(value || '').trim().toLowerCase();
}

function resolveCompanyTemplateContext(companyContext = {}) {
  const normalizedCompanyId = normalizeCompanyIdentifier(companyContext?.companyId || companyContext?.id);
  const normalizedCompanyName = normalizeCompanyIdentifier(companyContext?.companyName || companyContext?.name);
  return {
    companyId: normalizedCompanyId || normalizedCompanyName,
    companyName: String(companyContext?.companyName || companyContext?.name || '').trim(),
  };
}

function getTemplateVisibility(template) {
  return String(template?.visibility || '').toLowerCase() === 'company' ? 'company' : 'global';
}

function getTemplateOwnerKey(template) {
  const normalizedOwnerId = normalizeCompanyIdentifier(template?.ownerCompanyId);
  if (normalizedOwnerId) {
    return normalizedOwnerId;
  }
  return normalizeCompanyIdentifier(template?.ownerCompanyName);
}

function isTemplateVisibleForCompany(template, companyContext = null) {
  if (!template || typeof template !== 'object') {
    return false;
  }
  if (getTemplateVisibility(template) !== 'company') {
    return true;
  }
  const ownerKey = getTemplateOwnerKey(template);
  if (!ownerKey) {
    return false;
  }
  const resolvedCompany = resolveCompanyTemplateContext(companyContext || {});
  if (!resolvedCompany.companyId) {
    return false;
  }
  return ownerKey === resolvedCompany.companyId;
}

function getInspectionTemplateMatchKey(template) {
  const templateIdKey = String(template?.templateId || '')
    .trim()
    .toUpperCase();
  if (templateIdKey) {
    return `TEMPLATE_ID::${templateIdKey}`;
  }

  return getInspectionTemplateLegacyMatchKey(template);
}

function getInspectionTemplateLegacyMatchKey(template) {
  const regimeKey = String(template?.regime || '')
    .trim()
    .toUpperCase();
  const nameKey = String(template?.name || '')
    .trim()
    .toLowerCase();
  const visibilityKey = getTemplateVisibility(template);
  const ownerKey = visibilityKey === 'company' ? getTemplateOwnerKey(template) : '';
  return `${regimeKey}::${nameKey}::${visibilityKey}::${ownerKey}`;
}

function normalizeTemplateControlList(controls) {
  const seen = new Set();
  return (Array.isArray(controls) ? controls : [])
    .map((control) => String(control || '').trim())
    .filter((control) => {
      if (!control) {
        return false;
      }
      const key = control.toLowerCase();
      if (seen.has(key)) {
        return false;
      }
      seen.add(key);
      return true;
    });
}

function getCatalogTemplateByInspectionTemplate(template, fallbackRegime = '') {
  if (!template || !Array.isArray(aooTemplateCatalog)) {
    return null;
  }

  const normalizedTemplateId = String(template?.templateId || '').trim();
  const normalizedName = String(template?.name || '')
    .trim()
    .toLowerCase();
  const normalizedRegime = String(template?.regime || fallbackRegime || '')
    .trim()
    .toUpperCase();

  return (
    aooTemplateCatalog.find((candidate) => {
      const candidateTemplateId = String(candidate?.templateId || '').trim();
      if (normalizedTemplateId && candidateTemplateId === normalizedTemplateId) {
        return true;
      }

      const candidateName = String(candidate?.name || '')
        .trim()
        .toLowerCase();
      const candidateRegime = String(candidate?.regime || '')
        .trim()
        .toUpperCase();
      return Boolean(normalizedName && normalizedRegime && candidateName === normalizedName && candidateRegime === normalizedRegime);
    }) || null
  );
}

function hydrateInspectionTemplateRecord(template, index, fallbackTemplate = null) {
  const sourceTemplate = template && typeof template === 'object' ? template : {};
  const fallback = fallbackTemplate && typeof fallbackTemplate === 'object' ? fallbackTemplate : {};

  const regime = String(sourceTemplate.regime || fallback.regime || 'PUWER');
  const name = String(sourceTemplate.name || fallback.name || `Template ${index + 1}`);
  const storedControls = normalizeTemplateControlList(sourceTemplate.controls);
  const fallbackControls = normalizeTemplateControlList(fallback.controls);
  const resolvedId = String(sourceTemplate.id || fallback.id || '').trim();
  const isCatalogManagedTemplate = Boolean(
    sourceTemplate.templateId ||
      fallback.templateId ||
      resolvedId.startsWith('TPL-AOO-') ||
      (Array.isArray(fallback.sourceCoverage) && fallback.sourceCoverage.length > 0)
  );
  const controls =
    isCatalogManagedTemplate && fallbackControls.length > 0
      ? fallbackControls
      : storedControls.length > 0
        ? storedControls
        : fallbackControls;

  const resolvedMaxScore = Number(sourceTemplate.maxScore ?? fallback.maxScore ?? controls.length);
  const maxScore = Number.isFinite(resolvedMaxScore) && resolvedMaxScore > 0
    ? Math.round(resolvedMaxScore)
    : Math.max(controls.length, 1);
  const resolvedPassScore = Number(sourceTemplate.passScore ?? fallback.passScore ?? Math.round(maxScore * 0.8));
  const passScore = Number.isFinite(resolvedPassScore) && resolvedPassScore > 0
    ? Math.min(maxScore, Math.round(resolvedPassScore))
    : Math.round(maxScore * 0.8);
  const hasCompanyOwner = Boolean(
    normalizeCompanyIdentifier(
      sourceTemplate.ownerCompanyId ||
        sourceTemplate.ownerCompanyName ||
        fallback.ownerCompanyId ||
        fallback.ownerCompanyName
    )
  );
  const explicitVisibility = String(sourceTemplate.visibility || fallback.visibility || '')
    .trim()
    .toLowerCase();
  const visibility = explicitVisibility === 'company' || (!explicitVisibility && hasCompanyOwner) ? 'company' : 'global';
  const ownerCompanyId = visibility === 'company'
    ? normalizeCompanyIdentifier(
        sourceTemplate.ownerCompanyId ||
          fallback.ownerCompanyId ||
          sourceTemplate.ownerCompanyName ||
          fallback.ownerCompanyName
      )
    : '';
  const ownerCompanyName = visibility === 'company'
    ? String(
        sourceTemplate.ownerCompanyName ||
          fallback.ownerCompanyName ||
          sourceTemplate.ownerCompanyId ||
          fallback.ownerCompanyId ||
          ''
      ).trim()
    : '';

  return {
    id: String(sourceTemplate.id || fallback.id || `TPL-CUSTOM-${index + 1}`),
    regime,
    name,
    version: String(sourceTemplate.version || fallback.version || '1.0'),
    active:
      typeof sourceTemplate.active === 'boolean'
        ? sourceTemplate.active
        : typeof fallback.active === 'boolean'
          ? fallback.active
          : true,
    controls,
    sourceCoverage: Array.isArray(sourceTemplate.sourceCoverage)
      ? [...sourceTemplate.sourceCoverage]
      : Array.isArray(fallback.sourceCoverage)
        ? [...fallback.sourceCoverage]
        : [],
    templateId: String(sourceTemplate.templateId || fallback.templateId || ''),
    passScore,
    maxScore,
    visibility,
    ownerCompanyId,
    ownerCompanyName,
  };
}

function hydrateInspectionTemplates(templates) {
  const normalizedDefaults = (Array.isArray(defaultInspectionTemplates) ? defaultInspectionTemplates : []).map(
    (template, index) => hydrateInspectionTemplateRecord(template, index)
  );

  const defaultTemplatesByKey = new Map();
  const defaultTemplatesByTemplateId = new Map();
  normalizedDefaults.forEach((template) => {
    const key = getInspectionTemplateMatchKey(template);
    if (key && key !== '::') {
      defaultTemplatesByKey.set(key, template);
    }
    const legacyKey = getInspectionTemplateLegacyMatchKey(template);
    if (legacyKey && legacyKey !== '::') {
      defaultTemplatesByKey.set(legacyKey, template);
    }
    const templateId = String(template.templateId || '').trim();
    if (templateId) {
      defaultTemplatesByTemplateId.set(templateId, template);
    }
  });

  const normalizedStoredTemplates = (Array.isArray(templates) ? templates : [])
    .filter((template) => template && typeof template === 'object')
    .map((template, index) => {
      const templateId = String(template?.templateId || '').trim();
      const fallbackByTemplateId = templateId ? defaultTemplatesByTemplateId.get(templateId) : null;
      const fallbackByName =
        defaultTemplatesByKey.get(getInspectionTemplateMatchKey(template)) ||
        defaultTemplatesByKey.get(getInspectionTemplateLegacyMatchKey(template));
      return hydrateInspectionTemplateRecord(template, index, fallbackByTemplateId || fallbackByName || null);
    });

  const dedupedTemplates = [];
  const seenKeys = new Set();

  const addIfUnique = (template, indexHint) => {
    const key = getInspectionTemplateMatchKey(template);
    const uniqueKey = key && key !== '::' ? key : `${template.id}-${indexHint}`;
    if (seenKeys.has(uniqueKey)) {
      return;
    }
    seenKeys.add(uniqueKey);
    dedupedTemplates.push(template);
  };

  normalizedStoredTemplates.forEach((template, index) => addIfUnique(template, index));
  normalizedDefaults.forEach((template, index) => addIfUnique(template, normalizedStoredTemplates.length + index));

  return dedupedTemplates;
}

function pickBestInspectionTemplateForRegime(templates, regime, options = {}) {
  const normalizedRegime = String(regime || '').toUpperCase();
  const normalizedTemplateId = String(options?.templateId || '').trim();
  const companyContext = resolveCompanyTemplateContext({
    companyId: options?.companyId,
    companyName: options?.companyName,
  });
  const allTemplates = Array.isArray(templates) ? templates.filter((template) => template && typeof template === 'object') : [];
  if (allTemplates.length === 0) {
    return null;
  }

  if (normalizedTemplateId) {
    const exactTemplate = allTemplates.find((template) => {
      const templateInternalId = String(template?.id || '').trim();
      const templateCatalogId = String(template?.templateId || '').trim();
      const matchesId = templateInternalId === normalizedTemplateId || templateCatalogId === normalizedTemplateId;
      return matchesId && isTemplateVisibleForCompany(template, companyContext);
    });
    if (exactTemplate) {
      return exactTemplate;
    }
  }

  const activeTemplates = allTemplates.filter((template) => template?.active);
  if (activeTemplates.length === 0) {
    return null;
  }

  const visibleTemplates = activeTemplates.filter((template) => isTemplateVisibleForCompany(template, companyContext));
  const globalFallbackTemplates = activeTemplates.filter((template) => getTemplateVisibility(template) === 'global');
  const scopedTemplates = visibleTemplates.length > 0 ? visibleTemplates : globalFallbackTemplates;
  if (scopedTemplates.length === 0) {
    return null;
  }

  const regimeTemplates = scopedTemplates.filter(
    (template) => String(template?.regime || '').toUpperCase() === normalizedRegime
  );
  const candidateTemplates = regimeTemplates.length > 0 ? regimeTemplates : scopedTemplates;

  const getControlCount = (template) => {
    const directControls = Array.isArray(template?.controls) ? template.controls.length : 0;
    const catalogTemplate = getCatalogTemplateByInspectionTemplate(template, normalizedRegime);
    const catalogBooleanControls = Array.isArray(catalogTemplate?.questions)
      ? catalogTemplate.questions.filter((question) => String(question?.type || '').toLowerCase() === 'boolean').length
      : 0;
    return Math.max(directControls, catalogBooleanControls);
  };

  const getTemplatePriority = (template) => {
    const isCompanyScoped =
      getTemplateVisibility(template) === 'company' && isTemplateVisibleForCompany(template, companyContext);
    return isCompanyScoped ? 2 : 1;
  };

  return candidateTemplates.reduce((bestTemplate, currentTemplate) => {
    if (!bestTemplate) {
      return currentTemplate;
    }
    const bestPriority = getTemplatePriority(bestTemplate);
    const currentPriority = getTemplatePriority(currentTemplate);
    if (currentPriority !== bestPriority) {
      return currentPriority > bestPriority ? currentTemplate : bestTemplate;
    }
    const bestControlCount = getControlCount(bestTemplate);
    const currentControlCount = getControlCount(currentTemplate);
    return currentControlCount > bestControlCount ? currentTemplate : bestTemplate;
  }, null);
}

function incrementTemplateVersion(versionValue) {
  const [majorRaw, minorRaw] = String(versionValue || '1.0').split('.');
  const major = Number(majorRaw);
  const minor = Number(minorRaw || '0');
  if (Number.isNaN(major) || Number.isNaN(minor)) {
    return '1.0';
  }
  return `${major}.${minor + 1}`;
}

const TEMPLATE_QUESTION_TYPES = ['boolean', 'text', 'select', 'numeric'];

function sanitizeTemplateQuestionId(value, fallbackPrefix, index, usedIds) {
  const normalizedPrefix = String(fallbackPrefix || 'Q')
    .replace(/[^A-Za-z0-9]/g, '')
    .toUpperCase()
    .slice(0, 8) || 'Q';
  const rawId = String(value || '')
    .replace(/[^A-Za-z0-9_-]/g, '')
    .toUpperCase();
  const defaultId = `${normalizedPrefix}${String(index + 1).padStart(3, '0')}`;
  const baseId = rawId || defaultId;
  let candidateId = baseId;
  let suffix = 1;
  while (usedIds.has(candidateId)) {
    candidateId = `${baseId}_${suffix}`;
    suffix += 1;
  }
  usedIds.add(candidateId);
  return candidateId;
}

function normalizeTemplateQuestionBank(questions = [], fallbackPrefix = 'Q') {
  const usedIds = new Set();
  return (Array.isArray(questions) ? questions : [])
    .map((question, index) => {
      const safeQuestion = question && typeof question === 'object' ? question : {};
      const typeValue = String(safeQuestion.type || 'boolean').toLowerCase();
      const type = TEMPLATE_QUESTION_TYPES.includes(typeValue) ? typeValue : 'boolean';
      const weightValue = Number(safeQuestion.weight);
      const weight = Number.isFinite(weightValue) ? Math.max(1, Math.round(weightValue)) : 1;
      const questionId = sanitizeTemplateQuestionId(safeQuestion.id, fallbackPrefix, index, usedIds);
      const text = String(safeQuestion.text || '').trim();
      const category = String(safeQuestion.category || 'General').trim() || 'General';
      const showIfRaw = String(safeQuestion.showIf || '').trim();
      const options =
        type === 'boolean'
          ? { yes: 1, no: 0 }
          : safeQuestion.options && typeof safeQuestion.options === 'object'
            ? safeQuestion.options
            : {};

      return {
        id: questionId,
        category,
        text: text || `Question ${index + 1}`,
        type,
        options,
        weight,
        critical: type === 'boolean' ? Boolean(safeQuestion.critical) : false,
        required: Boolean(safeQuestion.required),
        evidence: {
          photo: Boolean(safeQuestion?.evidence?.photo),
          comment: safeQuestion?.evidence?.comment !== false,
          signature: Boolean(safeQuestion?.evidence?.signature),
        },
        showIf: showIfRaw || null,
      };
    })
    .filter((question) => String(question.text || '').trim().length > 0);
}

const TEMPLATE_REPORT_LOCATION_PROFILES = [
  {
    siteName: 'Meridian Logistics Centre',
    addressLine1: 'Unit 14 Meridian Industrial Park',
    addressLine2: 'Birmingham',
    postcode: 'B24 8EZ',
    primaryContact: 'Leah Davenport',
    primaryPhone: '+44 121 555 0187',
    primaryEmail: 'leah.davenport@meridian-logistics.co.uk',
    emergencyPhone: '+44 800 011 9001',
  },
  {
    siteName: 'Kingsway Retail Complex',
    addressLine1: '28 Kingsway Exchange',
    addressLine2: 'Leeds',
    postcode: 'LS1 4PX',
    primaryContact: 'Tom Eastwood',
    primaryPhone: '+44 113 555 0262',
    primaryEmail: 'tom.eastwood@kingswayretail.co.uk',
    emergencyPhone: '+44 800 011 9015',
  },
  {
    siteName: 'South Dock Distribution Hub',
    addressLine1: 'Plot 6 South Dock Freight Estate',
    addressLine2: 'Bristol',
    postcode: 'BS11 0YH',
    primaryContact: 'Nia Morgan',
    primaryPhone: '+44 117 555 0149',
    primaryEmail: 'nia.morgan@southdockhub.co.uk',
    emergencyPhone: '+44 800 011 9061',
  },
  {
    siteName: 'Riverside Manufacturing Campus',
    addressLine1: 'Riverside Works, Foundry Road',
    addressLine2: 'Sheffield',
    postcode: 'S9 3HF',
    primaryContact: 'Harvey Patel',
    primaryPhone: '+44 114 555 0218',
    primaryEmail: 'harvey.patel@riversidemfg.co.uk',
    emergencyPhone: '+44 800 011 9084',
  },
  {
    siteName: 'Northgate Hospitality Quarter',
    addressLine1: '75 Northgate Square',
    addressLine2: 'Manchester',
    postcode: 'M2 4WQ',
    primaryContact: 'Ava McKenna',
    primaryPhone: '+44 161 555 0126',
    primaryEmail: 'ava.mckenna@northgatehq.co.uk',
    emergencyPhone: '+44 800 011 9024',
  },
  {
    siteName: 'Cedar Medical Services Centre',
    addressLine1: '2 Cedar Way',
    addressLine2: 'Nottingham',
    postcode: 'NG2 1AB',
    primaryContact: 'Dr Samir Qureshi',
    primaryPhone: '+44 115 555 0104',
    primaryEmail: 'samir.qureshi@cedarmedical.co.uk',
    emergencyPhone: '+44 800 011 9072',
  },
];

const TEMPLATE_REPORT_BUSINESS_TYPE_BY_CATEGORY = {
  HS: 'Corporate multi-site operations',
  FRA: 'High-occupancy managed building',
  LOLER: 'Lifting equipment operations',
  PUWER: 'Industrial work-equipment estate',
  PSSR: 'Pressure systems and utilities',
  COSHH: 'Hazardous substance controlled environment',
  ASBESTOS: 'Legacy-building risk management',
  LEGIONELLA: 'Water-system safety controls',
  ELECTRICAL: 'Electrical safety compliance programme',
  SCAFFOLD: 'Construction and temporary works',
  FOOD: 'Food production and service operations',
  WORKPLACE: 'General workplace safety management',
  SUPPLEMENTAL: 'Supplementary statutory checks',
  MACHINE: 'Machine safety and guarding',
  FIRE_DOOR: 'Fire compartmentation controls',
  RETAIL: 'Retail branch operations',
  HOSPITALITY: 'Hospitality and guest safety',
  WAREHOUSE: 'Warehousing and logistics operations',
  CONSTRUCTION: 'Project-based site safety',
  EDUCATION: 'Education and safeguarding environment',
  HEALTHCARE: 'Clinical and care-service environment',
  MYSTERY: 'Customer journey and service assurance',
  PEN_TEST: 'Cybersecurity and resilience assurance',
};

const TEMPLATE_REPORT_BUILDING_TYPE_BY_CATEGORY = {
  HS: 'Head office and mixed-use estate',
  FRA: 'Commercial premises with public access',
  LOLER: 'Lift shafts, pits, and machine rooms',
  PUWER: 'Production floor and maintenance bays',
  PSSR: 'Plant room and compressor house',
  COSHH: 'Chemical storage and controlled handling areas',
  ASBESTOS: 'Multi-phase legacy construction site',
  LEGIONELLA: 'Domestic and process water network',
  ELECTRICAL: 'Distribution boards and switchgear areas',
  SCAFFOLD: 'Temporary elevated access structures',
  FOOD: 'Kitchen, prep, and cold-chain areas',
  WORKPLACE: 'Office, welfare, and shared spaces',
  SUPPLEMENTAL: 'Specialist verification areas',
  MACHINE: 'Machine shop and guarding zones',
  FIRE_DOOR: 'Compartmented escape routes',
  RETAIL: 'Front-of-house and stockroom',
  HOSPITALITY: 'Guest rooms and back-of-house',
  WAREHOUSE: 'Loading bays and racking aisles',
  CONSTRUCTION: 'Active construction workfront',
  EDUCATION: 'Classrooms and shared corridors',
  HEALTHCARE: 'Clinical wards and treatment rooms',
  MYSTERY: 'Customer-facing service environment',
  PEN_TEST: 'Network perimeter and critical systems',
};

const TEMPLATE_REPORT_MOTIFS = ['orbits', 'chevrons', 'wave', 'mesh', 'strata'];

const TEMPLATE_REPORT_CATEGORY_HUES = {
  HS: 188,
  FRA: 14,
  LOLER: 220,
  PUWER: 164,
  PSSR: 204,
  COSHH: 28,
  ASBESTOS: 8,
  LEGIONELLA: 196,
  ELECTRICAL: 42,
  SCAFFOLD: 232,
  FOOD: 148,
  WORKPLACE: 176,
  SUPPLEMENTAL: 210,
  MACHINE: 206,
  FIRE_DOOR: 18,
  RETAIL: 302,
  HOSPITALITY: 338,
  WAREHOUSE: 196,
  CONSTRUCTION: 26,
  EDUCATION: 262,
  HEALTHCARE: 332,
  MYSTERY: 286,
  PEN_TEST: 248,
};

function createDeterministicSeed(value) {
  const source = String(value || '');
  let hash = 2166136261;
  for (let index = 0; index < source.length; index += 1) {
    hash ^= source.charCodeAt(index) + index;
    hash = Math.imul(hash, 16777619);
  }
  return hash >>> 0;
}

function createPseudoDigest(input, length = 64) {
  const source = String(input || 'incert');
  let seed = createDeterministicSeed(source) || 1;
  let digest = '';

  while (digest.length < length) {
    seed ^= seed << 13;
    seed ^= seed >>> 17;
    seed ^= seed << 5;
    const chunk = (seed >>> 0).toString(16).padStart(8, '0');
    digest += chunk;
  }

  return digest.slice(0, Math.max(8, length));
}

function getTemplateCategoryLabel(categoryValue) {
  const normalizedCategory = String(categoryValue || '').toUpperCase();
  const option = templateCategoryOptions.find((entry) => String(entry?.value || '').toUpperCase() === normalizedCategory);
  return option?.label || normalizedCategory || 'General';
}

function buildTemplateReportTheme(template, templateIndex = 0) {
  const category = String(template?.category || 'HS').toUpperCase();
  const seedSource = `${template?.id || ''}|${template?.name || ''}|${category}|${template?.currentVersion || '1.0'}|${templateIndex}`;
  const seed = createDeterministicSeed(seedSource);
  const baseHue = TEMPLATE_REPORT_CATEGORY_HUES[category] ?? 196;
  const hueShift = (seed % 24) - 12;
  const hueA = (baseHue + hueShift + 360) % 360;
  const hueB = (hueA + 24 + (seed % 18)) % 360;
  const hueC = (hueA + 190) % 360;
  const motif = TEMPLATE_REPORT_MOTIFS[seed % TEMPLATE_REPORT_MOTIFS.length];
  const motifId = `motif-${String(template?.id || 'tpl').replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}-${seed % 1000}`;

  return {
    motif,
    motifId,
    pageBackground: `linear-gradient(140deg, hsl(${hueA} 65% 97%), hsl(${hueB} 78% 96%))`,
    heroBackground: `linear-gradient(128deg, hsl(${hueA} 62% 19%), hsl(${hueB} 68% 26%))`,
    accent: `hsl(${hueA} 72% 43%)`,
    accentSoft: `hsl(${hueA} 68% 94%)`,
    accentBright: `hsl(${hueB} 72% 56%)`,
    neutralInk: 'hsl(215 28% 18%)',
    muterInk: 'hsl(215 17% 40%)',
    danger: 'hsl(350 74% 48%)',
    success: 'hsl(154 70% 36%)',
    motifColorA: `hsla(${hueC}, 72%, 96%, 0.44)`,
    motifColorB: `hsla(${hueB}, 76%, 80%, 0.34)`,
  };
}

function evaluateTemplateQuestionForReport(template, question, questionIndex, completedAtIso) {
  const questionSeed = createDeterministicSeed(`${template?.id || 'TPL'}:${question?.id || ''}:${questionIndex}`);
  const questionType = String(question?.type || 'boolean').toLowerCase();
  const weight = Math.max(1, Number(question?.weight || 1));
  const options = question?.options && typeof question.options === 'object' ? question.options : {};
  const evidenceConfig = question?.evidence || {};

  let answerValue = '';
  let answerLabel = '';
  let isCompliant = true;
  let normalizedScore = 1;

  if (questionType === 'boolean') {
    const noThreshold = question?.critical ? 14 : 24;
    const isNo = (questionSeed % 100) < noThreshold;
    answerValue = isNo ? 0 : 1;
    answerLabel = isNo ? 'No' : 'Yes';
    isCompliant = !isNo;
    normalizedScore = isCompliant ? 1 : 0;
  } else if (questionType === 'numeric') {
    const numericValue = 45 + (questionSeed % 56);
    answerValue = numericValue;
    answerLabel = `${numericValue}%`;
    isCompliant = numericValue >= 72;
    normalizedScore = isCompliant ? Math.max(0.75, numericValue / 100) : Math.max(0.3, (numericValue / 100) * 0.72);
  } else if (questionType === 'select') {
    const optionEntries = Object.entries(options);
    const fallbackOptions = optionEntries.length > 0 ? optionEntries : [['pass', 1], ['improvement_required', 0.5], ['fail', 0]];
    const selectedOption = fallbackOptions[questionSeed % fallbackOptions.length];
    const optionKey = String(selectedOption[0] || '').trim();
    const optionScoreRaw = Number(selectedOption[1]);
    const normalizedOptionScore = Number.isFinite(optionScoreRaw)
      ? Math.max(0, Math.min(1, optionScoreRaw))
      : /pass|yes|compliant|good|ok/i.test(optionKey)
        ? 1
        : /warn|partial|improvement|minor/i.test(optionKey)
          ? 0.55
          : 0;
    answerValue = optionKey;
    answerLabel = optionKey.replaceAll('_', ' ') || 'Selected';
    isCompliant = normalizedOptionScore >= 0.6;
    normalizedScore = normalizedOptionScore;
  } else {
    const hasGap = question?.required ? (questionSeed % 100) < 22 : (questionSeed % 100) < 14;
    answerValue = hasGap
      ? 'Evidence partially available; procedure consistency needs improvement.'
      : 'Control observed and records reviewed during walkthrough.';
    answerLabel = hasGap ? 'Needs follow-up' : 'Control confirmed';
    isCompliant = !hasGap;
    normalizedScore = hasGap ? 0.45 : 0.9;
  }

  const evidenceKinds = [];
  if (evidenceConfig.photo) {
    evidenceKinds.push('Photo');
  }
  if (evidenceConfig.comment !== false) {
    evidenceKinds.push('Comment');
  }
  if (evidenceConfig.signature) {
    evidenceKinds.push('Signature');
  }
  if (evidenceKinds.length === 0 && (question?.required || !isCompliant)) {
    evidenceKinds.push('Comment');
  }

  const evidenceRecords = evidenceKinds.map((kind, evidenceIndex) => {
    const offsetMinutes = (questionIndex + 1) * 9 + evidenceIndex * 4;
    const capturedAt = new Date(new Date(completedAtIso).getTime() - offsetMinutes * 60_000).toISOString();
    const recordId = `EVD-${String(questionIndex + 1).padStart(3, '0')}-${String(evidenceIndex + 1).padStart(2, '0')}`;
    const fingerprint = createPseudoDigest(
      `${template?.id || 'TPL'}:${question?.id || ''}:${kind}:${capturedAt}:${recordId}`,
      48
    );
    const verified = (createDeterministicSeed(`${recordId}:${fingerprint}`) % 9) !== 0 || !question?.required;

    return {
      id: recordId,
      kind,
      capturedAt,
      fingerprint,
      verified,
      verifier: verified ? 'InCert Evidence Vault' : 'Pending verifier',
    };
  });

  const hasPendingVerification = evidenceRecords.some((record) => !record.verified);
  const evidenceVerificationStatus =
    evidenceRecords.length === 0 ? 'not_required' : hasPendingVerification ? 'pending' : 'verified';

  const needsAction = !isCompliant || (question?.required && evidenceVerificationStatus === 'pending');
  const severity = !isCompliant && question?.critical ? 'critical' : !isCompliant ? 'high' : hasPendingVerification ? 'medium' : 'low';
  const score = Number((weight * Math.max(0, Math.min(1, normalizedScore))).toFixed(2));

  return {
    id: question?.id || `Q${questionIndex + 1}`,
    category: question?.category || 'General',
    text: question?.text || `Question ${questionIndex + 1}`,
    type: questionType,
    weight,
    score,
    critical: Boolean(question?.critical),
    required: Boolean(question?.required),
    answerValue,
    answerLabel,
    isCompliant,
    needsAction,
    severity,
    evidenceRecords,
    evidenceSummary:
      evidenceRecords.length > 0
        ? evidenceRecords.map((record) => `${record.kind} ${record.id}`).join(', ')
        : 'No evidence required',
    evidenceVerificationStatus,
  };
}

function buildTemplateCompletionReportModel(template, templateIndex = 0) {
  const safeTemplate = template && typeof template === 'object' ? template : {};
  const templateId = String(safeTemplate.id || `TPLX-${String(templateIndex + 1).padStart(4, '0')}`);
  const category = String(safeTemplate.category || 'HS').toUpperCase();
  const templateName = String(safeTemplate.name || `Template ${templateIndex + 1}`);
  const currentVersion = String(safeTemplate.currentVersion || '1.0');
  const questionBank = normalizeTemplateQuestionBank(safeTemplate.questionBank || [], category || templateId);
  const seed = createDeterministicSeed(`${templateId}:${templateName}:${category}:${currentVersion}:${templateIndex}`);
  const locationProfile = TEMPLATE_REPORT_LOCATION_PROFILES[seed % TEMPLATE_REPORT_LOCATION_PROFILES.length];
  const categoryLabel = getTemplateCategoryLabel(category);
  const theme = buildTemplateReportTheme(safeTemplate, templateIndex);
  const businessType = TEMPLATE_REPORT_BUSINESS_TYPE_BY_CATEGORY[category] || 'Compliance assurance programme';
  const buildingType = TEMPLATE_REPORT_BUILDING_TYPE_BY_CATEGORY[category] || 'Managed operational site';
  const equipmentFocus = questionBank
    .slice(0, 3)
    .map((question) => String(question.category || '').trim())
    .filter(Boolean)
    .filter((value, index, source) => source.indexOf(value) === index)
    .join(', ') || 'General controls';

  const completedAt = new Date(Date.now() - ((seed % 7) + 1) * 24 * 60 * 60 * 1000);
  const startedAt = new Date(completedAt.getTime() - (((seed >> 4) % 11) + 3) * 60 * 60 * 1000);
  const nextReviewAt = new Date(completedAt.getTime() + (90 + (seed % 60)) * 24 * 60 * 60 * 1000);
  const completedDateIso = completedAt.toISOString();
  const reportId = `RPT-${createPseudoDigest(`${templateId}:${completedDateIso}:report`, 10).toUpperCase()}`;
  const auditReference = `${templateId}-${completedAt.getFullYear()}${String(completedAt.getMonth() + 1).padStart(2, '0')}${String(completedAt.getDate()).padStart(2, '0')}`;
  const vaultRecordId = `VLT-${createPseudoDigest(`${templateId}:${completedDateIso}:vault`, 8).toUpperCase()}`;
  const tamperSealId = `SEAL-${createPseudoDigest(`${templateId}:${completedDateIso}:seal`, 8).toUpperCase()}`;
  const verificationRunId = `VRF-${createPseudoDigest(`${templateId}:${completedDateIso}:verify`, 8).toUpperCase()}`;
  const evidenceMerkleRoot = createPseudoDigest(`${templateId}:${completedDateIso}:merkle`, 64);
  const chainHash = createPseudoDigest(`${templateId}:${reportId}:chain`, 64);
  const signatureBundleId = `SIG-${createPseudoDigest(`${templateId}:${currentVersion}:signature`, 10).toUpperCase()}`;

  const questionResults = questionBank.map((question, questionIndex) =>
    evaluateTemplateQuestionForReport(safeTemplate, question, questionIndex, completedDateIso)
  );

  const maxScore = questionResults.reduce((total, result) => total + Math.max(1, Number(result.weight || 1)), 0);
  const awardedScore = questionResults.reduce((total, result) => total + Number(result.score || 0), 0);
  const passScoreConfigured = Number(safeTemplate?.passThreshold?.passScore || 0);
  const passScore = passScoreConfigured > 0 ? passScoreConfigured : Math.max(1, Math.ceil(maxScore * 0.8));
  const passPercent = maxScore > 0 ? Math.round((awardedScore / maxScore) * 100) : 0;
  const criticalFailures = questionResults.filter((result) => result.critical && !result.isCompliant);
  const nonCompliantQuestions = questionResults.filter((result) => !result.isCompliant);
  const pendingVerificationCount = questionResults.filter((result) => result.evidenceVerificationStatus === 'pending').length;
  const requiresActionCount = questionResults.filter((result) => result.needsAction).length;
  const isPass = awardedScore >= passScore && criticalFailures.length === 0;
  const statusLabel = isPass ? 'Pass' : 'Action required';

  const autoActionMap = new Map(
    (Array.isArray(safeTemplate.autoActions) ? safeTemplate.autoActions : [])
      .filter((action) => action && typeof action === 'object' && action.questionId)
      .map((action) => [String(action.questionId), action])
  );

  const defaultRecommendationOwner = category === 'PEN_TEST' ? 'Security Lead' : category === 'MYSTERY' ? 'Operations Manager' : 'Site Manager';
  const recommendationsSource = questionResults.filter((result) => result.needsAction);
  const recommendations = recommendationsSource.slice(0, 8).map((result, index) => {
    const linkedAction = autoActionMap.get(String(result.id));
    const dueDays = Number(linkedAction?.dueWithinDays || (result.critical ? 7 : result.severity === 'high' ? 14 : 21));
    const recommendationText = linkedAction?.action
      ? linkedAction.action
      : result.evidenceVerificationStatus === 'pending'
        ? `Complete evidence verification for ${result.id} and re-run vault integrity check.`
        : `Resolve: ${result.text.replace(/\?$/, '')}. Capture closure evidence and re-verify.`;

    return {
      id: `REC-${String(index + 1).padStart(2, '0')}`,
      questionId: result.id,
      severity: result.severity,
      recommendation: recommendationText,
      owner: linkedAction?.assignee || defaultRecommendationOwner,
      dueWithinDays: Math.max(2, dueDays),
    };
  });

  if (recommendations.length === 0) {
    recommendations.push({
      id: 'REC-01',
      questionId: 'GENERAL',
      severity: 'low',
      recommendation: 'Maintain current controls and schedule routine spot checks to preserve performance.',
      owner: defaultRecommendationOwner,
      dueWithinDays: 30,
    });
  }

  const evidenceLedger = questionResults
    .flatMap((result) =>
      result.evidenceRecords.map((record) => ({
        questionId: result.id,
        questionText: result.text,
        kind: record.kind,
        recordId: record.id,
        fingerprint: record.fingerprint,
        capturedAt: record.capturedAt,
        verified: record.verified,
        verifier: record.verifier,
      }))
    )
    .slice(0, 24);

  const totalEvidenceCount = evidenceLedger.length;
  const verifiedEvidenceCount = evidenceLedger.filter((entry) => entry.verified).length;
  const verificationCoverage = totalEvidenceCount > 0 ? Math.round((verifiedEvidenceCount / totalEvidenceCount) * 100) : 100;

  const verificationUrl = `${getAppBaseUrl()}#verify=${encodeURIComponent(reportId)}`;
  const vaultUrl = `${getAppBaseUrl()}#vaultRecord=${encodeURIComponent(vaultRecordId)}`;
  const tamperUrl = `${getAppBaseUrl()}#seal=${encodeURIComponent(tamperSealId)}`;

  return {
    template: {
      id: templateId,
      name: templateName,
      category,
      categoryLabel,
      version: currentVersion,
      scoringModel: String(safeTemplate.scoringModel || 'weighted_sections'),
    },
    audit: {
      reportId,
      auditReference,
      completedAt: completedDateIso,
      startedAt: startedAt.toISOString(),
      nextReviewAt: nextReviewAt.toISOString(),
      auditorName: category === 'PEN_TEST' ? 'InCert Cyber Assurance Team' : 'InCert Lead Auditor Team',
      auditorPhone: category === 'PEN_TEST' ? '+44 20 3903 4102' : '+44 20 3903 4101',
      auditorEmail: category === 'PEN_TEST' ? 'cyber.assurance@incert.co.uk' : 'audits@incert.co.uk',
      executionMode: category === 'MYSTERY' ? 'Mystery shopper observed visit' : category === 'PEN_TEST' ? 'Authorised penetration test' : 'On-site compliance audit',
    },
    site: {
      ...locationProfile,
      businessType,
      buildingType,
      equipmentFocus,
    },
    summary: {
      isPass,
      statusLabel,
      awardedScore: Number(awardedScore.toFixed(2)),
      maxScore: Number(maxScore.toFixed(2)),
      passScore: Number(passScore.toFixed(2)),
      passPercent,
      questionCount: questionResults.length,
      nonCompliantCount: nonCompliantQuestions.length,
      criticalFailureCount: criticalFailures.length,
      pendingVerificationCount,
      requiresActionCount,
      verificationCoverage,
    },
    recommendations,
    questionResults,
    evidence: {
      mandatoryBlocks: Math.max(0, Number(safeTemplate.mandatoryEvidenceBlocks || 0)),
      ledger: evidenceLedger,
      totalEvidenceCount,
      verifiedEvidenceCount,
      verificationCoverage,
    },
    security: {
      vaultRecordId,
      tamperSealId,
      verificationRunId,
      signatureBundleId,
      evidenceMerkleRoot,
      chainHash,
      timestampAuthority: 'InCert Vault TSA Node EU-WEST-2',
      chainNode: `INCERT-VAULT-NODE-${String((seed % 9) + 1).padStart(2, '0')}`,
      trustMode: verificationCoverage === 100 ? 'Verified' : 'Partially verified',
    },
    links: {
      verificationUrl,
      vaultUrl,
      tamperUrl,
    },
    theme,
  };
}

function normalizeAuditAnswerValue(value) {
  const normalizedValue = String(value || '').trim().toLowerCase();
  if (normalizedValue === 'yes' || normalizedValue === 'y' || normalizedValue === 'pass') {
    return 'yes';
  }
  if (normalizedValue === 'no' || normalizedValue === 'n' || normalizedValue === 'fail') {
    return 'no';
  }
  return 'na';
}

function buildCompletedAuditRunReportModel({
  auditRun = null,
  templateBlueprint = null,
  completionPayload = null,
  job = null,
  auditor = null,
  companyContext = { id: '', name: '' },
}) {
  const payload = completionPayload && typeof completionPayload === 'object' ? completionPayload : {};
  const templateId = String(
    payload.templateId ||
      templateBlueprint?.id ||
      auditRun?.templateId ||
      job?.inspectionTemplateId ||
      `TPLR-${String(job?.id || '0000').replace(/[^A-Z0-9]/gi, '').slice(-6)}`
  )
    .trim()
    .toUpperCase();
  const templateName = String(
    payload.templateName ||
      templateBlueprint?.name ||
      job?.inspectionTemplateName ||
      `${String(job?.regime || 'General').toUpperCase()} Audit Checklist`
  ).trim();
  const templateCategory = String(
    payload.templateCategory ||
      templateBlueprint?.category ||
      job?.regime ||
      'HS'
  )
    .trim()
    .toUpperCase();
  const templateVersion = String(
    payload.templateVersion ||
      auditRun?.templateVersion ||
      templateBlueprint?.currentVersion ||
      '1.0'
  );

  const seedSource = `${templateId}:${job?.id || auditRun?.id || 'RUN'}:${templateCategory}`;
  const seed = createDeterministicSeed(seedSource);
  const locationProfile = TEMPLATE_REPORT_LOCATION_PROFILES[seed % TEMPLATE_REPORT_LOCATION_PROFILES.length];
  const categoryLabel = getTemplateCategoryLabel(templateCategory);
  const theme = buildTemplateReportTheme(
    {
      id: templateId,
      name: templateName,
      category: templateCategory,
      currentVersion: templateVersion,
    },
    seed % 17
  );

  const startedAtIso = String(auditRun?.startedAt || payload.startedAt || new Date().toISOString());
  const completedAtIso = String(auditRun?.completedAt || payload.completedAt || new Date().toISOString());
  const nextReviewAt = new Date(completedAtIso);
  nextReviewAt.setDate(nextReviewAt.getDate() + 90 + (seed % 45));

  const reportId = `RPT-${createPseudoDigest(`${templateId}:${completedAtIso}:${job?.id || auditRun?.id || ''}`, 10).toUpperCase()}`;
  const completedAtDate = new Date(completedAtIso);
  const auditReference = `${templateId}-${completedAtDate.getFullYear()}${String(completedAtDate.getMonth() + 1).padStart(2, '0')}${String(
    completedAtDate.getDate()
  ).padStart(2, '0')}`;
  const vaultRecordId = `VLT-${createPseudoDigest(`${reportId}:vault`, 8).toUpperCase()}`;
  const tamperSealId = `SEAL-${createPseudoDigest(`${reportId}:seal`, 8).toUpperCase()}`;
  const verificationRunId = `VRF-${createPseudoDigest(`${reportId}:verify`, 8).toUpperCase()}`;
  const evidenceMerkleRoot = createPseudoDigest(`${reportId}:merkle`, 64);
  const chainHash = createPseudoDigest(`${reportId}:chain`, 64);
  const signatureBundleId = `SIG-${createPseudoDigest(`${reportId}:signature`, 10).toUpperCase()}`;

  const payloadAnswers = Array.isArray(payload.answers) ? payload.answers : [];
  const fallbackQuestionBank = normalizeTemplateQuestionBank(
    templateBlueprint?.questionBank || [],
    templateCategory || templateId
  );

  const normalizedAnswerEntries = payloadAnswers.length > 0
    ? payloadAnswers.map((answer, index) => ({
        id: String(answer.questionId || answer.id || `Q${index + 1}`).trim(),
        category: String(answer.category || 'General').trim() || 'General',
        text: String(answer.text || `Question ${index + 1}`).trim(),
        weight: Math.max(1, Number(answer.weight || 1)),
        critical: Boolean(answer.critical),
        required: Boolean(answer.required),
        response: normalizeAuditAnswerValue(answer.response),
        notes: String(answer.notes || '').trim(),
        evidenceFiles: Array.isArray(answer.evidenceFiles) ? answer.evidenceFiles.map((file) => String(file || '').trim()).filter(Boolean) : [],
      }))
    : fallbackQuestionBank.map((question, index) => ({
        id: String(question.id || `Q${index + 1}`).trim(),
        category: String(question.category || 'General').trim() || 'General',
        text: String(question.text || `Question ${index + 1}`).trim(),
        weight: Math.max(1, Number(question.weight || 1)),
        critical: Boolean(question.critical),
        required: Boolean(question.required),
        response: normalizeAuditAnswerValue(payload.responsesByQuestionId?.[question.id]),
        notes: String(payload.notesByQuestionId?.[question.id] || '').trim(),
        evidenceFiles: Array.isArray(payload.evidenceByQuestionId?.[question.id])
          ? payload.evidenceByQuestionId[question.id].map((file) => String(file || '').trim()).filter(Boolean)
          : [],
      }));

  const questionResults = normalizedAnswerEntries.map((answer, index) => {
    const response = normalizeAuditAnswerValue(answer.response);
    const isCompliant = response !== 'no';
    const isApplicable = response !== 'na';
    const score = isApplicable && response === 'yes' ? answer.weight : 0;
    const evidenceFiles = answer.evidenceFiles;
    const needsEvidence = response === 'no' || answer.required;

    const evidenceRecords = evidenceFiles.map((filename, evidenceIndex) => {
      const capturedAt = new Date(new Date(completedAtIso).getTime() - (index + 1 + evidenceIndex) * 5 * 60_000).toISOString();
      const recordId = `EVD-${String(index + 1).padStart(3, '0')}-${String(evidenceIndex + 1).padStart(2, '0')}`;
      const fingerprint = createPseudoDigest(`${reportId}:${answer.id}:${filename}:${capturedAt}`, 48);
      return {
        id: recordId,
        kind: 'File',
        filename,
        capturedAt,
        fingerprint,
        verified: true,
        verifier: 'InCert Evidence Vault',
      };
    });

    if (needsEvidence && evidenceRecords.length === 0) {
      evidenceRecords.push({
        id: `EVD-${String(index + 1).padStart(3, '0')}-01`,
        kind: 'Pending',
        filename: 'evidence-required',
        capturedAt: completedAtIso,
        fingerprint: createPseudoDigest(`${reportId}:${answer.id}:pending`, 48),
        verified: false,
        verifier: 'Pending verifier',
      });
    }

    const hasPendingEvidence = evidenceRecords.some((record) => !record.verified);
    const evidenceVerificationStatus =
      evidenceRecords.length === 0 ? 'not_required' : hasPendingEvidence ? 'pending' : 'verified';
    const needsAction = response === 'no' || evidenceVerificationStatus === 'pending';
    const severity = response === 'no' && answer.critical ? 'critical' : response === 'no' ? 'high' : hasPendingEvidence ? 'medium' : 'low';

    return {
      id: answer.id || `Q${index + 1}`,
      category: answer.category || 'General',
      text: answer.text || `Question ${index + 1}`,
      type: 'boolean',
      weight: answer.weight,
      score,
      critical: Boolean(answer.critical),
      required: Boolean(answer.required),
      answerValue: response,
      answerLabel: response === 'yes' ? 'Yes' : response === 'no' ? 'No' : 'N/A',
      isCompliant,
      needsAction,
      severity,
      notes: answer.notes,
      evidenceRecords,
      evidenceSummary:
        evidenceRecords.length > 0
          ? evidenceRecords.map((record) => `${record.kind} ${record.id}`).join(', ')
          : 'No evidence required',
      evidenceVerificationStatus,
    };
  });

  const payloadSummary = payload.summary && typeof payload.summary === 'object' ? payload.summary : {};
  const fallbackScorePossible = questionResults.reduce(
    (total, result) => total + (result.answerValue === 'na' ? 0 : Math.max(1, Number(result.weight || 1))),
    0
  );
  const fallbackScoreEarned = questionResults.reduce((total, result) => total + Number(result.score || 0), 0);

  const scorePossibleRaw = Number(payloadSummary.scorePossible);
  const scoreEarnedRaw = Number(payloadSummary.scoreEarned);
  const scorePossible = Number.isFinite(scorePossibleRaw) && scorePossibleRaw > 0 ? scorePossibleRaw : fallbackScorePossible;
  const awardedScore = Number.isFinite(scoreEarnedRaw) ? Math.max(0, scoreEarnedRaw) : fallbackScoreEarned;
  const configuredPassPercent = Number(payloadSummary.effectivePassPercent || payloadSummary.passPercent || templateBlueprint?.passThreshold?.passPercent || 80);
  const effectivePassPercent = Math.max(60, Math.min(95, Number.isFinite(configuredPassPercent) ? configuredPassPercent : 80));
  const passScore = Math.max(1, Math.ceil(scorePossible * (effectivePassPercent / 100)));
  const passPercent = scorePossible > 0 ? Math.round((awardedScore / scorePossible) * 100) : 0;

  const criticalFailures = questionResults.filter((result) => result.critical && result.answerValue === 'no');
  const nonCompliantQuestions = questionResults.filter((result) => result.answerValue === 'no');
  const pendingVerificationCount = questionResults.filter((result) => result.evidenceVerificationStatus === 'pending').length;
  const requiresActionCount = questionResults.filter((result) => result.needsAction).length;
  const isPass =
    payloadSummary.isPassing !== undefined
      ? Boolean(payloadSummary.isPassing)
      : awardedScore >= passScore && criticalFailures.length === 0;
  const statusLabel = isPass ? 'Pass' : 'Action required';

  const recommendations = questionResults
    .filter((result) => result.needsAction)
    .slice(0, 8)
    .map((result, index) => {
      const dueWithinDays = result.critical ? 7 : result.severity === 'high' ? 14 : 21;
      const recommendation =
        result.evidenceVerificationStatus === 'pending'
          ? `Upload and verify evidence for ${result.id} (${result.text}).`
          : `Correct ${result.id}: ${result.text.replace(/\?$/, '')}. Capture closure evidence and re-audit.`;
      return {
        id: `REC-${String(index + 1).padStart(2, '0')}`,
        questionId: result.id,
        severity: result.severity,
        recommendation: result.notes ? `${recommendation} Auditor note: ${result.notes}` : recommendation,
        owner: result.critical ? 'HSE Lead' : templateCategory === 'PEN_TEST' ? 'Security Lead' : 'Site Manager',
        dueWithinDays,
      };
    });

  if (recommendations.length === 0) {
    recommendations.push({
      id: 'REC-01',
      questionId: 'GENERAL',
      severity: 'low',
      recommendation: 'No corrective actions required. Maintain controls and retain evidence pack.',
      owner: 'Site Manager',
      dueWithinDays: 30,
    });
  }

  const evidenceLedger = questionResults
    .flatMap((result) =>
      result.evidenceRecords.map((record) => ({
        questionId: result.id,
        questionText: result.text,
        kind: record.kind,
        recordId: record.id,
        fingerprint: record.fingerprint,
        capturedAt: record.capturedAt,
        verified: record.verified,
        verifier: record.verifier,
      }))
    )
    .slice(0, 30);

  const totalEvidenceCount = evidenceLedger.length;
  const verifiedEvidenceCount = evidenceLedger.filter((entry) => entry.verified).length;
  const verificationCoverage = totalEvidenceCount > 0 ? Math.round((verifiedEvidenceCount / totalEvidenceCount) * 100) : 100;

  const siteName = String(job?.site || locationProfile.siteName);
  const businessName = String(job?.companyName || companyContext?.name || 'InCert Client Organization');
  const verificationUrl = `${getAppBaseUrl()}#verify=${encodeURIComponent(reportId)}`;
  const vaultUrl = `${getAppBaseUrl()}#vaultRecord=${encodeURIComponent(vaultRecordId)}`;
  const tamperUrl = `${getAppBaseUrl()}#seal=${encodeURIComponent(tamperSealId)}`;

  return {
    template: {
      id: templateId,
      name: templateName,
      category: templateCategory,
      categoryLabel,
      version: templateVersion,
      scoringModel: String(templateBlueprint?.scoringModel || 'weighted_sections'),
    },
    audit: {
      reportId,
      auditReference,
      completedAt: completedAtIso,
      startedAt: startedAtIso,
      nextReviewAt: nextReviewAt.toISOString(),
      auditorName: String(auditor?.name || payload.auditorName || 'Assigned Auditor'),
      auditorPhone: String(payload.auditorPhone || '+44 20 3903 4101'),
      auditorEmail: String(payload.auditorEmail || 'audits@incert.co.uk'),
      executionMode: 'InCert checklist workflow',
    },
    site: {
      ...locationProfile,
      siteName,
      businessType: `${businessName} Â· ${TEMPLATE_REPORT_BUSINESS_TYPE_BY_CATEGORY[templateCategory] || 'Compliance programme'}`,
      buildingType: TEMPLATE_REPORT_BUILDING_TYPE_BY_CATEGORY[templateCategory] || 'Managed operational site',
      equipmentFocus: String(job?.assetName || payload.assetName || 'Mixed compliance controls'),
    },
    summary: {
      isPass,
      statusLabel,
      awardedScore: Number(awardedScore.toFixed(2)),
      maxScore: Number(scorePossible.toFixed(2)),
      passScore: Number(passScore.toFixed(2)),
      passPercent,
      questionCount: questionResults.length,
      nonCompliantCount: nonCompliantQuestions.length,
      criticalFailureCount: criticalFailures.length,
      pendingVerificationCount,
      requiresActionCount,
      verificationCoverage,
    },
    recommendations,
    questionResults,
    evidence: {
      mandatoryBlocks: Math.max(0, Number(templateBlueprint?.mandatoryEvidenceBlocks || 0)),
      ledger: evidenceLedger,
      totalEvidenceCount,
      verifiedEvidenceCount,
      verificationCoverage,
    },
    security: {
      vaultRecordId,
      tamperSealId,
      verificationRunId,
      signatureBundleId,
      evidenceMerkleRoot,
      chainHash,
      timestampAuthority: 'InCert Vault TSA Node EU-WEST-2',
      chainNode: `INCERT-VAULT-NODE-${String((seed % 9) + 1).padStart(2, '0')}`,
      trustMode: verificationCoverage === 100 ? 'Verified' : 'Partially verified',
    },
    links: {
      verificationUrl,
      vaultUrl,
      tamperUrl,
    },
    theme,
  };
}

function renderTemplateReportMotifSvg(theme) {
  if (theme.motif === 'chevrons') {
    return `
      <svg viewBox="0 0 1200 260" class="motif-svg" aria-hidden="true">
        <defs>
          <linearGradient id="${theme.motifId}-base" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="${theme.motifColorB}" />
            <stop offset="100%" stop-color="${theme.motifColorA}" />
          </linearGradient>
          <linearGradient id="${theme.motifId}-shine" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="rgba(255,255,255,0.34)" />
            <stop offset="100%" stop-color="rgba(255,255,255,0)" />
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="1200" height="260" fill="url(#${theme.motifId}-shine)" opacity="0.18" />
        <g opacity="0.94">
          <path d="M-180 260 L132 0 L356 0 L44 260 Z" fill="url(#${theme.motifId}-base)" />
          <path d="M114 260 L426 0 L648 0 L336 260 Z" fill="${theme.motifColorA}" />
          <path d="M408 260 L724 0 L938 0 L622 260 Z" fill="url(#${theme.motifId}-base)" />
          <path d="M704 260 L1022 0 L1218 0 L900 260 Z" fill="${theme.motifColorA}" />
          <path d="M954 260 L1214 42 L1214 260 Z" fill="url(#${theme.motifId}-base)" />
        </g>
        <path d="M0 106 L172 0 L252 0 L80 126 Z" fill="rgba(255,255,255,0.2)" />
        <path d="M264 92 L420 0 L500 0 L344 112 Z" fill="rgba(255,255,255,0.16)" />
        <path d="M0 222 L188 146 L352 222 L516 146 L680 222 L844 146 L1008 222 L1172 146" fill="none" stroke="rgba(255,255,255,0.34)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" />
        <path d="M0 196 L164 120 L328 196 L492 120 L656 196 L820 120 L984 196 L1148 120" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    `;
  }
  if (theme.motif === 'wave') {
    return `
      <svg viewBox="0 0 1200 260" class="motif-svg" aria-hidden="true">
        <defs>
          <linearGradient id="${theme.motifId}-wave-main" x1="0" x2="1">
            <stop offset="0%" stop-color="${theme.motifColorB}" />
            <stop offset="100%" stop-color="${theme.motifColorA}" />
          </linearGradient>
          <linearGradient id="${theme.motifId}-wave-secondary" x1="0" x2="1">
            <stop offset="0%" stop-color="${theme.motifColorA}" />
            <stop offset="100%" stop-color="${theme.motifColorB}" />
          </linearGradient>
          <radialGradient id="${theme.motifId}-halo" cx="76%" cy="20%" r="88%">
            <stop offset="0%" stop-color="rgba(255,255,255,0.36)" />
            <stop offset="100%" stop-color="rgba(255,255,255,0)" />
          </radialGradient>
        </defs>
        <rect x="0" y="0" width="1200" height="260" fill="url(#${theme.motifId}-halo)" />
        <path d="M0 174 C126 94 252 82 378 148 C504 214 630 224 756 164 C882 104 1008 96 1134 148 C1158 158 1180 166 1200 172 L1200 260 L0 260 Z" fill="url(#${theme.motifId}-wave-main)" />
        <path d="M0 198 C154 132 308 126 462 172 C616 218 770 222 924 188 C1018 166 1110 168 1200 188 L1200 260 L0 260 Z" fill="url(#${theme.motifId}-wave-secondary)" opacity="0.92" />
        <path d="M0 224 C176 182 352 176 528 206 C704 236 880 232 1056 206 C1110 198 1158 198 1200 202 L1200 260 L0 260 Z" fill="${theme.motifColorA}" opacity="0.72" />
        <path d="M0 106 C130 76 260 78 390 108 C520 138 650 140 780 112 C910 84 1040 80 1200 104" fill="none" stroke="rgba(255,255,255,0.44)" stroke-width="2.2" stroke-linecap="round" />
        <path d="M0 128 C146 100 292 102 438 126 C584 150 730 150 876 126 C1022 102 1096 96 1200 110" fill="none" stroke="rgba(255,255,255,0.28)" stroke-width="1.3" stroke-linecap="round" />
      </svg>
    `;
  }
  if (theme.motif === 'mesh') {
    return `
      <svg viewBox="0 0 1200 260" class="motif-svg" aria-hidden="true">
        <defs>
          <linearGradient id="${theme.motifId}-mesh-fill" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="${theme.motifColorB}" />
            <stop offset="100%" stop-color="${theme.motifColorA}" />
          </linearGradient>
        </defs>
        <path d="M0 172 L144 120 L286 156 L432 96 L588 150 L742 98 L894 150 L1048 102 L1200 146 L1200 260 L0 260 Z" fill="url(#${theme.motifId}-mesh-fill)" opacity="0.42" />
        <g fill="none" stroke="rgba(255,255,255,0.32)" stroke-width="1.6" stroke-linejoin="round">
          <path d="M0 172 L144 120 L286 156 L432 96 L588 150 L742 98 L894 150 L1048 102 L1200 146" />
          <path d="M0 206 L152 156 L300 188 L452 136 L608 188 L760 138 L912 190 L1060 142 L1200 178" />
          <path d="M0 136 L140 86 L282 122 L426 62 L582 116 L736 64 L888 116 L1042 68 L1200 112" />
          <path d="M64 260 L144 120 L226 260" />
          <path d="M212 260 L286 156 L368 260" />
          <path d="M354 260 L432 96 L516 260" />
          <path d="M512 260 L588 150 L670 260" />
          <path d="M666 260 L742 98 L824 260" />
          <path d="M818 260 L894 150 L976 260" />
          <path d="M970 260 L1048 102 L1128 260" />
        </g>
        <g fill="rgba(255,255,255,0.58)">
          <circle cx="144" cy="120" r="3.3" />
          <circle cx="286" cy="156" r="3.3" />
          <circle cx="432" cy="96" r="3.3" />
          <circle cx="588" cy="150" r="3.3" />
          <circle cx="742" cy="98" r="3.3" />
          <circle cx="894" cy="150" r="3.3" />
          <circle cx="1048" cy="102" r="3.3" />
        </g>
        <g fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1.1">
          <path d="M120 0 L286 156 L432 96 L588 150 L742 98 L894 150 L1058 0" />
          <path d="M258 0 L432 96 L588 150 L742 98 L898 0" />
        </g>
      </svg>
    `;
  }
  if (theme.motif === 'strata') {
    return `
      <svg viewBox="0 0 1200 260" class="motif-svg" aria-hidden="true">
        <defs>
          <linearGradient id="${theme.motifId}-strata-fill" x1="0" x2="1">
            <stop offset="0%" stop-color="${theme.motifColorA}" />
            <stop offset="100%" stop-color="${theme.motifColorB}" />
          </linearGradient>
        </defs>
        <path d="M0 164 C162 106 324 214 486 162 C648 110 810 214 972 166 C1062 138 1138 138 1200 152 L1200 260 L0 260 Z" fill="url(#${theme.motifId}-strata-fill)" opacity="0.5" />
        <g fill="none" stroke="rgba(255,255,255,0.34)" stroke-width="2" stroke-linecap="round">
          <path d="M0 132 C162 82 324 184 486 136 C648 88 810 186 972 138 C1068 108 1144 108 1200 120" />
          <path d="M0 152 C164 102 328 198 492 152 C656 106 820 198 984 152 C1074 126 1148 126 1200 136" />
          <path d="M0 172 C166 124 332 214 498 170 C664 126 830 216 996 172 C1080 150 1150 150 1200 160" />
          <path d="M0 192 C168 148 336 232 504 190 C672 148 840 232 1008 192 C1088 174 1154 174 1200 182" />
          <path d="M0 212 C170 172 340 250 510 210 C680 170 850 250 1020 212 C1094 198 1158 198 1200 204" />
          <path d="M0 232 C170 198 340 262 510 232 C680 202 850 262 1020 232 C1094 222 1158 222 1200 226" />
        </g>
        <g fill="none" stroke="rgba(255,255,255,0.24)" stroke-width="1.1" stroke-dasharray="4 5">
          <path d="M0 118 C160 72 320 168 480 122 C640 76 800 168 960 124 C1056 98 1138 98 1200 108" />
          <path d="M0 204 C168 158 336 240 504 204 C672 166 840 240 1008 206 C1088 190 1154 190 1200 196" />
        </g>
      </svg>
    `;
  }
  return `
    <svg viewBox="0 0 1200 260" class="motif-svg" aria-hidden="true">
      <defs>
        <linearGradient id="${theme.motifId}-ribbon-1" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="${theme.motifColorA}" />
          <stop offset="100%" stop-color="${theme.motifColorB}" />
        </linearGradient>
        <linearGradient id="${theme.motifId}-ribbon-2" x1="0" x2="1" y1="1" y2="0">
          <stop offset="0%" stop-color="${theme.motifColorB}" />
          <stop offset="100%" stop-color="${theme.motifColorA}" />
        </linearGradient>
        <linearGradient id="${theme.motifId}-sheen" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="rgba(255,255,255,0.3)" />
          <stop offset="100%" stop-color="rgba(255,255,255,0)" />
        </linearGradient>
      </defs>
      <rect x="0" y="0" width="1200" height="260" fill="url(#${theme.motifId}-sheen)" opacity="0.24" />
      <path d="M0 170 C174 112 348 112 522 166 C696 220 870 218 1044 166 C1102 148 1154 144 1200 148 L1200 260 L0 260 Z" fill="url(#${theme.motifId}-ribbon-1)" opacity="0.94" />
      <path d="M0 206 C162 170 324 172 486 206 C648 240 810 238 972 208 C1068 190 1144 188 1200 196 L1200 260 L0 260 Z" fill="url(#${theme.motifId}-ribbon-2)" opacity="0.84" />
      <path d="M514 -20 L780 -20 L1068 260 L802 260 Z" fill="rgba(255,255,255,0.14)" />
      <path d="M626 -20 L870 -20 L1152 260 L910 260 Z" fill="rgba(255,255,255,0.1)" />
      <g fill="none" stroke="rgba(255,255,255,0.32)" stroke-width="2" stroke-linejoin="round">
        <path d="M0 134 L180 82 L360 124 L542 74 L724 120 L906 72 L1088 116 L1200 92" />
        <path d="M0 156 L180 104 L360 146 L542 96 L724 142 L906 94 L1088 138 L1200 114" />
      </g>
      <g fill="none" stroke="rgba(255,255,255,0.24)" stroke-width="1.2">
        <path d="M760 18 L966 18 L1170 220 L964 220 Z" />
        <path d="M728 34 L934 34 L1138 236 L932 236 Z" />
      </g>
      <path d="M0 118 C164 90 328 92 492 120 C656 148 820 148 984 122 C1072 108 1144 106 1200 112" fill="none" stroke="rgba(255,255,255,0.22)" stroke-width="1.4" />
    </svg>
  `;
}

function buildTemplateCompletedReportHtml(reportModel, qrAssets = {}) {
  const verificationQrDataUrl = qrAssets.verificationQrDataUrl || '';
  const vaultQrDataUrl = qrAssets.vaultQrDataUrl || '';
  const tamperQrDataUrl = qrAssets.tamperQrDataUrl || '';
  const theme = reportModel.theme;
  const motifSvg = renderTemplateReportMotifSvg(theme);

  const recommendationRowsHtml = reportModel.recommendations
    .map(
      (recommendation) => `
        <article class="recommendation severity-${escapeHtml(recommendation.severity)}">
          <div class="recommendation-head">
            <span class="rec-id">${escapeHtml(recommendation.id)}</span>
            <span class="rec-severity">${escapeHtml(recommendation.severity)}</span>
          </div>
          <p class="rec-text">${escapeHtml(recommendation.recommendation)}</p>
          <p class="rec-meta">
            Owner: <strong>${escapeHtml(recommendation.owner)}</strong> Â· Due within <strong>${escapeHtml(
              recommendation.dueWithinDays
            )} days</strong> Â· Trigger <strong>${escapeHtml(recommendation.questionId)}</strong>
          </p>
        </article>
      `
    )
    .join('');

  const questionRowsHtml = reportModel.questionResults
    .map((result) => {
      const complianceClass = result.isCompliant ? 'ok' : 'issue';
      const verificationClass =
        result.evidenceVerificationStatus === 'verified'
          ? 'verified'
          : result.evidenceVerificationStatus === 'pending'
            ? 'pending'
            : 'na';

      return `
        <tr class="${complianceClass}">
          <td class="question-id">${escapeHtml(result.id)}</td>
          <td>
            <p class="question-text">${escapeHtml(result.text)}</p>
            <p class="question-meta">
              ${escapeHtml(result.category)} Â· Weight ${escapeHtml(result.weight)}${result.critical ? ' Â· Critical' : ''}
            </p>
          </td>
          <td>
            <span class="answer-chip ${complianceClass}">${escapeHtml(result.answerLabel)}</span>
          </td>
          <td class="score-cell">${escapeHtml(result.score.toFixed(2))} / ${escapeHtml(result.weight)}</td>
          <td>
            <p>${escapeHtml(result.evidenceSummary)}</p>
            ${
              result.evidenceRecords[0]
                ? `<p class="evidence-fingerprint">SHA256 ${escapeHtml(result.evidenceRecords[0].fingerprint.slice(0, 20))}...</p>`
                : '<p class="evidence-fingerprint">-</p>'
            }
          </td>
          <td>
            <span class="verification-chip ${verificationClass}">${escapeHtml(result.evidenceVerificationStatus.replaceAll('_', ' '))}</span>
          </td>
        </tr>
      `;
    })
    .join('');

  const evidenceLedgerRows = reportModel.evidence.ledger
    .map(
      (record) => `
        <tr>
          <td>${escapeHtml(record.recordId)}</td>
          <td>${escapeHtml(record.kind)}</td>
          <td>${escapeHtml(record.questionId)}</td>
          <td class="mono">${escapeHtml(record.fingerprint.slice(0, 24))}...</td>
          <td>${escapeHtml(formatDateLabel(record.capturedAt.slice(0, 10)))}</td>
          <td>${record.verified ? 'Verified' : 'Pending'}</td>
          <td>${escapeHtml(record.verifier)}</td>
        </tr>
      `
    )
    .join('');

  const qrCard = (label, value, dataUrl) => `
    <div class="qr-card">
      <p class="qr-label">${escapeHtml(label)}</p>
      ${
        dataUrl
          ? `<img src="${dataUrl}" alt="${escapeHtml(label)} QR code" class="qr-image" />`
          : '<div class="qr-placeholder">Generating QRâ¦</div>'
      }
      <p class="qr-value">${escapeHtml(value)}</p>
    </div>
  `;

  return `
    <!doctype html>
    <html lang="en">
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>${escapeHtml(reportModel.template.name)} - Completed Report</title>
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@600;700&display=swap');
          :root {
            --page-bg: ${theme.pageBackground};
            --hero-bg: ${theme.heroBackground};
            --accent: ${theme.accent};
            --accent-soft: ${theme.accentSoft};
            --accent-bright: ${theme.accentBright};
            --ink: ${theme.neutralInk};
            --muted: ${theme.muterInk};
            --danger: ${theme.danger};
            --success: ${theme.success};
            --white: #ffffff;
            --line: rgba(15, 23, 42, 0.1);
          }
          * { box-sizing: border-box; }
          html, body { margin: 0; padding: 0; background: var(--page-bg); color: var(--ink); }
          body { font-family: 'Manrope', 'Segoe UI', sans-serif; padding: 22px; }
          .report-shell {
            background: #fff;
            border-radius: 24px;
            overflow: hidden;
            border: 1px solid rgba(15, 23, 42, 0.12);
            box-shadow: 0 26px 42px -28px rgba(15, 23, 42, 0.36);
          }
          .hero {
            position: relative;
            background: var(--hero-bg);
            color: #f8fafc;
            padding: 26px 28px 22px;
            overflow: hidden;
          }
          .motif-svg { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0.98; }
          .hero-content { position: relative; z-index: 2; display: grid; grid-template-columns: 1fr auto; gap: 18px; align-items: start; }
          .kicker {
            font-size: 10px;
            letter-spacing: 0.22em;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(248, 250, 252, 0.82);
          }
          .hero-title { margin: 8px 0 0; font-family: 'Space Grotesk', 'Manrope', sans-serif; font-size: 30px; line-height: 1.15; letter-spacing: -0.02em; }
          .hero-subtitle { margin: 10px 0 0; font-size: 13px; color: rgba(241, 245, 249, 0.88); max-width: 78ch; }
          .score-pill {
            display: grid;
            place-items: center;
            width: 122px;
            min-height: 122px;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.26);
            background: rgba(15, 23, 42, 0.22);
            backdrop-filter: blur(4px);
            text-align: center;
            padding: 10px;
          }
          .score-pill .value { font-size: 32px; line-height: 1; font-weight: 800; letter-spacing: -0.03em; }
          .score-pill .label { margin-top: 5px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.16em; color: rgba(241,245,249,0.82); font-weight: 700; }
          .meta-grid {
            padding: 18px 20px 8px;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
          }
          .meta-card {
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 12px;
            background: linear-gradient(180deg, #fff 0%, #f8fafc 100%);
          }
          .meta-card h3 {
            margin: 0;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #64748b;
          }
          .meta-card p {
            margin: 8px 0 0;
            font-size: 13px;
            color: var(--ink);
            line-height: 1.45;
          }
          .meta-card .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
          .verification-band {
            margin: 12px 20px 0;
            border: 1px solid rgba(15,23,42,0.12);
            border-radius: 16px;
            background: linear-gradient(180deg, #ffffff 0%, var(--accent-soft) 100%);
            overflow: hidden;
          }
          .verification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 14px;
            border-bottom: 1px solid rgba(15,23,42,0.1);
          }
          .verification-title { font-size: 13px; font-weight: 800; letter-spacing: 0.03em; }
          .verification-status {
            font-size: 11px;
            border-radius: 999px;
            padding: 5px 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            background: rgba(255,255,255,0.72);
            border: 1px solid rgba(15,23,42,0.14);
          }
          .verification-grid {
            padding: 12px 14px;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
          }
          .verification-grid p { margin: 0; }
          .verification-grid .label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-weight: 700;
          }
          .verification-grid .value {
            margin-top: 5px;
            font-size: 12px;
            font-weight: 700;
            color: var(--ink);
            word-break: break-word;
          }
          .tamper-strip {
            margin: 12px 20px 0;
            border-radius: 12px;
            border: 1px dashed rgba(15,23,42,0.34);
            background:
              repeating-linear-gradient(135deg, rgba(15,23,42,0.04), rgba(15,23,42,0.04) 6px, rgba(15,23,42,0.09) 6px, rgba(15,23,42,0.09) 10px);
            padding: 9px 12px;
            font-size: 11px;
            color: #1e293b;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
          }
          .tamper-strip code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 11px; font-weight: 700; }
          .content-grid {
            padding: 16px 20px 0;
            display: grid;
            grid-template-columns: 1.08fr 0.92fr;
            gap: 12px;
          }
          .panel {
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 12px;
            background: #fff;
          }
          .panel h3 {
            margin: 0 0 10px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: #475569;
          }
          .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
          }
          .summary-item {
            border: 1px solid rgba(15,23,42,0.08);
            background: #f8fafc;
            border-radius: 10px;
            padding: 8px 9px;
          }
          .summary-item .label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.12em; font-weight: 700; }
          .summary-item .value { margin-top: 5px; font-size: 13px; font-weight: 800; color: var(--ink); }
          .recommendations {
            padding: 14px 20px 0;
            display: grid;
            gap: 8px;
          }
          .recommendation {
            border: 1px solid var(--line);
            border-left-width: 5px;
            border-radius: 12px;
            padding: 10px 12px;
            background: #fff;
          }
          .severity-critical { border-left-color: #b91c1c; }
          .severity-high { border-left-color: #dc2626; }
          .severity-medium { border-left-color: #d97706; }
          .severity-low { border-left-color: #0f766e; }
          .recommendation-head { display: flex; justify-content: space-between; gap: 8px; align-items: baseline; }
          .rec-id { font-size: 11px; font-weight: 800; letter-spacing: 0.1em; color: #334155; }
          .rec-severity { font-size: 10px; text-transform: uppercase; letter-spacing: 0.12em; color: #64748b; font-weight: 700; }
          .rec-text { margin: 6px 0 0; font-size: 12px; line-height: 1.45; color: #0f172a; }
          .rec-meta { margin: 7px 0 0; font-size: 11px; color: #475569; }
          .table-wrap {
            margin: 14px 20px 0;
            border: 1px solid var(--line);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
          }
          table { width: 100%; border-collapse: collapse; }
          thead th {
            background: #f1f5f9;
            color: #334155;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            text-align: left;
            padding: 10px 9px;
            border-bottom: 1px solid var(--line);
          }
          tbody td {
            font-size: 11px;
            color: #0f172a;
            padding: 9px;
            border-bottom: 1px solid rgba(15,23,42,0.08);
            vertical-align: top;
          }
          tbody tr.issue { background: rgba(248, 113, 113, 0.08); }
          tbody tr.ok { background: rgba(16, 185, 129, 0.05); }
          .question-id, .score-cell { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight: 700; white-space: nowrap; }
          .question-text { margin: 0; font-size: 11px; line-height: 1.35; color: #0f172a; }
          .question-meta { margin: 4px 0 0; font-size: 10px; color: #64748b; }
          .answer-chip, .verification-chip {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: 1px solid rgba(15,23,42,0.14);
            background: #fff;
          }
          .answer-chip.ok { color: #166534; background: rgba(134, 239, 172, 0.28); }
          .answer-chip.issue { color: #991b1b; background: rgba(252, 165, 165, 0.34); }
          .verification-chip.verified { color: #166534; background: rgba(134, 239, 172, 0.28); }
          .verification-chip.pending { color: #9a3412; background: rgba(253, 186, 116, 0.32); }
          .verification-chip.na { color: #334155; background: rgba(203, 213, 225, 0.4); }
          .evidence-fingerprint { margin: 4px 0 0; font-size: 10px; color: #64748b; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
          .ledger-wrap {
            margin: 14px 20px 0;
            border: 1px solid var(--line);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
          }
          .ledger-wrap td { font-size: 10.5px; }
          .ledger-wrap .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
          .qr-grid {
            padding: 14px 20px 20px;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
          }
          .qr-card {
            border: 1px solid var(--line);
            border-radius: 14px;
            background: #fff;
            padding: 10px;
          }
          .qr-label {
            margin: 0;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.13em;
            color: #64748b;
            font-weight: 800;
          }
          .qr-image, .qr-placeholder {
            margin-top: 8px;
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 10px;
            border: 1px solid rgba(15,23,42,0.12);
            object-fit: cover;
            background: #fff;
          }
          .qr-placeholder {
            display: grid;
            place-items: center;
            font-size: 11px;
            color: #64748b;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
          }
          .qr-value {
            margin: 7px 0 0;
            font-size: 10px;
            color: #334155;
            word-break: break-all;
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
          }
          .footer {
            border-top: 1px solid var(--line);
            background: #f8fafc;
            padding: 10px 20px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 10px;
            color: #475569;
          }
          .footer strong { color: #0f172a; }
        </style>
      </head>
      <body>
        <article class="report-shell">
          <header class="hero">
            ${motifSvg}
            <div class="hero-content">
              <div>
                <p class="kicker">InCert completed evidence report Â· ${escapeHtml(reportModel.template.categoryLabel)}</p>
                <h1 class="hero-title">${escapeHtml(reportModel.template.name)}</h1>
                <p class="hero-subtitle">
                  Report ${escapeHtml(reportModel.audit.reportId)} Â· Template ${escapeHtml(reportModel.template.id)} v${escapeHtml(
    reportModel.template.version
  )} Â· ${escapeHtml(reportModel.audit.executionMode)}
                </p>
              </div>
              <div class="score-pill">
                <span class="value">${escapeHtml(reportModel.summary.passPercent)}%</span>
                <span class="label">${escapeHtml(reportModel.summary.statusLabel)}</span>
              </div>
            </div>
          </header>

          <section class="meta-grid">
            <article class="meta-card">
              <h3>Site and business profile</h3>
              <p><strong>${escapeHtml(reportModel.site.siteName)}</strong></p>
              <p>${escapeHtml(reportModel.site.addressLine1)}<br />${escapeHtml(reportModel.site.addressLine2)} ${escapeHtml(
    reportModel.site.postcode
  )}</p>
              <p>${escapeHtml(reportModel.site.businessType)}<br />${escapeHtml(reportModel.site.buildingType)}</p>
            </article>
            <article class="meta-card">
              <h3>Primary contacts</h3>
              <p><strong>${escapeHtml(reportModel.site.primaryContact)}</strong></p>
              <p>${escapeHtml(reportModel.site.primaryPhone)}<br />${escapeHtml(reportModel.site.primaryEmail)}</p>
              <p>Emergency line: <strong>${escapeHtml(reportModel.site.emergencyPhone)}</strong></p>
            </article>
            <article class="meta-card">
              <h3>Audit delivery</h3>
              <p><strong>${escapeHtml(reportModel.audit.auditorName)}</strong></p>
              <p>${escapeHtml(reportModel.audit.auditorPhone)}<br />${escapeHtml(reportModel.audit.auditorEmail)}</p>
              <p class="mono">Ref ${escapeHtml(reportModel.audit.auditReference)}</p>
              <p>Completed ${escapeHtml(formatDateLabel(reportModel.audit.completedAt.slice(0, 10)))} Â· Next review ${escapeHtml(
    formatDateLabel(reportModel.audit.nextReviewAt.slice(0, 10))
  )}</p>
            </article>
          </section>

          <section class="verification-band">
            <div class="verification-header">
              <p class="verification-title">Evidence Vault Verification and Tamper-Evident Controls</p>
              <span class="verification-status">${escapeHtml(reportModel.security.trustMode)}</span>
            </div>
            <div class="verification-grid">
              <div>
                <p class="label">Vault Record</p>
                <p class="value">${escapeHtml(reportModel.security.vaultRecordId)}</p>
              </div>
              <div>
                <p class="label">Tamper Seal</p>
                <p class="value">${escapeHtml(reportModel.security.tamperSealId)}</p>
              </div>
              <div>
                <p class="label">Verification Run</p>
                <p class="value">${escapeHtml(reportModel.security.verificationRunId)}</p>
              </div>
              <div>
                <p class="label">Signature Bundle</p>
                <p class="value">${escapeHtml(reportModel.security.signatureBundleId)}</p>
              </div>
              <div>
                <p class="label">Chain Hash</p>
                <p class="value mono">${escapeHtml(reportModel.security.chainHash.slice(0, 22))}...</p>
              </div>
              <div>
                <p class="label">Merkle Root</p>
                <p class="value mono">${escapeHtml(reportModel.security.evidenceMerkleRoot.slice(0, 22))}...</p>
              </div>
              <div>
                <p class="label">Chain Node</p>
                <p class="value">${escapeHtml(reportModel.security.chainNode)}</p>
              </div>
              <div>
                <p class="label">Timestamp Authority</p>
                <p class="value">${escapeHtml(reportModel.security.timestampAuthority)}</p>
              </div>
            </div>
          </section>

          <div class="tamper-strip">
            <span>Tamper-evident mesh active</span>
            <span>Verification coverage: <strong>${escapeHtml(reportModel.summary.verificationCoverage)}%</strong></span>
            <span>Evidence blocks: <strong>${escapeHtml(reportModel.evidence.totalEvidenceCount)}</strong></span>
            <code>seal=${escapeHtml(reportModel.security.tamperSealId)}|vault=${escapeHtml(reportModel.security.vaultRecordId)}</code>
          </div>

          <section class="content-grid">
            <article class="panel">
              <h3>Outcome summary</h3>
              <div class="summary-grid">
                <div class="summary-item">
                  <p class="label">Scoring</p>
                  <p class="value">${escapeHtml(reportModel.summary.awardedScore.toFixed(2))} / ${escapeHtml(
    reportModel.summary.maxScore.toFixed(2)
  )}</p>
                </div>
                <div class="summary-item">
                  <p class="label">Pass threshold</p>
                  <p class="value">${escapeHtml(reportModel.summary.passScore.toFixed(2))}</p>
                </div>
                <div class="summary-item">
                  <p class="label">Questions</p>
                  <p class="value">${escapeHtml(reportModel.summary.questionCount)}</p>
                </div>
                <div class="summary-item">
                  <p class="label">Non-compliant</p>
                  <p class="value">${escapeHtml(reportModel.summary.nonCompliantCount)}</p>
                </div>
                <div class="summary-item">
                  <p class="label">Critical failures</p>
                  <p class="value">${escapeHtml(reportModel.summary.criticalFailureCount)}</p>
                </div>
                <div class="summary-item">
                  <p class="label">Pending verification</p>
                  <p class="value">${escapeHtml(reportModel.summary.pendingVerificationCount)}</p>
                </div>
              </div>
            </article>
            <article class="panel">
              <h3>Context</h3>
              <p><strong>Equipment or area focus:</strong> ${escapeHtml(reportModel.site.equipmentFocus)}</p>
              <p><strong>Scoring model:</strong> ${escapeHtml(reportModel.template.scoringModel.replaceAll('_', ' '))}</p>
              <p><strong>Mandatory evidence blocks:</strong> ${escapeHtml(reportModel.evidence.mandatoryBlocks)}</p>
              <p><strong>Actions required:</strong> ${escapeHtml(reportModel.summary.requiresActionCount)}</p>
              <p><strong>Next review due:</strong> ${escapeHtml(formatDateLabel(reportModel.audit.nextReviewAt.slice(0, 10)))}</p>
            </article>
          </section>

          <section class="recommendations">
            ${recommendationRowsHtml}
          </section>

          <section class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>QID</th>
                  <th>Question</th>
                  <th>Answer</th>
                  <th>Score</th>
                  <th>Evidence detail</th>
                  <th>Verification</th>
                </tr>
              </thead>
              <tbody>
                ${questionRowsHtml}
              </tbody>
            </table>
          </section>

          <section class="ledger-wrap">
            <table>
              <thead>
                <tr>
                  <th>Evidence ID</th>
                  <th>Type</th>
                  <th>Question</th>
                  <th>Fingerprint</th>
                  <th>Captured</th>
                  <th>Status</th>
                  <th>Verifier</th>
                </tr>
              </thead>
              <tbody>
                ${evidenceLedgerRows}
              </tbody>
            </table>
          </section>

          <section class="qr-grid">
            ${qrCard('Verification URL', reportModel.links.verificationUrl, verificationQrDataUrl)}
            ${qrCard('Evidence Vault Record', reportModel.links.vaultUrl, vaultQrDataUrl)}
            ${qrCard('Tamper Seal', reportModel.links.tamperUrl, tamperQrDataUrl)}
          </section>

          <footer class="footer">
            <span>Generated HTML evidence report for PDF export</span>
            <span><strong>InCert Trust Layer</strong> Â· ${escapeHtml(reportModel.security.verificationRunId)}</span>
          </footer>
        </article>
      </body>
    </html>
  `;
}

function getSeverityRiskScore(severity) {
  const lookup = {
    low: 4,
    medium: 9,
    high: 16,
    critical: 25,
  };
  return lookup[String(severity || '').toLowerCase()] || 9;
}

function getDefaultActionDueDate(severity, fromDate = new Date()) {
  const horizonDays = {
    low: 21,
    medium: 14,
    high: 7,
    critical: 2,
  };
  const severityKey = String(severity || '').toLowerCase();
  const offset = horizonDays[severityKey] || 14;
  const dueDate = new Date(fromDate.getTime());
  dueDate.setDate(dueDate.getDate() + offset);
  return dueDate.toISOString().slice(0, 10);
}

function getAuditorRateCard(auditor, regime) {
  if (!auditor?.rateCards) {
    return DEFAULT_RATE_CARD;
  }
  return auditor.rateCards[regime] || Object.values(auditor.rateCards)[0] || DEFAULT_RATE_CARD;
}

function isAuditorAvailableForJob(job, auditor, nowTimestamp = Date.now()) {
  const scope = getMarketplaceJobScope(job);
  const availability = auditor?.availability || { weekdays: [1, 2, 3, 4, 5], weekend: false };
  const dueDate = parseISODate(job?.dueDate || '');
  const dueWeekday = dueDate ? dueDate.getDay() : new Date(nowTimestamp).getDay();
  const weekdayMatch = Array.isArray(availability.weekdays)
    ? availability.weekdays.includes(dueWeekday)
    : true;
  const weekendMatch = scope.weekendAccess ? Boolean(availability.weekend) : true;
  const capacityRemaining = Math.max(0, (auditor?.maxConcurrentJobs || 8) - Number(auditor?.activeJobs || 0));
  const capacityMatch = capacityRemaining > 0;

  return {
    isAvailable: weekdayMatch && weekendMatch && capacityMatch,
    capacityRemaining,
    weekendMatch,
  };
}

function getNextMarketplaceJobId(jobs) {
  const highest = jobs.reduce((max, job) => {
    const value = Number(String(job.id || '').replace(/[^0-9]/g, ''));
    if (Number.isNaN(value)) {
      return max;
    }
    return Math.max(max, value);
  }, 1000);

  return `JOB-${String(highest + 1).padStart(4, '0')}`;
}

function getSiteRegion(siteName) {
  const normalized = String(siteName || '').toLowerCase();
  if (normalized.includes('london')) {
    return 'london';
  }
  if (normalized.includes('manchester')) {
    return 'manchester';
  }
  if (normalized.includes('birmingham')) {
    return 'birmingham';
  }
  return 'other';
}

function computeAuditorMatch(job, auditor, nowTimestamp = Date.now()) {
  const hasRegime = auditor.regimes.includes(job.regime);
  const scope = getMarketplaceJobScope(job);
  const auditorQuote = calculateMarketplaceQuote({
    scope,
    regime: job.regime,
    site: job.site,
    auditor,
  });
  const dispatch = getMarketplaceJobDispatch(job);
  const availability = isAuditorAvailableForJob(job, auditor, nowTimestamp);

  const siteRegion = getSiteRegion(job.site);
  const auditorRegion = getSiteRegion(auditor.baseLocation);
  const regionBonus = siteRegion === auditorRegion ? 14 : 4;
  const responseScore = Math.max(0, 14 - Math.floor((auditor.avgResponseMins || 80) / 10));
  const ratingScore = Math.round((auditor.rating || 4) * 6);
  const capacityScore = Math.min(18, availability.capacityRemaining * 4);
  const priceFitScore = Math.max(0, 14 - Math.floor(Math.abs((auditorQuote.auditorHourlyRate || 37) - 37) / 1.5));
  const weekendScore = scope.weekendAccess && !availability.weekendMatch ? -16 : 4;
  const availabilityScore = availability.isAvailable ? 16 : -40;
  const regimeScore = hasRegime ? 38 : -60;

  const total = Math.max(
    0,
    Math.min(
      100,
      regimeScore +
        regionBonus +
        responseScore +
        ratingScore +
        capacityScore +
        priceFitScore +
        weekendScore +
        availabilityScore
    )
  );

  const payoutEstimate = roundMoney(Math.max(0, auditorQuote.providerPayoutExVat));
  const etaHours = Math.max(2, Math.ceil((auditor.avgResponseMins || 80) / 30));

  return {
    score: total,
    hasRegime,
    isAvailable: availability.isAvailable,
    canAccept: hasRegime && availability.isAvailable,
    etaHours,
    payoutEstimate,
    capacityRemaining: availability.capacityRemaining,
    offerWindowMins: resolveOfferTtlMinutes(scope),
    dispatchSlaMins: dispatch.slaMinutes,
    auditorHourlyRate: auditorQuote.auditorHourlyRate,
    auditorBillableHours: auditorQuote.auditorBillableHours,
    explanation: hasRegime
      ? `${auditor.name} covers ${job.regime}, has ${availability.capacityRemaining} slot(s), and responds in ~${auditor.avgResponseMins} mins`
      : `${auditor.name} lacks ${job.regime} specialization`,
  };
}

function rankAuditorsForJob(job, auditors, nowTimestamp = Date.now()) {
  return auditors
    .map((auditor) => ({
      auditor,
      ...computeAuditorMatch(job, auditor, nowTimestamp),
    }))
    .filter((entry) => entry.hasRegime && entry.isAvailable)
    .sort((first, second) => second.score - first.score);
}

function getNextAssetId(assets) {
  const highest = assets.reduce((max, asset) => {
    const value = Number(String(asset.id || '').replace(/[^0-9]/g, ''));
    if (Number.isNaN(value)) {
      return max;
    }
    return Math.max(max, value);
  }, 0);

  return `AST-${String(highest + 1).padStart(3, '0')}`;
}

function loadStoredAssets() {
  try {
    const raw = window.localStorage.getItem(ASSET_STORAGE_KEY);
    if (!raw) {
      return initialAssets;
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) {
      return initialAssets;
    }

    return parsed;
  } catch {
    return initialAssets;
  }
}

function loadStoredMarketplaceJobs() {
  const hydrateJobs = (jobs) =>
    jobs.map((job) => {
      const pricing = getMarketplaceJobPricing(job);
      const pricingHistory = getMarketplaceJobPricingHistory(job, pricing);
      const companyName = String(job?.companyName || 'Acme Logistics').trim() || 'Acme Logistics';
      const companyId =
        String(job?.companyId || '').trim() || normalizeCompanyIdentifier(companyName) || 'acme-logistics';
      const existingTemplateId = String(job?.inspectionTemplateId || '').trim();
      const existingTemplateName = String(job?.inspectionTemplateName || '').trim();
      const templateNameFromAsset = (() => {
        const assetName = String(job?.assetName || '').trim();
        const match = assetName.match(/\(([^)]+)\)\s*$/);
        return match ? String(match[1] || '').trim() : '';
      })();
      const inferredTemplate = defaultInspectionTemplates.find((template) => {
        if (!template || typeof template !== 'object') {
          return false;
        }
        if (existingTemplateId && String(template.id || '').trim() === existingTemplateId) {
          return true;
        }
        const candidateName = String(template.name || '').trim().toLowerCase();
        const candidateRegime = String(template.regime || '').trim().toUpperCase();
        const targetName = String(existingTemplateName || templateNameFromAsset || '').trim().toLowerCase();
        const targetRegime = String(job?.regime || '').trim().toUpperCase();
        return Boolean(targetName && candidateRegime === targetRegime && candidateName === targetName);
      });
      const resolvedTemplateId = existingTemplateId || String(inferredTemplate?.id || '').trim();
      const resolvedTemplateName = existingTemplateName || String(inferredTemplate?.name || '').trim();
      const auditExecutionMode = normalizeAuditExecutionMode(job?.auditExecutionMode);
      const externalSoftwareWithholdPct = resolveExternalSoftwareWithholdPct({
        ...job,
        auditExecutionMode,
      });
      const externalAuditReviewStatus = resolveExternalAuditReviewStatus(job, auditExecutionMode);
      const normalizedStatus = ['open', 'offered', 'assigned', 'in_progress', 'awaiting_review', 'completed'].includes(
        job.status
      )
        ? job.status
        : 'open';
      const auditMethodLocked =
        Boolean(job?.auditMethodLocked) ||
        normalizedStatus === 'awaiting_review' ||
        normalizedStatus === 'completed';
      return {
        ...job,
        companyName,
        companyId,
        status: normalizedStatus,
        auditExecutionMode,
        externalAuditReviewStatus,
        externalSoftwareWithholdPct,
        auditMethodLocked,
        inspectionTemplateId: resolvedTemplateId,
        inspectionTemplateName: resolvedTemplateName,
        scope: getMarketplaceJobScope(job),
        pricing,
        pricingHistory,
        pricingAdjustments: getMarketplaceJobPricingAdjustments(job),
        pricingLock: getMarketplaceJobPricingLock(job, pricing),
        settlement: getMarketplaceJobSettlement(job, pricing),
        dispatch: getMarketplaceJobDispatch(job),
        timeline: Array.isArray(job.timeline) ? job.timeline : [],
        documents: Array.isArray(job.documents) ? job.documents : [],
      };
    });
  const mergeWithSeedJobs = (storedJobs) => {
    const normalizedStored = Array.isArray(storedJobs)
      ? storedJobs.filter((job) => job && typeof job === 'object')
      : [];
    const existingIds = new Set(
      normalizedStored
        .map((job) => String(job.id || '').trim())
        .filter(Boolean)
    );
    const missingSeedJobs = initialMarketplaceJobs.filter((job) => !existingIds.has(String(job.id || '').trim()));
    return [...normalizedStored, ...missingSeedJobs];
  };

  try {
    const raw = window.localStorage.getItem(MARKETPLACE_JOBS_STORAGE_KEY);
    if (!raw) {
      return hydrateJobs(initialMarketplaceJobs);
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) {
      return hydrateJobs(initialMarketplaceJobs);
    }

    return hydrateJobs(mergeWithSeedJobs(parsed));
  } catch {
    return hydrateJobs(initialMarketplaceJobs);
  }
}

function loadStoredInspectionLogs() {
  try {
    const raw = window.localStorage.getItem(INSPECTION_LOG_STORAGE_KEY);
    if (!raw) {
      return [];
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) {
      return [];
    }

    return parsed.filter((item) => item && typeof item === 'object');
  } catch {
    return [];
  }
}

function loadStoredRecurringProgrammes() {
  try {
    const raw = window.localStorage.getItem(RECURRING_PROGRAMMES_STORAGE_KEY);
    if (!raw) {
      return [];
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) {
      return [];
    }

    return parsed.filter((item) => item && typeof item === 'object');
  } catch {
    return [];
  }
}

function loadStoredPublicSiteConfig() {
  try {
    const raw = window.localStorage.getItem(PUBLIC_SITE_CONFIG_STORAGE_KEY);
    if (!raw) {
      return defaultPublicSiteConfig;
    }

    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== 'object') {
      return defaultPublicSiteConfig;
    }

    return {
      ...defaultPublicSiteConfig,
      ...parsed,
    };
  } catch {
    return defaultPublicSiteConfig;
  }
}

function loadStoredOnboardingTasks() {
  try {
    const raw = window.localStorage.getItem(ONBOARDING_TASKS_STORAGE_KEY);
    if (!raw) {
      return defaultOnboardingTasks;
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) {
      return defaultOnboardingTasks;
    }

    return parsed
      .filter((task) => task && typeof task === 'object')
      .map((task, index) => ({
        id: String(task.id || `task-${index + 1}`),
        label: String(task.label || `Task ${index + 1}`),
        completed: Boolean(task.completed),
      }));
  } catch {
    return defaultOnboardingTasks;
  }
}

function loadStoredFinanceInvoices() {
  try {
    const raw = window.localStorage.getItem(FINANCE_INVOICES_STORAGE_KEY);
    if (!raw) {
      return [];
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) {
      return [];
    }

    return parsed.filter((invoice) => invoice && typeof invoice === 'object');
  } catch {
    return [];
  }
}

function loadStoredPayoutRuns() {
  try {
    const raw = window.localStorage.getItem(PAYOUT_RUNS_STORAGE_KEY);
    if (!raw) {
      return [];
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) {
      return [];
    }

    return parsed.filter((run) => run && typeof run === 'object');
  } catch {
    return [];
  }
}

function loadStoredInspectionTemplates() {
  try {
    const raw = window.localStorage.getItem(INSPECTION_TEMPLATES_STORAGE_KEY);
    if (!raw) {
      return hydrateInspectionTemplates(defaultInspectionTemplates);
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) {
      return hydrateInspectionTemplates(defaultInspectionTemplates);
    }

    return hydrateInspectionTemplates(parsed);
  } catch {
    return hydrateInspectionTemplates(defaultInspectionTemplates);
  }
}

function loadStoredIntegrationConnections() {
  try {
    const raw = window.localStorage.getItem(INTEGRATION_CONNECTIONS_STORAGE_KEY);
    if (!raw) {
      return defaultIntegrationConnections;
    }

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) {
      return defaultIntegrationConnections;
    }

    return parsed
      .filter((integration) => integration && typeof integration === 'object')
      .map((integration, index) => ({
        id: String(integration.id || `INT-CUSTOM-${index + 1}`),
        name: String(integration.name || `Integration ${index + 1}`),
        category: String(integration.category || 'ERP'),
        status: integration.status === 'connected' ? 'connected' : 'not_connected',
        endpoint: String(integration.endpoint || ''),
        lastSyncAt: String(integration.lastSyncAt || ''),
      }));
  } catch {
    return defaultIntegrationConnections;
  }
}

function loadStoredApiClients() {
  return loadStoredCollection(API_CLIENTS_STORAGE_KEY, defaultApiClients);
}

function loadStoredWebhookEndpoints() {
  return loadStoredCollection(WEBHOOK_ENDPOINTS_STORAGE_KEY, defaultWebhookEndpoints);
}

function loadStoredEnterpriseSsoProviders() {
  return loadStoredCollection(ENTERPRISE_SSO_PROVIDERS_STORAGE_KEY, defaultEnterpriseSsoProviders);
}

function loadStoredEnterpriseAccessPolicies() {
  return loadStoredCollection(ENTERPRISE_ACCESS_POLICIES_STORAGE_KEY, defaultEnterpriseAccessPolicies);
}

function loadStoredCollection(storageKey, fallback) {
  try {
    const raw = window.localStorage.getItem(storageKey);
    if (!raw) {
      return fallback;
    }
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) {
      return fallback;
    }
    return parsed.filter((item) => item && typeof item === 'object');
  } catch {
    return fallback;
  }
}

function loadStoredTemplateBlueprints() {
  return loadStoredCollection(TEMPLATE_BLUEPRINTS_STORAGE_KEY, defaultTemplateBlueprints);
}

function loadStoredTemplateListings() {
  return loadStoredCollection(TEMPLATE_LISTINGS_STORAGE_KEY, defaultTemplateListings);
}

function loadStoredLicenceGrants() {
  return loadStoredCollection(LICENCE_GRANTS_STORAGE_KEY, defaultLicenceGrants);
}

function loadStoredAuditRuns() {
  return loadStoredCollection(AUDIT_RUNS_STORAGE_KEY, defaultAuditRuns);
}

function loadStoredAuditFindings() {
  return loadStoredCollection(AUDIT_FINDINGS_STORAGE_KEY, defaultAuditFindings);
}

function loadStoredAuditActions() {
  return loadStoredCollection(AUDIT_ACTIONS_STORAGE_KEY, defaultAuditActions);
}

function loadStoredReportArtifacts() {
  return loadStoredCollection(REPORT_ARTIFACTS_STORAGE_KEY, defaultReportArtifacts);
}

function loadStoredShareLinks() {
  return loadStoredCollection(SHARE_LINKS_STORAGE_KEY, defaultShareLinks);
}

function loadStoredMarketplaceBidBoard() {
  return loadStoredCollection(MARKETPLACE_BID_BOARD_STORAGE_KEY, defaultMarketplaceBidBoard);
}

function loadStoredDispatchSlaEvents() {
  return loadStoredCollection(DISPATCH_SLA_EVENTS_STORAGE_KEY, defaultDispatchSlaEvents);
}

function loadStoredEvidenceAiJobs() {
  return loadStoredCollection(EVIDENCE_AI_JOBS_STORAGE_KEY, defaultEvidenceAiJobs);
}

function loadStoredRegulatorVerificationRequests() {
  return loadStoredCollection(REGULATOR_VERIFICATION_REQUESTS_STORAGE_KEY, defaultRegulatorVerificationRequests);
}

function loadStoredAnalyticsRiskSignals() {
  return loadStoredCollection(ANALYTICS_RISK_SIGNALS_STORAGE_KEY, defaultAnalyticsRiskSignals);
}

function loadStoredWebhookDeliveryEvents() {
  return loadStoredCollection(WEBHOOK_DELIVERY_EVENTS_STORAGE_KEY, defaultWebhookDeliveryEvents);
}

function loadStoredMobileAuditSessions() {
  return loadStoredCollection(MOBILE_AUDIT_SESSIONS_STORAGE_KEY, defaultMobileAuditSessions);
}

function loadStoredEnterpriseSecurityEvents() {
  return loadStoredCollection(ENTERPRISE_SECURITY_EVENTS_STORAGE_KEY, defaultEnterpriseSecurityEvents);
}

function loadStoredQaHarnessRuns() {
  return loadStoredCollection(QA_HARNESS_RUNS_STORAGE_KEY, defaultQaHarnessRuns);
}

function loadStoredReleaseGateResults() {
  return loadStoredCollection(RELEASE_GATE_RESULTS_STORAGE_KEY, defaultReleaseGateResults);
}

function loadStoredTenantInvites() {
  return loadStoredCollection(TENANT_INVITES_STORAGE_KEY, defaultTenantInvites);
}

function loadStoredEvidenceProvenanceEvents() {
  return loadStoredCollection(EVIDENCE_PROVENANCE_EVENTS_STORAGE_KEY, defaultEvidenceProvenanceEvents);
}

function loadStoredAuthRuntimeMode() {
  try {
    const raw = window.localStorage.getItem(AUTH_RUNTIME_MODE_STORAGE_KEY);
    if (!raw) {
      return defaultAuthRuntimeMode;
    }
    const normalized = String(raw || '').toLowerCase();
    return normalized === 'supabase' || normalized === 'mock' ? normalized : defaultAuthRuntimeMode;
  } catch {
    return defaultAuthRuntimeMode;
  }
}

function loadStoredAuthSession() {
  try {
    const raw = window.localStorage.getItem(AUTH_SESSION_STORAGE_KEY);
    if (!raw) {
      return defaultAuthSession;
    }

    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== 'object') {
      return defaultAuthSession;
    }

    const email = String(parsed.email || '').trim();
    return {
      ...defaultAuthSession,
      ...parsed,
      email,
      isAuthenticated: Boolean(parsed.isAuthenticated && email),
    };
  } catch {
    return defaultAuthSession;
  }
}

function loadStoredDebugRole() {
  try {
    const raw = window.localStorage.getItem(DEBUG_ROLE_STORAGE_KEY);
    if (!raw) {
      return normalizeUserRole(defaultAuthSession.accountType);
    }
    return normalizeUserRole(raw, normalizeUserRole(defaultAuthSession.accountType));
  } catch {
    return normalizeUserRole(defaultAuthSession.accountType);
  }
}

function getLocalDateTimeInputValue(date = new Date()) {
  const target = new Date(date.getTime() - date.getTimezoneOffset() * 60_000);
  return target.toISOString().slice(0, 16);
}

function deepCloneStateValue(value, fallback = []) {
  try {
    if (typeof structuredClone === 'function') {
      return structuredClone(value);
    }
    return JSON.parse(JSON.stringify(value));
  } catch {
    return fallback;
  }
}

const DEBUG_MOCK_HISTORY_DAYS = 365;
const DEBUG_SNAPSHOT_SCHEMA_VERSION = `history-${DEBUG_MOCK_HISTORY_DAYS}-v5`;

function getDebugDateByDayOffset(dayOffset = 0, hour = 9, minute = 0) {
  const safeOffset = Math.max(0, Number(dayOffset || 0));
  const date = new Date();
  date.setHours(hour, minute, 0, 0);
  date.setDate(date.getDate() - safeOffset);
  return date;
}

function cycleDebugValue(values, index, fallback) {
  if (!Array.isArray(values) || values.length === 0) {
    return fallback;
  }
  return values[index % values.length];
}

function expandDebugCollection(source, targetCount, options = {}) {
  const seeds = deepCloneStateValue(source, []);
  if (!Array.isArray(seeds) || seeds.length === 0) {
    return [];
  }

  const {
    idPrefix,
    idPadding = 4,
    idMinValue = 1,
    mutate,
  } = options;

  const inferredPrefix = String(idPrefix || String(seeds[0]?.id || 'DBG').split('-')[0] || 'DBG').toUpperCase();
  const result = [...seeds];

  while (result.length < targetCount) {
    const seed = deepCloneStateValue(seeds[result.length % seeds.length], {});
    if (!seed || typeof seed !== 'object') {
      break;
    }

    const sequence = result.length + 1;
    seed.id = getNextEntityId(result, inferredPrefix, idMinValue, idPadding);

    if (typeof mutate === 'function') {
      mutate(seed, sequence, result, seeds);
    }

    result.push(seed);
  }

  return result;
}

function buildDebugInspectionLogs(assets, historyDays = DEBUG_MOCK_HISTORY_DAYS) {
  const totalLogs = Math.max(historyDays, historyDays + 24);
  return Array.from({ length: totalLogs }, (_, index) => {
    const asset = assets[index % assets.length] || {};
    const dayOffset = index % historyDays;
    const performed = getDebugDateByDayOffset(dayOffset, 7 + (index % 10), (index * 7) % 60);
    const created = new Date(performed.getTime() + 45 * 60 * 1000);
    const syncStatus = dayOffset <= 2 && index % 4 === 0 ? 'queued' : 'synced';

    return {
      id: `INSP-${String(500000 + index).padStart(6, '0')}`,
      assetId: String(asset.id || ''),
      assetName: String(asset.name || 'Asset'),
      performedAt: getLocalDateTimeInputValue(performed),
      notes: `Debug inspection log ${index + 1} captured for ${asset.name || 'asset'}.`,
      createdAt: created.toISOString(),
      syncStatus,
      syncedAt: syncStatus === 'synced' ? new Date(created.getTime() + 5 * 60 * 1000).toISOString() : null,
    };
  });
}

function buildDebugRecurringProgrammes(auditors, historyDays = DEBUG_MOCK_HISTORY_DAYS) {
  const cadences = ['monthly', 'quarterly', 'biannual', 'annual'];
  return Array.from({ length: 12 }, (_, index) => {
    const preferredAuditor = auditors[index % auditors.length];
    const createdAt = getDebugDateByDayOffset(index % historyDays, 9, (index * 9) % 60).toISOString();
    const startDate = getDebugDateByDayOffset((index * 4) % historyDays, 8, 0).toISOString().slice(0, 10);
    return {
      id: `PRG-${String(index + 1).padStart(4, '0')}`,
      name: `Debug Programme ${index + 1}`,
      cadence: cycleDebugValue(cadences, index, 'quarterly'),
      leadDays: 14 + index * 3,
      preferredAuditorId: String(preferredAuditor?.id || ''),
      budgetCap: roundMoney(420 + index * 55),
      startDate,
      approvalChain: index % 2 === 0 ? 'Site Manager > Finance' : 'Ops Lead > HSE > Finance',
      createdAt,
    };
  });
}

function buildDebugFinanceInvoices(jobs, auditors, historyDays = DEBUG_MOCK_HISTORY_DAYS) {
  const candidateJobs = jobs.filter((job) => ['completed', 'in_progress', 'awaiting_review'].includes(String(job.status || '')));
  const invoiceSource = candidateJobs.length > 0 ? candidateJobs : jobs;
  const totalInvoices = invoiceSource.length > 0 ? Math.max(historyDays, 60) : 0;
  const statuses = ['pending_approval', 'approved', 'issued', 'overdue', 'paid', 'payout_scheduled'];

  return Array.from({ length: totalInvoices }, (_, index) => {
    const job = invoiceSource[index % invoiceSource.length] || {};
    const dayOffset = index % historyDays;
    const issueDate = getDebugDateByDayOffset(dayOffset + 3, 10, (index * 5) % 60).toISOString().slice(0, 10);
    const dueDate = addDays(issueDate, 30);
    const linkedAuditor =
      auditors.find((auditor) => auditor.id === job.matchedAuditorId) ||
      cycleDebugValue(auditors, index, { id: '', name: 'Assigned provider', employmentModel: 'direct' });
    const providerName = String(linkedAuditor?.name || 'Assigned provider');
    const companyName = String(job.companyName || 'Acme Logistics');
    const companyId = String(job.companyId || normalizeCompanyIdentifier(companyName) || 'acme-logistics');
    const payToAuditorId = String(linkedAuditor?.id || job.matchedAuditorId || '');
    const payToOrganizationId = String(linkedAuditor?.dbOrganizationId || '');
    const payToAuditCompanyId = String(
      linkedAuditor?.thirdPartyOrganizationId ||
      (isThirdPartyProvider(linkedAuditor)
        ? linkedAuditor?.dbOrganizationId || linkedAuditor?.id || ''
        : '')
    );
    const totalIncVat = roundMoney(Number(job.budget || 340) + index * 12);
    const fallbackSubtotalExVat = roundMoney(totalIncVat / (1 + DEFAULT_VAT_RATE));
    const subtotalExVat = roundMoney(
      Number(job?.pricing?.subtotalExVat || fallbackSubtotalExVat)
    );
    const providerPayoutRatePct = Number((0.64 + (index % 8) * 0.02).toFixed(4));
    const providerPayoutExVat = roundMoney(
      Number(job?.pricing?.providerPayoutExVat || subtotalExVat * providerPayoutRatePct)
    );
    const platformGrossExVat = roundMoney(Math.max(0, subtotalExVat - providerPayoutExVat));
    const effectivePayoutRatePct = subtotalExVat > 0 ? Number((providerPayoutExVat / subtotalExVat).toFixed(4)) : 0;
    const effectiveGrossRatePct = subtotalExVat > 0 ? Number((platformGrossExVat / subtotalExVat).toFixed(4)) : 0;
    return {
      id: `INV-${String(1001 + index).padStart(5, '0')}`,
      jobId: String(job.id || `JOB-${1000 + index}`),
      quoteId: String(job?.pricing?.quoteId || `QTE-${String(2000 + index).padStart(4, '0')}`),
      assetName: String(job.assetName || 'Inspection scope'),
      providerName,
      billToName: companyName,
      payToName: providerName,
      companyId,
      companyOrgId: String(job.companyOrgId || ''),
      billToEntityType: 'company',
      billToEntityId: companyId,
      billToOrganizationId: String(job.companyOrgId || ''),
      payToEntityType: payToAuditCompanyId ? 'auditor_company' : 'auditor',
      payToEntityId: payToAuditCompanyId || payToAuditorId,
      payToAuditorId,
      payToAuditCompanyId,
      payToOrganizationId,
      issueDate,
      dueDate,
      poNumber: `PO-${String(3100 + index).padStart(4, '0')}`,
      costCentre: cycleDebugValue(['OPS', 'HSE', 'MNT', 'CAPEX'], index, 'OPS'),
      approver: cycleDebugValue(
        ['finance@acme-logistics.example', 'operations@acme-logistics.example', 'compliance@acme-logistics.example'],
        index,
        'finance@acme-logistics.example'
      ),
      subtotalExVat,
      providerPayoutExVat,
      platformGrossExVat,
      effectivePayoutRatePct,
      effectiveGrossRatePct,
      vatAmount: roundMoney(totalIncVat - subtotalExVat),
      totalIncVat,
      settlementReference: `SET-${String(7000 + index).padStart(4, '0')}`,
      status: cycleDebugValue(statuses, index, 'pending_approval'),
      approvedAt: index % 3 === 0 ? getDebugDateByDayOffset(Math.max(0, dayOffset - 1), 11, 0).toISOString() : '',
      payoutScheduledAt: index % 4 === 0 ? getDebugDateByDayOffset(Math.max(0, dayOffset - 6), 14, 0).toISOString() : '',
      paidAt: index % 6 === 0 ? getDebugDateByDayOffset(Math.max(0, dayOffset - 12), 16, 15).toISOString() : '',
      reminderCount: index % 3,
      lastReminderAt: index % 3 > 0 ? getDebugDateByDayOffset(Math.max(0, dayOffset - (8 + (index % 5))), 9, 45).toISOString() : '',
    };
  });
}

function buildDebugPayoutRuns(invoices, historyDays = DEBUG_MOCK_HISTORY_DAYS) {
  const payoutEligible = invoices.filter((invoice) =>
    ['approved', 'issued', 'overdue', 'paid', 'payout_scheduled'].includes(String(invoice.status || '').toLowerCase())
  );
  const payoutSource = payoutEligible.length > 0 ? payoutEligible : invoices;
  if (payoutSource.length === 0) {
    return [];
  }

  return payoutSource.map((invoice, index) => {
    const collectionDate = String(invoice.paidAt || '').slice(0, 10);
    const fallbackAnchorDate =
      String(invoice.dueDate || '').slice(0, 10) ||
      String(invoice.issueDate || '').slice(0, 10) ||
      new Date().toISOString().slice(0, 10);
    const scheduledPayoutDate = resolveCollectionBackedPayoutDate(
      collectionDate,
      `${String(invoice.id || invoice.jobId || 'PAY')}-${index}`,
      fallbackAnchorDate
    );
    const hasCollectionDate = Boolean(parseISODate(collectionDate));
    const status = hasCollectionDate && index % 5 !== 0 ? 'paid' : 'scheduled';
    const payoutBaseExVat = Number(
      invoice.providerPayoutExVat ||
      invoice.subtotalExVat ||
      roundMoney(Number(invoice.totalIncVat || 0) / (1 + DEFAULT_VAT_RATE))
    );
    const createdAtDate = addDays(scheduledPayoutDate, -1);
    const createdAt = buildIsoTimestampFromDate(createdAtDate, `${String(invoice.id || '')}-${index}-created`, 9, 6, 7);
    const paidAt = status === 'paid'
      ? buildIsoTimestampFromDate(scheduledPayoutDate, `${String(invoice.id || '')}-${index}-paid`, 10, 7, 13)
      : '';

    return {
      id: `PAY-${String(501 + index).padStart(5, '0')}`,
      invoiceId: String(invoice.id || ''),
      jobId: String(invoice.jobId || ''),
      providerName: String(invoice.providerName || 'Assigned provider'),
      payToEntityType: String(invoice.payToEntityType || (invoice.payToAuditCompanyId ? 'auditor_company' : 'auditor')),
      payToEntityId: String(
        invoice.payToEntityId ||
        invoice.payToAuditCompanyId ||
        invoice.payToAuditorId ||
        ''
      ),
      payToAuditorId: String(invoice.payToAuditorId || ''),
      payToAuditCompanyId: String(invoice.payToAuditCompanyId || ''),
      payToOrganizationId: String(invoice.payToOrganizationId || ''),
      companyId: String(invoice.companyId || ''),
      companyOrgId: String(invoice.companyOrgId || ''),
      payoutAmount: roundMoney(Math.max(0, payoutBaseExVat)),
      scheduledPayoutDate,
      scheduledFor: scheduledPayoutDate,
      status,
      createdAt: createdAt || new Date().toISOString(),
      paidAt,
    };
  });
}

function buildDebugMockSnapshot() {
  const providerLocations = ['London', 'Birmingham', 'Manchester', 'Leeds', 'Glasgow', 'Bristol', 'Cardiff', 'Sheffield'];
  const debugRegimeCycle = SUPPORTED_REGIMES.length > 0 ? SUPPORTED_REGIMES : ['LOLER', 'PUWER', 'PSSR'];
  const providerRegimes = [
    [debugRegimeCycle[0] || 'LOLER', debugRegimeCycle[1] || 'PUWER'],
    [debugRegimeCycle[2] || 'PSSR', debugRegimeCycle[1] || 'PUWER'],
    [debugRegimeCycle[0] || 'LOLER', debugRegimeCycle[2] || 'PSSR'],
    debugRegimeCycle.slice(0, Math.min(4, debugRegimeCycle.length)),
  ];
  const historyDays = DEBUG_MOCK_HISTORY_DAYS;
  const yearlyTimelineCount = Math.max(historyDays, 365);
  const today = new Date().toISOString().slice(0, 10);

  const auditors = expandDebugCollection(mockProviders, 12, {
    idPrefix: 'PRV',
    idPadding: 4,
    mutate: (auditor, index) => {
      auditor.name = `${String(auditor.name || 'Provider')} ${index}`;
      auditor.activeJobs = Math.max(1, Number(auditor.activeJobs || 0) + (index % 5));
      auditor.maxConcurrentJobs = Math.max(auditor.activeJobs + 2, Number(auditor.maxConcurrentJobs || 10));
      auditor.baseLocation = cycleDebugValue(providerLocations, index, 'UK');
      auditor.regimes = cycleDebugValue(providerRegimes, index, ['LOLER']);
      auditor.rating = Math.min(5, Number(auditor.rating || 4.4) + ((index % 3) * 0.1));
      auditor.avgResponseMins = Math.max(18, Number(auditor.avgResponseMins || 60) - (index % 4) * 6);
    },
  });
  const providerDirectory = deepCloneStateValue(auditors, []);

  const assets = expandDebugCollection(initialAssets, 36, {
    idPrefix: 'AST',
    idPadding: 3,
    mutate: (asset, index) => {
      asset.name = `${String(asset.name || 'Asset')} ${index}`;
      asset.site = cycleDebugValue(
        ['Birmingham Warehouse', 'Leeds Plant', 'Manchester Depot', 'London Hub', 'Bristol Distribution'],
        index,
        'Main Site'
      );
      asset.regime = cycleDebugValue(debugRegimeCycle, index, 'LOLER');
      asset.nextDue = addDays(today, (index % 60) - 12);
      asset.class = cycleDebugValue(['Lifting Equipment', 'Pressure System', 'Work Equipment'], index, asset.class);
    },
  });

  const marketplaceStatuses = ['open', 'offered', 'assigned', 'in_progress', 'awaiting_review', 'completed'];
  const marketplaceJobs = expandDebugCollection(initialMarketplaceJobs, yearlyTimelineCount, {
    idPrefix: 'JOB',
    idPadding: 4,
    mutate: (job, index) => {
      const linkedAsset = assets[index % assets.length];
      const linkedAuditor = auditors[index % auditors.length];
      const status = cycleDebugValue(marketplaceStatuses, index, 'open');
      job.companyName = cycleDebugValue(
        ['Acme Logistics', 'Meridian Facilities', 'Northpoint Estates', 'Harbour Industrial'],
        index,
        'Acme Logistics'
      );
      job.assetId = String(linkedAsset?.id || job.assetId || `AST-${String(index).padStart(3, '0')}`);
      job.assetName = String(linkedAsset?.name || job.assetName || 'Asset');
      job.site = String(linkedAsset?.site || job.site || 'Site');
      job.regime = String(linkedAsset?.regime || job.regime || 'LOLER');
      job.status = status;
      const dayOffset = index % historyDays;
      job.createdAt = getDebugDateByDayOffset(dayOffset, 8 + (index % 9), (index * 11) % 60).toISOString().slice(0, 10);
      job.dueDate = addDays(today, 4 + (index % 40));
      job.budget = roundMoney(Number(job.budget || 320) + index * 18);
      job.matchedAuditorId = status === 'open' ? null : String(linkedAuditor?.id || null);
      job.matchedAuditorName = status === 'open' ? '' : String(linkedAuditor?.name || '');
      job.notes = `PO: PO-${String(5000 + index).padStart(4, '0')} | Cost centre: ${cycleDebugValue(['OPS', 'HSE', 'CAPEX'], index, 'OPS')}`;
    },
  });

  const certificates = expandDebugCollection(initialCertificates, yearlyTimelineCount, {
    idPrefix: 'CERT',
    idPadding: 5,
    idMinValue: 2000,
    mutate: (certificate, index) => {
      const linkedAsset = assets[index % assets.length];
      const linkedAuditor = auditors[index % auditors.length];
      certificate.assetId = String(linkedAsset?.id || certificate.assetId || '');
      certificate.assetName = String(linkedAsset?.name || certificate.assetName || 'Asset');
      certificate.provider = String(linkedAuditor?.name || certificate.provider || 'Provider');
      certificate.regime = String(linkedAsset?.regime || certificate.regime || 'LOLER');
      const dayOffset = index % historyDays;
      certificate.issueDate = getDebugDateByDayOffset(dayOffset + 5, 10, (index * 13) % 60).toISOString().slice(0, 10);
      certificate.expiryDate = addDays(today, 90 - index * 3);
      certificate.status = cycleDebugValue(['valid', 'expiring', 'expired'], index, 'valid');
    },
  });

  const inspectionTemplates = hydrateInspectionTemplates(defaultInspectionTemplates);
  const inspectionLogs = buildDebugInspectionLogs(assets, historyDays);
  const recurringProgrammes = buildDebugRecurringProgrammes(auditors, historyDays);
  const financeInvoices = buildDebugFinanceInvoices(marketplaceJobs, auditors, historyDays);
  const payoutRuns = buildDebugPayoutRuns(financeInvoices, historyDays);

  const integrationConnections = expandDebugCollection(defaultIntegrationConnections, 12, {
    idPrefix: 'INT',
    mutate: (integration, index) => {
      integration.name = `${String(integration.name || 'Integration')} ${index}`;
      integration.status = index % 2 === 0 ? 'connected' : 'not_connected';
      integration.endpoint =
        integration.status === 'connected'
          ? `https://api.integration-${index}.example/incert/sync`
          : '';
      const dayOffset = index % historyDays;
      integration.lastSyncAt =
        integration.status === 'connected'
          ? getDebugDateByDayOffset(dayOffset, 7 + (index % 10), (index * 6) % 60).toISOString()
          : '';
    },
  });
  const apiClients = expandDebugCollection(defaultApiClients, 12, {
    idPrefix: 'API',
    mutate: (client, index) => {
      client.name = `${String(client.name || 'API Client')} ${index}`;
      client.status = index % 3 === 0 ? 'inactive' : 'active';
      client.secretFingerprint = `fp_${String(8200 + index).padStart(6, '0')}`;
      client.createdAt = getDebugDateByDayOffset((index + 5) % historyDays, 9, 15).toISOString();
      client.secretRotatedAt = getDebugDateByDayOffset(index % historyDays, 9, 30).toISOString();
    },
  });
  const webhookEndpoints = expandDebugCollection(defaultWebhookEndpoints, 12, {
    idPrefix: 'WEP',
    mutate: (endpoint, index) => {
      endpoint.name = `${String(endpoint.name || 'Webhook')} ${index}`;
      endpoint.status = index % 4 === 0 ? 'inactive' : 'active';
      endpoint.targetUrl = `https://hooks-${index}.example/incert/events`;
      endpoint.lastDeliveredAt = endpoint.status === 'active'
        ? getDebugDateByDayOffset(index % historyDays, 10 + (index % 8), (index * 5) % 60).toISOString()
        : '';
    },
  });
  const enterpriseSsoProviders = expandDebugCollection(defaultEnterpriseSsoProviders, 8, {
    idPrefix: 'SSO',
    mutate: (provider, index) => {
      provider.providerName = cycleDebugValue(['Microsoft Entra ID', 'Okta Workforce', 'Google Workspace'], index, 'SSO');
      provider.status = index % 4 === 0 ? 'disabled' : 'configured';
      provider.domain = `tenant-${index}.example`;
      provider.updatedAt = getDebugDateByDayOffset(index % historyDays, 6 + (index % 12), (index * 7) % 60).toISOString();
    },
  });
  const enterpriseAccessPolicies = expandDebugCollection(defaultEnterpriseAccessPolicies, 12, {
    idPrefix: 'POL',
    mutate: (policy, index) => {
      policy.name = `${String(policy.name || 'Access policy')} ${index}`;
      policy.status = index % 3 === 0 ? 'disabled' : 'enabled';
      policy.updatedAt = getDebugDateByDayOffset(index % historyDays, 8 + (index % 10), (index * 9) % 60).toISOString();
    },
  });
  const templateBlueprints = expandDebugCollection(defaultTemplateBlueprints, 24, {
    idPrefix: 'TPLX',
    mutate: (template, index) => {
      template.name = `${String(template.name || 'Template')} ${index}`;
      template.status = index % 5 === 0 ? 'draft' : 'published';
      template.currentVersion = `${1 + (index % 3)}.0`;
    },
  });
  const templateListings = expandDebugCollection(defaultTemplateListings, 16, {
    idPrefix: 'LST',
    mutate: (listing, index) => {
      listing.status = index % 4 === 0 ? 'paused' : 'active';
      listing.templateId = String(templateBlueprints[index % templateBlueprints.length]?.id || listing.templateId || '');
    },
  });
  const licenceGrants = expandDebugCollection(defaultLicenceGrants, 18, {
    idPrefix: 'LIC',
    mutate: (grant, index) => {
      grant.listingId = String(templateListings[index % templateListings.length]?.id || grant.listingId || '');
      grant.buyerOrgId = cycleDebugValue(['acme-logistics', 'northpoint-estates', 'meridian-fm'], index, 'acme-logistics');
      grant.seats = 10 + index * 2;
      grant.startAt = getDebugDateByDayOffset((index + 30) % historyDays, 9, 0).toISOString();
      grant.endAt = addDays(today, 180 + index * 12);
    },
  });
  const auditRuns = expandDebugCollection(defaultAuditRuns, yearlyTimelineCount, {
    idPrefix: 'RUN',
    mutate: (run, index) => {
      run.auditJobId = String(marketplaceJobs[index % marketplaceJobs.length]?.id || run.auditJobId || '');
      run.templateId = String(templateBlueprints[index % templateBlueprints.length]?.id || run.templateId || '');
      run.status = cycleDebugValue(['completed', 'in_progress', 'queued'], index, 'completed');
      const dayOffset = index % historyDays;
      run.startedAt = getDebugDateByDayOffset(dayOffset, 7 + (index % 10), (index * 8) % 60).toISOString();
      run.completedAt = run.status === 'completed'
        ? getDebugDateByDayOffset(dayOffset, 10 + (index % 8), (index * 8 + 35) % 60).toISOString()
        : '';
    },
  });
  const auditFindings = expandDebugCollection(defaultAuditFindings, yearlyTimelineCount, {
    idPrefix: 'FND',
    mutate: (finding, index) => {
      finding.auditRunId = String(auditRuns[index % auditRuns.length]?.id || finding.auditRunId || '');
      finding.severity = cycleDebugValue(['low', 'medium', 'high'], index, 'medium');
      finding.riskScore = 4 + (index % 16);
      finding.status = index % 4 === 0 ? 'closed' : 'open';
      finding.taxonomyCode = cycleDebugValue(['HS-EGRESS', 'ELEC-LOCKOUT', 'PSSR-SAFETYVALVE', 'PUWER-GUARDING'], index, 'GENERAL');
      finding.description = `Debug finding ${index}: ${finding.description || 'Inspection observation recorded.'}`;
    },
  });
  const auditActions = expandDebugCollection(defaultAuditActions, yearlyTimelineCount, {
    idPrefix: 'ACT',
    mutate: (action, index) => {
      action.findingId = String(auditFindings[index % auditFindings.length]?.id || action.findingId || '');
      action.assignee = cycleDebugValue(['Site Manager', 'HSE Lead', 'Maintenance Team', 'Audit Coordinator'], index, 'Site Manager');
      action.status = cycleDebugValue(['open', 'in_progress', 'closed'], index, 'open');
      action.dueDate = addDays(today, 5 + index);
      action.closureEvidenceCount = Math.max(0, index % 3);
    },
  });
  const reportArtifacts = expandDebugCollection(defaultReportArtifacts, yearlyTimelineCount, {
    idPrefix: 'RPT',
    mutate: (artifact, index) => {
      artifact.auditRunId = String(auditRuns[index % auditRuns.length]?.id || artifact.auditRunId || '');
      artifact.version = 1 + (index % 3);
      artifact.status = index % 5 === 0 ? 'superseded' : 'valid';
      artifact.createdAt = getDebugDateByDayOffset(index % historyDays, 11 + (index % 6), (index * 10) % 60).toISOString();
      artifact.pdfUri = `storage://incert-reports/${artifact.auditRunId}/v${artifact.version}/report.pdf`;
      artifact.htmlUri = `storage://incert-reports/${artifact.auditRunId}/v${artifact.version}/report.html`;
      artifact.signedPdfUrl = `https://signed.incert.example/reports/${artifact.auditRunId}/v${artifact.version}.pdf`;
      artifact.signedHtmlUrl = `https://signed.incert.example/reports/${artifact.auditRunId}/v${artifact.version}.html`;
    },
  });
  const shareLinks = expandDebugCollection(defaultShareLinks, yearlyTimelineCount, {
    idPrefix: 'SHR',
    mutate: (link, index) => {
      link.reportArtifactId = String(reportArtifacts[index % reportArtifacts.length]?.id || link.reportArtifactId || '');
      link.expiresAt = addDays(today, 7 + index);
      link.url = `https://portal.incert.example/share/${link.id}`;
      link.auditLogEnabled = index % 4 !== 0;
    },
  });
  const marketplaceBidBoard = expandDebugCollection(defaultMarketplaceBidBoard, yearlyTimelineCount, {
    idPrefix: 'BID',
    mutate: (bid, index) => {
      const linkedJob = marketplaceJobs[index % marketplaceJobs.length];
      const linkedAuditor = auditors[index % auditors.length];
      bid.requestId = String(linkedJob?.id || bid.requestId || '');
      bid.providerOrgName = String(linkedAuditor?.name || bid.providerOrgName || 'Provider');
      bid.status = cycleDebugValue(['submitted', 'awarded', 'submitted', 'declined'], index, 'submitted');
      bid.totalExVat = roundMoney(340 + index * 19);
      bid.vatAmount = roundMoney(bid.totalExVat * 0.2);
      bid.rankScore = 75 + (index % 20);
      bid.qualityScore = 72 + (index % 25);
      bid.leadTimeHours = 6 + (index % 18);
      bid.assignedAuditor = String(linkedAuditor?.name || 'Auditor');
      bid.assignmentStatus = cycleDebugValue(['assigned', 'accepted', 'pending'], index, 'pending');
      bid.submittedAt = getDebugDateByDayOffset(index % historyDays, 8 + (index % 9), (index * 14) % 60).toISOString();
    },
  });
  const dispatchSlaEvents = expandDebugCollection(defaultDispatchSlaEvents, yearlyTimelineCount, {
    idPrefix: 'SLA',
    mutate: (event, index) => {
      const linkedJob = marketplaceJobs[index % marketplaceJobs.length];
      event.requestId = String(linkedJob?.id || event.requestId || '');
      event.eventType = cycleDebugValue(['offer_sent', 'offer_accepted', 'offer_expired', 'reoffered'], index, 'offer_sent');
      event.minutesFromOpen = 8 + index * 4;
      event.isBreach = index % 7 === 0;
      event.eventAt = getDebugDateByDayOffset(index % historyDays, 9 + (index % 8), (index * 11) % 60).toISOString();
    },
  });
  const evidenceAiJobs = expandDebugCollection(defaultEvidenceAiJobs, yearlyTimelineCount, {
    idPrefix: 'EAI',
    mutate: (job, index) => {
      const linkedJob = marketplaceJobs[index % marketplaceJobs.length];
      job.evidenceRef = `evidence://${String(linkedJob?.id || 'JOB-0000')}/bundle-${String(index + 1).padStart(3, '0')}.pdf`;
      job.status = cycleDebugValue(['queued', 'running', 'completed', 'failed'], index, 'queued');
      job.reviewDecision = job.status === 'completed' ? cycleDebugValue(['accepted', 'pending', 'rejected'], index, 'pending') : 'pending';
      job.confidenceScore = job.status === 'completed' ? Number((0.72 + (index % 20) * 0.01).toFixed(2)) : 0;
      const dayOffset = index % historyDays;
      job.createdAt = getDebugDateByDayOffset(dayOffset, 7 + (index % 11), (index * 9) % 60).toISOString();
      job.completedAt =
        job.status === 'completed'
          ? getDebugDateByDayOffset(dayOffset, 10 + (index % 10), (index * 9 + 22) % 60).toISOString()
          : '';
    },
  });
  const regulatorVerificationRequests = expandDebugCollection(defaultRegulatorVerificationRequests, yearlyTimelineCount, {
    idPrefix: 'VRQ',
    mutate: (request, index) => {
      request.referenceId = String(certificates[index % certificates.length]?.id || request.referenceId || '');
      request.status = cycleDebugValue(['open', 'in_review', 'resolved'], index, 'open');
      request.requestor = cycleDebugValue(['Insurer Desk', 'HSE Liaison', 'Client Compliance Desk'], index, 'Insurer Desk');
      request.requestedAt = getDebugDateByDayOffset(index % historyDays, 9 + (index % 8), (index * 13) % 60).toISOString();
      request.dueAt = addDays(today, 2 + index);
    },
  });
  const analyticsRiskSignals = expandDebugCollection(defaultAnalyticsRiskSignals, yearlyTimelineCount, {
    idPrefix: 'RSK',
    mutate: (signal, index) => {
      signal.organization = cycleDebugValue(['Acme Logistics', 'Northpoint Estates', 'Meridian Facilities'], index, 'Acme Logistics');
      signal.signal = cycleDebugValue(
        ['repeat_high_severity_findings', 'dispatch_sla_near_breach', 'overdue_actions_cluster', 'evidence_gap_alert'],
        index,
        'dispatch_sla_near_breach'
      );
      signal.riskLevel = cycleDebugValue(['high', 'medium', 'low'], index, 'medium');
      signal.confidence = Number((0.62 + (index % 28) * 0.01).toFixed(2));
      signal.triggeredAt = getDebugDateByDayOffset(index % historyDays, 8 + (index % 11), (index * 5) % 60).toISOString();
    },
  });
  const webhookDeliveryEvents = expandDebugCollection(defaultWebhookDeliveryEvents, yearlyTimelineCount, {
    idPrefix: 'WEB',
    mutate: (event, index) => {
      const linkedEndpoint = webhookEndpoints[index % webhookEndpoints.length];
      event.endpointLabel = String(linkedEndpoint?.name || event.endpointLabel || 'Webhook');
      event.status = cycleDebugValue(['delivered', 'failed', 'retrying'], index, 'delivered');
      event.attempts = 1 + (index % 4);
      event.lastAttemptAt = getDebugDateByDayOffset(index % historyDays, 10 + (index % 8), (index * 12) % 60).toISOString();
      event.latencyMs = event.status === 'failed' ? 0 : 120 + (index % 8) * 35;
    },
  });
  const mobileAuditSessions = expandDebugCollection(defaultMobileAuditSessions, yearlyTimelineCount, {
    idPrefix: 'MAS',
    mutate: (session, index) => {
      const linkedJob = marketplaceJobs[index % marketplaceJobs.length];
      session.jobId = String(linkedJob?.id || session.jobId || '');
      session.deviceName = cycleDebugValue(
        ['iPhone 15 - BVUK-01', 'Pixel 9 - NSP-03', 'iPad Air - ACME-07', 'Galaxy Tab - ALL-02'],
        index,
        'Mobile Device'
      );
      session.syncStatus = cycleDebugValue(['synced', 'queued', 'syncing'], index, 'synced');
      session.attestationStatus = cycleDebugValue(['verified', 'pending', 'verified'], index, 'verified');
      const dayOffset = index % historyDays;
      session.startedAt = getDebugDateByDayOffset(dayOffset, 7 + (index % 12), (index * 6) % 60).toISOString();
      session.closedAt =
        index % 3 === 0
          ? getDebugDateByDayOffset(dayOffset, 11 + (index % 8), (index * 6 + 18) % 60).toISOString()
          : '';
    },
  });
  const enterpriseSecurityEvents = expandDebugCollection(defaultEnterpriseSecurityEvents, yearlyTimelineCount, {
    idPrefix: 'SEC',
    mutate: (event, index) => {
      event.eventType = cycleDebugValue(
        ['sso_policy_updated', 'suspicious_login_blocked', 'webhook_signature_invalid', 'mfa_challenge_enforced'],
        index,
        'sso_policy_updated'
      );
      event.severity = cycleDebugValue(['low', 'medium', 'high'], index, 'medium');
      event.actor = cycleDebugValue(
        ['system.guard', 'incert.admin@incert.local', 'security.bot', 'audit.ops@incert.local'],
        index,
        'system.guard'
      );
      event.occurredAt = getDebugDateByDayOffset(index % historyDays, 6 + (index % 13), (index * 10) % 60).toISOString();
    },
  });
  const qaHarnessRuns = expandDebugCollection(defaultQaHarnessRuns, yearlyTimelineCount, {
    idPrefix: 'QAR',
    mutate: (run, index) => {
      run.suiteName = cycleDebugValue(
        ['Marketplace Core', 'Ops Console', 'Evidence Pipeline', 'Mobile Session Sync'],
        index,
        'Marketplace Core'
      );
      run.status = cycleDebugValue(['passed', 'running', 'failed', 'queued'], index, 'passed');
      run.branch = cycleDebugValue(['main', 'release/ops', 'feature/evidence'], index, 'main');
      run.passRate = run.status === 'failed' ? 68 + (index % 8) : 84 + (index % 16);
      const dayOffset = index % historyDays;
      run.startedAt = getDebugDateByDayOffset(dayOffset, 5 + (index % 12), (index * 7) % 60).toISOString();
      run.completedAt = run.status === 'running' || run.status === 'queued'
        ? ''
        : getDebugDateByDayOffset(dayOffset, 8 + (index % 10), (index * 7 + 25) % 60).toISOString();
    },
  });
  const releaseGateResults = expandDebugCollection(defaultReleaseGateResults, yearlyTimelineCount, {
    idPrefix: 'RLG',
    mutate: (gate, index) => {
      gate.gateName = cycleDebugValue(
        ['Security checks', 'Data migrations', 'Performance budget', 'Rollback readiness'],
        index,
        'Security checks'
      );
      gate.status = cycleDebugValue(['passed', 'pending', 'failed'], index, 'pending');
      gate.evaluatedAt = getDebugDateByDayOffset(index % historyDays, 9 + (index % 8), (index * 9) % 60).toISOString();
      gate.notes = gate.status === 'passed' ? 'Checks completed.' : gate.status === 'failed' ? 'Action required before release.' : 'Awaiting run completion.';
    },
  });
  const tenantInvites = expandDebugCollection(defaultTenantInvites, yearlyTimelineCount, {
    idPrefix: 'INV',
    idPadding: 4,
    mutate: (invite, index) => {
      invite.email = `ops.team+${index}@acme-logistics.example`;
      invite.role = cycleDebugValue(['dutyholder_admin', 'site_manager', 'provider_admin', 'insurer_viewer'], index, 'site_manager');
      invite.status = cycleDebugValue(['pending', 'accepted', 'pending'], index, 'pending');
      invite.sentAt = getDebugDateByDayOffset(index % historyDays, 9 + (index % 7), (index * 8) % 60).toISOString();
      invite.acceptedAt =
        invite.status === 'accepted'
          ? getDebugDateByDayOffset(index % historyDays, 13 + (index % 5), (index * 8 + 20) % 60).toISOString()
          : '';
    },
  });
  const evidenceProvenanceEvents = expandDebugCollection(defaultEvidenceProvenanceEvents, yearlyTimelineCount, {
    idPrefix: 'PRV',
    mutate: (event, index) => {
      const linkedJob = marketplaceJobs[index % marketplaceJobs.length];
      event.evidenceRef = `evidence://${String(linkedJob?.id || 'JOB-0000')}/evidence-${String(index + 1).padStart(3, '0')}.jpg`;
      event.eventType = cycleDebugValue(['file_uploaded', 'ai_extracted', 'manual_reviewed', 'hash_verified'], index, 'file_uploaded');
      event.hash = `sha256:dbg${String(100000 + index)}`;
      event.deviceMetadata = cycleDebugValue(['ios:camera:v15', 'android:camera:v14', 'server:ai-pipeline', 'web:portal-upload'], index, 'web:portal-upload');
      event.createdAt = getDebugDateByDayOffset(index % historyDays, 8 + (index % 10), (index * 7) % 60).toISOString();
    },
  });

  return {
    assets,
    certificates,
    auditors,
    providerDirectory,
    marketplaceJobs,
    inspectionLogs,
    recurringProgrammes,
    publicSiteConfig: deepCloneStateValue(defaultPublicSiteConfig, defaultPublicSiteConfig),
    onboardingTasks: deepCloneStateValue(defaultOnboardingTasks, []),
    financeInvoices,
    payoutRuns,
    inspectionTemplates,
    integrationConnections,
    apiClients,
    webhookEndpoints,
    enterpriseSsoProviders,
    enterpriseAccessPolicies,
    templateBlueprints,
    templateListings,
    licenceGrants,
    auditRuns,
    auditFindings,
    auditActions,
    reportArtifacts,
    shareLinks,
    marketplaceBidBoard,
    dispatchSlaEvents,
    evidenceAiJobs,
    regulatorVerificationRequests,
    analyticsRiskSignals,
    webhookDeliveryEvents,
    mobileAuditSessions,
    enterpriseSecurityEvents,
    qaHarnessRuns,
    releaseGateResults,
    tenantInvites,
    evidenceProvenanceEvents,
  };
}

export default function App() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [isLoaded, setIsLoaded] = useState(false);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [isOnline, setIsOnline] = useState(() => (typeof navigator === 'undefined' ? true : navigator.onLine));

  // Data State
  const [assets, setAssets] = useState(() => {
    if (typeof window === 'undefined') {
      return initialAssets;
    }
    return loadStoredAssets();
  });
  const [certificates, setCertificates] = useState(initialCertificates);
  const [auditors, setAuditors] = useState(mockProviders);
  const [providerDirectory, setProviderDirectory] = useState(mockProviders);
  const [marketplaceJobs, setMarketplaceJobs] = useState(() => {
    if (typeof window === 'undefined') {
      return initialMarketplaceJobs;
    }
    return loadStoredMarketplaceJobs();
  });
  const [inspectionLogs, setInspectionLogs] = useState(() => {
    if (typeof window === 'undefined') {
      return [];
    }
    return loadStoredInspectionLogs();
  });
  const [recurringProgrammes, setRecurringProgrammes] = useState(() => {
    if (typeof window === 'undefined') {
      return [];
    }
    return loadStoredRecurringProgrammes();
  });
  const [publicSiteConfig, setPublicSiteConfig] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultPublicSiteConfig;
    }
    return loadStoredPublicSiteConfig();
  });
  const [onboardingTasks, setOnboardingTasks] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultOnboardingTasks;
    }
    return loadStoredOnboardingTasks();
  });
  const [financeInvoices, setFinanceInvoices] = useState(() => {
    if (typeof window === 'undefined') {
      return [];
    }
    return loadStoredFinanceInvoices();
  });
  const [payoutRuns, setPayoutRuns] = useState(() => {
    if (typeof window === 'undefined') {
      return [];
    }
    return loadStoredPayoutRuns();
  });
  const [inspectionTemplates, setInspectionTemplates] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultInspectionTemplates;
    }
    return loadStoredInspectionTemplates();
  });
  const [integrationConnections, setIntegrationConnections] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultIntegrationConnections;
    }
    return loadStoredIntegrationConnections();
  });
  const [apiClients, setApiClients] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultApiClients;
    }
    return loadStoredApiClients();
  });
  const [webhookEndpoints, setWebhookEndpoints] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultWebhookEndpoints;
    }
    return loadStoredWebhookEndpoints();
  });
  const [enterpriseSsoProviders, setEnterpriseSsoProviders] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultEnterpriseSsoProviders;
    }
    return loadStoredEnterpriseSsoProviders();
  });
  const [enterpriseAccessPolicies, setEnterpriseAccessPolicies] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultEnterpriseAccessPolicies;
    }
    return loadStoredEnterpriseAccessPolicies();
  });
  const [templateBlueprints, setTemplateBlueprints] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultTemplateBlueprints;
    }
    return loadStoredTemplateBlueprints();
  });
  const [templateListings, setTemplateListings] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultTemplateListings;
    }
    return loadStoredTemplateListings();
  });
  const [licenceGrants, setLicenceGrants] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultLicenceGrants;
    }
    return loadStoredLicenceGrants();
  });
  const [auditRuns, setAuditRuns] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultAuditRuns;
    }
    return loadStoredAuditRuns();
  });
  const [auditFindings, setAuditFindings] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultAuditFindings;
    }
    return loadStoredAuditFindings();
  });
  const [auditActions, setAuditActions] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultAuditActions;
    }
    return loadStoredAuditActions();
  });
  const [reportArtifacts, setReportArtifacts] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultReportArtifacts;
    }
    return loadStoredReportArtifacts();
  });
  const [shareLinks, setShareLinks] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultShareLinks;
    }
    return loadStoredShareLinks();
  });
  const [marketplaceBidBoard, setMarketplaceBidBoard] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultMarketplaceBidBoard;
    }
    return loadStoredMarketplaceBidBoard();
  });
  const [dispatchSlaEvents, setDispatchSlaEvents] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultDispatchSlaEvents;
    }
    return loadStoredDispatchSlaEvents();
  });
  const [evidenceAiJobs, setEvidenceAiJobs] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultEvidenceAiJobs;
    }
    return loadStoredEvidenceAiJobs();
  });
  const [regulatorVerificationRequests, setRegulatorVerificationRequests] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultRegulatorVerificationRequests;
    }
    return loadStoredRegulatorVerificationRequests();
  });
  const [analyticsRiskSignals, setAnalyticsRiskSignals] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultAnalyticsRiskSignals;
    }
    return loadStoredAnalyticsRiskSignals();
  });
  const [webhookDeliveryEvents, setWebhookDeliveryEvents] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultWebhookDeliveryEvents;
    }
    return loadStoredWebhookDeliveryEvents();
  });
  const [mobileAuditSessions, setMobileAuditSessions] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultMobileAuditSessions;
    }
    return loadStoredMobileAuditSessions();
  });
  const [enterpriseSecurityEvents, setEnterpriseSecurityEvents] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultEnterpriseSecurityEvents;
    }
    return loadStoredEnterpriseSecurityEvents();
  });
  const [qaHarnessRuns, setQaHarnessRuns] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultQaHarnessRuns;
    }
    return loadStoredQaHarnessRuns();
  });
  const [releaseGateResults, setReleaseGateResults] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultReleaseGateResults;
    }
    return loadStoredReleaseGateResults();
  });
  const [tenantInvites, setTenantInvites] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultTenantInvites;
    }
    return loadStoredTenantInvites();
  });
  const [evidenceProvenanceEvents, setEvidenceProvenanceEvents] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultEvidenceProvenanceEvents;
    }
    return loadStoredEvidenceProvenanceEvents();
  });
  const [authRuntimeMode, setAuthRuntimeMode] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultAuthRuntimeMode;
    }
    return loadStoredAuthRuntimeMode();
  });
  const [supabaseSession, setSupabaseSession] = useState(null);
  const [primaryOrganizationScope, setPrimaryOrganizationScope] = useState({
    organizationId: '',
    organizationName: '',
  });
  const [searchQuery, setSearchQuery] = useState('');
  const isSupabaseRuntime = authRuntimeMode === 'supabase' && SUPABASE_ENV_CONFIGURED;

  // UI State
  const [toasts, setToasts] = useState([]);
  const [showNotifications, setShowNotifications] = useState(false);

  // Modal/Drawer State
  const [showAddAssetModal, setShowAddAssetModal] = useState(false);
  const [showRequestModal, setShowRequestModal] = useState(false);
  const [showProgrammeModal, setShowProgrammeModal] = useState(false);
  const [selectedProviderForRequest, setSelectedProviderForRequest] = useState('');
  const [selectedAssetForDetails, setSelectedAssetForDetails] = useState(null);
  const [showCommandPalette, setShowCommandPalette] = useState(false);
  const [showMobileQuickPanel, setShowMobileQuickPanel] = useState(false);
  const [showScanModal, setShowScanModal] = useState(false);
  const [assetForQrLabel, setAssetForQrLabel] = useState(null);
  const [vaultFocusCertificateId, setVaultFocusCertificateId] = useState('');
  const [authSession, setAuthSession] = useState(() => {
    if (typeof window === 'undefined') {
      return defaultAuthSession;
    }
    return loadStoredAuthSession();
  });
  const [debugRole, setDebugRole] = useState(() => {
    if (typeof window === 'undefined') {
      return normalizeUserRole(defaultAuthSession.accountType);
    }
    return loadStoredDebugRole();
  });
  const [debugAccountancyScopeOverrides, setDebugAccountancyScopeOverrides] = useState({
    companyId: '',
    auditorId: '',
    auditCompanyId: '',
  });
  const isDebugBypassSession = String(authSession?.email || '').trim().toLowerCase() === 'debug@incert.local';
  const shouldTrackSupabaseSession = Boolean(SUPABASE_ENV_CONFIGURED && supabase && !isDebugBypassSession);
  const handledHashRef = useRef('');
  const debugSnapshotValidatedRef = useRef(false);
  const resetWorkspaceToMockData = useCallback(() => {
    const debugSnapshot = buildDebugMockSnapshot();
    setAssets(debugSnapshot.assets);
    setCertificates(debugSnapshot.certificates);
    setAuditors(debugSnapshot.auditors);
    setProviderDirectory(debugSnapshot.providerDirectory);
    setMarketplaceJobs(debugSnapshot.marketplaceJobs);
    setInspectionLogs(debugSnapshot.inspectionLogs);
    setRecurringProgrammes(debugSnapshot.recurringProgrammes);
    setPublicSiteConfig(debugSnapshot.publicSiteConfig);
    setOnboardingTasks(debugSnapshot.onboardingTasks);
    setFinanceInvoices(debugSnapshot.financeInvoices);
    setPayoutRuns(debugSnapshot.payoutRuns);
    setInspectionTemplates(debugSnapshot.inspectionTemplates);
    setIntegrationConnections(debugSnapshot.integrationConnections);
    setApiClients(debugSnapshot.apiClients);
    setWebhookEndpoints(debugSnapshot.webhookEndpoints);
    setEnterpriseSsoProviders(debugSnapshot.enterpriseSsoProviders);
    setEnterpriseAccessPolicies(debugSnapshot.enterpriseAccessPolicies);
    setTemplateBlueprints(debugSnapshot.templateBlueprints);
    setTemplateListings(debugSnapshot.templateListings);
    setLicenceGrants(debugSnapshot.licenceGrants);
    setAuditRuns(debugSnapshot.auditRuns);
    setAuditFindings(debugSnapshot.auditFindings);
    setAuditActions(debugSnapshot.auditActions);
    setReportArtifacts(debugSnapshot.reportArtifacts);
    setShareLinks(debugSnapshot.shareLinks);
    setMarketplaceBidBoard(debugSnapshot.marketplaceBidBoard);
    setDispatchSlaEvents(debugSnapshot.dispatchSlaEvents);
    setEvidenceAiJobs(debugSnapshot.evidenceAiJobs);
    setRegulatorVerificationRequests(debugSnapshot.regulatorVerificationRequests);
    setAnalyticsRiskSignals(debugSnapshot.analyticsRiskSignals);
    setWebhookDeliveryEvents(debugSnapshot.webhookDeliveryEvents);
    setMobileAuditSessions(debugSnapshot.mobileAuditSessions);
    setEnterpriseSecurityEvents(debugSnapshot.enterpriseSecurityEvents);
    setQaHarnessRuns(debugSnapshot.qaHarnessRuns);
    setReleaseGateResults(debugSnapshot.releaseGateResults);
    setTenantInvites(debugSnapshot.tenantInvites);
    setEvidenceProvenanceEvents(debugSnapshot.evidenceProvenanceEvents);
    setPrimaryOrganizationScope({
      organizationId: '',
      organizationName: '',
    });
    if (typeof window !== 'undefined') {
      try {
        window.localStorage.setItem(DEBUG_SNAPSHOT_VERSION_STORAGE_KEY, DEBUG_SNAPSHOT_SCHEMA_VERSION);
      } catch {
        // no-op when storage is unavailable
      }
    }
  }, []);
  const clearSupabaseOpsAndProviderState = useCallback(() => {
    setAssets([]);
    setCertificates([]);
    setMarketplaceJobs([]);
    setInspectionLogs([]);
    setRecurringProgrammes([]);
    setProviderDirectory([]);
    setAuditors([]);
    setTemplateBlueprints([]);
    setTenantInvites([]);
    setMarketplaceBidBoard([]);
    setDispatchSlaEvents([]);
    setEvidenceAiJobs([]);
    setEvidenceProvenanceEvents([]);
    setRegulatorVerificationRequests([]);
    setAuditFindings([]);
    setAuditActions([]);
    setFinanceInvoices([]);
    setPayoutRuns([]);
    setAnalyticsRiskSignals([]);
    setIntegrationConnections([]);
    setApiClients([]);
    setWebhookEndpoints([]);
    setWebhookDeliveryEvents([]);
    setMobileAuditSessions([]);
    setEnterpriseSsoProviders([]);
    setEnterpriseAccessPolicies([]);
    setEnterpriseSecurityEvents([]);
    setQaHarnessRuns([]);
    setReleaseGateResults([]);
    setPrimaryOrganizationScope({
      organizationId: '',
      organizationName: '',
    });
  }, []);

  useEffect(() => {
    if (typeof window === 'undefined') {
      return;
    }

    if (!isDebugBypassSession) {
      debugSnapshotValidatedRef.current = false;
      return;
    }

    if (debugSnapshotValidatedRef.current) {
      return;
    }

    let storedSnapshotVersion = '';
    try {
      storedSnapshotVersion = String(window.localStorage.getItem(DEBUG_SNAPSHOT_VERSION_STORAGE_KEY) || '').trim();
    } catch {
      storedSnapshotVersion = '';
    }

    const minimumTimelineRecords = Math.max(90, Math.floor(DEBUG_MOCK_HISTORY_DAYS * 0.9));
    const hasYearScaleDataset =
      marketplaceJobs.length >= minimumTimelineRecords &&
      inspectionLogs.length >= minimumTimelineRecords &&
      marketplaceBidBoard.length >= minimumTimelineRecords;
    const shouldRefreshSnapshot =
      storedSnapshotVersion !== DEBUG_SNAPSHOT_SCHEMA_VERSION || !hasYearScaleDataset;

    debugSnapshotValidatedRef.current = true;
    if (!shouldRefreshSnapshot) {
      return;
    }

    resetWorkspaceToMockData();
    addToast('Debug data refreshed with a 12-month timeline.', 'info');
  }, [
    inspectionLogs.length,
    isDebugBypassSession,
    marketplaceBidBoard.length,
    marketplaceJobs.length,
    resetWorkspaceToMockData,
  ]);

  useEffect(() => {
    setInspectionTemplates((currentTemplates) => {
      const hydratedTemplates = hydrateInspectionTemplates(currentTemplates);
      if (JSON.stringify(hydratedTemplates) === JSON.stringify(currentTemplates)) {
        return currentTemplates;
      }
      return hydratedTemplates;
    });
  }, []);

  useEffect(() => {
    if (!shouldTrackSupabaseSession) {
      setSupabaseSession(null);
      return undefined;
    }

    let isActive = true;

    supabase.auth
      .getSession()
      .then(({ data, error }) => {
        if (!isActive) {
          return;
        }
        if (error) {
          console.error('Failed to load Supabase session', error);
          setSupabaseSession(null);
          return;
        }
        setSupabaseSession(data.session ?? null);
      })
      .catch((error) => {
        if (!isActive) {
          return;
        }
        console.error('Supabase session lookup crashed', error);
        setSupabaseSession(null);
      });

    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSupabaseSession(session ?? null);
    });

    return () => {
      isActive = false;
      subscription.unsubscribe();
    };
  }, [shouldTrackSupabaseSession]);

  useEffect(() => {
    if (!SUPABASE_ENV_CONFIGURED || !supabase) {
      return;
    }

    const normalizedEmail = String(authSession?.email || '').trim().toLowerCase();
    if (!authSession?.isAuthenticated || !normalizedEmail || normalizedEmail === 'debug@incert.local') {
      return;
    }

    if (authRuntimeMode !== 'supabase') {
      setAuthRuntimeMode('supabase');
    }
  }, [authRuntimeMode, authSession?.email, authSession?.isAuthenticated]);

  useEffect(() => {
    if (!shouldTrackSupabaseSession) {
      return;
    }
    if (supabaseSession?.user?.id && authRuntimeMode !== 'supabase') {
      setAuthRuntimeMode('supabase');
    }
  }, [authRuntimeMode, shouldTrackSupabaseSession, supabaseSession?.user?.id]);

  useEffect(() => {
    if (!isSupabaseRuntime) {
      return;
    }

    const user = supabaseSession?.user;
    if (!user?.id || !user?.email) {
      setAuthSession(defaultAuthSession);
      return;
    }

    const accountTypeFromMetadata = normalizeUserRole(
      user.user_metadata?.account_type || user.app_metadata?.account_type || 'company'
    );

    setAuthSession({
      isAuthenticated: true,
      email: String(user.email || '').toLowerCase(),
      fullName: String(user.user_metadata?.full_name || user.user_metadata?.name || '').trim(),
      accountType: accountTypeFromMetadata,
      signedInAt: new Date().toISOString(),
    });
  }, [isSupabaseRuntime, supabaseSession]);

  useEffect(() => {
    if (!isSupabaseRuntime || supabaseSession?.user?.id) {
      return;
    }

    // In Supabase runtime without an authenticated Supabase session (e.g. debug bypass),
    // do not surface seeded/mock operations or provider datasets.
    clearSupabaseOpsAndProviderState();
  }, [isSupabaseRuntime, supabaseSession?.user?.id, clearSupabaseOpsAndProviderState]);

  useEffect(() => {
    if (!isSupabaseRuntime || !supabase || !supabaseSession?.user?.id) {
      return;
    }

    let isCancelled = false;
    clearSupabaseOpsAndProviderState();

    const loadSupabaseData = async () => {
      const userId = supabaseSession.user.id;

      const [
        membershipsResult,
        organizationsResult,
        sitesResult,
        assetsResult,
        requestsResult,
        requestAssetsResult,
        jobsResult,
        certificatesResult,
      ] = await Promise.all([
        supabase
          .from('organization_memberships')
          .select('organization_id, role, is_default, created_at')
          .eq('user_id', userId)
          .order('is_default', { ascending: false })
          .order('created_at', { ascending: true }),
        supabase.from('organizations').select('id, name, org_type, metadata'),
        supabase.from('sites').select('id, name'),
        supabase
          .from('assets')
          .select('id, organization_id, site_id, external_asset_id, name, asset_class, regime, next_due_date, status')
          .order('next_due_date', { ascending: true }),
        supabase
          .from('inspection_requests')
          .select('id, organization_id, site_id, title, regime, status, preferred_end_date, created_at')
          .order('created_at', { ascending: false })
          .limit(300),
        supabase.from('inspection_request_assets').select('request_id, asset_id'),
        supabase
          .from('inspection_jobs')
          .select('id, request_id, provider_organization_id, status, notes, created_at')
          .order('created_at', { ascending: false })
          .limit(300),
        supabase
          .from('certificates')
          .select('id, certificate_number, asset_id, provider_organization_id, regime, issue_date, expiry_date, status, sha256_hash')
          .order('issued_at', { ascending: false })
          .limit(300),
      ]);

      if (isCancelled) {
        return;
      }

      const memberships = Array.isArray(membershipsResult.data) ? membershipsResult.data : [];
      const organizations = Array.isArray(organizationsResult.data) ? organizationsResult.data : [];
      const sites = Array.isArray(sitesResult.data) ? sitesResult.data : [];
      const assetRows = Array.isArray(assetsResult.data) ? assetsResult.data : [];
      const requestRows = Array.isArray(requestsResult.data) ? requestsResult.data : [];
      const requestAssetRows = Array.isArray(requestAssetsResult.data) ? requestAssetsResult.data : [];
      const jobRows = Array.isArray(jobsResult.data) ? jobsResult.data : [];
      const certificateRows = Array.isArray(certificatesResult.data) ? certificatesResult.data : [];

      const primaryMembership =
        memberships.find((membership) => membership?.is_default) || memberships[0] || null;
      if (primaryMembership?.role) {
        setDebugRole(mapSupabaseRoleToUserRole(primaryMembership.role));
      }

      const organizationNameById = new Map(
        organizations.map((organization) => [String(organization.id), String(organization.name || 'Organization')])
      );
      const primaryOrganizationId = String(primaryMembership?.organization_id || '').trim();
      setPrimaryOrganizationScope({
        organizationId: primaryOrganizationId,
        organizationName: organizationNameById.get(primaryOrganizationId) || '',
      });
      const siteNameById = new Map(sites.map((site) => [String(site.id), String(site.name || 'Site')]));

      const mappedAssets = assetRows.map((asset) => {
        const fallbackAssetCode = `AST-${String(asset.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`;
        const displayId = String(asset.external_asset_id || fallbackAssetCode || asset.id || '').trim();
        return {
          id: displayId || fallbackAssetCode,
          dbId: String(asset.id || ''),
          name: String(asset.name || 'Unnamed asset'),
          site: siteNameById.get(String(asset.site_id || '')) || 'Unassigned site',
          class: String(asset.asset_class || 'Asset'),
          regime: String(asset.regime || '').toUpperCase() || 'LOLER',
          nextDue: String(asset.next_due_date || new Date().toISOString().slice(0, 10)),
        };
      });

      const assetByDbId = new Map(mappedAssets.map((asset) => [String(asset.dbId || ''), asset]));
      setAssets(mappedAssets);

      const requestAssetByRequestId = new Map();
      requestAssetRows.forEach((entry) => {
        const requestId = String(entry.request_id || '');
        if (!requestId || requestAssetByRequestId.has(requestId)) {
          return;
        }
        const linkedAsset = assetByDbId.get(String(entry.asset_id || ''));
        if (linkedAsset) {
          requestAssetByRequestId.set(requestId, linkedAsset);
        }
      });

      const jobByRequestId = new Map();
      jobRows.forEach((job) => {
        const requestId = String(job.request_id || '');
        if (!requestId || jobByRequestId.has(requestId)) {
          return;
        }
        jobByRequestId.set(requestId, job);
      });

      const mappedMarketplaceJobs = requestRows.map((request) => {
        const requestId = String(request.id || '');
        const linkedJob = jobByRequestId.get(requestId) || null;
        const linkedAsset = requestAssetByRequestId.get(requestId) || null;
        const providerOrganizationId = String(linkedJob?.provider_organization_id || '').trim();
        const jobCreatedAt = String(linkedJob?.created_at || request.created_at || '');
        const uiStatus = linkedJob
          ? mapJobStatusToMarketplaceStatus(linkedJob.status)
          : mapRequestStatusToMarketplaceStatus(request.status);
        const fallbackAssetName = String(request.title || 'Inspection scope');
        const fallbackAssetId = linkedAsset?.id || `REQ-${requestId.slice(0, 8).toUpperCase()}`;
        const dueDate = String(request.preferred_end_date || '').slice(0, 10);
        const createdAt = jobCreatedAt.slice(0, 10);

        const companyOrgId = String(request.organization_id || '').trim();
        const companyName =
          organizationNameById.get(companyOrgId) ||
          organizationNameById.get(String(primaryMembership?.organization_id || '')) ||
          'Operator';
        return {
          id: linkedJob?.id
            ? `JOB-${String(linkedJob.id).replace(/-/g, '').slice(0, 8).toUpperCase()}`
            : `REQ-${requestId.replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          dbRequestId: requestId,
          dbJobId: linkedJob?.id ? String(linkedJob.id) : '',
          companyName,
          companyId: normalizeCompanyIdentifier(companyName) || `org-${companyOrgId.slice(0, 8)}`,
          companyOrgId,
          assetId: linkedAsset?.id || fallbackAssetId,
          assetName: linkedAsset?.name || fallbackAssetName,
          site: siteNameById.get(String(request.site_id || '')) || linkedAsset?.site || 'Unassigned site',
          regime: String(request.regime || linkedAsset?.regime || 'LOLER').toUpperCase(),
          status: uiStatus,
          dueDate: dueDate || '',
          budget: 0,
          createdAt: createdAt || '',
          matchedAuditorId: providerOrganizationId || null,
          matchedAuditorName: organizationNameById.get(providerOrganizationId) || '',
          notes: String(linkedJob?.notes || request.title || '').trim(),
          scope: {
            template: 'supabase_request',
            assetCount: 1,
            estimatedHours: 1,
            complexity: 'standard',
            equipment: 'none',
            travelKm: 0,
            weekendAccess: false,
            expedite: false,
          },
          documents: [],
          timeline: [
            {
              label: linkedJob ? 'Job record loaded from Supabase' : 'Request record loaded from Supabase',
              at: createdAt || '',
              actor: 'Supabase',
            },
          ],
        };
      });

      setMarketplaceJobs(mappedMarketplaceJobs);

      const mappedCertificates = certificateRows.map((certificate) => {
        const asset = assetByDbId.get(String(certificate.asset_id || '')) || null;
        const providerId = String(certificate.provider_organization_id || '').trim();
        const certificateNumber =
          String(certificate.certificate_number || '').trim() ||
          `CERT-${String(certificate.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`;
        return {
          id: certificateNumber,
          dbId: String(certificate.id || ''),
          assetId: asset?.id || String(certificate.asset_id || '').slice(0, 8).toUpperCase(),
          assetName: asset?.name || 'Asset',
          regime: String(certificate.regime || asset?.regime || 'LOLER').toUpperCase(),
          provider: organizationNameById.get(providerId) || 'Provider',
          issueDate: String(certificate.issue_date || '').slice(0, 10),
          expiryDate: String(certificate.expiry_date || '').slice(0, 10),
          status: String(certificate.status || 'valid'),
          hash: String(certificate.sha256_hash || '').slice(0, 16),
        };
      });

      setCertificates(mappedCertificates);

      const requestById = new Map(requestRows.map((request) => [String(request.id || ''), request]));
      const providerStatsByOrgId = new Map();
      jobRows.forEach((job) => {
        const providerOrgId = String(job.provider_organization_id || '').trim();
        if (!providerOrgId) {
          return;
        }
        const request = requestById.get(String(job.request_id || '')) || null;
        const regime = String(request?.regime || '').toUpperCase();
        const existing = providerStatsByOrgId.get(providerOrgId) || {
          activeJobs: 0,
          regimes: new Set(),
        };
        if (['pending', 'accepted', 'in_progress', 'submitted'].includes(String(job.status || '').toLowerCase())) {
          existing.activeJobs += 1;
        }
        if (regime) {
          existing.regimes.add(regime);
        }
        providerStatsByOrgId.set(providerOrgId, existing);
      });

      const providerOrganizations = organizations.filter((organization) => {
        const normalizedOrgType = String(organization.org_type || '').toLowerCase();
        return ['provider', 'auditor', 'insurer', 'fm'].includes(normalizedOrgType);
      });
      const providerOrgIds = new Set([
        ...providerOrganizations.map((organization) => String(organization.id || '')),
        ...Array.from(providerStatsByOrgId.keys()),
      ]);

      const mappedProviders = Array.from(providerOrgIds)
        .filter(Boolean)
        .map((organizationId) => {
          const organization = organizations.find((item) => String(item.id) === organizationId) || null;
          const metadata = organization?.metadata && typeof organization.metadata === 'object' ? organization.metadata : {};
          const stats = providerStatsByOrgId.get(organizationId) || { activeJobs: 0, regimes: new Set() };
          const regimes = Array.from(stats.regimes || []).filter(Boolean);
          return {
            id: `PRV-${organizationId.replace(/-/g, '').slice(0, 8).toUpperCase()}`,
            dbOrganizationId: organizationId,
            name: String(organization?.name || `Provider ${organizationId.slice(0, 8)}`),
            tier: mapOrgTypeToProviderTier(organization?.org_type),
            employmentModel: String(organization?.org_type || '').toLowerCase() === 'auditor' ? 'third_party' : 'direct',
            regimes: regimes.length > 0 ? regimes : FALLBACK_PROVIDER_REGIMES,
            activeJobs: Math.max(0, Number(stats.activeJobs || 0)),
            maxConcurrentJobs: Math.max(1, Number(metadata.maxConcurrentJobs || metadata.max_concurrent_jobs || 8)),
            rating: Number(metadata.rating || 4.6),
            avgResponseMins: Math.max(15, Number(metadata.avgResponseMins || metadata.avg_response_mins || 60)),
            baseLocation: String(metadata.baseLocation || metadata.base_location || 'UK'),
            availability: {
              weekdays: [1, 2, 3, 4, 5],
              weekend: Boolean(metadata.weekend || metadata.weekend_support || false),
            },
            rateCards: metadata.rateCards && typeof metadata.rateCards === 'object' ? metadata.rateCards : undefined,
          };
        })
        .sort((a, b) => a.name.localeCompare(b.name));

      setAuditors(mappedProviders);
      setProviderDirectory(mappedProviders);

      const selectRows = async (tableName, columns, applyQuery) => {
        try {
          let query = supabase.from(tableName).select(columns);
          if (typeof applyQuery === 'function') {
            query = applyQuery(query);
          }
          const { data, error } = await query;
          if (error) {
            console.warn(`Supabase read failed for ${tableName}`, error.message);
            return [];
          }
          return Array.isArray(data) ? data : [];
        } catch (error) {
          console.warn(`Supabase read crashed for ${tableName}`, error);
          return [];
        }
      };

      const scopedOrganizationIds = Array.from(
        new Set(
          memberships
            .map((membership) => String(membership.organization_id || '').trim())
            .filter(Boolean)
        )
      );

      const orderNewest = (field) => (query) => query.order(field, { ascending: false }).limit(200);
      const scopeByOrg = (field = 'organization_id') => (query) =>
        scopedOrganizationIds.length > 0 ? query.in(field, scopedOrganizationIds) : query;

      const [
        templateDefinitionRows,
        templateVersionRows,
        bidRows,
        dispatchEventRows,
        aiJobRows,
        provenanceRows,
        verificationRows,
        capaRows,
        findingRows,
        invoiceRows,
        payoutRows,
        riskSignalRows,
        integrationSyncRows,
        apiClientRows,
        webhookEndpointRows,
        webhookDeliveryRows,
        mobileDeviceRows,
        mobileSessionRows,
        ssoProviderRows,
        enterprisePolicyRows,
        securityEventRows,
        qaSuiteRows,
        qaRunRows,
        releaseGateRows,
        releaseGateResultRows,
      ] = await Promise.all([
        selectRows('InCert-inspection_template_definitions', 'id, organization_id, regime, name, current_version_id, created_at, updated_at', (query) =>
          orderNewest('updated_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-inspection_template_versions', 'id, template_id, version_number, status, scoring_model, published_at, updated_at', orderNewest('updated_at')),
        selectRows('InCert-marketplace_bids', 'id, request_id, organization_id, status, total_ex_vat, vat_amount, lead_time_hours, quality_score, rank_score, submitted_at, metadata', orderNewest('created_at')),
        selectRows('InCert-dispatch_sla_events', 'id, request_id, event_type, event_at, minutes_from_open, is_breach', orderNewest('event_at')),
        selectRows('InCert-evidence_ai_jobs', 'id, evidence_file_id, status, model_name, created_at, completed_at, metadata', orderNewest('created_at')),
        selectRows('InCert-evidence_provenance_events', 'id, evidence_file_id, event_type, file_hash_sha256, metadata, created_at', orderNewest('created_at')),
        selectRows('InCert-regulator_verification_requests', 'id, requester_email, requester_organization_id, certificate_id, status, opened_at, decision_notes, metadata', orderNewest('opened_at')),
        selectRows('InCert-capa_actions', 'id, finding_id, title, status, due_date, owner_user_id, created_at', (query) =>
          orderNewest('created_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('inspection_findings', 'id, summary, severity, finding_code, created_at', orderNewest('created_at')),
        selectRows(
          'InCert-finance_invoices',
          'id, organization_id, job_id, invoice_number, status, subtotal_ex_vat, vat_amount, total_inc_vat, paid_at, due_at, issued_at, created_at, metadata',
          (query) =>
          orderNewest('created_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows(
          'InCert-finance_payout_batches',
          'id, provider_organization_id, status, reference, scheduled_for, paid_at, total_inc_vat, created_at, metadata',
          orderNewest('created_at')
        ),
        selectRows('InCert-analytics_risk_signals', 'id, organization_id, signal_type, severity, score, detected_at', (query) =>
          orderNewest('detected_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-integration_sync_jobs', 'id, connector_name, status, finished_at, created_at', (query) =>
          orderNewest('created_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-api_clients', 'id, name, client_key, scopes, is_active, created_at, updated_at', (query) =>
          orderNewest('created_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-webhook_endpoints', 'id, name, url, is_active, updated_at', (query) =>
          orderNewest('updated_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-webhook_delivery_events', 'id, endpoint_id, status, attempt_count, event_type, delivered_at, updated_at, created_at', orderNewest('created_at')),
        selectRows('InCert-mobile_devices', 'id, device_identifier, platform, attestation_status', (query) =>
          orderNewest('created_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-mobile_audit_sessions', 'id, job_id, device_id, status, started_at, ended_at, last_sync_at, created_at', (query) =>
          orderNewest('created_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-enterprise_sso_providers', 'id, name, is_active, metadata, updated_at', (query) =>
          orderNewest('updated_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-enterprise_access_policies', 'id, policy_name, is_active, updated_at', (query) =>
          orderNewest('updated_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-enterprise_security_events', 'id, event_type, severity, source, event_at', (query) =>
          orderNewest('event_at')(scopeByOrg('organization_id')(query))
        ),
        selectRows('InCert-qa_test_suites', 'id, name', orderNewest('updated_at')),
        selectRows('InCert-qa_test_runs', 'id, suite_id, status, branch_name, summary, started_at, completed_at, created_at', orderNewest('created_at')),
        selectRows('InCert-release_gates', 'id, name', orderNewest('updated_at')),
        selectRows('InCert-release_gate_results', 'id, run_id, gate_id, status, notes, checked_at, updated_at', orderNewest('updated_at')),
      ]);

      const latestVersionByTemplateId = new Map();
      templateVersionRows.forEach((version) => {
        const templateId = String(version.template_id || '');
        if (!templateId) {
          return;
        }
        const previous = latestVersionByTemplateId.get(templateId);
        if (!previous || Number(version.version_number || 0) > Number(previous.version_number || 0)) {
          latestVersionByTemplateId.set(templateId, version);
        }
      });
      const versionById = new Map(templateVersionRows.map((version) => [String(version.id || ''), version]));
      const liveTemplateBlueprints = templateDefinitionRows.map((definition, index) => {
        const definitionId = String(definition.id || '');
        const currentVersion =
          versionById.get(String(definition.current_version_id || '')) || latestVersionByTemplateId.get(definitionId) || null;
        return {
          id: `TPLX-${String(index + 1).padStart(4, '0')}`,
          ownerOrgId: String(definition.organization_id || ''),
          name: String(definition.name || `Template ${index + 1}`),
          category: String(definition.regime || 'LOLER'),
          schemaVersion: '1.0',
          scoringModel:
            String(currentVersion?.scoring_model?.mode || currentVersion?.scoring_model?.model || 'weighted_sections'),
          licenceModel: 'single_site',
          status: String(currentVersion?.status || 'draft'),
          currentVersion: `${Number(currentVersion?.version_number || 1)}.0`,
          blockTypes: [],
          mandatoryEvidenceBlocks: 0,
          versions: [],
          passThreshold: { passScore: 0, maxScore: 0, passPercent: 0, criticalQuestionIds: [] },
          questionBank: [],
        };
      });
      setTemplateBlueprints(liveTemplateBlueprints);

      const mappedBidBoard = bidRows.map((bid) => ({
        id: `BID-${String(bid.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
        requestId: `REQ-${String(bid.request_id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
        providerOrgName: organizationNameById.get(String(bid.organization_id || '')) || 'Provider',
        strategy: String(bid.metadata?.strategy || 'best_value'),
        totalExVat: Number(bid.total_ex_vat || 0),
        vatAmount: Number(bid.vat_amount || 0),
        leadTimeHours: Number(bid.lead_time_hours || 0),
        qualityScore: Number(bid.quality_score || 0),
        rankScore: Number(bid.rank_score || 0),
        status: String(bid.status || 'submitted'),
        submittedAt: String(bid.submitted_at || ''),
        assignedAuditor: String(bid.metadata?.assignedAuditor || bid.metadata?.assigned_auditor || ''),
        assignmentStatus: String(bid.metadata?.assignmentStatus || bid.metadata?.assignment_status || 'pending'),
      }));
      setMarketplaceBidBoard(mappedBidBoard);

      setDispatchSlaEvents(
        dispatchEventRows.map((event) => ({
          id: `SLA-${String(event.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          requestId: `REQ-${String(event.request_id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          eventType: String(event.event_type || ''),
          eventAt: String(event.event_at || ''),
          minutesFromOpen: Number(event.minutes_from_open || 0),
          isBreach: Boolean(event.is_breach),
        }))
      );

      setEvidenceAiJobs(
        aiJobRows.map((job) => ({
          id: `EAI-${String(job.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          evidenceRef: `evidence://${String(job.evidence_file_id || '')}`,
          model: String(job.model_name || 'gpt-5-mini'),
          status: String(job.status || 'queued'),
          extractionSummary: String(job.metadata?.extractionSummary || job.metadata?.extraction_summary || ''),
          confidenceScore: Number(job.metadata?.confidenceScore || job.metadata?.confidence_score || 0),
          createdAt: String(job.created_at || ''),
          completedAt: String(job.completed_at || ''),
          reviewDecision: String(job.metadata?.reviewDecision || job.metadata?.review_decision || 'pending'),
        }))
      );

      setEvidenceProvenanceEvents(
        provenanceRows.map((event) => ({
          id: `PRV-${String(event.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          evidenceRef: `evidence://${String(event.evidence_file_id || '')}`,
          eventType: String(event.event_type || ''),
          hash: String(event.file_hash_sha256 || ''),
          deviceMetadata: String(event.metadata?.device || event.metadata?.device_identifier || ''),
          createdAt: String(event.created_at || ''),
        }))
      );

      setRegulatorVerificationRequests(
        verificationRows.map((request) => ({
          id: `VRQ-${String(request.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          requestor:
            String(request.requester_email || '').trim() ||
            organizationNameById.get(String(request.requester_organization_id || '')) ||
            'Verification desk',
          referenceId: String(request.certificate_id || ''),
          status: String(request.status || 'open'),
          requestedAt: String(request.opened_at || ''),
          dueAt: String(request.metadata?.dueAt || request.metadata?.due_at || ''),
          latestEvent: String(request.decision_notes || request.metadata?.latestEvent || 'Verification requested'),
        }))
      );

      setAuditFindings(
        findingRows.map((finding) => ({
          id: `FND-${String(finding.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          severity: String(finding.severity || 'medium'),
          taxonomyCode: String(finding.finding_code || ''),
          description: String(finding.summary || ''),
          linkedBlockId: '',
          photos: 0,
          riskScore: 0,
          status: 'open',
        }))
      );

      setAuditActions(
        capaRows.map((action) => ({
          id: `ACT-${String(action.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          findingId: String(action.finding_id || ''),
          assignee: String(action.owner_user_id || 'Assignee'),
          dueDate: String(action.due_date || ''),
          status: String(action.status || 'open'),
          evidenceRequired: true,
          closureSignoff: 'auditor',
          closureEvidenceCount: 0,
        }))
      );

      setFinanceInvoices(
        invoiceRows.map((invoice) => {
          const metadata = invoice?.metadata && typeof invoice.metadata === 'object' ? invoice.metadata : {};
          const companyOrgId = String(invoice.organization_id || '').trim();
          const companyName = organizationNameById.get(companyOrgId) || 'Organization';
          const normalizedStatus = String(invoice.status || '').toLowerCase();
          const mappedStatus = (() => {
            if (normalizedStatus === 'paid') {
              return 'paid';
            }
            if (normalizedStatus === 'overdue') {
              return 'overdue';
            }
            if (normalizedStatus === 'issued') {
              return 'issued';
            }
            if (normalizedStatus === 'approved') {
              return 'approved';
            }
            return 'pending_approval';
          })();

          return {
            id: String(invoice.id || ''),
            invoiceNumber: String(invoice.invoice_number || ''),
            jobId: String(invoice.job_id || ''),
            status: mappedStatus,
            subtotalExVat: Number(invoice.subtotal_ex_vat || 0),
            vatAmount: Number(invoice.vat_amount || 0),
            totalIncVat: Number(invoice.total_inc_vat || 0),
            paidAt: String(invoice.paid_at || ''),
            issuedAt: String(invoice.issued_at || ''),
            dueAt: String(invoice.due_at || ''),
            createdAt: String(invoice.created_at || ''),
            companyId: normalizeCompanyIdentifier(companyName) || '',
            companyOrgId,
            billToName: companyName,
            billToEntityType: String(metadata.billToEntityType || 'company'),
            billToEntityId: String(metadata.billToEntityId || normalizeCompanyIdentifier(companyName) || ''),
            billToOrganizationId: String(metadata.billToOrganizationId || companyOrgId),
            payToEntityType: String(metadata.payToEntityType || ''),
            payToEntityId: String(metadata.payToEntityId || ''),
            payToAuditorId: String(metadata.payToAuditorId || metadata.pay_to_auditor_id || ''),
            payToAuditCompanyId: String(metadata.payToAuditCompanyId || metadata.pay_to_audit_company_id || ''),
            payToOrganizationId: String(metadata.payToOrganizationId || metadata.pay_to_organization_id || ''),
            providerName: String(metadata.providerName || metadata.provider_name || ''),
            payToName: String(metadata.payToName || metadata.pay_to_name || ''),
          };
        })
      );

      setPayoutRuns(
        payoutRows.map((batch) => {
          const metadata = batch?.metadata && typeof batch.metadata === 'object' ? batch.metadata : {};
          const providerOrgId = String(batch.provider_organization_id || '').trim();
          return {
            id: String(batch.id || ''),
            invoiceId: String(metadata.invoiceId || metadata.invoice_id || ''),
            jobId: String(metadata.jobId || metadata.job_id || ''),
            status: String(batch.status || 'draft'),
            scheduledFor: String(batch.scheduled_for || ''),
            paidAt: String(batch.paid_at || ''),
            totalIncVat: Number(batch.total_inc_vat || 0),
            reference: String(batch.reference || ''),
            providerName: String(metadata.providerName || metadata.provider_name || organizationNameById.get(providerOrgId) || ''),
            payToEntityType: String(metadata.payToEntityType || metadata.pay_to_entity_type || ''),
            payToEntityId: String(metadata.payToEntityId || metadata.pay_to_entity_id || ''),
            payToOrganizationId: providerOrgId,
            payToAuditorId: String(metadata.payToAuditorId || metadata.pay_to_auditor_id || ''),
            payToAuditCompanyId: String(metadata.payToAuditCompanyId || metadata.pay_to_audit_company_id || providerOrgId),
            companyId: String(metadata.companyId || metadata.company_id || ''),
            companyOrgId: String(metadata.companyOrgId || metadata.company_org_id || ''),
          };
        })
      );

      setAnalyticsRiskSignals(
        riskSignalRows.map((signal) => ({
          id: `RSK-${String(signal.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          organization: organizationNameById.get(String(signal.organization_id || '')) || 'Organization',
          signal: String(signal.signal_type || ''),
          riskLevel: String(signal.severity || 'low'),
          confidence: Number(signal.score || 0),
          triggeredAt: String(signal.detected_at || ''),
        }))
      );

      setIntegrationConnections(
        integrationSyncRows.map((sync) => ({
          id: String(sync.id || ''),
          name: String(sync.connector_name || 'Connector'),
          category: 'Integration',
          status: String(sync.status || '').toLowerCase() === 'succeeded' ? 'connected' : 'not_connected',
          endpoint: '',
          lastSyncAt: String(sync.finished_at || sync.created_at || ''),
        }))
      );

      setApiClients(
        apiClientRows.map((client) => ({
          id: `API-${String(client.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          name: String(client.name || 'API Client'),
          status: client.is_active ? 'active' : 'inactive',
          scopes: Array.isArray(client.scopes) ? client.scopes : [],
          secretFingerprint: String(client.client_key || '').slice(-8),
          secretRotatedAt: String(client.updated_at || ''),
          createdAt: String(client.created_at || ''),
        }))
      );

      const webhookNameById = new Map(
        webhookEndpointRows.map((endpoint) => [String(endpoint.id || ''), String(endpoint.name || 'Webhook')])
      );
      const endpointLastDeliveredAt = webhookDeliveryRows.reduce((accumulator, deliveryEvent) => {
        const endpointId = String(deliveryEvent.endpoint_id || '');
        if (!endpointId) {
          return accumulator;
        }
        const deliveredAt = String(deliveryEvent.delivered_at || deliveryEvent.updated_at || deliveryEvent.created_at || '');
        if (!accumulator.has(endpointId) || deliveredAt > accumulator.get(endpointId)) {
          accumulator.set(endpointId, deliveredAt);
        }
        return accumulator;
      }, new Map());

      setWebhookEndpoints(
        webhookEndpointRows.map((endpoint) => {
          const endpointId = String(endpoint.id || '');
          return {
            id: `WEP-${endpointId.replace(/-/g, '').slice(0, 8).toUpperCase()}`,
            name: String(endpoint.name || 'Webhook Endpoint'),
            status: endpoint.is_active ? 'active' : 'inactive',
            targetUrl: String(endpoint.url || ''),
            lastDeliveredAt: endpointLastDeliveredAt.get(endpointId) || '',
          };
        })
      );

      setWebhookDeliveryEvents(
        webhookDeliveryRows.map((event) => ({
          id: `WEB-${String(event.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          endpointLabel: webhookNameById.get(String(event.endpoint_id || '')) || 'Webhook',
          status: String(event.status || 'pending'),
          attempts: Number(event.attempt_count || 0),
          lastAttemptAt: String(event.updated_at || event.created_at || ''),
          latencyMs: 0,
        }))
      );

      const mobileDeviceById = new Map(
        mobileDeviceRows.map((device) => [String(device.id || ''), device])
      );
      setMobileAuditSessions(
        mobileSessionRows.map((session) => {
          const device = mobileDeviceById.get(String(session.device_id || '')) || null;
          return {
            id: `MAS-${String(session.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
            jobId: String(session.job_id || ''),
            deviceName: device
              ? `${String(device.platform || 'Device')} - ${String(device.device_identifier || '').slice(0, 8)}`
              : 'Mobile Device',
            attestationStatus: String(device?.attestation_status || 'unknown'),
            syncStatus: String(session.status || 'active'),
            startedAt: String(session.started_at || ''),
            closedAt: String(session.ended_at || ''),
          };
        })
      );

      setEnterpriseSsoProviders(
        ssoProviderRows.map((provider) => ({
          id: `SSO-${String(provider.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          providerName: String(provider.name || 'SSO Provider'),
          status: provider.is_active ? 'configured' : 'disabled',
          domain: String(provider.metadata?.domain || provider.metadata?.primary_domain || ''),
          updatedAt: String(provider.updated_at || ''),
        }))
      );

      setEnterpriseAccessPolicies(
        enterprisePolicyRows.map((policy) => ({
          id: `POL-${String(policy.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          name: String(policy.policy_name || 'Policy'),
          status: policy.is_active ? 'enabled' : 'disabled',
          updatedAt: String(policy.updated_at || ''),
        }))
      );

      setEnterpriseSecurityEvents(
        securityEventRows.map((event) => ({
          id: `SEC-${String(event.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          eventType: String(event.event_type || ''),
          severity: String(event.severity || 'low'),
          actor: String(event.source || 'system'),
          occurredAt: String(event.event_at || ''),
        }))
      );

      const qaSuiteNameById = new Map(
        qaSuiteRows.map((suite) => [String(suite.id || ''), String(suite.name || 'QA Suite')])
      );
      setQaHarnessRuns(
        qaRunRows.map((run) => {
          const summary = run.summary && typeof run.summary === 'object' ? run.summary : {};
          const passRateCandidate = Number(summary.pass_rate || summary.passRate || summary.passed_pct || 0);
          return {
            id: `QAR-${String(run.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
            suiteName: qaSuiteNameById.get(String(run.suite_id || '')) || 'QA Suite',
            status: String(run.status || 'queued'),
            branch: String(run.branch_name || 'main'),
            startedAt: String(run.started_at || ''),
            completedAt: String(run.completed_at || ''),
            passRate: Number.isFinite(passRateCandidate) ? passRateCandidate : 0,
          };
        })
      );

      const gateNameById = new Map(
        releaseGateRows.map((gate) => [String(gate.id || ''), String(gate.name || 'Release Gate')])
      );
      setReleaseGateResults(
        releaseGateResultRows.map((result) => ({
          id: `RLG-${String(result.id || '').replace(/-/g, '').slice(0, 8).toUpperCase()}`,
          gateName: gateNameById.get(String(result.gate_id || '')) || 'Release Gate',
          status: String(result.status || 'pending'),
          evaluatedAt: String(result.checked_at || result.updated_at || ''),
          notes: String(result.notes || ''),
        }))
      );

      setTenantInvites([]);
    };

    loadSupabaseData().catch((error) => {
      if (isCancelled) {
        return;
      }
      console.error('Failed to hydrate Supabase data', error);
    });

    return () => {
      isCancelled = true;
    };
  }, [isSupabaseRuntime, supabaseSession?.user?.id, clearSupabaseOpsAndProviderState]);

  const enrichedAssets = useMemo(() => {
    return assets
      .map((asset) => ({
        ...asset,
        status: deriveAssetStatus(asset.nextDue),
      }))
      .sort((a, b) => {
        const first = parseISODate(a.nextDue)?.getTime() || 0;
        const second = parseISODate(b.nextDue)?.getTime() || 0;
        return first - second;
      });
  }, [assets]);

  const enrichedCertificates = useMemo(() => {
    return certificates.map((certificate) => ({
      ...certificate,
      status: deriveCertificateStatus(certificate.expiryDate),
    }));
  }, [certificates]);

  const certificatesByAsset = useMemo(() => {
    const groupedCertificates = new Map();
    enrichedCertificates.forEach((certificate) => {
      if (!groupedCertificates.has(certificate.assetId)) {
        groupedCertificates.set(certificate.assetId, []);
      }
      groupedCertificates.get(certificate.assetId).push(certificate);
    });

    groupedCertificates.forEach((list) => {
      list.sort((first, second) => {
        const firstDate = parseISODate(first.issueDate)?.getTime() || 0;
        const secondDate = parseISODate(second.issueDate)?.getTime() || 0;
        return secondDate - firstDate;
      });
    });

    return groupedCertificates;
  }, [enrichedCertificates]);

  const urgentAssets = useMemo(() => {
    return enrichedAssets
      .filter((asset) => asset.status !== 'compliant')
      .sort((first, second) => {
        const firstDue = daysUntil(first.nextDue) ?? Number.MAX_SAFE_INTEGER;
        const secondDue = daysUntil(second.nextDue) ?? Number.MAX_SAFE_INTEGER;
        return firstDue - secondDue;
      })
      .slice(0, 6);
  }, [enrichedAssets]);

  const upcomingAssets = useMemo(() => {
    return enrichedAssets
      .filter((asset) => {
        const delta = daysUntil(asset.nextDue);
        return delta !== null && delta >= 0 && delta <= 45;
      })
      .slice(0, 6);
  }, [enrichedAssets]);

  const complianceTrend = useMemo(() => {
    const compliantAssets = enrichedAssets.filter((asset) => asset.status === 'compliant').length;
    const compliancePercentage =
      enrichedAssets.length > 0 ? Math.round((compliantAssets / enrichedAssets.length) * 100) : 0;
    return buildTrendPoints(compliancePercentage);
  }, [enrichedAssets]);

  const queuedInspectionCount = useMemo(
    () => inspectionLogs.filter((entry) => entry.syncStatus === 'queued').length,
    [inspectionLogs]
  );
  const activeCompanyContext = useMemo(() => {
    const fallbackName = 'Acme Logistics';
    const companyFromJobs = String(
      marketplaceJobs.find((job) => String(job?.companyName || '').trim())?.companyName || ''
    ).trim();
    const companyFromSiteTitle = String(publicSiteConfig?.siteTitle || '')
      .replace(/\s+Compliance Portal$/i, '')
      .trim();
    const resolvedName = companyFromJobs || companyFromSiteTitle || fallbackName;
    return {
      id: normalizeCompanyIdentifier(resolvedName) || 'acme-logistics',
      name: resolvedName,
    };
  }, [marketplaceJobs, publicSiteConfig?.siteTitle]);
  const activeProviderRecords = isSupabaseRuntime ? providerDirectory : auditors;
  const activeCompanyInitials = useMemo(() => {
    const initials = String(activeCompanyContext.name || '')
      .split(/\s+/)
      .map((part) => part[0] || '')
      .join('')
      .slice(0, 2)
      .toUpperCase();
    return initials || 'CO';
  }, [activeCompanyContext.name]);
  const effectiveUserRole = useMemo(
    () => normalizeUserRole(debugRole, normalizeUserRole(authSession.accountType)),
    [debugRole, authSession.accountType]
  );
  const allowedTabsForRole = useMemo(
    () => USER_ROLE_TAB_ACCESS[effectiveUserRole] || USER_ROLE_TAB_ACCESS.company,
    [effectiveUserRole]
  );
  const primaryRoleTab = allowedTabsForRole[0] || 'help';
  const effectiveRoleLabel = useMemo(
    () => USER_ROLE_OPTIONS.find((option) => option.id === effectiveUserRole)?.label || 'Company',
    [effectiveUserRole]
  );
  const marketplaceJobById = useMemo(
    () =>
      new Map(
        marketplaceJobs
          .map((job) => [String(job?.id || ''), job])
          .filter(([jobId]) => Boolean(jobId))
      ),
    [marketplaceJobs]
  );
  const financeInvoiceById = useMemo(
    () =>
      new Map(
        financeInvoices
          .map((invoice) => [String(invoice?.id || ''), invoice])
          .filter(([invoiceId]) => Boolean(invoiceId))
      ),
    [financeInvoices]
  );
  const providerLookupByIdentity = useMemo(() => {
    const lookup = new Map();
    const registerProvider = (key, provider) => {
      const normalizedKey = normalizeFinanceIdentityKey(key);
      if (!normalizedKey || lookup.has(normalizedKey)) {
        return;
      }
      lookup.set(normalizedKey, provider);
    };

    activeProviderRecords.forEach((provider) => {
      registerProvider(provider?.id, provider);
      registerProvider(provider?.dbOrganizationId, provider);
      registerProvider(provider?.name, provider);
      registerProvider(provider?.providerName, provider);
      registerProvider(provider?.thirdPartyOrganizationId, provider);
    });
    return lookup;
  }, [activeProviderRecords]);
  const findProviderForFinancialEntry = useCallback(
    (entry = {}) => {
      const lookupCandidates = [
        entry?.providerId,
        entry?.auditorId,
        entry?.payToAuditorId,
        entry?.providerOrganizationId,
        entry?.payToOrganizationId,
        entry?.matchedAuditorId,
        entry?.providerName,
        entry?.payToName,
      ];
      for (const candidate of lookupCandidates) {
        const provider = providerLookupByIdentity.get(normalizeFinanceIdentityKey(candidate));
        if (provider) {
          return provider;
        }
      }
      return null;
    },
    [providerLookupByIdentity]
  );
  const authLocalPart = useMemo(
    () =>
      String(authSession?.email || '')
        .split('@')[0]
        .replace(/[^a-z0-9]+/gi, ' ')
        .trim()
        .toLowerCase(),
    [authSession?.email]
  );
  const scopedAuditorProvider = useMemo(() => {
    const primaryOrgId = normalizeFinanceIdentityKey(primaryOrganizationScope?.organizationId);
    if (primaryOrgId) {
      const orgMatch = activeProviderRecords.find((provider) => {
        const providerId = normalizeFinanceIdentityKey(provider?.id);
        const providerOrgId = normalizeFinanceIdentityKey(provider?.dbOrganizationId);
        return providerId === primaryOrgId || providerOrgId === primaryOrgId;
      });
      if (orgMatch) {
        return orgMatch;
      }
    }

    if (authLocalPart) {
      const nameMatch = activeProviderRecords.find((provider) =>
        normalizeFinanceIdentityKey(provider?.name).includes(authLocalPart)
      );
      if (nameMatch) {
        return nameMatch;
      }
    }

    return activeProviderRecords[0] || null;
  }, [activeProviderRecords, authLocalPart, primaryOrganizationScope?.organizationId]);
  const scopedAuditCompany = useMemo(() => {
    const primaryOrgId = String(primaryOrganizationScope?.organizationId || '').trim();
    if (primaryOrgId) {
      const directName = String(primaryOrganizationScope?.organizationName || '').trim();
      return {
        id: primaryOrgId,
        name: directName || `Audit Company ${primaryOrgId.slice(0, 8)}`,
      };
    }

    const linkedThirdPartyProvider = activeProviderRecords.find((provider) => isThirdPartyProvider(provider)) || null;
    if (linkedThirdPartyProvider) {
      const linkedId = String(
        linkedThirdPartyProvider?.thirdPartyOrganizationId ||
        linkedThirdPartyProvider?.dbOrganizationId ||
        linkedThirdPartyProvider?.id ||
        ''
      ).trim();
      if (linkedId) {
        const linkedName =
          getThirdPartyOrganizationById(linkedThirdPartyProvider?.thirdPartyOrganizationId)?.name ||
          String(linkedThirdPartyProvider?.name || '').trim();
        return {
          id: linkedId,
          name: linkedName || 'Audit Company',
        };
      }
    }

    const fallbackOrganization = thirdPartyOrganizations[0] || null;
    return {
      id: String(fallbackOrganization?.id || '').trim(),
      name: String(fallbackOrganization?.name || 'Audit Company'),
    };
  }, [activeProviderRecords, primaryOrganizationScope?.organizationId, primaryOrganizationScope?.organizationName]);
  const companyAccountancyScopeOptions = useMemo(() => {
    const optionById = new Map();
    const addOption = (idValue, labelValue, organizationIdValue = '') => {
      const id = String(idValue || '').trim();
      const label = String(labelValue || '').trim();
      if (!id || !label || optionById.has(id)) {
        return;
      }
      optionById.set(id, {
        id,
        label,
        organizationId: String(organizationIdValue || '').trim(),
      });
    };

    addOption(activeCompanyContext?.id, activeCompanyContext?.name, primaryOrganizationScope?.organizationId);
    marketplaceJobs.forEach((job) => {
      const companyName = String(job?.companyName || '').trim();
      const companyId =
        String(job?.companyId || '').trim() ||
        normalizeCompanyIdentifier(companyName);
      addOption(companyId, companyName, job?.companyOrgId);
    });
    financeInvoices.forEach((invoice) => {
      const companyName = String(invoice?.billToName || invoice?.companyName || '').trim();
      const companyId =
        String(invoice?.companyId || '').trim() ||
        String(invoice?.billToEntityId || '').trim() ||
        normalizeCompanyIdentifier(companyName);
      const organizationId = String(invoice?.companyOrgId || invoice?.billToOrganizationId || '').trim();
      addOption(companyId, companyName, organizationId);
    });
    return Array.from(optionById.values()).sort((first, second) => first.label.localeCompare(second.label));
  }, [activeCompanyContext?.id, activeCompanyContext?.name, financeInvoices, marketplaceJobs, primaryOrganizationScope?.organizationId]);
  const auditorAccountancyScopeOptions = useMemo(() => {
    const optionById = new Map();
    const addOption = (idValue, labelValue, organizationIdValue = '') => {
      const id = String(idValue || '').trim();
      const label = String(labelValue || '').trim();
      if (!id || !label || optionById.has(id)) {
        return;
      }
      optionById.set(id, {
        id,
        label,
        organizationId: String(organizationIdValue || '').trim(),
      });
    };

    activeProviderRecords.forEach((provider) => {
      addOption(provider?.id, provider?.name, provider?.dbOrganizationId);
    });
    financeInvoices.forEach((invoice) => {
      const fallbackLabel = String(invoice?.providerName || invoice?.payToName || '').trim();
      addOption(invoice?.payToAuditorId, fallbackLabel, invoice?.payToOrganizationId);
    });
    return Array.from(optionById.values()).sort((first, second) => first.label.localeCompare(second.label));
  }, [activeProviderRecords, financeInvoices]);
  const auditCompanyAccountancyScopeOptions = useMemo(() => {
    const optionById = new Map();
    const addOption = (idValue, labelValue) => {
      const id = String(idValue || '').trim();
      const label = String(labelValue || '').trim();
      if (!id || !label || optionById.has(id)) {
        return;
      }
      optionById.set(id, { id, label, organizationId: id });
    };

    thirdPartyOrganizations.forEach((organization) => {
      addOption(organization?.id, organization?.name);
    });
    activeProviderRecords.forEach((provider) => {
      const orgId = String(
        provider?.thirdPartyOrganizationId ||
        (isThirdPartyProvider(provider) ? provider?.dbOrganizationId || provider?.id || '' : '')
      ).trim();
      if (!orgId) {
        return;
      }
      const orgName =
        getThirdPartyOrganizationById(provider?.thirdPartyOrganizationId)?.name ||
        String(provider?.name || '').trim();
      addOption(orgId, orgName);
    });
    financeInvoices.forEach((invoice) => {
      const orgId = String(invoice?.payToAuditCompanyId || '').trim();
      const orgName = String(invoice?.providerName || invoice?.payToName || '').trim();
      addOption(orgId, orgName);
    });
    return Array.from(optionById.values()).sort((first, second) => first.label.localeCompare(second.label));
  }, [activeProviderRecords, financeInvoices, getThirdPartyOrganizationById, isThirdPartyProvider, thirdPartyOrganizations]);
  const selectedDebugCompanyScopeOption = useMemo(() => {
    const explicitId = String(debugAccountancyScopeOverrides?.companyId || '').trim();
    if (explicitId) {
      return companyAccountancyScopeOptions.find((option) => option.id === explicitId) || null;
    }
    return companyAccountancyScopeOptions[0] || null;
  }, [companyAccountancyScopeOptions, debugAccountancyScopeOverrides?.companyId]);
  const selectedDebugAuditorScopeOption = useMemo(() => {
    const explicitId = String(debugAccountancyScopeOverrides?.auditorId || '').trim();
    if (explicitId) {
      return auditorAccountancyScopeOptions.find((option) => option.id === explicitId) || null;
    }
    return auditorAccountancyScopeOptions[0] || null;
  }, [auditorAccountancyScopeOptions, debugAccountancyScopeOverrides?.auditorId]);
  const selectedDebugAuditCompanyScopeOption = useMemo(() => {
    const explicitId = String(debugAccountancyScopeOverrides?.auditCompanyId || '').trim();
    if (explicitId) {
      return auditCompanyAccountancyScopeOptions.find((option) => option.id === explicitId) || null;
    }
    return auditCompanyAccountancyScopeOptions[0] || null;
  }, [auditCompanyAccountancyScopeOptions, debugAccountancyScopeOverrides?.auditCompanyId]);
  const accountancyScope = useMemo(() => {
    const normalizedRole = normalizeUserRole(effectiveUserRole, 'company');
    if (normalizedRole === 'incert') {
      return {
        mode: 'incert',
        label: 'InCert',
        entityId: '',
        organizationId: '',
      };
    }
    if (normalizedRole === 'auditor') {
      const scopedOption = isDebugBypassSession ? selectedDebugAuditorScopeOption : null;
      return {
        mode: 'auditor',
        label: String(scopedOption?.label || scopedAuditorProvider?.name || 'Auditor Account'),
        entityId: String(scopedOption?.id || scopedAuditorProvider?.id || ''),
        organizationId:
          String(scopedOption?.organizationId || '').trim() ||
          String(scopedAuditorProvider?.dbOrganizationId || '').trim() ||
          String(primaryOrganizationScope?.organizationId || '').trim(),
      };
    }
    if (normalizedRole === 'third_party') {
      const scopedOption = isDebugBypassSession ? selectedDebugAuditCompanyScopeOption : null;
      return {
        mode: 'auditor_company',
        label: String(scopedOption?.label || scopedAuditCompany?.name || 'Audit Company Account'),
        entityId: String(scopedOption?.id || scopedAuditCompany?.id || ''),
        organizationId: String(scopedOption?.organizationId || scopedAuditCompany?.id || ''),
      };
    }
    const scopedOption = isDebugBypassSession ? selectedDebugCompanyScopeOption : null;
    return {
      mode: 'company',
      label: String(scopedOption?.label || activeCompanyContext?.name || 'Company Account'),
      entityId: String(scopedOption?.id || activeCompanyContext?.id || ''),
      organizationId: String(scopedOption?.organizationId || primaryOrganizationScope?.organizationId || '').trim(),
    };
  }, [
    activeCompanyContext?.id,
    activeCompanyContext?.name,
    effectiveUserRole,
    isDebugBypassSession,
    primaryOrganizationScope?.organizationId,
    selectedDebugAuditCompanyScopeOption,
    selectedDebugAuditorScopeOption,
    selectedDebugCompanyScopeOption,
    scopedAuditCompany?.id,
    scopedAuditCompany?.name,
    scopedAuditorProvider?.dbOrganizationId,
    scopedAuditorProvider?.id,
    scopedAuditorProvider?.name,
  ]);
  const accountancyDebugScopeConfig = useMemo(() => {
    if (!isDebugBypassSession || accountancyScope.mode === 'incert') {
      return null;
    }
    if (accountancyScope.mode === 'company') {
      return {
        label: 'Company',
        value: String(selectedDebugCompanyScopeOption?.id || ''),
        options: companyAccountancyScopeOptions,
        onChange: (nextId) =>
          setDebugAccountancyScopeOverrides((previous) => ({
            ...previous,
            companyId: String(nextId || ''),
          })),
      };
    }
    if (accountancyScope.mode === 'auditor') {
      return {
        label: 'Auditor',
        value: String(selectedDebugAuditorScopeOption?.id || ''),
        options: auditorAccountancyScopeOptions,
        onChange: (nextId) =>
          setDebugAccountancyScopeOverrides((previous) => ({
            ...previous,
            auditorId: String(nextId || ''),
          })),
      };
    }
    if (accountancyScope.mode === 'auditor_company') {
      return {
        label: 'Audit company',
        value: String(selectedDebugAuditCompanyScopeOption?.id || ''),
        options: auditCompanyAccountancyScopeOptions,
        onChange: (nextId) =>
          setDebugAccountancyScopeOverrides((previous) => ({
            ...previous,
            auditCompanyId: String(nextId || ''),
          })),
      };
    }
    return null;
  }, [
    accountancyScope.mode,
    auditCompanyAccountancyScopeOptions,
    auditorAccountancyScopeOptions,
    companyAccountancyScopeOptions,
    isDebugBypassSession,
    selectedDebugAuditCompanyScopeOption?.id,
    selectedDebugAuditorScopeOption?.id,
    selectedDebugCompanyScopeOption?.id,
  ]);
  const resolveInvoiceOwnershipForScope = useCallback(
    (invoice) => {
      const linkedJob = marketplaceJobById.get(String(invoice?.jobId || '')) || null;
      const resolvedCompanyName = String(
        invoice?.billToName || invoice?.companyName || linkedJob?.companyName || activeCompanyContext?.name || ''
      ).trim();
      const resolvedCompanyId = String(
        invoice?.companyId ||
        (String(invoice?.billToEntityType || '').toLowerCase() === 'company' ? invoice?.billToEntityId : '') ||
        linkedJob?.companyId ||
        normalizeCompanyIdentifier(resolvedCompanyName) ||
        activeCompanyContext?.id ||
        ''
      ).trim();
      const resolvedCompanyOrgId = String(
        invoice?.companyOrgId || invoice?.billToOrganizationId || linkedJob?.companyOrgId || ''
      ).trim();
      const linkedProvider = findProviderForFinancialEntry({
        providerId: invoice?.providerId,
        auditorId: invoice?.auditorId,
        payToAuditorId: invoice?.payToAuditorId,
        providerOrganizationId: invoice?.payToOrganizationId,
        matchedAuditorId: linkedJob?.matchedAuditorId,
        providerName: invoice?.providerName || invoice?.payToName || linkedJob?.matchedAuditorName,
      });
      const resolvedAuditorId = String(
        invoice?.payToAuditorId ||
        invoice?.auditorId ||
        (String(invoice?.payToEntityType || '').toLowerCase() === 'auditor' ? invoice?.payToEntityId : '') ||
        linkedProvider?.id ||
        linkedJob?.matchedAuditorId ||
        ''
      ).trim();
      const resolvedAuditorOrgId = String(
        invoice?.payToOrganizationId || linkedProvider?.dbOrganizationId || ''
      ).trim();
      const resolvedAuditCompanyId = String(
        invoice?.payToAuditCompanyId ||
        invoice?.auditCompanyId ||
        (String(invoice?.payToEntityType || '').toLowerCase() === 'auditor_company' ? invoice?.payToEntityId : '') ||
        linkedProvider?.thirdPartyOrganizationId ||
        (isThirdPartyProvider(linkedProvider)
          ? linkedProvider?.dbOrganizationId || linkedProvider?.id || ''
          : '')
      ).trim();
      return {
        companyId: resolvedCompanyId,
        companyOrgId: resolvedCompanyOrgId,
        auditorId: resolvedAuditorId,
        auditorOrgId: resolvedAuditorOrgId,
        auditCompanyId: resolvedAuditCompanyId,
      };
    },
    [activeCompanyContext?.id, activeCompanyContext?.name, findProviderForFinancialEntry, marketplaceJobById]
  );
  const resolvePayoutOwnershipForScope = useCallback(
    (run) => {
      const linkedInvoice = financeInvoiceById.get(String(run?.invoiceId || '')) || null;
      const linkedOwnership = linkedInvoice ? resolveInvoiceOwnershipForScope(linkedInvoice) : null;
      const linkedProvider = findProviderForFinancialEntry({
        payToAuditorId: run?.payToAuditorId || linkedInvoice?.payToAuditorId,
        payToOrganizationId: run?.payToOrganizationId || linkedInvoice?.payToOrganizationId,
        providerName: run?.providerName || linkedInvoice?.providerName || linkedInvoice?.payToName,
      });
      const resolvedAuditCompanyId = String(
        run?.payToAuditCompanyId ||
        linkedOwnership?.auditCompanyId ||
        linkedProvider?.thirdPartyOrganizationId ||
        (isThirdPartyProvider(linkedProvider)
          ? linkedProvider?.dbOrganizationId || linkedProvider?.id || ''
          : '')
      ).trim();
      const resolvedAuditorId = String(run?.payToAuditorId || linkedOwnership?.auditorId || linkedProvider?.id || '').trim();
      const resolvedPayToEntityType = String(
        run?.payToEntityType ||
        linkedInvoice?.payToEntityType ||
        (resolvedAuditCompanyId ? 'auditor_company' : resolvedAuditorId ? 'auditor' : '')
      ).trim().toLowerCase();
      const resolvedPayToEntityId = String(
        run?.payToEntityId ||
        linkedInvoice?.payToEntityId ||
        (resolvedPayToEntityType === 'auditor_company' ? resolvedAuditCompanyId : resolvedAuditorId) ||
        ''
      ).trim();
      return {
        companyId: String(run?.companyId || linkedOwnership?.companyId || '').trim(),
        companyOrgId: String(run?.companyOrgId || linkedOwnership?.companyOrgId || '').trim(),
        auditorId: resolvedAuditorId,
        auditorOrgId: String(
          run?.payToOrganizationId || linkedOwnership?.auditorOrgId || linkedProvider?.dbOrganizationId || ''
        ).trim(),
        auditCompanyId: resolvedAuditCompanyId,
        payToEntityType: resolvedPayToEntityType,
        payToEntityId: resolvedPayToEntityId,
      };
    },
    [financeInvoiceById, findProviderForFinancialEntry, resolveInvoiceOwnershipForScope]
  );
  const accountancyScopeKeySet = useMemo(() => {
    const keys = new Set();
    [accountancyScope?.entityId, accountancyScope?.organizationId].forEach((value) => {
      const normalized = normalizeFinanceIdentityKey(value);
      if (normalized) {
        keys.add(normalized);
      }
    });
    return keys;
  }, [accountancyScope?.entityId, accountancyScope?.organizationId]);
  const isInvoiceInAccountancyScope = useCallback(
    (invoice) => {
      if (accountancyScope?.mode === 'incert') {
        return true;
      }
      if (accountancyScope?.mode === 'auditor' || accountancyScope?.mode === 'auditor_company') {
        return false;
      }
      if (!(accountancyScopeKeySet instanceof Set) || accountancyScopeKeySet.size === 0) {
        return false;
      }
      const ownership = resolveInvoiceOwnershipForScope(invoice);
      if (accountancyScope?.mode === 'company') {
        return (
          accountancyScopeKeySet.has(normalizeFinanceIdentityKey(ownership.companyId)) ||
          accountancyScopeKeySet.has(normalizeFinanceIdentityKey(ownership.companyOrgId))
        );
      }
      if (accountancyScope?.mode === 'auditor') {
        return (
          accountancyScopeKeySet.has(normalizeFinanceIdentityKey(ownership.auditorId)) ||
          accountancyScopeKeySet.has(normalizeFinanceIdentityKey(ownership.auditorOrgId))
        );
      }
      if (accountancyScope?.mode === 'auditor_company') {
        return (
          accountancyScopeKeySet.has(normalizeFinanceIdentityKey(ownership.auditCompanyId)) ||
          accountancyScopeKeySet.has(normalizeFinanceIdentityKey(ownership.auditorOrgId))
        );
      }
      return false;
    },
    [accountancyScope?.mode, accountancyScopeKeySet, resolveInvoiceOwnershipForScope]
  );
  const isPayoutInAccountancyScope = useCallback(
    (run) => {
      if (accountancyScope?.mode === 'incert') {
        return true;
      }
      if (accountancyScope?.mode === 'company') {
        return false;
      }
      if (!(accountancyScopeKeySet instanceof Set) || accountancyScopeKeySet.size === 0) {
        return false;
      }
      const ownership = resolvePayoutOwnershipForScope(run);
      const payToEntityType = String(ownership?.payToEntityType || '').trim().toLowerCase();
      const payToEntityId = String(ownership?.payToEntityId || '').trim();
      if (accountancyScope?.mode === 'auditor') {
        if (payToEntityType === 'auditor_company') {
          return false;
        }
        if (payToEntityType === 'auditor') {
          return accountancyScopeKeySet.has(
            normalizeFinanceIdentityKey(payToEntityId || ownership.auditorId)
          );
        }
        return accountancyScopeKeySet.has(normalizeFinanceIdentityKey(ownership.auditorId));
      }
      if (accountancyScope?.mode === 'auditor_company') {
        if (payToEntityType === 'auditor') {
          return false;
        }
        if (payToEntityType === 'auditor_company') {
          return accountancyScopeKeySet.has(
            normalizeFinanceIdentityKey(payToEntityId || ownership.auditCompanyId)
          );
        }
        return accountancyScopeKeySet.has(normalizeFinanceIdentityKey(ownership.auditCompanyId));
      }
      return false;
    },
    [accountancyScope?.mode, accountancyScopeKeySet, resolvePayoutOwnershipForScope]
  );
  const scopedFinanceInvoices = useMemo(
    () => financeInvoices.filter((invoice) => isInvoiceInAccountancyScope(invoice)),
    [financeInvoices, isInvoiceInAccountancyScope]
  );
  const scopedPayoutRuns = useMemo(
    () => payoutRuns.filter((run) => isPayoutInAccountancyScope(run)),
    [isPayoutInAccountancyScope, payoutRuns]
  );
  const scopedInvoiceIdSet = useMemo(
    () =>
      new Set(
        scopedFinanceInvoices
          .map((invoice) => String(invoice?.id || ''))
          .filter(Boolean)
      ),
    [scopedFinanceInvoices]
  );
  const scopedPayoutRunIdSet = useMemo(
    () =>
      new Set(
        scopedPayoutRuns
          .map((run) => String(run?.id || ''))
          .filter(Boolean)
      ),
    [scopedPayoutRuns]
  );
  const canManageInCertAccountancy = accountancyScope.mode === 'incert';
  const canRolePayInvoices = accountancyScope.mode === 'company';
  const canViewerPayInvoice = useCallback(
    (invoice) => {
      if (canManageInCertAccountancy) {
        return true;
      }
      if (accountancyScope.mode !== 'company' || !canRolePayInvoices) {
        return false;
      }
      const billToType = String(invoice?.billToEntityType || 'company').toLowerCase();
      return billToType === 'company';
    },
    [accountancyScope.mode, canManageInCertAccountancy, canRolePayInvoices]
  );
  useEffect(() => {
    if (isDebugBypassSession) {
      return;
    }
    setDebugAccountancyScopeOverrides({
      companyId: '',
      auditorId: '',
      auditCompanyId: '',
    });
  }, [isDebugBypassSession]);

  // Initialization & Theme
  useEffect(() => {
    setIsLoaded(true);

    if (typeof window === 'undefined') {
      return;
    }

    const storedTheme = window.localStorage.getItem(THEME_STORAGE_KEY);
    if (storedTheme === 'dark') {
      setIsDarkMode(true);
      return;
    }

    if (storedTheme === 'light') {
      setIsDarkMode(false);
      return;
    }

    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      setIsDarkMode(true);
    }
  }, []);

  useEffect(() => {
    document.documentElement.classList.toggle('dark', isDarkMode);

    try {
      window.localStorage.setItem(THEME_STORAGE_KEY, isDarkMode ? 'dark' : 'light');
    } catch {
      // no-op when storage is unavailable
    }
  }, [isDarkMode]);

  useEffect(() => {
    try {
      window.localStorage.setItem(ASSET_STORAGE_KEY, JSON.stringify(assets));
    } catch {
      // no-op when storage is unavailable
    }
  }, [assets]);

  useEffect(() => {
    try {
      window.localStorage.setItem(MARKETPLACE_JOBS_STORAGE_KEY, JSON.stringify(marketplaceJobs));
    } catch {
      // no-op when storage is unavailable
    }
  }, [marketplaceJobs]);

  useEffect(() => {
    try {
      window.localStorage.setItem(INSPECTION_LOG_STORAGE_KEY, JSON.stringify(inspectionLogs));
    } catch {
      // no-op when storage is unavailable
    }
  }, [inspectionLogs]);

  useEffect(() => {
    try {
      window.localStorage.setItem(RECURRING_PROGRAMMES_STORAGE_KEY, JSON.stringify(recurringProgrammes));
    } catch {
      // no-op when storage is unavailable
    }
  }, [recurringProgrammes]);

  useEffect(() => {
    try {
      window.localStorage.setItem(PUBLIC_SITE_CONFIG_STORAGE_KEY, JSON.stringify(publicSiteConfig));
    } catch {
      // no-op when storage is unavailable
    }
  }, [publicSiteConfig]);

  useEffect(() => {
    try {
      window.localStorage.setItem(ONBOARDING_TASKS_STORAGE_KEY, JSON.stringify(onboardingTasks));
    } catch {
      // no-op when storage is unavailable
    }
  }, [onboardingTasks]);

  useEffect(() => {
    try {
      window.localStorage.setItem(FINANCE_INVOICES_STORAGE_KEY, JSON.stringify(financeInvoices));
    } catch {
      // no-op when storage is unavailable
    }
  }, [financeInvoices]);

  useEffect(() => {
    try {
      window.localStorage.setItem(PAYOUT_RUNS_STORAGE_KEY, JSON.stringify(payoutRuns));
    } catch {
      // no-op when storage is unavailable
    }
  }, [payoutRuns]);

  useEffect(() => {
    try {
      window.localStorage.setItem(INSPECTION_TEMPLATES_STORAGE_KEY, JSON.stringify(inspectionTemplates));
    } catch {
      // no-op when storage is unavailable
    }
  }, [inspectionTemplates]);

  useEffect(() => {
    try {
      window.localStorage.setItem(INTEGRATION_CONNECTIONS_STORAGE_KEY, JSON.stringify(integrationConnections));
    } catch {
      // no-op when storage is unavailable
    }
  }, [integrationConnections]);

  useEffect(() => {
    try {
      window.localStorage.setItem(API_CLIENTS_STORAGE_KEY, JSON.stringify(apiClients));
    } catch {
      // no-op when storage is unavailable
    }
  }, [apiClients]);

  useEffect(() => {
    try {
      window.localStorage.setItem(WEBHOOK_ENDPOINTS_STORAGE_KEY, JSON.stringify(webhookEndpoints));
    } catch {
      // no-op when storage is unavailable
    }
  }, [webhookEndpoints]);

  useEffect(() => {
    try {
      window.localStorage.setItem(ENTERPRISE_SSO_PROVIDERS_STORAGE_KEY, JSON.stringify(enterpriseSsoProviders));
    } catch {
      // no-op when storage is unavailable
    }
  }, [enterpriseSsoProviders]);

  useEffect(() => {
    try {
      window.localStorage.setItem(ENTERPRISE_ACCESS_POLICIES_STORAGE_KEY, JSON.stringify(enterpriseAccessPolicies));
    } catch {
      // no-op when storage is unavailable
    }
  }, [enterpriseAccessPolicies]);

  useEffect(() => {
    try {
      window.localStorage.setItem(TEMPLATE_BLUEPRINTS_STORAGE_KEY, JSON.stringify(templateBlueprints));
    } catch {
      // no-op when storage is unavailable
    }
  }, [templateBlueprints]);

  useEffect(() => {
    try {
      window.localStorage.setItem(TEMPLATE_LISTINGS_STORAGE_KEY, JSON.stringify(templateListings));
    } catch {
      // no-op when storage is unavailable
    }
  }, [templateListings]);

  useEffect(() => {
    try {
      window.localStorage.setItem(LICENCE_GRANTS_STORAGE_KEY, JSON.stringify(licenceGrants));
    } catch {
      // no-op when storage is unavailable
    }
  }, [licenceGrants]);

  useEffect(() => {
    try {
      window.localStorage.setItem(AUDIT_RUNS_STORAGE_KEY, JSON.stringify(auditRuns));
    } catch {
      // no-op when storage is unavailable
    }
  }, [auditRuns]);

  useEffect(() => {
    try {
      window.localStorage.setItem(AUDIT_FINDINGS_STORAGE_KEY, JSON.stringify(auditFindings));
    } catch {
      // no-op when storage is unavailable
    }
  }, [auditFindings]);

  useEffect(() => {
    try {
      window.localStorage.setItem(AUDIT_ACTIONS_STORAGE_KEY, JSON.stringify(auditActions));
    } catch {
      // no-op when storage is unavailable
    }
  }, [auditActions]);

  useEffect(() => {
    try {
      window.localStorage.setItem(REPORT_ARTIFACTS_STORAGE_KEY, JSON.stringify(reportArtifacts));
    } catch {
      // no-op when storage is unavailable
    }
  }, [reportArtifacts]);

  useEffect(() => {
    try {
      window.localStorage.setItem(SHARE_LINKS_STORAGE_KEY, JSON.stringify(shareLinks));
    } catch {
      // no-op when storage is unavailable
    }
  }, [shareLinks]);

  useEffect(() => {
    try {
      window.localStorage.setItem(MARKETPLACE_BID_BOARD_STORAGE_KEY, JSON.stringify(marketplaceBidBoard));
    } catch {
      // no-op when storage is unavailable
    }
  }, [marketplaceBidBoard]);

  useEffect(() => {
    try {
      window.localStorage.setItem(DISPATCH_SLA_EVENTS_STORAGE_KEY, JSON.stringify(dispatchSlaEvents));
    } catch {
      // no-op when storage is unavailable
    }
  }, [dispatchSlaEvents]);

  useEffect(() => {
    try {
      window.localStorage.setItem(EVIDENCE_AI_JOBS_STORAGE_KEY, JSON.stringify(evidenceAiJobs));
    } catch {
      // no-op when storage is unavailable
    }
  }, [evidenceAiJobs]);

  useEffect(() => {
    try {
      window.localStorage.setItem(
        REGULATOR_VERIFICATION_REQUESTS_STORAGE_KEY,
        JSON.stringify(regulatorVerificationRequests)
      );
    } catch {
      // no-op when storage is unavailable
    }
  }, [regulatorVerificationRequests]);

  useEffect(() => {
    try {
      window.localStorage.setItem(ANALYTICS_RISK_SIGNALS_STORAGE_KEY, JSON.stringify(analyticsRiskSignals));
    } catch {
      // no-op when storage is unavailable
    }
  }, [analyticsRiskSignals]);

  useEffect(() => {
    try {
      window.localStorage.setItem(WEBHOOK_DELIVERY_EVENTS_STORAGE_KEY, JSON.stringify(webhookDeliveryEvents));
    } catch {
      // no-op when storage is unavailable
    }
  }, [webhookDeliveryEvents]);

  useEffect(() => {
    try {
      window.localStorage.setItem(MOBILE_AUDIT_SESSIONS_STORAGE_KEY, JSON.stringify(mobileAuditSessions));
    } catch {
      // no-op when storage is unavailable
    }
  }, [mobileAuditSessions]);

  useEffect(() => {
    try {
      window.localStorage.setItem(ENTERPRISE_SECURITY_EVENTS_STORAGE_KEY, JSON.stringify(enterpriseSecurityEvents));
    } catch {
      // no-op when storage is unavailable
    }
  }, [enterpriseSecurityEvents]);

  useEffect(() => {
    try {
      window.localStorage.setItem(QA_HARNESS_RUNS_STORAGE_KEY, JSON.stringify(qaHarnessRuns));
    } catch {
      // no-op when storage is unavailable
    }
  }, [qaHarnessRuns]);

  useEffect(() => {
    try {
      window.localStorage.setItem(RELEASE_GATE_RESULTS_STORAGE_KEY, JSON.stringify(releaseGateResults));
    } catch {
      // no-op when storage is unavailable
    }
  }, [releaseGateResults]);

  useEffect(() => {
    try {
      window.localStorage.setItem(TENANT_INVITES_STORAGE_KEY, JSON.stringify(tenantInvites));
    } catch {
      // no-op when storage is unavailable
    }
  }, [tenantInvites]);

  useEffect(() => {
    try {
      window.localStorage.setItem(EVIDENCE_PROVENANCE_EVENTS_STORAGE_KEY, JSON.stringify(evidenceProvenanceEvents));
    } catch {
      // no-op when storage is unavailable
    }
  }, [evidenceProvenanceEvents]);

  useEffect(() => {
    try {
      window.localStorage.setItem(AUTH_RUNTIME_MODE_STORAGE_KEY, authRuntimeMode);
    } catch {
      // no-op when storage is unavailable
    }
  }, [authRuntimeMode]);

  useEffect(() => {
    try {
      window.localStorage.setItem(AUTH_SESSION_STORAGE_KEY, JSON.stringify(authSession));
    } catch {
      // no-op when storage is unavailable
    }
  }, [authSession]);

  useEffect(() => {
    try {
      window.localStorage.setItem(DEBUG_ROLE_STORAGE_KEY, effectiveUserRole);
    } catch {
      // no-op when storage is unavailable
    }
  }, [effectiveUserRole]);

  useEffect(() => {
    if (typeof window === 'undefined') {
      return;
    }
    const hasStoredDebugRole = Boolean(window.localStorage.getItem(DEBUG_ROLE_STORAGE_KEY));
    if (hasStoredDebugRole) {
      return;
    }
    setDebugRole(normalizeUserRole(authSession.accountType));
  }, [authSession.accountType]);

  useEffect(() => {
    if (allowedTabsForRole.includes(activeTab)) {
      return;
    }
    setActiveTab(primaryRoleTab);
    setSearchQuery('');
  }, [activeTab, allowedTabsForRole, primaryRoleTab]);

  useEffect(() => {
    if (typeof window === 'undefined') {
      return;
    }

    const onOnline = () => setIsOnline(true);
    const onOffline = () => setIsOnline(false);

    setIsOnline(window.navigator.onLine);
    window.addEventListener('online', onOnline);
    window.addEventListener('offline', onOffline);
    return () => {
      window.removeEventListener('online', onOnline);
      window.removeEventListener('offline', onOffline);
    };
  }, []);

  useEffect(() => {
    if (!isOnline || queuedInspectionCount === 0) {
      return;
    }

    const syncedAt = new Date().toISOString();
    setInspectionLogs((previousLogs) =>
      previousLogs.map((entry) =>
        entry.syncStatus === 'queued'
          ? {
              ...entry,
              syncStatus: 'synced',
              syncedAt,
            }
          : entry
      )
    );

    addToast(
      `${queuedInspectionCount} offline inspection ${queuedInspectionCount === 1 ? 'log' : 'logs'} synced`,
      'success'
    );
  }, [isOnline, queuedInspectionCount]);

  useEffect(() => {
    const onEscape = (event) => {
      if (event.key !== 'Escape') {
        return;
      }

      setShowNotifications(false);
      setShowAddAssetModal(false);
      setShowRequestModal(false);
      setShowProgrammeModal(false);
      setSelectedAssetForDetails(null);
      setShowCommandPalette(false);
      setShowMobileQuickPanel(false);
      setShowScanModal(false);
      setAssetForQrLabel(null);
    };

    window.addEventListener('keydown', onEscape);
    return () => window.removeEventListener('keydown', onEscape);
  }, []);

  useEffect(() => {
    const onShortcut = (event) => {
      const isCommandPaletteShortcut = (event.metaKey || event.ctrlKey) && event.key.toLowerCase() === 'k';
      if (!isCommandPaletteShortcut) {
        return;
      }

      event.preventDefault();
      setShowCommandPalette(true);
    };

    window.addEventListener('keydown', onShortcut);
    return () => window.removeEventListener('keydown', onShortcut);
  }, []);

  useEffect(() => {
    if (typeof window === 'undefined') {
      return;
    }

    const resolveFromHash = () => {
      const hashValue = window.location.hash || '';
      if (!hashValue || handledHashRef.current === hashValue) {
        return;
      }

      const parsed = parseInCertScanValue(hashValue);
      if (!parsed) {
        return;
      }

      if (parsed.type === 'asset') {
        const targetAsset = enrichedAssets.find((asset) => asset.id.toUpperCase() === parsed.id);
        if (!targetAsset) {
          return;
        }
        handledHashRef.current = hashValue;
        setActiveTab('assets');
        setSearchQuery('');
        setSelectedAssetForDetails(targetAsset);
        return;
      }

      if (parsed.type === 'certificate') {
        const targetCertificate = enrichedCertificates.find(
          (certificate) => certificate.id.toUpperCase() === parsed.id
        );
        if (!targetCertificate) {
          return;
        }
        handledHashRef.current = hashValue;
        setActiveTab('vault');
        setSearchQuery('');
        setVaultFocusCertificateId(targetCertificate.id);
      }
    };

    resolveFromHash();
    window.addEventListener('hashchange', resolveFromHash);
    return () => window.removeEventListener('hashchange', resolveFromHash);
  }, [enrichedAssets, enrichedCertificates]);

  const toggleTheme = () => setIsDarkMode((previous) => !previous);

  // Toast System
  const addToast = (message, type = 'success') => {
    const id = Date.now();
    setToasts((previous) => [...previous, { id, message, type }]);
    setTimeout(() => {
      setToasts((previous) => previous.filter((toast) => toast.id !== id));
    }, 4000);
  };

  const setRuntimeAuthMode = (mode) => {
    const normalized = String(mode || '').toLowerCase() === 'supabase' ? 'supabase' : 'mock';
    const currentEmail = String(authSession?.email || '').trim().toLowerCase();
    const isDebugUser = currentEmail === 'debug@incert.local';

    if (normalized === 'mock' && authSession?.isAuthenticated && !isDebugUser) {
      addToast('Mock mode is restricted to Debug: Enter App.', 'info');
      if (SUPABASE_ENV_CONFIGURED) {
        setAuthRuntimeMode('supabase');
      }
      return false;
    }

    if (normalized === 'supabase' && !SUPABASE_ENV_CONFIGURED) {
      addToast('Supabase env vars are not configured yet. Staying in mock auth mode.', 'info');
      setAuthRuntimeMode('mock');
      return false;
    }
    setAuthRuntimeMode(normalized);
    addToast(
      normalized === 'supabase'
        ? 'Auth runtime switched to Supabase mode'
        : 'Auth runtime switched to mock mode',
      'info'
    );
    return true;
  };

  const authenticateUser = async ({ mode = 'signin', email = '', password = '', fullName = '', accountType = 'company' }) => {
    const normalizedEmail = String(email || '').trim().toLowerCase();
    if (!normalizedEmail) {
      addToast('Enter a valid email address', 'info');
      return false;
    }
    const isDebugBypass = import.meta.env.DEV && normalizedEmail === 'debug@incert.local';
    if (isDebugBypass) {
      if (supabase) {
        try {
          await supabase.auth.signOut();
        } catch (error) {
          console.warn('Debug bypass sign-out warning', error);
        }
      }
      setAuthRuntimeMode('mock');
      setSupabaseSession(null);
      resetWorkspaceToMockData();
      const normalizedRole = normalizeUserRole(accountType);
      setAuthSession({
        isAuthenticated: true,
        email: normalizedEmail,
        fullName: String(fullName || 'Debug User').trim(),
        accountType: normalizedRole,
        signedInAt: new Date().toISOString(),
      });
      setDebugRole(normalizedRole);
      setActiveTab((USER_ROLE_TAB_ACCESS[normalizedRole] || USER_ROLE_TAB_ACCESS.company)[0] || 'dashboard');
      addToast('Debug session started (mock data mode)', 'info');
      return true;
    }
    if (SUPABASE_ENV_CONFIGURED && supabase) {
      if (authRuntimeMode !== 'supabase') {
        setAuthRuntimeMode('supabase');
      }
      const trimmedPassword = String(password || '').trim();
      if (!trimmedPassword) {
        addToast('Enter your password to sign in with Supabase.', 'info');
        return false;
      }

      if (mode === 'signup') {
        const { data, error } = await supabase.auth.signUp({
          email: normalizedEmail,
          password: trimmedPassword,
          options: {
            data: {
              full_name: String(fullName || '').trim(),
              account_type: normalizeUserRole(accountType),
            },
          },
        });

        if (error) {
          addToast(`Supabase sign-up failed: ${error.message}`, 'info');
          return false;
        }

        if (data.session) {
          setSupabaseSession(data.session);
          addToast('Account created and signed in to InCert.', 'success');
          return true;
        }

        addToast('Check your email to confirm your account, then sign in.', 'info');
        return true;
      }

      const { data, error } = await supabase.auth.signInWithPassword({
        email: normalizedEmail,
        password: trimmedPassword,
      });
      if (error) {
        addToast(`Supabase sign-in failed: ${error.message}`, 'info');
        return false;
      }

      setSupabaseSession(data.session ?? null);
      addToast('Signed in to InCert', 'success');
      return true;
    }
    const normalizedRole = normalizeUserRole(accountType);

    setAuthSession({
      isAuthenticated: true,
      email: normalizedEmail,
      fullName: String(fullName || '').trim(),
      accountType: normalizedRole,
      signedInAt: new Date().toISOString(),
    });
    setDebugRole(normalizedRole);
    setActiveTab((USER_ROLE_TAB_ACCESS[normalizedRole] || USER_ROLE_TAB_ACCESS.company)[0] || 'dashboard');
    addToast(mode === 'signup' ? 'Account created. Welcome to InCert.' : 'Signed in to InCert', 'success');
    return true;
  };

  const openTab = (tab) => {
    const targetTab = allowedTabsForRole.includes(tab) ? tab : primaryRoleTab;
    setActiveTab(targetTab);
    setSearchQuery('');
    setShowNotifications(false);
    setShowCommandPalette(false);
    setShowMobileQuickPanel(false);
    setShowScanModal(false);
    setShowRequestModal(false);
    setShowProgrammeModal(false);
  };

  const switchDebugRole = (role) => {
    const normalizedRole = normalizeUserRole(role, effectiveUserRole);
    setDebugRole(normalizedRole);
    setAuthSession((previousSession) => ({
      ...previousSession,
      accountType: normalizedRole,
    }));
    const nextTab = (USER_ROLE_TAB_ACCESS[normalizedRole] || USER_ROLE_TAB_ACCESS.company)[0] || 'help';
    setActiveTab(nextTab);
    setSearchQuery('');
    setShowNotifications(false);
    setShowCommandPalette(false);
    setShowMobileQuickPanel(false);
    setShowScanModal(false);
    setShowRequestModal(false);
    setShowProgrammeModal(false);
    addToast(`Debug role switched to ${USER_ROLE_OPTIONS.find((option) => option.id === normalizedRole)?.label || 'Company'}`, 'info');
  };

  const signOutUser = async () => {
    const shouldSignOutSupabase =
      Boolean(supabase) &&
      !isDebugBypassSession &&
      (isSupabaseRuntime || Boolean(supabaseSession?.user?.id));
    if (shouldSignOutSupabase) {
      const { error } = await supabase.auth.signOut();
      if (error) {
        addToast(`Supabase sign-out warning: ${error.message}`, 'info');
      }
      setSupabaseSession(null);
    }
    setAuthSession(defaultAuthSession);
    setDebugRole(normalizeUserRole(defaultAuthSession.accountType));
    setActiveTab('dashboard');
    setSearchQuery('');
    setShowNotifications(false);
    setShowCommandPalette(false);
    setShowMobileQuickPanel(false);
    setShowScanModal(false);
    setShowAddAssetModal(false);
    setShowRequestModal(false);
    setShowProgrammeModal(false);
    setSelectedAssetForDetails(null);
    setAssetForQrLabel(null);
    setVaultFocusCertificateId('');
    addToast('Signed out', 'info');
  };

  const exportAuditPack = () => {
    downloadAuditPackPdf({
      assets: enrichedAssets,
      certificates: enrichedCertificates,
    });
    addToast('Audit pack PDF downloaded', 'success');
  };

  const openAssetRecordById = (assetId, showFeedback = true) => {
    const targetAsset = enrichedAssets.find((asset) => asset.id.toUpperCase() === String(assetId || '').toUpperCase());
    if (!targetAsset) {
      if (showFeedback) {
        addToast(`Asset ${assetId} not found`, 'info');
      }
      return false;
    }

    openTab('assets');
    setAssetForQrLabel(null);
    setSelectedAssetForDetails(targetAsset);
    if (typeof window !== 'undefined') {
      const hashValue = `asset=${encodeURIComponent(targetAsset.id)}`;
      handledHashRef.current = `#${hashValue}`;
      window.location.hash = hashValue;
    }
    if (showFeedback) {
      addToast(`Opened ${targetAsset.id} record`, 'success');
    }
    return true;
  };

  const openCertificateRecordById = (certificateId, showFeedback = true) => {
    const targetCertificate = enrichedCertificates.find(
      (certificate) => certificate.id.toUpperCase() === String(certificateId || '').toUpperCase()
    );
    if (!targetCertificate) {
      if (showFeedback) {
        addToast(`Certificate ${certificateId} not found`, 'info');
      }
      return false;
    }

    openTab('vault');
    setSelectedAssetForDetails(null);
    setAssetForQrLabel(null);
    setVaultFocusCertificateId(targetCertificate.id);
    if (typeof window !== 'undefined') {
      const hashValue = `certificate=${encodeURIComponent(targetCertificate.id)}`;
      handledHashRef.current = `#${hashValue}`;
      window.location.hash = hashValue;
    }
    if (showFeedback) {
      addToast(`Opened ${targetCertificate.id}`, 'success');
    }
    return true;
  };

  const handleScanLookup = (scanValue) => {
    const parsed = parseInCertScanValue(scanValue);
    if (!parsed) {
      addToast('Unable to parse code. Use AST-xxx, CERT-xxxx, or a InCert link.', 'info');
      return false;
    }

    if (parsed.type === 'asset') {
      const didOpenAsset = openAssetRecordById(parsed.id);
      if (didOpenAsset) {
        setShowScanModal(false);
      }
      return didOpenAsset;
    }

    const didOpenCertificate = openCertificateRecordById(parsed.id);
    if (didOpenCertificate) {
      setShowScanModal(false);
    }
    return didOpenCertificate;
  };

  // Handlers for interactions
  const handleAddAsset = (newAsset) => {
    setAssets((previousAssets) => [
      ...previousAssets,
      {
        ...newAsset,
        id: getNextAssetId(previousAssets),
      },
    ]);
    setShowAddAssetModal(false);
    addToast('Asset successfully added to register', 'success');
  };

  const handleRequestInspection = (payload) => {
    if (!payload || !payload.assetId) {
      addToast('Unable to create booking request. Please review scope details.', 'info');
      return false;
    }

    const createdJobId = createMarketplaceJob({
      assetId: payload.assetId,
      dueDate: payload.dueDate,
      notes: payload.notes,
      scope: payload.scope,
      pricing: payload.pricing,
      dispatchSlaMins: payload.dispatchSlaMins,
    });

    if (!createdJobId) {
      return false;
    }

    if (payload.preferredAuditorId) {
      dispatchMarketplaceJob(createdJobId, payload.preferredAuditorId, 'Preferred provider booking');
    }

    setShowRequestModal(false);
    setSelectedProviderForRequest('');
    openTab('marketplace');
    return true;
  };

  const handleLogInspection = ({ assetId, performedAt, notes }) => {
    const targetAsset = enrichedAssets.find((asset) => asset.id === assetId);
    if (!targetAsset) {
      addToast('Unable to log inspection: asset not found', 'info');
      return false;
    }

    const createdAt = new Date().toISOString();
    const entry = {
      id: `INSP-${Date.now()}`,
      assetId: targetAsset.id,
      assetName: targetAsset.name,
      performedAt: performedAt || getLocalDateTimeInputValue(),
      notes: String(notes || '').trim() || 'No inspection notes provided.',
      createdAt,
      syncStatus: isOnline ? 'synced' : 'queued',
      syncedAt: isOnline ? createdAt : null,
    };

    setInspectionLogs((previousLogs) => [entry, ...previousLogs].slice(0, 250));
    if (isOnline) {
      addToast('Inspection log saved and synced', 'success');
    } else {
      addToast('Offline mode: inspection saved and queued for sync', 'info');
    }
    return true;
  };

  const openDispatch = (providerName = '') => {
    const matchedProvider = auditors.find(
      (auditor) => auditor.id === providerName || auditor.name === providerName
    );
    setSelectedProviderForRequest(matchedProvider?.id || '');
    setShowRequestModal(true);
  };

  const handleCreateRecurringProgramme = (programmePayload) => {
    const name = String(programmePayload?.name || '').trim();
    if (!name) {
      addToast('Programme name is required', 'info');
      return false;
    }

    const createdAt = new Date().toISOString();
    const programme = {
      id: `PRG-${Date.now()}`,
      name,
      cadence: programmePayload.cadence || 'quarterly',
      leadDays: Math.max(7, Number(programmePayload.leadDays || 30)),
      preferredAuditorId: programmePayload.preferredAuditorId || '',
      budgetCap: roundMoney(programmePayload.budgetCap || 0),
      startDate: programmePayload.startDate || new Date().toISOString().slice(0, 10),
      approvalChain: String(programmePayload.approvalChain || '').trim() || 'Site Manager > Finance',
      createdAt,
    };

    setRecurringProgrammes((previousProgrammes) => [programme, ...previousProgrammes].slice(0, 50));
    setShowProgrammeModal(false);
    addToast(`Recurring programme created: ${programme.name}`, 'success');
    return true;
  };

  const createMarketplaceJob = ({ assetId, dueDate, notes, scope, pricing, dispatchSlaMins }) => {
    const linkedAsset = enrichedAssets.find((asset) => asset.id === assetId);
    if (!linkedAsset) {
      addToast('Unable to create job: asset not found', 'info');
      return '';
    }
    const companyName = activeCompanyContext.name;
    const companyId = activeCompanyContext.id;
    const assignedInspectionTemplate = pickBestInspectionTemplateForRegime(inspectionTemplates, linkedAsset.regime, {
      companyId,
      companyName,
    });

    const createdAt = new Date();
    const createdAtIsoDate = createdAt.toISOString().slice(0, 10);
    const nextJobId = getNextMarketplaceJobId(marketplaceJobs);
    const normalizedScope = normalizeMarketplaceScope({
      ...scope,
      estimatedHours:
        Number(scope?.estimatedHours) ||
        estimateScopeHours(scope?.template, scope?.assetCount, Boolean(scope?.weekendAccess)),
    });
    const quote = normalizeMarketplacePricing(
      pricing && typeof pricing === 'object'
        ? pricing
        : calculateMarketplaceQuote({
            scope: normalizedScope,
            regime: linkedAsset.regime,
            site: linkedAsset.site,
          }),
      {
        scope: normalizedScope,
        regime: linkedAsset.regime,
        site: linkedAsset.site,
        jobId: nextJobId,
      }
    );
    const quoteSnapshot = {
      ...quote,
      quoteVersion: 1,
      quoteId: buildMarketplaceQuoteId(nextJobId, 1),
      mappingEstimateTimestamp: createdAt.toISOString(),
      validUntil: new Date(createdAt.getTime() + 24 * 60 * 60 * 1000).toISOString(),
    };
    const slaMinutes = Math.max(60, Number(dispatchSlaMins || resolveDispatchSlaMinutes(normalizedScope)));
    const dispatchDeadlineAt = new Date(createdAt.getTime() + slaMinutes * 60000).toISOString();
    const timelineAt = getTimelineStamp(createdAt);

    setMarketplaceJobs((previousJobs) => [
      {
        id: nextJobId,
        companyName,
        companyId,
        assetId: linkedAsset.id,
        assetName: linkedAsset.name,
        site: linkedAsset.site,
        regime: linkedAsset.regime,
        inspectionTemplateId: String(assignedInspectionTemplate?.id || '').trim(),
        inspectionTemplateName: String(assignedInspectionTemplate?.name || '').trim(),
        status: 'open',
        dueDate,
        budget: quoteSnapshot.total,
        createdAt: createdAtIsoDate,
        matchedAuditorId: null,
        auditExecutionMode: AUDIT_EXECUTION_MODES.INCERT_TEMPLATE,
        externalAuditReviewStatus: EXTERNAL_AUDIT_REVIEW_STATUSES.NOT_REQUIRED,
        externalSoftwareWithholdPct: 0,
        auditMethodLocked: false,
        notes: notes || 'No additional site notes provided.',
        scope: normalizedScope,
        pricing: quoteSnapshot,
        pricingHistory: [quoteSnapshot],
        pricingAdjustments: [],
        pricingLock: null,
        settlement: null,
        dispatch: {
          slaMinutes,
          dispatchDeadlineAt,
          dispatchedAt: null,
          offerExpiresAt: null,
          acceptedAt: null,
          attempts: 0,
        },
        documents: [],
        timeline: [
          { label: 'Job advertised', at: timelineAt, actor: companyName },
          {
            label: `Instant quote v1 generated (${formatCurrencyGBP(quoteSnapshot.total)} inc VAT)`,
            at: timelineAt,
            actor: 'InCert Pricing Engine',
          },
          ...(assignedInspectionTemplate
            ? [
                {
                  label: `Template selected: ${assignedInspectionTemplate.name}`,
                  at: timelineAt,
                  actor: 'Template Engine',
                },
              ]
            : []),
        ],
      },
      ...previousJobs,
    ]);
    addToast(`Audit job advertised with quote ${formatCurrencyGBP(quoteSnapshot.total)} inc VAT`, 'success');
    return nextJobId;
  };

  const buildAuditorBoundQuote = (job, auditor, lockTimestamp = new Date()) => {
    const scope = getMarketplaceJobScope(job);
    const currentPricing = getMarketplaceJobPricing(job);
    const repricedCandidate = normalizeMarketplacePricing(
      calculateMarketplaceQuote({
        scope,
        regime: job.regime,
        site: job.site,
        auditor,
      }),
      {
        scope,
        regime: job.regime,
        site: job.site,
        jobId: job.id,
      }
    );
    const requiresReprice =
      roundMoney(repricedCandidate.providerPayoutExVat) !== roundMoney(currentPricing.providerPayoutExVat) ||
      roundMoney(repricedCandidate.platformFeeExVat) !== roundMoney(currentPricing.platformFeeExVat) ||
      roundMoney(repricedCandidate.total) !== roundMoney(currentPricing.total) ||
      repricedCandidate.pricingModelVersion !== currentPricing.pricingModelVersion;

    if (!requiresReprice) {
      return {
        quote: currentPricing,
        history: getMarketplaceJobPricingHistory(job, currentPricing),
        repriced: false,
      };
    }

    const nextVersion = Math.max(1, Number(currentPricing.quoteVersion || 1)) + 1;
    const nextQuote = {
      ...repricedCandidate,
      quoteVersion: nextVersion,
      quoteId: buildMarketplaceQuoteId(job.id, nextVersion),
      mappingEstimateTimestamp: lockTimestamp.toISOString(),
      validUntil: new Date(lockTimestamp.getTime() + 24 * 60 * 60 * 1000).toISOString(),
    };

    return {
      quote: nextQuote,
      history: [...getMarketplaceJobPricingHistory(job, currentPricing), nextQuote],
      repriced: true,
    };
  };

  const dispatchMarketplaceJob = (jobId, auditorId, source = 'InCert Match Engine') => {
    const targetAuditor = auditors.find((auditor) => auditor.id === auditorId);
    if (!targetAuditor) {
      addToast('Auditor not found for dispatch', 'info');
      return;
    }

    const now = new Date();
    const timelineAt = getTimelineStamp(now);
    let dispatchState = 'none';
    let blockedReason = '';

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) => {
        if (job.id !== jobId) {
          return job;
        }

        if (['assigned', 'in_progress', 'awaiting_review', 'completed'].includes(job.status)) {
          blockedReason = 'Job is already confirmed with an auditor';
          return job;
        }

        if (job.status === 'offered' && !isOfferExpired(job, now.getTime()) && job.matchedAuditorId !== auditorId) {
          blockedReason = 'An active offer already exists for this job';
          return job;
        }

        const scope = getMarketplaceJobScope(job);
        const dispatch = getMarketplaceJobDispatch(job);
        const offerTtlMinutes = resolveOfferTtlMinutes(scope);
        const offerExpiresAt = new Date(now.getTime() + offerTtlMinutes * 60000).toISOString();
        const hasExpiredOffer = job.status === 'offered' && isOfferExpired(job, now.getTime());
        dispatchState = hasExpiredOffer ? 'reoffered' : 'offered';

        return {
          ...job,
          status: 'offered',
          matchedAuditorId: auditorId,
          dispatch: {
            ...dispatch,
            dispatchedAt: now.toISOString(),
            offerExpiresAt,
            attempts: dispatch.attempts + 1,
          },
          timeline: [
            ...job.timeline,
            ...(hasExpiredOffer
              ? [
                  {
                    label: 'Previous offer expired; dispatch re-opened',
                    at: timelineAt,
                    actor: 'InCert Dispatch Engine',
                  },
                ]
              : []),
            {
              label: `Offer sent to ${targetAuditor.name} (expires ${formatDateTimeLabel(offerExpiresAt)})`,
              at: timelineAt,
              actor: source,
            },
          ],
        };
      })
    );

    if (dispatchState === 'none') {
      addToast(blockedReason || 'Unable to dispatch this job right now', 'info');
      return;
    }

    addToast(
      dispatchState === 'reoffered'
        ? `Offer re-routed to ${targetAuditor.name}`
        : `Offer sent to ${targetAuditor.name}`,
      'success'
    );
  };

  const reassignMarketplaceJob = (
    jobId,
    fromAuditorId,
    toAuditorId,
    source = 'Audit Company Control Desk'
  ) => {
    if (!jobId || !toAuditorId) {
      addToast('Job and target auditor are required for reassignment', 'info');
      return false;
    }

    if (fromAuditorId === toAuditorId) {
      addToast('Select a different auditor for reassignment', 'info');
      return false;
    }

    const targetAuditor = auditors.find((auditor) => auditor.id === toAuditorId);
    const previousAuditor = auditors.find((auditor) => auditor.id === fromAuditorId);
    if (!targetAuditor) {
      addToast('Target auditor not found', 'info');
      return false;
    }

    const now = new Date();
    const nowIso = now.toISOString();
    const timelineAt = getTimelineStamp(now);
    let reassignmentStatus = 'none';
    let blockingReason = '';
    let touchedJobStatus = '';

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) => {
        if (job.id !== jobId) {
          return job;
        }

        if (!['offered', 'assigned', 'in_progress', 'awaiting_review'].includes(job.status)) {
          blockingReason = 'Only active jobs can be reassigned';
          return job;
        }

        if (job.matchedAuditorId !== fromAuditorId) {
          blockingReason = 'Job is no longer assigned to the selected auditor';
          return job;
        }

        touchedJobStatus = job.status;
        reassignmentStatus = 'success';
        const dispatch = getMarketplaceJobDispatch(job);
        const scope = getMarketplaceJobScope(job);
        const offerExpiresAt =
          job.status === 'offered'
            ? new Date(now.getTime() + resolveOfferTtlMinutes(scope) * 60000).toISOString()
            : dispatch.offerExpiresAt;

        return {
          ...job,
          matchedAuditorId: toAuditorId,
          dispatch: {
            ...dispatch,
            dispatchedAt: nowIso,
            offerExpiresAt,
            attempts: dispatch.attempts + 1,
          },
          timeline: [
            ...job.timeline,
            {
              label: `Reassigned from ${previousAuditor?.name || 'previous auditor'} to ${targetAuditor.name}`,
              at: timelineAt,
              actor: source,
            },
          ],
        };
      })
    );

    if (reassignmentStatus !== 'success') {
      addToast(blockingReason || 'Unable to reassign this job', 'info');
      return false;
    }

    setDispatchSlaEvents((previousEvents) => [
      {
        id: getNextEntityId(previousEvents, 'SLA'),
        requestId: jobId,
        eventType: 'audit_company_reassignment',
        eventAt: nowIso,
        minutesFromOpen: 0,
        isBreach: false,
      },
      ...previousEvents,
    ]);

    if (['assigned', 'in_progress', 'awaiting_review'].includes(touchedJobStatus)) {
      setAuditors((previousAuditors) =>
        previousAuditors.map((auditor) => {
          if (auditor.id === fromAuditorId) {
            return { ...auditor, activeJobs: Math.max(0, Number(auditor.activeJobs || 0) - 1) };
          }
          if (auditor.id === toAuditorId) {
            return { ...auditor, activeJobs: Number(auditor.activeJobs || 0) + 1 };
          }
          return auditor;
        })
      );
    }

    addToast(`Job ${jobId} reassigned to ${targetAuditor.name}`, 'success');
    return true;
  };

  const acceptMarketplaceOffer = (
    jobId,
    auditorId,
    source = 'Auditor Console',
    executionMode = AUDIT_EXECUTION_MODES.INCERT_TEMPLATE
  ) => {
    const targetAuditor = auditors.find((auditor) => auditor.id === auditorId);
    if (!targetAuditor) {
      addToast('Auditor not found', 'info');
      return false;
    }

    const now = new Date();
    const timelineAt = getTimelineStamp(now);
    const selectedExecutionMode = normalizeAuditExecutionMode(executionMode);
    const externalSoftwareWithholdPct =
      selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
        ? PRICING_ENGINE_CONFIG.externalSoftwareWithholdPct
        : 0;
    const externalAuditReviewStatus =
      selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
        ? EXTERNAL_AUDIT_REVIEW_STATUSES.PENDING_EVIDENCE
        : EXTERNAL_AUDIT_REVIEW_STATUSES.NOT_REQUIRED;
    let acceptanceState = 'none';

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) => {
        if (job.id !== jobId) {
          return job;
        }

        if (['in_progress', 'awaiting_review', 'completed'].includes(job.status)) {
          return job;
        }

        const dispatch = getMarketplaceJobDispatch(job);

        if (job.status === 'offered') {
          if (job.matchedAuditorId !== auditorId) {
            return job;
          }

          if (isOfferExpired(job, now.getTime())) {
            acceptanceState = 'expired';
            return {
              ...job,
              status: 'open',
              matchedAuditorId: null,
              dispatch: {
                ...dispatch,
                offerExpiresAt: null,
              },
              timeline: [
                ...job.timeline,
                {
                  label: 'Offer expired before acceptance',
                  at: timelineAt,
                  actor: 'InCert Dispatch Engine',
                },
              ],
            };
          }

          acceptanceState = 'accepted';
          const { quote: pricing, history: pricingHistory, repriced } = buildAuditorBoundQuote(job, targetAuditor, now);
          const pricingLock = getMarketplaceJobPricingLock(job, pricing) ||
            buildMarketplacePricingLock({
              jobId: job.id,
              quote: pricing,
              lockedAt: now.toISOString(),
              lockedBy: targetAuditor.name,
            });
          return {
            ...job,
            status: 'assigned',
            auditExecutionMode: selectedExecutionMode,
            externalAuditReviewStatus,
            externalSoftwareWithholdPct,
            auditMethodLocked: true,
            pricing,
            pricingHistory,
            budget: pricing.total,
            pricingLock,
            settlement: buildMarketplaceSettlement(pricing, {
              payoutStatus: 'pending_completion',
              completedAt: now.toISOString(),
              externalSoftwareWithholdPct,
            }),
            dispatch: {
              ...dispatch,
              acceptedAt: now.toISOString(),
              offerExpiresAt: null,
            },
            timeline: [
              ...job.timeline,
              {
                label: 'Auditor accepted offer',
                at: timelineAt,
                actor: targetAuditor.name,
              },
              {
                label:
                  selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
                    ? 'Audit method selected: auditor software'
                    : 'Audit method selected: InCert template',
                at: timelineAt,
                actor: targetAuditor.name,
              },
              ...(repriced
                ? [
                    {
                      label: `Payout profile applied (${formatCurrencyGBP(pricing.providerPayoutExVat)} ex VAT @ Â£${Number(
                        pricing.auditorHourlyRate || 0
                      ).toFixed(2)}/h)`,
                      at: timelineAt,
                      actor: 'InCert Pricing Engine',
                    },
                  ]
                : []),
              {
                label: `Quote locked (${pricingLock?.quoteId || pricing.quoteId})`,
                at: timelineAt,
                actor: 'InCert Pricing Engine',
              },
            ],
          };
        }

        if (job.status === 'open') {
          acceptanceState = 'claimed';
          const { quote: pricing, history: pricingHistory, repriced } = buildAuditorBoundQuote(job, targetAuditor, now);
          const pricingLock = getMarketplaceJobPricingLock(job, pricing) ||
            buildMarketplacePricingLock({
              jobId: job.id,
              quote: pricing,
              lockedAt: now.toISOString(),
              lockedBy: source,
            });
          return {
            ...job,
            status: 'assigned',
            matchedAuditorId: auditorId,
            auditExecutionMode: selectedExecutionMode,
            externalAuditReviewStatus,
            externalSoftwareWithholdPct,
            auditMethodLocked: true,
            pricing,
            pricingHistory,
            budget: pricing.total,
            pricingLock,
            settlement: buildMarketplaceSettlement(pricing, {
              payoutStatus: 'pending_completion',
              completedAt: now.toISOString(),
              externalSoftwareWithholdPct,
            }),
            dispatch: {
              ...dispatch,
              dispatchedAt: dispatch.dispatchedAt || now.toISOString(),
              acceptedAt: now.toISOString(),
              attempts: Math.max(1, dispatch.attempts),
            },
            timeline: [
              ...job.timeline,
              {
                label: 'Auditor claimed open marketplace job',
                at: timelineAt,
                actor: source,
              },
              {
                label:
                  selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
                    ? 'Audit method selected: auditor software'
                    : 'Audit method selected: InCert template',
                at: timelineAt,
                actor: targetAuditor.name,
              },
              ...(repriced
                ? [
                    {
                      label: `Payout profile applied (${formatCurrencyGBP(pricing.providerPayoutExVat)} ex VAT @ Â£${Number(
                        pricing.auditorHourlyRate || 0
                      ).toFixed(2)}/h)`,
                      at: timelineAt,
                      actor: 'InCert Pricing Engine',
                    },
                  ]
                : []),
              {
                label: `Quote locked (${pricingLock?.quoteId || pricing.quoteId})`,
                at: timelineAt,
                actor: 'InCert Pricing Engine',
              },
            ],
          };
        }

        if (job.status === 'assigned' && job.matchedAuditorId === auditorId) {
          acceptanceState = 'already_assigned';
        }
        return job;
      })
    );

    if (acceptanceState === 'expired') {
      addToast('Offer expired before acceptance. Dispatch the job again.', 'info');
      return false;
    }

    if (!['accepted', 'claimed'].includes(acceptanceState)) {
      addToast('No eligible offer to accept for this job', 'info');
      return false;
    }

    setAuditors((previousAuditors) =>
      previousAuditors.map((auditor) =>
        auditor.id === auditorId
          ? {
              ...auditor,
              activeJobs: auditor.activeJobs + 1,
            }
          : auditor
      )
    );

    addToast(
      acceptanceState === 'claimed'
        ? `${targetAuditor.name} claimed this job`
        : `${targetAuditor.name} accepted the dispatch offer`,
      'success'
    );
    return true;
  };

  const startMarketplaceAudit = (
    jobId,
    auditorId,
    executionMode = AUDIT_EXECUTION_MODES.INCERT_TEMPLATE
  ) => {
    const targetJob = marketplaceJobs.find((job) => job.id === jobId);
    const canStartAssigned = targetJob?.status === 'assigned';
    const canBackfillMethodForInProgress = targetJob?.status === 'in_progress' && !targetJob?.auditMethodLocked;
    if (
      !targetJob ||
      targetJob.matchedAuditorId !== auditorId ||
      (!canStartAssigned && !canBackfillMethodForInProgress)
    ) {
      addToast('Only assigned jobs or legacy in-progress jobs can be started', 'info');
      return false;
    }

    const selectedExecutionMode = normalizeAuditExecutionMode(executionMode);
    const startedAt = new Date();
    const timelineAt = getTimelineStamp(startedAt);
    const externalSoftwareWithholdPct =
      selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
        ? PRICING_ENGINE_CONFIG.externalSoftwareWithholdPct
        : 0;
    let didStart = false;
    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) =>
        job.id === jobId &&
        job.matchedAuditorId === auditorId &&
        (job.status === 'assigned' || (job.status === 'in_progress' && !job.auditMethodLocked))
          ? {
              ...job,
              status: 'in_progress',
              auditExecutionMode: selectedExecutionMode,
              externalAuditReviewStatus:
                selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
                  ? EXTERNAL_AUDIT_REVIEW_STATUSES.PENDING_EVIDENCE
                  : EXTERNAL_AUDIT_REVIEW_STATUSES.NOT_REQUIRED,
              externalSoftwareWithholdPct,
              auditMethodLocked: true,
              settlement: buildMarketplaceSettlement(getMarketplaceJobPricing(job), {
                payoutStatus: 'pending_completion',
                completedAt: startedAt.toISOString(),
                externalSoftwareWithholdPct,
                scheduledPayoutDate: job?.settlement?.scheduledPayoutDate,
                holdbackReleaseDate: job?.settlement?.holdbackReleaseDate,
              }),
              timeline: [
                ...job.timeline,
                {
                  label: job.status === 'assigned'
                    ? selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
                      ? 'Audit started (auditor software selected)'
                      : 'Audit started (InCert template)'
                    : selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
                      ? 'Audit method selected (auditor software)'
                      : 'Audit method selected (InCert template)',
                  at: timelineAt,
                  actor: auditors.find((auditor) => auditor.id === auditorId)?.name || 'Auditor',
                },
              ],
            }
          : job
      )
    );
    didStart = true;
    addToast(
      selectedExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
        ? 'Audit started with auditor software. Upload evidence and submit for InCert review.'
        : canStartAssigned
          ? 'Audit marked in progress'
          : 'Audit method set to InCert template',
      'success'
    );
    return didStart;
  };

  const uploadMarketplaceDocuments = (jobId, files, auditorId) => {
    if (!files || files.length === 0) {
      return;
    }
    const targetJob = marketplaceJobs.find((job) => job.id === jobId);
    if (!targetJob || targetJob.matchedAuditorId !== auditorId || targetJob.status !== 'in_progress') {
      addToast('Documents can only be uploaded for in-progress jobs', 'info');
      return;
    }
    const timelineAt = getTimelineStamp(new Date());
    const fileNames = files.map((file) => file.name);

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) =>
        job.id === jobId && job.matchedAuditorId === auditorId && job.status === 'in_progress'
          ? {
              ...job,
              documents: [...job.documents, ...fileNames],
              timeline: [
                ...job.timeline,
                {
                  label: `${fileNames.length} file(s) uploaded`,
                  at: timelineAt,
                  actor: auditors.find((auditor) => auditor.id === auditorId)?.name || 'Auditor',
                },
              ],
            }
          : job
      )
    );
    setEvidenceProvenanceEvents((previousEvents) => {
      const nowIso = new Date().toISOString();
      const provenanceRows = [];
      fileNames.forEach((fileName) => {
        const computedId = getNextEntityId([...previousEvents, ...provenanceRows], 'PRV');
        provenanceRows.push({
          id: computedId,
          evidenceRef: `evidence://${jobId}/${fileName}`,
          eventType: 'file_uploaded',
          hash: createPseudoHash(`${jobId}:${fileName}:${nowIso}`),
          deviceMetadata: 'web:browser-upload',
          createdAt: nowIso,
        });
      });
      return [...provenanceRows, ...previousEvents];
    });
    addToast(`${fileNames.length} document(s) uploaded`, 'success');
  };

  const submitMarketplaceExternalAuditForReview = (jobId, auditorId) => {
    const targetJob = marketplaceJobs.find((job) => job.id === jobId);
    const targetAuditor = auditors.find((auditor) => auditor.id === auditorId);
    if (!targetJob || !targetAuditor) {
      addToast('Unable to submit audit for review', 'info');
      return false;
    }

    if (
      targetJob.matchedAuditorId !== auditorId ||
      targetJob.status !== 'in_progress' ||
      normalizeAuditExecutionMode(targetJob.auditExecutionMode) !== AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
    ) {
      addToast('Only in-progress external audits can be submitted for review', 'info');
      return false;
    }

    if (!Array.isArray(targetJob.documents) || targetJob.documents.length === 0) {
      addToast('Upload external audit evidence before submitting for review', 'info');
      return false;
    }

    const submittedAt = new Date();
    const timelineAt = getTimelineStamp(submittedAt);
    const externalSoftwareWithholdPct = resolveExternalSoftwareWithholdPct(targetJob);

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) =>
        job.id === jobId && job.matchedAuditorId === auditorId && job.status === 'in_progress'
          ? {
              ...job,
              status: 'awaiting_review',
              externalAuditReviewStatus: EXTERNAL_AUDIT_REVIEW_STATUSES.PENDING_REVIEW,
              settlement: buildMarketplaceSettlement(getMarketplaceJobPricing(job), {
                payoutStatus: 'pending_review',
                completedAt: submittedAt.toISOString(),
                externalSoftwareWithholdPct,
                scheduledPayoutDate: job?.settlement?.scheduledPayoutDate,
                holdbackReleaseDate: job?.settlement?.holdbackReleaseDate,
              }),
              timeline: [
                ...job.timeline,
                {
                  label: `External audit submitted for InCert review (${job.documents.length} evidence file(s))`,
                  at: timelineAt,
                  actor: targetAuditor.name,
                },
              ],
            }
          : job
      )
    );

    addToast('External audit submitted for InCert review', 'success');
    return true;
  };

  const reviewMarketplaceExternalAudit = (jobId, decision, reviewerName = 'InCert QA') => {
    const targetJob = marketplaceJobs.find((job) => job.id === jobId);
    if (!targetJob) {
      addToast('Job not found for review', 'info');
      return false;
    }

    const normalizedDecision = decision === 'reject' ? 'reject' : decision === 'approve' ? 'approve' : '';
    if (!normalizedDecision) {
      addToast('Invalid review decision', 'info');
      return false;
    }

    if (
      targetJob.status !== 'awaiting_review' ||
      normalizeAuditExecutionMode(targetJob.auditExecutionMode) !== AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
    ) {
      addToast('Only submitted external audits can be reviewed', 'info');
      return false;
    }

    const reviewDate = new Date();
    const reviewAt = getTimelineStamp(reviewDate);
    const externalSoftwareWithholdPct = resolveExternalSoftwareWithholdPct(targetJob);
    const targetAuditor = auditors.find((auditor) => auditor.id === targetJob.matchedAuditorId);
    const auditorName = targetAuditor?.name || 'Assigned auditor';

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) => {
        if (
          job.id !== jobId ||
          normalizeAuditExecutionMode(job.auditExecutionMode) !== AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
        ) {
          return job;
        }

        if (normalizedDecision === 'approve') {
          const settlement = buildMarketplaceSettlement(getMarketplaceJobPricing(job), {
            payoutStatus: 'scheduled',
            completedAt: reviewDate.toISOString(),
            externalSoftwareWithholdPct,
            scheduledPayoutDate: job?.settlement?.scheduledPayoutDate,
            holdbackReleaseDate: job?.settlement?.holdbackReleaseDate,
          });
          return {
            ...job,
            status: 'completed',
            externalAuditReviewStatus: EXTERNAL_AUDIT_REVIEW_STATUSES.APPROVED,
            settlement,
            timeline: [
              ...job.timeline,
              {
                label: 'InCert approved external audit evidence',
                at: reviewAt,
                actor: reviewerName,
              },
              {
                label: `Settlement scheduled for ${settlement.scheduledPayoutDate}`,
                at: reviewAt,
                actor: 'InCert Settlement Engine',
              },
            ],
          };
        }

        return {
          ...job,
          status: 'in_progress',
          externalAuditReviewStatus: EXTERNAL_AUDIT_REVIEW_STATUSES.REJECTED,
          settlement: buildMarketplaceSettlement(getMarketplaceJobPricing(job), {
            payoutStatus: 'pending_completion',
            completedAt: reviewDate.toISOString(),
            externalSoftwareWithholdPct,
            scheduledPayoutDate: job?.settlement?.scheduledPayoutDate,
            holdbackReleaseDate: job?.settlement?.holdbackReleaseDate,
          }),
          timeline: [
            ...job.timeline,
            {
              label: 'InCert requested revisions to external audit evidence',
              at: reviewAt,
              actor: reviewerName,
            },
          ],
        };
      })
    );

    if (normalizedDecision === 'reject') {
      addToast('External audit returned for additional evidence', 'info');
      return true;
    }

    if (targetAuditor) {
      setAuditors((previousAuditors) =>
        previousAuditors.map((auditor) =>
          auditor.id === targetAuditor.id
            ? {
                ...auditor,
                activeJobs: Math.max(0, auditor.activeJobs - 1),
                completedAudits: auditor.completedAudits + 1,
              }
            : auditor
        )
      );
    }

    const issueDate = reviewDate.toISOString().slice(0, 10);
    const expiryDate = new Date(reviewDate);
    expiryDate.setMonth(expiryDate.getMonth() + 6);
    setCertificates((previousCertificates) => [
      {
        id: `CERT-${reviewDate.getFullYear()}-${Math.floor(1000 + Math.random() * 9000)}`,
        assetId: targetJob.assetId,
        assetName: targetJob.assetName,
        regime: targetJob.regime,
        provider: auditorName,
        issueDate,
        expiryDate: expiryDate.toISOString().slice(0, 10),
        hash: createPseudoHash(`${targetJob.id}-${targetAuditor?.id || 'external'}-${issueDate}`),
      },
      ...previousCertificates,
    ]);

    const inProgressRun = auditRuns.find((run) => run.auditJobId === jobId && run.status === 'in_progress');
    if (inProgressRun) {
      completeAuditRun(inProgressRun.id, {
        auditorId: targetAuditor?.id || '',
        auditorName,
      });
    }

    addToast('External audit approved and certificate issued', 'success');
    return true;
  };

  const completeMarketplaceAudit = (jobId, auditorId, completionPayload = null) => {
    const targetJob = marketplaceJobs.find((job) => job.id === jobId);
    const targetAuditor = auditors.find((auditor) => auditor.id === auditorId);

    if (!targetJob || !targetAuditor) {
      addToast('Unable to complete job', 'info');
      return false;
    }

    if (targetJob.matchedAuditorId !== auditorId || targetJob.status !== 'in_progress') {
      addToast('Job must be in progress before completion', 'info');
      return false;
    }

    if (normalizeAuditExecutionMode(targetJob.auditExecutionMode) === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE) {
      addToast('External audits must be submitted for InCert review before completion', 'info');
      return false;
    }

    const today = new Date();
    const todayIso = today.toISOString().slice(0, 10);
    const expiry = new Date(today);
    expiry.setMonth(expiry.getMonth() + 6);
    const expiryIso = expiry.toISOString().slice(0, 10);
    const timelineAt = getTimelineStamp(today);

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) => {
        if (job.id === jobId && job.matchedAuditorId === auditorId && job.status === 'in_progress') {
          const pricing = getMarketplaceJobPricing(job);
          const pricingLock = getMarketplaceJobPricingLock(job, pricing) ||
            buildMarketplacePricingLock({
              jobId: job.id,
              quote: pricing,
              lockedAt: today.toISOString(),
              lockedBy: targetAuditor.name,
            });
          const settlement = buildMarketplaceSettlement(pricing, {
            payoutStatus: 'scheduled',
            completedAt: today.toISOString(),
            externalSoftwareWithholdPct: resolveExternalSoftwareWithholdPct(job),
          });
          return {
            ...job,
            status: 'completed',
            externalAuditReviewStatus: EXTERNAL_AUDIT_REVIEW_STATUSES.NOT_REQUIRED,
            pricingLock,
            settlement,
            timeline: [
              ...job.timeline,
              {
                label: 'Audit completed',
                at: timelineAt,
                actor: targetAuditor.name,
              },
              {
                label: `Settlement scheduled for ${settlement.scheduledPayoutDate}`,
                at: timelineAt,
                actor: 'InCert Settlement Engine',
              },
            ],
          };
        }
        return job;
      })
    );

    setAuditors((previousAuditors) =>
      previousAuditors.map((auditor) =>
        auditor.id === auditorId
          ? {
              ...auditor,
              activeJobs: Math.max(0, auditor.activeJobs - 1),
              completedAudits: auditor.completedAudits + 1,
            }
          : auditor
      )
    );

    setCertificates((previousCertificates) => [
      {
        id: `CERT-${today.getFullYear()}-${Math.floor(1000 + Math.random() * 9000)}`,
        assetId: targetJob.assetId,
        assetName: targetJob.assetName,
        regime: targetJob.regime,
        provider: targetAuditor.name,
        issueDate: todayIso,
        expiryDate: expiryIso,
        hash: createPseudoHash(`${targetJob.id}-${targetAuditor.id}-${todayIso}`),
      },
      ...previousCertificates,
    ]);

    const inProgressRun = auditRuns.find((run) => run.auditJobId === jobId && run.status === 'in_progress');
    let runCompletionResult = true;
    if (inProgressRun) {
      runCompletionResult = completeAuditRun(inProgressRun.id, {
        completionPayload:
          completionPayload && typeof completionPayload === 'object'
            ? {
                ...completionPayload,
                completedAt: today.toISOString(),
                auditorName: targetAuditor.name,
              }
            : null,
        auditorId: targetAuditor.id,
        auditorName: targetAuditor.name,
      });
    }

    addToast('Audit completed and certificate issued to Evidence Vault', 'success');
    if (runCompletionResult && typeof runCompletionResult === 'object') {
      return {
        ...runCompletionResult,
        jobId,
        auditorId,
      };
    }
    return true;
  };

  const applyMarketplaceAdjustment = (jobId, adjustmentPayload) => {
    const targetJob = marketplaceJobs.find((job) => job.id === jobId);
    if (!targetJob) {
      addToast('Unable to apply adjustment: job not found', 'info');
      return false;
    }

    const baselinePricing = getMarketplaceJobPricing(targetJob);
    const pricingLock = getMarketplaceJobPricingLock(targetJob, baselinePricing);
    if (!pricingLock) {
      addToast('Quote must be locked before adjustments can be applied', 'info');
      return false;
    }

    const adjustmentType = adjustmentPayload?.type || 'manual';
    const reasonCode = String(adjustmentPayload?.reasonCode || 'manual_adjustment').trim() || 'manual_adjustment';
    const evidenceRef = String(adjustmentPayload?.evidenceRef || '').trim();
    const approvedByUserId = String(adjustmentPayload?.approvedByUserId || 'ops_user').trim() || 'ops_user';
    const amountExVatDelta = roundMoney(adjustmentPayload?.amountExVatDelta);

    if (amountExVatDelta === 0) {
      addToast('Adjustment amount must be non-zero', 'info');
      return false;
    }

    const now = new Date();
    const timelineAt = getTimelineStamp(now);
    let adjustmentApplied = false;

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) => {
        if (job.id !== jobId) {
          return job;
        }

        const currentPricing = getMarketplaceJobPricing(job);
        const currentLock = getMarketplaceJobPricingLock(job, currentPricing);
        if (!currentLock) {
          return job;
        }

        const nextQuote = buildAdjustedMarketplaceQuote({
          previousQuote: currentPricing,
          jobId: job.id,
          adjustmentType,
          amountExVatDelta,
          reasonCode,
          evidenceRef,
        });

        const currentAdjustments = getMarketplaceJobPricingAdjustments(job);
        const adjustmentEvent = {
          adjustmentId: `ADJ-${job.id}-${currentAdjustments.length + 1}`,
          type: adjustmentType,
          reasonCode,
          amountExVatDelta,
          evidenceRef,
          approvedByUserId,
          quoteIdFrom: currentPricing.quoteId,
          quoteIdTo: nextQuote.quoteId,
          createdAt: now.toISOString(),
        };

        adjustmentApplied = true;
        const nextPayoutStatus =
          job.status === 'completed'
            ? 'scheduled'
            : job.status === 'awaiting_review'
              ? 'pending_review'
              : 'pending_completion';
        const nextSettlement = buildMarketplaceSettlement(nextQuote, {
          payoutStatus: nextPayoutStatus,
          completedAt: now.toISOString(),
          externalSoftwareWithholdPct: resolveExternalSoftwareWithholdPct(job),
          scheduledPayoutDate: job?.settlement?.scheduledPayoutDate,
          holdbackReleaseDate: job?.settlement?.holdbackReleaseDate,
        });

        return {
          ...job,
          budget: nextQuote.total,
          pricing: nextQuote,
          pricingHistory: [...getMarketplaceJobPricingHistory(job, currentPricing), nextQuote],
          pricingAdjustments: [...currentAdjustments, adjustmentEvent],
          settlement: nextSettlement,
          timeline: [
            ...job.timeline,
            {
              label: `Pricing adjustment ${adjustmentType.replace(/_/g, ' ')} (${amountExVatDelta >= 0 ? '+' : ''}${formatCurrencyGBP(amountExVatDelta)} ex VAT)`,
              at: timelineAt,
              actor: approvedByUserId,
            },
          ],
        };
      })
    );

    if (!adjustmentApplied) {
      addToast('Unable to apply adjustment for this job state', 'info');
      return false;
    }

    addToast(`Adjustment applied to ${jobId}: ${amountExVatDelta >= 0 ? '+' : ''}${formatCurrencyGBP(amountExVatDelta)} ex VAT`, 'success');
    return true;
  };

  const updatePublicSiteConfig = (patch) => {
    setPublicSiteConfig((previousConfig) => ({
      ...previousConfig,
      ...patch,
      launchDate:
        patch?.launchStatus === 'live'
          ? patch.launchDate || previousConfig.launchDate || new Date().toISOString().slice(0, 10)
          : patch?.launchDate ?? previousConfig.launchDate,
      updatedAt: new Date().toISOString(),
    }));
  };

  const toggleOnboardingTask = (taskId) => {
    setOnboardingTasks((previousTasks) =>
      previousTasks.map((task) =>
        task.id === taskId
          ? {
              ...task,
              completed: !task.completed,
            }
          : task
      )
    );
  };

  const runPilotFulfilmentLoop = () => {
    const openJobs = marketplaceJobs.filter((job) => job.status === 'open');
    if (openJobs.length === 0) {
      addToast('No open jobs available for pilot fulfilment loop', 'info');
      return;
    }

    let dispatched = 0;
    openJobs.slice(0, 3).forEach((job) => {
      const topCandidate = rankAuditorsForJob(job, auditors, Date.now())[0];
      if (!topCandidate) {
        return;
      }
      dispatchMarketplaceJob(job.id, topCandidate.auditor.id, 'Pilot fulfilment loop');
      dispatched += 1;
    });

    if (dispatched === 0) {
      addToast('Pilot loop found no eligible provider matches', 'info');
      return;
    }

    addToast(`Pilot fulfilment dispatched ${dispatched} open job${dispatched === 1 ? '' : 's'}`, 'success');
  };

  const signCertificateFromTrustLayer = (certificateId) => {
    const targetCertificate = certificates.find((certificate) => certificate.id === certificateId);
    if (!targetCertificate) {
      addToast('Certificate not found for signing', 'info');
      return false;
    }

    const signedAt = new Date().toISOString();
    const verificationLink = buildCertificateDeepLink(certificateId);
    setCertificates((previousCertificates) =>
      previousCertificates.map((certificate) =>
        certificate.id === certificateId
          ? {
              ...certificate,
              signedAt,
              signatureAlgorithm: 'kms_sha256_rsa',
              verificationLink,
            }
          : certificate
      )
    );
    addToast(`Certificate ${certificateId} signed and verification published`, 'success');
    return true;
  };

  const resolveInvoiceIssueDate = (invoice) =>
    String(invoice?.issueDate || invoice?.issuedAt || invoice?.createdAt || '').slice(0, 10);
  const resolveInvoiceDueDate = (invoice) => String(invoice?.dueDate || invoice?.dueAt || '').slice(0, 10);
  const resolveInvoiceMonthKey = (invoice) =>
    String(resolveInvoiceIssueDate(invoice) || resolveInvoiceDueDate(invoice) || '').slice(0, 7);
  const resolvePayoutMonthKey = (run) =>
    String(run?.scheduledPayoutDate || run?.scheduledFor || run?.createdAt || '').slice(0, 7);

  const generateMissingInvoices = () => {
    const completedJobs = marketplaceJobs.filter((job) => job.status === 'completed');
    if (completedJobs.length === 0) {
      addToast('No completed jobs available for invoicing', 'info');
      return;
    }

    const existingInvoiceJobIds = new Set(financeInvoices.map((invoice) => invoice.jobId));
    const issueDate = new Date().toISOString().slice(0, 10);
    const dueDate = addDays(issueDate, 30);
    const createdInvoices = [];
    const nextInvoices = [...financeInvoices];

    completedJobs.forEach((job) => {
      if (existingInvoiceJobIds.has(job.id)) {
        return;
      }

      const pricing = getMarketplaceJobPricing(job);
      const settlement = getMarketplaceJobSettlement(job, pricing);
      const poNumber = extractStructuredNoteValue(job.notes, 'PO') || 'PO-PENDING';
      const costCentre = extractStructuredNoteValue(job.notes, 'Cost centre') || 'UNALLOCATED';
      const approver = extractStructuredNoteValue(job.notes, 'Approver') || 'finance@acme-logistics.example';
      const invoiceId = getNextInvoiceId(nextInvoices);
      const matchedProvider = activeProviderRecords.find((provider) => provider.id === job.matchedAuditorId) || null;
      const providerName = String(matchedProvider?.name || 'Assigned provider');
      const companyName = String(job.companyName || activeCompanyContext.name || 'Company');
      const companyId =
        String(job.companyId || '').trim() ||
        normalizeCompanyIdentifier(companyName) ||
        activeCompanyContext.id ||
        'company';
      const companyOrgId = String(job.companyOrgId || '').trim();
      const payToAuditorId = String(matchedProvider?.id || job.matchedAuditorId || '');
      const payToOrganizationId = String(matchedProvider?.dbOrganizationId || '');
      const payToAuditCompanyId = String(
        matchedProvider?.thirdPartyOrganizationId ||
        (isThirdPartyProvider(matchedProvider)
          ? matchedProvider?.dbOrganizationId || matchedProvider?.id || ''
          : '')
      );
      const invoice = {
        id: invoiceId,
        jobId: job.id,
        quoteId: pricing.quoteId,
        assetName: job.assetName,
        providerName,
        billToName: companyName,
        payToName: providerName,
        companyId,
        companyOrgId,
        billToEntityType: 'company',
        billToEntityId: companyId,
        billToOrganizationId: companyOrgId,
        payToEntityType: payToAuditCompanyId ? 'auditor_company' : 'auditor',
        payToEntityId: payToAuditCompanyId || payToAuditorId,
        payToAuditorId,
        payToAuditCompanyId,
        payToOrganizationId,
        issueDate,
        dueDate,
        poNumber,
        costCentre,
        approver,
        subtotalExVat: pricing.subtotalExVat,
        vatAmount: pricing.vatAmount,
        totalIncVat: pricing.total,
        settlementReference: settlement ? settlement.payoutEvent : 'EVIDENCE_ISSUED',
        status: 'pending_approval',
        approvedAt: '',
        payoutScheduledAt: '',
        paidAt: '',
        reminderCount: 0,
        lastReminderAt: '',
      };
      nextInvoices.unshift(invoice);
      existingInvoiceJobIds.add(job.id);
      createdInvoices.push(invoice);
    });

    if (createdInvoices.length === 0) {
      addToast('All completed jobs already have invoices', 'info');
      return;
    }

    setFinanceInvoices(nextInvoices);
    addToast(`${createdInvoices.length} invoice${createdInvoices.length === 1 ? '' : 's'} generated from completed jobs`, 'success');
  };

  const approveInvoice = (invoiceId) => {
    let didApprove = false;
    const approvedAt = new Date().toISOString();
    setFinanceInvoices((previousInvoices) =>
      previousInvoices.map((invoice) => {
        if (invoice.id !== invoiceId || invoice.status !== 'pending_approval') {
          return invoice;
        }

        didApprove = true;
        return {
          ...invoice,
          status: 'approved',
          approvedAt,
        };
      })
    );

    if (!didApprove) {
      addToast('Invoice is not eligible for approval', 'info');
      return false;
    }

    addToast(`Invoice ${invoiceId} approved`, 'success');
    return true;
  };

  const issueInvoice = (invoiceId) => {
    let didIssue = false;
    const issuedAt = new Date().toISOString().slice(0, 10);
    setFinanceInvoices((previousInvoices) =>
      previousInvoices.map((invoice) => {
        if (invoice.id !== invoiceId) {
          return invoice;
        }

        const currentStatus = String(invoice.status || '').toLowerCase();
        if (!['approved', 'overdue', 'payout_scheduled'].includes(currentStatus)) {
          return invoice;
        }

        didIssue = true;
        const resolvedIssueDate = resolveInvoiceIssueDate(invoice) || issuedAt;
        return {
          ...invoice,
          status: currentStatus === 'approved' ? 'issued' : invoice.status,
          issueDate: resolvedIssueDate,
          issuedAt: resolvedIssueDate,
        };
      })
    );

    if (!didIssue) {
      addToast('Invoice is not eligible for issuing', 'info');
      return false;
    }

    addToast(`Invoice ${invoiceId} issued to customer`, 'success');
    return true;
  };

  const sendInvoiceReminder = (invoiceId) => {
    let reminderCount = 0;
    let didSend = false;
    const lastReminderAt = new Date().toISOString();

    setFinanceInvoices((previousInvoices) =>
      previousInvoices.map((invoice) => {
        if (invoice.id !== invoiceId) {
          return invoice;
        }

        const currentStatus = String(invoice.status || '').toLowerCase();
        if (['pending_approval', 'approved', 'paid'].includes(currentStatus)) {
          return invoice;
        }

        didSend = true;
        reminderCount = Math.max(0, Number(invoice.reminderCount || 0)) + 1;
        return {
          ...invoice,
          reminderCount,
          lastReminderAt,
        };
      })
    );

    if (!didSend) {
      addToast('Issue invoice before sending reminders', 'info');
      return false;
    }

    addToast(`Reminder ${reminderCount} sent for ${invoiceId}`, 'success');
    return true;
  };

  const markInvoiceCollected = (
    invoiceId,
    {
      payoutStatus = 'scheduled',
      existingRunStatus = '',
      successToastMessage = null,
    } = {}
  ) => {
    const targetInvoice = financeInvoices.find((invoice) => invoice.id === invoiceId);
    if (!targetInvoice) {
      addToast('Invoice not found for collection posting', 'info');
      return false;
    }

    let didCollect = false;
    const paidAt = new Date().toISOString();
    setFinanceInvoices((previousInvoices) =>
      previousInvoices.map((invoice) => {
        if (invoice.id !== invoiceId) {
          return invoice;
        }

        const currentStatus = String(invoice.status || '').toLowerCase();
        if (currentStatus === 'pending_approval' || currentStatus === 'paid') {
          return invoice;
        }

        didCollect = true;
        return {
          ...invoice,
          status: 'paid',
          paidAt,
        };
      })
    );

    if (!didCollect) {
      addToast('Invoice is not eligible for collection posting', 'info');
      return false;
    }

    const collectedInvoice = {
      ...targetInvoice,
      status: 'paid',
      paidAt,
    };
    const collectedInvoicesById = new Map([[String(invoiceId), collectedInvoice]]);
    setPayoutRuns((previousRuns) =>
      upsertPayoutRunsFromCollectedInvoices(previousRuns, collectedInvoicesById, paidAt, {
        newRunStatus: payoutStatus,
        existingRunStatus,
      })
    );

    addToast(
      successToastMessage || `Cash received for invoice ${invoiceId}. Provider payout queued within 7 days.`,
      'success'
    );
    return true;
  };

  const markInvoicePaidByCompany = (invoiceId) =>
    markInvoiceCollected(invoiceId, {
      payoutStatus: 'pending_confirmation',
      existingRunStatus: 'pending_confirmation',
      successToastMessage: `Payment recorded for invoice ${invoiceId}. Awaiting InCert confirmation before provider payment.`,
    });

  const buildDebugCollectedTimestamp = (invoice, fallbackIso = new Date().toISOString()) => {
    const seedSource = String(invoice?.id || invoice?.jobId || invoice?.quoteId || '');
    const seedValue = seedSource.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
    const fallbackDate = String(fallbackIso || '').slice(0, 10) || new Date().toISOString().slice(0, 10);
    const sourceDate =
      resolveInvoiceIssueDate(invoice) ||
      resolveInvoiceDueDate(invoice) ||
      fallbackDate;
    const parsedSource = parseISODate(sourceDate);
    if (!parsedSource) {
      return fallbackIso;
    }
    const year = parsedSource.getUTCFullYear();
    const monthIndex = parsedSource.getUTCMonth();
    const daysInMonth = new Date(Date.UTC(year, monthIndex + 1, 0)).getUTCDate();
    const day = Math.min(daysInMonth, (seedValue % 24) + 1);
    const hour = 8 + (seedValue % 10);
    const minute = (seedValue * 7) % 60;
    return new Date(Date.UTC(year, monthIndex, day, hour, minute, 0, 0)).toISOString();
  };

  const buildDebugPayoutPaidTimestamp = (run, fallbackIso = new Date().toISOString()) => {
    const seedSource = String(run?.id || run?.invoiceId || run?.jobId || '');
    const seedValue = seedSource.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
    const fallbackDate = String(fallbackIso || '').slice(0, 10) || new Date().toISOString().slice(0, 10);
    const sourceDate =
      String(run?.scheduledPayoutDate || run?.scheduledFor || run?.createdAt || fallbackDate).slice(0, 10) || fallbackDate;
    const parsedSource = parseISODate(sourceDate);
    if (!parsedSource) {
      return fallbackIso;
    }
    const year = parsedSource.getUTCFullYear();
    const monthIndex = parsedSource.getUTCMonth();
    const day = parsedSource.getUTCDate();
    const hour = 9 + (seedValue % 8);
    const minute = (seedValue * 11) % 60;
    return new Date(Date.UTC(year, monthIndex, day, hour, minute, 0, 0)).toISOString();
  };

  const resolveInvoicePayoutAmount = (invoice) => {
    const payoutBaseExVat = Number(
      invoice?.providerPayoutExVat ||
      invoice?.subtotalExVat ||
      roundMoney(Number(invoice?.totalIncVat || 0) / (1 + DEFAULT_VAT_RATE))
    );
    return roundMoney(Math.max(0, payoutBaseExVat));
  };

  const upsertPayoutRunsFromCollectedInvoices = (
    previousRuns,
    collectedInvoicesById,
    fallbackCreatedAtIso = new Date().toISOString(),
    { newRunStatus = 'scheduled', existingRunStatus = '' } = {}
  ) => {
    if (!(collectedInvoicesById instanceof Map) || collectedInvoicesById.size === 0) {
      return previousRuns;
    }
    const normalizedNewRunStatus = String(newRunStatus || 'scheduled').trim().toLowerCase() || 'scheduled';
    const normalizedExistingRunStatus = String(existingRunStatus || '').trim().toLowerCase();

    let nextRuns = previousRuns.map((run) => {
      const invoiceId = String(run.invoiceId || '');
      const linkedInvoice = collectedInvoicesById.get(invoiceId);
      const currentStatus = String(run.status || '').toLowerCase();
      if (!linkedInvoice || currentStatus === 'paid') {
        return run;
      }
      const collectionDate = String(linkedInvoice.paidAt || '').slice(0, 10);
      const fallbackDate = resolveInvoiceDueDate(linkedInvoice) || resolveInvoiceIssueDate(linkedInvoice) || collectionDate;
      const scheduledPayoutDate = resolveCollectionBackedPayoutDate(
        collectionDate,
        `${invoiceId}-${run.id || 'run'}`,
        fallbackDate,
        7
      );
      return {
        ...run,
        scheduledPayoutDate,
        scheduledFor: scheduledPayoutDate,
        status: normalizedExistingRunStatus || currentStatus || normalizedNewRunStatus,
        payToEntityType: String(
          run?.payToEntityType ||
          linkedInvoice?.payToEntityType ||
          (linkedInvoice?.payToAuditCompanyId ? 'auditor_company' : 'auditor')
        ),
        payToEntityId: String(
          run?.payToEntityId ||
          linkedInvoice?.payToEntityId ||
          linkedInvoice?.payToAuditCompanyId ||
          linkedInvoice?.payToAuditorId ||
          ''
        ),
      };
    });

    const existingInvoiceIds = new Set(nextRuns.map((run) => String(run.invoiceId || '')));
    collectedInvoicesById.forEach((linkedInvoice, invoiceId) => {
      const normalizedInvoiceId = String(invoiceId || '');
      if (!normalizedInvoiceId || existingInvoiceIds.has(normalizedInvoiceId)) {
        return;
      }

      const collectionDate = String(linkedInvoice.paidAt || '').slice(0, 10);
      const fallbackDate = resolveInvoiceDueDate(linkedInvoice) || resolveInvoiceIssueDate(linkedInvoice) || collectionDate;
      const scheduledPayoutDate = resolveCollectionBackedPayoutDate(
        collectionDate,
        `${normalizedInvoiceId}-new-run`,
        fallbackDate,
        7
      );

      nextRuns = [
        {
          id: getNextPayoutRunId(nextRuns),
          invoiceId: normalizedInvoiceId,
          jobId: String(linkedInvoice.jobId || ''),
          providerName: String(linkedInvoice.providerName || linkedInvoice.payToName || 'Assigned provider'),
          payToEntityType: String(
            linkedInvoice.payToEntityType || (linkedInvoice.payToAuditCompanyId ? 'auditor_company' : 'auditor')
          ),
          payToEntityId: String(
            linkedInvoice.payToEntityId || linkedInvoice.payToAuditCompanyId || linkedInvoice.payToAuditorId || ''
          ),
          payToAuditorId: String(linkedInvoice.payToAuditorId || ''),
          payToAuditCompanyId: String(linkedInvoice.payToAuditCompanyId || ''),
          payToOrganizationId: String(linkedInvoice.payToOrganizationId || ''),
          companyId: String(linkedInvoice.companyId || ''),
          companyOrgId: String(linkedInvoice.companyOrgId || ''),
          payoutAmount: resolveInvoicePayoutAmount(linkedInvoice),
          scheduledPayoutDate,
          scheduledFor: scheduledPayoutDate,
          status: normalizedNewRunStatus,
          createdAt: String(linkedInvoice.paidAt || fallbackCreatedAtIso || new Date().toISOString()),
        },
        ...nextRuns,
      ];
      existingInvoiceIds.add(normalizedInvoiceId);
    });

    return nextRuns;
  };

  const markInvoicesCollectedForMonth = (monthKey) => {
    const normalizedMonthKey = String(monthKey || '').trim();
    if (!/^\d{4}-\d{2}$/.test(normalizedMonthKey)) {
      addToast('Select a valid month before running debug approve+collect', 'info');
      return false;
    }

    let collectedCount = 0;
    const nowIso = new Date().toISOString();
    const issuedAt = nowIso.slice(0, 10);
    const approvedAt = nowIso;
    const collectedInvoicesById = new Map();
    setFinanceInvoices((previousInvoices) =>
      previousInvoices.map((invoice) => {
        if (resolveInvoiceMonthKey(invoice) !== normalizedMonthKey) {
          return invoice;
        }

        const currentStatus = String(invoice.status || '').toLowerCase();
        if (currentStatus === 'paid') {
          return invoice;
        }

        collectedCount += 1;
        const resolvedIssueDate = resolveInvoiceIssueDate(invoice) || issuedAt;
        const paidAt = buildDebugCollectedTimestamp(invoice, nowIso);
        const nextInvoice = {
          ...invoice,
          status: 'paid',
          approvedAt: invoice.approvedAt || approvedAt,
          issueDate: resolvedIssueDate,
          issuedAt: invoice.issuedAt || resolvedIssueDate,
          paidAt,
        };
        collectedInvoicesById.set(String(nextInvoice.id || ''), nextInvoice);
        return nextInvoice;
      })
    );

    if (collectedCount === 0) {
      addToast(`No eligible receivables in ${normalizedMonthKey}`, 'info');
      return false;
    }

    setPayoutRuns((previousRuns) => upsertPayoutRunsFromCollectedInvoices(previousRuns, collectedInvoicesById, nowIso));

    addToast(
      `Debug: approved+collected ${collectedCount} receivable${collectedCount === 1 ? '' : 's'} for ${normalizedMonthKey}`,
      'success'
    );
    return true;
  };

  const markAllInvoicesCollectedDebug = () => {
    let collectedCount = 0;
    const nowIso = new Date().toISOString();
    const issuedAt = nowIso.slice(0, 10);
    const approvedAt = nowIso;
    const collectedInvoicesById = new Map();
    setFinanceInvoices((previousInvoices) =>
      previousInvoices.map((invoice) => {
        const currentStatus = String(invoice.status || '').toLowerCase();
        if (currentStatus === 'paid') {
          return invoice;
        }

        collectedCount += 1;
        const resolvedIssueDate = resolveInvoiceIssueDate(invoice) || issuedAt;
        const paidAt = buildDebugCollectedTimestamp(invoice, nowIso);
        const nextInvoice = {
          ...invoice,
          status: 'paid',
          approvedAt: invoice.approvedAt || approvedAt,
          issueDate: resolvedIssueDate,
          issuedAt: invoice.issuedAt || resolvedIssueDate,
          paidAt,
        };
        collectedInvoicesById.set(String(nextInvoice.id || ''), nextInvoice);
        return nextInvoice;
      })
    );

    if (collectedCount === 0) {
      addToast('No eligible receivables in this debug year window', 'info');
      return false;
    }

    setPayoutRuns((previousRuns) => upsertPayoutRunsFromCollectedInvoices(previousRuns, collectedInvoicesById, nowIso));

    addToast(`Debug: approved+collected ${collectedCount} receivable${collectedCount === 1 ? '' : 's'} for the full year`, 'success');
    return true;
  };

  const runInvoiceCollectionsSweep = () => {
    const today = startOfToday().getTime();
    let markedOverdue = 0;

    setFinanceInvoices((previousInvoices) =>
      previousInvoices.map((invoice) => {
        const currentStatus = String(invoice.status || '').toLowerCase();
        if (['pending_approval', 'overdue', 'paid'].includes(currentStatus)) {
          return invoice;
        }

        const dueDate = parseISODate(resolveInvoiceDueDate(invoice));
        if (!dueDate || Number.isNaN(dueDate.getTime()) || dueDate.getTime() >= today) {
          return invoice;
        }

        markedOverdue += 1;
        return {
          ...invoice,
          status: 'overdue',
        };
      })
    );

    if (markedOverdue === 0) {
      addToast('No invoices became overdue in this sweep', 'info');
      return false;
    }

    addToast(`Collections sweep flagged ${markedOverdue} overdue invoice${markedOverdue === 1 ? '' : 's'}`, 'success');
    return true;
  };

  const schedulePayoutForInvoice = (invoiceId) => {
    const targetInvoice = financeInvoices.find((invoice) => invoice.id === invoiceId);
    if (!targetInvoice) {
      addToast('Invoice not found for payout scheduling', 'info');
      return false;
    }
    const normalizedInvoiceStatus = String(targetInvoice.status || '').toLowerCase();
    if (!['approved', 'issued', 'overdue', 'paid'].includes(normalizedInvoiceStatus)) {
      addToast('Invoice must be approved/issued before scheduling payout', 'info');
      return false;
    }
    if (payoutRuns.some((run) => run.invoiceId === invoiceId)) {
      addToast('Payout already scheduled for this invoice', 'info');
      return false;
    }

    const linkedJob = marketplaceJobs.find((job) => job.id === targetInvoice.jobId);
    const pricing = linkedJob ? getMarketplaceJobPricing(linkedJob) : null;
    const settlement = linkedJob ? getMarketplaceJobSettlement(linkedJob, pricing) : null;
    const runId = getNextPayoutRunId(payoutRuns);
    const collectionDate = String(targetInvoice.paidAt || '').slice(0, 10);
    const fallbackPayoutBaseDate =
      resolveInvoiceDueDate(targetInvoice) ||
      resolveInvoiceIssueDate(targetInvoice) ||
      new Date().toISOString().slice(0, 10);
    const scheduledPayoutDate = resolveCollectionBackedPayoutDate(
      collectionDate,
      `${String(targetInvoice.id || invoiceId)}-manual-schedule`,
      fallbackPayoutBaseDate,
      7
    );
    const fallbackPayoutBaseExVat = Number(
      targetInvoice.providerPayoutExVat ||
      targetInvoice.subtotalExVat ||
      roundMoney(Number(targetInvoice.totalIncVat || 0) / (1 + DEFAULT_VAT_RATE))
    );
    const payoutAmount = settlement?.netProviderScheduled || roundMoney(Math.max(0, fallbackPayoutBaseExVat));
    const createdAt = new Date().toISOString();

    setPayoutRuns((previousRuns) => [
      {
        id: runId,
        invoiceId,
        jobId: targetInvoice.jobId,
        providerName: targetInvoice.providerName,
        payToEntityType: String(
          targetInvoice.payToEntityType || (targetInvoice.payToAuditCompanyId ? 'auditor_company' : 'auditor')
        ),
        payToEntityId: String(
          targetInvoice.payToEntityId || targetInvoice.payToAuditCompanyId || targetInvoice.payToAuditorId || ''
        ),
        payToAuditorId: String(targetInvoice.payToAuditorId || ''),
        payToAuditCompanyId: String(targetInvoice.payToAuditCompanyId || ''),
        payToOrganizationId: String(targetInvoice.payToOrganizationId || ''),
        companyId: String(targetInvoice.companyId || ''),
        companyOrgId: String(targetInvoice.companyOrgId || ''),
        payoutAmount,
        scheduledPayoutDate,
        scheduledFor: scheduledPayoutDate,
        status: 'scheduled',
        createdAt,
      },
      ...previousRuns,
    ]);

    setFinanceInvoices((previousInvoices) =>
      previousInvoices.map((invoice) =>
        invoice.id === invoiceId
          ? {
              ...invoice,
              status: String(invoice.status || '').toLowerCase() === 'paid' ? 'paid' : 'payout_scheduled',
              payoutScheduledAt: createdAt,
            }
          : invoice
      )
    );

    addToast(`Payout run ${runId} scheduled for ${targetInvoice.providerName} (within 7 days of collection)`, 'success');
    return true;
  };

  const confirmPayoutRunForPayment = (runId) => {
    const targetRun = payoutRuns.find((run) => run.id === runId);
    if (!targetRun) {
      addToast('Payout run not found', 'info');
      return false;
    }
    const normalizedStatus = String(targetRun.status || '').toLowerCase();
    if (normalizedStatus === 'paid') {
      addToast('Payout run is already marked as paid', 'info');
      return false;
    }
    if (normalizedStatus === 'scheduled') {
      addToast('Payout run is already confirmed and scheduled for payment', 'info');
      return false;
    }

    setPayoutRuns((previousRuns) =>
      previousRuns.map((run) =>
        run.id === runId
          ? {
              ...run,
              status: 'scheduled',
            }
          : run
      )
    );

    addToast(`Payout ${runId} confirmed and ready for payment`, 'success');
    return true;
  };

  const markPayoutRunPaid = (runId) => {
    const targetRun = payoutRuns.find((run) => run.id === runId);
    if (!targetRun) {
      addToast('Payout run not found', 'info');
      return false;
    }

    if (String(targetRun.status || '').toLowerCase() === 'paid') {
      addToast('Payout run is already marked as paid', 'info');
      return false;
    }

    const paidAt = new Date().toISOString();
    setPayoutRuns((previousRuns) =>
      previousRuns.map((run) =>
        run.id === runId
          ? {
              ...run,
              status: 'paid',
              paidAt,
            }
          : run
      )
    );

    if (targetRun.invoiceId) {
      setFinanceInvoices((previousInvoices) =>
        previousInvoices.map((invoice) =>
          invoice.id === targetRun.invoiceId
            ? {
                ...invoice,
                status: 'paid',
                paidAt: invoice.paidAt || paidAt,
              }
            : invoice
        )
      );
    }

    addToast(`Payout ${runId} marked as paid`, 'success');
    return true;
  };

  const markPayoutRunsPaidForMonth = (monthKey) => {
    const normalizedMonthKey = String(monthKey || '').trim();
    if (!/^\d{4}-\d{2}$/.test(normalizedMonthKey)) {
      addToast('Select a valid month before running bulk payout', 'info');
      return false;
    }

    let paidRunsCount = 0;
    const nowIso = new Date().toISOString();
    const relatedInvoiceIds = new Set();
    const relatedInvoicePaidAtById = new Map();
    const invoicePaidDateById = new Map(
      financeInvoices.map((invoice) => [String(invoice.id || ''), String(invoice.paidAt || '').slice(0, 10)])
    );

    setPayoutRuns((previousRuns) =>
      previousRuns.map((run) => {
        if (resolvePayoutMonthKey(run) !== normalizedMonthKey) {
          return run;
        }

        if (String(run.status || '').toLowerCase() === 'paid') {
          return run;
        }

        paidRunsCount += 1;
        let alignedRun = run;
        if (run.invoiceId) {
          const relatedInvoiceId = String(run.invoiceId);
          relatedInvoiceIds.add(relatedInvoiceId);
          const invoicePaidDate = invoicePaidDateById.get(relatedInvoiceId) || '';
          const fallbackDate =
            String(run.scheduledPayoutDate || run.scheduledFor || run.createdAt || nowIso).slice(0, 10) ||
            String(nowIso).slice(0, 10);
          const alignedScheduledDate = resolveCollectionBackedPayoutDate(
            invoicePaidDate,
            `${relatedInvoiceId}-${run.id || 'run'}`,
            fallbackDate,
            7
          );
          alignedRun = {
            ...run,
            scheduledPayoutDate: alignedScheduledDate,
            scheduledFor: alignedScheduledDate,
          };
          if (!relatedInvoicePaidAtById.has(relatedInvoiceId)) {
            relatedInvoicePaidAtById.set(relatedInvoiceId, buildDebugPayoutPaidTimestamp(alignedRun, nowIso));
          }
        }
        const runPaidAt = buildDebugPayoutPaidTimestamp(alignedRun, nowIso);

        return {
          ...alignedRun,
          status: 'paid',
          paidAt: runPaidAt,
        };
      })
    );

    if (paidRunsCount === 0) {
      addToast(`No eligible provider payouts in ${normalizedMonthKey}`, 'info');
      return false;
    }

    if (relatedInvoiceIds.size > 0) {
      setFinanceInvoices((previousInvoices) =>
        previousInvoices.map((invoice) =>
          relatedInvoiceIds.has(String(invoice.id || ''))
            ? {
                ...invoice,
                status: 'paid',
                paidAt: invoice.paidAt || relatedInvoicePaidAtById.get(String(invoice.id || '')) || nowIso,
              }
            : invoice
        )
      );
    }

    addToast(
      `Debug: paid ${paidRunsCount} provider run${paidRunsCount === 1 ? '' : 's'} for ${normalizedMonthKey}`,
      'success'
    );
    return true;
  };

  const markAllPayoutRunsPaidDebug = () => {
    let paidRunsCount = 0;
    const nowIso = new Date().toISOString();
    const relatedInvoiceIds = new Set();
    const relatedInvoicePaidAtById = new Map();
    const invoicePaidDateById = new Map(
      financeInvoices.map((invoice) => [String(invoice.id || ''), String(invoice.paidAt || '').slice(0, 10)])
    );

    setPayoutRuns((previousRuns) =>
      previousRuns.map((run) => {
        if (String(run.status || '').toLowerCase() === 'paid') {
          return run;
        }

        paidRunsCount += 1;
        let alignedRun = run;
        if (run.invoiceId) {
          const relatedInvoiceId = String(run.invoiceId);
          relatedInvoiceIds.add(relatedInvoiceId);
          const invoicePaidDate = invoicePaidDateById.get(relatedInvoiceId) || '';
          const fallbackDate =
            String(run.scheduledPayoutDate || run.scheduledFor || run.createdAt || nowIso).slice(0, 10) ||
            String(nowIso).slice(0, 10);
          const alignedScheduledDate = resolveCollectionBackedPayoutDate(
            invoicePaidDate,
            `${relatedInvoiceId}-${run.id || 'run'}`,
            fallbackDate,
            7
          );
          alignedRun = {
            ...run,
            scheduledPayoutDate: alignedScheduledDate,
            scheduledFor: alignedScheduledDate,
          };
          if (!relatedInvoicePaidAtById.has(relatedInvoiceId)) {
            relatedInvoicePaidAtById.set(relatedInvoiceId, buildDebugPayoutPaidTimestamp(alignedRun, nowIso));
          }
        }
        const runPaidAt = buildDebugPayoutPaidTimestamp(alignedRun, nowIso);

        return {
          ...alignedRun,
          status: 'paid',
          paidAt: runPaidAt,
        };
      })
    );

    if (paidRunsCount === 0) {
      addToast('No eligible provider payouts in this debug year window', 'info');
      return false;
    }

    if (relatedInvoiceIds.size > 0) {
      setFinanceInvoices((previousInvoices) =>
        previousInvoices.map((invoice) =>
          relatedInvoiceIds.has(String(invoice.id || ''))
            ? {
                ...invoice,
                status: 'paid',
                paidAt: invoice.paidAt || relatedInvoicePaidAtById.get(String(invoice.id || '')) || nowIso,
              }
            : invoice
        )
      );
    }

    addToast(`Debug: paid ${paidRunsCount} provider run${paidRunsCount === 1 ? '' : 's'} for the full year`, 'success');
    return true;
  };

  const alignDebugPayoutsToCollections = () => {
    const invoiceById = new Map(financeInvoices.map((invoice) => [String(invoice.id || ''), invoice]));
    let alignedCount = 0;

    setPayoutRuns((previousRuns) =>
      previousRuns.map((run) => {
        const invoiceId = String(run.invoiceId || '');
        if (!invoiceId) {
          return run;
        }
        const linkedInvoice = invoiceById.get(invoiceId);
        if (!linkedInvoice) {
          return run;
        }

        const collectionDate = String(linkedInvoice.paidAt || '').slice(0, 10);
        const fallbackDate =
          resolveInvoiceDueDate(linkedInvoice) ||
          resolveInvoiceIssueDate(linkedInvoice) ||
          String(run.paidAt || run.scheduledPayoutDate || run.scheduledFor || '').slice(0, 10);
        const alignedScheduledDate = resolveCollectionBackedPayoutDate(
          collectionDate,
          `${invoiceId}-${run.id || 'align'}`,
          fallbackDate,
          7
        );
        if (!parseISODate(alignedScheduledDate)) {
          return run;
        }

        const alignedPaidAt = buildDebugPayoutPaidTimestamp(
          {
            ...run,
            scheduledPayoutDate: alignedScheduledDate,
            scheduledFor: alignedScheduledDate,
          },
          `${alignedScheduledDate}T09:00:00.000Z`
        );
        const nextRun = {
          ...run,
          scheduledPayoutDate: alignedScheduledDate,
          scheduledFor: alignedScheduledDate,
          paidAt: String(run.status || '').toLowerCase() === 'paid' ? alignedPaidAt : run.paidAt,
        };
        const changed =
          String(nextRun.scheduledPayoutDate || '') !== String(run.scheduledPayoutDate || '') ||
          String(nextRun.scheduledFor || '') !== String(run.scheduledFor || '') ||
          String(nextRun.paidAt || '') !== String(run.paidAt || '');
        if (changed) {
          alignedCount += 1;
          return nextRun;
        }
        return run;
      })
    );

    if (alignedCount === 0) {
      addToast('No payout runs required alignment to the 7-day collection payout cadence', 'info');
      return false;
    }

    addToast(
      `Debug: aligned ${alignedCount} payout run${alignedCount === 1 ? '' : 's'} to 7-day collection payout cadence`,
      'success'
    );
    return true;
  };

  const exportAccountancyCsv = ({
    invoices = financeInvoices,
    runs = payoutRuns,
    filePrefix = 'incert-accountancy',
  } = {}) => {
    if (typeof window === 'undefined') {
      return false;
    }

    const escapeCsvCell = (value) => `"${String(value ?? '').replaceAll('"', '""')}"`;
    const rows = [
      [
        'Entry Type',
        'Record ID',
        'Status',
        'Counterparty',
        'Job ID',
        'Invoice ID',
        'Reference',
        'Amount (inc VAT)',
        'Issued Date',
        'Due/Scheduled Date',
        'Paid Date',
      ],
    ];

    invoices.forEach((invoice) => {
      rows.push([
        'Invoice',
        invoice.id || '',
        invoice.status || '',
        invoice.providerName || 'Customer invoice',
        invoice.jobId || '',
        invoice.id || '',
        invoice.quoteId || invoice.invoiceNumber || '',
        Number(invoice.totalIncVat || 0),
        resolveInvoiceIssueDate(invoice),
        resolveInvoiceDueDate(invoice),
        String(invoice.paidAt || '').slice(0, 10),
      ]);
    });

    runs.forEach((run) => {
      rows.push([
        'Payout',
        run.id || '',
        run.status || '',
        run.providerName || run.reference || 'Provider payout',
        run.jobId || '',
        run.invoiceId || '',
        run.reference || '',
        Number(run.payoutAmount ?? run.totalIncVat ?? 0),
        String(run.createdAt || '').slice(0, 10),
        String(run.scheduledPayoutDate || run.scheduledFor || '').slice(0, 10),
        String(run.paidAt || '').slice(0, 10),
      ]);
    });

    const csvText = rows.map((row) => row.map(escapeCsvCell).join(',')).join('\n');
    const normalizedPrefix =
      String(filePrefix || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '') || 'accountancy';
    const fileName = `${normalizedPrefix}-${new Date().toISOString().slice(0, 10)}.csv`;
    const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
    const downloadUrl = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(downloadUrl);

    addToast('Accountancy CSV exported', 'success');
    return true;
  };
  const ensureScopedInvoiceForAccountancy = (invoiceId, { requirePayable = false } = {}) => {
    const normalizedInvoiceId = String(invoiceId || '').trim();
    if (!normalizedInvoiceId) {
      addToast('Invalid invoice reference', 'info');
      return null;
    }
    if (!scopedInvoiceIdSet.has(normalizedInvoiceId)) {
      addToast('This invoice is outside your account scope', 'info');
      return null;
    }
    const targetInvoice = financeInvoices.find((invoice) => String(invoice?.id || '') === normalizedInvoiceId) || null;
    if (!targetInvoice) {
      addToast('Invoice not found', 'info');
      return null;
    }
    if (requirePayable && !canViewerPayInvoice(targetInvoice)) {
      addToast('Only bill-to invoices can be paid from this account page', 'info');
      return null;
    }
    return targetInvoice;
  };
  const ensureScopedPayoutRunForAccountancy = (runId) => {
    const normalizedRunId = String(runId || '').trim();
    if (!normalizedRunId) {
      addToast('Invalid payout reference', 'info');
      return null;
    }
    if (!scopedPayoutRunIdSet.has(normalizedRunId)) {
      addToast('This payout run is outside your account scope', 'info');
      return null;
    }
    const targetRun = payoutRuns.find((run) => String(run?.id || '') === normalizedRunId) || null;
    if (!targetRun) {
      addToast('Payout run not found', 'info');
      return null;
    }
    return targetRun;
  };
  const exportScopedAccountancyCsv = () => {
    const scopeSlug = normalizeCompanyIdentifier(accountancyScope?.label || accountancyScope?.mode || 'accountancy') || 'accountancy';
    const prefix = accountancyScope?.mode === 'incert'
      ? 'incert-accountancy'
      : `${String(accountancyScope?.mode || 'account')}-accountancy-${scopeSlug}`;
    return exportAccountancyCsv({
      invoices: scopedFinanceInvoices,
      runs: scopedPayoutRuns,
      filePrefix: prefix,
    });
  };

  const addInspectionTemplate = ({ regime, name, controls, scope = 'company' }) => {
    const templateName = String(name || '').trim();
    if (!templateName) {
      addToast('Template name is required', 'info');
      return false;
    }
    const visibility = String(scope || '').toLowerCase() === 'global' ? 'global' : 'company';
    const ownerCompanyId = visibility === 'company' ? activeCompanyContext.id : '';
    const ownerCompanyName = visibility === 'company' ? activeCompanyContext.name : '';

    const cleanedControls = String(controls || '')
      .split('\n')
      .map((item) => item.trim())
      .filter(Boolean);

    setInspectionTemplates((previousTemplates) => [
      {
        id: getNextTemplateId(previousTemplates),
        regime: regime || 'PUWER',
        name: templateName,
        version: '1.0',
        active: true,
        controls: cleanedControls.length > 0 ? cleanedControls : ['Control checkpoint pending'],
        visibility,
        ownerCompanyId,
        ownerCompanyName,
      },
      ...previousTemplates,
    ]);
    addToast(
      `Template created: ${templateName} (${visibility === 'company' ? `${activeCompanyContext.name} bespoke` : 'global'})`,
      'success'
    );
    return true;
  };

  const toggleInspectionTemplate = (templateId) => {
    setInspectionTemplates((previousTemplates) =>
      previousTemplates.map((template) =>
        template.id === templateId
          ? {
              ...template,
              active: !template.active,
            }
          : template
      )
    );
  };

  const connectIntegration = (integrationId, endpoint) => {
    const sanitizedEndpoint = String(endpoint || '').trim();
    if (!sanitizedEndpoint) {
      addToast('Integration endpoint is required', 'info');
      return false;
    }

    let didConnect = false;
    const updatedAt = new Date().toISOString();
    setIntegrationConnections((previousIntegrations) =>
      previousIntegrations.map((integration) => {
        if (integration.id !== integrationId) {
          return integration;
        }
        didConnect = true;
        return {
          ...integration,
          status: 'connected',
          endpoint: sanitizedEndpoint,
          lastSyncAt: updatedAt,
        };
      })
    );

    if (!didConnect) {
      addToast('Integration not found', 'info');
      return false;
    }

    addToast('Integration connected and sync channel activated', 'success');
    return true;
  };

  const createApiClient = (name = 'New API Client') => {
    const clientName = String(name || '').trim() || 'New API Client';
    const nowIso = new Date().toISOString();
    const clientId = getNextEntityId(apiClients, 'API');
    setApiClients((previousClients) => [
      {
        id: clientId,
        name: clientName,
        status: 'active',
        scopes: ['jobs.read', 'jobs.write'],
        secretFingerprint: `fp_${createPseudoHash(`${clientId}:${nowIso}`).slice(0, 6)}`,
        secretRotatedAt: nowIso,
        createdAt: nowIso,
      },
      ...previousClients,
    ]);
    addToast(`API client ${clientId} created`, 'success');
    return true;
  };

  const rotateApiClientSecret = (clientId) => {
    let didRotate = false;
    const rotatedAt = new Date().toISOString();
    setApiClients((previousClients) =>
      previousClients.map((client) => {
        if (client.id !== clientId) {
          return client;
        }
        didRotate = true;
        return {
          ...client,
          secretFingerprint: `fp_${createPseudoHash(`${client.id}:${rotatedAt}`).slice(0, 6)}`,
          secretRotatedAt: rotatedAt,
        };
      })
    );

    if (!didRotate) {
      addToast('API client not found for secret rotation', 'info');
      return false;
    }

    addToast(`API secret rotated for ${clientId}`, 'success');
    return true;
  };

  const upsertWebhookEndpoint = (payload = {}) => {
    const name = String(payload.name || '').trim();
    const targetUrl = String(payload.targetUrl || '').trim();
    if (!name || !targetUrl) {
      addToast('Webhook name and target URL are required', 'info');
      return false;
    }
    const endpointId = getNextEntityId(webhookEndpoints, 'WEP');
    setWebhookEndpoints((previousEndpoints) => [
      {
        id: endpointId,
        name,
        status: 'active',
        targetUrl,
        lastDeliveredAt: '',
      },
      ...previousEndpoints,
    ]);
    addToast(`Webhook endpoint ${endpointId} added`, 'success');
    return true;
  };

  const configureEnterpriseSsoProvider = (providerName = 'SAML Provider', domain = 'example.com') => {
    const normalizedProvider = String(providerName || '').trim() || 'SAML Provider';
    const normalizedDomain = String(domain || '').trim() || 'example.com';
    const nowIso = new Date().toISOString();
    const existingProvider = enterpriseSsoProviders.find(
      (provider) => provider.providerName.toLowerCase() === normalizedProvider.toLowerCase()
    );

    if (existingProvider) {
      setEnterpriseSsoProviders((previousProviders) =>
        previousProviders.map((provider) =>
          provider.id === existingProvider.id
            ? {
                ...provider,
                status: 'configured',
                domain: normalizedDomain,
                updatedAt: nowIso,
              }
            : provider
        )
      );
      addToast(`SSO provider ${existingProvider.id} updated`, 'success');
      return true;
    }

    const providerId = getNextEntityId(enterpriseSsoProviders, 'SSO');
    setEnterpriseSsoProviders((previousProviders) => [
      {
        id: providerId,
        providerName: normalizedProvider,
        status: 'configured',
        domain: normalizedDomain,
        updatedAt: nowIso,
      },
      ...previousProviders,
    ]);
    addToast(`SSO provider ${providerId} configured`, 'success');
    return true;
  };

  const toggleEnterpriseAccessPolicy = (policyId) => {
    let didToggle = false;
    let nextStatus = 'enabled';
    const updatedAt = new Date().toISOString();
    setEnterpriseAccessPolicies((previousPolicies) =>
      previousPolicies.map((policy) => {
        if (policy.id !== policyId) {
          return policy;
        }
        didToggle = true;
        nextStatus = policy.status === 'enabled' ? 'disabled' : 'enabled';
        return {
          ...policy,
          status: nextStatus,
          updatedAt,
        };
      })
    );

    if (!didToggle) {
      addToast('Access policy not found', 'info');
      return false;
    }

    addToast(`Access policy ${policyId} set to ${nextStatus}`, 'success');
    return true;
  };

  const createTemplateBlueprint = ({ name, category, scoringModel, licenceModel, blockTypes, mandatoryEvidenceBlocks }) => {
    const templateName = String(name || '').trim();
    if (!templateName) {
      addToast('Template blueprint name is required', 'info');
      return false;
    }

    const normalizedBlockTypes = String(blockTypes || '')
      .split(',')
      .map((item) => item.trim())
      .filter(Boolean);
    const requiredEvidenceCount = Math.max(0, Number(mandatoryEvidenceBlocks || 0));
    const nowIso = new Date().toISOString();
    const templateId = getNextEntityId(templateBlueprints, 'TPLX');

    setTemplateBlueprints((previousTemplates) => [
      {
        id: templateId,
        ownerOrgId: 'incert',
        name: templateName,
        category: String(category || 'HS'),
        schemaVersion: '1.0',
        scoringModel: String(scoringModel || 'pass_fail'),
        licenceModel: String(licenceModel || 'single_use'),
        status: 'draft',
        currentVersion: '1.0',
        blockTypes: normalizedBlockTypes.length > 0 ? normalizedBlockTypes : ['section', 'yes_no_na', 'photo'],
        mandatoryEvidenceBlocks: requiredEvidenceCount,
        signatures: { auditorRequired: true, operatorRequired: false },
        publishedAt: '',
        versions: [
          {
            version: '1.0',
            changelog: 'Initial draft',
            publishedAt: nowIso,
            hash: createPseudoHash(JSON.stringify({ templateId, nowIso })),
          },
        ],
      },
      ...previousTemplates,
    ]);

    addToast(`Template blueprint created: ${templateName}`, 'success');
    return true;
  };

  const publishTemplateBlueprint = (templateId, changelog = 'Published update') => {
    let didPublish = false;
    let publishedVersion = '';
    const nowIso = new Date().toISOString();

    setTemplateBlueprints((previousTemplates) =>
      previousTemplates.map((template) => {
        if (template.id !== templateId) {
          return template;
        }
        didPublish = true;
        const nextVersion = incrementTemplateVersion(template.currentVersion || '1.0');
        publishedVersion = nextVersion;
        const versionEntry = {
          version: nextVersion,
          changelog: String(changelog || 'Published update'),
          publishedAt: nowIso,
          hash: createPseudoHash(JSON.stringify({ templateId, version: nextVersion, nowIso })),
        };
        return {
          ...template,
          status: 'published',
          currentVersion: nextVersion,
          publishedAt: nowIso,
          versions: [...(Array.isArray(template.versions) ? template.versions : []), versionEntry],
        };
      })
    );

    if (!didPublish) {
      addToast('Template blueprint not found', 'info');
      return false;
    }

    addToast(`Template ${templateId} published as v${publishedVersion}`, 'success');
    return true;
  };

  const updateTemplateBlueprintQuestionBank = ({ templateId, questionBank }) => {
    const normalizedTemplateId = String(templateId || '').trim();
    if (!normalizedTemplateId) {
      addToast('Select a valid template blueprint before saving question changes', 'info');
      return false;
    }

    const targetTemplate = templateBlueprints.find((template) => template.id === normalizedTemplateId);
    if (!targetTemplate) {
      addToast('Template blueprint not found', 'info');
      return false;
    }

    const questionPrefix = String(targetTemplate.category || targetTemplate.id || 'Q');
    const normalizedQuestions = normalizeTemplateQuestionBank(questionBank, questionPrefix);
    if (normalizedQuestions.length === 0) {
      addToast('Question bank must contain at least one question', 'info');
      return false;
    }

    const maxScore = normalizedQuestions.reduce((total, question) => total + Math.max(1, Number(question.weight || 1)), 0);
    const previousPassPercent = Number(targetTemplate?.passThreshold?.passPercent || 0);
    const passPercent = Number.isFinite(previousPassPercent) && previousPassPercent > 0
      ? Math.max(1, Math.round(previousPassPercent))
      : 80;
    const passScore = Math.max(1, Math.min(maxScore, Math.ceil(maxScore * (passPercent / 100))));
    const criticalQuestionIds = normalizedQuestions
      .filter((question) => question.type === 'boolean' && Boolean(question.critical))
      .map((question) => String(question.id || '').trim())
      .filter(Boolean);
    const mandatoryEvidenceBlocks = normalizedQuestions.filter((question) => {
      const evidence = question.evidence || {};
      return Boolean(evidence.photo || evidence.comment || evidence.signature || question.required);
    }).length;

    const nowIso = new Date().toISOString();
    const nextVersion = incrementTemplateVersion(targetTemplate.currentVersion || '1.0');
    const versionEntry = {
      version: nextVersion,
      changelog: 'Question bank updated from template viewer',
      publishedAt: nowIso,
      hash: createPseudoHash(JSON.stringify({ templateId: normalizedTemplateId, version: nextVersion, nowIso })),
    };

    setTemplateBlueprints((previousTemplates) =>
      previousTemplates.map((template) => {
        if (template.id !== normalizedTemplateId) {
          return template;
        }

        return {
          ...template,
          questionBank: normalizedQuestions,
          mandatoryEvidenceBlocks,
          currentVersion: nextVersion,
          publishedAt: template.status === 'published' ? nowIso : template.publishedAt,
          versions: [...(Array.isArray(template.versions) ? template.versions : []), versionEntry],
          passThreshold: {
            passScore,
            maxScore,
            passPercent,
            criticalQuestionIds,
          },
          updatedAt: nowIso,
        };
      })
    );

    addToast(`Template ${normalizedTemplateId} question bank saved as v${nextVersion}`, 'success');
    return true;
  };

  const createTemplateListing = ({ templateId, priceModel, price, tags, vettingTier }) => {
    const targetTemplate = templateBlueprints.find((template) => template.id === templateId);
    if (!targetTemplate) {
      addToast('Select a valid template blueprint before listing', 'info');
      return false;
    }

    const listingPrice = Number(price || 0);
    if (!Number.isFinite(listingPrice) || listingPrice <= 0) {
      addToast('Listing price must be greater than 0', 'info');
      return false;
    }

    const listingTags = String(tags || '')
      .split(',')
      .map((item) => item.trim().toLowerCase())
      .filter(Boolean);
    const listingId = getNextEntityId(templateListings, 'LST');

    setTemplateListings((previousListings) => [
      {
        id: listingId,
        templateId: targetTemplate.id,
        priceModel: String(priceModel || 'single_use'),
        price: Math.round(listingPrice),
        currency: 'GBP',
        tags: listingTags,
        previewAssets: 0,
        qualityRating: 4.7,
        vettingTier: String(vettingTier || 'community'),
        status: 'active',
      },
      ...previousListings,
    ]);

    addToast(`Marketplace listing created for ${targetTemplate.name}`, 'success');
    return true;
  };

  const grantTemplateLicence = ({ listingId, buyerOrgId, licenceType, seats, uses, allowedExports, watermarkRules, canFork }) => {
    const targetListing = templateListings.find((listing) => listing.id === listingId);
    if (!targetListing) {
      addToast('Select a valid marketplace listing before granting a licence', 'info');
      return false;
    }

    const normalizedBuyerOrgId = String(buyerOrgId || '').trim();
    if (!normalizedBuyerOrgId) {
      addToast('Buyer org is required', 'info');
      return false;
    }

    const startAt = new Date();
    const endAt = new Date(startAt.getTime());
    endAt.setFullYear(endAt.getFullYear() + 1);
    const exportsList = String(allowedExports || 'pdf,json')
      .split(',')
      .map((item) => item.trim().toLowerCase())
      .filter(Boolean);

    setLicenceGrants((previousGrants) => [
      {
        id: getNextEntityId(previousGrants, 'LIC'),
        listingId,
        buyerOrgId: normalizedBuyerOrgId,
        licenceType: String(licenceType || 'multi_use'),
        seats: Math.max(1, Number(seats || 1)),
        usesRemaining: licenceType === 'single_use' ? Math.max(1, Number(uses || 1)) : null,
        allowedExports: exportsList.length > 0 ? exportsList : ['pdf', 'json'],
        watermarkRules: String(watermarkRules || 'none'),
        canFork: Boolean(canFork),
        startAt: startAt.toISOString(),
        endAt: endAt.toISOString(),
      },
      ...previousGrants,
    ]);

    addToast(`Licence granted to ${normalizedBuyerOrgId}`, 'success');
    return true;
  };

  const startAuditRun = ({ auditJobId, templateId, offlineSyncState, gpsPolicy }) => {
    const targetJob = marketplaceJobs.find((job) => job.id === auditJobId);
    if (!targetJob) {
      addToast('Select a valid job before starting an audit run', 'info');
      return null;
    }
    const targetTemplate = templateBlueprints.find((template) => template.id === templateId);
    if (!targetTemplate) {
      addToast('Select a valid template before starting an audit run', 'info');
      return null;
    }

    const existingInProgressRun = auditRuns.find((run) => run.auditJobId === auditJobId && run.status === 'in_progress');
    if (existingInProgressRun) {
      return existingInProgressRun.id;
    }

    const runId = getNextEntityId(auditRuns, 'RUN');
    const nowIso = new Date().toISOString();
    setAuditRuns((previousRuns) => [
      {
        id: runId,
        auditJobId,
        templateId,
        templateVersion: targetTemplate.currentVersion || '1.0',
        startedAt: nowIso,
        completedAt: '',
        status: 'in_progress',
        offlineSyncState: String(offlineSyncState || 'queued'),
        gpsPolicy: String(gpsPolicy || 'optional'),
        requiredEvidenceRemaining: Math.max(0, Number(targetTemplate.mandatoryEvidenceBlocks || 0)),
        requiredSignaturesRemaining: targetTemplate.signatures?.operatorRequired ? 2 : 1,
        reportArtifactId: '',
        completionPayload: null,
        completionSummary: null,
      },
      ...previousRuns,
    ]);
    addToast(`Audit run ${runId} started for ${targetJob.id}`, 'success');
    return runId;
  };

  const createReportArtifactForRun = (auditRunId, completionContext = {}) => {
    const targetRun = auditRuns.find((run) => run.id === auditRunId);
    if (!targetRun) {
      addToast('Audit run not found for report generation', 'info');
      return null;
    }
    const targetTemplate = templateBlueprints.find((template) => template.id === targetRun.templateId) || null;
    const targetJob = marketplaceJobs.find((job) => job.id === targetRun.auditJobId) || null;
    const resolvedAuditorId = String(
      completionContext?.auditorId ||
        targetJob?.matchedAuditorId ||
        ''
    );
    const targetAuditor = auditors.find((auditor) => auditor.id === resolvedAuditorId) || null;
    const completionPayload =
      completionContext?.completionPayload && typeof completionContext.completionPayload === 'object'
        ? completionContext.completionPayload
        : targetRun?.completionPayload && typeof targetRun.completionPayload === 'object'
          ? targetRun.completionPayload
          : null;

    const hasActualAnswers = Array.isArray(completionPayload?.answers) && completionPayload.answers.length > 0;
    const templateIndex = Math.max(
      0,
      templateBlueprints.findIndex((template) => template.id === targetRun.templateId)
    );
    const fallbackTemplateModel = buildTemplateCompletionReportModel(
      targetTemplate || {
        id: targetRun.templateId || 'TPLX-0000',
        name: completionPayload?.templateName || `${targetJob?.regime || 'General'} Audit Template`,
        category: completionPayload?.templateCategory || targetJob?.regime || 'HS',
        currentVersion: targetRun.templateVersion || '1.0',
        questionBank: [],
      },
      templateIndex
    );
    const reportModel = hasActualAnswers
      ? buildCompletedAuditRunReportModel({
          auditRun: {
            ...targetRun,
            completedAt: completionContext?.completedAt || targetRun.completedAt || new Date().toISOString(),
          },
          templateBlueprint: targetTemplate,
          completionPayload,
          job: targetJob,
          auditor: targetAuditor,
          companyContext: activeCompanyContext,
        })
      : fallbackTemplateModel;

    let artifactId = '';
    let createdAtIso = '';
    setReportArtifacts((previousArtifacts) => {
      const runArtifacts = previousArtifacts.filter((artifact) => artifact.auditRunId === auditRunId);
      const nextVersion =
        runArtifacts.reduce((max, artifact) => Math.max(max, Number(artifact.version || 0)), 0) + 1;
      const replacedArtifacts = previousArtifacts.map((artifact) =>
        artifact.auditRunId === auditRunId && artifact.status === 'valid'
          ? {
              ...artifact,
            status: 'replaced',
          }
          : artifact
      );
      const createdAt = new Date().toISOString();
      createdAtIso = createdAt;
      artifactId = getNextEntityId(previousArtifacts, 'RPT');
      const basePath = `storage://incert-reports/${auditRunId}/v${nextVersion}`;
      const artifact = {
        id: artifactId,
        auditRunId,
        version: nextVersion,
        pdfUri: `${basePath}/report.pdf`,
        htmlUri: `${basePath}/report.html`,
        hash: createPseudoHash(JSON.stringify({ auditRunId, nextVersion, createdAt })),
        signature: `sig:incert:${auditRunId}:v${nextVersion}`,
        status: 'valid',
        signedPdfUrl: `https://signed.incert.example/reports/${auditRunId}/v${nextVersion}.pdf`,
        signedHtmlUrl: `https://signed.incert.example/reports/${auditRunId}/v${nextVersion}.html`,
        createdAt,
        htmlContent: buildTemplateCompletedReportHtml(reportModel, {}),
        reportSummary: reportModel.summary,
        reportTemplate: reportModel.template,
        reportAuditMeta: reportModel.audit,
        verificationUrl: reportModel.links.verificationUrl,
        vaultRecordId: reportModel.security.vaultRecordId,
        tamperSealId: reportModel.security.tamperSealId,
        vaultStatus: 'pending',
        vaultStoredAt: '',
      };
      return [artifact, ...replacedArtifacts];
    });

    if (artifactId) {
      Promise.all([
        QRCode.toDataURL(reportModel.links.verificationUrl, { width: 540, margin: 1, errorCorrectionLevel: 'H' }),
        QRCode.toDataURL(reportModel.links.vaultUrl, { width: 540, margin: 1, errorCorrectionLevel: 'H' }),
        QRCode.toDataURL(reportModel.links.tamperUrl, { width: 540, margin: 1, errorCorrectionLevel: 'H' }),
      ])
        .then(([verificationQrDataUrl, vaultQrDataUrl, tamperQrDataUrl]) => {
          const nextHtml = buildTemplateCompletedReportHtml(reportModel, {
            verificationQrDataUrl,
            vaultQrDataUrl,
            tamperQrDataUrl,
          });
          setReportArtifacts((previousArtifacts) =>
            previousArtifacts.map((artifact) =>
              artifact.id === artifactId
                ? {
                    ...artifact,
                    htmlContent: nextHtml,
                    qrAssets: {
                      verificationQrDataUrl,
                      vaultQrDataUrl,
                      tamperQrDataUrl,
                    },
                  }
                : artifact
            )
          );
        })
        .catch(() => {
          setReportArtifacts((previousArtifacts) =>
            previousArtifacts.map((artifact) =>
              artifact.id === artifactId
                ? {
                    ...artifact,
                    qrAssets: null,
                  }
                : artifact
            )
          );
        });
    }

    addToast(`Report artifact ${artifactId} generated`, 'success');
    if (createdAtIso) {
      setMarketplaceJobs((previousJobs) =>
        previousJobs.map((job) =>
          job.id === targetRun.auditJobId
            ? {
                ...job,
                timeline: [
                  ...job.timeline,
                  {
                    label: `Completed report artifact ${artifactId} generated`,
                    at: getTimelineStamp(new Date(createdAtIso)),
                    actor: 'InCert Report Engine',
                  },
                ],
              }
            : job
        )
      );
    }
    return artifactId;
  };

  const completeAuditRun = (auditRunId, completionContext = {}) => {
    const targetRun = auditRuns.find((run) => run.id === auditRunId);
    if (!targetRun) {
      addToast('Audit run not found', 'info');
      return false;
    }

    if (targetRun.status === 'completed') {
      addToast('Audit run is already completed', 'info');
      return false;
    }

    const completedAt = new Date().toISOString();
    const completionPayload =
      completionContext?.completionPayload && typeof completionContext.completionPayload === 'object'
        ? completionContext.completionPayload
        : null;
    const completionSummary =
      completionPayload?.summary && typeof completionPayload.summary === 'object'
        ? completionPayload.summary
        : null;

    setAuditRuns((previousRuns) =>
      previousRuns.map((run) =>
        run.id === auditRunId
          ? {
              ...run,
              completedAt,
              status: 'completed',
              offlineSyncState: 'synced',
              requiredEvidenceRemaining: 0,
              requiredSignaturesRemaining: 0,
              completionPayload,
              completionSummary,
            }
          : run
      )
    );
    const artifactId = createReportArtifactForRun(auditRunId, {
      ...completionContext,
      completedAt,
    });
    if (artifactId) {
      setAuditRuns((previousRuns) =>
        previousRuns.map((run) =>
          run.id === auditRunId
            ? {
                ...run,
                reportArtifactId: artifactId,
              }
            : run
        )
      );
    }
    return artifactId ? { runId: auditRunId, artifactId } : true;
  };

  const downloadReportArtifactHtml = (reportArtifactId) => {
    const targetArtifact = reportArtifacts.find((artifact) => artifact.id === reportArtifactId);
    if (!targetArtifact) {
      addToast('Report artifact not found', 'info');
      return false;
    }

    const htmlContent = String(targetArtifact.htmlContent || '').trim();
    if (!htmlContent) {
      const fallbackUrl = String(targetArtifact.signedHtmlUrl || '').trim();
      if (!fallbackUrl) {
        addToast('No HTML report is available for this artifact', 'info');
        return false;
      }
      window.open(fallbackUrl, '_blank', 'noopener,noreferrer');
      return true;
    }

    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const downloadUrl = window.URL.createObjectURL(blob);
    const anchor = document.createElement('a');
    const runId = String(targetArtifact.auditRunId || 'run').toLowerCase();
    const versionLabel = String(targetArtifact.version || '1');
    anchor.href = downloadUrl;
    anchor.download = `incert-${runId}-v${versionLabel}-report.html`;
    document.body.appendChild(anchor);
    anchor.click();
    document.body.removeChild(anchor);
    window.URL.revokeObjectURL(downloadUrl);
    addToast(`Downloaded report artifact ${reportArtifactId}`, 'success');
    return true;
  };

  const saveReportArtifactToEvidenceVault = (reportArtifactId) => {
    const targetArtifact = reportArtifacts.find((artifact) => artifact.id === reportArtifactId);
    if (!targetArtifact) {
      addToast('Report artifact not found', 'info');
      return false;
    }

    const storedAt = new Date().toISOString();
    const linkedRun = auditRuns.find((run) => run.id === targetArtifact.auditRunId);
    const linkedJobId = linkedRun?.auditJobId || '';

    setReportArtifacts((previousArtifacts) =>
      previousArtifacts.map((artifact) =>
        artifact.id === reportArtifactId
          ? {
              ...artifact,
              vaultStatus: 'stored',
              vaultStoredAt: storedAt,
              vaultRecordId: artifact.vaultRecordId || `VLT-${createPseudoDigest(`${reportArtifactId}:vault`, 8).toUpperCase()}`,
              tamperSealId: artifact.tamperSealId || `SEAL-${createPseudoDigest(`${reportArtifactId}:seal`, 8).toUpperCase()}`,
            }
          : artifact
      )
    );

    if (linkedJobId) {
      const timelineAt = getTimelineStamp(new Date(storedAt));
      setMarketplaceJobs((previousJobs) =>
        previousJobs.map((job) =>
          job.id === linkedJobId
            ? {
                ...job,
                timeline: [
                  ...job.timeline,
                  {
                    label: `Completed report ${reportArtifactId} saved to Evidence Vault`,
                    at: timelineAt,
                    actor: 'InCert Evidence Vault',
                  },
                ],
              }
            : job
        )
      );
    }

    addToast(`Report ${reportArtifactId} saved to Evidence Vault`, 'success');
    return true;
  };

  const addAuditFinding = ({ auditRunId, severity, taxonomyCode, description }) => {
    const normalizedDescription = String(description || '').trim();
    if (!normalizedDescription) {
      addToast('Finding description is required', 'info');
      return false;
    }

    const targetRun = auditRuns.find((run) => run.id === auditRunId);
    if (!targetRun) {
      addToast('Select a valid audit run before adding a finding', 'info');
      return false;
    }

    const severityValue = String(severity || 'medium').toLowerCase();
    let createdFindingId = '';
    setAuditFindings((previousFindings) => {
      createdFindingId = getNextEntityId(previousFindings, 'FND');
      return [
        {
          id: createdFindingId,
          auditRunId,
          severity: severityValue,
          taxonomyCode: String(taxonomyCode || 'GENERAL'),
          description: normalizedDescription,
          linkedBlockId: '',
          photos: severityValue === 'low' ? 0 : 1,
          riskScore: getSeverityRiskScore(severityValue),
          status: 'open',
        },
        ...previousFindings,
      ];
    });

    if (severityValue === 'high' || severityValue === 'critical') {
      setAuditActions((previousActions) => [
        {
          id: getNextEntityId(previousActions, 'ACT'),
          findingId: createdFindingId,
          assignee: 'Site Manager',
          dueDate: getDefaultActionDueDate(severityValue),
          status: 'open',
          evidenceRequired: true,
          closureSignoff: 'auditor',
          closureEvidenceCount: 0,
        },
        ...previousActions,
      ]);
      addToast(`Finding ${createdFindingId} logged and high-risk action auto-created`, 'success');
      return true;
    }

    addToast(`Finding ${createdFindingId} logged`, 'success');
    return true;
  };

  const createAuditAction = ({ findingId, assignee, dueDate, evidenceRequired, closureSignoff }) => {
    const targetFinding = auditFindings.find((finding) => finding.id === findingId);
    if (!targetFinding) {
      addToast('Select a valid finding before creating an action', 'info');
      return false;
    }

    setAuditActions((previousActions) => [
      {
        id: getNextEntityId(previousActions, 'ACT'),
        findingId,
        assignee: String(assignee || 'Site Manager'),
        dueDate: dueDate || getDefaultActionDueDate(targetFinding.severity),
        status: 'open',
        evidenceRequired: Boolean(evidenceRequired),
        closureSignoff: String(closureSignoff || 'auditor'),
        closureEvidenceCount: 0,
      },
      ...previousActions,
    ]);
    addToast(`Action created for finding ${findingId}`, 'success');
    return true;
  };

  const advanceAuditActionStatus = (actionId) => {
    let previousStatus = '';
    let nextStatus = '';

    setAuditActions((previousActions) =>
      previousActions.map((action) => {
        if (action.id !== actionId) {
          return action;
        }

        previousStatus = action.status;
        if (action.status === 'open') {
          nextStatus = 'pending_approval';
        } else if (action.status === 'pending_approval') {
          nextStatus = 'closed';
        } else {
          nextStatus = 'closed';
        }

        return {
          ...action,
          status: nextStatus,
          closureEvidenceCount: nextStatus === 'closed' ? Math.max(1, Number(action.closureEvidenceCount || 0)) : action.closureEvidenceCount,
        };
      })
    );

    if (!previousStatus) {
      addToast('Action not found', 'info');
      return false;
    }

    addToast(`Action ${actionId} moved to ${nextStatus.replace('_', ' ')}`, 'success');
    return true;
  };

  const createShareLinkForArtifact = (reportArtifactId) => {
    const targetArtifact = reportArtifacts.find((artifact) => artifact.id === reportArtifactId);
    if (!targetArtifact) {
      addToast('Report artifact not found', 'info');
      return false;
    }

    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + 14);
    const shareId = getNextEntityId(shareLinks, 'SHR');

    setShareLinks((previousLinks) => [
      {
        id: shareId,
        reportArtifactId,
        scopeJson: '{}',
        expiresAt: expiresAt.toISOString(),
        accessPolicy: 'read_only',
        auditLogEnabled: true,
        url: `https://portal.incert.example/share/${shareId}`,
      },
      ...previousLinks,
    ]);
    addToast(`Share link ${shareId} generated`, 'success');
    return true;
  };

  const createTenantInvite = (email, role = 'dutyholder_admin') => {
    const normalizedEmail = String(email || '').trim().toLowerCase();
    if (!normalizedEmail) {
      addToast('Invite email is required', 'info');
      return false;
    }
    if (tenantInvites.some((invite) => invite.email === normalizedEmail && invite.status === 'pending')) {
      addToast('A pending invite already exists for this email', 'info');
      return false;
    }
    const now = new Date().toISOString();
    setTenantInvites((previous) => [
      {
        id: getNextEntityId(previous, 'INV'),
        email: normalizedEmail,
        role: String(role || 'dutyholder_admin'),
        status: 'pending',
        sentAt: now,
        acceptedAt: '',
      },
      ...previous,
    ]);
    addToast(`Invite sent to ${normalizedEmail}`, 'success');
    return true;
  };

  const acceptNextTenantInvite = () => {
    let acceptedInviteId = '';
    setTenantInvites((previous) =>
      previous.map((invite) => {
        if (!acceptedInviteId && invite.status === 'pending') {
          acceptedInviteId = invite.id;
          return {
            ...invite,
            status: 'accepted',
            acceptedAt: new Date().toISOString(),
          };
        }
        return invite;
      })
    );
    if (!acceptedInviteId) {
      addToast('No pending invites to accept', 'info');
      return false;
    }
    addToast(`Invite ${acceptedInviteId} marked as accepted`, 'success');
    return true;
  };

  const appendEvidenceProvenanceEvent = () => {
    const targetJob =
      marketplaceJobs.find((job) => Array.isArray(job.documents) && job.documents.length > 0) || marketplaceJobs[0];
    if (!targetJob) {
      addToast('No job found to append provenance event', 'info');
      return false;
    }
    const docName = Array.isArray(targetJob.documents) && targetJob.documents.length > 0 ? targetJob.documents[0] : 'manual-upload.pdf';
    const evidenceRef = `evidence://${targetJob.id}/${docName}`;
    const createdAt = new Date().toISOString();
    setEvidenceProvenanceEvents((previous) => [
      {
        id: getNextEntityId(previous, 'PRV'),
        evidenceRef,
        eventType: 'review_signed',
        hash: createPseudoHash(`${evidenceRef}-${createdAt}`),
        deviceMetadata: 'server:review-workflow',
        createdAt,
      },
      ...previous,
    ]);
    addToast(`Provenance event appended for ${targetJob.id}`, 'success');
    return true;
  };

  const seedMarketplaceBidRound = () => {
    const targetJob =
      marketplaceJobs.find((job) => ['open', 'offered'].includes(job.status)) || marketplaceJobs[0] || null;
    if (!targetJob) {
      addToast('No marketplace job available to seed bids', 'info');
      return false;
    }

    const existingBidCount = marketplaceBidBoard.filter((bid) => bid.requestId === targetJob.id).length;
    if (existingBidCount >= 3) {
      addToast(`Bid board for ${targetJob.id} already has ${existingBidCount} bids`, 'info');
      return false;
    }

    const nowIso = new Date().toISOString();
    const firstSeedBidId = getNextEntityId(marketplaceBidBoard, 'BID');
    const secondSeedBidId = getNextEntityId([...marketplaceBidBoard, { id: firstSeedBidId }], 'BID');
    const seedBids = [
      {
        id: firstSeedBidId,
        requestId: targetJob.id,
        providerOrgName: 'NorthStar Inspection Partners',
        strategy: 'best_value',
        totalExVat: roundMoney(Math.max(120, Number(targetJob.budget || 320) * 0.92)),
        vatAmount: roundMoney(Math.max(24, Number(targetJob.budget || 320) * 0.184)),
        leadTimeHours: 11,
        qualityScore: 90,
        rankScore: 89,
        status: 'submitted',
        submittedAt: nowIso,
        assignedAuditor: 'Hannah Briggs',
        assignmentStatus: 'assigned',
      },
      {
        id: secondSeedBidId,
        requestId: targetJob.id,
        providerOrgName: 'Allianz Engineering',
        strategy: 'best_value',
        totalExVat: roundMoney(Math.max(120, Number(targetJob.budget || 320) * 0.96)),
        vatAmount: roundMoney(Math.max(24, Number(targetJob.budget || 320) * 0.192)),
        leadTimeHours: 8,
        qualityScore: 94,
        rankScore: 92,
        status: 'submitted',
        submittedAt: nowIso,
        assignedAuditor: 'O. Turner',
        assignmentStatus: 'assigned',
      },
    ];

    setMarketplaceBidBoard((previous) => [...seedBids, ...previous]);
    setDispatchSlaEvents((previous) => [
      {
        id: getNextEntityId(previous, 'SLA'),
        requestId: targetJob.id,
        eventType: 'bid_round_seeded',
        eventAt: nowIso,
        minutesFromOpen: 22,
        isBreach: false,
      },
      ...previous,
    ]);
    addToast(`Seeded ${seedBids.length} marketplace bids for ${targetJob.id}`, 'success');
    return true;
  };

  const awardBestMarketplaceBid = () => {
    const groupedByRequest = marketplaceBidBoard.reduce((groups, bid) => {
      if (!groups.has(bid.requestId)) {
        groups.set(bid.requestId, []);
      }
      groups.get(bid.requestId).push(bid);
      return groups;
    }, new Map());

    const targetGroup = [...groupedByRequest.entries()].find(([, bids]) =>
      bids.some((bid) => bid.status === 'submitted')
    );

    if (!targetGroup) {
      addToast('No submitted bids are available for award', 'info');
      return false;
    }

    const [requestId, bids] = targetGroup;
    const winner = rankBidEntries(
      bids.filter((bid) => bid.status === 'submitted' || bid.status === 'shortlisted')
    )[0];

    if (!winner) {
      addToast(`No eligible bid found for ${requestId}`, 'info');
      return false;
    }

    const nowIso = new Date().toISOString();
    setMarketplaceBidBoard((previous) =>
      previous.map((bid) => {
        if (bid.requestId !== requestId) {
          return bid;
        }
        if (bid.id === winner.id) {
          return {
            ...bid,
            status: 'awarded',
            assignmentStatus: 'accepted',
          };
        }
        if (['submitted', 'shortlisted'].includes(bid.status)) {
          return { ...bid, status: 'rejected' };
        }
        return bid;
      })
    );

    setDispatchSlaEvents((previous) => [
      {
        id: getNextEntityId(previous, 'SLA'),
        requestId,
        eventType: 'bid_awarded',
        eventAt: nowIso,
        minutesFromOpen: 34,
        isBreach: false,
      },
      ...previous,
    ]);

    setMarketplaceJobs((previous) =>
      previous.map((job) => {
        if (job.id !== requestId) {
          return job;
        }
        const matchedAuditor =
          auditors.find((auditor) => auditor.name === winner.providerOrgName) ||
          auditors.find((auditor) => String(auditor.name || '').includes(String(winner.providerOrgName || '')));
        return {
          ...job,
          status: job.status === 'completed' ? 'completed' : 'offered',
          matchedAuditorId: matchedAuditor?.id || job.matchedAuditorId,
          timeline: [
            ...job.timeline,
            {
              label: `Bid awarded to ${winner.providerOrgName} (${formatCurrencyGBP(winner.totalExVat)} ex VAT)`,
              at: getTimelineStamp(new Date(nowIso)),
              actor: 'InCert Award Engine',
            },
          ],
        };
      })
    );

    addToast(`Awarded best-value bid for ${requestId}`, 'success');
    return true;
  };

  const enqueueEvidenceAiExtraction = () => {
    const targetJob =
      marketplaceJobs.find((job) => Array.isArray(job.documents) && job.documents.length > 0) || marketplaceJobs[0];
    if (!targetJob) {
      addToast('No job available for evidence AI extraction', 'info');
      return false;
    }

    const latestDoc = Array.isArray(targetJob.documents) && targetJob.documents.length > 0 ? targetJob.documents[0] : 'manual-upload.pdf';
    const createdAt = new Date().toISOString();
    setEvidenceAiJobs((previous) => [
      {
        id: getNextEntityId(previous, 'EAI'),
        evidenceRef: `evidence://${targetJob.id}/${latestDoc}`,
        model: 'gpt-5-mini',
        status: 'queued',
        extractionSummary: '',
        confidenceScore: 0,
        createdAt,
        completedAt: '',
        reviewDecision: 'pending',
      },
      ...previous,
    ]);
    addToast(`Queued evidence AI extraction for ${targetJob.id}`, 'success');
    return true;
  };

  const advanceEvidenceAiReview = () => {
    let changedRecord = null;
    setEvidenceAiJobs((previous) =>
      previous.map((job) => {
        if (changedRecord) {
          return job;
        }
        if (job.status === 'queued') {
          changedRecord = {
            id: job.id,
            to: 'completed',
          };
          return {
            ...job,
            status: 'completed',
            extractionSummary:
              job.extractionSummary || 'Auto-extracted checklist evidence, detected 2 pass, 1 fail, and 1 advisory.',
            confidenceScore: 0.89,
            completedAt: new Date().toISOString(),
            reviewDecision: 'pending',
          };
        }
        if (job.status === 'completed' && job.reviewDecision === 'pending') {
          changedRecord = {
            id: job.id,
            to: 'accepted',
          };
          return {
            ...job,
            reviewDecision: 'accepted',
          };
        }
        return job;
      })
    );

    if (!changedRecord) {
      addToast('No queued/pending AI evidence jobs to advance', 'info');
      return false;
    }

    addToast(`Evidence AI job ${changedRecord.id} advanced to ${changedRecord.to}`, 'success');
    return true;
  };

  const createRegulatorVerificationRequest = () => {
    const targetArtifact = reportArtifacts[0];
    const now = new Date();
    const due = new Date(now.getTime() + 4 * 24 * 60 * 60 * 1000);
    setRegulatorVerificationRequests((previous) => [
      {
        id: getNextEntityId(previous, 'VRQ'),
        requestor: 'Insurer Desk',
        referenceId: targetArtifact?.id || certificates[0]?.id || 'RPT-PENDING',
        status: 'open',
        requestedAt: now.toISOString(),
        dueAt: due.toISOString(),
        latestEvent: 'Verification request created from operator workflow.',
      },
      ...previous,
    ]);
    addToast('Regulator/insurer verification request created', 'success');
    return true;
  };

  const resolveRegulatorVerificationRequest = () => {
    let resolvedId = '';
    setRegulatorVerificationRequests((previous) =>
      previous.map((request) => {
        if (!resolvedId && request.status === 'open') {
          resolvedId = request.id;
          return {
            ...request,
            status: 'fulfilled',
            latestEvent: 'Evidence bundle verified and response issued.',
          };
        }
        return request;
      })
    );

    if (!resolvedId) {
      addToast('No open verification requests to resolve', 'info');
      return false;
    }
    addToast(`Verification request ${resolvedId} fulfilled`, 'success');
    return true;
  };

  const triggerWebhookRetry = () => {
    let retriedId = '';
    setWebhookDeliveryEvents((previous) =>
      previous.map((event) => {
        if (!retriedId && event.status === 'failed') {
          retriedId = event.id;
          return {
            ...event,
            status: 'delivered',
            attempts: Number(event.attempts || 0) + 1,
            latencyMs: 320,
            lastAttemptAt: new Date().toISOString(),
          };
        }
        return event;
      })
    );

    if (!retriedId) {
      addToast('No failed webhook events to retry', 'info');
      return false;
    }
    addToast(`Webhook delivery ${retriedId} retried and delivered`, 'success');
    return true;
  };

  const openMobileAuditSession = () => {
    const targetJob =
      marketplaceJobs.find((job) => ['assigned', 'in_progress'].includes(job.status) && job.matchedAuditorId) ||
      marketplaceJobs.find((job) => job.matchedAuditorId);
    if (!targetJob) {
      addToast('No matched audit job available for mobile session', 'info');
      return false;
    }

    const matchedAuditor = auditors.find((auditor) => auditor.id === targetJob.matchedAuditorId);
    setMobileAuditSessions((previous) => [
      {
        id: getNextEntityId(previous, 'MAS'),
        jobId: targetJob.id,
        deviceName: `iPhone - ${matchedAuditor?.name || 'Auditor Device'}`,
        attestationStatus: 'verified',
        syncStatus: isOnline ? 'synced' : 'queued',
        startedAt: new Date().toISOString(),
        closedAt: '',
      },
      ...previous,
    ]);

    addToast(`Mobile audit session opened for ${targetJob.id}`, 'success');
    return true;
  };

  const logEnterpriseSecurityEvent = () => {
    const severity = enterpriseSecurityEvents.some((event) => event.severity === 'high') ? 'medium' : 'high';
    setEnterpriseSecurityEvents((previous) => [
      {
        id: getNextEntityId(previous, 'SEC'),
        eventType: severity === 'high' ? 'anomalous_access_attempt' : 'policy_change',
        severity,
        actor: authSession.email || 'debug@incert.local',
        occurredAt: new Date().toISOString(),
      },
      ...previous,
    ]);
    addToast('Enterprise security event logged', 'success');
    return true;
  };

  const startQaHarnessRun = () => {
    const runId = getNextEntityId(qaHarnessRuns, 'QAR');
    const now = new Date().toISOString();
    setQaHarnessRuns((previous) => [
      {
        id: runId,
        suiteName: 'Marketplace + Evidence Integration',
        status: 'running',
        branch: 'main',
        startedAt: now,
        completedAt: '',
        passRate: 0,
      },
      ...previous,
    ]);
    addToast(`QA harness run ${runId} started`, 'success');
    return true;
  };

  const finalizeLatestQaHarnessRun = () => {
    let finalizedRunId = '';
    setQaHarnessRuns((previous) =>
      previous.map((run) => {
        if (!finalizedRunId && run.status === 'running') {
          finalizedRunId = run.id;
          return {
            ...run,
            status: 'passed',
            completedAt: new Date().toISOString(),
            passRate: 100,
          };
        }
        return run;
      })
    );

    if (!finalizedRunId) {
      addToast('No running QA harness run to finalize', 'info');
      return false;
    }
    addToast(`QA harness run ${finalizedRunId} finalized as passed`, 'success');
    return true;
  };

  const advanceReleaseGateResult = () => {
    let advancedId = '';
    let nextStatus = 'pending';
    setReleaseGateResults((previous) =>
      previous.map((gate) => {
        if (advancedId) {
          return gate;
        }
        advancedId = gate.id;
        nextStatus = gate.status === 'pending' ? 'passed' : gate.status === 'passed' ? 'failed' : 'pending';
        return {
          ...gate,
          status: nextStatus,
          evaluatedAt: new Date().toISOString(),
          notes:
            nextStatus === 'passed'
              ? 'Gate passed after latest QA telemetry.'
              : nextStatus === 'failed'
                ? 'Gate failed due to unresolved blocker.'
                : 'Gate reset for next release cycle.',
        };
      })
    );

    if (!advancedId) {
      addToast('No release gate records available', 'info');
      return false;
    }
    addToast(`Release gate ${advancedId} moved to ${nextStatus}`, 'success');
    return true;
  };

  const startAuditRunForMarketplaceJob = (jobId) => {
    const targetJob = marketplaceJobs.find((job) => job.id === jobId);
    if (!targetJob) {
      return null;
    }

    const existingRun = auditRuns.find((run) => run.auditJobId === jobId && run.status === 'in_progress');
    if (existingRun) {
      return existingRun.id;
    }

    const preferredTemplate =
      templateBlueprints.find((template) => template.status === 'published' && template.category === 'HS') ||
      templateBlueprints.find((template) => template.status === 'published') ||
      templateBlueprints[0];

    if (!preferredTemplate) {
      addToast('No template blueprint is available for this audit run', 'info');
      return null;
    }

    return startAuditRun({
      auditJobId: jobId,
      templateId: preferredTemplate.id,
      offlineSyncState: isOnline ? 'synced' : 'queued',
      gpsPolicy: 'optional',
    });
  };

  const recordMarketplaceFinding = (jobId, auditorId, findingPayload) => {
    const targetJob = marketplaceJobs.find((job) => job.id === jobId);
    const targetAuditor = auditors.find((auditor) => auditor.id === auditorId);

    if (!targetJob || !targetAuditor) {
      return false;
    }

    const control = String(findingPayload?.control || 'Checklist finding').trim();
    const notes = String(findingPayload?.notes || '').trim();
    const severity = String(findingPayload?.severity || 'medium').toLowerCase();
    const timelineAt = getTimelineStamp(new Date());
    const findingSummary = notes ? `${control} - ${notes}` : control;

    setMarketplaceJobs((previousJobs) =>
      previousJobs.map((job) =>
        job.id === jobId
          ? {
              ...job,
              timeline: [
                ...job.timeline,
                {
                  label: `Finding logged (${severity}): ${findingSummary}`,
                  at: timelineAt,
                  actor: targetAuditor.name,
                },
              ],
            }
          : job
      )
    );

    const linkedRun =
      auditRuns.find((run) => run.auditJobId === jobId && run.status === 'in_progress') ||
      auditRuns.find((run) => run.auditJobId === jobId);

    if (!linkedRun) {
      return true;
    }

    const taxonomyCode = `${targetJob.regime}-${control}`
      .toUpperCase()
      .replace(/[^A-Z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .slice(0, 28);

    addAuditFinding({
      auditRunId: linkedRun.id,
      severity,
      taxonomyCode: taxonomyCode || 'GENERAL',
      description: findingSummary,
    });

    return true;
  };

  const handleCommandAction = (actionId) => {
    if (actionId === 'go-dashboard') {
      openTab('dashboard');
      return;
    }
    if (actionId === 'go-onboarding') {
      openTab('onboarding');
      return;
    }
    if (actionId === 'go-assets') {
      openTab('assets');
      return;
    }
    if (actionId === 'go-vault') {
      openTab('vault');
      return;
    }
    if (actionId === 'go-providers') {
      openTab('providers');
      return;
    }
    if (actionId === 'go-marketplace') {
      openTab('marketplace');
      return;
    }
    if (actionId === 'go-accountancy') {
      openTab('accountancy');
      return;
    }
    if (actionId === 'go-help') {
      openTab('help');
      return;
    }
    if (actionId === 'go-ops') {
      openTab('ops');
      return;
    }
    if (actionId === 'go-templates') {
      openTab('templates');
      return;
    }
    if (actionId === 'new-asset') {
      setShowCommandPalette(false);
      setShowAddAssetModal(true);
      return;
    }
    if (actionId === 'request-inspection') {
      setShowCommandPalette(false);
      setShowRequestModal(true);
      return;
    }
    if (actionId === 'new-programme') {
      setShowCommandPalette(false);
      setShowProgrammeModal(true);
      return;
    }
    if (actionId === 'scan-lookup') {
      setShowCommandPalette(false);
      setShowScanModal(true);
      return;
    }
    if (actionId === 'export-audit') {
      setShowCommandPalette(false);
      exportAuditPack();
      return;
    }
    if (actionId === 'copy-audit-link') {
      setShowCommandPalette(false);
      addToast('Secure read-only link copied to clipboard!', 'success');
      return;
    }
    if (actionId === 'post-audit-job') {
      setShowCommandPalette(false);
      openTab('marketplace');
      addToast('Open the marketplace composer to advertise an audit job', 'info');
      return;
    }
    if (actionId === 'open-ops-console') {
      setShowCommandPalette(false);
      openTab('ops');
      addToast('Operations console opened', 'info');
    }
  };

  const selectedAssetCertificates = selectedAssetForDetails
    ? certificatesByAsset.get(selectedAssetForDetails.id) || []
    : [];

  if (!authSession.isAuthenticated) {
    return (
      <div className={isDarkMode ? 'dark' : ''}>
        <PublicMarketingLanding
          isDarkMode={isDarkMode}
          onToggleTheme={toggleTheme}
          onAuthenticate={authenticateUser}
          authRuntimeMode={authRuntimeMode}
          isSupabaseConfigured={SUPABASE_ENV_CONFIGURED}
        />
      </div>
    );
  }

  return (
    <div className={isDarkMode ? 'dark' : ''}>
      <style
        dangerouslySetInnerHTML={{
          __html: `
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideUpFade { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes orbFloat { 0%, 100% { transform: translateY(0px) translateX(0px); } 50% { transform: translateY(-16px) translateX(10px); } }
        @keyframes pulseSoft { 0%, 100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.24); } 70% { box-shadow: 0 0 0 12px rgba(6, 182, 212, 0); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes floatIn { from { transform: translateY(24px); opacity: 0; } to { transform: translateY(0px); opacity: 1; } }

        .toast-enter { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .glass-panel { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .float-in { animation: floatIn 0.45s ease-out forwards; }
        .ambient-orb { animation: orbFloat 10s ease-in-out infinite; }
        .pulse-soft { animation: pulseSoft 2.4s ease-out infinite; }
        .shimmer-line {
          background-image: linear-gradient(90deg, rgba(15, 23, 42, 0), rgba(15, 23, 42, 0.1), rgba(15, 23, 42, 0));
          background-size: 200% 100%;
          animation: shimmer 2s linear infinite;
        }
        .dark .shimmer-line {
          background-image: linear-gradient(90deg, rgba(226, 232, 240, 0), rgba(226, 232, 240, 0.12), rgba(226, 232, 240, 0));
        }
        .hover-lift {
          transition: transform 200ms ease, box-shadow 200ms ease;
        }
        .hover-lift:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 28px rgba(15, 23, 42, 0.14);
        }

        .stagger-item { opacity: 0; animation: slideUpFade 0.4s ease-out forwards; }
        .stagger-item:nth-child(1) { animation-delay: 0.05s; }
        .stagger-item:nth-child(2) { animation-delay: 0.1s; }
        .stagger-item:nth-child(3) { animation-delay: 0.15s; }
        .stagger-item:nth-child(4) { animation-delay: 0.2s; }
        .stagger-item:nth-child(5) { animation-delay: 0.25s; }
        .stagger-item:nth-child(6) { animation-delay: 0.3s; }
        .stagger-item:nth-child(n+7) { animation-delay: 0.35s; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(107, 114, 128, 0.8); }
        .dark ::-webkit-scrollbar-thumb { background: rgba(75, 85, 99, 0.5); }
        .dark ::-webkit-scrollbar-thumb:hover { background: rgba(107, 114, 128, 0.8); }
      `,
        }}
      />

      <div className="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50/60 to-emerald-50/60 dark:from-slate-950 dark:via-slate-900 dark:to-slate-900 text-slate-900 dark:text-slate-200 overflow-hidden flex flex-col md:flex-row relative transition-colors duration-300">
        {/* Background Elements */}
        <div className="ambient-orb absolute top-0 -left-10 w-96 h-96 bg-cyan-100 dark:bg-cyan-900/20 rounded-full mix-blend-multiply dark:mix-blend-lighten filter blur-[100px] opacity-60 pointer-events-none transition-colors duration-500" />
        <div className="ambient-orb absolute -bottom-10 right-10 w-96 h-96 bg-emerald-100 dark:bg-emerald-900/20 rounded-full mix-blend-multiply dark:mix-blend-lighten filter blur-[100px] opacity-60 pointer-events-none transition-colors duration-500" />
        <div className="ambient-orb absolute top-1/3 right-1/4 w-72 h-72 bg-amber-100/70 dark:bg-amber-900/10 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-[100px] opacity-40 pointer-events-none transition-colors duration-500" />

        {/* --- MOBILE HEADER --- */}
        <header className="md:hidden glass-panel h-16 bg-white/80 dark:bg-slate-800/80 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-4 fixed inset-x-0 top-0 z-50 w-full transition-colors duration-300">
          <InCertLogo width={138} height={36} className="text-slate-800 dark:text-white" />
          <div className="flex items-center space-x-3">
            <button
              onClick={() => setShowCommandPalette(true)}
              aria-label="Open command palette"
              className="p-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 transition-colors"
            >
              <Command className="h-5 w-5" />
            </button>
            <button
              onClick={() => setShowScanModal(true)}
              aria-label="Scan QR code"
              className="p-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 transition-colors"
            >
              <ScanLine className="h-5 w-5" />
            </button>
            <button
              onClick={toggleTheme}
              aria-label="Toggle theme"
              className="p-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 transition-colors"
            >
              {isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
            </button>
            <button
              onClick={signOutUser}
              aria-label="Sign out"
              className="p-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 transition-colors"
            >
              <LogOut className="h-5 w-5" />
            </button>
            <button
              onClick={() => setShowMobileQuickPanel((previous) => !previous)}
              aria-label="Open quick actions"
              className="p-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 transition-colors"
            >
              <Zap className="h-5 w-5" />
            </button>
            <div className="relative">
              <button
                onClick={() => setShowNotifications((previous) => !previous)}
                aria-label="Open notifications"
                className="p-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 transition-colors"
              >
                <Bell className="h-5 w-5" />
                <span className="absolute top-1 right-1 w-2 h-2 bg-rose-500 rounded-full border-2 border-white dark:border-slate-800" />
              </button>
            </div>
          </div>
        </header>

        {/* --- DESKTOP SIDEBAR --- */}
        <aside className="hidden md:flex w-64 glass-panel bg-white/80 dark:bg-slate-800/80 border-r border-slate-200 dark:border-slate-700 flex-col z-30 h-screen transition-colors duration-300">
          <div className="px-6 pt-6 pb-3 space-y-3">
            <InCertLogo width={176} height={44} className="text-slate-800 dark:text-white" />
            <p className="text-[10px] font-semibold uppercase tracking-[0.14em] text-slate-400 dark:text-slate-500">
              Navigation
            </p>
          </div>

          <nav className="flex-1 px-4 space-y-2 mt-4">
            {allowedTabsForRole.includes('dashboard') && (
              <DesktopNavItem
                icon={<LayoutDashboard />}
                label="Dashboard"
                isActive={activeTab === 'dashboard'}
                onClick={() => openTab('dashboard')}
              />
            )}
            {allowedTabsForRole.includes('onboarding') && (
              <DesktopNavItem
                icon={<Building2 />}
                label="Onboarding"
                isActive={activeTab === 'onboarding'}
                onClick={() => openTab('onboarding')}
              />
            )}
            {allowedTabsForRole.includes('assets') && (
              <DesktopNavItem
                icon={<Box />}
                label="Asset Register"
                isActive={activeTab === 'assets'}
                onClick={() => openTab('assets')}
              />
            )}
            {allowedTabsForRole.includes('vault') && (
              <DesktopNavItem
                icon={<Lock />}
                label="Evidence Vault"
                isActive={activeTab === 'vault'}
                onClick={() => openTab('vault')}
              />
            )}
            {allowedTabsForRole.includes('providers') && (
              <DesktopNavItem
                icon={<Users />}
                label="Provider Network"
                isActive={activeTab === 'providers'}
                onClick={() => openTab('providers')}
              />
            )}
            {allowedTabsForRole.includes('marketplace') && (
              <DesktopNavItem
                icon={<ClipboardList />}
                label="Audit Marketplace"
                isActive={activeTab === 'marketplace'}
                onClick={() => openTab('marketplace')}
              />
            )}
            {allowedTabsForRole.includes('accountancy') && (
              <DesktopNavItem
                icon={<BarChart3 />}
                label="Accountancy"
                isActive={activeTab === 'accountancy'}
                onClick={() => openTab('accountancy')}
              />
            )}
            {allowedTabsForRole.includes('ops') && (
              <DesktopNavItem
                icon={<ServerCog />}
                label="Operations"
                isActive={activeTab === 'ops'}
                onClick={() => openTab('ops')}
              />
            )}
            {allowedTabsForRole.includes('templates') && (
              <DesktopNavItem
                icon={<FileSignature />}
                label="Templates"
                isActive={activeTab === 'templates'}
                onClick={() => openTab('templates')}
              />
            )}
            {allowedTabsForRole.includes('help') && (
              <DesktopNavItem
                icon={<FileText />}
                label="Help"
                isActive={activeTab === 'help'}
                onClick={() => openTab('help')}
              />
            )}
          </nav>

          <div className="p-4 mx-4 mb-4 rounded-xl bg-slate-100 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 relative overflow-hidden transition-colors duration-300">
            <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 relative z-10">Current Estate</p>
            <div className="flex items-center space-x-2 text-sm text-slate-800 dark:text-white font-medium relative z-10">
              <div className="w-8 h-8 rounded-full bg-cyan-600 text-white flex items-center justify-center text-xs shadow-sm">
                {activeCompanyInitials}
              </div>
              <span>{activeCompanyContext.name}</span>
            </div>
            <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-2 relative z-10 truncate">
              Signed in as {authSession.fullName || authSession.email}
            </p>
            <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1 relative z-10">
              Debug role: {effectiveRoleLabel}
            </p>
          </div>
        </aside>

        {/* --- MAIN CONTENT AREA --- */}
        <main className="flex-1 flex flex-col h-screen md:h-screen pt-16 md:pt-0 overflow-hidden relative z-20">
          {/* Desktop Header */}
          <header className="hidden md:flex h-20 glass-panel bg-white/80 dark:bg-slate-800/80 border-b border-slate-200 dark:border-slate-700 items-center justify-between px-8 sticky top-0 z-30 transition-colors duration-300">
            <div className="flex items-center">
              <h1 className="text-2xl font-bold text-slate-800 dark:text-white capitalize tracking-wide">
                {activeTab.replace(/([A-Z])/g, ' $1').trim()}
              </h1>
            </div>
            <div className="flex items-center space-x-4">
              <div className="relative group">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400 dark:text-slate-500 group-focus-within:text-cyan-500 transition-colors" />
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(event) => setSearchQuery(event.target.value)}
                  placeholder={`Search ${activeTab}...`}
                  className="pl-10 pr-4 py-2.5 bg-white dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:bg-white dark:focus:bg-slate-800 focus:border-cyan-500 dark:focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all w-72 text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 shadow-sm"
                />
              </div>

              <button
                onClick={() => setShowCommandPalette(true)}
                className="px-3 py-2.5 text-slate-500 hover:text-slate-800 dark:text-slate-400 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-sm flex items-center gap-2 text-xs font-bold"
              >
                <Command className="h-4 w-4" />
                <span>Quick Actions</span>
                <span className="px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-[10px] font-mono">âK</span>
              </button>

              <button
                onClick={() => setShowScanModal(true)}
                aria-label="Scan QR code"
                className="p-2.5 text-slate-500 hover:text-slate-800 dark:text-slate-400 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-sm"
              >
                <ScanLine className="h-5 w-5" />
              </button>

              <button
                onClick={toggleTheme}
                aria-label="Toggle theme"
                className="p-2.5 text-slate-500 hover:text-slate-800 dark:text-slate-400 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-sm"
              >
                {isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
              </button>

              <button
                onClick={signOutUser}
                aria-label="Sign out"
                className="px-3 py-2.5 text-slate-500 hover:text-slate-800 dark:text-slate-400 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-sm flex items-center gap-2 text-xs font-bold"
              >
                <LogOut className="h-4 w-4" />
                <span>Sign out</span>
              </button>

              <div className="relative">
                <button
                  onClick={() => setShowNotifications((previous) => !previous)}
                  aria-label="Open notifications"
                  className="p-2.5 text-slate-500 hover:text-slate-800 dark:text-slate-400 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-sm"
                >
                  <Bell className="h-5 w-5" />
                  <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-rose-500 rounded-full border-2 border-white dark:border-slate-800" />
                </button>
                {/* Notifications Dropdown */}
                {showNotifications && (
                  <div className="absolute right-0 mt-3 w-80 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-xl overflow-hidden z-50 animate-in fade-in slide-in-from-top-2">
                    <div className="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                      <h3 className="font-bold text-slate-800 dark:text-white text-sm">Notifications</h3>
                    </div>
                    <div className="divide-y divide-slate-100 dark:divide-slate-700 max-h-80 overflow-y-auto">
                      <div className="p-4 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors cursor-pointer">
                        <div className="flex space-x-3">
                          <AlertTriangle className="w-5 h-5 text-amber-500 shrink-0" />
                          <div>
                            <p className="text-sm font-medium text-slate-800 dark:text-white leading-tight">
                              Pallet Stacker Due
                            </p>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                              Inspection required within 14 days (PUWER).
                            </p>
                          </div>
                        </div>
                      </div>
                      <div className="p-4 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors cursor-pointer">
                        <div className="flex space-x-3">
                          <CheckCircle2 className="w-5 h-5 text-emerald-500 shrink-0" />
                          <div>
                            <p className="text-sm font-medium text-slate-800 dark:text-white leading-tight">
                              New Certificate Verified
                            </p>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                              Air Compressor PSSR certificate uploaded.
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </header>

          <div className="border-b border-amber-200/80 dark:border-amber-800/50 bg-amber-50/80 dark:bg-amber-900/15 px-4 md:px-8 py-2.5">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="text-[11px] font-bold uppercase tracking-wider text-amber-700 dark:text-amber-300">
                  Debug View
                </span>
                <div className="inline-flex rounded-lg border border-amber-200 dark:border-amber-800/40 overflow-hidden">
                  {USER_ROLE_OPTIONS.map((roleOption) => (
                    <button
                      key={roleOption.id}
                      type="button"
                      onClick={() => switchDebugRole(roleOption.id)}
                      className={`px-2.5 py-1.5 text-[11px] font-bold transition-colors ${
                        effectiveUserRole === roleOption.id
                          ? 'bg-amber-500 text-white'
                          : 'bg-white dark:bg-slate-900/40 text-amber-700 dark:text-amber-300'
                      }`}
                    >
                      {roleOption.label}
                    </button>
                  ))}
                </div>
              </div>
              <p className="text-[11px] text-amber-700/90 dark:text-amber-200/90">
                Role-based UI simulation. Auth runtime: {authRuntimeMode === 'supabase' ? 'Supabase live' : 'Mock'}.
              </p>
            </div>
          </div>

          {/* Dynamic Content Scroll Area */}
          <div
            className="flex-1 overflow-y-auto p-4 md:p-8 pb-28 md:pb-10 scroll-smooth"
            onClick={() => showNotifications && setShowNotifications(false)}
          >
            <div
              className={`transition-all duration-700 ease-out space-y-8 ${
                isLoaded ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
              }`}
            >
              <ConnectivityBanner isOnline={isOnline} queuedCount={queuedInspectionCount} />

              {(activeTab === 'dashboard' || activeTab === 'assets') && (
                <OfflineInspectionPanel
                  assets={enrichedAssets}
                  logs={inspectionLogs}
                  isOnline={isOnline}
                  pendingCount={queuedInspectionCount}
                  onSubmit={handleLogInspection}
                />
              )}

              {activeTab === 'onboarding' && (
                <OnboardingPortalView
                  onNotify={addToast}
                  onboardingTasks={onboardingTasks}
                  onToggleOnboardingTask={toggleOnboardingTask}
                  onOpenMarketplace={() => openTab('marketplace')}
                />
              )}

              {activeTab === 'dashboard' && (
                <DashboardView
                  assets={enrichedAssets}
                  urgentAssets={urgentAssets}
                  upcomingAssets={upcomingAssets}
                  complianceTrend={complianceTrend}
                  programmeCount={recurringProgrammes.length}
                  onAction={(action) => {
                    if (action === 'request') {
                      setShowRequestModal(true);
                    }
                    if (action === 'programme') {
                      setShowProgrammeModal(true);
                    }
                    if (action === 'export') {
                      exportAuditPack();
                    }
                  }}
                />
              )}

              {activeTab === 'assets' && (
                <AssetRegisterView
                  assets={enrichedAssets}
                  searchQuery={searchQuery}
                  onAdd={() => setShowAddAssetModal(true)}
                  onViewAsset={setSelectedAssetForDetails}
                />
              )}

              {activeTab === 'vault' && (
                <EvidenceVaultView
                  certificates={enrichedCertificates}
                  searchQuery={searchQuery}
                  onLinkGen={() => addToast('Secure read-only link copied to clipboard!', 'success')}
                  onUploadComplete={(filename) => addToast(`Uploaded ${filename} to evidence intake`, 'success')}
                  focusCertificateId={vaultFocusCertificateId}
                  onFocusHandled={() => setVaultFocusCertificateId('')}
                />
              )}

              {activeTab === 'providers' && (
                <ProviderNetworkView
                  providers={activeProviderRecords}
                  searchQuery={searchQuery}
                  onDispatch={openDispatch}
                />
              )}

              {activeTab === 'marketplace' && (
                <MarketplaceExchangeView
                  assets={enrichedAssets}
                  auditors={activeProviderRecords}
                  jobs={marketplaceJobs}
                  auditRuns={auditRuns}
                  reportArtifacts={reportArtifacts}
                  inspectionTemplates={inspectionTemplates}
                  companyContext={activeCompanyContext}
                  debugRole={effectiveUserRole}
                  searchQuery={searchQuery}
                  onCreateJob={createMarketplaceJob}
                  onDispatchJob={dispatchMarketplaceJob}
                  onAcceptOffer={acceptMarketplaceOffer}
                  onStartJob={startMarketplaceAudit}
                  onUploadDocuments={uploadMarketplaceDocuments}
                  onCompleteJob={completeMarketplaceAudit}
                  onSubmitExternalForReview={submitMarketplaceExternalAuditForReview}
                  onReviewExternalAudit={reviewMarketplaceExternalAudit}
                  onApplyAdjustment={applyMarketplaceAdjustment}
                  onStartAuditRunForJob={startAuditRunForMarketplaceJob}
                  onRecordFinding={recordMarketplaceFinding}
                  onReassignJob={reassignMarketplaceJob}
                  onDownloadReportArtifact={downloadReportArtifactHtml}
                  onSaveReportArtifactToVault={saveReportArtifactToEvidenceVault}
                />
              )}

              {activeTab === 'accountancy' && (
                <AccountancyView
                  accountancyMode={accountancyScope.mode}
                  accountancyEntityLabel={accountancyScope.label}
                  financeInvoices={scopedFinanceInvoices}
                  payoutRuns={scopedPayoutRuns}
                  canPayInvoice={canViewerPayInvoice}
                  showDebugScopeSelector={Boolean(accountancyDebugScopeConfig)}
                  debugScopeLabel={accountancyDebugScopeConfig?.label || 'Account'}
                  debugScopeOptions={accountancyDebugScopeConfig?.options || []}
                  debugScopeValue={accountancyDebugScopeConfig?.value || ''}
                  onDebugScopeChange={accountancyDebugScopeConfig?.onChange}
                  onGenerateInvoices={canManageInCertAccountancy ? generateMissingInvoices : undefined}
                  onApproveInvoice={canManageInCertAccountancy
                    ? (invoiceId) => {
                        const scopedInvoice = ensureScopedInvoiceForAccountancy(invoiceId);
                        if (!scopedInvoice) {
                          return false;
                        }
                        return approveInvoice(invoiceId);
                      }
                    : undefined}
                  onIssueInvoice={canManageInCertAccountancy
                    ? (invoiceId) => {
                        const scopedInvoice = ensureScopedInvoiceForAccountancy(invoiceId);
                        if (!scopedInvoice) {
                          return false;
                        }
                        return issueInvoice(invoiceId);
                      }
                    : undefined}
                  onSendInvoiceReminder={canManageInCertAccountancy
                    ? (invoiceId) => {
                        const scopedInvoice = ensureScopedInvoiceForAccountancy(invoiceId);
                        if (!scopedInvoice) {
                          return false;
                        }
                        return sendInvoiceReminder(invoiceId);
                      }
                    : undefined}
                  onMarkInvoiceCollected={
                    canManageInCertAccountancy || canRolePayInvoices
                      ? (invoiceId) => {
                          const scopedInvoice = ensureScopedInvoiceForAccountancy(invoiceId, {
                            requirePayable: !canManageInCertAccountancy,
                          });
                          if (!scopedInvoice) {
                            return false;
                          }
                          return canManageInCertAccountancy
                            ? markInvoiceCollected(invoiceId)
                            : markInvoicePaidByCompany(invoiceId);
                        }
                      : undefined
                  }
                  onRunCollectionsSweep={canManageInCertAccountancy ? runInvoiceCollectionsSweep : undefined}
                  onSchedulePayout={canManageInCertAccountancy
                    ? (invoiceId) => {
                        const scopedInvoice = ensureScopedInvoiceForAccountancy(invoiceId);
                        if (!scopedInvoice) {
                          return false;
                        }
                        return schedulePayoutForInvoice(invoiceId);
                      }
                    : undefined}
                  onConfirmPayoutRun={canManageInCertAccountancy
                    ? (runId) => {
                        const scopedRun = ensureScopedPayoutRunForAccountancy(runId);
                        if (!scopedRun) {
                          return false;
                        }
                        return confirmPayoutRunForPayment(runId);
                      }
                    : undefined}
                  onMarkPayoutPaid={canManageInCertAccountancy
                    ? (runId) => {
                        const scopedRun = ensureScopedPayoutRunForAccountancy(runId);
                        if (!scopedRun) {
                          return false;
                        }
                        return markPayoutRunPaid(runId);
                      }
                    : undefined}
                  onExportCsv={exportScopedAccountancyCsv}
                  showDebugBulkActions={isDebugBypassSession && canManageInCertAccountancy}
                  onCollectReceivablesMonthDebug={canManageInCertAccountancy ? markInvoicesCollectedForMonth : undefined}
                  onPayProvidersMonthDebug={canManageInCertAccountancy ? markPayoutRunsPaidForMonth : undefined}
                  onCollectReceivablesYearDebug={canManageInCertAccountancy ? markAllInvoicesCollectedDebug : undefined}
                  onPayProvidersYearDebug={canManageInCertAccountancy ? markAllPayoutRunsPaidDebug : undefined}
                  onAlignPayoutsToCollectionsDebug={canManageInCertAccountancy ? alignDebugPayoutsToCollections : undefined}
                />
              )}

              {activeTab === 'ops' && (
                <div className="space-y-5">
                  <OperationsCenterView
                    isSupabaseConfigured={SUPABASE_ENV_CONFIGURED}
                    authRuntimeMode={authRuntimeMode}
                    onSetAuthRuntimeMode={setRuntimeAuthMode}
                    tenantInvites={tenantInvites}
                    onCreateTenantInvite={createTenantInvite}
                    onAcceptTenantInvite={acceptNextTenantInvite}
                    marketplaceBidBoard={marketplaceBidBoard}
                    dispatchSlaEvents={dispatchSlaEvents}
                    onSeedBidRound={seedMarketplaceBidRound}
                    onAwardBestBid={awardBestMarketplaceBid}
                    templateBlueprints={templateBlueprints}
                    onPublishTemplateBlueprint={publishTemplateBlueprint}
                    evidenceAiJobs={evidenceAiJobs}
                    evidenceProvenanceEvents={evidenceProvenanceEvents}
                    onQueueEvidenceAiJob={enqueueEvidenceAiExtraction}
                    onAdvanceEvidenceReview={advanceEvidenceAiReview}
                    onAppendProvenanceEvent={appendEvidenceProvenanceEvent}
                    regulatorVerificationRequests={regulatorVerificationRequests}
                    onCreateVerificationRequest={createRegulatorVerificationRequest}
                    onResolveVerificationRequest={resolveRegulatorVerificationRequest}
                    auditFindings={auditFindings}
                    auditActions={auditActions}
                    onCreateAuditAction={() => {
                      const targetFinding = auditFindings[0];
                      if (!targetFinding) {
                        addToast('Create a finding first before creating CAPA actions', 'info');
                        return false;
                      }
                      return createAuditAction({
                        findingId: targetFinding.id,
                        assignee: 'Site Manager',
                        dueDate: getDefaultActionDueDate(targetFinding.severity),
                        evidenceRequired: true,
                        closureSignoff: 'auditor',
                      });
                    }}
                    onAdvanceAuditActionStatus={advanceAuditActionStatus}
                    financeInvoices={financeInvoices}
                    payoutRuns={payoutRuns}
                    onGenerateInvoices={generateMissingInvoices}
                    onSchedulePayout={schedulePayoutForInvoice}
                    analyticsRiskSignals={analyticsRiskSignals}
                    integrationConnections={integrationConnections}
                    apiClients={apiClients}
                    webhookEndpoints={webhookEndpoints}
                    webhookDeliveryEvents={webhookDeliveryEvents}
                    onCreateApiClient={createApiClient}
                    onRotateApiClientSecret={rotateApiClientSecret}
                    onCreateWebhookEndpoint={upsertWebhookEndpoint}
                    onTriggerWebhookRetry={triggerWebhookRetry}
                    mobileAuditSessions={mobileAuditSessions}
                    onOpenMobileSession={openMobileAuditSession}
                    enterpriseSsoProviders={enterpriseSsoProviders}
                    enterpriseAccessPolicies={enterpriseAccessPolicies}
                    enterpriseSecurityEvents={enterpriseSecurityEvents}
                    onConfigureSsoProvider={configureEnterpriseSsoProvider}
                    onToggleEnterprisePolicy={toggleEnterpriseAccessPolicy}
                    onLogSecurityEvent={logEnterpriseSecurityEvent}
                    qaHarnessRuns={qaHarnessRuns}
                    releaseGateResults={releaseGateResults}
                    onStartQaHarnessRun={startQaHarnessRun}
                    onFinalizeQaHarnessRun={finalizeLatestQaHarnessRun}
                    onAdvanceReleaseGateResult={advanceReleaseGateResult}
                  />

                  <HelpCenterView
                    onNotify={addToast}
                    isInCertAdmin={effectiveUserRole === 'incert'}
                    jobs={marketplaceJobs}
                    certificates={enrichedCertificates}
                    publicSiteConfig={publicSiteConfig}
                    onboardingTasks={onboardingTasks}
                    financeInvoices={financeInvoices}
                    payoutRuns={payoutRuns}
                    inspectionTemplates={inspectionTemplates}
                    companyContext={activeCompanyContext}
                    integrationConnections={integrationConnections}
                    templateBlueprints={templateBlueprints}
                    templateListings={templateListings}
                    licenceGrants={licenceGrants}
                    auditRuns={auditRuns}
                    auditFindings={auditFindings}
                    auditActions={auditActions}
                    reportArtifacts={reportArtifacts}
                    shareLinks={shareLinks}
                    marketplaceBidBoard={marketplaceBidBoard}
                    dispatchSlaEvents={dispatchSlaEvents}
                    evidenceAiJobs={evidenceAiJobs}
                    regulatorVerificationRequests={regulatorVerificationRequests}
                    analyticsRiskSignals={analyticsRiskSignals}
                    webhookDeliveryEvents={webhookDeliveryEvents}
                    mobileAuditSessions={mobileAuditSessions}
                    enterpriseSecurityEvents={enterpriseSecurityEvents}
                    qaHarnessRuns={qaHarnessRuns}
                    releaseGateResults={releaseGateResults}
                    onUpdatePublicSiteConfig={updatePublicSiteConfig}
                    onToggleOnboardingTask={toggleOnboardingTask}
                    onRunPilotFulfilmentLoop={runPilotFulfilmentLoop}
                    onSignCertificate={signCertificateFromTrustLayer}
                    onGenerateInvoices={generateMissingInvoices}
                    onApproveInvoice={approveInvoice}
                    onSchedulePayout={schedulePayoutForInvoice}
                    onAddTemplate={addInspectionTemplate}
                    onToggleTemplate={toggleInspectionTemplate}
                    onConnectIntegration={connectIntegration}
                    onCreateTemplateBlueprint={createTemplateBlueprint}
                    onUpdateTemplateBlueprint={updateTemplateBlueprintQuestionBank}
                    onPublishTemplateBlueprint={publishTemplateBlueprint}
                    onCreateTemplateListing={createTemplateListing}
                    onGrantTemplateLicence={grantTemplateLicence}
                    onStartAuditRun={startAuditRun}
                    onCompleteAuditRun={completeAuditRun}
                    onAddAuditFinding={addAuditFinding}
                    onCreateAuditAction={createAuditAction}
                    onAdvanceAuditActionStatus={advanceAuditActionStatus}
                    onCreateShareLink={createShareLinkForArtifact}
                    onSeedBidRound={seedMarketplaceBidRound}
                    onAwardBestBid={awardBestMarketplaceBid}
                    onQueueEvidenceAiJob={enqueueEvidenceAiExtraction}
                    onAdvanceEvidenceReview={advanceEvidenceAiReview}
                    onCreateVerificationRequest={createRegulatorVerificationRequest}
                    onResolveVerificationRequest={resolveRegulatorVerificationRequest}
                    onTriggerWebhookRetry={triggerWebhookRetry}
                    onOpenMobileSession={openMobileAuditSession}
                    onLogSecurityEvent={logEnterpriseSecurityEvent}
                    onStartQaHarnessRun={startQaHarnessRun}
                    onFinalizeQaHarnessRun={finalizeLatestQaHarnessRun}
                    onAdvanceReleaseGateResult={advanceReleaseGateResult}
                  />
                </div>
              )}

              {activeTab === 'templates' && (
                <TemplateStudioView
                  onNotify={addToast}
                  isInCertAdmin={effectiveUserRole === 'incert'}
                  templateBlueprints={templateBlueprints}
                  onPublishTemplateBlueprint={publishTemplateBlueprint}
                  onUpdateTemplateBlueprint={updateTemplateBlueprintQuestionBank}
                />
              )}

              {activeTab === 'help' && (
                <SupportHelpView
                  onNotify={addToast}
                  isInCertAdmin={effectiveUserRole === 'incert'}
                  onOpenOps={() => openTab('ops')}
                  onOpenTemplates={() => openTab('templates')}
                />
              )}

              <AppFooter
                onOpenHelp={() => openTab('help')}
                onPrivacy={() => addToast('Privacy policy placeholder', 'info')}
                onTerms={() => addToast('Terms placeholder', 'info')}
              />
            </div>
          </div>
        </main>

        {showMobileQuickPanel && (
          <div className="md:hidden fixed inset-0 z-[70] bg-slate-900/35 backdrop-blur-sm" onClick={() => setShowMobileQuickPanel(false)}>
            <div
              className="absolute left-3 right-3 bottom-24 p-4 bg-white/95 dark:bg-slate-800/95 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-soft float-in"
              onClick={(event) => event.stopPropagation()}
            >
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-1">
                <Sparkles className="w-3.5 h-3.5 text-cyan-500" />
                Quick Actions
              </p>
              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={() => {
                    setShowMobileQuickPanel(false);
                    setShowAddAssetModal(true);
                  }}
                  className="rounded-xl bg-cyan-600 text-white px-3 py-2.5 text-sm font-bold"
                >
                  Add Asset
                </button>
                <button
                  onClick={() => {
                    setShowMobileQuickPanel(false);
                    setShowRequestModal(true);
                  }}
                  className="rounded-xl bg-emerald-600 text-white px-3 py-2.5 text-sm font-bold"
                >
                  Dispatch
                </button>
                <button
                  onClick={() => {
                    setShowMobileQuickPanel(false);
                    setShowCommandPalette(true);
                  }}
                  className="rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-100 px-3 py-2.5 text-sm font-bold"
                >
                  Search
                </button>
                <button
                  onClick={() => {
                    setShowMobileQuickPanel(false);
                    openTab('onboarding');
                  }}
                  className="rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-100 px-3 py-2.5 text-sm font-bold"
                >
                  Onboard
                </button>
                <button
                  onClick={() => {
                    setShowMobileQuickPanel(false);
                    exportAuditPack();
                  }}
                  className="rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-100 px-3 py-2.5 text-sm font-bold"
                >
                  Export
                </button>
                <button
                  onClick={() => {
                    setShowMobileQuickPanel(false);
                    openTab('ops');
                  }}
                  className="rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-100 px-3 py-2.5 text-sm font-bold"
                >
                  Ops
                </button>
                <button
                  onClick={() => {
                    setShowMobileQuickPanel(false);
                    setShowScanModal(true);
                  }}
                  className="rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-100 px-3 py-2.5 text-sm font-bold"
                >
                  Scan QR
                </button>
              </div>
            </div>
          </div>
        )}

        {/* --- MOBILE BOTTOM NAVIGATION --- */}
        <nav
          className="md:hidden glass-panel bg-white/90 dark:bg-slate-800/90 border-t border-slate-200 dark:border-slate-700 fixed bottom-0 w-full z-50 px-2 py-3 grid items-center pb-safe transition-colors duration-300"
          style={{
            gridTemplateColumns: `repeat(${Math.max(
              2,
              ['dashboard', 'assets', 'vault', 'providers', 'marketplace', 'accountancy', 'ops', 'templates', 'help'].filter((tab) =>
                allowedTabsForRole.includes(tab)
              ).length
            )}, minmax(0, 1fr))`,
          }}
        >
          {allowedTabsForRole.includes('dashboard') && (
            <MobileNavItem
              icon={<LayoutDashboard />}
              label="Dash"
              isActive={activeTab === 'dashboard'}
              onClick={() => openTab('dashboard')}
            />
          )}
          {allowedTabsForRole.includes('assets') && (
            <MobileNavItem
              icon={<Box />}
              label="Assets"
              isActive={activeTab === 'assets'}
              onClick={() => openTab('assets')}
            />
          )}
          {allowedTabsForRole.includes('vault') && (
            <MobileNavItem
              icon={<Lock />}
              label="Vault"
              isActive={activeTab === 'vault'}
              onClick={() => openTab('vault')}
            />
          )}
          {allowedTabsForRole.includes('providers') && (
            <MobileNavItem
              icon={<Users />}
              label="Network"
              isActive={activeTab === 'providers'}
              onClick={() => openTab('providers')}
            />
          )}
          {allowedTabsForRole.includes('marketplace') && (
            <MobileNavItem
              icon={<ClipboardList />}
              label="Market"
              isActive={activeTab === 'marketplace'}
              onClick={() => openTab('marketplace')}
            />
          )}
          {allowedTabsForRole.includes('accountancy') && (
            <MobileNavItem
              icon={<BarChart3 />}
              label="Accounts"
              isActive={activeTab === 'accountancy'}
              onClick={() => openTab('accountancy')}
            />
          )}
          {allowedTabsForRole.includes('ops') && (
            <MobileNavItem
              icon={<ServerCog />}
              label="Ops"
              isActive={activeTab === 'ops'}
              onClick={() => openTab('ops')}
            />
          )}
          {allowedTabsForRole.includes('templates') && (
            <MobileNavItem
              icon={<FileSignature />}
              label="Tpls"
              isActive={activeTab === 'templates'}
              onClick={() => openTab('templates')}
            />
          )}
          {allowedTabsForRole.includes('help') && (
            <MobileNavItem
              icon={<FileText />}
              label="Help"
              isActive={activeTab === 'help'}
              onClick={() => openTab('help')}
            />
          )}
        </nav>

        {/* --- GLOBAL COMPONENTS (MODALS, DRAWERS & TOASTS) --- */}

        {/* Toast Container */}
        <div className="fixed bottom-20 md:bottom-8 right-4 md:right-8 z-[150] flex flex-col space-y-3 pointer-events-none">
          {toasts.map((toast) => (
            <div
              key={toast.id}
              className="toast-enter pointer-events-auto flex items-center space-x-3 bg-slate-900 dark:bg-slate-800 text-white p-4 rounded-xl shadow-2xl border border-slate-700 w-80"
            >
              {toast.type === 'success' ? (
                <CheckCircle2 className="w-5 h-5 text-emerald-400 shrink-0" />
              ) : (
                <Info className="w-5 h-5 text-blue-400 shrink-0" />
              )}
              <p className="text-sm font-medium">{toast.message}</p>
            </div>
          ))}
        </div>

        <CommandPalette
          isOpen={showCommandPalette}
          onClose={() => setShowCommandPalette(false)}
          onAction={handleCommandAction}
        />

        <ScanLookupModal
          isOpen={showScanModal}
          onClose={() => setShowScanModal(false)}
          onResolve={handleScanLookup}
        />

        {assetForQrLabel && (
          <AssetQrLabelModal
            asset={assetForQrLabel}
            latestCertificate={certificatesByAsset.get(assetForQrLabel.id)?.[0] || null}
            certificateCount={(certificatesByAsset.get(assetForQrLabel.id) || []).length}
            onClose={() => setAssetForQrLabel(null)}
            onNotify={(message, type) => addToast(message, type)}
          />
        )}

        {/* Asset Details Drawer (Slide-out from Right) */}
        {selectedAssetForDetails && (
          <div className="fixed inset-0 z-[100] flex justify-end bg-slate-900/40 dark:bg-slate-900/60 backdrop-blur-sm transition-opacity">
            <div className="absolute inset-0" onClick={() => setSelectedAssetForDetails(null)} />
            <div className="w-full md:w-96 h-full bg-white dark:bg-slate-800 shadow-2xl flex flex-col relative z-10 animate-in slide-in-from-right duration-300 border-l border-slate-200 dark:border-slate-700">
              {/* Drawer Header */}
              <div className="p-6 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-start">
                <div>
                  <div className="flex items-center space-x-2 mb-2">
                    <Box className="w-5 h-5 text-cyan-500" />
                    <span className="text-xs font-bold text-slate-500 dark:text-slate-400 font-mono tracking-wider">
                      {selectedAssetForDetails.id}
                    </span>
                  </div>
                  <h3 className="text-xl font-bold text-slate-800 dark:text-white leading-tight">
                    {selectedAssetForDetails.name}
                  </h3>
                </div>
                <button
                  onClick={() => setSelectedAssetForDetails(null)}
                  aria-label="Close asset details"
                  className="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 bg-white dark:bg-slate-700 rounded-full border border-slate-200 dark:border-slate-600 shadow-sm"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>

              {/* Drawer Body */}
              <div className="flex-1 overflow-y-auto p-6 space-y-8">
                {/* Status Card */}
                <div className="bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-700 rounded-2xl p-5">
                  <div className="flex justify-between items-center mb-4">
                    <span className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Current Status
                    </span>
                    <StatusPill status={selectedAssetForDetails.status} />
                  </div>
                  <div className="flex items-center space-x-3 text-slate-800 dark:text-white mb-2">
                    <Calendar className="w-5 h-5 text-cyan-500 opacity-70" />
                    <span className="font-bold text-lg">
                      Next Due: {formatDateLabel(selectedAssetForDetails.nextDue)}
                    </span>
                  </div>
                </div>

                {/* Properties */}
                <div>
                  <h4 className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 flex items-center">
                    <Settings className="w-4 h-4 mr-1" /> Asset Properties
                  </h4>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3 shadow-sm">
                      <span className="text-[10px] uppercase font-bold text-slate-500 block mb-1">
                        Site Location
                      </span>
                      <span className="font-medium text-slate-800 dark:text-white text-sm">
                        {selectedAssetForDetails.site}
                      </span>
                    </div>
                    <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3 shadow-sm">
                      <span className="text-[10px] uppercase font-bold text-slate-500 block mb-1">
                        Statutory Regime
                      </span>
                      <span className="font-medium text-cyan-600 dark:text-cyan-400 text-sm">
                        {selectedAssetForDetails.regime}
                      </span>
                    </div>
                    <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3 shadow-sm col-span-2">
                      <span className="text-[10px] uppercase font-bold text-slate-500 block mb-1">
                        Equipment Class
                      </span>
                      <span className="font-medium text-slate-800 dark:text-white text-sm">
                        {selectedAssetForDetails.class}
                      </span>
                    </div>
                  </div>
                </div>

                {/* History Timeline */}
                <div>
                  <h4 className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-4 flex items-center">
                    <History className="w-4 h-4 mr-1" /> Inspection History
                  </h4>
                  <div className="relative pl-4 border-l-2 border-slate-200 dark:border-slate-700 space-y-6">
                    <div className="relative">
                      <div className="absolute -left-[21px] top-1 w-3 h-3 bg-emerald-500 rounded-full ring-4 ring-white dark:ring-slate-800" />
                      <p className="text-sm font-bold text-slate-800 dark:text-white">Passed Inspection</p>
                      <p className="text-xs text-slate-500 mt-1">Provider: Bureau Veritas UK</p>
                      <p className="text-[10px] text-slate-400 mt-0.5">Aug 10, 2024</p>
                    </div>
                    <div className="relative">
                      <div className="absolute -left-[21px] top-1 w-3 h-3 bg-cyan-500 rounded-full ring-4 ring-white dark:ring-slate-800" />
                      <p className="text-sm font-bold text-slate-800 dark:text-white">Added to Register</p>
                      <p className="text-xs text-slate-500 mt-1">System Import</p>
                      <p className="text-[10px] text-slate-400 mt-0.5">Jan 15, 2024</p>
                    </div>
                  </div>
                </div>

                <div>
                  <h4 className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 flex items-center">
                    <FileSignature className="w-4 h-4 mr-1" /> Previous Certificates
                  </h4>
                  {selectedAssetCertificates.length === 0 ? (
                    <div className="rounded-xl border border-dashed border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900/30 p-4">
                      <p className="text-xs text-slate-500 dark:text-slate-400">
                        No certificate in vault yet for this asset. Once an auditor completes a job, the certificate
                        appears here automatically.
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {selectedAssetCertificates.slice(0, 3).map((certificate) => (
                        <button
                          key={certificate.id}
                          onClick={() => {
                            setSelectedAssetForDetails(null);
                            setAssetForQrLabel(null);
                            openCertificateRecordById(certificate.id, false);
                          }}
                          className="w-full text-left rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/60 px-3 py-2.5 hover:bg-slate-50 dark:hover:bg-slate-700/60 transition-colors"
                        >
                          <p className="text-xs font-bold text-slate-800 dark:text-white font-mono">{certificate.id}</p>
                          <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                            Issued {formatDateLabel(certificate.issueDate)} â¢ Expires {formatDateLabel(certificate.expiryDate)}
                          </p>
                        </button>
                      ))}
                    </div>
                  )}
                </div>

                <div className="rounded-2xl border border-cyan-100 dark:border-cyan-800/30 bg-cyan-50/70 dark:bg-cyan-900/10 p-4">
                  <p className="text-xs font-bold uppercase tracking-wider text-cyan-700 dark:text-cyan-300">
                    Asset QR Label
                  </p>
                  <p className="text-xs text-cyan-700/80 dark:text-cyan-200/80 mt-2 leading-relaxed">
                    Print and attach a QR label so auditors can scan this asset and jump straight to prior audits and
                    certificates in InCert.
                  </p>
                </div>
              </div>

              {/* Drawer Footer */}
              <div className="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 space-y-2">
                <button
                  onClick={() => setAssetForQrLabel(selectedAssetForDetails)}
                  className="w-full py-3 bg-white hover:bg-slate-100 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-100 rounded-xl font-bold shadow-sm transition-colors flex justify-center items-center border border-slate-200 dark:border-slate-600"
                >
                  <QrCode className="w-4 h-4 mr-2" /> Create QR Label
                </button>
                <button
                  onClick={() => {
                    setSelectedAssetForDetails(null);
                    openDispatch();
                  }}
                  className="w-full py-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-xl font-bold shadow-sm transition-colors flex justify-center items-center"
                >
                  <Calendar className="w-4 h-4 mr-2" /> Schedule Inspection
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Add Asset Modal */}
        {showAddAssetModal && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 dark:bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col transform transition-all">
              <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center">
                  <Plus className="w-5 h-5 text-cyan-500 mr-2" /> Add New Asset
                </h3>
                <button
                  onClick={() => setShowAddAssetModal(false)}
                  aria-label="Close add asset modal"
                  className="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 rounded-full"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
              <form
                onSubmit={(event) => {
                  event.preventDefault();
                  const form = new FormData(event.currentTarget);
                  handleAddAsset({
                    name: String(form.get('name') || '').trim(),
                    site: String(form.get('site') || '').trim(),
                    class: String(form.get('class') || '').trim(),
                    regime: String(form.get('regime') || '').trim(),
                    nextDue: String(form.get('nextDue') || '').trim(),
                  });
                }}
              >
                <div className="p-6 space-y-4">
                  <div>
                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                      Asset Name
                    </label>
                    <input
                      required
                      name="name"
                      type="text"
                      className="w-full px-4 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none text-slate-900 dark:text-white"
                      placeholder="e.g. Service Lift 3"
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                        Site/Location
                      </label>
                      <input
                        required
                        name="site"
                        type="text"
                        className="w-full px-4 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none text-slate-900 dark:text-white"
                        placeholder="London HQ"
                        defaultValue="London HQ"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                        Asset Class
                      </label>
                      <input
                        required
                        name="class"
                        type="text"
                        className="w-full px-4 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none text-slate-900 dark:text-white"
                        placeholder="Lift"
                      />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                        Regime
                      </label>
                      <select
                        required
                        name="regime"
                        className="w-full px-4 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none text-slate-900 dark:text-white"
                      >
                        {SUPPORTED_REGIMES.map((regime) => (
                          <option key={`asset-regime-${regime}`}>{regime}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                        Next Inspection Due
                      </label>
                      <input
                        required
                        name="nextDue"
                        type="date"
                        className="w-full px-4 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-cyan-500 outline-none text-slate-900 dark:text-white dark:[color-scheme:dark]"
                      />
                    </div>
                  </div>
                </div>
                <div className="p-5 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-end space-x-3">
                  <button
                    type="button"
                    onClick={() => setShowAddAssetModal(false)}
                    className="px-5 py-2.5 font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    className="px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-bold rounded-xl shadow-sm transition-colors"
                  >
                    Save Asset
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}

        <BookingRequestModal
          isOpen={showRequestModal}
          assets={enrichedAssets}
          auditors={auditors}
          initialAuditorId={selectedProviderForRequest}
          onClose={() => {
            setShowRequestModal(false);
            setSelectedProviderForRequest('');
          }}
          onSubmit={handleRequestInspection}
        />

        <RecurringProgrammeModal
          isOpen={showProgrammeModal}
          auditors={auditors}
          onClose={() => setShowProgrammeModal(false)}
          onSubmit={handleCreateRecurringProgramme}
        />
      </div>
    </div>
  );
}

function BookingRequestModal({ isOpen, assets, auditors, initialAuditorId, onClose, onSubmit }) {
  const defaultAssetId = assets[0]?.id || '';
  const defaultRegime = assets[0]?.regime || 'LOLER';
  const defaultDueDate = useMemo(() => {
    const target = new Date();
    target.setDate(target.getDate() + 7);
    return target.toISOString().slice(0, 10);
  }, []);

  const [step, setStep] = useState(0);
  const [workType, setWorkType] = useState('inspection');
  const [selectedSite, setSelectedSite] = useState('all');
  const [scopeTarget, setScopeTarget] = useState('due');
  const [selectedAssetId, setSelectedAssetId] = useState(defaultAssetId);
  const [selectedRegimes, setSelectedRegimes] = useState([defaultRegime]);
  const [schedulingMode, setSchedulingMode] = useState('asap');
  const [windowStart, setWindowStart] = useState(defaultDueDate);
  const [windowEnd, setWindowEnd] = useState(defaultDueDate);
  const [sameAuditorAcrossSites, setSameAuditorAcrossSites] = useState(false);
  const [preferredAuditorId, setPreferredAuditorId] = useState(initialAuditorId || '');
  const [complexity, setComplexity] = useState('standard');
  const [equipment, setEquipment] = useState('none');
  const [travelKm, setTravelKm] = useState(12);
  const [weekendAccess, setWeekendAccess] = useState(false);
  const [poNumber, setPoNumber] = useState('');
  const [costCentre, setCostCentre] = useState('');
  const [approver, setApprover] = useState('');
  const [includeCertificate, setIncludeCertificate] = useState(true);
  const [includeAuditPack, setIncludeAuditPack] = useState(true);
  const [specialRequirements, setSpecialRequirements] = useState('');
  const [accessNotes, setAccessNotes] = useState('');

  useEffect(() => {
    if (!isOpen) {
      return;
    }

    setStep(0);
    setWorkType('inspection');
    setSelectedSite('all');
    setScopeTarget('due');
    setSelectedAssetId(defaultAssetId);
    setSelectedRegimes([defaultRegime]);
    setSchedulingMode('asap');
    setWindowStart(defaultDueDate);
    setWindowEnd(defaultDueDate);
    setSameAuditorAcrossSites(false);
    setPreferredAuditorId(initialAuditorId || '');
    setComplexity('standard');
    setEquipment('none');
    setTravelKm(12);
    setWeekendAccess(false);
    setPoNumber('');
    setCostCentre('');
    setApprover('');
    setIncludeCertificate(true);
    setIncludeAuditPack(true);
    setSpecialRequirements('');
    setAccessNotes('');
  }, [isOpen, initialAuditorId, defaultAssetId, defaultRegime, defaultDueDate]);

  const steps = [
    'Work Type',
    'Scope Builder',
    'Scheduling',
    'Instant Pricing',
    'Procurement',
    'Confirm',
  ];

  const siteOptions = useMemo(() => Array.from(new Set(assets.map((asset) => asset.site))), [assets]);

  const scopedAssets = useMemo(
    () =>
      assets.filter((asset) => {
        const matchesSite = selectedSite === 'all' || asset.site === selectedSite;
        const matchesRegime = selectedRegimes.length === 0 || selectedRegimes.includes(asset.regime);
        return matchesSite && matchesRegime;
      }),
    [assets, selectedSite, selectedRegimes]
  );

  const dueAssets = useMemo(
    () => scopedAssets.filter((asset) => asset.status !== 'compliant'),
    [scopedAssets]
  );

  const selectedScopeAssets = useMemo(() => {
    if (scopeTarget === 'selected') {
      return scopedAssets.filter((asset) => asset.id === selectedAssetId);
    }
    if (scopeTarget === 'due') {
      return dueAssets.length > 0 ? dueAssets : scopedAssets;
    }
    return scopedAssets;
  }, [scopeTarget, scopedAssets, dueAssets, selectedAssetId]);

  const targetAssets = selectedScopeAssets.length > 0 ? selectedScopeAssets : assets.slice(0, 1);
  const primaryAsset = targetAssets[0] || null;

  const scopeTemplate = useMemo(() => {
    if (workType === 'audit') {
      return targetAssets.length > 1 ? 'portfolio_sweep' : 'insurer_verification';
    }
    if (selectedRegimes.includes('PSSR')) {
      return 'written_scheme_review';
    }
    if (schedulingMode === 'asap') {
      return 'urgent_defect_followup';
    }
    return 'portfolio_sweep';
  }, [workType, targetAssets.length, selectedRegimes, schedulingMode]);

  const normalizedScope = useMemo(() => {
    const assetCount = Math.max(1, targetAssets.length);
    const estimatedHours = estimateScopeHours(scopeTemplate, assetCount, weekendAccess);
    return normalizeMarketplaceScope({
      template: scopeTemplate,
      assetCount,
      estimatedHours,
      complexity,
      equipment,
      travelKm,
      weekendAccess,
      expedite: schedulingMode === 'asap',
    });
  }, [scopeTemplate, targetAssets.length, weekendAccess, complexity, equipment, travelKm, schedulingMode]);

  const quote = useMemo(
    () =>
      calculateMarketplaceQuote({
        scope: normalizedScope,
        regime: primaryAsset?.regime,
        site: primaryAsset?.site,
      }),
    [normalizedScope, primaryAsset]
  );

  const dispatchSlaMins = useMemo(() => resolveDispatchSlaMinutes(normalizedScope), [normalizedScope]);

  const dueDate = schedulingMode === 'scheduled' ? windowEnd || windowStart || defaultDueDate : defaultDueDate;
  const preferredAuditor = auditors.find((auditor) => auditor.id === preferredAuditorId) || null;
  const deliverables = [includeCertificate ? 'Certificate PDF/JSON' : null, includeAuditPack ? 'Audit pack export' : null]
    .filter(Boolean)
    .join(', ');

  const canContinue = useMemo(() => {
    if (step === 1) {
      return targetAssets.length > 0 && selectedRegimes.length > 0;
    }
    if (step === 2 && schedulingMode === 'scheduled') {
      return Boolean(windowStart && windowEnd);
    }
    return true;
  }, [step, targetAssets.length, selectedRegimes.length, schedulingMode, windowStart, windowEnd]);

  const toggleRegime = (regime) => {
    setSelectedRegimes((previousRegimes) => {
      if (previousRegimes.includes(regime)) {
        if (previousRegimes.length === 1) {
          return previousRegimes;
        }
        return previousRegimes.filter((item) => item !== regime);
      }
      return [...previousRegimes, regime];
    });
  };

  const handleSubmit = () => {
    if (!primaryAsset) {
      return;
    }

    const summaryLines = [
      `Work type: ${workType === 'audit' ? 'Independent audit' : 'Statutory inspection'}`,
      `Scope assets: ${targetAssets.length} (${scopeTarget === 'selected' ? 'selected asset' : scopeTarget === 'due' ? 'due/overdue set' : 'all assets in scope'})`,
      `Regimes: ${selectedRegimes.join(', ')}`,
      `Scheduling: ${schedulingMode === 'asap' ? 'ASAP dispatch' : `${windowStart} to ${windowEnd}`}`,
      `Preferred provider: ${preferredAuditor?.name || 'Auto-match network'}`,
      `Same auditor across sites: ${sameAuditorAcrossSites ? 'Yes' : 'No'}`,
      `Deliverables: ${deliverables || 'none selected'}`,
      `PO: ${poNumber || 'Not provided'}`,
      `Cost centre: ${costCentre || 'Not provided'}`,
      `Approver: ${approver || 'Not provided'}`,
      `Special requirements: ${specialRequirements || 'None'}`,
      `Quote estimate: ${formatCurrencyGBP(quote.total)} inc VAT (VAT ${formatCurrencyGBP(quote.vatAmount)})`,
      `Pricing model: ${quote.pricingModelVersion} (${quote.rateCardVersionId})`,
    ];

    const notesBlock = [
      accessNotes || 'No additional access notes provided.',
      '',
      ...summaryLines,
    ].join('\n');

    const wasCreated = onSubmit({
      assetId: primaryAsset.id,
      dueDate,
      scope: normalizedScope,
      pricing: quote,
      dispatchSlaMins,
      preferredAuditorId: preferredAuditorId || '',
      notes: notesBlock,
    });

    if (wasCreated) {
      onClose();
    }
  };

  if (!isOpen) {
    return null;
  }

  return (
    <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/45 dark:bg-slate-950/65 backdrop-blur-sm">
      <div className="w-full max-w-3xl rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
        <div className="px-5 md:px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/70">
          <div className="flex items-start justify-between gap-3">
            <div>
              <h3 className="text-lg md:text-xl font-black text-slate-900 dark:text-white flex items-center gap-2">
                <Calendar className="w-5 h-5 text-cyan-500" />
                Request Audit or Inspection
              </h3>
              <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                Research-aligned booking flow: scope, scheduling, pricing, procurement, and dispatch.
              </p>
            </div>
            <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500">
              <X className="w-5 h-5" />
            </button>
          </div>
          <div className="mt-4 grid grid-cols-6 gap-1.5">
            {steps.map((stepLabel, index) => (
              <div key={stepLabel} className="min-w-0">
                <div
                  className={`h-1.5 rounded-full ${
                    index <= step ? 'bg-cyan-500' : 'bg-slate-200 dark:bg-slate-700'
                  }`}
                />
                <p className="mt-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 truncate">{stepLabel}</p>
              </div>
            ))}
          </div>
        </div>

        <div className="p-5 md:p-6 max-h-[72vh] overflow-y-auto space-y-4">
          {step === 0 && (
            <div className="space-y-4">
              <p className="text-sm text-slate-600 dark:text-slate-300">
                Choose the primary job type for this request.
              </p>
              <div className="grid md:grid-cols-2 gap-3">
                <button
                  onClick={() => setWorkType('inspection')}
                  className={`rounded-xl border px-4 py-4 text-left transition-colors ${
                    workType === 'inspection'
                      ? 'border-cyan-500 bg-cyan-50 dark:bg-cyan-900/20'
                      : 'border-slate-200 dark:border-slate-700'
                  }`}
                >
                  <p className="text-sm font-bold text-slate-900 dark:text-white">Statutory inspection</p>
                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    Best for due-date driven asset checks and certification.
                  </p>
                </button>
                <button
                  onClick={() => setWorkType('audit')}
                  className={`rounded-xl border px-4 py-4 text-left transition-colors ${
                    workType === 'audit'
                      ? 'border-cyan-500 bg-cyan-50 dark:bg-cyan-900/20'
                      : 'border-slate-200 dark:border-slate-700'
                  }`}
                >
                  <p className="text-sm font-bold text-slate-900 dark:text-white">Independent audit</p>
                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    Best for evidence review across one or more sites.
                  </p>
                </button>
              </div>
            </div>
          )}

          {step === 1 && (
            <div className="space-y-4">
              <p className="text-sm text-slate-600 dark:text-slate-300">
                Define regimes, sites, and asset target scope.
              </p>
              <div className="grid md:grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    Sites
                  </label>
                  <select
                    value={selectedSite}
                    onChange={(event) => setSelectedSite(event.target.value)}
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  >
                    <option value="all">All selected sites</option>
                    {siteOptions.map((site) => (
                      <option key={site} value={site}>
                        {site}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    Target assets
                  </label>
                  <select
                    value={scopeTarget}
                    onChange={(event) => setScopeTarget(event.target.value)}
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  >
                    <option value="due">Due + overdue assets</option>
                    <option value="all">All assets in site scope</option>
                    <option value="selected">Single selected asset</option>
                  </select>
                </div>
              </div>

              {scopeTarget === 'selected' && (
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    Selected asset
                  </label>
                  <select
                    value={selectedAssetId}
                    onChange={(event) => setSelectedAssetId(event.target.value)}
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  >
                    {scopedAssets.map((asset) => (
                      <option key={asset.id} value={asset.id}>
                        {asset.id} - {asset.name}
                      </option>
                    ))}
                  </select>
                </div>
              )}

              <div>
                <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">
                  Regimes
                </label>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  {SUPPORTED_REGIMES.map((regime) => (
                    <button
                      key={regime}
                      type="button"
                      onClick={() => toggleRegime(regime)}
                      className={`rounded-xl border px-3 py-2 text-xs font-bold transition-colors ${
                        selectedRegimes.includes(regime)
                          ? 'border-cyan-500 bg-cyan-50 dark:bg-cyan-900/20 text-cyan-700 dark:text-cyan-300'
                          : 'border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300'
                      }`}
                    >
                      {regime}
                    </button>
                  ))}
                </div>
              </div>

              <p className="text-xs text-slate-500 dark:text-slate-400">
                Assets in scope: {targetAssets.length} {primaryAsset ? `â¢ Primary record: ${primaryAsset.id}` : ''}
              </p>
            </div>
          )}

          {step === 2 && (
            <div className="space-y-4">
              <p className="text-sm text-slate-600 dark:text-slate-300">
                Configure scheduling mode and dispatch constraints.
              </p>
              <div className="grid md:grid-cols-2 gap-3">
                <button
                  type="button"
                  onClick={() => setSchedulingMode('asap')}
                  className={`rounded-xl border px-4 py-3 text-left ${
                    schedulingMode === 'asap'
                      ? 'border-cyan-500 bg-cyan-50 dark:bg-cyan-900/20'
                      : 'border-slate-200 dark:border-slate-700'
                  }`}
                >
                  <p className="text-sm font-bold text-slate-900 dark:text-white">ASAP dispatch</p>
                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Launches immediate offer waves.</p>
                </button>
                <button
                  type="button"
                  onClick={() => setSchedulingMode('scheduled')}
                  className={`rounded-xl border px-4 py-3 text-left ${
                    schedulingMode === 'scheduled'
                      ? 'border-cyan-500 bg-cyan-50 dark:bg-cyan-900/20'
                      : 'border-slate-200 dark:border-slate-700'
                  }`}
                >
                  <p className="text-sm font-bold text-slate-900 dark:text-white">Scheduled window</p>
                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Set start and end dates per plan.</p>
                </button>
              </div>

              {schedulingMode === 'scheduled' && (
                <div className="grid md:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                      Window start
                    </label>
                    <input
                      type="date"
                      value={windowStart}
                      onChange={(event) => setWindowStart(event.target.value)}
                      className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm dark:[color-scheme:dark]"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                      Window end
                    </label>
                    <input
                      type="date"
                      value={windowEnd}
                      onChange={(event) => setWindowEnd(event.target.value)}
                      className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm dark:[color-scheme:dark]"
                    />
                  </div>
                </div>
              )}

              <div className="grid md:grid-cols-2 gap-3">
                <label className="flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 px-3 py-2 text-sm text-slate-700 dark:text-slate-200">
                  <input
                    type="checkbox"
                    checked={sameAuditorAcrossSites}
                    onChange={(event) => setSameAuditorAcrossSites(event.target.checked)}
                  />
                  Same auditor across selected sites
                </label>
                <label className="flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 px-3 py-2 text-sm text-slate-700 dark:text-slate-200">
                  <input
                    type="checkbox"
                    checked={weekendAccess}
                    onChange={(event) => setWeekendAccess(event.target.checked)}
                  />
                  Weekend / out-of-hours access
                </label>
              </div>

              <div className="grid md:grid-cols-3 gap-3">
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    Access complexity
                  </label>
                  <select
                    value={complexity}
                    onChange={(event) => setComplexity(event.target.value)}
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  >
                    <option value="standard">Standard</option>
                    <option value="restricted">Restricted</option>
                    <option value="out_of_hours">Out of hours</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    Equipment
                  </label>
                  <select
                    value={equipment}
                    onChange={(event) => setEquipment(event.target.value)}
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  >
                    <option value="none">None</option>
                    <option value="specialist_instruments">Specialist instruments</option>
                    <option value="rope_access">Rope access</option>
                    <option value="confined_space">Confined space</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    Travel (km)
                  </label>
                  <input
                    type="number"
                    min="0"
                    max="300"
                    value={travelKm}
                    onChange={(event) => setTravelKm(Number(event.target.value || 0))}
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  />
                </div>
              </div>

              <div>
                <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                  Preferred provider (optional)
                </label>
                <select
                  value={preferredAuditorId}
                  onChange={(event) => setPreferredAuditorId(event.target.value)}
                  className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                >
                  <option value="">Auto-match network</option>
                  {auditors.map((auditor) => (
                    <option key={auditor.id} value={auditor.id}>
                      {auditor.name} ({auditor.tier})
                    </option>
                  ))}
                </select>
              </div>
            </div>
          )}

          {step === 3 && (
            <div className="space-y-4">
              <p className="text-sm text-slate-600 dark:text-slate-300">
                Fixed-price estimate based on selected scope and dispatch mode.
              </p>
              <div className="rounded-2xl border border-cyan-200 dark:border-cyan-800/30 bg-cyan-50/70 dark:bg-cyan-900/10 p-4">
                <div className="grid grid-cols-2 gap-3 text-xs">
                  <div>
                    <p className="text-cyan-700/80 dark:text-cyan-300/80">VAT</p>
                    <p className="font-bold text-cyan-700 dark:text-cyan-300">{formatCurrencyGBP(quote.vatAmount)}</p>
                  </div>
                  <div>
                    <p className="text-cyan-700/80 dark:text-cyan-300/80">Total inc VAT</p>
                    <p className="font-black text-cyan-700 dark:text-cyan-300">{formatCurrencyGBP(quote.total)}</p>
                  </div>
                </div>
                <p className="mt-2 text-xs text-cyan-700/90 dark:text-cyan-300/90">
                  Dispatch SLA target: {dispatchSlaMins} minutes. Scope template: {scopeTemplate.replaceAll('_', ' ')}. Model {quote.pricingModelVersion}.
                </p>
              </div>
              <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40 p-3">
                <p className="text-xs text-slate-600 dark:text-slate-300">
                  Assumptions: {targetAssets.length} asset(s), {schedulingMode === 'asap' ? 'ASAP dispatch' : 'scheduled window'},{' '}
                  {weekendAccess ? 'weekend-capable visit' : 'weekday access'}.
                </p>
              </div>
            </div>
          )}

          {step === 4 && (
            <div className="space-y-4">
              <p className="text-sm text-slate-600 dark:text-slate-300">
                Capture PO and approval details for finance reconciliation.
              </p>
              <div className="grid md:grid-cols-3 gap-3">
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    PO Number
                  </label>
                  <input
                    value={poNumber}
                    onChange={(event) => setPoNumber(event.target.value)}
                    placeholder="PO-2026-..."
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    Cost Centre
                  </label>
                  <input
                    value={costCentre}
                    onChange={(event) => setCostCentre(event.target.value)}
                    placeholder="Ops-North"
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                    Approver
                  </label>
                  <input
                    value={approver}
                    onChange={(event) => setApprover(event.target.value)}
                    placeholder="finance@..."
                    className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                  />
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-3">
                <label className="flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 px-3 py-2 text-sm text-slate-700 dark:text-slate-200">
                  <input
                    type="checkbox"
                    checked={includeCertificate}
                    onChange={(event) => setIncludeCertificate(event.target.checked)}
                  />
                  Certificate output required
                </label>
                <label className="flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 px-3 py-2 text-sm text-slate-700 dark:text-slate-200">
                  <input
                    type="checkbox"
                    checked={includeAuditPack}
                    onChange={(event) => setIncludeAuditPack(event.target.checked)}
                  />
                  Audit pack export required
                </label>
              </div>
              <div>
                <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                  Special requirements
                </label>
                <input
                  value={specialRequirements}
                  onChange={(event) => setSpecialRequirements(event.target.value)}
                  placeholder="e.g. insurer witness, pressure relief validation, sampling ratio..."
                  className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
                />
              </div>
              <div>
                <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                  Access notes
                </label>
                <textarea
                  value={accessNotes}
                  onChange={(event) => setAccessNotes(event.target.value)}
                  rows={3}
                  placeholder="Site induction, permits, escort constraints, keys, and contact instructions..."
                  className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm resize-none"
                />
              </div>
            </div>
          )}

          {step === 5 && (
            <div className="space-y-3">
              <p className="text-sm text-slate-600 dark:text-slate-300">
                Review and submit this request to the InCert network.
              </p>
              <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40 p-4 space-y-2 text-sm">
                <p className="text-slate-700 dark:text-slate-200">
                  <span className="font-bold">Primary asset:</span> {primaryAsset ? `${primaryAsset.id} - ${primaryAsset.name}` : 'n/a'}
                </p>
                <p className="text-slate-700 dark:text-slate-200">
                  <span className="font-bold">Type:</span> {workType === 'audit' ? 'Independent audit' : 'Statutory inspection'}
                </p>
                <p className="text-slate-700 dark:text-slate-200">
                  <span className="font-bold">Scope assets:</span> {targetAssets.length}
                </p>
                <p className="text-slate-700 dark:text-slate-200">
                  <span className="font-bold">Regimes:</span> {selectedRegimes.join(', ')}
                </p>
                <p className="text-slate-700 dark:text-slate-200">
                  <span className="font-bold">Scheduling:</span>{' '}
                  {schedulingMode === 'asap' ? 'ASAP dispatch' : `${windowStart} to ${windowEnd}`}
                </p>
                <p className="text-slate-700 dark:text-slate-200">
                  <span className="font-bold">Preferred provider:</span> {preferredAuditor?.name || 'Auto-match'}
                </p>
                <p className="text-slate-700 dark:text-slate-200">
                  <span className="font-bold">Total estimate:</span> {formatCurrencyGBP(quote.total)} inc VAT
                </p>
                <p className="text-slate-700 dark:text-slate-200">
                  <span className="font-bold">Quote metadata:</span> {quote.pricingModelVersion} â¢ {quote.rateCardVersionId}
                </p>
              </div>
            </div>
          )}
        </div>

        <div className="px-5 md:px-6 py-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/70 flex items-center justify-between">
          <button
            type="button"
            onClick={() => {
              if (step === 0) {
                onClose();
                return;
              }
              setStep((previousStep) => Math.max(0, previousStep - 1));
            }}
            className="px-4 py-2 rounded-lg text-sm font-bold bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200"
          >
            {step === 0 ? 'Cancel' : 'Back'}
          </button>
          {step < steps.length - 1 ? (
            <button
              type="button"
              disabled={!canContinue}
              onClick={() => setStep((previousStep) => Math.min(steps.length - 1, previousStep + 1))}
              className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 disabled:bg-slate-300 dark:disabled:bg-slate-700 text-white transition-colors"
            >
              Next
            </button>
          ) : (
            <button
              type="button"
              onClick={handleSubmit}
              className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white transition-colors"
            >
              Send Request
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

function RecurringProgrammeModal({ isOpen, auditors, onClose, onSubmit }) {
  const [name, setName] = useState('');
  const [cadence, setCadence] = useState('quarterly');
  const [leadDays, setLeadDays] = useState(30);
  const [preferredAuditorId, setPreferredAuditorId] = useState('');
  const [budgetCap, setBudgetCap] = useState(2500);
  const [startDate, setStartDate] = useState(() => new Date().toISOString().slice(0, 10));
  const [approvalChain, setApprovalChain] = useState('Site Manager > Finance');

  useEffect(() => {
    if (!isOpen) {
      return;
    }
    setName('');
    setCadence('quarterly');
    setLeadDays(30);
    setPreferredAuditorId('');
    setBudgetCap(2500);
    setStartDate(new Date().toISOString().slice(0, 10));
    setApprovalChain('Site Manager > Finance');
  }, [isOpen]);

  if (!isOpen) {
    return null;
  }

  return (
    <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/45 dark:bg-slate-950/65 backdrop-blur-sm">
      <div className="w-full max-w-xl rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
        <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/70 flex items-center justify-between">
          <h3 className="text-lg font-black text-slate-900 dark:text-white">Create Recurring Programme</h3>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500">
            <X className="w-5 h-5" />
          </button>
        </div>
        <form
          onSubmit={(event) => {
            event.preventDefault();
            const wasCreated = onSubmit({
              name,
              cadence,
              leadDays,
              preferredAuditorId,
              budgetCap,
              startDate,
              approvalChain,
            });
            if (wasCreated) {
              onClose();
            }
          }}
          className="p-5 space-y-4"
        >
          <div>
            <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
              Programme name
            </label>
            <input
              required
              value={name}
              onChange={(event) => setName(event.target.value)}
              placeholder="Q2 LOLER Multi-site Sweep"
              className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
            />
          </div>
          <div className="grid md:grid-cols-3 gap-3">
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Cadence
              </label>
              <select
                value={cadence}
                onChange={(event) => setCadence(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
              >
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="biannual">Biannual</option>
                <option value="annual">Annual</option>
              </select>
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Lead days
              </label>
              <input
                type="number"
                min="7"
                max="180"
                value={leadDays}
                onChange={(event) => setLeadDays(Number(event.target.value || 30))}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Start date
              </label>
              <input
                type="date"
                value={startDate}
                onChange={(event) => setStartDate(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm dark:[color-scheme:dark]"
              />
            </div>
          </div>
          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Preferred provider
              </label>
              <select
                value={preferredAuditorId}
                onChange={(event) => setPreferredAuditorId(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
              >
                <option value="">Auto-match network</option>
                {auditors.map((auditor) => (
                  <option key={auditor.id} value={auditor.id}>
                    {auditor.name}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Budget cap (GBP)
              </label>
              <input
                type="number"
                min="0"
                step="50"
                value={budgetCap}
                onChange={(event) => setBudgetCap(Number(event.target.value || 0))}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
          </div>
          <div>
            <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
              Approval chain
            </label>
            <input
              value={approvalChain}
              onChange={(event) => setApprovalChain(event.target.value)}
              className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-sm"
            />
          </div>
          <div className="flex justify-end gap-2 pt-2 border-t border-slate-200 dark:border-slate-700">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 rounded-lg text-sm font-bold bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200"
            >
              Cancel
            </button>
            <button type="submit" className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white">
              Save Programme
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// --- NAVIGATION COMPONENTS ---

function DesktopNavItem({ icon, label, isActive, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 border ${
        isActive
          ? 'bg-cyan-50 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-400 border-cyan-200 dark:border-cyan-800/50 shadow-sm'
          : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200 border-transparent'
      }`}
    >
      <div className={`${isActive ? 'text-cyan-600 dark:text-cyan-400' : 'text-slate-400 dark:text-slate-500'}`}>
        {React.cloneElement(icon, { className: 'w-5 h-5' })}
      </div>
      <span>{label}</span>
    </button>
  );
}

function MobileNavItem({ icon, label, isActive, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`w-full min-w-0 flex flex-col items-center justify-center space-y-1 transition-colors duration-200 ${
        isActive
          ? 'text-cyan-600 dark:text-cyan-400'
          : 'text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200'
      }`}
    >
      <div
        className={`p-1.5 rounded-lg transition-colors duration-200 ${
          isActive ? 'bg-cyan-50 dark:bg-cyan-900/30' : 'bg-transparent'
        }`}
      >
        {React.cloneElement(icon, { className: 'w-5 h-5' })}
      </div>
      <span className="text-[10px] font-bold text-center leading-tight">{label}</span>
    </button>
  );
}

function AppFooter({ onOpenHelp, onPrivacy, onTerms }) {
  return (
    <footer className="border-t border-slate-200 dark:border-slate-700 pt-5">
      <div className="flex flex-col items-center gap-3 text-center md:flex-row md:justify-between md:text-left">
        <p className="text-xs text-slate-500 dark:text-slate-400">
          InCert by InCommand &copy; {new Date().getFullYear()}
        </p>
        <div className="flex items-center justify-center gap-5">
          <button
            onClick={onOpenHelp}
            className="text-xs font-semibold text-slate-600 dark:text-slate-300 hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors"
          >
            Help
          </button>
          <button
            onClick={onPrivacy}
            className="text-xs font-semibold text-slate-600 dark:text-slate-300 hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors"
          >
            Privacy
          </button>
          <button
            onClick={onTerms}
            className="text-xs font-semibold text-slate-600 dark:text-slate-300 hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors"
          >
            Terms
          </button>
        </div>
      </div>
    </footer>
  );
}

function usePrefersReducedMotion() {
  const [prefersReduced, setPrefersReduced] = useState(false);

  useEffect(() => {
    if (typeof window === 'undefined' || !window.matchMedia) {
      return;
    }

    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    const handleChange = () => setPrefersReduced(mediaQuery.matches);

    handleChange();

    if (mediaQuery.addEventListener) {
      mediaQuery.addEventListener('change', handleChange);
    } else {
      mediaQuery.addListener(handleChange);
    }

    return () => {
      if (mediaQuery.removeEventListener) {
        mediaQuery.removeEventListener('change', handleChange);
      } else {
        mediaQuery.removeListener(handleChange);
      }
    };
  }, []);

  return prefersReduced;
}

function AnimatedNetworkSvg() {
  const prefersReducedMotion = usePrefersReducedMotion();

  return (
    <svg viewBox="0 0 560 260" className="w-full h-56" role="img" aria-label="Animated network map">
      <defs>
        <linearGradient id="networkStroke" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stopColor="#06b6d4" />
          <stop offset="100%" stopColor="#0ea5e9" />
        </linearGradient>
      </defs>
      <rect x="10" y="10" width="540" height="240" rx="20" fill="rgba(148, 163, 184, 0.06)" />
      <path d="M90 180 C170 70, 270 70, 350 170 S500 230, 520 120" fill="none" stroke="url(#networkStroke)" strokeWidth="3" strokeDasharray="9 9">
        {!prefersReducedMotion && (
          <animate attributeName="stroke-dashoffset" values="36;0" dur="2.6s" repeatCount="indefinite" />
        )}
      </path>
      <path d="M80 80 C180 180, 260 170, 380 70 S500 60, 510 190" fill="none" stroke="#14b8a6" strokeWidth="2.5" strokeDasharray="7 9" opacity="0.8">
        {!prefersReducedMotion && (
          <animate attributeName="stroke-dashoffset" values="0;32" dur="3.1s" repeatCount="indefinite" />
        )}
      </path>
      {[
        { x: 80, y: 80, label: 'Company' },
        { x: 170, y: 170, label: 'Site' },
        { x: 280, y: 130, label: 'InCert' },
        { x: 390, y: 70, label: 'Auditor' },
        { x: 510, y: 180, label: 'Insurer' },
      ].map((node) => (
        <g key={node.label}>
          <circle cx={node.x} cy={node.y} r="8" fill="#0ea5e9">
            {!prefersReducedMotion && <animate attributeName="r" values="8;10;8" dur="2s" repeatCount="indefinite" />}
          </circle>
          <text x={node.x + 12} y={node.y + 4} fill="#334155" fontSize="11" fontWeight="700">
            {node.label}
          </text>
        </g>
      ))}
    </svg>
  );
}

function AnimatedWorkflowSvg() {
  const prefersReducedMotion = usePrefersReducedMotion();

  return (
    <svg viewBox="0 0 560 220" className="w-full h-52" role="img" aria-label="Animated workflow timeline">
      <rect x="16" y="26" width="528" height="168" rx="18" fill="rgba(148, 163, 184, 0.06)" />
      <line x1="66" y1="110" x2="494" y2="110" stroke="#0ea5e9" strokeWidth="3" strokeDasharray="8 8">
        {!prefersReducedMotion && (
          <animate attributeName="stroke-dashoffset" values="32;0" dur="2.4s" repeatCount="indefinite" />
        )}
      </line>
      {[
        { x: 66, label: 'Scope' },
        { x: 172, label: 'Price' },
        { x: 280, label: 'Dispatch' },
        { x: 388, label: 'Inspect' },
        { x: 494, label: 'Verify' },
      ].map((step, index) => (
        <g key={step.label}>
          <circle cx={step.x} cy="110" r="16" fill="#06b6d4" opacity="0.92">
            {!prefersReducedMotion && (
              <animate
                attributeName="opacity"
                values="0.55;1;0.55"
                dur="3s"
                begin={`${index * 0.35}s`}
                repeatCount="indefinite"
              />
            )}
          </circle>
          <text x={step.x} y="154" textAnchor="middle" fill="#334155" fontSize="11" fontWeight="700">
            {step.label}
          </text>
        </g>
      ))}
      <rect x="48" y="48" width="36" height="22" rx="6" fill="#0ea5e9">
        {!prefersReducedMotion && <animate attributeName="x" values="48;462;48" dur="4.4s" repeatCount="indefinite" />}
      </rect>
    </svg>
  );
}

function AnimatedTrustSvg() {
  const prefersReducedMotion = usePrefersReducedMotion();

  return (
    <svg viewBox="0 0 380 220" className="w-full h-52" role="img" aria-label="Animated trust badge">
      <defs>
        <linearGradient id="shieldFill" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#06b6d4" />
          <stop offset="100%" stopColor="#14b8a6" />
        </linearGradient>
      </defs>
      <rect x="16" y="16" width="348" height="188" rx="20" fill="rgba(148, 163, 184, 0.06)" />
      <path d="M190 46 L272 76 V122 C272 156 239 183 190 196 C141 183 108 156 108 122 V76 Z" fill="url(#shieldFill)" opacity="0.92">
        {!prefersReducedMotion && (
          <animate attributeName="opacity" values="0.8;1;0.8" dur="3s" repeatCount="indefinite" />
        )}
      </path>
      <path d="M151 117 L181 145 L233 92" fill="none" stroke="#f8fafc" strokeWidth="10" strokeLinecap="round" strokeLinejoin="round" strokeDasharray="120">
        {!prefersReducedMotion && (
          <animate attributeName="stroke-dashoffset" values="120;0;0;120" dur="4.2s" repeatCount="indefinite" />
        )}
      </path>
      <circle cx="126" cy="62" r="9" fill="#38bdf8">
        {!prefersReducedMotion && <animate attributeName="r" values="9;12;9" dur="2.4s" repeatCount="indefinite" />}
      </circle>
      <circle cx="254" cy="62" r="9" fill="#38bdf8">
        {!prefersReducedMotion && (
          <animate attributeName="r" values="9;12;9" dur="2.4s" begin="0.4s" repeatCount="indefinite" />
        )}
      </circle>
    </svg>
  );
}

function AnimatedLogoShield({ className = 'h-7 w-7' }) {
  const prefersReducedMotion = usePrefersReducedMotion();

  return (
    <svg viewBox="0 0 28 28" className={className} role="img" aria-label="InCert">
      <defs>
        <linearGradient id="logoShieldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#06b6d4" />
          <stop offset="100%" stopColor="#0d9488" />
        </linearGradient>
      </defs>
      <path
        d="M14 2L24 6v8c0 6-10 12-10 12S4 20 4 14V6l10-4z"
        fill="url(#logoShieldGrad)"
        opacity="0.95"
      >
        {!prefersReducedMotion && (
          <animate attributeName="opacity" values="0.9;1;0.9" dur="2.5s" repeatCount="indefinite" />
        )}
      </path>
      <path
        d="M8 12l4 4 8-8"
        fill="none"
        stroke="white"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        strokeDasharray="24"
      >
        {!prefersReducedMotion && <animate attributeName="stroke-dashoffset" values="24;0" dur="0.6s" fill="freeze" />}
      </path>
    </svg>
  );
}

function AnimatedCheckIcon({ className = 'h-5 w-5' }) {
  const prefersReducedMotion = usePrefersReducedMotion();

  return (
    <svg viewBox="0 0 20 20" className={className} role="img" aria-hidden="true">
      <circle cx="10" cy="10" r="9" fill="#0d9488" opacity="0.2">
        {!prefersReducedMotion && <animate attributeName="r" values="9;10;9" dur="2s" repeatCount="indefinite" />}
      </circle>
      <path d="M6 10l3 3 5-6" fill="none" stroke="#0d9488" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" strokeDasharray="20">
        {!prefersReducedMotion && (
          <animate attributeName="stroke-dashoffset" values="20;0" dur="0.4s" repeatCount="indefinite" />
        )}
      </path>
    </svg>
  );
}

function AnimatedPortalIcon({ type, className = 'h-10 w-10' }) {
  const prefersReducedMotion = usePrefersReducedMotion();

  const icons = {
    company: (
      <g fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="5" width="14" height="12" rx="1.5" />
        <path d="M7 5V3a1.5 1.5 0 013 0v2M3 9h18" />
        {!prefersReducedMotion && (
          <animate attributeName="opacity" values="0.85;1;0.85" dur="2.2s" repeatCount="indefinite" />
        )}
      </g>
    ),
    auditor: (
      <g fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="10" cy="6" r="3.5" />
        <path d="M4 18c0-3.3 2.7-6 6-6s6 2.7 6 6" />
        {!prefersReducedMotion && (
          <animate attributeName="opacity" values="0.85;1;0.85" dur="2.2s" begin="0.2s" repeatCount="indefinite" />
        )}
      </g>
    ),
    admin: (
      <g fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
        <path d="M4 14v4M10 10v8M16 6v12" />
        <path d="M2 18h4M8 18h4M14 18h4" />
        {!prefersReducedMotion && (
          <animate attributeName="opacity" values="0.85;1;0.85" dur="2.2s" begin="0.4s" repeatCount="indefinite" />
        )}
      </g>
    ),
    insurer: (
      <g fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
        <rect x="4" y="8" width="12" height="8" rx="1" />
        <path d="M8 8V6a2 2 0 014 0v2M10 12h4" />
        {!prefersReducedMotion && (
          <animate attributeName="opacity" values="0.85;1;0.85" dur="2.2s" begin="0.6s" repeatCount="indefinite" />
        )}
      </g>
    ),
  };
  return (
    <svg viewBox="0 0 20 20" className={className}>
      {icons[type] || icons.company}
    </svg>
  );
}

function AnimatedStepIcon({ step, className = 'h-12 w-12' }) {
  const prefersReducedMotion = usePrefersReducedMotion();

  return (
    <svg viewBox="0 0 48 48" className={className} role="img" aria-hidden="true">
      <defs>
        <linearGradient id={`stepGrad-${step}`} x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#06b6d4" />
          <stop offset="100%" stopColor="#0ea5e9" />
        </linearGradient>
      </defs>
      <circle cx="24" cy="24" r="20" fill={`url(#stepGrad-${step})`} opacity="0.9">
        {!prefersReducedMotion && (
          <animate attributeName="r" values="20;22;20" dur="2s" begin={`${step * 0.2}s`} repeatCount="indefinite" />
        )}
      </circle>
      <text x="24" y="28" textAnchor="middle" fill="white" fontSize="16" fontWeight="bold">
        {step}
      </text>
    </svg>
  );
}

function PublicMarketingLanding({
  isDarkMode,
  onToggleTheme,
  onAuthenticate,
  authRuntimeMode = 'mock',
  isSupabaseConfigured = false,
}) {
  const [authMode, setAuthMode] = useState('signin');
  const [fullName, setFullName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [accountType, setAccountType] = useState('company');
  const heroPage = PUBLIC_SITE_PAGE_BLUEPRINTS.find((page) => page.id === 'home') || PUBLIC_SITE_PAGE_BLUEPRINTS[0];

  const submitLabel = authMode === 'signup' ? 'Create account' : 'Sign in';
  const canSubmit = Boolean(email.trim()) && Boolean(password.trim()) && (authMode === 'signin' || Boolean(fullName.trim()));

  const sectionId = (value) => `public-${value}`;

  const scrollToSection = (value, options = {}) => {
    if (options.authMode) {
      setAuthMode(options.authMode);
    }
    if (options.accountType) {
      setAccountType(options.accountType);
    }

    if (typeof window === 'undefined') {
      return;
    }
    const target = document.getElementById(sectionId(value));
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };

  const footerTargetByLabel = {
    Security: 'security',
    Legal: 'legal',
    Privacy: 'privacy',
    Status: 'status',
    Contact: 'contact',
    Careers: 'careers',
  };

  const handleSubmit = async (event) => {
    event.preventDefault();
    const didAuth = await onAuthenticate?.({
      mode: authMode,
      email,
      password,
      fullName,
      accountType,
    });
    if (didAuth) {
      setPassword('');
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50/60 to-emerald-50/60 dark:from-slate-950 dark:via-slate-900 dark:to-slate-900 text-slate-900 dark:text-slate-200 transition-colors duration-300">
      <div className="max-w-7xl mx-auto px-4 md:px-8 pb-12">
        <header className="h-20 flex items-center justify-between sticky top-0 z-30 backdrop-blur-md bg-slate-50/80 dark:bg-slate-950/70 border-b border-slate-200/80 dark:border-slate-800/80">
          <button onClick={() => scrollToSection('home')} className="flex items-center gap-2.5">
            <InCertLogo width={176} height={44} className="text-slate-800 dark:text-white" />
          </button>
          <nav className="hidden lg:flex items-center gap-2">
            {PUBLIC_SITE_PAGE_BLUEPRINTS.map((page) => (
              <button
                key={page.id}
                onClick={() => scrollToSection(page.id)}
                className="px-2.5 py-1.5 rounded-lg text-xs font-semibold text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800"
              >
                {page.label}
              </button>
            ))}
            <button
              onClick={() => scrollToSection('signin', { authMode: 'signin' })}
              className="px-2.5 py-1.5 rounded-lg text-xs font-bold bg-cyan-600 text-white hover:bg-cyan-700"
            >
              Sign in
            </button>
          </nav>
          <button
            onClick={onToggleTheme}
            aria-label="Toggle theme"
            className="p-2.5 text-slate-500 hover:text-slate-800 dark:text-slate-400 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700"
          >
            {isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
          </button>
        </header>

        <div className="lg:hidden mt-3 mb-1">
          <div className="flex gap-2 overflow-x-auto pb-2">
            {PUBLIC_SITE_PAGE_BLUEPRINTS.map((page) => (
              <button
                key={`mobile-${page.id}`}
                onClick={() => scrollToSection(page.id)}
                className="shrink-0 px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/45 text-[11px] font-semibold"
              >
                {page.label}
              </button>
            ))}
            <button
              onClick={() => scrollToSection('signin', { authMode: 'signin' })}
              className="shrink-0 px-3 py-1.5 rounded-full bg-cyan-600 text-white text-[11px] font-bold"
            >
              Sign in
            </button>
          </div>
        </div>

        <main className="grid gap-6 lg:grid-cols-[1.15fr_0.85fr] items-start mt-4">
          <section className="space-y-5">
            <section id={sectionId('home')} className="scroll-mt-24 glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-7 shadow-sm">
              <p className="text-xs font-bold uppercase tracking-wider text-cyan-600 dark:text-cyan-400">Compliance Exchange Platform</p>
              <h1 className="text-3xl md:text-4xl font-black text-slate-900 dark:text-white mt-2 max-w-3xl">
                {heroPage.headline}
              </h1>
              <p className="text-sm md:text-base text-slate-600 dark:text-slate-300 mt-3 max-w-3xl">
                One platform for booking statutory work, dispatching vetted auditors, issuing signed certificates, and sharing
                audit-ready evidence.
              </p>
              <div className="mt-4 flex flex-wrap gap-2">
                {heroPage.trustCues.map((cue) => (
                  <span
                    key={`hero-${cue}`}
                    className="px-2.5 py-1 rounded-full border border-cyan-200 dark:border-cyan-800/40 bg-cyan-50 dark:bg-cyan-900/20 text-[11px] font-semibold text-cyan-700 dark:text-cyan-300"
                  >
                    {cue}
                  </span>
                ))}
              </div>
              <div className="mt-4 flex flex-wrap gap-2">
                <button
                  onClick={() => scrollToSection('signin', { authMode: 'signup', accountType: 'company' })}
                  className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
                >
                  Request a pilot
                </button>
                <button
                  onClick={() => scrollToSection('signin', { authMode: 'signup', accountType: 'auditor' })}
                  className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
                >
                  Join as an auditor
                </button>
              </div>
              <div className="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/70 dark:bg-slate-900/35 p-3">
                <img
                  src="/illustrations/landing-network-hero.png"
                  alt="InCert connecting companies, sites, auditors and insurers"
                  className="w-full h-auto max-w-2xl mx-auto block"
                />
              </div>
            </section>

            <section id={sectionId('how-it-works')} className="scroll-mt-24 glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
              <h2 className="text-lg md:text-xl font-black text-slate-900 dark:text-white">How the system works</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-2">
                Scope once, price instantly, dispatch in waves, and deliver signed evidence packs without manual PDF chasing.
              </p>
              <div className="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/70 dark:bg-slate-900/35 p-4 h-52 sm:h-64 overflow-hidden relative">
                <img
                  src="/illustrations/workflow-timeline-hero.png"
                  alt="Workflow: Scope, Price, Dispatch, Inspect, Verify"
                  className="absolute inset-0 w-full h-full object-cover object-center"
                />
              </div>
              <div className="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
                {[
                  { step: 1, title: 'Define scope', copy: 'Select regime, sites, assets, and delivery requirements.' },
                  { step: 2, title: 'Instant price', copy: 'Get fixed quote with VAT-ready totals and assumptions.' },
                  { step: 3, title: 'Dispatch + complete', copy: 'Match vetted auditors/providers and run SLA-driven delivery.' },
                  { step: 4, title: 'Verify evidence', copy: 'Access signed certificates and audit packs with traceability.' },
                ].map((item) => (
                  <article key={item.step} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3 flex flex-col items-center text-center">
                    <AnimatedStepIcon step={item.step} className="h-12 w-12 mb-2" />
                    <p className="text-xs font-bold uppercase tracking-wider text-cyan-600 dark:text-cyan-400">Step {item.step}</p>
                    <p className="text-sm font-bold text-slate-800 dark:text-slate-100 mt-1">{item.title}</p>
                    <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">{item.copy}</p>
                  </article>
                ))}
              </div>
              <button type="button" onClick={() => scrollToSection('portals')} className="mt-3 text-xs font-semibold text-cyan-600 dark:text-cyan-400 hover:underline">
                See Portals included â
              </button>
            </section>

            <section id={sectionId('portals')} className="scroll-mt-24 glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
              <h2 className="text-lg md:text-xl font-black text-slate-900 dark:text-white">Portals included</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-2">
                One platform, four roles: company, auditor, admin, and insurer. Each portal is tailored to its workflow.
              </p>
              <div className="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
                {[
                  { type: 'company', title: 'Company portal', copy: 'Book inspections, control approvals, and access vault exports.' },
                  { type: 'auditor', title: 'Auditor portal', copy: 'Accept jobs, submit findings, and track payout status.' },
                  { type: 'admin', title: 'InCert admin portal', copy: 'See customer totals, auditor payouts, and platform gross.' },
                  { type: 'insurer', title: 'Insurer read-only portal', copy: 'Review completed jobs and evidence timeline only.' },
                ].map((portal) => (
                  <article key={portal.type} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
                    <span className="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 dark:text-cyan-400">
                      <AnimatedPortalIcon type={portal.type} className="h-6 w-6" />
                    </span>
                    <p className="text-sm font-bold text-slate-800 dark:text-slate-100 mt-2">{portal.title}</p>
                    <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">{portal.copy}</p>
                  </article>
                ))}
              </div>
            </section>

            <section id={sectionId('facilities')} className="scroll-mt-24 glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
              <h2 className="text-lg md:text-xl font-black text-slate-900 dark:text-white">For Facilities teams</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-2">
                Stop chasing PDFs. Run a controlled compliance program with site-level visibility and procurement-grade finance outputs.
              </p>
              <div className="mt-3 grid gap-3 md:grid-cols-2">
                {[
                  'Upload asset registers and auto-build due-date calendars',
                  'Set lead times, evidence requirements, and retention policy profiles',
                  'Use PO and VAT-ready invoicing with approver workflows',
                  'Export audit packs by site, regime, and status in minutes',
                ].map((item) => (
                  <div key={item} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
                    <p className="text-xs text-slate-700 dark:text-slate-200">{item}</p>
                  </div>
                ))}
              </div>
              <div className="mt-3 flex gap-2">
                <button
                  onClick={() => scrollToSection('signin', { authMode: 'signup', accountType: 'company' })}
                  className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
                >
                  Upload your asset register
                </button>
                <button
                  onClick={() => scrollToSection('resources')}
                  className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
                >
                  Download procurement pack
                </button>
              </div>
            </section>

            <section id={sectionId('auditors')} className="scroll-mt-24 glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
              <h2 className="text-lg md:text-xl font-black text-slate-900 dark:text-white">For Auditors</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-2">
                Find work that fits your coverage, rates, and availability. Keep evidence handling tight and payouts predictable.
              </p>
              <div className="mt-3 grid gap-3 md:grid-cols-2">
                {[
                  'Create a profile with regimes, coverage regions, and payout expectations',
                  'Upload credentials and pass vetting with expiry tracking',
                  'Accept offers with clear payout, travel estimate, and SLA windows',
                  'Submit findings linked to assets and certificates for traceability',
                ].map((item) => (
                  <div key={item} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
                    <p className="text-xs text-slate-700 dark:text-slate-200">{item}</p>
                  </div>
                ))}
              </div>
              <div className="mt-3 flex gap-2">
                <button
                  onClick={() => scrollToSection('signin', { authMode: 'signup', accountType: 'auditor' })}
                  className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
                >
                  Create auditor profile
                </button>
                <button
                  onClick={() => scrollToSection('how-it-works')}
                  className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
                >
                  See example workflow
                </button>
              </div>
            </section>

            <section id={sectionId('pricing')} className="scroll-mt-24 glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
              <h2 className="text-lg md:text-xl font-black text-slate-900 dark:text-white">Pricing</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-2">
                Transparent commercial model for operators and audit firms, with VAT-ready outputs and no lock-in.
              </p>
              <div className="mt-3 grid gap-3 md:grid-cols-3">
                <article className="rounded-xl border border-cyan-200 dark:border-cyan-800/30 bg-cyan-50/70 dark:bg-cyan-900/10 p-3">
                  <p className="text-xs font-bold uppercase tracking-wider text-cyan-700 dark:text-cyan-300">Per booking</p>
                  <p className="text-sm font-semibold text-slate-800 dark:text-slate-100 mt-1">For operators starting pilots</p>
                  <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">Pay per completed job with line-item visibility.</p>
                </article>
                <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
                  <p className="text-xs font-bold uppercase tracking-wider text-slate-600 dark:text-slate-300">Programme</p>
                  <p className="text-sm font-semibold text-slate-800 dark:text-slate-100 mt-1">For recurring multi-site operations</p>
                  <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">Budget caps, approval chains, and recurring schedules.</p>
                </article>
                <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
                  <p className="text-xs font-bold uppercase tracking-wider text-slate-600 dark:text-slate-300">Enterprise</p>
                  <p className="text-sm font-semibold text-slate-800 dark:text-slate-100 mt-1">Custom procurement and integrations</p>
                  <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">ERP handoff, SSO, and governance controls.</p>
                </article>
              </div>
              <div className="mt-3 flex gap-2">
                <button
                  onClick={() => scrollToSection('signin', { authMode: 'signup', accountType: 'company' })}
                  className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
                >
                  Start pilot pricing
                </button>
                <button
                  onClick={() => scrollToSection('contact')}
                  className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
                >
                  Enterprise consultation
                </button>
              </div>
            </section>

            <section id={sectionId('trust')} className="scroll-mt-24 glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
              <h2 className="text-lg md:text-xl font-black text-slate-900 dark:text-white">Trust & Compliance</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-2">
                Evidence integrity and access controls are built into every workflow step.
              </p>
              <div className="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/70 dark:bg-slate-900/35 p-3">
                <img
                  src="/illustrations/trust-compliance-hero.png"
                  alt="Trust and compliance: evidence integrity, secure records, credentialed network"
                  className="w-full h-auto block"
                />
              </div>
              <div className="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                {PUBLIC_TRUST_MODULES.map((module) => (
                  <div key={module.id} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3 flex items-start gap-2">
                    <span className="shrink-0 mt-0.5 text-emerald-600 dark:text-emerald-400">
                      <AnimatedCheckIcon className="h-5 w-5" />
                    </span>
                    <div>
                      <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{module.title}</p>
                      <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">{module.description}</p>
                    </div>
                  </div>
                ))}
              </div>
            </section>

            <section id={sectionId('resources')} className="scroll-mt-24 glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
              <h2 className="text-lg md:text-xl font-black text-slate-900 dark:text-white">Resources</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-2">
                Templates, implementation guides, and compliance checklists for operators, auditors, and procurement teams.
              </p>
              <div className="mt-3 grid gap-3 md:grid-cols-3">
                {[
                  { title: 'Audit scope template', copy: 'Download a starter scope for LOLER, PUWER, and PSSR workflows.' },
                  { title: 'Onboarding checklist', copy: 'Company, auditor, provider, and finance onboarding steps.' },
                  { title: 'Evidence sharing guide', copy: 'Best practices for secure links, retention, and audit exports.' },
                ].map((resource) => (
                  <article key={resource.title} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
                    <p className="text-sm font-bold text-slate-800 dark:text-slate-100">{resource.title}</p>
                    <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">{resource.copy}</p>
                  </article>
                ))}
              </div>
              <div className="mt-3 flex gap-2">
                <button
                  onClick={() => scrollToSection('signin', { authMode: 'signup', accountType: 'company' })}
                  className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
                >
                  Get the audit scope template
                </button>
                <button
                  onClick={() => scrollToSection('contact')}
                  className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
                >
                  Subscribe to updates
                </button>
              </div>
            </section>
          </section>

          <aside id={sectionId('signin')} className="scroll-mt-24 glass-panel sticky top-24 bg-white/90 dark:bg-slate-800/90 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-6 shadow-sm">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Account access</p>
            <h2 className="text-xl font-black text-slate-900 dark:text-white mt-1">
              {authMode === 'signup' ? 'Create your account' : 'Sign in to your portal'}
            </h2>
            <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
              Runtime mode: {authRuntimeMode === 'supabase' ? 'Supabase live' : 'Mock'} â¢{' '}
              {isSupabaseConfigured ? 'env detected' : 'env pending'}
            </p>
            <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
              Start with a company or auditor account, then invite teams and configure workflows.
            </p>

            <div className="mt-4 grid grid-cols-2 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
              <button
                onClick={() => setAuthMode('signin')}
                className={`px-3 py-2 text-xs font-bold ${authMode === 'signin' ? 'bg-cyan-600 text-white' : 'bg-white dark:bg-slate-900/45 text-slate-600 dark:text-slate-300'}`}
              >
                Sign in
              </button>
              <button
                onClick={() => setAuthMode('signup')}
                className={`px-3 py-2 text-xs font-bold border-l border-slate-200 dark:border-slate-700 ${
                  authMode === 'signup' ? 'bg-cyan-600 text-white' : 'bg-white dark:bg-slate-900/45 text-slate-600 dark:text-slate-300'
                }`}
              >
                Sign up
              </button>
            </div>

            <form onSubmit={handleSubmit} className="mt-4 space-y-3">
              {authMode === 'signup' && (
                <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
                  Full name
                  <input
                    required={authMode === 'signup'}
                    value={fullName}
                    onChange={(event) => setFullName(event.target.value)}
                    placeholder="Alex Operator"
                    className="mt-1 w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 text-sm"
                  />
                </label>
              )}
              <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
                Work email
                <input
                  required
                  type="email"
                  value={email}
                  onChange={(event) => setEmail(event.target.value)}
                  placeholder="name@company.com"
                  className="mt-1 w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 text-sm"
                />
              </label>
              <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
                Password
                <input
                  required
                  type="password"
                  value={password}
                  onChange={(event) => setPassword(event.target.value)}
                  placeholder="Enter password"
                  className="mt-1 w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 text-sm"
                />
              </label>
              <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
                Primary portal
                <select
                  value={accountType}
                  onChange={(event) => setAccountType(event.target.value)}
                  className="mt-1 w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 text-sm"
                >
                  <option value="company">Company</option>
                  <option value="auditor">Auditor</option>
                  <option value="incert">InCert Admin</option>
                  <option value="insurer">Insurer (read-only)</option>
                </select>
              </label>
              <button
                type="submit"
                disabled={!canSubmit}
                className="w-full px-4 py-2.5 rounded-lg bg-cyan-600 hover:bg-cyan-700 disabled:bg-slate-300 dark:disabled:bg-slate-700 text-white text-sm font-bold transition-colors"
              >
                {submitLabel}
              </button>

              {import.meta.env.DEV && (
                <button
                  type="button"
                  onClick={() =>
                    onAuthenticate?.({
                      mode: 'signin',
                      email: 'debug@incert.local',
                      fullName: 'Debug User',
                      accountType,
                    })
                  }
                  className="w-full px-4 py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold transition-colors"
                >
                  Debug: Enter App
                </button>
              )}
            </form>
            <div className="mt-5 pt-4 border-t border-slate-200 dark:border-slate-700">
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Trust controls</p>
              <ul className="mt-2 space-y-2">
                {[
                  { title: 'Evidence integrity', desc: 'Signed certificates and immutable history.' },
                  { title: 'Secure electronic records', desc: 'Access trails and exportable audit packs.' },
                  { title: 'Credentialled network', desc: 'Vetted auditors and expiry tracking.' },
                ].map((item) => (
                  <li key={item.title} className="flex items-start gap-2">
                    <span className="shrink-0 mt-0.5 text-emerald-600 dark:text-emerald-400">
                      <AnimatedCheckIcon className="h-5 w-5" />
                    </span>
                    <div>
                      <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{item.title}</p>
                      <p className="text-[11px] text-slate-600 dark:text-slate-400">{item.desc}</p>
                    </div>
                  </li>
                ))}
              </ul>
              <button
                type="button"
                onClick={() => scrollToSection('trust')}
                className="mt-3 text-xs font-semibold text-cyan-600 dark:text-cyan-400 hover:underline"
              >
                View Trust & Compliance â
              </button>
            </div>
          </aside>
        </main>

        <section className="mt-8 grid gap-3 md:grid-cols-2 lg:grid-cols-3">
          <article id={sectionId('security')} className="scroll-mt-24 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-800/80 p-4">
            <h3 className="text-sm font-black text-slate-900 dark:text-white">Security</h3>
            <p className="text-sm text-slate-700 dark:text-slate-200 mt-2">
              Encryption in transit and at rest, role-based access, MFA-ready controls, and access/event logs. All evidence is signed and tamper-evident.
            </p>
            <button type="button" onClick={() => scrollToSection('trust')} className="mt-2 text-xs font-semibold text-cyan-600 dark:text-cyan-400 hover:underline">
              View security overview â
            </button>
          </article>
          <article id={sectionId('legal')} className="scroll-mt-24 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-800/80 p-4">
            <h3 className="text-sm font-black text-slate-900 dark:text-white">Legal</h3>
            <p className="text-sm text-slate-700 dark:text-slate-200 mt-2">
              Contract-ready terms of service, SLAs, cancellation rules, and audit traceability. Designed for procurement and legal review.
            </p>
            <button type="button" onClick={() => scrollToSection('contact')} className="mt-2 text-xs font-semibold text-cyan-600 dark:text-cyan-400 hover:underline">
              Request terms pack â
            </button>
          </article>
          <article id={sectionId('privacy')} className="scroll-mt-24 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-800/80 p-4">
            <h3 className="text-sm font-black text-slate-900 dark:text-white">Privacy</h3>
            <p className="text-sm text-slate-700 dark:text-slate-200 mt-2">
              Controlled data sharing, retention policies, and read-only evidence links with expiry. GDPR-aligned for UK and EU operations.
            </p>
            <button type="button" onClick={() => scrollToSection('contact')} className="mt-2 text-xs font-semibold text-cyan-600 dark:text-cyan-400 hover:underline">
              Privacy & DPA info â
            </button>
          </article>
          <article id={sectionId('status')} className="scroll-mt-24 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-800/80 p-4">
            <h3 className="text-sm font-black text-slate-900 dark:text-white">Status</h3>
            <p className="text-sm text-slate-700 dark:text-slate-200 mt-2">
              Live operational status, planned maintenance windows, and incident updates. Subscribe for notifications so you stay informed.
            </p>
            <button type="button" onClick={() => scrollToSection('contact')} className="mt-2 text-xs font-semibold text-cyan-600 dark:text-cyan-400 hover:underline">
              Open status page â
            </button>
          </article>
          <article id={sectionId('contact')} className="scroll-mt-24 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-800/80 p-4">
            <h3 className="text-sm font-black text-slate-900 dark:text-white">Contact</h3>
            <p className="text-sm text-slate-700 dark:text-slate-200 mt-2">
              <strong>Sales & onboarding:</strong> sales@incert.example Â· <strong>Support & compliance:</strong> support@incert.example. We typically respond within one business day.
            </p>
            <button type="button" onClick={() => scrollToSection('signin', { authMode: 'signup' })} className="mt-2 text-xs font-semibold text-cyan-600 dark:text-cyan-400 hover:underline">
              Create account to get started â
            </button>
          </article>
          <article id={sectionId('careers')} className="scroll-mt-24 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-800/80 p-4">
            <h3 className="text-sm font-black text-slate-900 dark:text-white">Careers</h3>
            <p className="text-sm text-slate-700 dark:text-slate-200 mt-2">
              Weâre hiring for product, compliance operations, and network growth across the UK and EU. Join us to shape the future of compliance exchange.
            </p>
            <button type="button" onClick={() => scrollToSection('contact')} className="mt-2 text-xs font-semibold text-cyan-600 dark:text-cyan-400 hover:underline">
              See open roles â
            </button>
          </article>
        </section>

        <footer className="mt-8 border-t border-slate-200 dark:border-slate-700 pt-4">
          <div className="flex flex-wrap items-center justify-between gap-2">
            <p className="text-xs text-slate-500 dark:text-slate-400">
              InCert by InCommand &copy; {new Date().getFullYear()}
            </p>
            <div className="flex flex-wrap gap-2">
              {PUBLIC_FOOTER_LINKS.map((link) => (
                <button
                  key={`public-${link}`}
                  onClick={() => scrollToSection(footerTargetByLabel[link] || 'home')}
                  className="px-2.5 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/45 text-[11px] font-semibold text-slate-700 dark:text-slate-200"
                >
                  {link}
                </button>
              ))}
            </div>
          </div>
        </footer>
      </div>
    </div>
  );
}

function PublicLandingView({ onNotify, publicSiteConfig = defaultPublicSiteConfig, onOpenOnboarding, onOpenHelp }) {
  const [activePageId, setActivePageId] = useState(PUBLIC_SITE_PAGE_BLUEPRINTS[0]?.id || 'home');

  const activePage = PUBLIC_SITE_PAGE_BLUEPRINTS.find((page) => page.id === activePageId) || PUBLIC_SITE_PAGE_BLUEPRINTS[0];

  const pageIcons = {
    home: LayoutDashboard,
    'how-it-works': Activity,
    facilities: Building2,
    auditors: Users,
    pricing: BarChart3,
    trust: Lock,
    resources: FileText,
  };

  return (
    <div className="space-y-5 animate-in fade-in duration-300">
      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-6 shadow-sm">
        <div className="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
          <div>
            <p className="text-xs font-bold uppercase tracking-wider text-cyan-600 dark:text-cyan-400">Public Website</p>
            <h2 className="text-2xl md:text-3xl font-black text-slate-900 dark:text-white mt-2">
              {publicSiteConfig.siteTitle || 'InCert Public Site'}
            </h2>
            <p className="text-sm text-slate-600 dark:text-slate-300 mt-2 max-w-3xl">
              Build-ready page architecture for acquisition, trust, and onboarding. Includes all public pages from the research
              sitemap and messaging model.
            </p>
          </div>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => onNotify?.('Pilot request placeholder', 'info')}
              className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
            >
              Request a pilot
            </button>
            <button
              onClick={() => onOpenOnboarding?.()}
              className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
            >
              Start onboarding
            </button>
            <button
              onClick={() => onNotify?.('Sign in placeholder', 'info')}
              className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
            >
              Sign in
            </button>
          </div>
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
        <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Top navigation pages</p>
        <div className="mt-3 grid gap-2 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7">
          {PUBLIC_SITE_PAGE_BLUEPRINTS.map((page) => {
            const Icon = pageIcons[page.id] || FileText;
            const isActive = page.id === activePage.id;
            return (
              <button
                key={page.id}
                onClick={() => setActivePageId(page.id)}
                className={`rounded-xl border px-3 py-2.5 text-left transition-colors ${
                  isActive
                    ? 'border-cyan-300 dark:border-cyan-700 bg-cyan-50 dark:bg-cyan-900/25'
                    : 'border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/35 hover:bg-slate-50 dark:hover:bg-slate-800/60'
                }`}
              >
                <div className="flex items-center gap-2">
                  <Icon className={`w-4 h-4 ${isActive ? 'text-cyan-600 dark:text-cyan-400' : 'text-slate-400 dark:text-slate-500'}`} />
                  <p className={`text-xs font-bold ${isActive ? 'text-cyan-700 dark:text-cyan-300' : 'text-slate-700 dark:text-slate-200'}`}>
                    {page.label}
                  </p>
                </div>
              </button>
            );
          })}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-6 shadow-sm">
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{activePage.label}</p>
            <h3 className="text-xl font-black text-slate-900 dark:text-white mt-1">{activePage.headline}</h3>
            <p className="text-sm text-slate-600 dark:text-slate-300 mt-2 max-w-3xl">{activePage.purpose}</p>
          </div>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => onNotify?.(`${activePage.primaryCta} placeholder`, 'info')}
              className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
            >
              {activePage.primaryCta}
            </button>
            <button
              onClick={() => onNotify?.(`${activePage.secondaryCta} placeholder`, 'info')}
              className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
            >
              {activePage.secondaryCta}
            </button>
          </div>
        </div>

        <div className="mt-4 grid gap-3 md:grid-cols-3">
          {activePage.trustCues.map((cue) => (
            <article
              key={`${activePage.id}-${cue}`}
              className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 px-3 py-2.5"
            >
              <p className="text-xs font-semibold text-slate-700 dark:text-slate-200">{cue}</p>
            </article>
          ))}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
        <div className="flex items-center justify-between gap-3">
          <h3 className="text-base font-bold text-slate-900 dark:text-white">Reusable Trust Modules</h3>
          <button
            onClick={() => onOpenHelp?.()}
            className="text-xs font-bold text-cyan-700 dark:text-cyan-300 hover:underline"
          >
            Open Help Center
          </button>
        </div>
        <div className="mt-3 grid gap-3 md:grid-cols-2">
          {PUBLIC_TRUST_MODULES.map((module) => (
            <article
              key={module.id}
              className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 px-3 py-3"
            >
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{module.title}</p>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-1">{module.description}</p>
            </article>
          ))}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
        <h3 className="text-base font-bold text-slate-900 dark:text-white">Public Footer</h3>
        <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
          Security, legal, and support links expected on every public page.
        </p>
        <div className="mt-3 flex flex-wrap gap-2">
          {PUBLIC_FOOTER_LINKS.map((link) => (
            <button
              key={link}
              onClick={() => onNotify?.(`${link} page placeholder`, 'info')}
              className="px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/45 text-xs font-semibold text-slate-700 dark:text-slate-200"
            >
              {link}
            </button>
          ))}
        </div>
      </section>
    </div>
  );
}

function OnboardingPortalView({ onNotify, onboardingTasks = [], onToggleOnboardingTask, onOpenMarketplace }) {
  const [activePersonaId, setActivePersonaId] = useState(ONBOARDING_PERSONA_FLOWS[0]?.id || 'operator-admin');
  const activePersona = ONBOARDING_PERSONA_FLOWS.find((persona) => persona.id === activePersonaId) || ONBOARDING_PERSONA_FLOWS[0];
  const completedChecklist = onboardingTasks.filter((task) => task.completed).length;
  const checklistProgress = onboardingTasks.length > 0 ? Math.round((completedChecklist / onboardingTasks.length) * 100) : 0;

  const personaIcons = {
    'operator-admin': Building2,
    'site-manager': MapPin,
    auditor: Users,
    'auditor-admin': ShieldCheck,
    'provider-admin': Settings,
    'finance-purchasing': BarChart3,
  };

  return (
    <div className="space-y-5 animate-in fade-in duration-300">
      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-6 shadow-sm">
        <div className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div>
            <p className="text-xs font-bold uppercase tracking-wider text-cyan-600 dark:text-cyan-400">Onboarding Portal</p>
            <h2 className="text-2xl md:text-3xl font-black text-slate-900 dark:text-white mt-2">
              Companies, auditors, providers, and finance flows
            </h2>
            <p className="text-sm text-slate-600 dark:text-slate-300 mt-2 max-w-3xl">
              Persona-by-persona onboarding screens from the research journey maps, including vetting, SLA setup, and launch
              readiness controls.
            </p>
          </div>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => onOpenMarketplace?.()}
              className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
            >
              Open marketplace
            </button>
            <button
              onClick={() => onNotify?.('Onboarding invite flow placeholder', 'info')}
              className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200"
            >
              Send onboarding invites
            </button>
          </div>
        </div>

        <div className="mt-4 grid gap-3 md:grid-cols-3">
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Persona flows</p>
            <p className="text-lg font-black text-slate-900 dark:text-white mt-1">{ONBOARDING_PERSONA_FLOWS.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Checklist progress</p>
            <p className="text-lg font-black text-slate-900 dark:text-white mt-1">{checklistProgress}%</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Vetting tracks</p>
            <p className="text-lg font-black text-slate-900 dark:text-white mt-1">{ONBOARDING_TRACKS.length}</p>
          </article>
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
        <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Persona journeys</p>
        <div className="mt-3 grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
          {ONBOARDING_PERSONA_FLOWS.map((persona) => {
            const Icon = personaIcons[persona.id] || Users;
            const isActive = persona.id === activePersona.id;
            return (
              <button
                key={persona.id}
                onClick={() => setActivePersonaId(persona.id)}
                className={`rounded-xl border px-3 py-2.5 text-left transition-colors ${
                  isActive
                    ? 'border-cyan-300 dark:border-cyan-700 bg-cyan-50 dark:bg-cyan-900/25'
                    : 'border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/35 hover:bg-slate-50 dark:hover:bg-slate-800/60'
                }`}
              >
                <div className="flex items-center gap-2">
                  <Icon className={`w-4 h-4 ${isActive ? 'text-cyan-600 dark:text-cyan-400' : 'text-slate-400 dark:text-slate-500'}`} />
                  <p className={`text-xs font-bold ${isActive ? 'text-cyan-700 dark:text-cyan-300' : 'text-slate-700 dark:text-slate-200'}`}>
                    {persona.label}
                  </p>
                </div>
              </button>
            );
          })}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-6 shadow-sm">
        <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{activePersona.label}</p>
        <h3 className="text-xl font-black text-slate-900 dark:text-white mt-1">{activePersona.goal}</h3>
        <div className="mt-4 space-y-3">
          {activePersona.steps.map((step, index) => (
            <article
              key={`${activePersona.id}-${step.title}`}
              className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4"
            >
              <div className="flex items-start justify-between gap-3">
                <div>
                  <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Step {index + 1}</p>
                  <h4 className="text-sm md:text-base font-bold text-slate-900 dark:text-white mt-1">{step.title}</h4>
                  <p className="text-sm text-slate-600 dark:text-slate-300 mt-1">{step.microcopy}</p>
                </div>
                <button
                  onClick={() => onNotify?.(`${step.cta} placeholder`, 'info')}
                  className="shrink-0 px-2.5 py-1.5 rounded-lg bg-white dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 text-[11px] font-bold text-slate-700 dark:text-slate-200"
                >
                  {step.cta}
                </button>
              </div>
              <ul className="mt-3 space-y-1 text-xs text-slate-600 dark:text-slate-300">
                {step.details.map((detail) => (
                  <li key={`${step.title}-${detail}`}>â¢ {detail}</li>
                ))}
              </ul>
            </article>
          ))}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
        <h3 className="text-base font-bold text-slate-900 dark:text-white">Onboarding + Vetting Tracks</h3>
        <div className="mt-3 grid gap-3 md:grid-cols-3">
          {ONBOARDING_TRACKS.map((track) => (
            <article
              key={track.id}
              className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4"
            >
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{track.title}</p>
              <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">{track.summary}</p>
              <ul className="mt-3 space-y-1 text-xs text-slate-600 dark:text-slate-300">
                {track.checks.map((check) => (
                  <li key={`${track.id}-${check}`}>â¢ {check}</li>
                ))}
              </ul>
            </article>
          ))}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm">
        <div className="flex items-center justify-between gap-3">
          <h3 className="text-base font-bold text-slate-900 dark:text-white">Launch Checklist</h3>
          <p className="text-xs font-semibold text-slate-500 dark:text-slate-400">{completedChecklist}/{onboardingTasks.length} complete</p>
        </div>
        <div className="mt-3 h-2 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
          <div
            className="h-full bg-cyan-500 transition-all"
            style={{ width: `${checklistProgress}%` }}
          />
        </div>
        <div className="mt-3 space-y-2">
          {onboardingTasks.map((task) => (
            <div
              key={task.id}
              className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5 flex items-center justify-between gap-3"
            >
              <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{task.label}</p>
              <button
                onClick={() => onToggleOnboardingTask?.(task.id)}
                className={`px-2.5 py-1 rounded-full text-[11px] font-bold ${
                  task.completed
                    ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                    : 'bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200'
                }`}
              >
                {task.completed ? 'Completed' : 'Mark complete'}
              </button>
            </div>
          ))}
        </div>
      </section>
    </div>
  );
}

function AccountancyView({
  accountancyMode = 'incert',
  accountancyEntityLabel = '',
  financeInvoices = [],
  payoutRuns = [],
  canPayInvoice,
  showDebugScopeSelector = false,
  debugScopeLabel = 'Account',
  debugScopeOptions = [],
  debugScopeValue = '',
  onDebugScopeChange,
  onGenerateInvoices,
  onApproveInvoice,
  onIssueInvoice,
  onSendInvoiceReminder,
  onMarkInvoiceCollected,
  onRunCollectionsSweep,
  onSchedulePayout,
  onConfirmPayoutRun,
  onMarkPayoutPaid,
  onExportCsv,
  showDebugBulkActions = false,
  onCollectReceivablesMonthDebug,
  onPayProvidersMonthDebug,
  onCollectReceivablesYearDebug,
  onPayProvidersYearDebug,
  onAlignPayoutsToCollectionsDebug,
}) {
  const PAYMENT_TERMS_DAYS = 30;
  const AVERAGE_DAYS_PER_MONTH = 365.25 / 12;
  const normalizeDateValue = (value) => String(value || '').slice(0, 10);
  const normalizeMonthValue = (value) => String(value || '').slice(0, 7);
  const isMonthKey = (value) => /^\d{4}-\d{2}$/.test(String(value || ''));
  const buildIsoWeekKey = (dateValue) => {
    const normalizedDate = normalizeDateValue(dateValue);
    const [yearPart, monthPart, dayPart] = normalizedDate.split('-').map(Number);
    if (!Number.isFinite(yearPart) || !Number.isFinite(monthPart) || !Number.isFinite(dayPart)) {
      return '';
    }
    const targetDate = new Date(Date.UTC(yearPart, monthPart - 1, dayPart));
    if (Number.isNaN(targetDate.getTime())) {
      return '';
    }
    const isoWeekDate = new Date(targetDate);
    isoWeekDate.setUTCDate(isoWeekDate.getUTCDate() + 4 - (isoWeekDate.getUTCDay() || 7));
    const weekYear = isoWeekDate.getUTCFullYear();
    const yearStart = new Date(Date.UTC(weekYear, 0, 1));
    const weekNumber = Math.ceil((((isoWeekDate - yearStart) / 86400000) + 1) / 7);
    return `${weekYear}-W${String(weekNumber).padStart(2, '0')}`;
  };
  const getPeriodMonthMultiplier = (granularity) => {
    if (granularity === 'day') {
      return 1 / AVERAGE_DAYS_PER_MONTH;
    }
    if (granularity === 'week') {
      return 7 / AVERAGE_DAYS_PER_MONTH;
    }
    if (granularity === 'quarter') {
      return 3;
    }
    if (granularity === 'year') {
      return 12;
    }
    return 1;
  };
  const formatMonthLabel = (monthValue) => {
    if (!isMonthKey(monthValue)) {
      return String(monthValue || 'Unknown month');
    }
    const [year, month] = String(monthValue).split('-').map(Number);
    const labelDate = new Date(Date.UTC(year, Math.max(0, month - 1), 1));
    return labelDate.toLocaleDateString(undefined, { month: 'short', year: 'numeric', timeZone: 'UTC' });
  };
  const resolveInvoiceIssueDate = (invoice) =>
    normalizeDateValue(invoice?.issueDate || invoice?.issuedAt || invoice?.createdAt);
  const resolveInvoiceDueDate = (invoice) =>
    normalizeDateValue(invoice?.dueDate || invoice?.dueAt || addDays(resolveInvoiceIssueDate(invoice), PAYMENT_TERMS_DAYS));
  const resolvePayoutScheduleDate = (run) => normalizeDateValue(run?.scheduledPayoutDate || run?.scheduledFor);
  const resolvePayoutAmount = (run) => Number(run?.payoutAmount ?? run?.totalIncVat ?? 0);
  const toQuarterKey = (year, month) => `${year}-Q${Math.floor((month - 1) / 3) + 1}`;
  const buildPeriodKey = (dateValue, granularity) => {
    const normalizedDate = normalizeDateValue(dateValue);
    if (!/^\d{4}-\d{2}-\d{2}$/.test(normalizedDate)) {
      return '';
    }
    const [yearPart, monthPart] = normalizedDate.split('-').map(Number);
    if (!Number.isFinite(yearPart) || !Number.isFinite(monthPart) || monthPart < 1 || monthPart > 12) {
      return '';
    }
    if (granularity === 'day') {
      return normalizedDate;
    }
    if (granularity === 'week') {
      return buildIsoWeekKey(normalizedDate);
    }
    if (granularity === 'year') {
      return String(yearPart);
    }
    if (granularity === 'quarter') {
      return toQuarterKey(yearPart, monthPart);
    }
    return `${String(yearPart)}-${String(monthPart).padStart(2, '0')}`;
  };
  const formatPeriodLabel = (periodKey, granularity) => {
    if (granularity === 'day') {
      return /^\d{4}-\d{2}-\d{2}$/.test(String(periodKey)) ? formatDateLabel(String(periodKey)) : 'Unknown day';
    }
    if (granularity === 'week') {
      const match = String(periodKey).match(/^(\d{4})-W(\d{2})$/);
      return match ? `Week ${match[2]} ${match[1]}` : 'Unknown week';
    }
    if (granularity === 'year') {
      return /^\d{4}$/.test(String(periodKey)) ? String(periodKey) : 'Unknown year';
    }
    if (granularity === 'quarter') {
      const match = String(periodKey).match(/^(\d{4})-Q([1-4])$/);
      return match ? `Q${match[2]} ${match[1]}` : 'Unknown quarter';
    }
    return formatMonthLabel(periodKey);
  };
  const getPeriodRank = (periodKey, granularity) => {
    if (granularity === 'day') {
      const parsedDate = parseISODate(String(periodKey || ''));
      return parsedDate ? parsedDate.getTime() : Number.MIN_SAFE_INTEGER;
    }
    if (granularity === 'week') {
      const match = String(periodKey).match(/^(\d{4})-W(\d{2})$/);
      if (!match) {
        return Number.MIN_SAFE_INTEGER;
      }
      const year = Number(match[1]);
      const week = Number(match[2]);
      return year * 53 + week;
    }
    if (granularity === 'year') {
      const year = Number(periodKey);
      return Number.isFinite(year) ? year : Number.MIN_SAFE_INTEGER;
    }
    if (granularity === 'quarter') {
      const match = String(periodKey).match(/^(\d{4})-Q([1-4])$/);
      if (!match) {
        return Number.MIN_SAFE_INTEGER;
      }
      const year = Number(match[1]);
      const quarter = Number(match[2]);
      return year * 4 + (quarter - 1);
    }
    if (!isMonthKey(periodKey)) {
      return Number.MIN_SAFE_INTEGER;
    }
    const [year, month] = String(periodKey).split('-').map(Number);
    return year * 12 + (month - 1);
  };
  const normalizedAccountancyMode = String(accountancyMode || 'incert').toLowerCase();
  const isInCertAccountancy = normalizedAccountancyMode === 'incert';
  const isCompanyAccountancy = normalizedAccountancyMode === 'company';
  const isAuditorPayoutAccountancy = normalizedAccountancyMode === 'auditor' || normalizedAccountancyMode === 'auditor_company';
  const canGenerateInvoices = isInCertAccountancy && typeof onGenerateInvoices === 'function';
  const canRunCollectionsSweep = isInCertAccountancy && typeof onRunCollectionsSweep === 'function';
  const canApproveInvoices = isInCertAccountancy && typeof onApproveInvoice === 'function';
  const canIssueInvoices = isInCertAccountancy && typeof onIssueInvoice === 'function';
  const canSendReminders = isInCertAccountancy && typeof onSendInvoiceReminder === 'function';
  const canSchedulePayouts = isInCertAccountancy && typeof onSchedulePayout === 'function';
  const canConfirmPayoutRuns = isInCertAccountancy && typeof onConfirmPayoutRun === 'function';
  const canMarkPayoutsPaid = isInCertAccountancy && typeof onMarkPayoutPaid === 'function';
  const canCollectInvoices = typeof onMarkInvoiceCollected === 'function';
  const resolveCanPayInvoice = (invoice) => (typeof canPayInvoice === 'function' ? canPayInvoice(invoice) : true);
  const accountancyHeaderKicker = (() => {
    if (isInCertAccountancy) {
      return 'InCert Accountancy';
    }
    if (normalizedAccountancyMode === 'auditor_company') {
      return 'Audit Company Accountancy';
    }
    if (normalizedAccountancyMode === 'auditor') {
      return 'Auditor Accountancy';
    }
    return 'Company Accountancy';
  })();
  const accountancyHeaderTitle = isInCertAccountancy
    ? 'Invoicing, Collections, and Payables'
    : isAuditorPayoutAccountancy
      ? 'Payouts and Remittances'
      : 'Spend, Invoices, and Payments';
  const accountancyHeaderSubtitle = isInCertAccountancy
    ? `Full finance operations view with ${PAYMENT_TERMS_DAYS}-day default terms.`
    : `${String(accountancyEntityLabel || 'Current account')} ledger is locked to this account scope only.`;
  const collectActionLabel = isInCertAccountancy ? 'Mark collected' : 'Pay invoice';
  const receivablesQueueTitle = isCompanyAccountancy ? 'Payables Queue' : 'Receivables Queue';
  const receivablesQueueSummary = isInCertAccountancy
    ? 'Approve, issue, chase, collect, and schedule payouts.'
    : 'Track invoices billed to your company and mark payments in your own scope.';
  const payoutQueueTitle = isInCertAccountancy ? 'Pay Providers' : 'Your Payouts';
  const payoutQueueSummary = isInCertAccountancy
    ? 'Scheduled runs and payment status.'
    : 'Track what you will be paid for completed jobs.';
  const showReceivablesSection = isInCertAccountancy || isCompanyAccountancy;
  const showPayoutSection = isInCertAccountancy || isAuditorPayoutAccountancy;
  const [receivablesMonthFilter, setReceivablesMonthFilter] = useState('');
  const [providerQueueMonthFilter, setProviderQueueMonthFilter] = useState('');
  const [summaryMonthFilter, setSummaryMonthFilter] = useState('');
  const [profitAccountingMode, setProfitAccountingMode] = useState('cash');
  const [profitLossGranularity, setProfitLossGranularity] = useState('month');
  const [profitLossSortDirection, setProfitLossSortDirection] = useState('desc');
  const [profitYearFilter, setProfitYearFilter] = useState('');
  const [businessOverheadsMonthly, setBusinessOverheadsMonthly] = useState(600);
  const [ownerPayMonthly, setOwnerPayMonthly] = useState(3000);
  const [plannedStaffCount, setPlannedStaffCount] = useState(2);
  const [avgStaffCostMonthly, setAvgStaffCostMonthly] = useState(2100);
  const staffPayrollMonthly = Math.max(0, plannedStaffCount) * Math.max(0, avgStaffCostMonthly);
  const inCertOperatingCostsMonthly = Math.max(0, businessOverheadsMonthly) + staffPayrollMonthly;
  const totalPlannedCostsMonthly = inCertOperatingCostsMonthly + Math.max(0, ownerPayMonthly);

  const formatDateSafe = (value) => {
    const normalized = normalizeDateValue(value);
    if (!normalized || !parseISODate(normalized)) {
      return '-';
    }
    return formatDateLabel(normalized);
  };

  const todayMs = startOfToday().getTime();
  const payoutByInvoiceId = useMemo(() => {
    const ids = new Set();
    payoutRuns.forEach((run) => {
      if (run?.invoiceId) {
        ids.add(String(run.invoiceId));
      }
    });
    return ids;
  }, [payoutRuns]);

  const normalizedInvoices = useMemo(
    () =>
      [...financeInvoices]
        .map((invoice) => {
          const dueDate = resolveInvoiceDueDate(invoice);
          const parsedDue = parseISODate(dueDate);
          const dueMs = parsedDue ? parsedDue.getTime() : Number.MAX_SAFE_INTEGER;
          const rawStatus = String(invoice.status || '').toLowerCase();
          let collectionStatus = rawStatus;
          if (rawStatus === 'payout_scheduled') {
            collectionStatus = 'issued';
          }
          if (rawStatus === 'approved') {
            collectionStatus = 'approved';
          }
          if (rawStatus === 'pending_approval') {
            collectionStatus = 'pending_approval';
          }
          if (!['pending_approval', 'approved', 'issued', 'overdue', 'paid'].includes(collectionStatus)) {
            collectionStatus = 'issued';
          }
          if (collectionStatus !== 'paid' && collectionStatus !== 'pending_approval' && dueMs < todayMs) {
            collectionStatus = 'overdue';
          }

          return {
            ...invoice,
            displayId: String(invoice.id || invoice.invoiceNumber || 'INV-UNKNOWN'),
            customerName: String(invoice.billToName || invoice.companyName || 'Customer'),
            providerName: String(invoice.payToName || invoice.providerName || 'Assigned provider'),
            issueDate: resolveInvoiceIssueDate(invoice),
            dueDate,
            collectionStatus,
            totalIncVat: Number(invoice.totalIncVat || 0),
            payoutScheduled: payoutByInvoiceId.has(String(invoice.id || '')),
            dueMs,
          };
        })
        .sort((first, second) => {
          const dueDelta = first.dueMs - second.dueMs;
          if (Number.isFinite(dueDelta) && dueDelta !== 0) {
            return dueDelta;
          }
          return String(second.displayId).localeCompare(String(first.displayId));
        }),
    [financeInvoices, payoutByInvoiceId, todayMs]
  );

  const normalizedPayoutRuns = useMemo(
    () =>
      [...payoutRuns]
        .map((run) => {
          const rawStatus = String(run.status || '').toLowerCase();
          let normalizedStatus = 'scheduled';
          if (rawStatus === 'paid') {
            normalizedStatus = 'paid';
          } else if (['pending_confirmation', 'pending', 'draft'].includes(rawStatus)) {
            normalizedStatus = 'pending';
          }
          return {
            ...run,
            displayId: String(run.id || run.reference || 'PAY-UNKNOWN'),
            scheduledDate: resolvePayoutScheduleDate(run),
            payoutAmount: resolvePayoutAmount(run),
            normalizedStatus,
            sortDateMs: parseISODate(resolvePayoutScheduleDate(run))?.getTime() || Number.MAX_SAFE_INTEGER,
          };
        })
        .sort((first, second) => first.sortDateMs - second.sortDateMs),
    [payoutRuns]
  );
  const invoicePaidAtById = useMemo(
    () =>
      new Map(
        normalizedInvoices.map((invoice) => [
          String(invoice.id || ''),
          String(invoice.paidAt || '').slice(0, 10),
        ])
      ),
    [normalizedInvoices]
  );
  const paidPayoutAmountByInvoiceId = useMemo(() => {
    const byInvoiceId = new Map();
    normalizedPayoutRuns.forEach((run) => {
      if (run.normalizedStatus !== 'paid') {
        return;
      }
      const invoiceId = String(run.invoiceId || '');
      if (!invoiceId) {
        return;
      }
      const linkedInvoicePaidDate = String(invoicePaidAtById.get(invoiceId) || '');
      if (!linkedInvoicePaidDate) {
        return;
      }
      const existingAmount = Number(byInvoiceId.get(invoiceId) || 0);
      byInvoiceId.set(invoiceId, existingAmount + Number(run.payoutAmount || 0));
    });
    return byInvoiceId;
  }, [invoicePaidAtById, normalizedPayoutRuns]);
  const resolvePayoutCashAnchorDate = useCallback(
    (run) => {
      const invoiceId = String(run?.invoiceId || '');
      const linkedInvoicePaidDate = invoiceId ? String(invoicePaidAtById.get(invoiceId) || '') : '';
      return linkedInvoicePaidDate || '';
    },
    [invoicePaidAtById]
  );

  const receivablesMonthOptions = useMemo(() => {
    const months = new Set();
    normalizedInvoices.forEach((invoice) => {
      const monthKey = normalizeMonthValue(invoice.issueDate || invoice.dueDate || '');
      if (isMonthKey(monthKey)) {
        months.add(monthKey);
      }
    });
    return Array.from(months).sort((a, b) => b.localeCompare(a));
  }, [normalizedInvoices]);

  const providerQueueMonthOptions = useMemo(() => {
    const months = new Set();
    normalizedPayoutRuns.forEach((run) => {
      const monthKey = normalizeMonthValue(run.scheduledDate || run.createdAt || '');
      if (isMonthKey(monthKey)) {
        months.add(monthKey);
      }
    });
    return Array.from(months).sort((a, b) => b.localeCompare(a));
  }, [normalizedPayoutRuns]);

  const summaryMonthOptions = useMemo(() => {
    const months = new Set([...receivablesMonthOptions, ...providerQueueMonthOptions]);
    return Array.from(months).sort((a, b) => b.localeCompare(a));
  }, [providerQueueMonthOptions, receivablesMonthOptions]);

  useEffect(() => {
    if (!receivablesMonthFilter) {
      return;
    }
    if (!receivablesMonthOptions.includes(receivablesMonthFilter)) {
      setReceivablesMonthFilter('');
    }
  }, [receivablesMonthFilter, receivablesMonthOptions]);

  useEffect(() => {
    if (!providerQueueMonthFilter) {
      return;
    }
    if (!providerQueueMonthOptions.includes(providerQueueMonthFilter)) {
      setProviderQueueMonthFilter('');
    }
  }, [providerQueueMonthFilter, providerQueueMonthOptions]);

  useEffect(() => {
    if (!summaryMonthFilter) {
      return;
    }
    if (!summaryMonthOptions.includes(summaryMonthFilter)) {
      setSummaryMonthFilter('');
    }
  }, [summaryMonthFilter, summaryMonthOptions]);

  const filteredReceivables = useMemo(() => {
    if (!receivablesMonthFilter) {
      return normalizedInvoices;
    }
    return normalizedInvoices.filter((invoice) => {
      const monthKey = normalizeMonthValue(invoice.issueDate || invoice.dueDate || '');
      return monthKey === receivablesMonthFilter;
    });
  }, [normalizedInvoices, receivablesMonthFilter]);

  const filteredProviderQueueRuns = useMemo(() => {
    if (!providerQueueMonthFilter) {
      return normalizedPayoutRuns;
    }
    return normalizedPayoutRuns.filter((run) => {
      const monthKey = normalizeMonthValue(run.scheduledDate || run.createdAt || '');
      return monthKey === providerQueueMonthFilter;
    });
  }, [normalizedPayoutRuns, providerQueueMonthFilter]);
  const summaryInvoices = useMemo(() => {
    if (!summaryMonthFilter) {
      return normalizedInvoices;
    }
    return normalizedInvoices.filter((invoice) => {
      const monthKey = normalizeMonthValue(invoice.issueDate || invoice.dueDate || '');
      return monthKey === summaryMonthFilter;
    });
  }, [normalizedInvoices, summaryMonthFilter]);
  const summaryPayoutRuns = useMemo(() => {
    if (!summaryMonthFilter) {
      return normalizedPayoutRuns;
    }
    return normalizedPayoutRuns.filter((run) => {
      const monthKey = normalizeMonthValue(run.scheduledDate || run.createdAt || '');
      return monthKey === summaryMonthFilter;
    });
  }, [normalizedPayoutRuns, summaryMonthFilter]);
  const buildProfitLossRowsByGranularity = useCallback(
    (granularity, accountingMode = 'cash') => {
      const periodMonthMultiplier = getPeriodMonthMultiplier(granularity);
      const rowsByPeriod = new Map();
      const ensureRow = (periodKey) => {
        if (!rowsByPeriod.has(periodKey)) {
          rowsByPeriod.set(periodKey, {
            periodKey,
            periodLabel: formatPeriodLabel(periodKey, granularity),
            periodRank: getPeriodRank(periodKey, granularity),
            invoicedIncVat: 0,
            collectedIncVat: 0,
            collectedExVat: 0,
            paidOutExVat: 0,
            outstandingIncVat: 0,
            overdueIncVat: 0,
          });
        }
        return rowsByPeriod.get(periodKey);
      };

      const payoutAmountByInvoiceId = new Map();
      if (accountingMode === 'accrual') {
        normalizedPayoutRuns.forEach((run) => {
          const invoiceId = String(run.invoiceId || '');
          if (!invoiceId) {
            return;
          }
          const existingAmount = Number(payoutAmountByInvoiceId.get(invoiceId) || 0);
          payoutAmountByInvoiceId.set(invoiceId, existingAmount + Number(run.payoutAmount || 0));
        });
      }

      normalizedInvoices.forEach((invoice) => {
        const invoicePeriodKey = buildPeriodKey(invoice.issueDate || invoice.dueDate || '', granularity);
        if (invoicePeriodKey) {
          const invoiceRow = ensureRow(invoicePeriodKey);
          const invoiceValue = Number(invoice.totalIncVat || 0);
          invoiceRow.invoicedIncVat += invoiceValue;
          if (invoice.collectionStatus !== 'paid') {
            invoiceRow.outstandingIncVat += invoiceValue;
          }
          if (invoice.collectionStatus === 'overdue') {
            invoiceRow.overdueIncVat += invoiceValue;
          }
        }

        const invoiceStatus = String(invoice.collectionStatus || '').toLowerCase();
        if (accountingMode === 'cash') {
          if (invoiceStatus === 'paid') {
            const collectedPeriodKey = buildPeriodKey(invoice.paidAt || '', granularity);
            if (collectedPeriodKey) {
              const collectedRow = ensureRow(collectedPeriodKey);
              collectedRow.collectedIncVat += Number(invoice.totalIncVat || 0);
              collectedRow.collectedExVat += resolveInvoiceSubtotalExVat(invoice);
              const invoiceId = String(invoice.id || '');
              const payoutRaw = Number(paidPayoutAmountByInvoiceId.get(invoiceId) || 0);
              const payoutCap = Math.max(0, resolveInvoiceSubtotalExVat(invoice));
              const payoutRecognized = Math.min(Math.max(0, payoutRaw), payoutCap);
              collectedRow.paidOutExVat += payoutRecognized;
            }
          }
        } else if (invoicePeriodKey && ['approved', 'issued', 'overdue', 'paid'].includes(invoiceStatus)) {
          const accruedRow = ensureRow(invoicePeriodKey);
          accruedRow.collectedIncVat += Number(invoice.totalIncVat || 0);
          accruedRow.collectedExVat += resolveInvoiceSubtotalExVat(invoice);
          const invoiceId = String(invoice.id || '');
          const payoutFromRuns = Number(payoutAmountByInvoiceId.get(invoiceId) || 0);
          const fallbackProviderCost = Number(invoice.providerPayoutExVat || 0);
          const accruedCost = payoutFromRuns > 0 ? payoutFromRuns : fallbackProviderCost;
          accruedRow.paidOutExVat += Number.isFinite(accruedCost) ? accruedCost : 0;
        }
      });

      return Array.from(rowsByPeriod.values()).map((row) => {
        const collectedExVat = roundMoney(row.collectedExVat);
        const paidOutExVat = roundMoney(row.paidOutExVat);
        const operatingProfitExVat = roundMoney(collectedExVat - paidOutExVat);
        const inCertStaffWagesExVat = roundMoney(staffPayrollMonthly * periodMonthMultiplier);
        const inCertOverheadsExVat = roundMoney(Math.max(0, businessOverheadsMonthly) * periodMonthMultiplier);
        const inCertOperatingCostsExVat = roundMoney(inCertStaffWagesExVat + inCertOverheadsExVat);
        const ownerDrawExVat = roundMoney(Math.max(0, ownerPayMonthly) * periodMonthMultiplier);
        const netProfitAfterInCertCostsExVat = roundMoney(operatingProfitExVat - inCertOperatingCostsExVat);
        const netAfterOwnerDrawExVat = roundMoney(netProfitAfterInCertCostsExVat - ownerDrawExVat);
        return {
          ...row,
          invoicedIncVat: roundMoney(row.invoicedIncVat),
          collectedIncVat: roundMoney(row.collectedIncVat),
          collectedExVat,
          paidOutExVat,
          operatingProfitExVat,
          inCertStaffWagesExVat,
          inCertOverheadsExVat,
          inCertOperatingCostsExVat,
          ownerDrawExVat,
          netProfitAfterInCertCostsExVat,
          netAfterOwnerDrawExVat,
          outstandingIncVat: roundMoney(row.outstandingIncVat),
          overdueIncVat: roundMoney(row.overdueIncVat),
          profitLossExVat: netProfitAfterInCertCostsExVat,
          grossMarginPct: collectedExVat > 0 ? netProfitAfterInCertCostsExVat / collectedExVat : 0,
        };
      });
    },
    [businessOverheadsMonthly, getPeriodMonthMultiplier, normalizedInvoices, normalizedPayoutRuns, ownerPayMonthly, paidPayoutAmountByInvoiceId, staffPayrollMonthly]
  );

  const periodProfitLossRows = useMemo(() => {
    const rows = buildProfitLossRowsByGranularity(profitLossGranularity, profitAccountingMode);
    rows.sort((first, second) =>
      profitLossSortDirection === 'asc'
        ? first.periodRank - second.periodRank
        : second.periodRank - first.periodRank
    );
    return rows;
  }, [buildProfitLossRowsByGranularity, profitAccountingMode, profitLossGranularity, profitLossSortDirection]);

  const monthlyProfitRows = useMemo(() => {
    const rows = buildProfitLossRowsByGranularity('month', profitAccountingMode);
    rows.sort((first, second) => second.periodRank - first.periodRank);
    return rows;
  }, [buildProfitLossRowsByGranularity, profitAccountingMode]);

  const yearlyProfitRows = useMemo(() => {
    const rows = buildProfitLossRowsByGranularity('year', profitAccountingMode);
    rows.sort((first, second) => second.periodRank - first.periodRank);
    return rows;
  }, [buildProfitLossRowsByGranularity, profitAccountingMode]);

  const profitYearOptions = useMemo(() => {
    const years = new Set();
    periodProfitLossRows.forEach((row) => {
      const yearKey = String(row.periodKey || '').match(/^(\d{4})/)?.[1] || '';
      if (/^\d{4}$/.test(yearKey)) {
        years.add(yearKey);
      }
    });
    return Array.from(years).sort((a, b) => b.localeCompare(a));
  }, [periodProfitLossRows]);

  useEffect(() => {
    if (!profitYearFilter) {
      return;
    }
    if (!profitYearOptions.includes(profitYearFilter)) {
      setProfitYearFilter('');
    }
  }, [profitYearFilter, profitYearOptions]);

  const filteredPeriodProfitLossRows = useMemo(() => {
    if (!['day', 'week', 'month'].includes(profitLossGranularity) || !profitYearFilter) {
      return periodProfitLossRows;
    }
    return periodProfitLossRows.filter((row) => String(row.periodKey || '').startsWith(`${profitYearFilter}-`));
  }, [periodProfitLossRows, profitLossGranularity, profitYearFilter]);
  const filteredPeriodProfitLossRowsWithCumulative = useMemo(() => {
    const chronological = [...filteredPeriodProfitLossRows].sort((first, second) => first.periodRank - second.periodRank);
    let runningBalance = 0;
    const cumulativeByPeriod = new Map();
    chronological.forEach((row) => {
      runningBalance += Number(row.profitLossExVat || 0);
      cumulativeByPeriod.set(row.periodKey, roundMoney(runningBalance));
    });
    return filteredPeriodProfitLossRows.map((row) => ({
      ...row,
      cumulativeBalanceExVat: Number(cumulativeByPeriod.get(row.periodKey) || 0),
    }));
  }, [filteredPeriodProfitLossRows]);
  const yearCollectEligibleCount = normalizedInvoices.filter((invoice) => {
    const currentStatus = String(invoice.collectionStatus || '').toLowerCase();
    return currentStatus !== 'paid';
  }).length;
  const yearPayoutEligibleCount = normalizedPayoutRuns.filter((run) => {
    const normalizedStatus = String(run.normalizedStatus || '').toLowerCase();
    return normalizedStatus !== 'paid';
  }).length;
  function resolveInvoiceSubtotalExVat(invoice) {
    const direct = Number(invoice?.subtotalExVat || 0);
    if (Number.isFinite(direct) && direct > 0) {
      return direct;
    }
    const fromTotal = Number(invoice?.totalIncVat || 0);
    return fromTotal > 0 ? roundMoney(fromTotal / (1 + DEFAULT_VAT_RATE)) : 0;
  }

  const pendingApprovalCount = summaryInvoices.filter((invoice) => invoice.collectionStatus === 'pending_approval').length;
  const awaitingIssueCount = summaryInvoices.filter((invoice) => invoice.collectionStatus === 'approved').length;
  const overdueInvoices = summaryInvoices.filter((invoice) => invoice.collectionStatus === 'overdue');
  const collectedInvoices = summaryInvoices.filter((invoice) => invoice.collectionStatus === 'paid');
  const totalInvoicedValue = summaryInvoices.reduce((sum, invoice) => sum + Number(invoice.totalIncVat || 0), 0);
  const collectedValue = collectedInvoices.reduce((sum, invoice) => sum + Number(invoice.totalIncVat || 0), 0);
  const outstandingValue = summaryInvoices.reduce(
    (sum, invoice) => sum + (invoice.collectionStatus === 'paid' ? 0 : Number(invoice.totalIncVat || 0)),
    0
  );
  const overdueValue = overdueInvoices.reduce((sum, invoice) => sum + Number(invoice.totalIncVat || 0), 0);
  const scheduledPayouts = summaryPayoutRuns.filter((run) => run.normalizedStatus === 'scheduled');
  const pendingConfirmationPayouts = summaryPayoutRuns.filter((run) => run.normalizedStatus === 'pending');
  const openPayouts = summaryPayoutRuns.filter((run) => run.normalizedStatus !== 'paid');
  const paidPayouts = summaryPayoutRuns.filter(
    (run) => run.normalizedStatus === 'paid' && String(invoicePaidAtById.get(String(run.invoiceId || '')) || '')
  );
  const scheduledPayoutValue = openPayouts.reduce((sum, run) => sum + Number(run.payoutAmount || 0), 0);
  const paidPayoutValue = summaryInvoices.reduce((sum, invoice) => {
    if (String(invoice.collectionStatus || '').toLowerCase() !== 'paid') {
      return sum;
    }
    const invoiceId = String(invoice.id || '');
    const payoutRaw = Number(paidPayoutAmountByInvoiceId.get(invoiceId) || 0);
    const payoutCap = Math.max(0, resolveInvoiceSubtotalExVat(invoice));
    return sum + Math.min(Math.max(0, payoutRaw), payoutCap);
  }, 0);
  const totalPayoutExpectedValue = summaryPayoutRuns.reduce((sum, run) => sum + Number(run.payoutAmount || 0), 0);
  const paidPayoutRunValue = summaryPayoutRuns
    .filter((run) => run.normalizedStatus === 'paid')
    .reduce((sum, run) => sum + Number(run.payoutAmount || 0), 0);
  const scheduledPayoutRunValue = summaryPayoutRuns
    .filter((run) => run.normalizedStatus !== 'paid')
    .reduce((sum, run) => sum + Number(run.payoutAmount || 0), 0);
  const nextScheduledPayoutRun = summaryPayoutRuns
    .filter((run) => run.normalizedStatus !== 'paid')
    .sort((first, second) => Number(first.sortDateMs || 0) - Number(second.sortDateMs || 0))[0] || null;
  const totalInvoicedExVat = summaryInvoices.reduce((sum, invoice) => sum + resolveInvoiceSubtotalExVat(invoice), 0);
  const collectedExVat = collectedInvoices.reduce((sum, invoice) => sum + resolveInvoiceSubtotalExVat(invoice), 0);
  const payoutCommittedExVat = summaryPayoutRuns.reduce((sum, run) => sum + Number(run.payoutAmount || 0), 0);
  const realizedGrossExVat = collectedExVat - paidPayoutValue;
  const realizedGrossMarginPct = collectedExVat > 0 ? realizedGrossExVat / collectedExVat : 0;
  const blendedPayoutRatePct = totalInvoicedExVat > 0 ? payoutCommittedExVat / totalInvoicedExVat : 0;
  const netWindowMonth = summaryMonthFilter || new Date().toISOString().slice(0, 7);
  const collectionsInNetWindow = normalizedInvoices.reduce((sum, invoice) => {
    const paidAtMonth = String(invoice.paidAt || '').slice(0, 7);
    return paidAtMonth === netWindowMonth ? sum + Number(invoice.totalIncVat || 0) : sum;
  }, 0);
  const payoutsInNetWindow = normalizedInvoices.reduce((sum, invoice) => {
    if (String(invoice.collectionStatus || '').toLowerCase() !== 'paid') {
      return sum;
    }
    const paidAtMonth = String(invoice.paidAt || '').slice(0, 7);
    if (paidAtMonth !== netWindowMonth) {
      return sum;
    }
    const invoiceId = String(invoice.id || '');
    const payoutRaw = Number(paidPayoutAmountByInvoiceId.get(invoiceId) || 0);
    const payoutCap = Math.max(0, resolveInvoiceSubtotalExVat(invoice));
    return sum + Math.min(Math.max(0, payoutRaw), payoutCap);
  }, 0);
  const netCashInNetWindow = collectionsInNetWindow - payoutsInNetWindow;
  const netWindowLabel = summaryMonthFilter ? `Net ${formatMonthLabel(summaryMonthFilter)}` : 'Net this month';
  const summaryPeriodLabel = summaryMonthFilter ? formatMonthLabel(summaryMonthFilter) : 'All months';
  const paidOutVsInvoicedPct = totalInvoicedValue > 0 ? paidPayoutValue / totalInvoicedValue : 0;
  const revenueColumnLabel = profitAccountingMode === 'cash' ? 'Collected (inc VAT)' : 'Revenue (inc VAT)';
  const cumulativeColumnLabel = profitAccountingMode === 'cash' ? 'Cumulative Net (ex VAT)' : 'Cumulative Net P/L (ex VAT)';
  const nowDate = new Date();
  const currentYearKey = String(nowDate.getFullYear());
  const latestMonthProfitRow = monthlyProfitRows[0] || null;
  const currentMonthProfitRow =
    monthlyProfitRows.find((row) => row.periodKey === nowDate.toISOString().slice(0, 7)) || latestMonthProfitRow;
  const trailingTwelveProfitRows = monthlyProfitRows.slice(0, 12);
  const trailingTwelveOperatingAverageExVat =
    trailingTwelveProfitRows.length > 0
      ? trailingTwelveProfitRows.reduce((sum, row) => sum + Number(row.operatingProfitExVat || 0), 0) / trailingTwelveProfitRows.length
      : 0;
  const trailingTwelveMonthlyAverageExVat =
    trailingTwelveProfitRows.length > 0
      ? trailingTwelveProfitRows.reduce((sum, row) => sum + Number(row.profitLossExVat || 0), 0) / trailingTwelveProfitRows.length
      : 0;
  const projectedAnnualProfitExVat = trailingTwelveMonthlyAverageExVat * 12;
  const currentYearProfitExVat = yearlyProfitRows.find((row) => row.periodKey === currentYearKey)?.profitLossExVat || 0;
  const selectedYearKey = profitYearFilter || currentYearKey;
  const selectedYearProfitExVat = monthlyProfitRows
    .filter((row) => String(row.periodKey || '').startsWith(`${selectedYearKey}-`))
    .reduce((sum, row) => sum + Number(row.profitLossExVat || 0), 0);
  const netAfterCostsMonthlyExVat = trailingTwelveMonthlyAverageExVat - Math.max(0, ownerPayMonthly);
  const netAfterCostsAnnualExVat = netAfterCostsMonthlyExVat * 12;
  const affordableStaffHeadcount =
    avgStaffCostMonthly > 0
      ? Math.max(
          0,
          Math.floor((trailingTwelveOperatingAverageExVat - Math.max(0, businessOverheadsMonthly) - Math.max(0, ownerPayMonthly)) / avgStaffCostMonthly)
        )
      : 0;

  const agingBuckets = useMemo(() => {
    const buckets = {
      current: 0,
      d1to30: 0,
      d31to60: 0,
      d61to90: 0,
      d90plus: 0,
    };

    summaryInvoices.forEach((invoice) => {
      if (invoice.collectionStatus === 'paid') {
        return;
      }
      const dueDate = parseISODate(invoice.dueDate);
      if (!dueDate) {
        buckets.current += Number(invoice.totalIncVat || 0);
        return;
      }
      const daysOverdue = Math.floor((todayMs - dueDate.getTime()) / (1000 * 60 * 60 * 24));
      if (daysOverdue <= 0) {
        buckets.current += Number(invoice.totalIncVat || 0);
        return;
      }
      if (daysOverdue <= 30) {
        buckets.d1to30 += Number(invoice.totalIncVat || 0);
        return;
      }
      if (daysOverdue <= 60) {
        buckets.d31to60 += Number(invoice.totalIncVat || 0);
        return;
      }
      if (daysOverdue <= 90) {
        buckets.d61to90 += Number(invoice.totalIncVat || 0);
        return;
      }
      buckets.d90plus += Number(invoice.totalIncVat || 0);
    });

    return buckets;
  }, [summaryInvoices, todayMs]);

  const statusBadgeClasses = {
    pending_approval: 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300',
    approved: 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300',
    issued: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300',
    overdue: 'bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300',
    paid: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300',
  };

  const statusLabels = {
    pending_approval: isCompanyAccountancy ? 'Pending' : 'Needs approval',
    approved: isCompanyAccountancy ? 'Approved' : 'Ready to issue',
    issued: isCompanyAccountancy ? 'Issued to you' : 'Issued',
    overdue: isCompanyAccountancy ? 'Overdue to pay' : 'Overdue',
    paid: isCompanyAccountancy ? 'Paid' : 'Collected',
  };

  return (
    <div className="space-y-5 animate-in fade-in duration-300">
      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-6 shadow-sm">
        <div className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div>
            <p className="text-xs font-bold uppercase tracking-wider text-cyan-600 dark:text-cyan-400">{accountancyHeaderKicker}</p>
            <h2 className="text-2xl md:text-3xl font-black text-slate-900 dark:text-white mt-1">{accountancyHeaderTitle}</h2>
            <p className="text-sm text-slate-600 dark:text-slate-300 mt-2 max-w-3xl">
              {accountancyHeaderSubtitle}
            </p>
            <label className="mt-3 inline-flex items-center gap-2 text-[11px] font-semibold text-slate-600 dark:text-slate-300">
              Summary period
              <select
                value={summaryMonthFilter}
                onChange={(event) => setSummaryMonthFilter(event.target.value)}
                className="rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-[11px] font-semibold text-slate-700 dark:text-slate-200"
              >
                <option value="">All months</option>
                {summaryMonthOptions.map((monthKey) => (
                  <option key={monthKey} value={monthKey}>
                    {formatMonthLabel(monthKey)}
                  </option>
                ))}
              </select>
            </label>
            {showDebugScopeSelector && Array.isArray(debugScopeOptions) && debugScopeOptions.length > 0 && (
              <label className="mt-2 inline-flex items-center gap-2 text-[11px] font-semibold text-slate-600 dark:text-slate-300">
                Debug {debugScopeLabel}
                <select
                  value={debugScopeValue}
                  onChange={(event) => onDebugScopeChange?.(event.target.value)}
                  className="rounded-md border border-amber-200 dark:border-amber-700 bg-amber-50 dark:bg-amber-900/20 px-2 py-1 text-[11px] font-semibold text-amber-800 dark:text-amber-200"
                >
                  {debugScopeOptions.map((option) => (
                    <option key={option.id} value={option.id}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </label>
            )}
          </div>
          <div className="flex flex-wrap gap-2">
            {canGenerateInvoices && (
              <button
                onClick={() => onGenerateInvoices?.()}
                className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold inline-flex items-center gap-2"
              >
                <FileText className="w-3.5 h-3.5" />
                Generate invoices
              </button>
            )}
            {canRunCollectionsSweep && (
              <button
                onClick={() => onRunCollectionsSweep?.()}
                className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200 inline-flex items-center gap-2"
              >
                <AlertTriangle className="w-3.5 h-3.5" />
                Run overdue sweep
              </button>
            )}
            {typeof onExportCsv === 'function' && (
              <button
                onClick={() => onExportCsv?.()}
                className="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 text-xs font-bold text-slate-700 dark:text-slate-200 inline-flex items-center gap-2"
              >
                <Download className="w-3.5 h-3.5" />
                Export CSV
              </button>
            )}
          </div>
        </div>

        {isAuditorPayoutAccountancy ? (
          <>
            <div className="mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-4">
              <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
                <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Total expected payout</p>
                <p className="text-xl font-black text-slate-900 dark:text-white mt-1">{formatCurrencyGBP(totalPayoutExpectedValue)}</p>
              </article>
              <article className="rounded-xl border border-emerald-200 dark:border-emerald-800/40 bg-emerald-50/80 dark:bg-emerald-900/15 p-3">
                <p className="text-[11px] font-bold uppercase tracking-wider text-emerald-700 dark:text-emerald-300">Paid to you</p>
                <p className="text-xl font-black text-emerald-700 dark:text-emerald-300 mt-1">{formatCurrencyGBP(paidPayoutRunValue)}</p>
              </article>
              <article className="rounded-xl border border-indigo-200 dark:border-indigo-800/40 bg-indigo-50/80 dark:bg-indigo-900/15 p-3">
                <p className="text-[11px] font-bold uppercase tracking-wider text-indigo-700 dark:text-indigo-300">Pending payout</p>
                <p className="text-xl font-black text-indigo-700 dark:text-indigo-300 mt-1">{formatCurrencyGBP(scheduledPayoutRunValue)}</p>
              </article>
              <article className="rounded-xl border border-cyan-200 dark:border-cyan-800/40 bg-cyan-50/80 dark:bg-cyan-900/15 p-3">
                <p className="text-[11px] font-bold uppercase tracking-wider text-cyan-700 dark:text-cyan-300">Runs in period</p>
                <p className="text-xl font-black text-cyan-700 dark:text-cyan-300 mt-1">{summaryPayoutRuns.length}</p>
              </article>
            </div>
            <div className="mt-3 flex flex-wrap gap-2 text-[11px] text-slate-600 dark:text-slate-300">
              <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                Summary {summaryPeriodLabel}
              </span>
              <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                {paidPayouts.length} payout runs paid
              </span>
              <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                {openPayouts.length} payout runs pending
              </span>
              <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                {pendingConfirmationPayouts.length} awaiting InCert confirmation
              </span>
              <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                Next payout {nextScheduledPayoutRun ? formatDateSafe(nextScheduledPayoutRun.scheduledDate) : '-'}
              </span>
            </div>
          </>
        ) : (
          <>
            <div className={`mt-4 grid gap-3 sm:grid-cols-2 ${isCompanyAccountancy ? 'xl:grid-cols-4' : 'xl:grid-cols-5'}`}>
              <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
                <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{isCompanyAccountancy ? 'Total spend' : 'Total invoiced'}</p>
                <p className="text-xl font-black text-slate-900 dark:text-white mt-1">{formatCurrencyGBP(totalInvoicedValue)}</p>
              </article>
              <article className="rounded-xl border border-emerald-200 dark:border-emerald-800/40 bg-emerald-50/80 dark:bg-emerald-900/15 p-3">
                <p className="text-[11px] font-bold uppercase tracking-wider text-emerald-700 dark:text-emerald-300">{isCompanyAccountancy ? 'Paid' : 'Collected'}</p>
                <p className="text-xl font-black text-emerald-700 dark:text-emerald-300 mt-1">{formatCurrencyGBP(collectedValue)}</p>
              </article>
              {isCompanyAccountancy ? (
                <article className="rounded-xl border border-indigo-200 dark:border-indigo-800/40 bg-indigo-50/80 dark:bg-indigo-900/15 p-3">
                  <p className="text-[11px] font-bold uppercase tracking-wider text-indigo-700 dark:text-indigo-300">Invoices paid</p>
                  <p className="text-xl font-black text-indigo-700 dark:text-indigo-300 mt-1">{collectedInvoices.length}</p>
                </article>
              ) : (
                <article className="rounded-xl border border-indigo-200 dark:border-indigo-800/40 bg-indigo-50/80 dark:bg-indigo-900/15 p-3">
                  <p className="text-[11px] font-bold uppercase tracking-wider text-indigo-700 dark:text-indigo-300">Paid out</p>
                  <p className="text-xl font-black text-indigo-700 dark:text-indigo-300 mt-1">{formatCurrencyGBP(paidPayoutValue)}</p>
                  <p className="mt-1 text-[10px] font-semibold text-indigo-600 dark:text-indigo-300">
                    {formatPercentage(paidOutVsInvoicedPct)} of invoiced
                  </p>
                </article>
              )}
              <article className="rounded-xl border border-amber-200 dark:border-amber-800/40 bg-amber-50/80 dark:bg-amber-900/15 p-3">
                <p className="text-[11px] font-bold uppercase tracking-wider text-amber-700 dark:text-amber-300">{isCompanyAccountancy ? 'Unpaid invoices' : 'Outstanding'}</p>
                <p className="text-xl font-black text-amber-700 dark:text-amber-300 mt-1">{formatCurrencyGBP(outstandingValue)}</p>
              </article>
              <article className="rounded-xl border border-rose-200 dark:border-rose-800/40 bg-rose-50/80 dark:bg-rose-900/15 p-3">
                <p className="text-[11px] font-bold uppercase tracking-wider text-rose-700 dark:text-rose-300">{isCompanyAccountancy ? 'Overdue to pay' : 'Overdue'}</p>
                <p className="text-xl font-black text-rose-700 dark:text-rose-300 mt-1">{formatCurrencyGBP(overdueValue)}</p>
              </article>
            </div>
            <div className="mt-3 flex flex-wrap gap-2 text-[11px] text-slate-600 dark:text-slate-300">
              <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                Summary {summaryPeriodLabel}
              </span>
              {isCompanyAccountancy ? (
                <>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {collectedInvoices.length} paid
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {summaryInvoices.length - collectedInvoices.length} unpaid
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {overdueInvoices.length} overdue to pay
                  </span>
                </>
              ) : (
                <>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {pendingApprovalCount} need approval
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {awaitingIssueCount} ready to issue
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {openPayouts.length} payouts pending payment
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {pendingConfirmationPayouts.length} awaiting confirmation
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {paidPayouts.length} payouts paid
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    {netWindowLabel} {formatCurrencyGBP(netCashInNetWindow)}
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    Payout rate {formatPercentage(blendedPayoutRatePct)}
                  </span>
                  <span className="px-2 py-1 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-900/45">
                    Gross margin {formatPercentage(realizedGrossMarginPct)} ({formatCurrencyGBP(realizedGrossExVat)} ex VAT)
                  </span>
                </>
              )}
            </div>
          </>
        )}
      </section>

      <section className={`grid gap-4 ${showReceivablesSection && showPayoutSection ? 'xl:grid-cols-2' : ''}`}>
        {!isAuditorPayoutAccountancy && showReceivablesSection && (
          <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
            <h3 className="text-base font-bold text-slate-900 dark:text-white">{receivablesQueueTitle}</h3>
          <div className="mt-1 flex flex-wrap items-center justify-between gap-2">
            <p className="text-xs text-slate-600 dark:text-slate-300">{receivablesQueueSummary}</p>
            <div className="inline-flex items-center gap-2">
              <label className="inline-flex items-center gap-2 text-[11px] font-semibold text-slate-600 dark:text-slate-300">
                Month
                <select
                  value={receivablesMonthFilter}
                  onChange={(event) => setReceivablesMonthFilter(event.target.value)}
                  className="rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-[11px] font-semibold text-slate-700 dark:text-slate-200"
                >
                  <option value="">All months</option>
                  {receivablesMonthOptions.map((monthKey) => (
                    <option key={monthKey} value={monthKey}>
                      {formatMonthLabel(monthKey)}
                    </option>
                  ))}
                </select>
              </label>
              {showDebugBulkActions && (
                <button
                  onClick={() => onCollectReceivablesMonthDebug?.(receivablesMonthFilter)}
                  disabled={!receivablesMonthFilter}
                  className={`px-2.5 py-1 rounded-md text-[11px] font-bold border ${
                    receivablesMonthFilter
                      ? 'border-emerald-200 text-emerald-700 bg-emerald-50 hover:bg-emerald-100 dark:border-emerald-800/40 dark:text-emerald-300 dark:bg-emerald-900/20 dark:hover:bg-emerald-900/30'
                      : 'border-slate-200 text-slate-400 bg-slate-100 cursor-not-allowed dark:border-slate-700 dark:text-slate-500 dark:bg-slate-800'
                  }`}
                >
                  Debug: Approve+collect month
                </button>
              )}
              {showDebugBulkActions && (
                <button
                  onClick={() => onCollectReceivablesYearDebug?.()}
                  disabled={yearCollectEligibleCount === 0}
                  className={`px-2.5 py-1 rounded-md text-[11px] font-bold border ${
                    yearCollectEligibleCount > 0
                      ? 'border-emerald-200 text-emerald-700 bg-emerald-50 hover:bg-emerald-100 dark:border-emerald-800/40 dark:text-emerald-300 dark:bg-emerald-900/20 dark:hover:bg-emerald-900/30'
                      : 'border-slate-200 text-slate-400 bg-slate-100 cursor-not-allowed dark:border-slate-700 dark:text-slate-500 dark:bg-slate-800'
                  }`}
                >
                  Debug: Approve+collect all year
                </button>
              )}
            </div>
          </div>
          <div className="mt-3 space-y-2 max-h-[560px] overflow-y-auto pr-1">
            {filteredReceivables.length === 0 ? (
              <p className="text-xs text-slate-600 dark:text-slate-300">
                {receivablesMonthFilter
                  ? 'No invoices for the selected month.'
                  : isCompanyAccountancy
                    ? 'No invoices to pay yet.'
                    : 'No invoices available yet.'}
              </p>
            ) : (
              filteredReceivables.slice(0, 30).map((invoice) => (
                <article
                  key={invoice.displayId}
                  className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3"
                >
                  <div>
                    <p className="text-xs font-bold text-slate-900 dark:text-white">{invoice.displayId}</p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400">
                      {isCompanyAccountancy
                        ? `From ${invoice.providerName} | Bill to ${invoice.customerName}`
                        : `Bill to ${invoice.customerName} | Pay ${invoice.providerName}`}
                    </p>
                    <p className="text-[11px] text-slate-600 dark:text-slate-300 mt-1">
                      Issue {formatDateSafe(invoice.issueDate)} | Due {formatDateSafe(invoice.dueDate)} | {formatCurrencyGBP(invoice.totalIncVat)}
                    </p>
                  </div>
                  <div className="flex flex-wrap items-center gap-1.5">
                    <span
                      className={`text-[11px] font-bold px-2 py-1 rounded-full ${
                        statusBadgeClasses[invoice.collectionStatus] || statusBadgeClasses.issued
                      }`}
                    >
                      {statusLabels[invoice.collectionStatus] || 'Issued'}
                    </span>
                    {canApproveInvoices && invoice.collectionStatus === 'pending_approval' && (
                      <button
                        onClick={() => onApproveInvoice?.(invoice.id)}
                        className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                      >
                        Approve
                      </button>
                    )}
                    {canIssueInvoices && invoice.collectionStatus === 'approved' && (
                      <button
                        onClick={() => onIssueInvoice?.(invoice.id)}
                        className="px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300 text-[11px] font-bold"
                      >
                        Issue
                      </button>
                    )}
                    {canSendReminders && (invoice.collectionStatus === 'issued' || invoice.collectionStatus === 'overdue') && (
                      <button
                        onClick={() => onSendInvoiceReminder?.(invoice.id)}
                        className="px-2.5 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300 text-[11px] font-bold"
                      >
                        Reminder
                      </button>
                    )}
                    {canCollectInvoices &&
                      resolveCanPayInvoice(invoice) &&
                      invoice.collectionStatus !== 'pending_approval' &&
                      invoice.collectionStatus !== 'paid' && (
                      <button
                        onClick={() => onMarkInvoiceCollected?.(invoice.id)}
                        className="px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300 text-[11px] font-bold"
                      >
                        {collectActionLabel}
                      </button>
                    )}
                    {canSchedulePayouts && !invoice.payoutScheduled && invoice.collectionStatus !== 'pending_approval' && (
                      <button
                        onClick={() => onSchedulePayout?.(invoice.id)}
                        className="px-2.5 py-1 rounded-full bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200 text-[11px] font-bold"
                      >
                        Schedule payout
                      </button>
                    )}
                  </div>
                </article>
              ))
            )}
          </div>
          </div>
        )}

        {showPayoutSection && (
          <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
            <h3 className="text-base font-bold text-slate-900 dark:text-white">{payoutQueueTitle}</h3>
          <div className="mt-1 flex flex-wrap items-center justify-between gap-2">
            <p className="text-xs text-slate-600 dark:text-slate-300">{payoutQueueSummary}</p>
            <div className="inline-flex items-center gap-2">
              <label className="inline-flex items-center gap-2 text-[11px] font-semibold text-slate-600 dark:text-slate-300">
                Month
                <select
                  value={providerQueueMonthFilter}
                  onChange={(event) => setProviderQueueMonthFilter(event.target.value)}
                  className="rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-[11px] font-semibold text-slate-700 dark:text-slate-200"
                >
                  <option value="">All months</option>
                  {providerQueueMonthOptions.map((monthKey) => (
                    <option key={monthKey} value={monthKey}>
                      {formatMonthLabel(monthKey)}
                    </option>
                  ))}
                </select>
              </label>
              {showDebugBulkActions && (
                <button
                  onClick={() => onPayProvidersMonthDebug?.(providerQueueMonthFilter)}
                  disabled={!providerQueueMonthFilter}
                  className={`px-2.5 py-1 rounded-md text-[11px] font-bold border ${
                    providerQueueMonthFilter
                      ? 'border-indigo-200 text-indigo-700 bg-indigo-50 hover:bg-indigo-100 dark:border-indigo-800/40 dark:text-indigo-300 dark:bg-indigo-900/20 dark:hover:bg-indigo-900/30'
                      : 'border-slate-200 text-slate-400 bg-slate-100 cursor-not-allowed dark:border-slate-700 dark:text-slate-500 dark:bg-slate-800'
                  }`}
                >
                  Debug: Pay month
                </button>
              )}
              {showDebugBulkActions && (
                <button
                  onClick={() => onPayProvidersYearDebug?.()}
                  disabled={yearPayoutEligibleCount === 0}
                  className={`px-2.5 py-1 rounded-md text-[11px] font-bold border ${
                    yearPayoutEligibleCount > 0
                      ? 'border-indigo-200 text-indigo-700 bg-indigo-50 hover:bg-indigo-100 dark:border-indigo-800/40 dark:text-indigo-300 dark:bg-indigo-900/20 dark:hover:bg-indigo-900/30'
                      : 'border-slate-200 text-slate-400 bg-slate-100 cursor-not-allowed dark:border-slate-700 dark:text-slate-500 dark:bg-slate-800'
                  }`}
                >
                  Debug: Pay all year
                </button>
              )}
            </div>
          </div>
          <div className="mt-3 space-y-2 max-h-[560px] overflow-y-auto pr-1">
            {filteredProviderQueueRuns.length === 0 ? (
              <p className="text-xs text-slate-600 dark:text-slate-300">
                {providerQueueMonthFilter ? 'No payout runs for the selected month.' : 'No payout runs scheduled yet.'}
              </p>
            ) : (
              filteredProviderQueueRuns.slice(0, 30).map((run) => (
                <article
                  key={run.displayId}
                  className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3"
                >
                  <div>
                    <p className="text-xs font-bold text-slate-900 dark:text-white">{run.who}</p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400">
                      {run.displayId} | {run.normalizedStatus === 'pending' ? 'Pending' : isInCertAccountancy ? 'Pay' : 'Scheduled'} {formatDateSafe(run.scheduledDate)} | {formatCurrencyGBP(run.payoutAmount)}
                    </p>
                    <p className="text-[11px] text-slate-600 dark:text-slate-300 mt-1">Invoice {run.invoiceId || '-'}</p>
                  </div>
                  <div className="flex items-center gap-2">
                    <span
                      className={`text-[11px] font-bold px-2 py-1 rounded-full ${
                        run.normalizedStatus === 'paid'
                          ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                          : run.normalizedStatus === 'pending'
                            ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300'
                            : 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300'
                      }`}
                    >
                      {run.normalizedStatus === 'paid'
                        ? 'Paid'
                        : run.normalizedStatus === 'pending'
                          ? 'Pending confirmation'
                          : 'Scheduled'}
                    </span>
                    {canConfirmPayoutRuns && run.normalizedStatus === 'pending' && (
                      <button
                        onClick={() => onConfirmPayoutRun?.(run.id)}
                        className="px-2.5 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300 text-[11px] font-bold"
                      >
                        Confirm paid
                      </button>
                    )}
                    {canMarkPayoutsPaid && run.normalizedStatus === 'scheduled' && (
                      <button
                        onClick={() => onMarkPayoutPaid?.(run.id)}
                        className="px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300 text-[11px] font-bold"
                      >
                        Mark paid
                      </button>
                    )}
                  </div>
                </article>
              ))
            )}
          </div>
          </div>
        )}
      </section>

      {isInCertAccountancy && (
      <>
      <section className="grid gap-4 xl:grid-cols-2">
        <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
          <h3 className="text-base font-bold text-slate-900 dark:text-white">A/R Aging</h3>
          <div className="mt-3 grid gap-2 text-xs">
            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
              <span className="text-slate-600 dark:text-slate-300">Current</span>
              <span className="font-bold text-slate-900 dark:text-white">{formatCurrencyGBP(agingBuckets.current)}</span>
            </div>
            <div className="flex items-center justify-between rounded-lg border border-amber-200 dark:border-amber-800/40 px-3 py-2 bg-amber-50/60 dark:bg-amber-900/10">
              <span className="text-amber-800 dark:text-amber-300">1-30 overdue</span>
              <span className="font-bold text-amber-800 dark:text-amber-300">{formatCurrencyGBP(agingBuckets.d1to30)}</span>
            </div>
            <div className="flex items-center justify-between rounded-lg border border-amber-200 dark:border-amber-800/40 px-3 py-2 bg-amber-50/60 dark:bg-amber-900/10">
              <span className="text-amber-800 dark:text-amber-300">31-60 overdue</span>
              <span className="font-bold text-amber-800 dark:text-amber-300">{formatCurrencyGBP(agingBuckets.d31to60)}</span>
            </div>
            <div className="flex items-center justify-between rounded-lg border border-rose-200 dark:border-rose-800/40 px-3 py-2 bg-rose-50/60 dark:bg-rose-900/10">
              <span className="text-rose-700 dark:text-rose-300">61-90 overdue</span>
              <span className="font-bold text-rose-700 dark:text-rose-300">{formatCurrencyGBP(agingBuckets.d61to90)}</span>
            </div>
            <div className="flex items-center justify-between rounded-lg border border-rose-200 dark:border-rose-800/40 px-3 py-2 bg-rose-50/60 dark:bg-rose-900/10">
              <span className="text-rose-700 dark:text-rose-300">90+ overdue</span>
              <span className="font-bold text-rose-700 dark:text-rose-300">{formatCurrencyGBP(agingBuckets.d90plus)}</span>
            </div>
          </div>
        </div>

        <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
          <h3 className="text-base font-bold text-slate-900 dark:text-white">Cash Movement</h3>
			  <div className="mt-3 space-y-2 text-xs">
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">Collected in net window</span>
	              <span className="font-bold text-emerald-700 dark:text-emerald-300">{formatCurrencyGBP(collectionsInNetWindow)}</span>
	            </div>
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">Payouts paid in net window</span>
	              <span className="font-bold text-rose-700 dark:text-rose-300">{formatCurrencyGBP(payoutsInNetWindow)}</span>
	            </div>
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">Paid payouts lifetime</span>
	              <span className="font-bold text-slate-900 dark:text-white">{formatCurrencyGBP(paidPayoutValue)}</span>
	            </div>
            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
              <span className="text-slate-600 dark:text-slate-300">Scheduled payout balance</span>
              <span className="font-bold text-slate-900 dark:text-white">{formatCurrencyGBP(scheduledPayoutValue)}</span>
            </div>
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2 bg-slate-50/80 dark:bg-slate-900/35">
	              <span className="text-slate-700 dark:text-slate-200 font-semibold">{netWindowLabel}</span>
	              <span className={`font-black ${netCashInNetWindow >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
	                {formatCurrencyGBP(netCashInNetWindow)}
	              </span>
	            </div>
	          </div>
	        </div>
	      </section>

	      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
	        <div className="flex flex-wrap items-center justify-between gap-3">
	          <div>
	            <h3 className="text-base font-bold text-slate-900 dark:text-white">Profit & Loss by Period</h3>
	            <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
	              Compare invoices, collections, provider payouts, staff wages, and net profit by day, week, month, quarter, or year.
	            </p>
	          </div>
		          <div className="flex flex-wrap items-center gap-2">
              <label className="inline-flex items-center gap-2 text-[11px] font-semibold text-slate-600 dark:text-slate-300">
                Mode
                <select
                  value={profitAccountingMode}
                  onChange={(event) => setProfitAccountingMode(event.target.value)}
                  className="rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-[11px] font-semibold text-slate-700 dark:text-slate-200"
                >
                  <option value="cash">Cash</option>
                  <option value="accrual">Accrual</option>
                </select>
              </label>
		            <label className="inline-flex items-center gap-2 text-[11px] font-semibold text-slate-600 dark:text-slate-300">
		              View
	              <select
	                value={profitLossGranularity}
	                onChange={(event) => setProfitLossGranularity(event.target.value)}
	                className="rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-[11px] font-semibold text-slate-700 dark:text-slate-200"
	              >
	                <option value="day">Day</option>
	                <option value="week">Week</option>
	                <option value="month">Month</option>
	                <option value="quarter">Quarter</option>
		                <option value="year">Year</option>
		              </select>
		            </label>
	              {['day', 'week', 'month'].includes(profitLossGranularity) && (
	                <label className="inline-flex items-center gap-2 text-[11px] font-semibold text-slate-600 dark:text-slate-300">
	                  Year
	                  <select
	                    value={profitYearFilter}
	                    onChange={(event) => setProfitYearFilter(event.target.value)}
	                    className="rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-[11px] font-semibold text-slate-700 dark:text-slate-200"
	                  >
	                    <option value="">All years</option>
	                    {profitYearOptions.map((yearKey) => (
	                      <option key={yearKey} value={yearKey}>
	                        {yearKey}
	                      </option>
	                    ))}
	                  </select>
	                </label>
	              )}
		            <button
		              onClick={() => setProfitLossSortDirection((current) => (current === 'desc' ? 'asc' : 'desc'))}
		              className="px-2.5 py-1 rounded-md text-[11px] font-bold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-200"
		            >
              {profitLossSortDirection === 'desc' ? 'Newest first' : 'Oldest first'}
            </button>
            {showDebugBulkActions && (
              <button
                onClick={() => onAlignPayoutsToCollectionsDebug?.()}
                className="px-2.5 py-1 rounded-md text-[11px] font-bold border border-indigo-200 text-indigo-700 bg-indigo-50 hover:bg-indigo-100 dark:border-indigo-800/40 dark:text-indigo-300 dark:bg-indigo-900/20 dark:hover:bg-indigo-900/30"
              >
                Debug: Align payout months
              </button>
            )}
          </div>
        </div>
        <div className="mt-3 overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
		          <table className="min-w-full text-xs">
		            <thead className="bg-slate-100/80 dark:bg-slate-900/50 text-slate-600 dark:text-slate-300">
		              <tr>
		                <th className="px-3 py-2 text-left font-bold">Period</th>
		                <th className="px-3 py-2 text-right font-bold">Invoiced (inc VAT)</th>
		                <th className="px-3 py-2 text-right font-bold">{revenueColumnLabel}</th>
		                <th className="px-3 py-2 text-right font-bold">Paid Out to Auditors/Companies (ex VAT)</th>
                    <th className="px-3 py-2 text-right font-bold">Operating P/L (ex VAT)</th>
                    <th className="px-3 py-2 text-right font-bold">InCert Staff Wages (ex VAT)</th>
                    <th className="px-3 py-2 text-right font-bold">InCert Costs (ex VAT)</th>
		                <th className="px-3 py-2 text-right font-bold">Net P/L (ex VAT)</th>
	                  <th className="px-3 py-2 text-right font-bold">{cumulativeColumnLabel}</th>
		                <th className="px-3 py-2 text-right font-bold">Margin</th>
		              </tr>
			            </thead>
			            <tbody>
			              {filteredPeriodProfitLossRowsWithCumulative.length === 0 ? (
			                <tr>
			                  <td colSpan={10} className="px-3 py-4 text-center text-slate-500 dark:text-slate-400">
			                    No period data available yet.
			                  </td>
			                </tr>
			              ) : (
			                filteredPeriodProfitLossRowsWithCumulative.map((row) => (
		                  <tr key={row.periodKey} className="border-t border-slate-200 dark:border-slate-700">
		                    <td className="px-3 py-2 font-semibold text-slate-900 dark:text-white">{row.periodLabel}</td>
			                    <td className="px-3 py-2 text-right text-slate-700 dark:text-slate-200">{formatCurrencyGBP(row.invoicedIncVat)}</td>
			                    <td className="px-3 py-2 text-right text-emerald-700 dark:text-emerald-300">{formatCurrencyGBP(row.collectedIncVat)}</td>
		                    <td className="px-3 py-2 text-right text-indigo-700 dark:text-indigo-300">{formatCurrencyGBP(row.paidOutExVat)}</td>
                    <td
                      className={`px-3 py-2 text-right font-bold ${
                        row.operatingProfitExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'
                      }`}
                    >
	                      {formatCurrencyGBP(row.operatingProfitExVat)}
	                    </td>
                    <td className="px-3 py-2 text-right text-slate-700 dark:text-slate-200">{formatCurrencyGBP(row.inCertStaffWagesExVat)}</td>
                    <td className="px-3 py-2 text-right text-slate-700 dark:text-slate-200">{formatCurrencyGBP(row.inCertOperatingCostsExVat)}</td>
	                    <td
	                      className={`px-3 py-2 text-right font-bold ${
	                        row.profitLossExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'
	                      }`}
	                    >
	                      {formatCurrencyGBP(row.profitLossExVat)}
	                    </td>
                    <td
                      className={`px-3 py-2 text-right font-bold ${
                        row.cumulativeBalanceExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'
                      }`}
                    >
                      {formatCurrencyGBP(row.cumulativeBalanceExVat)}
                    </td>
	                    <td className="px-3 py-2 text-right text-slate-700 dark:text-slate-200">{formatPercentage(row.grossMarginPct)}</td>
	                  </tr>
	                ))
	              )}
	            </tbody>
	          </table>
	        </div>
	      </section>

      <section className="grid gap-4 xl:grid-cols-2">
	        <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
	          <h3 className="text-base font-bold text-slate-900 dark:text-white">Owner Profit View (ex VAT)</h3>
	          <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
	            Profit now includes overhead and InCert staff deductions. Use this to track true net business performance.
	          </p>
	          <div className="mt-3 grid gap-2 text-xs md:grid-cols-2">
            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
              <span className="text-slate-600 dark:text-slate-300">Latest operating P/L</span>
              <span className={`font-bold ${Number(latestMonthProfitRow?.operatingProfitExVat || 0) >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
                {formatCurrencyGBP(Number(latestMonthProfitRow?.operatingProfitExVat || 0))}
              </span>
            </div>
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">Latest month net P/L</span>
	              <span className={`font-bold ${Number(latestMonthProfitRow?.profitLossExVat || 0) >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
	                {formatCurrencyGBP(Number(latestMonthProfitRow?.profitLossExVat || 0))}
	              </span>
	            </div>
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">Current month net P/L</span>
	              <span className={`font-bold ${Number(currentMonthProfitRow?.profitLossExVat || 0) >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
	                {formatCurrencyGBP(Number(currentMonthProfitRow?.profitLossExVat || 0))}
	              </span>
	            </div>
            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
              <span className="text-slate-600 dark:text-slate-300">Avg monthly P/L (12m)</span>
              <span className={`font-bold ${trailingTwelveMonthlyAverageExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
                {formatCurrencyGBP(trailingTwelveMonthlyAverageExVat)}
              </span>
            </div>
            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
              <span className="text-slate-600 dark:text-slate-300">Projected annual P/L</span>
              <span className={`font-bold ${projectedAnnualProfitExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
                {formatCurrencyGBP(projectedAnnualProfitExVat)}
              </span>
            </div>
            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
              <span className="text-slate-600 dark:text-slate-300">Current year P/L</span>
              <span className={`font-bold ${currentYearProfitExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
                {formatCurrencyGBP(currentYearProfitExVat)}
              </span>
            </div>
            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
              <span className="text-slate-600 dark:text-slate-300">{selectedYearKey} P/L</span>
              <span className={`font-bold ${selectedYearProfitExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
                {formatCurrencyGBP(selectedYearProfitExVat)}
              </span>
            </div>
          </div>
        </div>

	        <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
	          <h3 className="text-base font-bold text-slate-900 dark:text-white">Affordability Planner (Monthly)</h3>
	          <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
	            Overheads and staff are now deducted in the net P/L above. This section helps plan owner draw on top of that.
	          </p>
          <div className="mt-3 grid gap-2 sm:grid-cols-2">
            <label className="text-[11px] font-semibold text-slate-600 dark:text-slate-300">
              Business overheads
              <input
                type="number"
                min="0"
                value={businessOverheadsMonthly}
                onChange={(event) => setBusinessOverheadsMonthly(Math.max(0, Number(event.target.value || 0)))}
                className="mt-1 w-full rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1.5 text-xs text-slate-700 dark:text-slate-200"
              />
            </label>
            <label className="text-[11px] font-semibold text-slate-600 dark:text-slate-300">
              Your monthly pay
              <input
                type="number"
                min="0"
                value={ownerPayMonthly}
                onChange={(event) => setOwnerPayMonthly(Math.max(0, Number(event.target.value || 0)))}
                className="mt-1 w-full rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1.5 text-xs text-slate-700 dark:text-slate-200"
              />
            </label>
            <label className="text-[11px] font-semibold text-slate-600 dark:text-slate-300">
              Planned staff count
              <input
                type="number"
                min="0"
                step="1"
                value={plannedStaffCount}
                onChange={(event) => setPlannedStaffCount(Math.max(0, Math.round(Number(event.target.value || 0))))}
                className="mt-1 w-full rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1.5 text-xs text-slate-700 dark:text-slate-200"
              />
            </label>
            <label className="text-[11px] font-semibold text-slate-600 dark:text-slate-300">
              Avg staff cost each
              <input
                type="number"
                min="0"
                value={avgStaffCostMonthly}
                onChange={(event) => setAvgStaffCostMonthly(Math.max(0, Number(event.target.value || 0)))}
                className="mt-1 w-full rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1.5 text-xs text-slate-700 dark:text-slate-200"
              />
            </label>
          </div>
	          <div className="mt-3 space-y-2 text-xs">
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">InCert operating costs in P/L (overhead + staff)</span>
	              <span className="font-bold text-slate-900 dark:text-white">{formatCurrencyGBP(inCertOperatingCostsMonthly)}</span>
	            </div>
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">Total planned monthly costs (inc owner draw)</span>
	              <span className="font-bold text-slate-900 dark:text-white">{formatCurrencyGBP(totalPlannedCostsMonthly)}</span>
	            </div>
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">Net after owner draw (monthly)</span>
	              <span className={`font-bold ${netAfterCostsMonthlyExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
	                {formatCurrencyGBP(netAfterCostsMonthlyExVat)}
	              </span>
	            </div>
	            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2">
	              <span className="text-slate-600 dark:text-slate-300">Net after owner draw (annual)</span>
	              <span className={`font-bold ${netAfterCostsAnnualExVat >= 0 ? 'text-emerald-700 dark:text-emerald-300' : 'text-rose-700 dark:text-rose-300'}`}>
	                {formatCurrencyGBP(netAfterCostsAnnualExVat)}
	              </span>
	            </div>
            <div className="flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2 bg-slate-50/80 dark:bg-slate-900/35">
              <span className="text-slate-700 dark:text-slate-200 font-semibold">Affordable staff at current margin</span>
              <span className="font-black text-slate-900 dark:text-white">{affordableStaffHeadcount}</span>
            </div>
          </div>
        </div>
      </section>
      </>
      )}
    </div>
  );
}

function SupportHelpView({ onNotify, isInCertAdmin = false, onOpenOps, onOpenTemplates }) {
  return (
    <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Help Center</p>
          <h2 className="text-xl font-bold text-slate-900 dark:text-white mt-1">Support and Product Guidance</h2>
          <p className="text-sm text-slate-600 dark:text-slate-300 mt-2 max-w-3xl">
            Use this space for user guidance, support routing, and product walkthrough links.
          </p>
        </div>
        <div className="flex flex-wrap gap-2">
          {isInCertAdmin && (
            <button
              type="button"
              onClick={() => onOpenOps?.()}
              className="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
            >
              <ServerCog className="w-4 h-4" />
              Open Ops Console
            </button>
          )}
          {isInCertAdmin && (
            <button
              type="button"
              onClick={() => onOpenTemplates?.()}
              className="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold"
            >
              <FileSignature className="w-4 h-4" />
              Open Templates
            </button>
          )}
          <button
            type="button"
            onClick={() => onNotify?.('Support channel placeholder', 'info')}
            className="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 text-xs font-bold text-slate-700 dark:text-slate-200"
          >
            <Info className="w-4 h-4" />
            Contact Support
          </button>
        </div>
      </div>
    </section>
  );
}

function TemplateEvidenceReportPreview({ template, templateIndex = 0 }) {
  const reportModel = useMemo(() => buildTemplateCompletionReportModel(template, templateIndex), [template, templateIndex]);
  const verificationQrDataUrl = useQrDataUrl(reportModel.links.verificationUrl, 540);
  const vaultQrDataUrl = useQrDataUrl(reportModel.links.vaultUrl, 540);
  const tamperQrDataUrl = useQrDataUrl(reportModel.links.tamperUrl, 540);

  const reportHtml = useMemo(
    () =>
      buildTemplateCompletedReportHtml(reportModel, {
        verificationQrDataUrl,
        vaultQrDataUrl,
        tamperQrDataUrl,
      }),
    [reportModel, verificationQrDataUrl, vaultQrDataUrl, tamperQrDataUrl]
  );

  return (
    <article className="rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden bg-white dark:bg-slate-900/40 shadow-sm">
      <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 bg-slate-50/85 dark:bg-slate-900/65 flex flex-wrap items-center justify-between gap-2">
        <div>
          <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">HTML Evidence Report Preview</p>
          <p className="text-sm font-bold text-slate-900 dark:text-white mt-0.5">
            {reportModel.template.id} Â· {reportModel.template.name}
          </p>
        </div>
        <span
          className={`inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-bold ${
            reportModel.summary.isPass
              ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
              : 'bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300'
          }`}
        >
          {reportModel.summary.statusLabel} Â· {reportModel.summary.passPercent}%
        </span>
      </div>
      <iframe
        title={`${reportModel.template.id} completed evidence report`}
        srcDoc={reportHtml}
        className="w-full h-[1120px] bg-white"
      />
    </article>
  );
}

function TemplateStudioView({
  onNotify,
  isInCertAdmin = false,
  templateBlueprints = [],
  onPublishTemplateBlueprint,
  onUpdateTemplateBlueprint,
}) {
  const [selectedTemplateId, setSelectedTemplateId] = useState(() => templateBlueprints[0]?.id || '');
  const [previewTemplateId, setPreviewTemplateId] = useState(() => templateBlueprints[0]?.id || '');
  const [questionDraft, setQuestionDraft] = useState([]);

  useEffect(() => {
    setSelectedTemplateId((previous) =>
      templateBlueprints.some((template) => template.id === previous) ? previous : templateBlueprints[0]?.id || ''
    );
  }, [templateBlueprints]);

  useEffect(() => {
    setPreviewTemplateId((previous) =>
      templateBlueprints.some((template) => template.id === previous) ? previous : templateBlueprints[0]?.id || ''
    );
  }, [templateBlueprints]);

  useEffect(() => {
    const selectedTemplate = templateBlueprints.find((template) => template.id === selectedTemplateId);
    const questionPrefix = String(selectedTemplate?.category || selectedTemplate?.id || 'Q');
    setQuestionDraft(normalizeTemplateQuestionBank(selectedTemplate?.questionBank || [], questionPrefix));
  }, [selectedTemplateId, templateBlueprints]);

  const selectedTemplate = templateBlueprints.find((template) => template.id === selectedTemplateId) || null;
  const previewTemplate = templateBlueprints.find((template) => template.id === previewTemplateId) || null;
  const previewTemplateIndex = Math.max(
    0,
    templateBlueprints.findIndex((template) => template.id === previewTemplateId)
  );
  const questionCount = questionDraft.length;
  const criticalCount = questionDraft.filter((question) => question.type === 'boolean' && Boolean(question.critical)).length;
  const maxScore = questionDraft.reduce((total, question) => total + Math.max(1, Number(question.weight || 1)), 0);

  const updateQuestionDraftAt = (index, patch) => {
    if (!isInCertAdmin) {
      return;
    }
    setQuestionDraft((previousQuestions) =>
      previousQuestions.map((question, questionIndex) => {
        if (questionIndex !== index) {
          return question;
        }
        const nextEvidence = patch?.evidence
          ? {
              photo: Boolean(patch.evidence.photo ?? question?.evidence?.photo),
              comment:
                patch.evidence.comment !== undefined
                  ? Boolean(patch.evidence.comment)
                  : question?.evidence?.comment !== false,
              signature: Boolean(patch.evidence.signature ?? question?.evidence?.signature),
            }
          : question?.evidence || { photo: false, comment: true, signature: false };

        return {
          ...question,
          ...patch,
          evidence: nextEvidence,
        };
      })
    );
  };

  const addQuestion = () => {
    if (!isInCertAdmin) {
      onNotify?.('Only InCert admins can edit templates', 'info');
      return;
    }
    const questionPrefix = String(selectedTemplate?.category || selectedTemplate?.id || 'Q');
    setQuestionDraft((previousQuestions) =>
      normalizeTemplateQuestionBank(
        [
          ...previousQuestions,
          {
            id: '',
            category: 'General',
            text: '',
            type: 'boolean',
            options: { yes: 1, no: 0 },
            weight: 1,
            critical: false,
            required: false,
            evidence: { photo: false, comment: true, signature: false },
            showIf: null,
          },
        ],
        questionPrefix
      )
    );
  };

  const removeQuestion = (index) => {
    if (!isInCertAdmin) {
      onNotify?.('Only InCert admins can edit templates', 'info');
      return;
    }
    const questionPrefix = String(selectedTemplate?.category || selectedTemplate?.id || 'Q');
    setQuestionDraft((previousQuestions) =>
      normalizeTemplateQuestionBank(previousQuestions.filter((_, questionIndex) => questionIndex !== index), questionPrefix)
    );
  };

  const resetDraft = () => {
    const questionPrefix = String(selectedTemplate?.category || selectedTemplate?.id || 'Q');
    setQuestionDraft(normalizeTemplateQuestionBank(selectedTemplate?.questionBank || [], questionPrefix));
  };

  const saveQuestionBank = (event) => {
    event.preventDefault();
    if (!isInCertAdmin) {
      onNotify?.('Only InCert admins can save template updates', 'info');
      return;
    }
    if (!selectedTemplateId) {
      onNotify?.('Select a template first', 'info');
      return;
    }
    onUpdateTemplateBlueprint?.({
      templateId: selectedTemplateId,
      questionBank: questionDraft,
    });
  };

  return (
    <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
      <div className="flex flex-wrap items-start justify-between gap-3">
        <div>
          <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Template Studio</p>
          <h2 className="text-xl font-bold text-slate-900 dark:text-white mt-1">Template Management</h2>
          <p className="text-sm text-slate-600 dark:text-slate-300 mt-2">
            Edit template question banks, weighting, evidence requirements, and publish updates.
          </p>
        </div>
      </div>

      <div className="mt-4 grid gap-3 md:grid-cols-4">
        <label className="text-xs font-semibold text-slate-600 dark:text-slate-300 md:col-span-2">
          Template
          <select
            value={selectedTemplateId}
            onChange={(event) => setSelectedTemplateId(event.target.value)}
            className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
          >
            {templateBlueprints.map((template) => (
              <option key={template.id} value={template.id}>
                {template.id} - {template.name}
              </option>
            ))}
          </select>
        </label>
        <div className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
          <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Questions</p>
          <p className="text-sm font-bold text-slate-900 dark:text-white mt-1">{questionCount}</p>
        </div>
        <div className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
          <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Critical / Max score</p>
          <p className="text-sm font-bold text-slate-900 dark:text-white mt-1">
            {criticalCount} / {maxScore}
          </p>
        </div>
      </div>

      <div className="mt-3 flex flex-wrap items-center gap-2">
        <button
          type="button"
          onClick={addQuestion}
          disabled={!isInCertAdmin}
          className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 disabled:opacity-50 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
        >
          Add question
        </button>
        <button
          type="button"
          onClick={resetDraft}
          className="px-2.5 py-1 rounded-full bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200 text-[11px] font-bold"
        >
          Reset draft
        </button>
        <button
          type="button"
          disabled={!selectedTemplateId}
          onClick={() => onPublishTemplateBlueprint?.(selectedTemplateId, 'Published from Template Studio')}
          className="px-2.5 py-1 rounded-full bg-amber-100 text-amber-700 disabled:opacity-50 dark:bg-amber-900/40 dark:text-amber-300 text-[11px] font-bold"
        >
          Publish update
        </button>
      </div>
      {!isInCertAdmin && (
        <p className="mt-2 text-xs text-amber-700 dark:text-amber-300">Read-only mode. InCert admin role required to edit and save templates.</p>
      )}

      <form onSubmit={saveQuestionBank} className="mt-4 space-y-2">
        <fieldset disabled={!isInCertAdmin} className={`space-y-2 max-h-[42rem] overflow-y-auto pr-1 ${!isInCertAdmin ? 'opacity-80' : ''}`}>
          {selectedTemplate ? (
            questionDraft.map((question, index) => (
              <article
                key={`${question.id || 'question'}-${index}`}
                className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 p-3 space-y-3"
              >
                <div className="flex items-center justify-between gap-3">
                  <p className="text-xs font-bold text-slate-700 dark:text-slate-200">
                    Q{index + 1} {question.id ? `â¢ ${question.id}` : ''}
                  </p>
                  <button
                    type="button"
                    onClick={() => removeQuestion(index)}
                    className="px-2 py-0.5 rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300 text-[11px] font-bold"
                  >
                    Remove
                  </button>
                </div>

                <div className="grid gap-3 md:grid-cols-4">
                  <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                    Question ID
                    <input
                      value={question.id || ''}
                      onChange={(event) => updateQuestionDraftAt(index, { id: event.target.value })}
                      className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                    />
                  </label>
                  <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                    Type
                    <select
                      value={question.type || 'boolean'}
                      onChange={(event) => updateQuestionDraftAt(index, { type: event.target.value })}
                      className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                    >
                      {TEMPLATE_QUESTION_TYPES.map((typeOption) => (
                        <option key={`${question.id || index}-${typeOption}`} value={typeOption}>
                          {typeOption}
                        </option>
                      ))}
                    </select>
                  </label>
                  <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                    Weight
                    <input
                      type="number"
                      min={1}
                      value={question.weight ?? 1}
                      onChange={(event) => updateQuestionDraftAt(index, { weight: Math.max(1, Number(event.target.value || 1)) })}
                      className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                    />
                  </label>
                  <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                    Category
                    <input
                      value={question.category || ''}
                      onChange={(event) => updateQuestionDraftAt(index, { category: event.target.value })}
                      className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                    />
                  </label>
                </div>

                <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
                  Question text
                  <textarea
                    rows={2}
                    value={question.text || ''}
                    onChange={(event) => updateQuestionDraftAt(index, { text: event.target.value })}
                    className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                  />
                </label>

                <div className="grid gap-3 md:grid-cols-2">
                  <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                    Show-if rule
                    <input
                      value={question.showIf || ''}
                      onChange={(event) => updateQuestionDraftAt(index, { showIf: event.target.value })}
                      className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                    />
                  </label>
                  <div className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                    Flags and evidence
                    <div className="mt-1 flex flex-wrap items-center gap-3">
                      <label className="inline-flex items-center gap-1.5">
                        <input
                          type="checkbox"
                          checked={Boolean(question.critical)}
                          onChange={(event) => updateQuestionDraftAt(index, { critical: event.target.checked })}
                        />
                        Critical
                      </label>
                      <label className="inline-flex items-center gap-1.5">
                        <input
                          type="checkbox"
                          checked={Boolean(question.required)}
                          onChange={(event) => updateQuestionDraftAt(index, { required: event.target.checked })}
                        />
                        Required
                      </label>
                      <label className="inline-flex items-center gap-1.5">
                        <input
                          type="checkbox"
                          checked={Boolean(question?.evidence?.photo)}
                          onChange={(event) => updateQuestionDraftAt(index, { evidence: { ...question.evidence, photo: event.target.checked } })}
                        />
                        Photo
                      </label>
                      <label className="inline-flex items-center gap-1.5">
                        <input
                          type="checkbox"
                          checked={question?.evidence?.comment !== false}
                          onChange={(event) => updateQuestionDraftAt(index, { evidence: { ...question.evidence, comment: event.target.checked } })}
                        />
                        Comment
                      </label>
                      <label className="inline-flex items-center gap-1.5">
                        <input
                          type="checkbox"
                          checked={Boolean(question?.evidence?.signature)}
                          onChange={(event) => updateQuestionDraftAt(index, { evidence: { ...question.evidence, signature: event.target.checked } })}
                        />
                        Signature
                      </label>
                    </div>
                  </div>
                </div>
              </article>
            ))
          ) : (
            <p className="text-xs text-slate-600 dark:text-slate-300">No template blueprint available yet.</p>
          )}
        </fieldset>

        <div className="pt-1">
          <button
            type="submit"
            disabled={!isInCertAdmin || !selectedTemplate}
            className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 text-white text-xs font-bold transition-colors"
          >
            <CheckCircle2 className="w-3.5 h-3.5" />
            Save Question Bank
          </button>
        </div>
      </form>

      <section className="mt-6 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/75 dark:bg-slate-900/45 p-4 md:p-5 space-y-4">
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Report Templates</p>
            <h3 className="text-base md:text-lg font-bold text-slate-900 dark:text-white mt-1">Completed HTML Report Output (PDF Evidence View)</h3>
            <p className="text-xs md:text-sm text-slate-600 dark:text-slate-300 mt-1 max-w-3xl">
              Every template renders a completed report with scoring, recommendations, addresses, contact numbers, evidence ledger, QR verification,
              and tamper-evident vault metadata.
            </p>
          </div>
          <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
            Preview template
            <select
              value={previewTemplateId}
              onChange={(event) => setPreviewTemplateId(event.target.value)}
              className="mt-1 w-full min-w-[18rem] px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
            >
              {templateBlueprints.map((template) => (
                <option key={`preview-${template.id}`} value={template.id}>
                  {template.id} - {template.name}
                </option>
              ))}
            </select>
          </label>
        </div>

        <div className="grid gap-4 xl:grid-cols-[19rem_1fr]">
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/85 dark:bg-slate-900/35 p-2.5 max-h-[46rem] overflow-y-auto">
            {templateBlueprints.map((template) => {
              const isSelected = template.id === previewTemplateId;
              return (
                <button
                  key={`preview-list-${template.id}`}
                  type="button"
                  onClick={() => setPreviewTemplateId(template.id)}
                  className={`w-full text-left rounded-lg border px-3 py-2.5 mb-2 transition-colors ${
                    isSelected
                      ? 'border-cyan-300 bg-cyan-50 text-cyan-800 dark:border-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-100'
                      : 'border-slate-200 bg-white text-slate-700 hover:border-slate-300 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-200'
                  }`}
                >
                  <p className="text-xs font-bold">{template.name}</p>
                  <p className="text-[11px] mt-0.5 opacity-80">
                    {template.id} Â· {template.category} Â· {(template.questionBank || []).length} questions
                  </p>
                </button>
              );
            })}
          </div>

          <div>
            {previewTemplate ? (
              <TemplateEvidenceReportPreview template={previewTemplate} templateIndex={previewTemplateIndex} />
            ) : (
              <p className="text-xs text-slate-600 dark:text-slate-300">Select a template to preview its completed report output.</p>
            )}
          </div>
        </div>
      </section>
    </section>
  );
}

function HelpCenterView({
  onNotify,
  isInCertAdmin = false,
  jobs = [],
  certificates = [],
  companyContext = { id: '', name: 'Acme Logistics' },
  publicSiteConfig = defaultPublicSiteConfig,
  onboardingTasks = [],
  financeInvoices = [],
  payoutRuns = [],
  inspectionTemplates = [],
  integrationConnections = [],
  templateBlueprints = [],
  templateListings = [],
  licenceGrants = [],
  auditRuns = [],
  auditFindings = [],
  auditActions = [],
  reportArtifacts = [],
  shareLinks = [],
  marketplaceBidBoard = [],
  dispatchSlaEvents = [],
  evidenceAiJobs = [],
  regulatorVerificationRequests = [],
  analyticsRiskSignals = [],
  webhookDeliveryEvents = [],
  mobileAuditSessions = [],
  enterpriseSecurityEvents = [],
  qaHarnessRuns = [],
  releaseGateResults = [],
  onUpdatePublicSiteConfig,
  onToggleOnboardingTask,
  onRunPilotFulfilmentLoop,
  onSignCertificate,
  onGenerateInvoices,
  onApproveInvoice,
  onSchedulePayout,
  onAddTemplate,
  onToggleTemplate,
  onConnectIntegration,
  onCreateTemplateBlueprint,
  onUpdateTemplateBlueprint,
  onPublishTemplateBlueprint,
  onCreateTemplateListing,
  onGrantTemplateLicence,
  onStartAuditRun,
  onCompleteAuditRun,
  onAddAuditFinding,
  onCreateAuditAction,
  onAdvanceAuditActionStatus,
  onCreateShareLink,
  onSeedBidRound,
  onAwardBestBid,
  onQueueEvidenceAiJob,
  onAdvanceEvidenceReview,
  onCreateVerificationRequest,
  onResolveVerificationRequest,
  onTriggerWebhookRetry,
  onOpenMobileSession,
  onLogSecurityEvent,
  onStartQaHarnessRun,
  onFinalizeQaHarnessRun,
  onAdvanceReleaseGateResult,
}) {
  const [siteForm, setSiteForm] = useState(() => ({
    siteTitle: publicSiteConfig.siteTitle || '',
    siteSlug: publicSiteConfig.siteSlug || '',
    supportEmail: publicSiteConfig.supportEmail || '',
    verificationPath: publicSiteConfig.verificationPath || '/verify',
    launchStatus: publicSiteConfig.launchStatus || 'draft',
    launchDate: publicSiteConfig.launchDate || '',
  }));
  const [templateForm, setTemplateForm] = useState({
    regime: 'PUWER',
    scope: 'company',
    name: '',
    controls: '',
  });
  const [integrationForm, setIntegrationForm] = useState(() =>
    integrationConnections.reduce((accumulator, integration) => {
      accumulator[integration.id] = integration.endpoint || '';
      return accumulator;
    }, {})
  );
  const [blueprintForm, setBlueprintForm] = useState({
    name: '',
    category: 'HS',
    scoringModel: 'weighted_sections',
    licenceModel: 'multi_use',
    blockTypes: 'section,yes_no_na,photo,signature',
    mandatoryEvidenceBlocks: 2,
  });
  const [listingForm, setListingForm] = useState(() => ({
    templateId: templateBlueprints[0]?.id || '',
    priceModel: 'single_use',
    price: 99,
    tags: 'hs,operations',
    vettingTier: 'community',
  }));
  const [licenceForm, setLicenceForm] = useState(() => ({
    listingId: templateListings[0]?.id || '',
    buyerOrgId: '',
    licenceType: 'multi_use',
    seats: 10,
    uses: 1,
    allowedExports: 'pdf,json',
    watermarkRules: 'none',
    canFork: false,
  }));
  const [runForm, setRunForm] = useState(() => ({
    auditJobId: jobs[0]?.id || '',
    templateId: templateBlueprints[0]?.id || '',
    offlineSyncState: 'queued',
    gpsPolicy: 'optional',
  }));
  const [findingForm, setFindingForm] = useState(() => ({
    auditRunId: auditRuns[0]?.id || '',
    severity: 'medium',
    taxonomyCode: 'GENERAL',
    description: '',
  }));
  const [actionForm, setActionForm] = useState(() => ({
    findingId: auditFindings[0]?.id || '',
    assignee: 'Site Manager',
    dueDate: '',
    evidenceRequired: true,
    closureSignoff: 'auditor',
  }));
  const [selectedBlueprintEditorId, setSelectedBlueprintEditorId] = useState(() => templateBlueprints[0]?.id || '');
  const [blueprintQuestionDraft, setBlueprintQuestionDraft] = useState([]);

  useEffect(() => {
    setSiteForm({
      siteTitle: publicSiteConfig.siteTitle || '',
      siteSlug: publicSiteConfig.siteSlug || '',
      supportEmail: publicSiteConfig.supportEmail || '',
      verificationPath: publicSiteConfig.verificationPath || '/verify',
      launchStatus: publicSiteConfig.launchStatus || 'draft',
      launchDate: publicSiteConfig.launchDate || '',
    });
  }, [publicSiteConfig]);

  useEffect(() => {
    setIntegrationForm((previous) =>
      integrationConnections.reduce((accumulator, integration) => {
        accumulator[integration.id] = previous[integration.id] ?? integration.endpoint ?? '';
        return accumulator;
      }, {})
    );
  }, [integrationConnections]);

  useEffect(() => {
    setListingForm((previous) => ({
      ...previous,
      templateId:
        templateBlueprints.some((template) => template.id === previous.templateId)
          ? previous.templateId
          : templateBlueprints[0]?.id || '',
    }));
    setRunForm((previous) => ({
      ...previous,
      templateId:
        templateBlueprints.some((template) => template.id === previous.templateId)
          ? previous.templateId
          : templateBlueprints[0]?.id || '',
    }));
    setSelectedBlueprintEditorId((previous) =>
      templateBlueprints.some((template) => template.id === previous) ? previous : templateBlueprints[0]?.id || ''
    );
  }, [templateBlueprints]);

  useEffect(() => {
    setLicenceForm((previous) => ({
      ...previous,
      listingId:
        templateListings.some((listing) => listing.id === previous.listingId)
          ? previous.listingId
          : templateListings[0]?.id || '',
    }));
  }, [templateListings]);

  useEffect(() => {
    setRunForm((previous) => ({
      ...previous,
      auditJobId: jobs.some((job) => job.id === previous.auditJobId) ? previous.auditJobId : jobs[0]?.id || '',
    }));
  }, [jobs]);

  useEffect(() => {
    setFindingForm((previous) => ({
      ...previous,
      auditRunId: auditRuns.some((run) => run.id === previous.auditRunId) ? previous.auditRunId : auditRuns[0]?.id || '',
    }));
  }, [auditRuns]);

  useEffect(() => {
    setActionForm((previous) => ({
      ...previous,
      findingId:
        auditFindings.some((finding) => finding.id === previous.findingId)
          ? previous.findingId
          : auditFindings[0]?.id || '',
    }));
  }, [auditFindings]);

  useEffect(() => {
    const selectedTemplate = templateBlueprints.find((template) => template.id === selectedBlueprintEditorId);
    const questionPrefix = String(selectedTemplate?.category || selectedTemplate?.id || 'Q');
    setBlueprintQuestionDraft(normalizeTemplateQuestionBank(selectedTemplate?.questionBank || [], questionPrefix));
  }, [selectedBlueprintEditorId, templateBlueprints]);

  const onboardingCompleted = onboardingTasks.filter((task) => task.completed).length;
  const onboardingProgress = onboardingTasks.length > 0 ? Math.round((onboardingCompleted / onboardingTasks.length) * 100) : 0;
  const openJobs = jobs.filter((job) => job.status === 'open');
  const dispatchedJobs = jobs.filter((job) => job.status === 'dispatched');
  const completedJobs = jobs.filter((job) => job.status === 'completed');
  const unsignedCertificates = certificates.filter((certificate) => !certificate.signedAt);
  const pendingInvoices = financeInvoices.filter((invoice) => invoice.status === 'pending_approval');
  const approvedInvoices = financeInvoices.filter((invoice) => invoice.status === 'approved');
  const scheduledPayouts = payoutRuns.filter((run) => run.status === 'scheduled');
  const connectedIntegrations = integrationConnections.filter((integration) => integration.status === 'connected');
  const recentInvoices = financeInvoices.slice(0, 6);
  const recentPayoutRuns = payoutRuns.slice(0, 5);
  const publishedBlueprints = templateBlueprints.filter((template) => template.status === 'published');
  const activeListings = templateListings.filter((listing) => listing.status === 'active');
  const liveLicenceGrants = licenceGrants.filter((grant) => {
    if (!grant.endAt) {
      return true;
    }
    const expiry = new Date(grant.endAt).getTime();
    return !Number.isNaN(expiry) && expiry >= Date.now();
  });
  const inProgressRuns = auditRuns.filter((run) => run.status === 'in_progress');
  const completedRuns = auditRuns.filter((run) => run.status === 'completed');
  const openFindings = auditFindings.filter((finding) => finding.status !== 'closed');
  const openActionCount = auditActions.filter((action) => action.status !== 'closed').length;
  const validArtifacts = reportArtifacts.filter((artifact) => artifact.status === 'valid');
  const submittedBidCount = marketplaceBidBoard.filter((bid) => bid.status === 'submitted').length;
  const awardedBidCount = marketplaceBidBoard.filter((bid) => bid.status === 'awarded').length;
  const slaBreachCount = dispatchSlaEvents.filter((event) => Boolean(event.isBreach)).length;
  const evidenceQueueCount = evidenceAiJobs.filter((job) => job.status === 'queued').length;
  const evidencePendingReviewCount = evidenceAiJobs.filter(
    (job) => job.status === 'completed' && job.reviewDecision === 'pending'
  ).length;
  const openVerificationRequests = regulatorVerificationRequests.filter((request) => request.status === 'open').length;
  const highRiskSignals = analyticsRiskSignals.filter((signal) => signal.riskLevel === 'high').length;
  const failedWebhookDeliveries = webhookDeliveryEvents.filter((event) => event.status === 'failed').length;
  const activeMobileSessions = mobileAuditSessions.filter((session) => !session.closedAt).length;
  const highSeveritySecurityEvents = enterpriseSecurityEvents.filter((event) => event.severity === 'high').length;
  const runningQaRuns = qaHarnessRuns.filter((run) => run.status === 'running').length;
  const pendingReleaseGates = releaseGateResults.filter((gate) => gate.status === 'pending').length;
  const prioritizedInspectionTemplates = useMemo(() => {
    const resolvedContext = resolveCompanyTemplateContext(companyContext);
    const getTemplatePriority = (template) => {
      const visibility = getTemplateVisibility(template);
      if (visibility === 'company' && isTemplateVisibleForCompany(template, resolvedContext)) {
        return 0;
      }
      if (visibility === 'global' && String(template?.id || '').startsWith('TPL-CUSTOM-')) {
        return 1;
      }
      if (visibility === 'global') {
        return 2;
      }
      return 3;
    };

    return [...inspectionTemplates]
      .sort((first, second) => {
        const priorityDelta = getTemplatePriority(first) - getTemplatePriority(second);
        if (priorityDelta !== 0) {
          return priorityDelta;
        }
        const firstName = String(first?.name || '').toLowerCase();
        const secondName = String(second?.name || '').toLowerCase();
        return firstName.localeCompare(secondName);
      })
      .slice(0, 6);
  }, [inspectionTemplates, companyContext]);
  const findingsByRunId = useMemo(() => {
    const grouped = new Map();
    auditFindings.forEach((finding) => {
      if (!grouped.has(finding.auditRunId)) {
        grouped.set(finding.auditRunId, []);
      }
      grouped.get(finding.auditRunId).push(finding);
    });
    return grouped;
  }, [auditFindings]);
  const actionsByFindingId = useMemo(() => {
    const grouped = new Map();
    auditActions.forEach((action) => {
      if (!grouped.has(action.findingId)) {
        grouped.set(action.findingId, []);
      }
      grouped.get(action.findingId).push(action);
    });
    return grouped;
  }, [auditActions]);

  const executionPhases = [
    {
      phase: 'Foundation',
      summary: 'Public site, onboarding, and operator portal baseline.',
      metric: `${onboardingCompleted}/${onboardingTasks.length || 0} onboarding tasks complete`,
      status: onboardingProgress === 100 ? 'complete' : onboardingProgress > 0 ? 'active' : 'attention',
    },
    {
      phase: 'Liquidity',
      summary: 'Pricing engine, dispatch SLAs, and pilot fulfilment loops.',
      metric: `${openJobs.length} open jobs, ${dispatchedJobs.length} dispatched`,
      status: openJobs.length > 0 || dispatchedJobs.length > 0 ? 'active' : 'attention',
    },
    {
      phase: 'Trust Layer',
      summary: 'Certificate signing, verification links, and evidence API.',
      metric: `${unsignedCertificates.length} unsigned certificates`,
      status: unsignedCertificates.length === 0 ? 'complete' : 'active',
    },
    {
      phase: 'Money Movement',
      summary: 'PO workflow, invoicing, and payout orchestration.',
      metric: `${financeInvoices.length} invoices, ${scheduledPayouts.length} scheduled payouts`,
      status: financeInvoices.length > 0 ? 'active' : 'attention',
    },
    {
      phase: 'Expansion',
      summary: 'Deeper PUWER/PSSR templates and enterprise integrations.',
      metric: `${publishedBlueprints.length} published templates, ${activeListings.length} listings, ${openActionCount} open actions`,
      status: publishedBlueprints.length > 0 || connectedIntegrations.length > 0 ? 'active' : 'attention',
    },
  ];

  const phaseStatusClasses = {
    complete: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300',
    active: 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300',
    attention: 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300',
  };

  const formatDateCell = (value) => {
    if (!value) {
      return '-';
    }

    const parsed = new Date(value);
    if (Number.isNaN(parsed.getTime())) {
      return String(value);
    }

    return new Intl.DateTimeFormat('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
    }).format(parsed);
  };

  const handleSaveFoundation = (event) => {
    event.preventDefault();
    onUpdatePublicSiteConfig?.(siteForm);
    onNotify?.('Foundation configuration saved', 'success');
  };

  const handleTemplateSubmit = (event) => {
    event.preventDefault();
    const wasCreated = onAddTemplate?.(templateForm);
    if (wasCreated) {
      setTemplateForm({
        regime: templateForm.regime,
        scope: templateForm.scope,
        name: '',
        controls: '',
      });
    }
  };

  const handleBlueprintSubmit = (event) => {
    event.preventDefault();
    const wasCreated = onCreateTemplateBlueprint?.(blueprintForm);
    if (wasCreated) {
      setBlueprintForm((previous) => ({
        ...previous,
        name: '',
      }));
    }
  };

  const handleListingSubmit = (event) => {
    event.preventDefault();
    onCreateTemplateListing?.(listingForm);
  };

  const handleLicenceSubmit = (event) => {
    event.preventDefault();
    const wasGranted = onGrantTemplateLicence?.(licenceForm);
    if (wasGranted) {
      setLicenceForm((previous) => ({
        ...previous,
        buyerOrgId: '',
      }));
    }
  };

  const handleRunSubmit = (event) => {
    event.preventDefault();
    onStartAuditRun?.(runForm);
  };

  const handleFindingSubmit = (event) => {
    event.preventDefault();
    const wasCreated = onAddAuditFinding?.(findingForm);
    if (wasCreated) {
      setFindingForm((previous) => ({
        ...previous,
        description: '',
      }));
    }
  };

  const handleActionSubmit = (event) => {
    event.preventDefault();
    onCreateAuditAction?.(actionForm);
  };

  const updateQuestionDraftAt = (index, patch) => {
    if (!isInCertAdmin) {
      return;
    }
    setBlueprintQuestionDraft((previousQuestions) =>
      previousQuestions.map((question, questionIndex) => {
        if (questionIndex !== index) {
          return question;
        }
        const nextEvidence = patch?.evidence
          ? {
              photo: Boolean(patch.evidence.photo ?? question?.evidence?.photo),
              comment:
                patch.evidence.comment !== undefined
                  ? Boolean(patch.evidence.comment)
                  : question?.evidence?.comment !== false,
              signature: Boolean(patch.evidence.signature ?? question?.evidence?.signature),
            }
          : question?.evidence || { photo: false, comment: true, signature: false };

        return {
          ...question,
          ...patch,
          evidence: nextEvidence,
        };
      })
    );
  };

  const addQuestionToDraft = () => {
    if (!isInCertAdmin) {
      onNotify?.('Only InCert admins can edit template questions', 'info');
      return;
    }
    const selectedTemplate = templateBlueprints.find((template) => template.id === selectedBlueprintEditorId);
    const fallbackPrefix = String(selectedTemplate?.category || selectedTemplate?.id || 'Q');
    setBlueprintQuestionDraft((previousQuestions) => {
      const nextQuestions = [
        ...previousQuestions,
        {
          id: '',
          category: 'General',
          text: '',
          type: 'boolean',
          options: { yes: 1, no: 0 },
          weight: 1,
          critical: false,
          required: false,
          evidence: { photo: false, comment: true, signature: false },
          showIf: null,
        },
      ];
      return normalizeTemplateQuestionBank(nextQuestions, fallbackPrefix);
    });
  };

  const removeQuestionFromDraft = (index) => {
    if (!isInCertAdmin) {
      onNotify?.('Only InCert admins can edit template questions', 'info');
      return;
    }
    const selectedTemplate = templateBlueprints.find((template) => template.id === selectedBlueprintEditorId);
    const fallbackPrefix = String(selectedTemplate?.category || selectedTemplate?.id || 'Q');
    setBlueprintQuestionDraft((previousQuestions) =>
      normalizeTemplateQuestionBank(previousQuestions.filter((_, questionIndex) => questionIndex !== index), fallbackPrefix)
    );
  };

  const resetQuestionDraft = () => {
    const selectedTemplate = templateBlueprints.find((template) => template.id === selectedBlueprintEditorId);
    const fallbackPrefix = String(selectedTemplate?.category || selectedTemplate?.id || 'Q');
    setBlueprintQuestionDraft(normalizeTemplateQuestionBank(selectedTemplate?.questionBank || [], fallbackPrefix));
  };

  const handleQuestionBankSave = (event) => {
    event.preventDefault();
    if (!isInCertAdmin) {
      onNotify?.('Only InCert admins can save template changes', 'info');
      return;
    }
    if (!selectedBlueprintEditorId) {
      onNotify?.('Select a template blueprint first', 'info');
      return;
    }
    onUpdateTemplateBlueprint?.({
      templateId: selectedBlueprintEditorId,
      questionBank: blueprintQuestionDraft,
    });
  };

  const selectedBlueprintForEditor = templateBlueprints.find((template) => template.id === selectedBlueprintEditorId) || null;
  const draftQuestionCount = blueprintQuestionDraft.length;
  const draftCriticalCount = blueprintQuestionDraft.filter(
    (question) => String(question.type || '') === 'boolean' && Boolean(question.critical)
  ).length;
  const draftWeightTotal = blueprintQuestionDraft.reduce(
    (total, question) => total + Math.max(1, Number(question.weight || 1)),
    0
  );

  return (
    <div className="space-y-5 animate-in fade-in duration-300">
      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-6 shadow-sm transition-colors duration-300">
        <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Execution mode</p>
            <h2 className="text-xl md:text-2xl font-bold text-slate-900 dark:text-white mt-1">Delivery Execution Console</h2>
            <p className="text-sm text-slate-600 dark:text-slate-300 mt-2 max-w-3xl">
              Roadmap items now run as live workflows. Configure each phase and execute actions directly from this tab.
            </p>
          </div>
          <button
            onClick={() => onNotify?.('Support contact placeholder', 'info')}
            className="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-bold transition-colors shadow-sm"
          >
            <Info className="w-4 h-4" />
            Contact Support
          </button>
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
        <h3 className="text-base font-bold text-slate-900 dark:text-white">Phase Status</h3>
        <div className="mt-4 grid gap-3 md:grid-cols-2 xl:grid-cols-5">
          {executionPhases.map((phase) => (
            <article
              key={phase.phase}
              className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4"
            >
              <div className="flex items-center justify-between gap-2">
                <h4 className="text-sm font-bold text-slate-900 dark:text-white">{phase.phase}</h4>
                <span className={`text-[11px] font-bold rounded-full px-2.5 py-1 ${phaseStatusClasses[phase.status]}`}>
                  {phase.status === 'complete' ? 'Complete' : phase.status === 'active' ? 'Active' : 'Needs input'}
                </span>
              </div>
              <p className="text-xs text-slate-600 dark:text-slate-300 mt-2">{phase.summary}</p>
              <p className="text-xs font-semibold text-slate-700 dark:text-slate-200 mt-3">{phase.metric}</p>
            </article>
          ))}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
        <div className="flex items-center justify-between gap-2">
          <h3 className="text-base font-bold text-slate-900 dark:text-white">Foundation</h3>
          <span className="text-[11px] font-bold rounded-full px-2.5 py-1 bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300">
            Months 1-3
          </span>
        </div>
        <div className="mt-4 grid gap-4 xl:grid-cols-[1.1fr_1fr]">
          <form onSubmit={handleSaveFoundation} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Public site configuration</p>
            <div className="grid gap-3 md:grid-cols-2">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Site title
                <input
                  required
                  value={siteForm.siteTitle}
                  onChange={(event) => setSiteForm((previous) => ({ ...previous, siteTitle: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Site slug
                <input
                  required
                  value={siteForm.siteSlug}
                  onChange={(event) => setSiteForm((previous) => ({ ...previous, siteSlug: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Support email
                <input
                  required
                  type="email"
                  value={siteForm.supportEmail}
                  onChange={(event) => setSiteForm((previous) => ({ ...previous, supportEmail: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Verification path
                <input
                  required
                  value={siteForm.verificationPath}
                  onChange={(event) => setSiteForm((previous) => ({ ...previous, verificationPath: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Launch status
                <select
                  value={siteForm.launchStatus}
                  onChange={(event) => setSiteForm((previous) => ({ ...previous, launchStatus: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="draft">Draft</option>
                  <option value="live">Live</option>
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Launch date
                <input
                  type="date"
                  value={siteForm.launchDate}
                  onChange={(event) => setSiteForm((previous) => ({ ...previous, launchDate: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm dark:[color-scheme:dark]"
                />
              </label>
            </div>
            <div className="flex items-center justify-between gap-3">
              <p className="text-xs text-slate-500 dark:text-slate-400">
                Last update: {publicSiteConfig.updatedAt ? formatDateCell(publicSiteConfig.updatedAt) : 'none yet'}
              </p>
              <button
                type="submit"
                className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
              >
                <CheckCircle2 className="w-3.5 h-3.5" />
                Save Foundation
              </button>
            </div>
          </form>

          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Onboarding checklist</p>
            <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">{onboardingProgress}% complete</p>
            <div className="mt-3 space-y-2">
              {onboardingTasks.map((task) => (
                <div
                  key={task.id}
                  className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5 flex items-center justify-between gap-3"
                >
                  <div className="min-w-0">
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{task.label}</p>
                  </div>
                  <button
                    onClick={() => onToggleOnboardingTask?.(task.id)}
                    className={`px-2.5 py-1 rounded-full text-[11px] font-bold ${
                      task.completed
                        ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                        : 'bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200'
                    }`}
                  >
                    {task.completed ? 'Completed' : 'Mark complete'}
                  </button>
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h3 className="text-base font-bold text-slate-900 dark:text-white">Liquidity</h3>
            <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
              Pricing engine and dispatch loops are live. Run pilot fulfilment to auto-dispatch open jobs.
            </p>
          </div>
          <button
            onClick={() => onRunPilotFulfilmentLoop?.()}
            className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
          >
            <Zap className="w-3.5 h-3.5" />
            Run Pilot Fulfilment
          </button>
        </div>

        <div className="mt-4 grid gap-3 md:grid-cols-3">
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Open jobs</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{openJobs.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Dispatched jobs</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{dispatchedJobs.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Completed jobs</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{completedJobs.length}</p>
          </article>
        </div>

        <div className="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div className="bg-slate-100/80 dark:bg-slate-900/45 px-3 py-2 text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
            Open job queue
          </div>
          {openJobs.length === 0 ? (
            <p className="px-3 py-4 text-xs text-slate-600 dark:text-slate-300">No open jobs waiting for dispatch.</p>
          ) : (
            openJobs.slice(0, 5).map((job) => {
              const pricing = getMarketplaceJobPricing(job);
              return (
                <div key={job.id} className="px-3 py-2.5 border-t border-slate-200 dark:border-slate-700 flex items-center justify-between gap-3">
                  <div>
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                      {job.id} - {job.assetName}
                    </p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400">
                      Due {formatDateLabel(job.dueDate)} | {job.regime}
                    </p>
                  </div>
                  <p className="text-xs font-bold text-slate-700 dark:text-slate-200">{formatCurrencyGBP(pricing.total)}</p>
                </div>
              );
            })
          )}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
        <div className="flex items-center justify-between gap-3">
          <div>
            <h3 className="text-base font-bold text-slate-900 dark:text-white">Trust Layer</h3>
            <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
              Sign certificates and publish verification links from the evidence trust controls.
            </p>
          </div>
          <span className="text-[11px] font-bold rounded-full px-2.5 py-1 bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300">
            Months 5-8
          </span>
        </div>

        <div className="mt-4 grid gap-3 md:grid-cols-2">
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Pending signatures</p>
            <div className="mt-3 space-y-2">
              {unsignedCertificates.length === 0 ? (
                <p className="text-xs text-slate-600 dark:text-slate-300">All certificates are signed.</p>
              ) : (
                unsignedCertificates.slice(0, 5).map((certificate) => (
                  <div
                    key={certificate.id}
                    className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5 flex items-center justify-between gap-3"
                  >
                    <div className="min-w-0">
                      <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{certificate.id}</p>
                      <p className="text-[11px] text-slate-500 dark:text-slate-400 truncate">{certificate.assetName}</p>
                    </div>
                    <button
                      onClick={() => onSignCertificate?.(certificate.id)}
                      className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                    >
                      Sign now
                    </button>
                  </div>
                ))
              )}
            </div>
          </div>

          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Recently signed</p>
            <div className="mt-3 space-y-2">
              {certificates
                .filter((certificate) => certificate.signedAt)
                .slice(0, 5)
                .map((certificate) => (
                  <div
                    key={certificate.id}
                    className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5"
                  >
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{certificate.id}</p>
                        <p className="text-[11px] text-slate-500 dark:text-slate-400">Signed {formatDateCell(certificate.signedAt)}</p>
                      </div>
                      <a
                        href={buildCertificateDeepLink(certificate.id)}
                        className="text-[11px] font-bold text-cyan-700 dark:text-cyan-300 hover:underline"
                      >
                        Verification link
                      </a>
                    </div>
                  </div>
                ))}
              {certificates.filter((certificate) => certificate.signedAt).length === 0 && (
                <p className="text-xs text-slate-600 dark:text-slate-300">No signed certificates yet.</p>
              )}
            </div>
          </div>
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h3 className="text-base font-bold text-slate-900 dark:text-white">Money Movement</h3>
            <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
              Generate VAT-ready invoices, approve them, and schedule provider payouts.
            </p>
          </div>
          <button
            onClick={() => onGenerateInvoices?.()}
            className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
          >
            <FileText className="w-3.5 h-3.5" />
            Generate Missing Invoices
          </button>
        </div>

        <div className="mt-4 grid gap-3 md:grid-cols-3">
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Pending approval</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{pendingInvoices.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Approved invoices</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{approvedInvoices.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Scheduled payouts</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{scheduledPayouts.length}</p>
          </article>
        </div>

        <div className="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div className="bg-slate-100/80 dark:bg-slate-900/45 px-3 py-2 text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
            Invoice operations
          </div>
          {recentInvoices.length === 0 ? (
            <p className="px-3 py-4 text-xs text-slate-600 dark:text-slate-300">No invoices generated yet.</p>
          ) : (
            recentInvoices.map((invoice) => (
              <div key={invoice.id} className="px-3 py-2.5 border-t border-slate-200 dark:border-slate-700 flex flex-wrap items-center justify-between gap-3">
                <div>
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{invoice.id}</p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400">
                    {invoice.providerName} | {invoice.poNumber} | {formatCurrencyGBP(invoice.totalIncVat)}
                  </p>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-[11px] font-bold px-2 py-1 rounded-full bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200">
                    {invoice.status}
                  </span>
                  {invoice.status === 'pending_approval' && (
                    <button
                      onClick={() => onApproveInvoice?.(invoice.id)}
                      className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                    >
                      Approve
                    </button>
                  )}
                  {invoice.status === 'approved' && (
                    <button
                      onClick={() => onSchedulePayout?.(invoice.id)}
                      className="px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300 text-[11px] font-bold"
                    >
                      Schedule payout
                    </button>
                  )}
                </div>
              </div>
            ))
          )}
        </div>

        <div className="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div className="bg-slate-100/80 dark:bg-slate-900/45 px-3 py-2 text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
            Payout schedule
          </div>
          {recentPayoutRuns.length === 0 ? (
            <p className="px-3 py-4 text-xs text-slate-600 dark:text-slate-300">No payout runs scheduled yet.</p>
          ) : (
            recentPayoutRuns.map((run) => (
              <div key={run.id} className="px-3 py-2.5 border-t border-slate-200 dark:border-slate-700 flex items-center justify-between gap-3">
                <div>
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{run.id}</p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400">
                    {run.providerName} | Scheduled {formatDateCell(run.scheduledPayoutDate)}
                  </p>
                </div>
                <p className="text-xs font-bold text-slate-700 dark:text-slate-200">{formatCurrencyGBP(run.payoutAmount)}</p>
              </div>
            ))
          )}
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
        <div className="flex items-center justify-between gap-3">
          <div>
            <h3 className="text-base font-bold text-slate-900 dark:text-white">Expansion</h3>
            <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
              Template builder, marketplace licensing, audit runs, findings, actions, and evidence link generation.
            </p>
          </div>
          <span className="text-[11px] font-bold rounded-full px-2.5 py-1 bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300">
            Months 10-12
          </span>
        </div>

        <form
          onSubmit={handleQuestionBankSave}
          className="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3"
        >
          <div className="flex flex-wrap items-start justify-between gap-3">
            <div>
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                Template Question Viewer
              </p>
              <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
                View every question in the selected template, edit weighting and controls, then save an updated version.
              </p>
            </div>
            <div className="flex flex-wrap items-center gap-2">
              <button
                type="button"
                onClick={addQuestionToDraft}
                disabled={!isInCertAdmin}
                className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 disabled:opacity-50 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
              >
                Add question
              </button>
              <button
                type="button"
                onClick={resetQuestionDraft}
                className="px-2.5 py-1 rounded-full bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200 text-[11px] font-bold"
              >
                Reset draft
              </button>
              <button
                type="submit"
                disabled={!isInCertAdmin}
                className="px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700 disabled:opacity-50 dark:bg-emerald-900/40 dark:text-emerald-300 text-[11px] font-bold"
              >
                Save question bank
              </button>
            </div>
          </div>
          {!isInCertAdmin && (
            <p className="text-xs text-amber-700 dark:text-amber-300">
              Read-only mode. Switch to the InCert admin role to edit and save template questions.
            </p>
          )}

          <div className="grid gap-3 md:grid-cols-4">
            <label className="text-xs font-semibold text-slate-600 dark:text-slate-300 md:col-span-2">
              Blueprint
              <select
                value={selectedBlueprintEditorId}
                onChange={(event) => setSelectedBlueprintEditorId(event.target.value)}
                className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
              >
                {templateBlueprints.map((template) => (
                  <option key={template.id} value={template.id}>
                    {template.id} - {template.name}
                  </option>
                ))}
              </select>
            </label>
            <div className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
              <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Questions</p>
              <p className="text-sm font-bold text-slate-900 dark:text-white mt-1">{draftQuestionCount}</p>
            </div>
            <div className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
              <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                Critical / Max score
              </p>
              <p className="text-sm font-bold text-slate-900 dark:text-white mt-1">
                {draftCriticalCount} / {draftWeightTotal}
              </p>
            </div>
          </div>

          {selectedBlueprintForEditor ? (
            <fieldset disabled={!isInCertAdmin} className={`space-y-2 max-h-[38rem] overflow-y-auto pr-1 ${!isInCertAdmin ? 'opacity-80' : ''}`}>
              {blueprintQuestionDraft.map((question, index) => (
                <article
                  key={`${question.id || 'question'}-${index}`}
                  className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 p-3 space-y-3"
                >
                  <div className="flex items-center justify-between gap-3">
                    <p className="text-xs font-bold text-slate-700 dark:text-slate-200">
                      Q{index + 1} {question.id ? `â¢ ${question.id}` : ''}
                    </p>
                    <button
                      type="button"
                      onClick={() => removeQuestionFromDraft(index)}
                      className="px-2 py-0.5 rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300 text-[11px] font-bold"
                    >
                      Remove
                    </button>
                  </div>

                  <div className="grid gap-3 md:grid-cols-4">
                    <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                      Question ID
                      <input
                        value={question.id || ''}
                        onChange={(event) => updateQuestionDraftAt(index, { id: event.target.value })}
                        className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                      />
                    </label>
                    <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                      Type
                      <select
                        value={question.type || 'boolean'}
                        onChange={(event) => updateQuestionDraftAt(index, { type: event.target.value })}
                        className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                      >
                        {TEMPLATE_QUESTION_TYPES.map((typeOption) => (
                          <option key={`${question.id || index}-${typeOption}`} value={typeOption}>
                            {typeOption}
                          </option>
                        ))}
                      </select>
                    </label>
                    <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                      Weight
                      <input
                        type="number"
                        min={1}
                        value={question.weight ?? 1}
                        onChange={(event) => updateQuestionDraftAt(index, { weight: Math.max(1, Number(event.target.value || 1)) })}
                        className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                      />
                    </label>
                    <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                      Category
                      <input
                        value={question.category || ''}
                        onChange={(event) => updateQuestionDraftAt(index, { category: event.target.value })}
                        className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                      />
                    </label>
                  </div>

                  <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
                    Question text
                    <textarea
                      rows={2}
                      value={question.text || ''}
                      onChange={(event) => updateQuestionDraftAt(index, { text: event.target.value })}
                      className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                    />
                  </label>

                  <div className="grid gap-3 md:grid-cols-2">
                    <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                      Show-if rule
                      <input
                        value={question.showIf || ''}
                        onChange={(event) => updateQuestionDraftAt(index, { showIf: event.target.value })}
                        className="mt-1 w-full px-2.5 py-1.5 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-xs"
                      />
                    </label>
                    <div className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                      Flags and evidence
                      <div className="mt-1 flex flex-wrap items-center gap-3">
                        <label className="inline-flex items-center gap-1.5">
                          <input
                            type="checkbox"
                            checked={Boolean(question.critical)}
                            onChange={(event) => updateQuestionDraftAt(index, { critical: event.target.checked })}
                          />
                          Critical
                        </label>
                        <label className="inline-flex items-center gap-1.5">
                          <input
                            type="checkbox"
                            checked={Boolean(question.required)}
                            onChange={(event) => updateQuestionDraftAt(index, { required: event.target.checked })}
                          />
                          Required
                        </label>
                        <label className="inline-flex items-center gap-1.5">
                          <input
                            type="checkbox"
                            checked={Boolean(question?.evidence?.photo)}
                            onChange={(event) => updateQuestionDraftAt(index, { evidence: { ...question.evidence, photo: event.target.checked } })}
                          />
                          Photo
                        </label>
                        <label className="inline-flex items-center gap-1.5">
                          <input
                            type="checkbox"
                            checked={question?.evidence?.comment !== false}
                            onChange={(event) => updateQuestionDraftAt(index, { evidence: { ...question.evidence, comment: event.target.checked } })}
                          />
                          Comment
                        </label>
                        <label className="inline-flex items-center gap-1.5">
                          <input
                            type="checkbox"
                            checked={Boolean(question?.evidence?.signature)}
                            onChange={(event) => updateQuestionDraftAt(index, { evidence: { ...question.evidence, signature: event.target.checked } })}
                          />
                          Signature
                        </label>
                      </div>
                    </div>
                  </div>
                </article>
              ))}
            </fieldset>
          ) : (
            <p className="text-xs text-slate-600 dark:text-slate-300">No template blueprint available to edit yet.</p>
          )}
        </form>

        <div className="mt-4 grid gap-4 xl:grid-cols-2">
          <form onSubmit={handleTemplateSubmit} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Inspection templates</p>
            <div className="grid gap-3 md:grid-cols-3">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Regime
                <select
                  value={templateForm.regime}
                  onChange={(event) => setTemplateForm((previous) => ({ ...previous, regime: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  {templateRegimeOptions.map((regimeOption) => (
                    <option key={regimeOption} value={regimeOption}>
                      {regimeOption}
                    </option>
                  ))}
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Scope
                <select
                  value={templateForm.scope}
                  onChange={(event) => setTemplateForm((previous) => ({ ...previous, scope: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="company">{companyContext?.name || 'Current company'} bespoke</option>
                  <option value="global">Global baseline</option>
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Template name
                <input
                  required
                  value={templateForm.name}
                  onChange={(event) => setTemplateForm((previous) => ({ ...previous, name: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
            </div>
            <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
              Controls (one per line)
              <textarea
                value={templateForm.controls}
                onChange={(event) => setTemplateForm((previous) => ({ ...previous, controls: event.target.value }))}
                rows={4}
                className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
              />
            </label>
            <p className="text-[11px] text-slate-500 dark:text-slate-400">
              Bespoke templates are saved locally per company now and can be synced to Supabase later.
            </p>
            <button
              type="submit"
              className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
            >
              <Plus className="w-3.5 h-3.5" />
              Add Template
            </button>

            <div className="space-y-2">
              {prioritizedInspectionTemplates.map((template) => (
                <div
                  key={template.id}
                  className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5 flex items-center justify-between gap-3"
                >
                  <div>
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{template.name}</p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400">
                      {template.regime} | v{template.version} | {template.controls.length} controls
                    </p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400">
                      {getTemplateVisibility(template) === 'company'
                        ? `${template.ownerCompanyName || companyContext?.name || 'Company'} bespoke`
                        : 'Global baseline'}
                    </p>
                  </div>
                  <button
                    type="button"
                    onClick={() => onToggleTemplate?.(template.id)}
                    className={`px-2.5 py-1 rounded-full text-[11px] font-bold ${
                      template.active
                        ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                        : 'bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200'
                    }`}
                  >
                    {template.active ? 'Active' : 'Enable'}
                  </button>
                </div>
              ))}
            </div>
          </form>

          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Enterprise integrations</p>
            {integrationConnections.map((integration) => (
              <div
                key={integration.id}
                className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-3 space-y-2"
              >
                <div className="flex items-center justify-between gap-3">
                  <div>
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{integration.name}</p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400">{integration.category}</p>
                  </div>
                  <span
                    className={`text-[11px] font-bold px-2.5 py-1 rounded-full ${
                      integration.status === 'connected'
                        ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                        : 'bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200'
                    }`}
                  >
                    {integration.status === 'connected' ? 'Connected' : 'Not connected'}
                  </span>
                </div>
                <input
                  value={integrationForm[integration.id] ?? ''}
                  onChange={(event) =>
                    setIntegrationForm((previous) => ({
                      ...previous,
                      [integration.id]: event.target.value,
                    }))
                  }
                  placeholder="https://integration-endpoint.example"
                  className="w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
                <div className="flex items-center justify-between gap-3">
                  <p className="text-[11px] text-slate-500 dark:text-slate-400">
                    Last sync: {integration.lastSyncAt ? formatDateCell(integration.lastSyncAt) : 'never'}
                  </p>
                  <button
                    onClick={() => onConnectIntegration?.(integration.id, integrationForm[integration.id] ?? '')}
                    className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                  >
                    Connect
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="mt-4 grid gap-3 md:grid-cols-3 xl:grid-cols-6">
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Published templates</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{publishedBlueprints.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Marketplace listings</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{activeListings.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Live licences</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{liveLicenceGrants.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Audit runs</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">
              {inProgressRuns.length} active / {completedRuns.length} complete
            </p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Open findings</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{openFindings.length}</p>
          </article>
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3">
            <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Valid report artifacts</p>
            <p className="text-lg font-bold text-slate-900 dark:text-white mt-1">{validArtifacts.length}</p>
          </article>
        </div>

        <div className="mt-4 grid gap-4 xl:grid-cols-2">
          <form onSubmit={handleBlueprintSubmit} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Template builder (v1)</p>
            <div className="grid gap-3 md:grid-cols-2">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Template name
                <input
                  required
                  value={blueprintForm.name}
                  onChange={(event) => setBlueprintForm((previous) => ({ ...previous, name: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Category
                <select
                  value={blueprintForm.category}
                  onChange={(event) => setBlueprintForm((previous) => ({ ...previous, category: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  {templateCategoryOptions.map((categoryOption) => (
                    <option key={categoryOption.value} value={categoryOption.value}>
                      {categoryOption.label}
                    </option>
                  ))}
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Scoring model
                <select
                  value={blueprintForm.scoringModel}
                  onChange={(event) => setBlueprintForm((previous) => ({ ...previous, scoringModel: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="pass_fail">Pass/Fail</option>
                  <option value="weighted_sections">Weighted sections</option>
                  <option value="risk_aggregate">Risk aggregate</option>
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Licence model
                <select
                  value={blueprintForm.licenceModel}
                  onChange={(event) => setBlueprintForm((previous) => ({ ...previous, licenceModel: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="single_use">Single-use</option>
                  <option value="multi_use">Multi-use</option>
                  <option value="subscription">Subscription</option>
                </select>
              </label>
            </div>
            <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
              Builder blocks (comma separated)
              <input
                value={blueprintForm.blockTypes}
                onChange={(event) => setBlueprintForm((previous) => ({ ...previous, blockTypes: event.target.value }))}
                className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
              />
            </label>
            <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
              Mandatory evidence blocks
              <input
                type="number"
                min={0}
                value={blueprintForm.mandatoryEvidenceBlocks}
                onChange={(event) =>
                  setBlueprintForm((previous) => ({ ...previous, mandatoryEvidenceBlocks: Number(event.target.value || 0) }))
                }
                className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
              />
            </label>
            <div className="flex flex-wrap items-center gap-2">
              <button
                type="submit"
                className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
              >
                <Plus className="w-3.5 h-3.5" />
                Create Blueprint
              </button>
            </div>

            <div className="space-y-2">
              {templateBlueprints.slice(0, 6).map((template) => (
                <div
                  key={template.id}
                  className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5 flex items-center justify-between gap-3"
                >
                  <div>
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                      {template.name} <span className="text-slate-400">({template.category})</span>
                    </p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400">
                      {template.id} | v{template.currentVersion} | {template.scoringModel.replace('_', ' ')} | {template.blockTypes?.length || 0} block types
                    </p>
                  </div>
                  <button
                    type="button"
                    onClick={() => onPublishTemplateBlueprint?.(template.id, 'Published from expansion console')}
                    className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                  >
                    Publish +
                  </button>
                </div>
              ))}
            </div>
          </form>

          <form onSubmit={handleListingSubmit} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Template marketplace</p>
            <div className="grid gap-3 md:grid-cols-2">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Blueprint
                <select
                  value={listingForm.templateId}
                  onChange={(event) => setListingForm((previous) => ({ ...previous, templateId: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  {templateBlueprints.map((template) => (
                    <option key={template.id} value={template.id}>
                      {template.id} - {template.name}
                    </option>
                  ))}
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Price model
                <select
                  value={listingForm.priceModel}
                  onChange={(event) => setListingForm((previous) => ({ ...previous, priceModel: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="single_use">Single-use</option>
                  <option value="multi_use">Multi-use</option>
                  <option value="subscription">Subscription</option>
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Price (GBP)
                <input
                  type="number"
                  min={1}
                  value={listingForm.price}
                  onChange={(event) => setListingForm((previous) => ({ ...previous, price: Number(event.target.value || 0) }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Vetting tier
                <select
                  value={listingForm.vettingTier}
                  onChange={(event) => setListingForm((previous) => ({ ...previous, vettingTier: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="community">Community</option>
                  <option value="reviewed">Reviewed</option>
                  <option value="verified">Verified</option>
                </select>
              </label>
            </div>
            <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
              Tags (comma separated)
              <input
                value={listingForm.tags}
                onChange={(event) => setListingForm((previous) => ({ ...previous, tags: event.target.value }))}
                className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
              />
            </label>
            <button
              type="submit"
              className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
            >
              <Plus className="w-3.5 h-3.5" />
              Create Listing
            </button>

            <div className="space-y-2">
              {templateListings.slice(0, 6).map((listing) => {
                const template = templateBlueprints.find((item) => item.id === listing.templateId);
                const grantCount = licenceGrants.filter((grant) => grant.listingId === listing.id).length;
                return (
                  <div
                    key={listing.id}
                    className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5"
                  >
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                      {listing.id} - {template?.name || listing.templateId}
                    </p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                      {listing.priceModel.replace('_', ' ')} | {formatCurrencyGBP(listing.price)} | {listing.vettingTier} | {grantCount} grants
                    </p>
                  </div>
                );
              })}
            </div>
          </form>
        </div>

        <div className="mt-4 grid gap-4 xl:grid-cols-2">
          <form onSubmit={handleLicenceSubmit} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Licence grants</p>
            <div className="grid gap-3 md:grid-cols-2">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Listing
                <select
                  value={licenceForm.listingId}
                  onChange={(event) => setLicenceForm((previous) => ({ ...previous, listingId: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  {templateListings.map((listing) => (
                    <option key={listing.id} value={listing.id}>
                      {listing.id} - {listing.priceModel.replace('_', ' ')}
                    </option>
                  ))}
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Buyer org
                <input
                  required
                  value={licenceForm.buyerOrgId}
                  onChange={(event) => setLicenceForm((previous) => ({ ...previous, buyerOrgId: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Licence type
                <select
                  value={licenceForm.licenceType}
                  onChange={(event) => setLicenceForm((previous) => ({ ...previous, licenceType: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="single_use">Single-use</option>
                  <option value="multi_use">Multi-use</option>
                  <option value="subscription">Subscription</option>
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Seats
                <input
                  type="number"
                  min={1}
                  value={licenceForm.seats}
                  onChange={(event) => setLicenceForm((previous) => ({ ...previous, seats: Number(event.target.value || 1) }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
            </div>
            <div className="grid gap-3 md:grid-cols-2">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Allowed exports
                <input
                  value={licenceForm.allowedExports}
                  onChange={(event) => setLicenceForm((previous) => ({ ...previous, allowedExports: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Watermark rules
                <input
                  value={licenceForm.watermarkRules}
                  onChange={(event) => setLicenceForm((previous) => ({ ...previous, watermarkRules: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
            </div>
            <label className="inline-flex items-center gap-2 text-xs font-semibold text-slate-600 dark:text-slate-300">
              <input
                type="checkbox"
                checked={licenceForm.canFork}
                onChange={(event) => setLicenceForm((previous) => ({ ...previous, canFork: event.target.checked }))}
              />
              Allow buyer to fork template
            </label>
            <button
              type="submit"
              className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
            >
              <Plus className="w-3.5 h-3.5" />
              Grant Licence
            </button>

            <div className="space-y-2">
              {licenceGrants.slice(0, 6).map((grant) => (
                <div key={grant.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5">
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                    {grant.id} - {grant.buyerOrgId}
                  </p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {grant.licenceType.replace('_', ' ')} | Seats {grant.seats} | Ends {formatDateCell(grant.endAt)}
                  </p>
                </div>
              ))}
            </div>
          </form>

          <form onSubmit={handleRunSubmit} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Audit run execution</p>
            <div className="grid gap-3 md:grid-cols-2">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Job
                <select
                  value={runForm.auditJobId}
                  onChange={(event) => setRunForm((previous) => ({ ...previous, auditJobId: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  {jobs.map((job) => (
                    <option key={job.id} value={job.id}>
                      {job.id} - {job.assetName}
                    </option>
                  ))}
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Template
                <select
                  value={runForm.templateId}
                  onChange={(event) => setRunForm((previous) => ({ ...previous, templateId: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  {templateBlueprints.map((template) => (
                    <option key={template.id} value={template.id}>
                      {template.id} - v{template.currentVersion}
                    </option>
                  ))}
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Sync state
                <select
                  value={runForm.offlineSyncState}
                  onChange={(event) => setRunForm((previous) => ({ ...previous, offlineSyncState: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="queued">Queued (offline)</option>
                  <option value="synced">Synced</option>
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                GPS policy
                <select
                  value={runForm.gpsPolicy}
                  onChange={(event) => setRunForm((previous) => ({ ...previous, gpsPolicy: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="optional">Optional</option>
                  <option value="required">Required</option>
                  <option value="disabled">Disabled</option>
                </select>
              </label>
            </div>
            <button
              type="submit"
              className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
            >
              <Plus className="w-3.5 h-3.5" />
              Start Audit Run
            </button>
            <div className="space-y-2">
              {auditRuns.slice(0, 6).map((run) => (
                <div key={run.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5">
                  <div className="flex flex-wrap items-center justify-between gap-2">
                    <div>
                      <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                        {run.id} - {run.auditJobId}
                      </p>
                      <p className="text-[11px] text-slate-500 dark:text-slate-400">
                        {run.status} | Sync {run.offlineSyncState} | Findings {(findingsByRunId.get(run.id) || []).length}
                      </p>
                    </div>
                    {run.status !== 'completed' && (
                      <button
                        type="button"
                        onClick={() => onCompleteAuditRun?.(run.id)}
                        className="px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300 text-[11px] font-bold"
                      >
                        Complete + Artifact
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </form>
        </div>

        <div className="mt-4 grid gap-4 xl:grid-cols-2">
          <form onSubmit={handleFindingSubmit} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Findings engine</p>
            <div className="grid gap-3 md:grid-cols-2">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Audit run
                <select
                  value={findingForm.auditRunId}
                  onChange={(event) => setFindingForm((previous) => ({ ...previous, auditRunId: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  {auditRuns.map((run) => (
                    <option key={run.id} value={run.id}>
                      {run.id} - {run.auditJobId}
                    </option>
                  ))}
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Severity
                <select
                  value={findingForm.severity}
                  onChange={(event) => setFindingForm((previous) => ({ ...previous, severity: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </label>
            </div>
            <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
              Taxonomy code
              <input
                value={findingForm.taxonomyCode}
                onChange={(event) => setFindingForm((previous) => ({ ...previous, taxonomyCode: event.target.value }))}
                className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
              />
            </label>
            <label className="block text-xs font-semibold text-slate-600 dark:text-slate-300">
              Description
              <textarea
                required
                rows={3}
                value={findingForm.description}
                onChange={(event) => setFindingForm((previous) => ({ ...previous, description: event.target.value }))}
                className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
              />
            </label>
            <button
              type="submit"
              className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
            >
              <Plus className="w-3.5 h-3.5" />
              Log Finding
            </button>

            <div className="space-y-2">
              {auditFindings.slice(0, 6).map((finding) => (
                <div key={finding.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5">
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                    {finding.id} - {finding.taxonomyCode}
                  </p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {finding.severity} | Risk {finding.riskScore} | Actions {(actionsByFindingId.get(finding.id) || []).length}
                  </p>
                </div>
              ))}
            </div>
          </form>

          <form onSubmit={handleActionSubmit} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Action tracking</p>
            <div className="grid gap-3 md:grid-cols-2">
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Finding
                <select
                  value={actionForm.findingId}
                  onChange={(event) => setActionForm((previous) => ({ ...previous, findingId: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  {auditFindings.map((finding) => (
                    <option key={finding.id} value={finding.id}>
                      {finding.id} - {finding.severity}
                    </option>
                  ))}
                </select>
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Assignee
                <input
                  value={actionForm.assignee}
                  onChange={(event) => setActionForm((previous) => ({ ...previous, assignee: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Due date
                <input
                  type="date"
                  value={actionForm.dueDate}
                  onChange={(event) => setActionForm((previous) => ({ ...previous, dueDate: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm dark:[color-scheme:dark]"
                />
              </label>
              <label className="text-xs font-semibold text-slate-600 dark:text-slate-300">
                Closure sign-off
                <select
                  value={actionForm.closureSignoff}
                  onChange={(event) => setActionForm((previous) => ({ ...previous, closureSignoff: event.target.value }))}
                  className="mt-1 w-full px-3 py-2 bg-white dark:bg-slate-900/55 border border-slate-200 dark:border-slate-700 rounded-lg text-sm"
                >
                  <option value="auditor">Auditor</option>
                  <option value="operator">Operator</option>
                </select>
              </label>
            </div>
            <label className="inline-flex items-center gap-2 text-xs font-semibold text-slate-600 dark:text-slate-300">
              <input
                type="checkbox"
                checked={actionForm.evidenceRequired}
                onChange={(event) => setActionForm((previous) => ({ ...previous, evidenceRequired: event.target.checked }))}
              />
              Evidence required on closure
            </label>
            <button
              type="submit"
              className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold transition-colors"
            >
              <Plus className="w-3.5 h-3.5" />
              Create Action
            </button>

            <div className="space-y-2">
              {auditActions.slice(0, 6).map((action) => (
                <div key={action.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5">
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                        {action.id} - {action.assignee}
                      </p>
                      <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                        {action.status.replace('_', ' ')} | Due {formatDateCell(action.dueDate)} | {action.evidenceRequired ? 'Evidence required' : 'Evidence optional'}
                      </p>
                    </div>
                    {action.status !== 'closed' && (
                      <button
                        type="button"
                        onClick={() => onAdvanceAuditActionStatus?.(action.id)}
                        className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                      >
                        Advance
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </form>
        </div>

        <div className="mt-4 grid gap-4 xl:grid-cols-2">
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Report artifacts</p>
            {reportArtifacts.length === 0 ? (
              <p className="text-xs text-slate-600 dark:text-slate-300">No report artifacts generated yet.</p>
            ) : (
              reportArtifacts.slice(0, 6).map((artifact) => (
                <div
                  key={artifact.id}
                  className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5"
                >
                  <div className="flex items-start justify-between gap-2">
                    <div>
                      <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                        {artifact.id} - run {artifact.auditRunId}
                      </p>
                      <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                        v{artifact.version} | {artifact.status} | {formatDateCell(artifact.createdAt)}
                      </p>
                      <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1 break-all">PDF: {artifact.signedPdfUrl}</p>
                      <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1 break-all">HTML: {artifact.signedHtmlUrl}</p>
                    </div>
                    <button
                      type="button"
                      onClick={() => onCreateShareLink?.(artifact.id)}
                      className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                    >
                      Create share link
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>

          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Share link access</p>
            {shareLinks.length === 0 ? (
              <p className="text-xs text-slate-600 dark:text-slate-300">No share links created yet.</p>
            ) : (
              shareLinks.slice(0, 8).map((link) => (
                <div key={link.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2.5">
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{link.id}</p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    Artifact {link.reportArtifactId} | Expires {formatDateCell(link.expiresAt)}
                  </p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1 break-all">{link.url}</p>
                </div>
              ))
            )}
          </div>
        </div>
      </section>

      <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
              Supabase Readiness
            </p>
            <h3 className="text-base font-bold text-slate-900 dark:text-white mt-1">
              Items 2-15 Operations Console
            </h3>
            <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
              Run the remaining post-migration operational workflows before full backend wiring is enabled.
            </p>
          </div>
          <div className="flex flex-wrap gap-2">
            <button
              type="button"
              onClick={() => onSeedBidRound?.()}
              className="px-3 py-1.5 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
            >
              Seed Bid Round
            </button>
            <button
              type="button"
              onClick={() => onAwardBestBid?.()}
              className="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold"
            >
              Award Best Bid
            </button>
            <button
              type="button"
              onClick={() => onQueueEvidenceAiJob?.()}
              className="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold"
            >
              Queue Evidence AI
            </button>
            <button
              type="button"
              onClick={() => onStartQaHarnessRun?.()}
              className="px-3 py-1.5 rounded-lg bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold"
            >
              Start QA Run
            </button>
          </div>
        </div>

        <div className="mt-4 grid gap-4 xl:grid-cols-2">
          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <div className="flex items-center justify-between gap-2">
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                Audit company bids + SLA
              </p>
              <span className="text-[11px] font-bold rounded-full px-2.5 py-1 bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300">
                {submittedBidCount} submitted / {awardedBidCount} awarded
              </span>
            </div>
            <p className="text-xs text-slate-600 dark:text-slate-300">
              SLA breaches: <span className="font-semibold">{slaBreachCount}</span> â¢ Bid board rows:{' '}
              <span className="font-semibold">{marketplaceBidBoard.length}</span>
            </p>
            <div className="space-y-2">
              {marketplaceBidBoard.slice(0, 3).map((bid) => (
                <div key={bid.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                    {bid.id} â¢ {bid.requestId} â¢ {bid.providerOrgName}
                  </p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {bid.status} â¢ score {bid.rankScore} â¢ {formatCurrencyGBP(bid.totalExVat)} ex VAT â¢ ETA {bid.leadTimeHours}h
                  </p>
                </div>
              ))}
            </div>
          </article>

          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <div className="flex items-center justify-between gap-2">
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                AI evidence + verification
              </p>
              <div className="flex gap-2">
                <button
                  type="button"
                  onClick={() => onAdvanceEvidenceReview?.()}
                  className="px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300 text-[11px] font-bold"
                >
                  Advance Review
                </button>
                <button
                  type="button"
                  onClick={() => onCreateVerificationRequest?.()}
                  className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                >
                  Raise Request
                </button>
              </div>
            </div>
            <p className="text-xs text-slate-600 dark:text-slate-300">
              AI queued: <span className="font-semibold">{evidenceQueueCount}</span> â¢ Pending review:{' '}
              <span className="font-semibold">{evidencePendingReviewCount}</span> â¢ Open verification:{' '}
              <span className="font-semibold">{openVerificationRequests}</span>
            </p>
            <div className="space-y-2">
              {evidenceAiJobs.slice(0, 2).map((job) => (
                <div key={job.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">{job.id}</p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1 break-all">
                    {job.status} â¢ {job.model} â¢ {job.evidenceRef}
                  </p>
                </div>
              ))}
              {regulatorVerificationRequests.slice(0, 1).map((request) => (
                <div key={request.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
                  <div className="flex items-center justify-between gap-2">
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                      {request.id} â¢ {request.referenceId}
                    </p>
                    {request.status === 'open' && (
                      <button
                        type="button"
                        onClick={() => onResolveVerificationRequest?.()}
                        className="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300 text-[10px] font-bold"
                      >
                        Resolve
                      </button>
                    )}
                  </div>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {request.status} â¢ Due {formatDateCell(request.dueAt)}
                  </p>
                </div>
              ))}
            </div>
          </article>

          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <div className="flex items-center justify-between gap-2">
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                Risk analytics + integrations
              </p>
              <button
                type="button"
                onClick={() => onTriggerWebhookRetry?.()}
                className="px-2.5 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300 text-[11px] font-bold"
              >
                Retry Failed Hook
              </button>
            </div>
            <p className="text-xs text-slate-600 dark:text-slate-300">
              High risk signals: <span className="font-semibold">{highRiskSignals}</span> â¢ Failed webhooks:{' '}
              <span className="font-semibold">{failedWebhookDeliveries}</span>
            </p>
            <div className="space-y-2">
              {analyticsRiskSignals.slice(0, 2).map((signal) => (
                <div key={signal.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                    {signal.id} â¢ {signal.signal}
                  </p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {signal.riskLevel} risk â¢ confidence {Math.round(Number(signal.confidence || 0) * 100)}%
                  </p>
                </div>
              ))}
              {webhookDeliveryEvents.slice(0, 2).map((event) => (
                <div key={event.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                    {event.id} â¢ {event.endpointLabel}
                  </p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {event.status} â¢ attempts {event.attempts} â¢ {event.latencyMs}ms
                  </p>
                </div>
              ))}
            </div>
          </article>

          <article className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-4 space-y-3">
            <div className="flex items-center justify-between gap-2">
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                Mobile, security, and release gates
              </p>
              <div className="flex gap-2">
                <button
                  type="button"
                  onClick={() => onOpenMobileSession?.()}
                  className="px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300 text-[11px] font-bold"
                >
                  Open Mobile Session
                </button>
                <button
                  type="button"
                  onClick={() => onLogSecurityEvent?.()}
                  className="px-2.5 py-1 rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300 text-[11px] font-bold"
                >
                  Log Security Event
                </button>
              </div>
            </div>
            <p className="text-xs text-slate-600 dark:text-slate-300">
              Active sessions: <span className="font-semibold">{activeMobileSessions}</span> â¢ High severity events:{' '}
              <span className="font-semibold">{highSeveritySecurityEvents}</span> â¢ Running QA:{' '}
              <span className="font-semibold">{runningQaRuns}</span> â¢ Pending gates:{' '}
              <span className="font-semibold">{pendingReleaseGates}</span>
            </p>
            <div className="space-y-2">
              {mobileAuditSessions.slice(0, 2).map((session) => (
                <div key={session.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
                  <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                    {session.id} â¢ {session.jobId}
                  </p>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {session.deviceName} â¢ {session.attestationStatus} â¢ sync {session.syncStatus}
                  </p>
                </div>
              ))}
              {qaHarnessRuns.slice(0, 1).map((run) => (
                <div key={run.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
                  <div className="flex items-center justify-between gap-2">
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                      {run.id} â¢ {run.suiteName}
                    </p>
                    {run.status === 'running' && (
                      <button
                        type="button"
                        onClick={() => onFinalizeQaHarnessRun?.()}
                        className="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300 text-[10px] font-bold"
                      >
                        Finalize
                      </button>
                    )}
                  </div>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {run.status} â¢ pass rate {run.passRate}%
                  </p>
                </div>
              ))}
              {releaseGateResults.slice(0, 2).map((gate) => (
                <div key={gate.id} className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/45 px-3 py-2">
                  <div className="flex items-center justify-between gap-2">
                    <p className="text-xs font-semibold text-slate-800 dark:text-slate-100">
                      {gate.id} â¢ {gate.gateName}
                    </p>
                    <button
                      type="button"
                      onClick={() => onAdvanceReleaseGateResult?.()}
                      className="px-2 py-0.5 rounded-full bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200 text-[10px] font-bold"
                    >
                      Advance
                    </button>
                  </div>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                    {gate.status} â¢ {gate.notes}
                  </p>
                </div>
              ))}
            </div>
          </article>
        </div>
      </section>
    </div>
  );
}

function ConnectivityBanner({ isOnline, queuedCount }) {
  const hasQueuedLogs = queuedCount > 0;
  const toneClass = isOnline
    ? 'border-emerald-200 dark:border-emerald-900/40 bg-emerald-50/80 dark:bg-emerald-900/15'
    : 'border-amber-200 dark:border-amber-900/40 bg-amber-50/80 dark:bg-amber-900/15';
  const iconClass = isOnline ? 'text-emerald-600 dark:text-emerald-400' : 'text-amber-600 dark:text-amber-400';

  return (
    <section className={`glass-panel rounded-2xl border px-4 py-3 md:px-5 md:py-4 shadow-sm transition-colors duration-300 ${toneClass}`}>
      <div className="flex items-start gap-3">
        <div className={`mt-0.5 ${iconClass}`}>
          {isOnline ? <Wifi className="w-4 h-4" /> : <WifiOff className="w-4 h-4" />}
        </div>
        <div className="space-y-0.5">
          <p className="text-sm font-bold text-slate-800 dark:text-white">{isOnline ? 'Online sync active' : 'Offline mode enabled'}</p>
          <p className="text-xs text-slate-600 dark:text-slate-300">
            {isOnline
              ? hasQueuedLogs
                ? `${queuedCount} inspection ${queuedCount === 1 ? 'log is' : 'logs are'} queued and will sync now.`
                : 'Asset and inspection data is cached for low-signal environments.'
              : 'You can continue viewing assets and logging inspections. New logs will auto-sync when connected.'}
          </p>
        </div>
      </div>
    </section>
  );
}

function OfflineInspectionPanel({ assets, logs, isOnline, pendingCount, onSubmit }) {
  const [assetId, setAssetId] = useState(assets[0]?.id || '');
  const [performedAt, setPerformedAt] = useState(() => getLocalDateTimeInputValue());
  const [notes, setNotes] = useState('');

  useEffect(() => {
    if (!assets.length) {
      if (assetId) {
        setAssetId('');
      }
      return;
    }

    if (!assetId || !assets.some((asset) => asset.id === assetId)) {
      setAssetId(assets[0].id);
    }
  }, [assets, assetId]);

  const recentLogs = logs.slice(0, 4);

  const formatLogDate = (value) => {
    const parsed = new Date(value);
    if (Number.isNaN(parsed.getTime())) {
      return value;
    }
    return parsed.toLocaleString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  const handleSubmit = (event) => {
    event.preventDefault();
    if (!assetId) {
      return;
    }

    const wasSaved = onSubmit({ assetId, performedAt, notes });
    if (!wasSaved) {
      return;
    }

    setNotes('');
    setPerformedAt(getLocalDateTimeInputValue());
  };

  return (
    <section className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-sm transition-colors duration-300">
      <div className="flex flex-col gap-5 md:gap-6 xl:grid xl:grid-cols-[1.3fr_1fr]">
        <div>
          <div className="flex flex-wrap items-center gap-2 mb-3">
            <h2 className="text-base font-bold text-slate-900 dark:text-white">Inspection Logging (Offline Ready)</h2>
            <span
              className={`text-[11px] font-bold px-2.5 py-1 rounded-full ${
                isOnline
                  ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                  : 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300'
              }`}
            >
              {isOnline ? 'Online' : 'Offline'}
            </span>
          </div>
          <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">
            Inspectors can save evidence notes with no signal. Logs are stored locally and sync automatically on reconnect.
          </p>

          <form onSubmit={handleSubmit} className="space-y-3">
            <div>
              <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                Asset
              </label>
              <select
                required
                value={assetId}
                onChange={(event) => setAssetId(event.target.value)}
                disabled={assets.length === 0}
                className="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 rounded-xl text-sm text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-cyan-500 outline-none"
              >
                {assets.length === 0 ? (
                  <option value="">No assets available</option>
                ) : (
                  assets.map((asset) => (
                    <option key={asset.id} value={asset.id}>
                      {asset.id} - {asset.name}
                    </option>
                  ))
                )}
              </select>
            </div>
            <div>
              <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                Inspection Time
              </label>
              <input
                required
                type="datetime-local"
                value={performedAt}
                onChange={(event) => setPerformedAt(event.target.value)}
                className="w-full px-3 py-2 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 rounded-xl text-sm text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-cyan-500 outline-none dark:[color-scheme:dark]"
              />
            </div>
            <div>
              <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                Notes
              </label>
              <textarea
                value={notes}
                onChange={(event) => setNotes(event.target.value)}
                placeholder="Observed condition, isolation actions, defects, or pass/fail context..."
                className="w-full px-3 py-2 h-24 resize-none bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 rounded-xl text-sm text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-cyan-500 outline-none"
              />
            </div>
            <button
              type="submit"
              className={`inline-flex items-center justify-center px-4 py-2.5 rounded-xl text-sm font-bold transition-colors ${
                isOnline
                  ? 'bg-cyan-600 hover:bg-cyan-700 text-white'
                  : 'bg-amber-600 hover:bg-amber-700 text-white'
              }`}
            >
              {isOnline ? 'Save & Sync Inspection' : 'Queue Inspection Log'}
            </button>
          </form>
        </div>

        <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/70 dark:bg-slate-900/40 p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-bold text-slate-900 dark:text-white">Recent Logs</h3>
            <span className="text-xs font-semibold text-slate-600 dark:text-slate-300">
              Pending sync: {pendingCount}
            </span>
          </div>
          <div className="space-y-2">
            {recentLogs.length === 0 ? (
              <p className="text-xs text-slate-500 dark:text-slate-400">No inspection logs captured yet.</p>
            ) : (
              recentLogs.map((entry) => (
                <div
                  key={entry.id}
                  className="rounded-lg border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/60 px-3 py-2"
                >
                  <div className="flex items-center justify-between gap-2">
                    <p className="text-xs font-bold text-slate-800 dark:text-slate-100 truncate">{entry.assetName}</p>
                    <span
                      className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${
                        entry.syncStatus === 'queued'
                          ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300'
                          : 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                      }`}
                    >
                      {entry.syncStatus === 'queued' ? 'Queued' : 'Synced'}
                    </span>
                  </div>
                  <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">{formatLogDate(entry.performedAt)}</p>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </section>
  );
}

// --- VIEWS ---

function DashboardView({ assets, urgentAssets, upcomingAssets, complianceTrend, programmeCount = 0, onAction }) {
  const totalAssets = assets.length;
  const compliantAssets = assets.filter((asset) => asset.status === 'compliant').length;
  const overdueAssets = assets.filter((asset) => asset.status === 'overdue').length;
  const warningAssets = assets.filter((asset) => asset.status === 'warning').length;

  const compliancePercentage = totalAssets > 0 ? Math.round((compliantAssets / totalAssets) * 100) : 0;
  const trendDelta = complianceTrend.length > 1 ? complianceTrend[complianceTrend.length - 1] - complianceTrend[0] : 0;

  const getRegimeStats = (regime) => {
    const regimeAssets = assets.filter((asset) => asset.regime === regime);
    const compliant = regimeAssets.filter((asset) => asset.status === 'compliant').length;
    return { compliant, total: regimeAssets.length };
  };

  const loler = getRegimeStats('LOLER');
  const puwer = getRegimeStats('PUWER');
  const pssr = getRegimeStats('PSSR');

  return (
    <div className="space-y-6 animate-in fade-in duration-300">
      <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 relative overflow-hidden shadow-sm transition-colors duration-300 hover-lift">
        <div className="absolute inset-x-0 top-0 h-1 shimmer-line" />
        <div className="absolute -right-10 -top-12 opacity-15 dark:opacity-30 pointer-events-none">
          <svg width="220" height="220" viewBox="0 0 100 100" className="motion-safe:animate-[spin_18s_linear_infinite]">
            <circle
              cx="50"
              cy="50"
              r="45"
              fill="none"
              stroke="currentColor"
              className="text-cyan-500"
              strokeWidth="0.4"
              strokeDasharray="4 4"
            />
            <circle
              cx="50"
              cy="50"
              r="31"
              fill="none"
              stroke="currentColor"
              className="text-emerald-400"
              strokeWidth="1"
            />
            <path d="M50 50 L85 15" stroke="currentColor" className="text-cyan-500" strokeWidth="2" strokeLinecap="round" />
          </svg>
        </div>
        <div className="relative z-10">
          <div className="flex flex-wrap items-center gap-2 mb-2">
            <div className="pulse-soft rounded-full">
              <Activity className="w-5 h-5 text-cyan-600 dark:text-cyan-400" />
            </div>
            <span className="text-sm font-bold text-cyan-600 dark:text-cyan-400 tracking-wider uppercase">
              Live Compliance Status
            </span>
            <span className="text-xs px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-semibold">
              {trendDelta >= 0 ? '+' : ''}
              {trendDelta}% vs prior cycle
            </span>
          </div>
          <h2 className="text-2xl md:text-3xl font-black text-slate-800 dark:text-white mb-2 tracking-tight">
            Estate is{' '}
            <span className={compliancePercentage < 100 ? 'text-amber-500' : 'text-emerald-600 dark:text-emerald-400'}>
              {compliancePercentage}% Compliant
            </span>
          </h2>
          <p className="text-slate-600 dark:text-slate-400 text-sm md:text-base max-w-xl leading-relaxed">
            {warningAssets} assets require action within 30 days.{' '}
            {overdueAssets > 0 ? (
              <span className="text-rose-500 font-bold">{overdueAssets} overdue alerts need immediate follow-up.</span>
            ) : (
              'No critical overdue alerts right now.'
            )}
          </p>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stagger-item">
          <GlassStatCard
            title="Total Assets"
            value={totalAssets}
            icon={<Box />}
            color="text-cyan-600 dark:text-cyan-400"
            bgClass="bg-cyan-50 dark:bg-cyan-900/20"
          />
        </div>
        <div className="stagger-item">
          <GlassStatCard
            title="Compliant"
            value={compliantAssets}
            icon={<CheckCircle2 />}
            color="text-emerald-600 dark:text-emerald-400"
            bgClass="bg-emerald-50 dark:bg-emerald-900/20"
          />
        </div>
        <div className="stagger-item">
          <GlassStatCard
            title="Due < 30 Days"
            value={warningAssets}
            icon={<Clock />}
            color={warningAssets > 0 ? 'text-amber-600 dark:text-amber-400' : 'text-slate-400'}
            bgClass={warningAssets > 0 ? 'bg-amber-50 dark:bg-amber-900/20' : 'bg-slate-100 dark:bg-slate-800'}
          />
        </div>
        <div className="stagger-item">
          <GlassStatCard
            title="Overdue"
            value={overdueAssets}
            icon={<AlertTriangle />}
            color={overdueAssets > 0 ? 'text-rose-600 dark:text-rose-400' : 'text-slate-400'}
            bgClass={
              overdueAssets > 0
                ? 'bg-rose-50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-500/30'
                : 'bg-slate-100 dark:bg-slate-800'
            }
          />
        </div>
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 xl:col-span-2 shadow-sm transition-colors duration-300 hover-lift">
          <div className="flex flex-wrap items-center justify-between gap-3 mb-6">
            <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center">
              <BarChart3 className="w-5 h-5 mr-2 text-cyan-500" /> Compliance Momentum
            </h3>
            <span className="text-xs font-semibold text-slate-500 dark:text-slate-400">
              Last 12 reporting periods
            </span>
          </div>
          <div className="mb-6">
            <SparklineChart points={complianceTrend} />
          </div>
          <div className="space-y-5">
            <AnimatedProgressBar name="LOLER (Lifting Eq.)" compliant={loler.compliant} total={loler.total} color="bg-cyan-500" />
            <AnimatedProgressBar name="PUWER (Work Eq.)" compliant={puwer.compliant} total={puwer.total} color="bg-emerald-500" />
            <AnimatedProgressBar name="PSSR (Pressure)" compliant={pssr.compliant} total={pssr.total} color="bg-amber-500" />
          </div>
        </div>

        <div className="space-y-6">
          <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-sm transition-colors duration-300 hover-lift">
            <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-5 flex items-center">
              <ClipboardList className="w-5 h-5 mr-2 text-cyan-500" /> Quick Actions
            </h3>
            <div className="space-y-3">
              <GlassActionButton icon={<Plus />} label="Request Inspection" primary onClick={() => onAction('request')} />
              <GlassActionButton
                icon={<Calendar />}
                label="Create Programme"
                badge={programmeCount > 0 ? String(programmeCount) : undefined}
                onClick={() => onAction('programme')}
              />
              <GlassActionButton icon={<Download />} label="Export Audit Pack" onClick={() => onAction('export')} />
              <GlassActionButton icon={<Users />} label="Review Quotes" badge="2" />
            </div>
          </div>

          <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-sm transition-colors duration-300 hover-lift">
            <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center">
              <AlertTriangle className="w-5 h-5 mr-2 text-amber-500" /> Urgent Queue
            </h3>
            <div className="space-y-3">
              {urgentAssets.length === 0 ? (
                <p className="text-sm text-slate-500 dark:text-slate-400">No urgent assets right now.</p>
              ) : (
                urgentAssets.map((asset) => (
                  <UrgentAssetItem key={asset.id} asset={asset} />
                ))
              )}
            </div>
          </div>
        </div>
      </div>

      <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-sm transition-colors duration-300 hover-lift">
        <div className="flex items-center justify-between mb-4 gap-3">
          <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center">
            <Calendar className="w-5 h-5 mr-2 text-emerald-500" /> Upcoming Site Inspections
          </h3>
          <span className="text-xs font-semibold text-slate-500 dark:text-slate-400">Next 45 days</span>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
          {upcomingAssets.length === 0 ? (
            <p className="text-sm text-slate-500 dark:text-slate-400">No planned items in the next 45 days.</p>
          ) : (
            upcomingAssets.map((asset) => (
              <div
                key={asset.id}
                className="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 p-3 hover-lift"
              >
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <p className="text-sm font-bold text-slate-800 dark:text-white">{asset.name}</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{asset.site}</p>
                  </div>
                  <StatusPill status={asset.status} />
                </div>
                <div className="mt-3 text-xs text-slate-600 dark:text-slate-300 flex items-center justify-between">
                  <span>{formatDateLabel(asset.nextDue)}</span>
                  <span className="font-semibold">{formatRelativeDueLabel(asset.nextDue)}</span>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
}

function AssetRegisterView({ assets, searchQuery, onAdd, onViewAsset }) {
  const [showFilters, setShowFilters] = useState(false);
  const [statusFilter, setStatusFilter] = useState('All');
  const [regimeFilter, setRegimeFilter] = useState('All');
  const [viewMode, setViewMode] = useState('table');
  const [page, setPage] = useState(1);
  const pageSize = 8;

  const filteredAssets = useMemo(() => {
    return assets.filter((asset) => {
      const term = searchQuery.toLowerCase();
      const matchesSearch =
        asset.name.toLowerCase().includes(term) ||
        asset.id.toLowerCase().includes(term) ||
        asset.site.toLowerCase().includes(term);
      const matchesStatus = statusFilter === 'All' || asset.status === statusFilter.toLowerCase();
      const matchesRegime = regimeFilter === 'All' || asset.regime === regimeFilter;
      return matchesSearch && matchesStatus && matchesRegime;
    });
  }, [assets, searchQuery, statusFilter, regimeFilter]);

  useEffect(() => {
    setPage(1);
  }, [searchQuery, statusFilter, regimeFilter]);

  const totalPages = Math.max(1, Math.ceil(filteredAssets.length / pageSize));
  const currentPage = Math.min(page, totalPages);
  const paginatedAssets = filteredAssets.slice((currentPage - 1) * pageSize, currentPage * pageSize);

  const compliantCount = filteredAssets.filter((asset) => asset.status === 'compliant').length;
  const warningCount = filteredAssets.filter((asset) => asset.status === 'warning').length;
  const overdueCount = filteredAssets.filter((asset) => asset.status === 'overdue').length;

  return (
    <div className="space-y-4 md:space-y-6 animate-in fade-in duration-300 pb-10">
      <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
        <div>
          <h2 className="text-xl font-bold text-slate-800 dark:text-white">Asset Register</h2>
          <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
            Manage and track statutory inspection cadences at scale.
          </p>
        </div>
        <div className="flex space-x-3">
          <div className="relative flex-1 md:flex-none">
            <button
              onClick={() => setShowFilters((previous) => !previous)}
              className={`w-full justify-center px-4 py-2.5 bg-white dark:bg-slate-800 border ${
                showFilters || statusFilter !== 'All' || regimeFilter !== 'All'
                  ? 'border-cyan-500 text-cyan-600 dark:text-cyan-400'
                  : 'border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300'
              } hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl text-sm font-bold flex items-center space-x-2 transition-colors shadow-sm`}
            >
              <Filter className="w-4 h-4" />
              <span>Filters</span>
              {(statusFilter !== 'All' || regimeFilter !== 'All') && (
                <span className="w-2 h-2 bg-cyan-500 rounded-full ml-1" />
              )}
              <ChevronDown className={`w-4 h-4 ml-1 transition-transform ${showFilters ? 'rotate-180' : ''}`} />
            </button>
            {showFilters && (
              <div className="absolute top-full mt-2 right-0 w-64 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl z-50 p-4 animate-in fade-in slide-in-from-top-2">
                <div className="mb-4">
                  <label className="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-2">Status</label>
                  <select
                    value={statusFilter}
                    onChange={(event) => setStatusFilter(event.target.value)}
                    className="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm outline-none"
                  >
                    <option>All</option>
                    <option>Compliant</option>
                    <option>Warning</option>
                    <option>Overdue</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-2">Regime</label>
                  <select
                    value={regimeFilter}
                    onChange={(event) => setRegimeFilter(event.target.value)}
                    className="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm outline-none"
                  >
                    <option>All</option>
                    {SUPPORTED_REGIMES.map((regime) => (
                      <option key={`filter-regime-${regime}`}>{regime}</option>
                    ))}
                  </select>
                </div>
                <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                  <button
                    onClick={() => {
                      setStatusFilter('All');
                      setRegimeFilter('All');
                    }}
                    className="text-xs font-bold text-cyan-600 hover:text-cyan-800 w-full text-center"
                  >
                    Reset Filters
                  </button>
                </div>
              </div>
            )}
          </div>
          <button
            onClick={onAdd}
            className="flex-1 md:flex-none justify-center px-4 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded-xl text-sm font-bold flex items-center space-x-2 transition-colors shadow-sm"
          >
            <Plus className="w-4 h-4" />
            <span>Add Asset</span>
          </button>
        </div>
      </div>

      <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div className="flex flex-wrap gap-2">
            <div className="px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-xs font-bold text-slate-700 dark:text-slate-200">
              Total {filteredAssets.length}
            </div>
            <div className="px-3 py-1.5 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 text-xs font-bold text-emerald-700 dark:text-emerald-400">
              Compliant {compliantCount}
            </div>
            <div className="px-3 py-1.5 rounded-lg bg-amber-50 dark:bg-amber-900/20 text-xs font-bold text-amber-700 dark:text-amber-400">
              Warning {warningCount}
            </div>
            <div className="px-3 py-1.5 rounded-lg bg-rose-50 dark:bg-rose-900/20 text-xs font-bold text-rose-700 dark:text-rose-400">
              Overdue {overdueCount}
            </div>
          </div>
          <div className="hidden md:flex rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
            <button
              onClick={() => setViewMode('table')}
              className={`px-3 py-1.5 text-xs font-bold ${viewMode === 'table' ? 'bg-cyan-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300'}`}
            >
              Table
            </button>
            <button
              onClick={() => setViewMode('cards')}
              className={`px-3 py-1.5 text-xs font-bold border-l border-slate-200 dark:border-slate-700 ${viewMode === 'cards' ? 'bg-cyan-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300'}`}
            >
              Cards
            </button>
          </div>
        </div>
      </div>

      {filteredAssets.length === 0 ? (
        <div className="p-12 text-center glass-panel bg-white/50 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700 animate-in fade-in">
          <Box className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" />
          <p className="text-slate-500 dark:text-slate-400 font-medium">No assets found matching current criteria.</p>
        </div>
      ) : (
        <>
          {viewMode === 'table' ? (
            <div className="hidden md:block glass-panel bg-white/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden shadow-sm transition-colors duration-300 stagger-item">
              <table className="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                <thead className="bg-slate-50/50 dark:bg-slate-900/20">
                  <tr>
                    <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Asset ID & Name
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Location
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Regime
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Next Due
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Status
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                  {paginatedAssets.map((asset, index) => (
                    <tr
                      key={asset.id}
                      onClick={() => onViewAsset(asset)}
                      className="stagger-item hover:bg-cyan-50/50 dark:hover:bg-slate-700/50 transition-colors group cursor-pointer"
                      style={{ animationDelay: `${index * 0.05}s` }}
                    >
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center text-cyan-600 dark:text-cyan-400 group-hover:scale-105 transition-transform shadow-sm">
                            <Box className="w-5 h-5" />
                          </div>
                          <div className="flex flex-col">
                            <span className="text-sm font-bold text-slate-800 dark:text-white group-hover:text-cyan-600 dark:group-hover:text-cyan-400 transition-colors">
                              {asset.name}
                            </span>
                            <span className="text-xs text-slate-500 dark:text-slate-400 font-mono mt-0.5">{asset.id}</span>
                          </div>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300">
                        <MapPin className="inline w-3 h-3 mr-1 text-slate-400" />
                        {asset.site}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className="px-2.5 py-1 text-xs font-bold rounded-md bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-800/30">
                          {asset.regime}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-800 dark:text-slate-200">
                        <div>{formatDateLabel(asset.nextDue)}</div>
                        <div className="text-xs text-slate-500 dark:text-slate-400">{formatRelativeDueLabel(asset.nextDue)}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <StatusPill status={asset.status} />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            <div className="hidden md:grid grid-cols-1 lg:grid-cols-2 gap-3">
              {paginatedAssets.map((asset, index) => (
                <div
                  key={asset.id}
                  onClick={() => onViewAsset(asset)}
                  className="stagger-item glass-panel bg-white/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-xl p-4 flex flex-col relative overflow-hidden shadow-sm transition-transform cursor-pointer hover-lift"
                  style={{ animationDelay: `${index * 0.05}s` }}
                >
                  <div className="flex justify-between items-start mb-3">
                    <div className="flex flex-col">
                      <span className="font-bold text-slate-800 dark:text-white text-base">{asset.name}</span>
                      <span className="text-xs text-slate-500 dark:text-slate-400 font-mono mt-0.5">{asset.id}</span>
                    </div>
                    <StatusPill status={asset.status} />
                  </div>
                  <div className="text-sm text-slate-600 dark:text-slate-300 flex justify-between">
                    <span>{asset.site}</span>
                    <span className="font-semibold">{asset.regime}</span>
                  </div>
                  <div className="mt-3 text-xs text-slate-500 dark:text-slate-400 flex justify-between">
                    <span>{formatDateLabel(asset.nextDue)}</span>
                    <span>{formatRelativeDueLabel(asset.nextDue)}</span>
                  </div>
                </div>
              ))}
            </div>
          )}

          <div className="md:hidden space-y-3">
            {paginatedAssets.map((asset, index) => (
              <div
                key={asset.id}
                onClick={() => onViewAsset(asset)}
                className="stagger-item glass-panel bg-white/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-xl p-4 flex flex-col relative overflow-hidden shadow-sm active:scale-[0.98] transition-transform cursor-pointer"
                style={{ animationDelay: `${index * 0.05}s` }}
              >
                <div
                  className={`absolute left-0 top-0 bottom-0 w-1 ${
                    asset.status === 'compliant'
                      ? 'bg-emerald-500'
                      : asset.status === 'warning'
                        ? 'bg-amber-500'
                        : 'bg-rose-500'
                  }`}
                />
                <div className="flex justify-between items-start mb-3 pl-2">
                  <div className="flex flex-col">
                    <span className="font-bold text-slate-800 dark:text-white text-base">{asset.name}</span>
                    <span className="text-xs text-slate-500 dark:text-slate-400 font-mono mt-0.5">{asset.id}</span>
                  </div>
                  <StatusPill status={asset.status} />
                </div>
                <div className="grid grid-cols-2 gap-2 mt-2 pt-3 border-t border-slate-100 dark:border-slate-700 pl-2">
                  <div>
                    <span className="text-[10px] uppercase font-bold tracking-wider text-slate-500">Regime</span>
                    <p className="text-sm font-medium text-emerald-600 dark:text-emerald-400 mt-0.5">{asset.regime}</p>
                  </div>
                  <div>
                    <span className="text-[10px] uppercase font-bold tracking-wider text-slate-500">Next Due</span>
                    <p className="text-sm font-medium text-slate-800 dark:text-white mt-0.5">
                      {formatDateLabel(asset.nextDue)}
                    </p>
                    <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-0.5">
                      {formatRelativeDueLabel(asset.nextDue)}
                    </p>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <PaginationControls
            currentPage={currentPage}
            totalPages={totalPages}
            onPrevious={() => setPage((previous) => Math.max(1, previous - 1))}
            onNext={() => setPage((previous) => Math.min(totalPages, previous + 1))}
          />
        </>
      )}
    </div>
  );
}

function EvidenceVaultView({
  certificates,
  searchQuery,
  onLinkGen,
  onUploadComplete,
  focusCertificateId,
  onFocusHandled,
}) {
  const [selectedCert, setSelectedCert] = useState(null);
  const [isVerifying, setIsVerifying] = useState(false);
  const [isVerified, setIsVerified] = useState(false);
  const [statusFilter, setStatusFilter] = useState('all');
  const [page, setPage] = useState(1);
  const pageSize = 6;

  const handleViewCert = (certificate) => {
    setSelectedCert(certificate);
    setIsVerifying(false);
    setIsVerified(false);
  };

  const handleCloseModal = () => setSelectedCert(null);

  const runVerification = () => {
    setIsVerifying(true);
    setTimeout(() => {
      setIsVerifying(false);
      setIsVerified(true);
    }, 1800);
  };

  const filteredCerts = useMemo(() => {
    return certificates.filter((certificate) => {
      const term = searchQuery.toLowerCase();
      const matchesSearch =
        certificate.assetName.toLowerCase().includes(term) ||
        certificate.id.toLowerCase().includes(term) ||
        certificate.provider.toLowerCase().includes(term);
      const matchesStatus = statusFilter === 'all' || certificate.status === statusFilter;
      return matchesSearch && matchesStatus;
    });
  }, [certificates, searchQuery, statusFilter]);

  useEffect(() => {
    setPage(1);
  }, [searchQuery, statusFilter]);

  useEffect(() => {
    if (!focusCertificateId) {
      return;
    }

    const targetCertificate = certificates.find(
      (certificate) => certificate.id.toUpperCase() === String(focusCertificateId).toUpperCase()
    );
    if (targetCertificate) {
      setSelectedCert(targetCertificate);
      setIsVerifying(false);
      setIsVerified(false);
    }
    onFocusHandled?.();
  }, [focusCertificateId, certificates, onFocusHandled]);

  const validCount = filteredCerts.filter((certificate) => certificate.status === 'valid').length;
  const expiredCount = filteredCerts.filter((certificate) => certificate.status !== 'valid').length;
  const totalPages = Math.max(1, Math.ceil(filteredCerts.length / pageSize));
  const currentPage = Math.min(page, totalPages);
  const paginatedCerts = filteredCerts.slice((currentPage - 1) * pageSize, currentPage * pageSize);

  return (
    <div className="space-y-4 md:space-y-6 relative animate-in fade-in duration-300 pb-10">
      <div className="glass-panel bg-white/85 dark:bg-slate-800/85 rounded-2xl p-4 md:p-6 flex flex-col gap-4 border border-slate-200 dark:border-slate-700 shadow-sm transition-colors duration-300">
        <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
          <div className="flex items-center space-x-4">
            <div className="p-3 bg-cyan-50 dark:bg-cyan-900/20 text-cyan-600 dark:text-cyan-400 rounded-xl border border-cyan-100 dark:border-cyan-800/30 shadow-sm">
              <Lock className="w-6 h-6" />
            </div>
            <div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white">Secure Evidence Vault</h2>
              <p className="text-xs md:text-sm text-slate-500 dark:text-slate-400 mt-1">
                Tamper-evident, cryptographically verified statutory reports.
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={onLinkGen}
              className="w-full md:w-auto px-5 py-2.5 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-xl text-sm font-bold flex items-center justify-center space-x-2 transition-all border border-slate-200 dark:border-slate-700 shadow-sm"
            >
              <Share2 className="w-4 h-4" />
              <span>Generate Audit Link</span>
            </button>
          </div>
        </div>

        <UploadDropZone
          onFilesSelected={(files) => {
            files.forEach((file) => onUploadComplete(file.name));
          }}
        />

        <div className="flex flex-wrap items-center justify-between gap-3">
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setStatusFilter('all')}
              className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${
                statusFilter === 'all'
                  ? 'bg-cyan-600 text-white border-cyan-600'
                  : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700'
              }`}
            >
              All {filteredCerts.length}
            </button>
            <button
              onClick={() => setStatusFilter('valid')}
              className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${
                statusFilter === 'valid'
                  ? 'bg-emerald-600 text-white border-emerald-600'
                  : 'bg-white dark:bg-slate-800 text-emerald-700 dark:text-emerald-400 border-emerald-200 dark:border-emerald-800/50'
              }`}
            >
              Valid {validCount}
            </button>
            <button
              onClick={() => setStatusFilter('expired')}
              className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${
                statusFilter === 'expired'
                  ? 'bg-rose-600 text-white border-rose-600'
                  : 'bg-white dark:bg-slate-800 text-rose-700 dark:text-rose-400 border-rose-200 dark:border-rose-800/50'
              }`}
            >
              Expired {expiredCount}
            </button>
          </div>
          <span className="text-xs text-slate-500 dark:text-slate-400">
            Showing page {currentPage} of {totalPages}
          </span>
        </div>
      </div>

      {paginatedCerts.length === 0 ? (
        <div className="p-12 text-center glass-panel bg-white/50 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700 animate-in fade-in">
          <FileSignature className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" />
          <p className="text-slate-500 dark:text-slate-400 font-medium">No certificates found matching "{searchQuery}"</p>
        </div>
      ) : (
        <>
          <div className="hidden md:block glass-panel bg-white/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden shadow-sm transition-colors duration-300 stagger-item">
            <table className="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
              <thead className="bg-slate-50/50 dark:bg-slate-900/20">
                <tr>
                  <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                    Record
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                    Asset Focus
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                    Issuer
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                    Expiry
                  </th>
                  <th className="px-6 py-4 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                    Status
                  </th>
                  <th className="px-6 py-4 text-right text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                    Action
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                {paginatedCerts.map((certificate, index) => (
                  <tr
                    key={certificate.id}
                    className="stagger-item hover:bg-slate-50/50 dark:hover:bg-slate-700/30 transition-colors"
                    style={{ animationDelay: `${index * 0.05}s` }}
                  >
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center space-x-3">
                        <FileSignature
                          className={`w-5 h-5 ${
                            certificate.status === 'valid' ? 'text-cyan-500 dark:text-cyan-400' : 'text-slate-400'
                          }`}
                        />
                        <span className="text-sm font-bold text-slate-800 dark:text-slate-200 font-mono">
                          {certificate.id}
                        </span>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex flex-col">
                        <span className="text-sm text-slate-800 dark:text-white font-medium">{certificate.assetName}</span>
                        <span className="text-xs text-slate-500 dark:text-slate-400">{certificate.regime}</span>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex flex-col">
                        <span className="text-sm text-slate-700 dark:text-slate-300">{certificate.provider}</span>
                        <span className="text-[10px] text-emerald-600 dark:text-emerald-400 flex items-center mt-1 font-bold tracking-wide">
                          <CheckCircle2 className="w-3 h-3 mr-1" /> VAULT SECURED
                        </span>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-700 dark:text-slate-300">
                      {formatDateLabel(certificate.expiryDate)}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <StatusPill
                        status={certificate.status === 'valid' ? 'compliant' : 'overdue'}
                        text={certificate.status}
                      />
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right">
                      <button
                        onClick={() => handleViewCert(certificate)}
                        className="px-4 py-1.5 bg-cyan-50 hover:bg-cyan-100 text-cyan-700 dark:bg-cyan-900/20 dark:hover:bg-cyan-900/40 dark:text-cyan-400 border border-cyan-200 dark:border-cyan-800/30 rounded-lg text-sm font-bold transition-all shadow-sm"
                      >
                        Inspect Record
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="md:hidden space-y-3">
            {paginatedCerts.map((certificate, index) => (
              <div
                key={certificate.id}
                className="stagger-item glass-panel bg-white/80 dark:bg-slate-800/80 rounded-xl p-4 flex flex-col relative border border-slate-200 dark:border-slate-700 shadow-sm"
                style={{ animationDelay: `${index * 0.05}s` }}
              >
                <div className="flex justify-between items-start mb-3">
                  <div className="flex items-center space-x-2">
                    <FileSignature
                      className={`w-4 h-4 ${
                        certificate.status === 'valid' ? 'text-cyan-500 dark:text-cyan-400' : 'text-slate-400'
                      }`}
                    />
                    <span className="text-sm font-bold text-slate-800 dark:text-slate-200 font-mono">{certificate.id}</span>
                  </div>
                  <StatusPill
                    status={certificate.status === 'valid' ? 'compliant' : 'overdue'}
                    text={certificate.status}
                  />
                </div>
                <p className="text-base font-medium text-slate-800 dark:text-white mb-1">{certificate.assetName}</p>
                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2">{certificate.provider}</p>
                <div className="flex items-center justify-between mt-2 pt-3 border-t border-slate-100 dark:border-slate-700">
                  <span className="text-xs text-slate-500 dark:text-slate-400">
                    Expires {formatDateLabel(certificate.expiryDate)}
                  </span>
                  <button
                    onClick={() => handleViewCert(certificate)}
                    className="px-4 py-1.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-xs font-bold transition-colors shadow-sm"
                  >
                    Inspect
                  </button>
                </div>
              </div>
            ))}
          </div>

          <PaginationControls
            currentPage={currentPage}
            totalPages={totalPages}
            onPrevious={() => setPage((previous) => Math.max(1, previous - 1))}
            onNext={() => setPage((previous) => Math.min(totalPages, previous + 1))}
          />
        </>
      )}

      {selectedCert && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 dark:bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh] transform transition-all scale-100">
            <div className="flex justify-between items-center p-5 md:p-6 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
              <div>
                <h3 className="text-lg md:text-xl font-bold text-slate-800 dark:text-white flex items-center">
                  <ShieldCheck className="w-5 h-5 text-cyan-500 dark:text-cyan-400 mr-2" /> Evidence Detail
                </h3>
                <p className="text-xs text-slate-500 dark:text-slate-400 font-mono mt-1">{selectedCert.id}</p>
              </div>
              <button
                onClick={handleCloseModal}
                className="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-600 shadow-sm"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            <div className="p-5 md:p-6 overflow-y-auto flex-1 space-y-6">
              <div
                className={`flex flex-col md:flex-row md:items-center justify-between p-4 rounded-xl border transition-all duration-500 overflow-hidden relative ${
                  isVerified
                    ? 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-800/30'
                    : 'bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700/50'
                }`}
              >
                {isVerifying && (
                  <div
                    className="absolute top-0 left-0 h-1 bg-cyan-500 animate-[drawPath_2s_linear_forwards] w-full"
                    style={{ strokeDasharray: '0', animation: 'progress 2s linear forwards' }}
                  />
                )}
                <style>{`@keyframes progress { from { width: 0%; } to { width: 100%; } }`}</style>

                <div className="flex items-start md:items-center space-x-3 relative z-10">
                  {isVerifying ? (
                    <Loader2 className="w-6 h-6 shrink-0 text-cyan-500 animate-spin mt-1 md:mt-0" />
                  ) : isVerified ? (
                    <CheckCircle2 className="w-6 h-6 shrink-0 text-emerald-500 mt-1 md:mt-0" />
                  ) : (
                    <Lock className="w-6 h-6 shrink-0 text-slate-400 dark:text-slate-500 mt-1 md:mt-0" />
                  )}
                  <div>
                    <p
                      className={`font-bold text-sm tracking-wide ${
                        isVerified ? 'text-emerald-700 dark:text-emerald-400' : 'text-slate-700 dark:text-slate-300'
                      }`}
                    >
                      {isVerifying
                        ? 'Verifying cryptographic signature...'
                        : isVerified
                          ? 'Cryptographically Verified & Authentic'
                          : 'Verification Required'}
                    </p>
                    <p className="text-[10px] md:text-xs mt-1 font-mono break-all leading-tight text-slate-500 dark:text-slate-400">
                      SHA: {selectedCert.hash}
                    </p>
                  </div>
                </div>
                {!isVerified && !isVerifying && (
                  <button
                    onClick={runVerification}
                    className="mt-3 md:mt-0 px-4 py-1.5 text-xs font-bold bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 shadow-sm transition-colors relative z-10"
                  >
                    Run Verification
                  </button>
                )}
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700/50">
                  <p className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-2">Asset Details</p>
                  <p className="font-bold text-slate-800 dark:text-white text-lg">{selectedCert.assetName}</p>
                  <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">
                    ID: <span className="text-slate-800 dark:text-slate-300">{selectedCert.assetId}</span>
                  </p>
                  <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">
                    Regime: <span className="text-emerald-600 dark:text-emerald-400 font-medium">{selectedCert.regime}</span>
                  </p>
                </div>
                <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700/50">
                  <p className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-2">Inspection Validity</p>
                  <p className="font-bold text-slate-800 dark:text-white text-base">{selectedCert.provider}</p>
                  <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">Issued: {formatDateLabel(selectedCert.issueDate)}</p>
                  <p className="text-sm font-bold text-rose-600 dark:text-rose-400 mt-1 flex items-center">
                    <Clock className="w-3 h-3 mr-1" /> Expires: {formatDateLabel(selectedCert.expiryDate)}
                  </p>
                </div>
              </div>

              <div className="border-t border-slate-200 dark:border-slate-700 pt-6">
                <p className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-3">Document Artefact</p>
                <div className="space-y-4">
                  <CertificateDocumentCard certificate={selectedCert} isVerified={isVerified} />
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <button
                      onClick={() => downloadCertificatePdf(selectedCert)}
                      className="px-4 py-2.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-xs font-bold rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors shadow-sm flex items-center justify-center gap-1.5"
                    >
                      <Download className="w-3.5 h-3.5" />
                      Download PDF
                    </button>
                    <button
                      onClick={async () => {
                        const didCopy = await navigator.clipboard
                          .writeText(buildCertificateDeepLink(selectedCert.id))
                          .then(() => true)
                          .catch(() => false);
                        if (!didCopy) {
                          window.prompt('Copy certificate link', buildCertificateDeepLink(selectedCert.id));
                        }
                      }}
                      className="px-4 py-2.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-xs font-bold rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors shadow-sm flex items-center justify-center gap-1.5"
                    >
                      <Copy className="w-3.5 h-3.5" />
                      Copy Link
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div className="p-5 md:p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex flex-col md:flex-row justify-end space-y-3 md:space-y-0 md:space-x-3">
              <button
                onClick={handleCloseModal}
                className="w-full md:w-auto px-5 py-2.5 font-bold text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl transition-colors shadow-sm"
              >
                Close
              </button>
              <button
                onClick={() => downloadCertificatePdf(selectedCert)}
                className="w-full md:w-auto px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-bold rounded-xl flex items-center justify-center space-x-2 transition-colors shadow-sm"
              >
                <Download className="w-4 h-4" />
                <span>Export Official Record</span>
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function ProviderNetworkView({ providers, searchQuery, onDispatch }) {
  const [selectedProviderId, setSelectedProviderId] = useState(providers[0]?.id || null);

  const filteredProviders = useMemo(() => {
    return providers.filter((provider) => provider.name.toLowerCase().includes(searchQuery.toLowerCase()));
  }, [providers, searchQuery]);

  const selectedProvider =
    filteredProviders.find((provider) => provider.id === selectedProviderId) || filteredProviders[0] || null;

  return (
    <div className="space-y-6 animate-in fade-in duration-300 pb-10">
      <div>
        <h2 className="text-xl font-bold text-slate-800 dark:text-white">Verified Network</h2>
        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
          Pre-vetted, accredited inspection bodies ready for dispatch.
        </p>
      </div>

      <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-6 shadow-sm hover-lift">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4">
          <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center">
            <MapIcon className="w-5 h-5 mr-2 text-cyan-500" /> Provider Coverage View
          </h3>
          {selectedProvider && (
            <span className="text-xs px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-semibold">
              Selected: {selectedProvider.name}
            </span>
          )}
        </div>
        <CoverageMap providers={filteredProviders} selectedProviderId={selectedProvider?.id || null} onSelect={setSelectedProviderId} />
      </div>

      {filteredProviders.length === 0 ? (
         <div className="p-12 text-center glass-panel bg-white/50 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700 animate-in fade-in">
           <Building2 className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" />
          <p className="text-slate-500 dark:text-slate-400 font-medium">No providers found matching "{searchQuery}"</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredProviders.map((provider, index) => (
            <div
              key={provider.id}
              className="stagger-item glass-panel bg-white/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-sm flex flex-col justify-between"
              style={{ animationDelay: `${index * 0.1}s` }}
            >
              <div>
                <div className="flex justify-between items-start mb-5">
                  <div className="w-12 h-12 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl flex items-center justify-center text-slate-800 dark:text-white font-bold text-lg shadow-sm">
                    {provider.name.charAt(0)}
                  </div>
                  <span className="px-2.5 py-1 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-800/30 text-[10px] uppercase tracking-widest font-bold rounded-md flex items-center">
                    <ShieldCheck className="w-3 h-3 mr-1" /> {provider.tier}
                  </span>
                </div>

                <h3 className="font-bold text-lg text-slate-800 dark:text-white mb-2">{provider.name}</h3>

                <div className="flex flex-wrap gap-2 mb-6">
                  {provider.regimes.map((regime) => (
                    <span
                      key={regime}
                      className="text-[10px] font-bold bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 px-2.5 py-1 rounded-md flex items-center"
                    >
                      <Tag className="w-3 h-3 mr-1 opacity-50" /> {regime}
                    </span>
                  ))}
                </div>
              </div>

              <div className="pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center mt-auto">
                <span className="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold tracking-wider">
                  Active: <span className="text-cyan-600 dark:text-cyan-400">{provider.activeJobs} Jobs</span>
                </span>
                <div className="flex gap-2">
                  <button
                    onClick={() => setSelectedProviderId(provider.id)}
                    className="text-sm font-bold text-slate-700 dark:text-white bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 px-3 py-1.5 rounded-lg transition-colors flex items-center shadow-sm"
                  >
                    Focus
                  </button>
                  <button
                    onClick={() => onDispatch(provider.name)}
                    className="text-sm font-bold text-slate-700 dark:text-white bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 px-3 py-1.5 rounded-lg transition-colors flex items-center shadow-sm"
                  >
                    Dispatch <ChevronRight className="w-4 h-4 ml-1 text-slate-400" />
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function MarketplaceExchangeView({
  assets,
  auditors,
  jobs,
  auditRuns = [],
  reportArtifacts = [],
  inspectionTemplates = [],
  companyContext = { id: '', name: '' },
  debugRole = 'company',
  searchQuery,
  onCreateJob,
  onDispatchJob,
  onAcceptOffer,
  onStartJob,
  onUploadDocuments,
  onCompleteJob,
  onSubmitExternalForReview,
  onReviewExternalAudit,
  onApplyAdjustment,
  onStartAuditRunForJob,
  onRecordFinding,
  onReassignJob,
  onDownloadReportArtifact,
  onSaveReportArtifactToVault,
}) {
  const resolveMarketplaceMode = useCallback(
    (role) => {
      const normalizedRole = normalizeUserRole(role, 'company');
      if (normalizedRole === 'third_party') {
        return 'auditor';
      }
      if (['company', 'auditor', 'insurer', 'incert'].includes(normalizedRole)) {
        return normalizedRole;
      }
      return 'company';
    },
    []
  );
  const [activeMode, setActiveMode] = useState(() => resolveMarketplaceMode(debugRole));
  const [selectedAuditorId, setSelectedAuditorId] = useState(auditors[0]?.id || '');
  const [showComposer, setShowComposer] = useState(false);
  const [adjustmentJobId, setAdjustmentJobId] = useState('');
  const [showAdjustmentModal, setShowAdjustmentModal] = useState(false);
  const [statusFilter, setStatusFilter] = useState('all');
  const [page, setPage] = useState(1);
  const [nowTick, setNowTick] = useState(() => Date.now());
  const [reassignmentTargets, setReassignmentTargets] = useState({});
  const [workspaceJobId, setWorkspaceJobId] = useState('');
  const [startAuditJobId, setStartAuditJobId] = useState('');
  const [startAuditMode, setStartAuditMode] = useState(AUDIT_EXECUTION_MODES.INCERT_TEMPLATE);
  const [acceptJobId, setAcceptJobId] = useState('');
  const [acceptAuditMode, setAcceptAuditMode] = useState(AUDIT_EXECUTION_MODES.INCERT_TEMPLATE);
  const [completedReportArtifactId, setCompletedReportArtifactId] = useState('');
  const [showCompletedReportModal, setShowCompletedReportModal] = useState(false);
  const pageSize = 6;

  useEffect(() => {
    const timerId = window.setInterval(() => setNowTick(Date.now()), 60_000);
    return () => window.clearInterval(timerId);
  }, []);

  useEffect(() => {
    setActiveMode(resolveMarketplaceMode(debugRole));
  }, [debugRole, resolveMarketplaceMode]);

  const isCompanyPortal = activeMode === 'company';
  const isAuditorPortal = activeMode === 'auditor';
  const isInCertPortal = activeMode === 'incert';
  const isInsurerPortal = activeMode === 'insurer';
  const normalizedDebugRole = normalizeUserRole(debugRole, 'company');
  const isAuditCompanyRole = normalizedDebugRole === 'third_party';
  const isRoleLockedMarketplaceMode = normalizedDebugRole !== 'incert';

  const selectedAuditor = auditors.find((auditor) => auditor.id === selectedAuditorId) || auditors[0] || null;
  const workspaceJob = jobs.find((job) => job.id === workspaceJobId) || null;
  const startAuditJob = jobs.find((job) => job.id === startAuditJobId) || null;
  const acceptJob = jobs.find((job) => job.id === acceptJobId) || null;
  const acceptJobPayoutOptions = useMemo(
    () => (acceptJob ? getAuditorPayoutOptions(getMarketplaceJobPricing(acceptJob)) : null),
    [acceptJob]
  );
  const workspaceTemplate = useMemo(() => {
    if (!workspaceJob) {
      return null;
    }
    return pickBestInspectionTemplateForRegime(inspectionTemplates, workspaceJob.regime, {
      templateId: workspaceJob.inspectionTemplateId,
      companyId: workspaceJob.companyId || companyContext?.id,
      companyName: workspaceJob.companyName || companyContext?.name,
    });
  }, [workspaceJob, inspectionTemplates, companyContext?.id, companyContext?.name]);
  const latestArtifactByRunId = useMemo(() => {
    const artifactMap = new Map();
    reportArtifacts.forEach((artifact) => {
      if (!artifact?.auditRunId) {
        return;
      }
      const existingArtifact = artifactMap.get(artifact.auditRunId);
      const artifactVersion = Number(artifact.version || 0);
      const existingVersion = Number(existingArtifact?.version || 0);
      const shouldReplace =
        !existingArtifact ||
        artifactVersion > existingVersion ||
        (artifactVersion === existingVersion &&
          String(artifact.createdAt || '') > String(existingArtifact.createdAt || ''));
      if (shouldReplace) {
        artifactMap.set(artifact.auditRunId, artifact);
      }
    });
    return artifactMap;
  }, [reportArtifacts]);
  const latestRunByJobId = useMemo(() => {
    const runMap = new Map();
    auditRuns.forEach((run) => {
      if (!run?.auditJobId) {
        return;
      }
      const existingRun = runMap.get(run.auditJobId);
      const runCompletedAt = String(run.completedAt || run.startedAt || '');
      const existingCompletedAt = String(existingRun?.completedAt || existingRun?.startedAt || '');
      if (!existingRun || runCompletedAt > existingCompletedAt) {
        runMap.set(run.auditJobId, run);
      }
    });
    return runMap;
  }, [auditRuns]);
  const selectedCompletedArtifact =
    reportArtifacts.find((artifact) => artifact.id === completedReportArtifactId) || null;
  const selectedCompletedRun = selectedCompletedArtifact
    ? auditRuns.find((run) => run.id === selectedCompletedArtifact.auditRunId) || null
    : null;
  const selectedCompletedJob = selectedCompletedRun
    ? jobs.find((job) => job.id === selectedCompletedRun.auditJobId) || null
    : null;

  const filteredJobs = useMemo(() => {
    const term = searchQuery.toLowerCase();
    return jobs.filter((job) => {
      const matchesSearch =
        job.assetName.toLowerCase().includes(term) ||
        job.site.toLowerCase().includes(term) ||
        job.regime.toLowerCase().includes(term) ||
        job.id.toLowerCase().includes(term);
      const matchesStatus = isInsurerPortal ? true : statusFilter === 'all' || job.status === statusFilter;
      return matchesSearch && matchesStatus;
    });
  }, [jobs, searchQuery, statusFilter, isInsurerPortal]);

  useEffect(() => {
    setPage(1);
  }, [searchQuery, statusFilter, activeMode]);

  useEffect(() => {
    if (!isAuditorPortal) {
      setWorkspaceJobId('');
      setStartAuditJobId('');
      setAcceptJobId('');
    }
  }, [isAuditorPortal]);

  useEffect(() => {
    if (!workspaceJobId) {
      return;
    }
    if (!workspaceJob || workspaceJob.status === 'completed') {
      setWorkspaceJobId('');
    }
  }, [workspaceJobId, workspaceJob]);

  useEffect(() => {
    if (!startAuditJobId) {
      return;
    }
    const canSelectMethodForLegacyInProgress =
      startAuditJob?.status === 'in_progress' && !startAuditJob?.auditMethodLocked;
    if (!startAuditJob || (startAuditJob.status !== 'assigned' && !canSelectMethodForLegacyInProgress)) {
      setStartAuditJobId('');
    }
  }, [startAuditJobId, startAuditJob]);

  useEffect(() => {
    if (!acceptJobId) {
      return;
    }
    if (!acceptJob || !['open', 'offered'].includes(acceptJob.status)) {
      setAcceptJobId('');
    }
  }, [acceptJobId, acceptJob]);

  const visibleJobs = useMemo(() => {
    if (isAuditorPortal) {
      return filteredJobs.filter((job) => job.status === 'open' || job.matchedAuditorId === selectedAuditorId);
    }
    if (isInsurerPortal) {
      return filteredJobs.filter((job) => job.status === 'completed');
    }
    if (isCompanyPortal || isInCertPortal) {
      return filteredJobs;
    }
    return filteredJobs;
  }, [filteredJobs, isAuditorPortal, isInsurerPortal, isCompanyPortal, isInCertPortal, selectedAuditorId]);

  const totalPages = Math.max(1, Math.ceil(visibleJobs.length / pageSize));
  const currentPage = Math.min(page, totalPages);
  const paginatedJobs = visibleJobs.slice((currentPage - 1) * pageSize, currentPage * pageSize);

  const openCount = jobs.filter((job) => job.status === 'open').length;
  const offeredCount = jobs.filter((job) => job.status === 'offered').length;
  const assignedCount = jobs.filter((job) => job.status === 'assigned').length;
  const inProgressCount = jobs.filter((job) => ['in_progress', 'awaiting_review'].includes(job.status)).length;
  const awaitingReviewCount = jobs.filter((job) => job.status === 'awaiting_review').length;
  const completedCount = jobs.filter((job) => job.status === 'completed').length;
  const selectedAdjustmentJob = jobs.find((job) => job.id === adjustmentJobId) || null;
  const workspacePageRef = useRef(null);
  const incertFinanceTotals = useMemo(
    () =>
      visibleJobs.reduce(
        (totals, job) => {
          const pricing = getMarketplaceJobPricing(job);
          return {
            companyTotalIncVat: totals.companyTotalIncVat + pricing.total,
            auditorPayoutExVat: totals.auditorPayoutExVat + pricing.providerPayoutExVat,
            incertGrossExVat: totals.incertGrossExVat + pricing.platformFeeExVat,
          };
        },
        {
          companyTotalIncVat: 0,
          auditorPayoutExVat: 0,
          incertGrossExVat: 0,
        }
      ),
    [visibleJobs]
  );

  const scrollWorkspacePageToTop = useCallback(() => {
    if (!workspacePageRef.current || typeof window === 'undefined') {
      return;
    }

    const workspaceNode = workspacePageRef.current;
    workspaceNode.scrollTop = 0;

    let ancestor = workspaceNode.parentElement;
    while (ancestor) {
      const style = window.getComputedStyle(ancestor);
      const overflowY = style.overflowY;
      if ((overflowY === 'auto' || overflowY === 'scroll') && ancestor.scrollHeight > ancestor.clientHeight) {
        ancestor.scrollTop = 0;
        break;
      }
      ancestor = ancestor.parentElement;
    }
    window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
  }, []);

  useEffect(() => {
    if (!workspaceJobId) {
      return undefined;
    }

    scrollWorkspacePageToTop();
    if (typeof window === 'undefined') {
      return undefined;
    }

    const frameId = window.requestAnimationFrame(scrollWorkspacePageToTop);
    const timeoutId = window.setTimeout(scrollWorkspacePageToTop, 40);
    return () => {
      window.cancelAnimationFrame(frameId);
      window.clearTimeout(timeoutId);
    };
  }, [workspaceJobId, scrollWorkspacePageToTop]);

  const openAuditMethodPicker = (job) => {
    setStartAuditJobId(job.id);
    setStartAuditMode(normalizeAuditExecutionMode(job.auditExecutionMode));
  };

  const resolveReassignmentTarget = (jobId, fallbackAuditorId) => {
    const mappedTarget = reassignmentTargets[jobId];
    if (mappedTarget) {
      return mappedTarget;
    }
    const nextAuditor = auditors.find((auditor) => auditor.id !== fallbackAuditorId);
    return nextAuditor?.id || fallbackAuditorId || '';
  };

  const getLatestArtifactForJob = useCallback(
    (jobId) => {
      const linkedRun = latestRunByJobId.get(jobId);
      if (!linkedRun) {
        return null;
      }
      return latestArtifactByRunId.get(linkedRun.id) || null;
    },
    [latestRunByJobId, latestArtifactByRunId]
  );

  const openCompletedArtifactModal = useCallback(
    (artifactId) => {
      if (!artifactId) {
        return;
      }
      setCompletedReportArtifactId(artifactId);
      setShowCompletedReportModal(true);
    },
    []
  );

  const closeCompletedArtifactModal = useCallback(() => {
    setShowCompletedReportModal(false);
    setCompletedReportArtifactId('');
  }, []);

  const openAcceptMethodPicker = (job) => {
    setAcceptJobId(job.id);
    setAcceptAuditMode(
      Boolean(job.auditMethodLocked)
        ? normalizeAuditExecutionMode(job.auditExecutionMode)
        : AUDIT_EXECUTION_MODES.INCERT_TEMPLATE
    );
  };

  const confirmAcceptJob = () => {
    if (!acceptJob || !selectedAuditor) {
      return;
    }
    const didAccept = onAcceptOffer?.(
      acceptJob.id,
      selectedAuditor.id,
      selectedAuditor.name,
      normalizeAuditExecutionMode(acceptAuditMode)
    );
    if (didAccept === false) {
      return;
    }
    setAcceptJobId('');
  };

  const confirmAuditStart = () => {
    if (!startAuditJob || !selectedAuditor) {
      return;
    }

    const selectedMode = normalizeAuditExecutionMode(startAuditMode);
    const didStart = onStartJob(startAuditJob.id, selectedAuditor.id, selectedMode);
    if (didStart === false) {
      return;
    }

    setStartAuditJobId('');
    if (selectedMode === AUDIT_EXECUTION_MODES.INCERT_TEMPLATE) {
      onStartAuditRunForJob?.(startAuditJob.id);
      setWorkspaceJobId(startAuditJob.id);
    }
  };

  if (isAuditorPortal && workspaceJob && selectedAuditor) {
    return (
      <div ref={workspacePageRef} className="space-y-4 animate-in fade-in duration-300 pb-10">
        <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
              <p className="text-xs font-bold tracking-wider uppercase text-cyan-600 dark:text-cyan-400 mb-1">
                {isAuditCompanyRole ? 'Audit Company Workspace' : 'Auditor Workspace'}
              </p>
              <p className="text-sm text-slate-600 dark:text-slate-300">
                {workspaceJob.id} â¢ {workspaceJob.assetName} â¢ {workspaceJob.regime}
              </p>
            </div>
            <button
              type="button"
              onClick={() => setWorkspaceJobId('')}
              className="px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 text-xs font-bold"
            >
              Back to Jobs
            </button>
          </div>
        </div>

        <AuditorTemplateRunModal
          job={workspaceJob}
          auditor={selectedAuditor}
          template={workspaceTemplate}
          onClose={() => setWorkspaceJobId('')}
          onUploadEvidence={(files) => onUploadDocuments(workspaceJob.id, files, selectedAuditor.id)}
          onRecordFinding={(findingPayload) =>
            onRecordFinding?.(workspaceJob.id, selectedAuditor.id, findingPayload)
          }
          onCompleteAudit={(completionPayload) => {
            const completionResult = onCompleteJob(workspaceJob.id, selectedAuditor.id, completionPayload);
            if (completionResult && typeof completionResult === 'object' && completionResult.artifactId) {
              openCompletedArtifactModal(completionResult.artifactId);
            }
            return completionResult;
          }}
        />

        {showAdjustmentModal && selectedAdjustmentJob && (
          <PricingAdjustmentModal
            job={selectedAdjustmentJob}
            onClose={() => {
              setShowAdjustmentModal(false);
              setAdjustmentJobId('');
            }}
            onSubmit={(payload) => {
              const wasApplied = onApplyAdjustment(selectedAdjustmentJob.id, payload);
              if (wasApplied) {
                setShowAdjustmentModal(false);
                setAdjustmentJobId('');
              }
            }}
          />
        )}
      </div>
    );
  }

  return (
    <div className="space-y-6 animate-in fade-in duration-300 pb-10">
      <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-5 md:p-6 shadow-sm hover-lift">
        <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
          <div>
            <p className="text-xs font-bold tracking-wider uppercase text-cyan-600 dark:text-cyan-400 mb-2">
              InCert Exchange
            </p>
            <h2 className="text-2xl font-black text-slate-800 dark:text-white tracking-tight">
              {isCompanyPortal && 'Company Portal'}
              {isAuditorPortal && (isAuditCompanyRole ? 'Audit Company Portal' : 'Auditor Portal')}
              {isInCertPortal && 'InCert Admin Portal'}
              {isInsurerPortal && 'Insurer Read-only Portal'}
            </h2>
            <p className="text-sm text-slate-600 dark:text-slate-400 mt-2 max-w-2xl">
              {isCompanyPortal &&
                'Book statutory work with fixed quotes. Company users only see total, VAT, and booking status.'}
              {isAuditorPortal &&
                (isAuditCompanyRole
                  ? 'Bid on open jobs, assign your in-house auditors, and manage evidence/completion workflow.'
                  : 'View assigned/open jobs, accept offers, deliver evidence, and manage completion workflow.')}
              {isInCertPortal &&
                'Admin visibility for quoted totals, provider payout, platform fee, and operational adjustments.'}
              {isInsurerPortal &&
                'Read-only access to completed jobs and verification-ready evidence trails.'}
            </p>
          </div>
          {isCompanyPortal && (
            <button
              onClick={() => setShowComposer(true)}
              className="px-4 py-2.5 rounded-xl bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-sm flex items-center gap-2"
            >
              <Plus className="w-4 h-4" />
              Advertise Audit Job
            </button>
          )}
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
        <GlassStatCard title="Open Jobs" value={openCount} icon={<ClipboardList />} color="text-cyan-600 dark:text-cyan-400" bgClass="bg-cyan-50 dark:bg-cyan-900/20" />
        <GlassStatCard title="Offers Sent" value={offeredCount} icon={<Bell />} color="text-violet-600 dark:text-violet-400" bgClass="bg-violet-50 dark:bg-violet-900/20" />
        <GlassStatCard title="Assigned" value={assignedCount} icon={<Users />} color="text-indigo-600 dark:text-indigo-400" bgClass="bg-indigo-50 dark:bg-indigo-900/20" />
        <GlassStatCard
          title={awaitingReviewCount > 0 ? `In Progress (${awaitingReviewCount} review)` : 'In Progress'}
          value={inProgressCount}
          icon={<Activity />}
          color="text-amber-600 dark:text-amber-400"
          bgClass="bg-amber-50 dark:bg-amber-900/20"
        />
        <GlassStatCard title="Completed" value={completedCount} icon={<CheckCircle2 />} color="text-emerald-600 dark:text-emerald-400" bgClass="bg-emerald-50 dark:bg-emerald-900/20" />
      </div>

      <div className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          {isRoleLockedMarketplaceMode ? (
            <div className="rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 bg-slate-50/80 dark:bg-slate-900/40">
              <p className="text-xs font-bold text-slate-700 dark:text-slate-200">
                Role view locked to {USER_ROLE_OPTIONS.find((roleOption) => roleOption.id === normalizedDebugRole)?.label || 'Company'}
              </p>
            </div>
          ) : (
            <div className="grid grid-cols-2 md:grid-cols-4 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden w-full md:w-auto">
              <button
                onClick={() => setActiveMode('company')}
                className={`px-3 py-2 text-xs font-bold ${isCompanyPortal ? 'bg-cyan-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300'}`}
              >
                Company
              </button>
              <button
                onClick={() => setActiveMode('auditor')}
                className={`px-3 py-2 text-xs font-bold border-l border-slate-200 dark:border-slate-700 ${isAuditorPortal ? 'bg-cyan-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300'}`}
              >
                Auditor
              </button>
              <button
                onClick={() => setActiveMode('incert')}
                className={`px-3 py-2 text-xs font-bold border-l border-slate-200 dark:border-slate-700 ${isInCertPortal ? 'bg-cyan-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300'}`}
              >
                InCert
              </button>
              <button
                onClick={() => setActiveMode('insurer')}
                className={`px-3 py-2 text-xs font-bold border-l border-slate-200 dark:border-slate-700 ${isInsurerPortal ? 'bg-cyan-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300'}`}
              >
                Insurer
              </button>
            </div>
          )}

          {isInsurerPortal ? (
            <p className="text-xs text-slate-500 dark:text-slate-400 font-semibold">
              Read-only feed: completed jobs and evidence timeline only.
            </p>
          ) : (
            <div className="flex gap-2 flex-wrap">
              {['all', 'open', 'offered', 'assigned', 'in_progress', 'awaiting_review', 'completed'].map((status) => (
                <button
                  key={status}
                  onClick={() => setStatusFilter(status)}
                  className={`px-2.5 py-1.5 rounded-lg text-xs font-bold border ${
                    statusFilter === status
                      ? 'bg-slate-900 text-white border-slate-900 dark:bg-slate-100 dark:text-slate-900 dark:border-slate-100'
                      : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300'
                  }`}
                >
                  {status === 'all' ? 'All' : status.replace('_', ' ')}
                </button>
              ))}
            </div>
          )}
        </div>

        {isAuditorPortal && (
          <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 flex flex-col md:flex-row md:items-center gap-3">
            <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
              {isAuditCompanyRole ? 'Assigned Auditor' : 'Active Auditor'}
            </label>
            <select
              value={selectedAuditorId}
              onChange={(event) => setSelectedAuditorId(event.target.value)}
              className="px-3 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm"
            >
              {auditors.map((auditor) => (
                <option key={auditor.id} value={auditor.id}>
                  {auditor.name} ({auditor.rating.toFixed(1)}â, {auditor.baseLocation})
                </option>
              ))}
            </select>
            {selectedAuditor && (
              <p className="text-xs text-slate-500 dark:text-slate-400">
                {isAuditCompanyRole
                  ? `Assigning ${selectedAuditor.name} â¢ Capacity ${selectedAuditor.activeJobs}/${selectedAuditor.maxConcurrentJobs || 8}`
                  : `Avg response ${selectedAuditor.avgResponseMins} mins â¢ Active jobs ${selectedAuditor.activeJobs}/${selectedAuditor.maxConcurrentJobs || 8}`}
              </p>
            )}
          </div>
        )}
      </div>

      {isInCertPortal && (
        <div className="glass-panel bg-emerald-50/70 dark:bg-emerald-900/10 border border-emerald-200 dark:border-emerald-900/40 rounded-2xl p-4 md:p-5 shadow-sm">
          <p className="text-[11px] font-bold uppercase tracking-wider text-emerald-700 dark:text-emerald-300 mb-3">
            InCert Admin Finance Summary
          </p>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div className="rounded-xl border border-emerald-200/70 dark:border-emerald-900/50 bg-white/70 dark:bg-slate-900/30 px-3 py-2">
              <p className="text-[11px] uppercase tracking-wider text-emerald-700/90 dark:text-emerald-300/90">Company Total (inc VAT)</p>
              <p className="text-sm font-black text-emerald-800 dark:text-emerald-200">{formatCurrencyGBP(incertFinanceTotals.companyTotalIncVat)}</p>
            </div>
            <div className="rounded-xl border border-emerald-200/70 dark:border-emerald-900/50 bg-white/70 dark:bg-slate-900/30 px-3 py-2">
              <p className="text-[11px] uppercase tracking-wider text-emerald-700/90 dark:text-emerald-300/90">Auditor Payout (ex VAT)</p>
              <p className="text-sm font-black text-emerald-800 dark:text-emerald-200">{formatCurrencyGBP(incertFinanceTotals.auditorPayoutExVat)}</p>
            </div>
            <div className="rounded-xl border border-emerald-200/70 dark:border-emerald-900/50 bg-white/70 dark:bg-slate-900/30 px-3 py-2">
              <p className="text-[11px] uppercase tracking-wider text-emerald-700/90 dark:text-emerald-300/90">InCert Gross (ex VAT)</p>
              <p className="text-sm font-black text-emerald-800 dark:text-emerald-200">{formatCurrencyGBP(incertFinanceTotals.incertGrossExVat)}</p>
            </div>
          </div>
        </div>
      )}

      {isCompanyPortal || isInCertPortal ? (
        <div className="space-y-4">
          {paginatedJobs.length === 0 ? (
            <div className="p-12 text-center glass-panel bg-white/50 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
              <ClipboardList className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" />
              <p className="text-slate-500 dark:text-slate-400 font-medium">No advertised jobs for this filter.</p>
            </div>
          ) : (
            paginatedJobs.map((job) => {
              const matchedAuditor = auditors.find((auditor) => auditor.id === job.matchedAuditorId);
              const rankedAuditors = rankAuditorsForJob(job, auditors, nowTick).slice(0, 3);
              const resolvedTemplate = pickBestInspectionTemplateForRegime(inspectionTemplates, job.regime, {
                templateId: job.inspectionTemplateId,
                companyId: job.companyId || companyContext?.id,
                companyName: job.companyName || companyContext?.name,
              });
              const templateControlCount =
                Array.isArray(resolvedTemplate?.controls) && resolvedTemplate.controls.length > 0
                  ? resolvedTemplate.controls.length
                  : getDefaultChecklistControlsByRegime(job.regime).length;
              const scope = getMarketplaceJobScope(job);
              const pricing = getMarketplaceJobPricing(job);
              const pricingHistory = getMarketplaceJobPricingHistory(job, pricing);
              const pricingLock = getMarketplaceJobPricingLock(job, pricing);
              const adjustments = getMarketplaceJobPricingAdjustments(job);
              const settlement = getMarketplaceJobSettlement(job, pricing);
              const dispatch = getMarketplaceJobDispatch(job);
              const auditExecutionMode = normalizeAuditExecutionMode(job.auditExecutionMode);
              const isExternalAuditFlow = auditExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE;
              const externalReviewStatus = resolveExternalAuditReviewStatus(job, auditExecutionMode);
              const offerExpired = isOfferExpired(job, nowTick);
              const offerMinsRemaining = minutesUntil(dispatch.offerExpiresAt, nowTick);
              const dispatchSlaRemaining = minutesUntil(dispatch.dispatchDeadlineAt, nowTick);
              return (
                <div
                  key={job.id}
                  className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm hover-lift"
                >
                  <div className="flex flex-col md:flex-row md:items-start justify-between gap-3">
                    <div>
                      <p className="text-sm font-black text-slate-800 dark:text-white">
                        {job.id} â¢ {job.assetName}
                      </p>
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                        {job.site} â¢ {job.regime} â¢ Due {formatDateLabel(job.dueDate)} â¢ {formatCurrencyGBP(pricing.total)}
                      </p>
                    </div>
                    <JobStatusPill status={job.status} />
                  </div>

                  <div className="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 px-3 py-2">
                    <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                      Scope Builder
                    </p>
                    <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
                      {getScopeTemplateLabel(scope.template)} â¢ {scope.assetCount} asset(s) â¢ {scope.estimatedHours}h â¢{' '}
                      {scope.complexity.replace('_', ' ')}
                    </p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Travel {scope.travelKm}km â¢ Equipment {scope.equipment.replace('_', ' ')} â¢{' '}
                      {scope.expedite ? 'Expedite requested' : 'Standard dispatch'}
                    </p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Template: {resolvedTemplate?.name || job.inspectionTemplateName || `${job.regime} default checklist`} â¢ {templateControlCount} controls
                    </p>
                  </div>

                  <div className="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/75 dark:bg-slate-900/30 px-3 py-2">
                    <p className="text-[11px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                      Audit Delivery
                    </p>
                    <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
                      Method: {getAuditExecutionModeLabel(auditExecutionMode)}
                      {isExternalAuditFlow
                        ? ` â¢ Review: ${getExternalAuditReviewStatusLabel(externalReviewStatus)}`
                        : ''}
                    </p>
                  </div>

                  {isInCertPortal ? (
                    <div className="mt-3 grid grid-cols-2 md:grid-cols-6 gap-2">
                      <div className="rounded-lg border border-slate-200 dark:border-slate-700 px-2 py-1.5">
                        <p className="text-[10px] uppercase tracking-wider text-slate-500">Labour</p>
                        <p className="text-xs font-bold text-slate-700 dark:text-slate-200">{formatCurrencyGBP(pricing.labour)}</p>
                      </div>
                      <div className="rounded-lg border border-slate-200 dark:border-slate-700 px-2 py-1.5">
                        <p className="text-[10px] uppercase tracking-wider text-slate-500">Travel</p>
                        <p className="text-xs font-bold text-slate-700 dark:text-slate-200">{formatCurrencyGBP(pricing.travel)}</p>
                      </div>
                      <div className="rounded-lg border border-slate-200 dark:border-slate-700 px-2 py-1.5">
                        <p className="text-[10px] uppercase tracking-wider text-slate-500">Equipment</p>
                        <p className="text-xs font-bold text-slate-700 dark:text-slate-200">{formatCurrencyGBP(pricing.equipment)}</p>
                      </div>
                      <div className="rounded-lg border border-slate-200 dark:border-slate-700 px-2 py-1.5">
                        <p className="text-[10px] uppercase tracking-wider text-slate-500">Modifiers</p>
                        <p className="text-xs font-bold text-slate-700 dark:text-slate-200">{formatCurrencyGBP(pricing.expedite)}</p>
                      </div>
                      <div className="rounded-lg border border-slate-200 dark:border-slate-700 px-2 py-1.5">
                        <p className="text-[10px] uppercase tracking-wider text-slate-500">VAT</p>
                        <p className="text-xs font-bold text-slate-700 dark:text-slate-200">{formatCurrencyGBP(pricing.vatAmount)}</p>
                      </div>
                      <div className="rounded-lg border border-cyan-200 dark:border-cyan-800/30 bg-cyan-50/70 dark:bg-cyan-900/10 px-2 py-1.5">
                        <p className="text-[10px] uppercase tracking-wider text-cyan-700 dark:text-cyan-300">Total inc VAT</p>
                        <p className="text-xs font-black text-cyan-700 dark:text-cyan-300">{formatCurrencyGBP(pricing.total)}</p>
                      </div>
                    </div>
                  ) : (
                    <div className="mt-3 grid grid-cols-2 gap-2">
                      <div className="rounded-lg border border-slate-200 dark:border-slate-700 px-2 py-1.5">
                        <p className="text-[10px] uppercase tracking-wider text-slate-500">VAT</p>
                        <p className="text-xs font-bold text-slate-700 dark:text-slate-200">{formatCurrencyGBP(pricing.vatAmount)}</p>
                      </div>
                      <div className="rounded-lg border border-cyan-200 dark:border-cyan-800/30 bg-cyan-50/70 dark:bg-cyan-900/10 px-2 py-1.5">
                        <p className="text-[10px] uppercase tracking-wider text-cyan-700 dark:text-cyan-300">Total inc VAT</p>
                        <p className="text-xs font-black text-cyan-700 dark:text-cyan-300">{formatCurrencyGBP(pricing.total)}</p>
                      </div>
                    </div>
                  )}

                  <p className="text-sm text-slate-600 dark:text-slate-300 mt-3">{job.notes}</p>

                  <div className="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/75 dark:bg-slate-900/30 px-3 py-2">
                    <p className="text-[11px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                      Dispatch SLA
                    </p>
                    <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
                      Confirm by {formatDateTimeLabel(dispatch.dispatchDeadlineAt)} (
                      {dispatchSlaRemaining === null
                        ? 'n/a'
                        : dispatchSlaRemaining >= 0
                          ? `${dispatchSlaRemaining} mins remaining`
                          : `${Math.abs(dispatchSlaRemaining)} mins overdue`}
                      ) â¢ Attempts {dispatch.attempts}
                    </p>
                    {job.status === 'offered' && (
                      <p className={`text-xs mt-1 ${offerExpired ? 'text-rose-500' : 'text-violet-600 dark:text-violet-300'}`}>
                        {offerExpired
                          ? 'Offer expired. Re-dispatch required.'
                          : `Offer expires ${formatDateTimeLabel(dispatch.offerExpiresAt)} (${offerMinsRemaining} mins left)`}
                      </p>
                    )}
                  </div>

                  {isInCertPortal && (
                    <div className="mt-3 rounded-xl border border-emerald-200 dark:border-emerald-900/40 bg-emerald-50/60 dark:bg-emerald-900/10 px-3 py-3 space-y-2">
                      <div className="flex flex-wrap items-center justify-between gap-2">
                        <p className="text-[11px] font-semibold uppercase tracking-wider text-emerald-700 dark:text-emerald-300">
                          InCert Finance View
                        </p>
                        <span className="text-[11px] text-emerald-700/80 dark:text-emerald-300/80">
                          {pricing.quoteId} â¢ v{pricing.quoteVersion} â¢ {formatPercentage(pricing.effectiveTakeRate)} take-rate
                        </span>
                      </div>
                      <p className="text-xs text-emerald-800/80 dark:text-emerald-300/90">
                        Company pays {formatCurrencyGBP(pricing.total)} inc VAT â¢ Auditor receives {formatCurrencyGBP(pricing.providerPayoutExVat)} ex VAT â¢ InCert platform/documentation fee {formatCurrencyGBP(pricing.platformFeeExVat)} ex VAT
                      </p>
                      <p className="text-xs text-emerald-800/80 dark:text-emerald-300/90">
                        InCert share covers platform operations, documentation workflows, verification, and compliance delivery overhead.
                      </p>
                      <p className="text-xs text-emerald-800/80 dark:text-emerald-300/90">
                        Model {pricing.pricingModelVersion} â¢ Rate card {pricing.rateCardVersionId} â¢ Route {pricing.routeEstimate?.miles || 0} miles
                      </p>
                      <p className="text-xs text-emerald-800/80 dark:text-emerald-300/90">
                        Auditor payout profile: Â£{Number(pricing.auditorHourlyRate || 0).toFixed(2)}/h â¢ {Number(
                          pricing.auditorBillableHours || 0
                        ).toFixed(2)} billable h â¢ travel payout {formatCurrencyGBP(pricing.auditorTravelPayoutExVat)} ex VAT
                      </p>
                      <p className="text-xs text-emerald-800/80 dark:text-emerald-300/90">
                        {pricingLock
                          ? `Pricing lock ${pricingLock.pricingLockId} at ${formatDateTimeLabel(pricingLock.lockedAt)}`
                          : 'Awaiting provider acceptance to create pricing lock.'}
                      </p>

                      {adjustments.length > 0 && (
                        <div className="pt-1 space-y-1">
                          {adjustments.slice(-2).map((entry) => (
                            <p key={entry.adjustmentId} className="text-xs text-emerald-900/80 dark:text-emerald-200/90">
                              {entry.type.replace(/_/g, ' ')} {entry.amountExVatDelta >= 0 ? '+' : ''}{formatCurrencyGBP(entry.amountExVatDelta)} ex VAT â¢ {entry.reasonCode}
                            </p>
                          ))}
                        </div>
                      )}

                      {pricingLock && (
                        <div className="pt-1 flex flex-wrap gap-2">
                          <button
                            onClick={() => {
                              setAdjustmentJobId(job.id);
                              setShowAdjustmentModal(true);
                            }}
                            className="px-2.5 py-1.5 rounded-lg text-[11px] font-bold border border-emerald-300 dark:border-emerald-800/50 bg-white/80 dark:bg-slate-900/50 text-emerald-700 dark:text-emerald-300"
                          >
                            Add Adjustment Event
                          </button>
                          <span className="text-[11px] text-emerald-700/80 dark:text-emerald-300/80 self-center">
                            Quote history: {pricingHistory.length} version(s)
                          </span>
                        </div>
                      )}

                      {settlement && (
                        <p className="text-xs text-emerald-800/80 dark:text-emerald-300/90">
                          Settlement {settlement.payoutStatus.replace('_', ' ')} â¢ payout {settlement.scheduledPayoutDate || 'n/a'} â¢ holdback {formatCurrencyGBP(settlement.holdbackAmount)} â¢ reserve {formatCurrencyGBP(settlement.disputeReserveAmount)}
                        </p>
                      )}
                    </div>
                  )}

                  {isInCertPortal && (job.status === 'open' || (job.status === 'offered' && offerExpired)) && (
                    <div className="mt-4">
                      <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">
                        InCert Match Recommendations
                      </p>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                        {rankedAuditors.length === 0 ? (
                          <p className="text-xs text-slate-500 dark:text-slate-400">No suitable auditors found for {job.regime}.</p>
                        ) : (
                          rankedAuditors.map((candidate) => (
                            <button
                              key={candidate.auditor.id}
                              onClick={() => onDispatchJob(job.id, candidate.auditor.id)}
                              className="text-left rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 p-3 hover-lift"
                            >
                              <div className="flex items-center justify-between gap-2">
                                <p className="text-xs font-bold text-slate-800 dark:text-white">{candidate.auditor.name}</p>
                                <span className="text-xs font-bold text-cyan-600 dark:text-cyan-400">{candidate.score}%</span>
                              </div>
                              <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                                ETA {candidate.etaHours}h
                                {isInCertPortal
                                  ? ` â¢ Payout est. ${formatCurrencyGBP(candidate.payoutEstimate)} â¢ Â£${Number(
                                      candidate.auditorHourlyRate || 0
                                    ).toFixed(2)}/h`
                                  : ''}
                              </p>
                              <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                                Capacity {candidate.capacityRemaining} slot(s) â¢ Offer window {candidate.offerWindowMins} mins
                              </p>
                            </button>
                          ))
                        )}
                      </div>
                    </div>
                  )}

                  {matchedAuditor && job.status === 'offered' && !offerExpired && (
                    <div className="mt-4 rounded-xl border border-violet-200 dark:border-violet-800/30 bg-violet-50/70 dark:bg-violet-900/10 px-3 py-2 text-xs text-violet-700 dark:text-violet-300">
                      Awaiting acceptance from <span className="font-bold">{matchedAuditor.name}</span> by{' '}
                      {formatDateTimeLabel(dispatch.offerExpiresAt)}.
                    </div>
                  )}

                  {matchedAuditor && ['assigned', 'in_progress', 'awaiting_review', 'completed'].includes(job.status) && (
                    <div className="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 px-3 py-2 text-xs text-slate-600 dark:text-slate-300">
                      Assigned auditor: <span className="font-bold">{matchedAuditor.name}</span>
                    </div>
                  )}

                  {isInCertPortal && isExternalAuditFlow && job.status === 'awaiting_review' && (
                    <div className="mt-4 rounded-xl border border-cyan-200 dark:border-cyan-800/40 bg-cyan-50/70 dark:bg-cyan-900/20 px-3 py-3">
                      <p className="text-xs text-cyan-700 dark:text-cyan-300 font-semibold">
                        External audit evidence is pending InCert review.
                      </p>
                      <div className="mt-2 flex flex-wrap gap-2">
                        <button
                          type="button"
                          onClick={() => onReviewExternalAudit?.(job.id, 'approve')}
                          className="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold"
                        >
                          Approve Evidence
                        </button>
                        <button
                          type="button"
                          onClick={() => onReviewExternalAudit?.(job.id, 'reject')}
                          className="px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700 text-white text-xs font-bold"
                        >
                          Request Revisions
                        </button>
                      </div>
                    </div>
                  )}

                  <div className="mt-4 pt-3 border-t border-slate-200 dark:border-slate-700">
                    <p className="text-[11px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">
                      Activity Timeline
                    </p>
                    <div className="space-y-1.5">
                      {job.timeline.slice(-3).map((item, index) => (
                        <p key={`${job.id}-${index}`} className="text-xs text-slate-600 dark:text-slate-300">
                          <span className="font-semibold">{item.at}</span> â¢ {item.label} <span className="text-slate-400">({item.actor})</span>
                        </p>
                      ))}
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      ) : isAuditorPortal ? (
        <div className="space-y-4">
          {paginatedJobs.length === 0 ? (
            <div className="p-12 text-center glass-panel bg-white/50 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
              <Users className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" />
              <p className="text-slate-500 dark:text-slate-400 font-medium">
                {isAuditCompanyRole ? 'No open jobs available to bid right now.' : 'No available jobs for this auditor.'}
              </p>
            </div>
          ) : (
            paginatedJobs.map((job) => {
              const currentMatch = selectedAuditor ? computeAuditorMatch(job, selectedAuditor, nowTick) : null;
              const isOwnedBySelectedAuditor = job.matchedAuditorId === selectedAuditorId;
              const completedArtifactForJob = getLatestArtifactForJob(job.id);
              const dispatch = getMarketplaceJobDispatch(job);
              const offerExpired = isOfferExpired(job, nowTick);
              const offerMinsRemaining = minutesUntil(dispatch.offerExpiresAt, nowTick);
              const pricing = getMarketplaceJobPricing(job);
              const payoutOptions = getAuditorPayoutOptions(pricing);
              const auditExecutionMode = normalizeAuditExecutionMode(job.auditExecutionMode);
              const isExternalAuditFlow = auditExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE;
              const externalReviewStatus = resolveExternalAuditReviewStatus(job, auditExecutionMode);
              const requiresAuditMethodSelection =
                isOwnedBySelectedAuditor && job.status === 'in_progress' && !job.auditMethodLocked;
              const reassignmentTargetId = resolveReassignmentTarget(job.id, job.matchedAuditorId);
              const canReassignJob =
                Boolean(reassignmentTargetId) && reassignmentTargetId !== job.matchedAuditorId;
              const auditorPayoutLabel = (() => {
                if (job.auditMethodLocked) {
                  return auditExecutionMode === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
                    ? `${formatCurrencyGBP(payoutOptions.ownSoftwareExVat)} ex VAT`
                    : `${formatCurrencyGBP(payoutOptions.incertTemplateExVat)} ex VAT`;
                }
                return `${formatCurrencyGBP(payoutOptions.minExVat)} to ${formatCurrencyGBP(
                  payoutOptions.maxExVat
                )} ex VAT`;
              })();
              return (
                <div
                  key={job.id}
                  className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm hover-lift"
                >
                  <div className="flex flex-col md:flex-row md:items-start justify-between gap-3">
                    <div>
                      <p className="text-sm font-black text-slate-800 dark:text-white">
                        {job.id} â¢ {job.assetName}
                      </p>
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                        {job.site} â¢ {job.regime} â¢ {isAuditCompanyRole ? 'Audit company payout' : 'Auditor payout'} {auditorPayoutLabel}
                      </p>
                    </div>
                    <JobStatusPill status={job.status} />
                  </div>

                  {currentMatch && (
                    <div className="mt-3">
                      <p className="text-xs text-slate-600 dark:text-slate-300 mb-1">
                        Match score for {selectedAuditor?.name}: <span className="font-bold">{currentMatch.score}%</span>
                      </p>
                      <MatchScoreBar score={currentMatch.score} />
                      <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1">
                        Capacity remaining {currentMatch.capacityRemaining}
                      </p>
                    </div>
                  )}

                  {job.status === 'offered' && isOwnedBySelectedAuditor && (
                    <p className={`mt-3 text-xs ${offerExpired ? 'text-rose-500' : 'text-violet-600 dark:text-violet-300'}`}>
                      {offerExpired
                        ? 'Offer expired before acceptance.'
                        : `Offer expires ${formatDateTimeLabel(dispatch.offerExpiresAt)} (${offerMinsRemaining} mins left).`}
                    </p>
                  )}

                  {getMarketplaceJobPricingLock(job, pricing) && (
                    <p className="mt-3 text-[11px] text-slate-500 dark:text-slate-400">
                      Locked quote {pricing.quoteId}
                    </p>
                  )}

                  {isOwnedBySelectedAuditor && job.status !== 'open' && (
                    <div className="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 px-3 py-2">
                      <p className="text-[11px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                        Audit method
                      </p>
                      <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
                        {requiresAuditMethodSelection ? 'Select method to continue' : getAuditExecutionModeLabel(auditExecutionMode)}
                        {isExternalAuditFlow
                          ? ` â¢ ${getExternalAuditReviewStatusLabel(externalReviewStatus)}`
                          : ''}
                      </p>
                    </div>
                  )}

                  {isAuditCompanyRole &&
                    job.matchedAuditorId &&
                    ['offered', 'assigned', 'in_progress', 'awaiting_review'].includes(job.status) && (
                      <div className="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 px-3 py-3">
                        <p className="text-[11px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                          Audit company reassignment
                        </p>
                        <div className="mt-2 flex flex-col md:flex-row gap-2 md:items-center">
                          <select
                            value={reassignmentTargetId}
                            onChange={(event) =>
                              setReassignmentTargets((previousTargets) => ({
                                ...previousTargets,
                                [job.id]: event.target.value,
                              }))
                            }
                            className="px-3 py-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-xs font-semibold"
                          >
                            {auditors.map((auditor) => (
                              <option key={`${job.id}-reassign-${auditor.id}`} value={auditor.id}>
                                {auditor.name} ({auditor.activeJobs}/{auditor.maxConcurrentJobs || 8})
                              </option>
                            ))}
                          </select>
                          <button
                            type="button"
                            disabled={!canReassignJob}
                            onClick={() => {
                              if (!canReassignJob) {
                                return;
                              }
                              const didReassign = onReassignJob?.(
                                job.id,
                                job.matchedAuditorId,
                                reassignmentTargetId,
                                'Audit Company Assignment Desk'
                              );
                              if (didReassign !== false) {
                                setReassignmentTargets((previousTargets) => {
                                  const updatedTargets = { ...previousTargets };
                                  delete updatedTargets[job.id];
                                  return updatedTargets;
                                });
                              }
                            }}
                            className={`px-3 py-2 rounded-lg text-xs font-bold ${
                              canReassignJob
                                ? 'bg-indigo-600 hover:bg-indigo-700 text-white'
                                : 'bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-300 cursor-not-allowed'
                            }`}
                          >
                            Reassign Auditor
                          </button>
                        </div>
                      </div>
                    )}

                  <div className="mt-4 flex flex-wrap gap-2">
                    {isOwnedBySelectedAuditor &&
                      job.status === 'in_progress' &&
                      !requiresAuditMethodSelection &&
                      !isExternalAuditFlow && (
                      <button
                        onClick={() => setWorkspaceJobId(job.id)}
                        className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
                      >
                        Open Template
                      </button>
                      )}
                    {job.status === 'open' && selectedAuditor && currentMatch?.canAccept && (
                      <button
                        onClick={() => openAcceptMethodPicker(job)}
                        className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
                      >
                        {isAuditCompanyRole ? 'Bid & Claim Job' : 'Claim Job'}
                      </button>
                    )}
                    {job.status === 'offered' && isOwnedBySelectedAuditor && !offerExpired && (
                      <button
                        onClick={() => openAcceptMethodPicker(job)}
                        className="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold"
                      >
                        {isAuditCompanyRole ? 'Accept Bid Offer' : 'Accept Offer'}
                      </button>
                    )}
                    {job.status === 'offered' && isOwnedBySelectedAuditor && offerExpired && (
                      <button
                        onClick={() => onDispatchJob(job.id, selectedAuditor.id, selectedAuditor.name)}
                        className="px-3 py-2 rounded-lg bg-rose-600 hover:bg-rose-700 text-white text-xs font-bold"
                      >
                        Request Re-offer
                      </button>
                    )}
                    {(job.status === 'assigned' || requiresAuditMethodSelection) && isOwnedBySelectedAuditor && (
                      <button
                        onClick={() => {
                          if (job.auditMethodLocked) {
                            const selectedMode = normalizeAuditExecutionMode(job.auditExecutionMode);
                            const didStart = onStartJob(job.id, selectedAuditorId, selectedMode);
                            if (didStart === false) {
                              return;
                            }
                            if (selectedMode === AUDIT_EXECUTION_MODES.INCERT_TEMPLATE) {
                              onStartAuditRunForJob?.(job.id);
                              setWorkspaceJobId(job.id);
                            }
                            return;
                          }
                          openAuditMethodPicker(job);
                        }}
                        className="px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold"
                      >
                        Start Audit
                      </button>
                    )}
                    {job.status === 'in_progress' && isOwnedBySelectedAuditor && (
                      isExternalAuditFlow ? (
                        <>
                          <label className="px-3 py-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-xs font-bold cursor-pointer">
                            Upload Evidence
                            <input
                              type="file"
                              multiple
                              className="hidden"
                              onChange={(event) =>
                                onUploadDocuments(
                                  job.id,
                                  Array.from(event.target.files || []),
                                  selectedAuditorId
                                )
                              }
                            />
                          </label>
                          <button
                            onClick={() => onSubmitExternalForReview?.(job.id, selectedAuditorId)}
                            disabled={job.documents.length === 0}
                            className={`px-3 py-2 rounded-lg text-white text-xs font-bold ${
                              job.documents.length === 0
                                ? 'bg-indigo-300 dark:bg-indigo-900/40 cursor-not-allowed'
                                : 'bg-indigo-600 hover:bg-indigo-700'
                            }`}
                          >
                            Submit for Review
                          </button>
                        </>
                      ) : (
                        <>
                          <label className="px-3 py-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-xs font-bold cursor-pointer">
                            Upload Docs
                            <input
                              type="file"
                              multiple
                              className="hidden"
                              onChange={(event) =>
                                onUploadDocuments(
                                  job.id,
                                  Array.from(event.target.files || []),
                                  selectedAuditorId
                                )
                              }
                            />
                          </label>
                          <button
                            onClick={() => setWorkspaceJobId(job.id)}
                            className="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold"
                          >
                            Complete in Template
                          </button>
                        </>
                      )
                    )}
                    {job.status === 'awaiting_review' &&
                      isOwnedBySelectedAuditor &&
                      isExternalAuditFlow && (
                        <span className="px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs font-bold">
                          Awaiting InCert review
                        </span>
                      )}
                    {job.status === 'completed' && isOwnedBySelectedAuditor && completedArtifactForJob && (
                      <button
                        onClick={() => openCompletedArtifactModal(completedArtifactForJob.id)}
                        className="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold"
                      >
                        View Completed Report
                      </button>
                    )}
                  </div>

                  {job.documents.length > 0 && (
                    <div className="mt-3 text-xs text-slate-500 dark:text-slate-400">
                      Uploaded docs: {job.documents.join(', ')}
                    </div>
                  )}
                  {job.status === 'completed' && completedArtifactForJob && (
                    <div className="mt-3 text-xs text-slate-600 dark:text-slate-300">
                      Report artifact: <span className="font-semibold">{completedArtifactForJob.id}</span> â¢ v
                      {completedArtifactForJob.version}
                    </div>
                  )}
                  {isOwnedBySelectedAuditor &&
                    isExternalAuditFlow &&
                    job.status === 'in_progress' &&
                    job.documents.length === 0 && (
                      <div className="mt-3 text-xs text-amber-600 dark:text-amber-300">
                        Upload at least one evidence file before submitting for review.
                      </div>
                    )}
                </div>
              );
            })
          )}
        </div>
      ) : (
        <div className="space-y-4">
          {paginatedJobs.length === 0 ? (
            <div className="p-12 text-center glass-panel bg-white/50 dark:bg-slate-800/50 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
              <ShieldCheck className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" />
              <p className="text-slate-500 dark:text-slate-400 font-medium">No completed jobs for insurer review.</p>
            </div>
          ) : (
            paginatedJobs.map((job) => {
              const matchedAuditor = auditors.find((auditor) => auditor.id === job.matchedAuditorId);
              const completionEvent =
                [...job.timeline].reverse().find((entry) => entry.label.toLowerCase().includes('complete')) || null;
              return (
                <div
                  key={job.id}
                  className="glass-panel bg-white/85 dark:bg-slate-800/85 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-5 shadow-sm"
                >
                  <div className="flex flex-col md:flex-row md:items-start justify-between gap-3">
                    <div>
                      <p className="text-sm font-black text-slate-800 dark:text-white">
                        {job.id} â¢ {job.assetName}
                      </p>
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                        {job.site} â¢ {job.regime} â¢ Completed {completionEvent?.at || formatDateLabel(job.dueDate)}
                      </p>
                    </div>
                    <JobStatusPill status={job.status} />
                  </div>

                  <div className="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 px-3 py-2">
                    <p className="text-[11px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                      Verification Snapshot
                    </p>
                    <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">
                      Auditor: {matchedAuditor?.name || 'Assigned provider'} â¢ Evidence files: {job.documents.length}
                    </p>
                    {job.documents.length > 0 && (
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Documents: {job.documents.join(', ')}</p>
                    )}
                  </div>

                  <div className="mt-4 pt-3 border-t border-slate-200 dark:border-slate-700">
                    <p className="text-[11px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">
                      Activity Timeline
                    </p>
                    <div className="space-y-1.5">
                      {job.timeline.slice(-4).map((item, index) => (
                        <p key={`${job.id}-insurer-${index}`} className="text-xs text-slate-600 dark:text-slate-300">
                          <span className="font-semibold">{item.at}</span> â¢ {item.label} <span className="text-slate-400">({item.actor})</span>
                        </p>
                      ))}
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      <PaginationControls
        currentPage={currentPage}
        totalPages={totalPages}
        onPrevious={() => setPage((previous) => Math.max(1, previous - 1))}
        onNext={() => setPage((previous) => Math.min(totalPages, previous + 1))}
      />

      {acceptJob && selectedAuditor && (
        <div className="fixed inset-0 z-[124] bg-slate-900/45 dark:bg-slate-950/70 backdrop-blur-sm p-4 flex items-center justify-center">
          <div className="w-full max-w-xl rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
            <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 flex items-start justify-between gap-3">
              <div>
                <h3 className="text-lg font-black text-slate-800 dark:text-white">
                  {isAuditCompanyRole ? 'Accept Job Bid' : 'Accept Job'}
                </h3>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  {acceptJob.id} â¢ {acceptJob.assetName}
                </p>
                {isAuditCompanyRole && (
                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    Auditor assignment: <span className="font-semibold">{selectedAuditor.name}</span>
                  </p>
                )}
              </div>
              <button
                type="button"
                onClick={() => setAcceptJobId('')}
                className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <X className="w-4 h-4 text-slate-500" />
              </button>
            </div>

            <div className="p-5 space-y-3">
              <button
                type="button"
                onClick={() => setAcceptAuditMode(AUDIT_EXECUTION_MODES.INCERT_TEMPLATE)}
                className={`w-full text-left rounded-xl border px-4 py-3 transition-colors ${
                  normalizeAuditExecutionMode(acceptAuditMode) === AUDIT_EXECUTION_MODES.INCERT_TEMPLATE
                    ? 'border-cyan-400 bg-cyan-50/80 dark:bg-cyan-900/20'
                    : 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/30'
                }`}
              >
                <p className="text-sm font-bold text-slate-800 dark:text-slate-100">InCert Template</p>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  Payout: {formatCurrencyGBP(acceptJobPayoutOptions?.incertTemplateExVat || 0)} ex VAT
                </p>
              </button>

              <button
                type="button"
                onClick={() => setAcceptAuditMode(AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE)}
                className={`w-full text-left rounded-xl border px-4 py-3 transition-colors ${
                  normalizeAuditExecutionMode(acceptAuditMode) === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
                    ? 'border-indigo-400 bg-indigo-50/80 dark:bg-indigo-900/20'
                    : 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/30'
                }`}
              >
                <p className="text-sm font-bold text-slate-800 dark:text-slate-100">My Own Software</p>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  Payout: {formatCurrencyGBP(acceptJobPayoutOptions?.ownSoftwareExVat || 0)} ex VAT
                </p>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  Evidence upload and InCert review required before completion.
                </p>
              </button>
            </div>

            <div className="px-5 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-2">
              <button
                type="button"
                onClick={() => setAcceptJobId('')}
                className="px-4 py-2 rounded-lg text-sm font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={confirmAcceptJob}
                className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white"
              >
                {isAuditCompanyRole ? 'Accept & Assign Auditor' : 'Accept Job'}
              </button>
            </div>
          </div>
        </div>
      )}

      {startAuditJob && (
        <div className="fixed inset-0 z-[125] bg-slate-900/45 dark:bg-slate-950/70 backdrop-blur-sm p-4 flex items-center justify-center">
          <div className="w-full max-w-xl rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
            <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 flex items-start justify-between gap-3">
              <div>
                <h3 className="text-lg font-black text-slate-800 dark:text-white">Choose Audit Method</h3>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  {startAuditJob.id} â¢ {startAuditJob.assetName}
                </p>
              </div>
              <button
                type="button"
                onClick={() => setStartAuditJobId('')}
                className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <X className="w-4 h-4 text-slate-500" />
              </button>
            </div>

            <div className="p-5 space-y-3">
              <button
                type="button"
                onClick={() => setStartAuditMode(AUDIT_EXECUTION_MODES.INCERT_TEMPLATE)}
                className={`w-full text-left rounded-xl border px-4 py-3 transition-colors ${
                  normalizeAuditExecutionMode(startAuditMode) === AUDIT_EXECUTION_MODES.INCERT_TEMPLATE
                    ? 'border-cyan-400 bg-cyan-50/80 dark:bg-cyan-900/20'
                    : 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/30'
                }`}
              >
                <p className="text-sm font-bold text-slate-800 dark:text-slate-100">Use InCert Template</p>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  Full in-app checklist workflow and standard payout schedule.
                </p>
              </button>

              <button
                type="button"
                onClick={() => setStartAuditMode(AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE)}
                className={`w-full text-left rounded-xl border px-4 py-3 transition-colors ${
                  normalizeAuditExecutionMode(startAuditMode) === AUDIT_EXECUTION_MODES.AUDITOR_SOFTWARE
                    ? 'border-indigo-400 bg-indigo-50/80 dark:bg-indigo-900/20'
                    : 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/30'
                }`}
              >
                <p className="text-sm font-bold text-slate-800 dark:text-slate-100">Use My Own Software</p>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  Evidence upload and InCert review required before completion.
                </p>
              </button>
            </div>

            <div className="px-5 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-2">
              <button
                type="button"
                onClick={() => setStartAuditJobId('')}
                className="px-4 py-2 rounded-lg text-sm font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={confirmAuditStart}
                className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white"
              >
                Start Audit
              </button>
            </div>
          </div>
        </div>
      )}

      {showCompletedReportModal && selectedCompletedArtifact && (
        <div className="fixed inset-0 z-[126] bg-slate-900/45 dark:bg-slate-950/70 backdrop-blur-sm p-4 flex items-center justify-center">
          <div className="w-full max-w-6xl rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
            <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 flex flex-wrap items-start justify-between gap-3">
              <div>
                <h3 className="text-lg font-black text-slate-800 dark:text-white">Completed Audit Report</h3>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  Artifact {selectedCompletedArtifact.id} â¢ Run {selectedCompletedArtifact.auditRunId} â¢ Version {selectedCompletedArtifact.version}
                </p>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  {selectedCompletedJob?.id ? `${selectedCompletedJob.id} â¢ ${selectedCompletedJob.assetName}` : 'Audit artifact ready'} â¢ Created{' '}
                  {formatDateLabel(String(selectedCompletedArtifact.createdAt || '').slice(0, 10))}
                </p>
              </div>
              <button
                type="button"
                onClick={closeCompletedArtifactModal}
                className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <X className="w-4 h-4 text-slate-500" />
              </button>
            </div>

            <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/40 flex flex-wrap items-center gap-2 text-xs">
              <span
                className={`px-2.5 py-1 rounded-full font-bold ${
                  selectedCompletedArtifact.vaultStatus === 'stored'
                    ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                    : 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300'
                }`}
              >
                Vault {selectedCompletedArtifact.vaultStatus === 'stored' ? 'stored' : 'pending'}
              </span>
              <span className="text-slate-600 dark:text-slate-300">
                Vault record: {selectedCompletedArtifact.vaultRecordId || 'pending'}
              </span>
              <span className="text-slate-600 dark:text-slate-300">
                Tamper seal: {selectedCompletedArtifact.tamperSealId || 'pending'}
              </span>
            </div>

            <div className="p-4">
              {selectedCompletedArtifact.htmlContent ? (
                <iframe
                  title={`completed-report-${selectedCompletedArtifact.id}`}
                  srcDoc={selectedCompletedArtifact.htmlContent}
                  className="w-full h-[60vh] border border-slate-200 dark:border-slate-700 rounded-xl bg-white"
                />
              ) : (
                <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40 p-6 text-sm text-slate-600 dark:text-slate-300">
                  Report HTML is still generating. You can close and reopen this view.
                </div>
              )}
            </div>

            <div className="px-5 py-4 border-t border-slate-200 dark:border-slate-700 flex flex-wrap justify-end gap-2">
              <button
                type="button"
                onClick={() => onDownloadReportArtifact?.(selectedCompletedArtifact.id)}
                className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white"
              >
                Download HTML Report
              </button>
              <button
                type="button"
                onClick={() => onSaveReportArtifactToVault?.(selectedCompletedArtifact.id)}
                className="px-4 py-2 rounded-lg text-sm font-bold bg-emerald-600 hover:bg-emerald-700 text-white"
              >
                Save to Evidence Vault
              </button>
              <button
                type="button"
                onClick={closeCompletedArtifactModal}
                className="px-4 py-2 rounded-lg text-sm font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {showComposer && (
        <MarketplaceComposerModal
          assets={assets}
          onClose={() => setShowComposer(false)}
          onSubmit={(payload) => {
            onCreateJob(payload);
            setShowComposer(false);
          }}
        />
      )}

      {showAdjustmentModal && selectedAdjustmentJob && (
        <PricingAdjustmentModal
          job={selectedAdjustmentJob}
          onClose={() => {
            setShowAdjustmentModal(false);
            setAdjustmentJobId('');
          }}
          onSubmit={(payload) => {
            const wasApplied = onApplyAdjustment(selectedAdjustmentJob.id, payload);
            if (wasApplied) {
              setShowAdjustmentModal(false);
              setAdjustmentJobId('');
            }
          }}
        />
      )}
    </div>
  );
}

function AuditorTemplateRunModal({
  job,
  auditor,
  template,
  onClose,
  onUploadEvidence,
  onRecordFinding,
  onCompleteAudit,
}) {
  const auditQuestions = useMemo(() => {
    const normalizeQuestion = (question, fallbackId, fallbackText) => ({
      id: String(question?.id || fallbackId),
      category: String(question?.category || 'General').trim() || 'General',
      text: String(question?.text || fallbackText).trim(),
      weight: Math.max(1, Number(question?.weight || 1)),
      critical: Boolean(question?.critical),
      required: Boolean(question?.required),
      evidence: {
        photo: Boolean(question?.evidence?.photo),
        comment: question?.evidence?.comment !== false,
        signature: Boolean(question?.evidence?.signature),
      },
    });

    const catalogTemplate = getCatalogTemplateByInspectionTemplate(template, job?.regime);
    if (Array.isArray(catalogTemplate?.questions) && catalogTemplate.questions.length > 0) {
      const booleanQuestions = catalogTemplate.questions.filter(
        (question) => String(question?.type || '').toLowerCase() === 'boolean'
      );
      if (booleanQuestions.length > 0) {
        return booleanQuestions.map((question, index) =>
          normalizeQuestion(question, `Q-${index + 1}`, `Checklist control ${index + 1}`)
        );
      }
    }

    if (Array.isArray(template?.controls) && template.controls.length > 0) {
      return template.controls.map((control, index) =>
        normalizeQuestion(
          { id: `CTRL-${index + 1}`, text: String(control), weight: 1, critical: false },
          `CTRL-${index + 1}`,
          String(control)
        )
      );
    }

    return getDefaultChecklistControlsByRegime(job?.regime).map((control, index) =>
      normalizeQuestion(
        { id: `AUTO-${index + 1}`, text: String(control), weight: 1, critical: false },
        `AUTO-${index + 1}`,
        String(control)
      )
    );
  }, [template, job?.regime]);

  const [responses, setResponses] = useState({});
  const [notesByQuestionId, setNotesByQuestionId] = useState({});
  const [evidenceByQuestionId, setEvidenceByQuestionId] = useState({});
  const [errorMessage, setErrorMessage] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const workspaceRootRef = useRef(null);
  const scrollContainerRef = useRef(null);
  const questionsPerPage = 10;

  useEffect(() => {
    const nextResponses = {};
    const nextNotes = {};
    const nextEvidence = {};
    auditQuestions.forEach((question) => {
      nextResponses[question.id] = '';
      nextNotes[question.id] = '';
      nextEvidence[question.id] = [];
    });
    setResponses(nextResponses);
    setNotesByQuestionId(nextNotes);
    setEvidenceByQuestionId(nextEvidence);
    setErrorMessage('');
    setCurrentPage(1);
  }, [job?.id, template?.id, auditQuestions]);

  const totalPages = Math.max(1, Math.ceil(auditQuestions.length / questionsPerPage));
  const safeCurrentPage = Math.min(currentPage, totalPages);
  useEffect(() => {
    if (safeCurrentPage !== currentPage) {
      setCurrentPage(safeCurrentPage);
    }
  }, [safeCurrentPage, currentPage]);

  const resetWorkspaceScrollToTop = useCallback(() => {
    if (scrollContainerRef.current) {
      scrollContainerRef.current.scrollTop = 0;
    }
    if (workspaceRootRef.current) {
      workspaceRootRef.current.scrollTop = 0;
    }
  }, []);

  useEffect(() => {
    resetWorkspaceScrollToTop();

    if (typeof window === 'undefined') {
      return undefined;
    }
    const frameId = window.requestAnimationFrame(resetWorkspaceScrollToTop);
    const timeoutId = window.setTimeout(resetWorkspaceScrollToTop, 40);
    return () => {
      window.cancelAnimationFrame(frameId);
      window.clearTimeout(timeoutId);
    };
  }, [job?.id, template?.id, safeCurrentPage, resetWorkspaceScrollToTop]);

  const pageStartIndex = (safeCurrentPage - 1) * questionsPerPage;
  const visibleQuestions = auditQuestions.slice(pageStartIndex, pageStartIndex + questionsPerPage);
  const failedQuestions = auditQuestions.filter((question) => responses[question.id] === 'no');
  const criticalFailedQuestions = failedQuestions.filter((question) => question.critical);
  const missingEvidenceQuestions = failedQuestions.filter((question) => {
    const evidenceList = evidenceByQuestionId[question.id];
    return !Array.isArray(evidenceList) || evidenceList.length === 0;
  });
  const unansweredCount = auditQuestions.filter((question) => !responses[question.id]).length;
  const answeredCount = auditQuestions.length - unansweredCount;
  const completionPercent = auditQuestions.length > 0 ? Math.round((answeredCount / auditQuestions.length) * 100) : 0;
  const evidenceTotal = Object.values(evidenceByQuestionId).reduce((total, files) => total + (files?.length || 0), 0);

  const applicableQuestions = auditQuestions.filter(
    (question) => responses[question.id] === 'yes' || responses[question.id] === 'no'
  );
  const scorePossible = applicableQuestions.reduce((total, question) => total + Number(question.weight || 1), 0);
  const scoreEarned = applicableQuestions.reduce((total, question) => {
    return total + (responses[question.id] === 'yes' ? Number(question.weight || 1) : 0);
  }, 0);
  const scorePercent = scorePossible > 0 ? Math.round((scoreEarned / scorePossible) * 100) : 0;
  const configuredPassPercent =
    Number(template?.passScore) > 0 && Number(template?.maxScore) > 0
      ? Math.round((Number(template.passScore) / Number(template.maxScore)) * 100)
      : 80;
  const effectivePassPercent = Math.max(60, Math.min(95, configuredPassPercent || 80));
  const isPassing = scorePossible > 0 && scorePercent >= effectivePassPercent && criticalFailedQuestions.length === 0;

  const submitCompletion = () => {
    if (unansweredCount > 0) {
      setErrorMessage(`Complete all checklist questions before completion (${unansweredCount} remaining).`);
      return;
    }
    if (missingEvidenceQuestions.length > 0) {
      setErrorMessage(`Attach evidence for all "No" responses before completion (${missingEvidenceQuestions.length} missing).`);
      return;
    }

    failedQuestions.forEach((question) => {
      onRecordFinding?.({
        control: question.text,
        notes: notesByQuestionId[question.id] || '',
        severity: question.critical ? 'high' : 'medium',
      });
    });

    const completionPayload = {
      templateId: String(template?.id || template?.templateId || job?.inspectionTemplateId || ''),
      templateName: String(template?.name || `${job?.regime || 'General'} Audit Template`),
      templateCategory: String(template?.regime || job?.regime || 'HS').toUpperCase(),
      templateVersion: String(template?.version || template?.templateVersion || '1.0'),
      startedAt: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
      completedAt: new Date().toISOString(),
      auditorName: auditor?.name || '',
      answers: auditQuestions.map((question) => ({
        questionId: question.id,
        category: question.category || 'General',
        text: question.text,
        weight: question.weight,
        critical: Boolean(question.critical),
        required: Boolean(question.required),
        response: responses[question.id] || 'na',
        notes: notesByQuestionId[question.id] || '',
        evidenceFiles: evidenceByQuestionId[question.id] || [],
      })),
      summary: {
        answeredCount,
        unansweredCount,
        scoreEarned,
        scorePossible,
        scorePercent,
        effectivePassPercent,
        isPassing,
        failedCount: failedQuestions.length,
        criticalFailedCount: criticalFailedQuestions.length,
        evidenceTotal,
      },
      responsesByQuestionId: responses,
      notesByQuestionId,
      evidenceByQuestionId,
      assetName: job?.assetName || '',
      regime: job?.regime || '',
    };

    const didComplete = onCompleteAudit?.(completionPayload);
    if (didComplete === false) {
      return;
    }
    onClose?.();
  };

  const goToNextPage = () => {
    setErrorMessage('');
    setCurrentPage((previous) => Math.min(totalPages, previous + 1));
  };

  const goToPreviousPage = () => {
    setErrorMessage('');
    setCurrentPage((previous) => Math.max(1, previous - 1));
  };

  const setQuestionResponse = (questionId, value) => {
    setResponses((previous) => ({
      ...previous,
      [questionId]: value,
    }));
    setErrorMessage('');
  };

  const appendEvidenceFiles = (questionId, files) => {
    const selectedFiles = Array.from(files || []);
    if (selectedFiles.length === 0) {
      return;
    }
    const fileNames = selectedFiles.map((file) => file.name);
    setEvidenceByQuestionId((previous) => ({
      ...previous,
      [questionId]: [...(previous[questionId] || []), ...fileNames],
    }));
    onUploadEvidence?.(selectedFiles);
  };

  const canSaveAndClose = unansweredCount === 0;
  const saveAndClose = () => {
    if (!canSaveAndClose) {
      setErrorMessage(`Answer all checklist questions before saving (${unansweredCount} remaining).`);
      return;
    }
    onClose?.();
  };

  return (
    <div
      ref={workspaceRootRef}
      className="w-full rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm"
    >
      <div className="h-[calc(100dvh-12rem)] md:h-[calc(100dvh-10.5rem)] w-full bg-white dark:bg-slate-900 flex flex-col">
        <div className="px-4 md:px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-start justify-between gap-3">
          <div>
            <h3 className="text-xl md:text-2xl font-black text-slate-800 dark:text-white">Audit Template Workspace</h3>
            <p className="text-xs md:text-sm text-slate-500 dark:text-slate-400 mt-1">
              {job.id} â¢ {job.assetName} â¢ {job.regime} â¢ {auditor.name}
            </p>
            <p className="text-xs md:text-sm text-slate-500 dark:text-slate-400 mt-1">
              Template: {template?.name || `${job.regime} default checklist`}
            </p>
          </div>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
            <X className="w-5 h-5 text-slate-500" />
          </button>
        </div>

        <div className="px-4 md:px-6 py-3 border-b border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/40 space-y-3">
          <div className="flex flex-wrap items-center gap-2">
            <span className="text-[11px] font-bold px-2.5 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-900/40 dark:text-cyan-300">
              Page {safeCurrentPage}/{totalPages}
            </span>
            <span className="text-[11px] font-bold px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300">
              Answered {answeredCount}/{auditQuestions.length}
            </span>
            <span className="text-[11px] font-bold px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300">
              Score {scorePercent}% ({scoreEarned}/{Math.max(scorePossible, 1)})
            </span>
            <span className="text-[11px] font-bold px-2.5 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300">
              No responses {failedQuestions.length}
            </span>
            <span className="text-[11px] font-bold px-2.5 py-1 rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300">
              Critical fails {criticalFailedQuestions.length}
            </span>
            <span className="text-[11px] font-bold px-2.5 py-1 rounded-full bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200">
              Evidence files {evidenceTotal}
            </span>
            <span
              className={`text-[11px] font-bold px-2.5 py-1 rounded-full ${
                isPassing
                  ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300'
                  : 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300'
              }`}
            >
              {isPassing ? 'Currently passing' : `Needs ${effectivePassPercent}% + no critical fails`}
            </span>
          </div>
          <div className="h-2 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
            <div
              className="h-full rounded-full bg-cyan-500 transition-all duration-300 ease-out"
              style={{ width: `${Math.max(2, completionPercent)}%` }}
            />
          </div>
        </div>

        <div ref={scrollContainerRef} className="flex-1 overflow-y-auto px-4 md:px-6 py-4 space-y-3">
          {visibleQuestions.map((question, index) => {
            const questionNumber = pageStartIndex + index + 1;
            const response = responses[question.id] || '';
            const evidenceList = evidenceByQuestionId[question.id] || [];
            const requiresEvidence = response === 'no';

            const responseButtonStyles = {
              yes: response === 'yes'
                ? 'bg-emerald-500 text-white shadow'
                : 'bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/20',
              no: response === 'no'
                ? 'bg-rose-500 text-white shadow'
                : 'bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-300 hover:bg-rose-50 dark:hover:bg-rose-900/20',
              na: response === 'na'
                ? 'bg-slate-700 text-white shadow'
                : 'bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800',
            };

            return (
              <article
                key={`${job.id}-${question.id}`}
                className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/35 p-3 md:p-4 space-y-3"
              >
                <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-2">
                  <div>
                    <p className="text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                      Question {questionNumber}
                    </p>
                    <p className="text-sm md:text-base font-semibold text-slate-800 dark:text-slate-100 mt-1">{question.text}</p>
                  </div>
                  <div className="flex flex-wrap items-center gap-2">
                    <span className="text-[11px] font-bold px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300">
                      Weight {question.weight}
                    </span>
                    {question.critical && (
                      <span className="text-[11px] font-bold px-2 py-1 rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300">
                        Critical
                      </span>
                    )}
                  </div>
                </div>

                <div className="inline-flex rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                  <button
                    type="button"
                    onClick={() => setQuestionResponse(question.id, 'yes')}
                    className={`px-4 py-2 text-xs font-bold transition-all duration-200 ${responseButtonStyles.yes}`}
                  >
                    Yes
                  </button>
                  <button
                    type="button"
                    onClick={() => setQuestionResponse(question.id, 'no')}
                    className={`px-4 py-2 text-xs font-bold transition-all duration-200 border-l border-slate-200 dark:border-slate-700 ${responseButtonStyles.no}`}
                  >
                    No
                  </button>
                  <button
                    type="button"
                    onClick={() => setQuestionResponse(question.id, 'na')}
                    className={`px-4 py-2 text-xs font-bold transition-all duration-200 border-l border-slate-200 dark:border-slate-700 ${responseButtonStyles.na}`}
                  >
                    N/A
                  </button>
                </div>

                <textarea
                  value={notesByQuestionId[question.id] || ''}
                  onChange={(event) =>
                    setNotesByQuestionId((previous) => ({
                      ...previous,
                      [question.id]: event.target.value,
                    }))
                  }
                  rows={2}
                  placeholder="Observation notes, defect context, or action recommendation..."
                  className="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-xs md:text-sm"
                />

                <div className="flex flex-wrap items-center gap-2">
                  <label className="px-2.5 py-1.5 rounded-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-[11px] font-bold cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    Upload Evidence
                    <input
                      type="file"
                      multiple
                      className="hidden"
                      onChange={(event) => appendEvidenceFiles(question.id, event.target.files)}
                    />
                  </label>
                  <label className="px-2.5 py-1.5 rounded-lg bg-cyan-50 dark:bg-cyan-900/20 border border-cyan-200 dark:border-cyan-800/40 text-[11px] font-bold cursor-pointer hover:bg-cyan-100 dark:hover:bg-cyan-900/30 transition-colors inline-flex items-center gap-1.5 text-cyan-700 dark:text-cyan-300">
                    <Camera className="w-3.5 h-3.5" />
                    Camera
                    <input
                      type="file"
                      accept="image/*"
                      capture="environment"
                      className="hidden"
                      onChange={(event) => appendEvidenceFiles(question.id, event.target.files)}
                    />
                  </label>
                  {requiresEvidence && (
                    <span
                      className={`text-[11px] font-semibold ${
                        evidenceList.length > 0
                          ? 'text-emerald-700 dark:text-emerald-300'
                          : 'text-rose-600 dark:text-rose-300'
                      }`}
                    >
                      {evidenceList.length > 0 ? 'Evidence attached' : 'Evidence required for "No" response'}
                    </span>
                  )}
                </div>

                {evidenceList.length > 0 && (
                  <p className="text-[11px] text-slate-500 dark:text-slate-400">
                    Files: {evidenceList.join(', ')}
                  </p>
                )}
              </article>
            );
          })}
        </div>

        <div className="px-4 md:px-6 py-4 border-t border-slate-200 dark:border-slate-700 space-y-2">
          {errorMessage && <p className="text-xs font-semibold text-rose-600 dark:text-rose-300">{errorMessage}</p>}
          <div className="flex flex-wrap items-center justify-between gap-2">
            <p className="text-xs text-slate-500 dark:text-slate-400">
              Step-through mode: 10 questions per page. Complete all pages to finish the audit.
            </p>
            <div className="flex flex-wrap gap-2">
              <button
                type="button"
                onClick={saveAndClose}
                disabled={!canSaveAndClose}
                className={`px-4 py-2 rounded-lg text-sm font-bold transition-colors ${
                  canSaveAndClose
                    ? 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200'
                    : 'bg-slate-200 text-slate-500 dark:bg-slate-800 dark:text-slate-500 cursor-not-allowed'
                }`}
              >
                Save & Close
              </button>
              <button
                type="button"
                onClick={goToPreviousPage}
                disabled={safeCurrentPage <= 1}
                className={`px-4 py-2 rounded-lg text-sm font-bold transition-colors ${
                  safeCurrentPage <= 1
                    ? 'bg-slate-200 text-slate-500 dark:bg-slate-800 dark:text-slate-500 cursor-not-allowed'
                    : 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200'
                }`}
              >
                Previous Page
              </button>
              {safeCurrentPage < totalPages ? (
                <button
                  type="button"
                  onClick={goToNextPage}
                  className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white transition-colors"
                >
                  Next Page
                </button>
              ) : (
                <button
                  type="button"
                  onClick={submitCompletion}
                  className="px-4 py-2 rounded-lg text-sm font-bold bg-emerald-600 hover:bg-emerald-700 text-white transition-colors"
                >
                  Complete Audit
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function PricingAdjustmentModal({ job, onClose, onSubmit }) {
  const adjustmentDefaults = {
    scope_up: { amount: 120, reasonCode: 'scope_change_up' },
    scope_down: { amount: -80, reasonCode: 'scope_change_down' },
    service_credit: { amount: -60, reasonCode: 'service_credit' },
    cancellation: { amount: 95, reasonCode: 'cancellation_fee' },
    no_show: { amount: 140, reasonCode: 'no_show_fee' },
  };

  const [type, setType] = useState('scope_up');
  const [amountExVatDelta, setAmountExVatDelta] = useState(adjustmentDefaults.scope_up.amount);
  const [reasonCode, setReasonCode] = useState(adjustmentDefaults.scope_up.reasonCode);
  const [evidenceRef, setEvidenceRef] = useState('');
  const [approvedByUserId, setApprovedByUserId] = useState('ops_manager');

  useEffect(() => {
    const defaults = adjustmentDefaults[type] || adjustmentDefaults.scope_up;
    setAmountExVatDelta(defaults.amount);
    setReasonCode(defaults.reasonCode);
  }, [type]);

  return (
    <div className="fixed inset-0 z-[122] bg-slate-900/45 dark:bg-slate-950/70 backdrop-blur-sm p-4 flex items-center justify-center">
      <div className="w-full max-w-lg rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
        <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <div>
            <h3 className="text-lg font-black text-slate-800 dark:text-white">Apply Pricing Adjustment</h3>
            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
              {job.id} â¢ {job.assetName}
            </p>
          </div>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
            <X className="w-4 h-4 text-slate-500" />
          </button>
        </div>

        <form
          onSubmit={(event) => {
            event.preventDefault();
            onSubmit({
              type,
              reasonCode,
              evidenceRef,
              approvedByUserId,
              amountExVatDelta: Number(amountExVatDelta || 0),
            });
          }}
          className="p-5 space-y-4"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Adjustment Type
              </label>
              <select
                value={type}
                onChange={(event) => setType(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              >
                <option value="scope_up">Scope change up</option>
                <option value="scope_down">Scope change down</option>
                <option value="service_credit">Service credit</option>
                <option value="cancellation">Cancellation fee</option>
                <option value="no_show">No-show fee</option>
              </select>
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Amount Ex VAT
              </label>
              <input
                type="number"
                step="1"
                value={amountExVatDelta}
                onChange={(event) => setAmountExVatDelta(Number(event.target.value || 0))}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Reason Code
              </label>
              <input
                value={reasonCode}
                onChange={(event) => setReasonCode(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Approved By
              </label>
              <input
                value={approvedByUserId}
                onChange={(event) => setApprovedByUserId(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
              Evidence Reference
            </label>
            <input
              value={evidenceRef}
              onChange={(event) => setEvidenceRef(event.target.value)}
              placeholder="job-log://..., chat://..., or document ref"
              className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
            />
          </div>

          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 p-3 text-xs text-slate-600 dark:text-slate-300">
            This creates a new immutable quote version and records an auditable adjustment event.
          </div>

          <div className="pt-2 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-2">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 rounded-lg text-sm font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200"
            >
              Cancel
            </button>
            <button
              type="submit"
              className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white"
            >
              Apply Adjustment
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

function MarketplaceComposerModal({ assets, onClose, onSubmit }) {
  const [assetId, setAssetId] = useState(assets[0]?.id || '');
  const [dueDate, setDueDate] = useState(() => {
    const target = new Date();
    target.setDate(target.getDate() + 7);
    return target.toISOString().slice(0, 10);
  });
  const [scopeTemplate, setScopeTemplate] = useState(MARKETPLACE_SCOPE_TEMPLATES[0].id);
  const [assetCount, setAssetCount] = useState(1);
  const [complexity, setComplexity] = useState('standard');
  const [equipment, setEquipment] = useState('none');
  const [travelKm, setTravelKm] = useState(12);
  const [weekendAccess, setWeekendAccess] = useState(false);
  const [expedite, setExpedite] = useState(false);
  const [notes, setNotes] = useState('');

  const selectedAsset = useMemo(
    () => assets.find((asset) => asset.id === assetId) || assets[0] || null,
    [assets, assetId]
  );

  const estimatedHours = useMemo(
    () => estimateScopeHours(scopeTemplate, assetCount, weekendAccess),
    [scopeTemplate, assetCount, weekendAccess]
  );

  const scope = useMemo(
    () =>
      normalizeMarketplaceScope({
        template: scopeTemplate,
        assetCount,
        estimatedHours,
        complexity,
        equipment,
        travelKm,
        weekendAccess,
        expedite,
      }),
    [scopeTemplate, assetCount, estimatedHours, complexity, equipment, travelKm, weekendAccess, expedite]
  );

  const quote = useMemo(
    () =>
      calculateMarketplaceQuote({
        scope,
        regime: selectedAsset?.regime,
        site: selectedAsset?.site,
      }),
    [scope, selectedAsset]
  );

  const dispatchSlaMins = useMemo(() => resolveDispatchSlaMinutes(scope), [scope]);

  return (
    <div className="fixed inset-0 z-[120] bg-slate-900/40 dark:bg-slate-950/65 backdrop-blur-sm p-4 flex items-center justify-center">
      <div className="w-full max-w-2xl rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
        <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <h3 className="text-lg font-black text-slate-800 dark:text-white">Advertise Audit Job with Scope Builder</h3>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
            <X className="w-4 h-4 text-slate-500" />
          </button>
        </div>
        <form
          onSubmit={(event) => {
            event.preventDefault();
            if (!selectedAsset) {
              return;
            }
            onSubmit({
              assetId: selectedAsset.id,
              dueDate,
              notes,
              scope,
              pricing: quote,
              dispatchSlaMins,
            });
          }}
          className="p-5 space-y-4"
        >
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Asset
              </label>
              <select
                required
                value={assetId}
                onChange={(event) => setAssetId(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              >
                {assets.map((asset) => (
                  <option key={asset.id} value={asset.id}>
                    {asset.id} â¢ {asset.name} ({asset.regime})
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Due Date
              </label>
              <input
                required
                value={dueDate}
                onChange={(event) => setDueDate(event.target.value)}
                type="date"
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Scope Template
              </label>
              <select
                value={scopeTemplate}
                onChange={(event) => setScopeTemplate(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              >
                {MARKETPLACE_SCOPE_TEMPLATES.map((template) => (
                  <option key={template.id} value={template.id}>
                    {template.label}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Asset Count
              </label>
              <input
                type="number"
                min="1"
                max="30"
                value={assetCount}
                onChange={(event) => setAssetCount(Number(event.target.value || 1))}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Estimated Hours
              </label>
              <input
                readOnly
                value={estimatedHours}
                className="w-full rounded-xl px-3 py-2 bg-slate-100 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Access Complexity
              </label>
              <select
                value={complexity}
                onChange={(event) => setComplexity(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              >
                <option value="standard">Standard</option>
                <option value="restricted">Restricted access</option>
                <option value="out_of_hours">Out of hours</option>
              </select>
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Equipment
              </label>
              <select
                value={equipment}
                onChange={(event) => setEquipment(event.target.value)}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              >
                <option value="none">None</option>
                <option value="specialist_instruments">Specialist instruments</option>
                <option value="rope_access">Rope access</option>
                <option value="confined_space">Confined space</option>
              </select>
            </div>
            <div>
              <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                Travel (km)
              </label>
              <input
                type="number"
                min="0"
                max="300"
                value={travelKm}
                onChange={(event) => setTravelKm(Number(event.target.value || 0))}
                className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm"
              />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label className="flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 px-3 py-2 text-sm text-slate-700 dark:text-slate-200">
              <input type="checkbox" checked={weekendAccess} onChange={(event) => setWeekendAccess(event.target.checked)} />
              Weekend access required
            </label>
            <label className="flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 px-3 py-2 text-sm text-slate-700 dark:text-slate-200">
              <input type="checkbox" checked={expedite} onChange={(event) => setExpedite(event.target.checked)} />
              Expedite dispatch SLA
            </label>
          </div>

          <div>
            <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
              Access Notes
            </label>
            <textarea
              value={notes}
              onChange={(event) => setNotes(event.target.value)}
              rows="4"
              placeholder="Any escort requirements, operating hours, or permit constraints..."
              className="w-full rounded-xl px-3 py-2 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm resize-none"
            />
          </div>

          <div className="rounded-xl border border-cyan-200 dark:border-cyan-800/30 bg-cyan-50/70 dark:bg-cyan-900/10 p-4">
            <p className="text-xs font-bold uppercase tracking-wider text-cyan-700 dark:text-cyan-300">Instant Quote</p>
            <div className="mt-2 grid grid-cols-2 gap-2 text-xs">
              <div>
                <p className="text-cyan-700/80 dark:text-cyan-300/80">VAT</p>
                <p className="font-bold text-cyan-700 dark:text-cyan-300">{formatCurrencyGBP(quote.vatAmount)}</p>
              </div>
              <div>
                <p className="text-cyan-700/80 dark:text-cyan-300/80">Total inc VAT</p>
                <p className="font-black text-cyan-700 dark:text-cyan-300">{formatCurrencyGBP(quote.total)}</p>
              </div>
            </div>
            <p className="mt-2 text-xs text-cyan-700/90 dark:text-cyan-300/90">
              Dispatch SLA target: {dispatchSlaMins} minutes from publish. Model {quote.pricingModelVersion}.
            </p>
          </div>

          <div className="pt-3 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-2">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 rounded-lg text-sm font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200"
            >
              Cancel
            </button>
            <button type="submit" className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white">
              Publish Job
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

function JobStatusPill({ status }) {
  const map = {
    open: 'bg-cyan-100 text-cyan-700 border-cyan-200 dark:bg-cyan-500/10 dark:text-cyan-400 dark:border-cyan-500/20',
    offered: 'bg-violet-100 text-violet-700 border-violet-200 dark:bg-violet-500/10 dark:text-violet-400 dark:border-violet-500/20',
    assigned: 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-500/10 dark:text-indigo-400 dark:border-indigo-500/20',
    in_progress: 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-500/10 dark:text-amber-400 dark:border-amber-500/20',
    awaiting_review: 'bg-sky-100 text-sky-700 border-sky-200 dark:bg-sky-500/10 dark:text-sky-400 dark:border-sky-500/20',
    completed: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-500/10 dark:text-emerald-400 dark:border-emerald-500/20',
  };

  return (
    <span className={`px-2.5 py-1 border inline-flex text-[10px] md:text-xs font-bold uppercase tracking-wider rounded-md shadow-sm ${map[status] || map.open}`}>
      {status.replace('_', ' ')}
    </span>
  );
}

function MatchScoreBar({ score }) {
  return (
    <div className="w-full h-2 rounded-full bg-slate-100 dark:bg-slate-700 overflow-hidden">
      <div
        className={`h-full ${
          score >= 85 ? 'bg-emerald-500' : score >= 70 ? 'bg-cyan-500' : score >= 50 ? 'bg-amber-500' : 'bg-rose-500'
        }`}
        style={{ width: `${score}%` }}
      />
    </div>
  );
}

function SparklineChart({ points }) {
  if (!points || points.length === 0) {
    return null;
  }

  const width = 620;
  const height = 180;
  const padding = 12;
  const max = Math.max(...points);
  const min = Math.min(...points);
  const range = Math.max(1, max - min);

  const toCoordinates = (value, index) => {
    const x = padding + (index / (points.length - 1 || 1)) * (width - padding * 2);
    const y = height - padding - ((value - min) / range) * (height - padding * 2);
    return { x, y };
  };

  const coordinates = points.map(toCoordinates);
  const linePath = coordinates
    .map((coordinate, index) => `${index === 0 ? 'M' : 'L'} ${coordinate.x.toFixed(2)} ${coordinate.y.toFixed(2)}`)
    .join(' ');

  const fillPath = `${linePath} L ${width - padding} ${height - padding} L ${padding} ${height - padding} Z`;

  return (
    <div className="rounded-xl border border-cyan-100 dark:border-cyan-900/40 bg-gradient-to-br from-cyan-50/70 to-emerald-50/70 dark:from-slate-900 dark:to-slate-900 p-4">
      <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-36">
        <defs>
          <linearGradient id="sparklineStroke" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor="#06b6d4" />
            <stop offset="100%" stopColor="#10b981" />
          </linearGradient>
          <linearGradient id="sparklineFill" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stopColor="rgba(6, 182, 212, 0.22)" />
            <stop offset="100%" stopColor="rgba(16, 185, 129, 0.02)" />
          </linearGradient>
        </defs>
        <path d={fillPath} fill="url(#sparklineFill)" />
        <path d={linePath} fill="none" stroke="url(#sparklineStroke)" strokeWidth="3" strokeLinecap="round" />
        {coordinates.map((coordinate, index) => (
          <circle key={index} cx={coordinate.x} cy={coordinate.y} r={3.8} fill={index === coordinates.length - 1 ? '#10b981' : '#06b6d4'} />
        ))}
      </svg>
      <div className="flex items-center justify-between mt-2 text-xs text-slate-500 dark:text-slate-400">
        <span>12 months ago</span>
        <span className="font-semibold text-slate-700 dark:text-slate-200">Current cycle</span>
      </div>
    </div>
  );
}

function UrgentAssetItem({ asset }) {
  return (
    <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 p-3 hover-lift">
      <div className="flex items-start justify-between gap-3">
        <div>
          <p className="text-sm font-bold text-slate-800 dark:text-white">{asset.name}</p>
          <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">
            {asset.id} â¢ {asset.site}
          </p>
        </div>
        <StatusPill status={asset.status} />
      </div>
      <div className="mt-2 text-xs text-slate-600 dark:text-slate-300 flex items-center justify-between">
        <span>{formatDateLabel(asset.nextDue)}</span>
        <span className="font-semibold">{formatRelativeDueLabel(asset.nextDue)}</span>
      </div>
    </div>
  );
}

function PaginationControls({ currentPage, totalPages, onPrevious, onNext }) {
  if (totalPages <= 1) {
    return null;
  }

  return (
    <div className="flex items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-white/85 dark:bg-slate-800/85 px-4 py-3">
      <button
        onClick={onPrevious}
        disabled={currentPage <= 1}
        className="px-3 py-1.5 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Previous
      </button>
      <span className="text-xs text-slate-500 dark:text-slate-400">
        Page {currentPage} of {totalPages}
      </span>
      <button
        onClick={onNext}
        disabled={currentPage >= totalPages}
        className="px-3 py-1.5 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Next
      </button>
    </div>
  );
}

function UploadDropZone({ onFilesSelected }) {
  const [isDragging, setIsDragging] = useState(false);
  const inputRef = useRef(null);

  const emitFiles = (fileList) => {
    const files = Array.from(fileList || []);
    if (files.length === 0) {
      return;
    }
    onFilesSelected(files);
  };

  return (
    <div
      onDragOver={(event) => {
        event.preventDefault();
        setIsDragging(true);
      }}
      onDragLeave={() => setIsDragging(false)}
      onDrop={(event) => {
        event.preventDefault();
        setIsDragging(false);
        emitFiles(event.dataTransfer.files);
      }}
      className={`rounded-xl border-2 border-dashed p-4 transition-colors ${
        isDragging
          ? 'border-cyan-500 bg-cyan-50 dark:bg-cyan-900/10'
          : 'border-slate-300 dark:border-slate-600 bg-slate-50/70 dark:bg-slate-900/20'
      }`}
    >
      <input
        ref={inputRef}
        type="file"
        multiple
        accept=".pdf"
        className="hidden"
        onChange={(event) => emitFiles(event.target.files)}
      />
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
        <div className="flex items-start gap-3">
          <UploadCloud className="w-5 h-5 text-cyan-600 dark:text-cyan-400 mt-0.5" />
          <div>
            <p className="text-sm font-bold text-slate-800 dark:text-white">Drop provider certificates here</p>
            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
              PDFs are queued for parsing and metadata extraction.
            </p>
          </div>
        </div>
        <button
          onClick={() => inputRef.current?.click()}
          className="px-3 py-2 rounded-lg text-sm font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700"
        >
          Browse Files
        </button>
      </div>
    </div>
  );
}

function CoverageMap({ providers, selectedProviderId, onSelect }) {
  const pinPositions = [
    { left: '20%', top: '30%' },
    { left: '48%', top: '45%' },
    { left: '72%', top: '24%' },
    { left: '60%', top: '68%' },
    { left: '34%', top: '62%' },
    { left: '80%', top: '54%' },
  ];

  return (
    <div className="relative h-64 rounded-xl border border-slate-200 dark:border-slate-700 bg-gradient-to-br from-slate-100 to-cyan-50 dark:from-slate-900 dark:to-slate-900 overflow-hidden">
      <div className="absolute inset-0 opacity-40 dark:opacity-20">
        <div className="absolute inset-y-0 left-1/4 w-px bg-slate-300 dark:bg-slate-700" />
        <div className="absolute inset-y-0 left-1/2 w-px bg-slate-300 dark:bg-slate-700" />
        <div className="absolute inset-y-0 left-3/4 w-px bg-slate-300 dark:bg-slate-700" />
        <div className="absolute inset-x-0 top-1/3 h-px bg-slate-300 dark:bg-slate-700" />
        <div className="absolute inset-x-0 top-2/3 h-px bg-slate-300 dark:bg-slate-700" />
      </div>
      <div className="absolute top-3 left-3 inline-flex items-center gap-1 text-xs font-semibold text-slate-600 dark:text-slate-300 bg-white/80 dark:bg-slate-800/80 px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700">
        <LocateFixed className="w-3.5 h-3.5 text-cyan-500" />
        Live dispatch coverage
      </div>

      {providers.map((provider, index) => {
        const position = pinPositions[index % pinPositions.length];
        const isSelected = provider.id === selectedProviderId;
        return (
          <button
            key={provider.id}
            onClick={() => onSelect(provider.id)}
            className={`absolute -translate-x-1/2 -translate-y-1/2 transition-all ${
              isSelected ? 'scale-110 z-20' : 'hover:scale-105 z-10'
            }`}
            style={{ left: position.left, top: position.top }}
            title={provider.name}
          >
            <div className={`w-10 h-10 rounded-full border-2 flex items-center justify-center text-xs font-black ${
              isSelected
                ? 'bg-cyan-600 border-cyan-200 text-white shadow-lg'
                : 'bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200'
            }`}>
              {provider.name.charAt(0)}
            </div>
            {isSelected && <span className="absolute -inset-1 rounded-full border border-cyan-400/50 pulse-soft" />}
          </button>
        );
      })}
    </div>
  );
}

function CommandPalette({ isOpen, onClose, onAction }) {
  const [query, setQuery] = useState('');
  const inputRef = useRef(null);

  useEffect(() => {
    if (!isOpen) {
      setQuery('');
      return;
    }
    const timeoutId = setTimeout(() => inputRef.current?.focus(), 10);
    return () => clearTimeout(timeoutId);
  }, [isOpen]);

  const actions = useMemo(
    () => [
      { id: 'go-dashboard', label: 'Go to Dashboard', description: 'View estate compliance overview', icon: LayoutDashboard },
      { id: 'go-onboarding', label: 'Open Onboarding Portal', description: 'View persona onboarding journeys', icon: Building2 },
      { id: 'go-assets', label: 'Open Asset Register', description: 'Inspect assets, due dates, and status', icon: Box },
      { id: 'go-vault', label: 'Open Evidence Vault', description: 'Inspect and verify certificates', icon: Lock },
      { id: 'go-providers', label: 'Open Provider Network', description: 'Find and dispatch providers', icon: Users },
      { id: 'go-marketplace', label: 'Open Audit Marketplace', description: 'Advertise and match audit jobs', icon: ClipboardList },
      { id: 'go-accountancy', label: 'Open Accountancy', description: 'Run invoicing, collections, and payouts', icon: BarChart3 },
      { id: 'go-ops', label: 'Open Operations Console', description: 'Run readiness workflows for items 2-15', icon: ServerCog },
      { id: 'go-templates', label: 'Open Template Studio', description: 'Edit and publish template question banks', icon: FileSignature },
      { id: 'go-help', label: 'Open Help Center', description: 'View product guides and placeholders', icon: FileText },
      { id: 'new-asset', label: 'Add New Asset', description: 'Create an asset in the register', icon: Plus },
      { id: 'request-inspection', label: 'Request Inspection', description: 'Open dispatch flow', icon: Calendar },
      { id: 'new-programme', label: 'Create Recurring Programme', description: 'Schedule recurring audits and inspections', icon: History },
      { id: 'scan-lookup', label: 'Scan QR / Lookup', description: 'Open asset or certificate from a QR value', icon: ScanLine },
      { id: 'post-audit-job', label: 'Post Audit Job', description: 'Create a new marketplace listing', icon: Sparkles },
      { id: 'open-ops-console', label: 'Run Ops Readiness', description: 'Open InCert operations readiness panel', icon: Gauge },
      { id: 'export-audit', label: 'Export Audit Pack', description: 'Generate current compliance export', icon: Download },
      { id: 'copy-audit-link', label: 'Copy Audit Link', description: 'Create secure read-only access', icon: Share2 },
    ],
    []
  );

  const filteredActions = actions.filter((action) => {
    const term = query.trim().toLowerCase();
    if (!term) {
      return true;
    }
    return (
      action.label.toLowerCase().includes(term) ||
      action.description.toLowerCase().includes(term)
    );
  });

  if (!isOpen) {
    return null;
  }

  return (
    <div className="fixed inset-0 z-[120] bg-slate-900/40 dark:bg-slate-950/60 backdrop-blur-sm p-4" onClick={onClose}>
      <div
        className="max-w-2xl mx-auto mt-8 md:mt-16 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-800/95 shadow-2xl overflow-hidden float-in"
        onClick={(event) => event.stopPropagation()}
      >
        <div className="px-4 md:px-5 py-4 border-b border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-2">
            <Command className="w-5 h-5 text-cyan-500" />
            <input
              ref={inputRef}
              value={query}
              onChange={(event) => setQuery(event.target.value)}
              placeholder="Search actions..."
              className="w-full bg-transparent outline-none text-slate-800 dark:text-slate-100 placeholder:text-slate-400"
            />
            <button onClick={onClose} className="text-xs font-bold px-2 py-1 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300">
              ESC
            </button>
          </div>
        </div>
        <div className="max-h-[60vh] overflow-y-auto p-2">
          {filteredActions.length === 0 ? (
            <div className="px-3 py-6 text-sm text-slate-500 dark:text-slate-400 text-center">
              No matching action for "{query}".
            </div>
          ) : (
            filteredActions.map((action) => {
              const Icon = action.icon;
              return (
                <button
                  key={action.id}
                  onClick={() => onAction(action.id)}
                  className="w-full text-left rounded-xl px-3 py-3 hover:bg-slate-100 dark:hover:bg-slate-700/70 transition-colors flex items-center justify-between gap-3"
                >
                  <div className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-lg bg-cyan-50 dark:bg-cyan-900/25 text-cyan-600 dark:text-cyan-400 flex items-center justify-center shrink-0">
                      <Icon className="w-4 h-4" />
                    </div>
                    <div>
                      <p className="text-sm font-bold text-slate-800 dark:text-white">{action.label}</p>
                      <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{action.description}</p>
                    </div>
                  </div>
                  <ArrowUpRight className="w-4 h-4 text-slate-400" />
                </button>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}

function useQrDataUrl(value, size = 640) {
  const [qrDataUrl, setQrDataUrl] = useState('');

  useEffect(() => {
    if (!value) {
      setQrDataUrl('');
      return;
    }

    let isCancelled = false;
    QRCode.toDataURL(value, {
      width: size,
      margin: 1,
      errorCorrectionLevel: 'H',
      color: {
        dark: '#0f172a',
        light: '#ffffff',
      },
    })
      .then((dataUrl) => {
        if (!isCancelled) {
          setQrDataUrl(dataUrl);
        }
      })
      .catch(() => {
        if (!isCancelled) {
          setQrDataUrl('');
        }
      });

    return () => {
      isCancelled = true;
    };
  }, [value, size]);

  return qrDataUrl;
}

function QrCodePreview({ value, size = 220, withLogo = true }) {
  const qrDataUrl = useQrDataUrl(value, size * 3);

  return (
    <div
      className="relative rounded-2xl border border-slate-200 bg-white p-3 shadow-sm"
      style={{ width: size, height: size }}
    >
      {qrDataUrl ? (
        <img src={qrDataUrl} alt="InCert QR code" className="w-full h-full rounded-xl" />
      ) : (
        <div className="w-full h-full rounded-xl bg-slate-100 flex items-center justify-center">
          <Loader2 className="w-5 h-5 animate-spin text-slate-400" />
        </div>
      )}
      {withLogo && (
        <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
          <div className="w-12 h-12 rounded-xl bg-white/95 border border-slate-200 shadow-sm flex items-center justify-center text-[8px] font-black tracking-wide text-slate-700 text-center leading-tight px-1">
            InCert
            <br />
            LOGO
          </div>
        </div>
      )}
    </div>
  );
}

function ScanLookupModal({ isOpen, onClose, onResolve }) {
  const [inputValue, setInputValue] = useState('');
  const [cameraStatus, setCameraStatus] = useState('idle');
  const [cameraMessage, setCameraMessage] = useState('');
  const [lastDetection, setLastDetection] = useState('');
  const inputRef = useRef(null);
  const videoRef = useRef(null);
  const streamRef = useRef(null);
  const detectorRef = useRef(null);
  const animationFrameRef = useRef(0);
  const lastDetectAtRef = useRef(0);
  const isOpenRef = useRef(isOpen);

  const stopCamera = useCallback((nextStatus = 'idle') => {
    if (animationFrameRef.current) {
      window.cancelAnimationFrame(animationFrameRef.current);
      animationFrameRef.current = 0;
    }

    if (streamRef.current) {
      streamRef.current.getTracks().forEach((track) => track.stop());
      streamRef.current = null;
    }

    if (videoRef.current) {
      videoRef.current.srcObject = null;
    }

    detectorRef.current = null;
    setCameraStatus(nextStatus);
  }, []);

  const startCameraScan = useCallback(async () => {
    if (typeof window === 'undefined') {
      setCameraStatus('unsupported');
      setCameraMessage('Camera scanning is unavailable in this environment.');
      return;
    }

    if (!window.navigator?.mediaDevices?.getUserMedia) {
      setCameraStatus('unsupported');
      setCameraMessage('Camera access is not available in this browser/device.');
      return;
    }

    if (typeof window.BarcodeDetector !== 'function') {
      setCameraStatus('unsupported');
      setCameraMessage('BarcodeDetector is not supported. Use manual paste or Chrome/Edge.');
      return;
    }

    try {
      stopCamera('starting');
      setCameraMessage('');
      setLastDetection('');

      const preferredFormats = [
        'qr_code',
        'code_128',
        'code_39',
        'ean_13',
        'ean_8',
        'upc_a',
        'upc_e',
        'data_matrix',
        'pdf417',
        'aztec',
      ];

      const supportedFormats = typeof window.BarcodeDetector.getSupportedFormats === 'function'
        ? await window.BarcodeDetector.getSupportedFormats().catch(() => [])
        : [];
      const detectorFormats =
        supportedFormats.length > 0
          ? preferredFormats.filter((format) => supportedFormats.includes(format))
          : preferredFormats;

      detectorRef.current = new window.BarcodeDetector(
        detectorFormats.length > 0 ? { formats: detectorFormats } : undefined
      );

      const stream = await window.navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1280 },
          height: { ideal: 720 },
        },
        audio: false,
      });

      streamRef.current = stream;

      if (!videoRef.current) {
        stopCamera('error');
        setCameraMessage('Unable to start camera preview.');
        return;
      }

      videoRef.current.srcObject = stream;
      await videoRef.current.play();
      setCameraStatus('active');

      const scanFrame = async () => {
        if (!isOpenRef.current || !videoRef.current || !detectorRef.current) {
          return;
        }

        const video = videoRef.current;

        if (video.readyState >= 2) {
          const now = window.performance.now();
          if (now - lastDetectAtRef.current >= 250) {
            lastDetectAtRef.current = now;
            try {
              const detections = await detectorRef.current.detect(video);
              if (Array.isArray(detections) && detections.length > 0) {
                const detectedValue = detections.map(extractBarcodeRawValue).find((value) => value);
                if (detectedValue) {
                  setInputValue(detectedValue);
                  setLastDetection(detectedValue);
                  const didResolve = onResolve(detectedValue);
                  if (didResolve) {
                    stopCamera('idle');
                    return;
                  }
                  setCameraMessage('Code detected but no matching asset/certificate was found.');
                }
              }
            } catch {
              stopCamera('error');
              setCameraMessage('Live scan failed. Check camera permissions and retry.');
              return;
            }
          }
        }

        animationFrameRef.current = window.requestAnimationFrame(scanFrame);
      };

      animationFrameRef.current = window.requestAnimationFrame(scanFrame);
    } catch (error) {
      const errorName = error && typeof error === 'object' ? error.name : '';
      if (errorName === 'NotAllowedError') {
        setCameraMessage('Camera permission denied. Enable permission and retry.');
      } else if (errorName === 'NotFoundError') {
        setCameraMessage('No camera detected on this device.');
      } else {
        setCameraMessage('Unable to start camera scanning.');
      }
      stopCamera('error');
    }
  }, [onResolve, stopCamera]);

  useEffect(() => {
    isOpenRef.current = isOpen;

    if (!isOpen) {
      stopCamera('idle');
      setInputValue('');
      setLastDetection('');
      setCameraMessage('');
      return;
    }
    const timeoutId = setTimeout(() => inputRef.current?.focus(), 20);
    return () => {
      clearTimeout(timeoutId);
      stopCamera('idle');
    };
  }, [isOpen, stopCamera]);

  const toggleCameraScan = () => {
    if (cameraStatus === 'active' || cameraStatus === 'starting') {
      stopCamera('idle');
      return;
    }
    startCameraScan();
  };

  if (!isOpen) {
    return null;
  }

  return (
    <div className="fixed inset-0 z-[125] bg-slate-900/45 dark:bg-slate-950/70 backdrop-blur-sm p-4 flex items-center justify-center">
      <div className="w-full max-w-lg rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
        <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <h3 className="text-lg font-black text-slate-800 dark:text-white flex items-center gap-2">
            <ScanLine className="w-5 h-5 text-cyan-500" />
            Scan / Lookup
          </h3>
          <button
            onClick={() => {
              stopCamera('idle');
              onClose();
            }}
            className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"
          >
            <X className="w-4 h-4 text-slate-500" />
          </button>
        </div>

        <form
          onSubmit={(event) => {
            event.preventDefault();
            onResolve(inputValue);
          }}
          className="p-5 space-y-4"
        >
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40 p-3 space-y-3">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div>
                <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                  Live Camera Scan
                </p>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  Use the camera to scan a QR/barcode without manual paste.
                </p>
              </div>
              <button
                type="button"
                onClick={toggleCameraScan}
                className={`px-3 py-2 rounded-lg text-xs font-bold border inline-flex items-center gap-1 ${
                  cameraStatus === 'active' || cameraStatus === 'starting'
                    ? 'bg-rose-50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-800/40 text-rose-700 dark:text-rose-300'
                    : 'bg-cyan-50 dark:bg-cyan-900/20 border-cyan-200 dark:border-cyan-800/40 text-cyan-700 dark:text-cyan-300'
                }`}
              >
                {cameraStatus === 'active' || cameraStatus === 'starting' ? (
                  <>
                    <CameraOff className="w-3.5 h-3.5" />
                    Stop Camera
                  </>
                ) : (
                  <>
                    <Camera className="w-3.5 h-3.5" />
                    Start Camera
                  </>
                )}
              </button>
            </div>

            <div className="rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-slate-900">
              {cameraStatus === 'active' || cameraStatus === 'starting' ? (
                <video
                  ref={videoRef}
                  autoPlay
                  muted
                  playsInline
                  className="w-full h-44 object-cover"
                />
              ) : (
                <div className="h-44 flex flex-col items-center justify-center gap-2 text-slate-300">
                  {cameraStatus === 'unsupported' ? (
                    <CameraOff className="w-6 h-6" />
                  ) : cameraStatus === 'error' ? (
                    <AlertTriangle className="w-6 h-6 text-amber-300" />
                  ) : (
                    <Camera className="w-6 h-6" />
                  )}
                  <p className="text-xs text-center px-4">
                    {cameraStatus === 'starting'
                      ? 'Starting camera...'
                      : 'Camera preview appears here when scanning starts.'}
                  </p>
                </div>
              )}
            </div>

            {(cameraMessage || lastDetection) && (
              <div className="space-y-1">
                {cameraMessage && (
                  <p className="text-xs text-slate-600 dark:text-slate-300">{cameraMessage}</p>
                )}
                {lastDetection && (
                  <p className="text-xs font-mono text-cyan-700 dark:text-cyan-300 break-all">
                    Last detection: {lastDetection}
                  </p>
                )}
              </div>
            )}
          </div>

          <div>
            <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">
              Paste scanned QR value
            </label>
            <input
              ref={inputRef}
              value={inputValue}
              onChange={(event) => setInputValue(event.target.value)}
              placeholder="AST-001, CERT-2026-1031, or https://...#asset=AST-001"
              className="w-full rounded-xl px-3 py-2.5 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-sm outline-none focus:ring-2 focus:ring-cyan-500"
            />
          </div>
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40 p-3">
            <p className="text-xs font-semibold text-slate-600 dark:text-slate-300">Supported formats</p>
            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
              `AST-xxx`, `CERT-yyyy-nnnn`, or InCert deep links generated from asset labels/certificates.
            </p>
          </div>
          <div className="pt-3 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-2">
            <button
              type="button"
              onClick={() => {
                stopCamera('idle');
                onClose();
              }}
              className="px-4 py-2 rounded-lg text-sm font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200"
            >
              Cancel
            </button>
            <button type="submit" className="px-4 py-2 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white">
              Open Record
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

function AssetQrLabelModal({ asset, latestCertificate, certificateCount, onClose, onNotify }) {
  const assetLink = buildAssetDeepLink(asset.id);
  const qrDataUrl = useQrDataUrl(assetLink, 900);
  const latestCertificateLink = latestCertificate ? buildCertificateDeepLink(latestCertificate.id) : '';

  const copyValue = async (value, successMessage) => {
    const didCopy = await navigator.clipboard
      .writeText(value)
      .then(() => true)
      .catch(() => false);

    if (didCopy) {
      onNotify(successMessage, 'success');
      return;
    }

    window.prompt('Copy value', value);
  };

  const printLabel = () => {
    if (!qrDataUrl) {
      onNotify('QR code is still generating. Try again in a second.', 'info');
      return;
    }

    const printWindow = window.open('', '_blank', 'width=820,height=980');
    if (!printWindow) {
      onNotify('Unable to open print window. Allow popups and try again.', 'info');
      return;
    }

    const certificateLine = latestCertificate
      ? `${escapeHtml(latestCertificate.id)} â¢ exp ${escapeHtml(formatDateLabel(latestCertificate.expiryDate))}`
      : 'No certificate yet';

    printWindow.document.write(`
      <!doctype html>
      <html>
        <head>
          <meta charset="utf-8" />
          <title>InCert Asset Label</title>
          <style>
            body { margin: 0; font-family: Arial, sans-serif; background: #e2e8f0; padding: 28px; }
            .label { width: 360px; border-radius: 16px; border: 1px solid #cbd5e1; background: white; padding: 18px; }
            .brand { font-weight: 800; color: #0f172a; letter-spacing: 0.04em; font-size: 18px; }
            .meta { margin-top: 8px; font-size: 12px; color: #475569; line-height: 1.4; }
            .qr-wrap { margin-top: 14px; position: relative; width: 100%; max-width: 320px; }
            .qr-wrap img { width: 100%; height: auto; display: block; border-radius: 12px; }
            .logo { position: absolute; inset: 0; display: grid; place-items: center; pointer-events: none; }
            .logo-box { background: rgba(255,255,255,0.95); border: 1px solid #cbd5e1; border-radius: 10px; width: 56px; height: 56px; display: grid; place-items: center; }
            .logo-box img { width: 48px; height: auto; object-fit: contain; }
            .small { margin-top: 8px; font-size: 10px; color: #64748b; word-break: break-all; }
          </style>
        </head>
        <body>
          <div class="label">
            <div class="brand">InCert ASSET TAG</div>
            <div class="meta">
              <div><strong>${escapeHtml(asset.id)}</strong> â¢ ${escapeHtml(asset.name)}</div>
              <div>${escapeHtml(asset.site)} â¢ ${escapeHtml(asset.regime)}</div>
              <div>Latest cert: ${certificateLine}</div>
            </div>
            <div class="qr-wrap">
              <img src="${qrDataUrl}" alt="QR" />
              <div class="logo"><div class="logo-box"><img src="/icons/incert-shield.png" alt="InCert" /></div></div>
            </div>
            <div class="small">${escapeHtml(assetLink)}</div>
          </div>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 120);
  };

  return (
    <div className="fixed inset-0 z-[125] bg-slate-900/45 dark:bg-slate-950/70 backdrop-blur-sm p-4 flex items-center justify-center">
      <div className="w-full max-w-3xl rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-2xl overflow-hidden">
        <div className="px-5 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <h3 className="text-lg font-black text-slate-800 dark:text-white flex items-center gap-2">
            <QrCode className="w-5 h-5 text-cyan-500" />
            Printable Asset QR Label
          </h3>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
            <X className="w-4 h-4 text-slate-500" />
          </button>
        </div>

        <div className="p-5 md:p-6 grid grid-cols-1 md:grid-cols-[1.1fr_0.9fr] gap-6">
          <div className="space-y-4">
            <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40 p-4">
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">Asset</p>
              <p className="text-lg font-black text-slate-800 dark:text-white mt-1">{asset.name}</p>
              <p className="text-sm text-slate-600 dark:text-slate-300 mt-1 font-mono">{asset.id}</p>
              <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                {asset.site} â¢ {asset.regime} â¢ Next due {formatDateLabel(asset.nextDue)}
              </p>
            </div>

            <div className="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40 p-4 space-y-2">
              <p className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                Audit trail
              </p>
              <p className="text-sm text-slate-700 dark:text-slate-200">
                {certificateCount} certificate(s) linked to this asset.
              </p>
              {latestCertificate ? (
                <p className="text-xs text-slate-500 dark:text-slate-400">
                  Latest: {latestCertificate.id} â¢ Expires {formatDateLabel(latestCertificate.expiryDate)}
                </p>
              ) : (
                <p className="text-xs text-slate-500 dark:text-slate-400">No certificate issued yet.</p>
              )}
            </div>

            <div className="space-y-2">
              <button
                onClick={() => copyValue(assetLink, 'Asset deep link copied')}
                className="w-full px-3 py-2.5 rounded-lg text-sm font-bold bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 flex items-center justify-center gap-2"
              >
                <Copy className="w-4 h-4" />
                Copy Asset Link
              </button>
              {latestCertificate && (
                <button
                  onClick={() => copyValue(latestCertificateLink, 'Certificate link copied')}
                  className="w-full px-3 py-2.5 rounded-lg text-sm font-bold bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 flex items-center justify-center gap-2"
                >
                  <FileSignature className="w-4 h-4" />
                  Copy Latest Certificate Link
                </button>
              )}
            </div>
          </div>

          <div className="rounded-2xl border border-cyan-100 dark:border-cyan-800/30 bg-cyan-50/60 dark:bg-cyan-900/10 p-4 flex flex-col items-center">
            <QrCodePreview value={assetLink} size={252} />
            <p className="text-[11px] text-cyan-700 dark:text-cyan-300 mt-3 text-center font-semibold">
              Scan to open this asset and previous audits
            </p>
            <p className="text-[10px] text-cyan-700/80 dark:text-cyan-300/80 mt-2 break-all text-center">
              {assetLink}
            </p>

            <div className="w-full grid grid-cols-1 gap-2 mt-4">
              <a
                href={qrDataUrl || '#'}
                download={`incert-${asset.id}-qr.png`}
                className="w-full px-3 py-2.5 rounded-lg text-sm font-bold bg-white border border-slate-200 text-slate-700 flex items-center justify-center gap-2"
              >
                <Download className="w-4 h-4" />
                Download PNG
              </a>
              <button
                onClick={printLabel}
                className="w-full px-3 py-2.5 rounded-lg text-sm font-bold bg-cyan-600 hover:bg-cyan-700 text-white flex items-center justify-center gap-2"
              >
                <Printer className="w-4 h-4" />
                Print Label
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function CertificateDocumentCard({ certificate, isVerified }) {
  const certificateLink = buildCertificateDeepLink(certificate.id);

  return (
    <div className="rounded-2xl border border-slate-200 bg-white p-4 md:p-5 shadow-sm text-slate-900 relative overflow-hidden">
      <svg className="absolute inset-0 pointer-events-none" viewBox="0 0 100 100" preserveAspectRatio="none">
        <rect x="1.4" y="1.4" width="97.2" height="97.2" rx="2.8" fill="none" stroke="#06b6d4" strokeWidth="1" />
        <rect x="3.2" y="3.2" width="93.6" height="93.6" rx="2.4" fill="none" stroke="#94a3b8" strokeDasharray="1 1.6" strokeWidth="0.4" />
      </svg>

      <div className="relative z-10 space-y-4">
        <div className="flex items-start justify-between gap-3">
          <div>
            <p className="text-[11px] font-black tracking-[0.25em] text-cyan-700">INCERT CERTIFICATE</p>
            <h4 className="text-xl font-black text-slate-900 mt-1">{certificate.assetName}</h4>
            <p className="text-xs text-slate-600 mt-1 font-mono">{certificate.id}</p>
          </div>
          <div className="text-right">
            <p className="text-[10px] uppercase tracking-wider text-slate-500 font-bold">Status</p>
            <p className={`text-xs font-black mt-1 ${certificate.status === 'valid' ? 'text-emerald-600' : 'text-rose-600'}`}>
              {certificate.status.toUpperCase()}
            </p>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-3 text-xs">
          <div>
            <p className="font-bold text-slate-500 uppercase tracking-wide">Asset ID</p>
            <p className="font-semibold text-slate-800 mt-1">{certificate.assetId}</p>
          </div>
          <div>
            <p className="font-bold text-slate-500 uppercase tracking-wide">Regime</p>
            <p className="font-semibold text-slate-800 mt-1">{certificate.regime}</p>
          </div>
          <div>
            <p className="font-bold text-slate-500 uppercase tracking-wide">Issue Date</p>
            <p className="font-semibold text-slate-800 mt-1">{formatDateLabel(certificate.issueDate)}</p>
          </div>
          <div>
            <p className="font-bold text-slate-500 uppercase tracking-wide">Expiry Date</p>
            <p className="font-semibold text-slate-800 mt-1">{formatDateLabel(certificate.expiryDate)}</p>
          </div>
          <div className="col-span-2">
            <p className="font-bold text-slate-500 uppercase tracking-wide">Issued By</p>
            <p className="font-semibold text-slate-800 mt-1">{certificate.provider}</p>
          </div>
          <div className="col-span-2">
            <p className="font-bold text-slate-500 uppercase tracking-wide">SHA-256 Fingerprint</p>
            <p className="font-mono text-[11px] text-slate-700 mt-1 break-all">{certificate.hash}</p>
          </div>
        </div>

        <div className="grid grid-cols-[1fr_auto] gap-3 items-end">
          <div>
            <p className="text-[10px] uppercase tracking-wider text-slate-500 font-bold">Verification URL</p>
            <p className="text-[10px] text-slate-600 break-all mt-1">{certificateLink}</p>
            <p className="text-[10px] text-slate-500 mt-1">
              {isVerified ? 'Verified by InCert cryptographic check' : 'Pending cryptographic verification'}
            </p>
          </div>
          <QrCodePreview value={certificateLink} size={94} withLogo={false} />
        </div>
      </div>
    </div>
  );
}

// --- UTILS & MICRO COMPONENTS ---

function GlassStatCard({ title, value, icon, color, bgClass = '' }) {
  return (
    <div className="glass-panel bg-white/80 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700 rounded-2xl p-4 md:p-6 shadow-sm transition-colors duration-300 h-full flex flex-col justify-center">
      <div className="flex justify-between items-start mb-3 md:mb-4">
        <div className={`p-2.5 md:p-3 rounded-xl border border-transparent dark:border-white/5 ${bgClass} ${color}`}>
          {React.cloneElement(icon, { className: 'w-5 h-5 md:w-6 md:h-6' })}
        </div>
      </div>
      <div>
        <p className="text-xs md:text-sm text-slate-500 dark:text-slate-400 font-bold mb-1">{title}</p>
        <h3 className="text-2xl md:text-4xl font-black text-slate-800 dark:text-white tracking-tight">{value}</h3>
      </div>
    </div>
  );
}

function AnimatedProgressBar({ name, compliant, total, color }) {
  const percentage = total > 0 ? Math.round((compliant / total) * 100) : 0;
  return (
    <div>
      <div className="flex justify-between text-xs md:text-sm mb-2">
        <span className="font-bold text-slate-700 dark:text-slate-300">{name}</span>
        <span className="text-slate-500 dark:text-slate-400 font-mono">
          {compliant}/{total}
        </span>
      </div>
      <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-3 border border-slate-200 dark:border-slate-600 overflow-hidden relative">
        <div className={`h-full rounded-full ${color} relative overflow-hidden`} style={{ width: `${percentage}%`, transition: 'width 1s ease-out' }} />
      </div>
    </div>
  );
}

function GlassActionButton({ icon, label, primary, badge, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`w-full flex justify-between items-center p-3.5 rounded-xl transition-colors font-bold text-sm border shadow-sm ${
        primary
          ? 'bg-cyan-600 hover:bg-cyan-700 text-white border-transparent'
          : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'
      }`}
    >
      <div className="flex items-center space-x-3">
        {React.cloneElement(icon, {
          className: `w-5 h-5 ${primary ? 'text-white/90' : 'text-slate-400 dark:text-slate-500'}`,
        })}
        <span>{label}</span>
      </div>
      {badge && <span className="bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">{badge}</span>}
    </button>
  );
}

function StatusPill({ status, text }) {
  const isCompliant = status === 'compliant';
  const isWarning = status === 'warning';

  const colors = isCompliant
    ? 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-500/10 dark:text-emerald-400 dark:border-emerald-500/20'
    : isWarning
      ? 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-500/10 dark:text-amber-400 dark:border-amber-500/20'
      : 'bg-rose-100 text-rose-700 border-rose-200 dark:bg-rose-500/10 dark:text-rose-400 dark:border-rose-500/20';

  return (
    <span className={`px-2.5 py-1 border inline-flex text-[10px] md:text-xs font-bold uppercase tracking-wider rounded-md shadow-sm ${colors}`}>
      {text || status}
    </span>
  );
}
