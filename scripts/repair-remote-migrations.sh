#!/usr/bin/env bash
# Mark all remote-only migration versions as reverted so we can push our local migrations.
# Run from project root: ./scripts/repair-remote-migrations.sh

set -e
cd "$(dirname "$0")/.."

VERSIONS="20250605031406 20250605031654 20250605031919 20250605031956 20250605032124 20250605033016 20250605033604 20250605033639 20250605035201 20250605054418 20250605061449 20250605061528 20250605062904 20250605064232 20250605120911 20250605121423 20250605122216 20250605125416 20250605125428 20250606073647 20250606073806 20250606073857 20250606073946 20250606074704 20250606074928 20250606075024 20250606080540 20250606080755 20250606081607 20250606083907 20250615073111 20250615091047 20250615091049 20250615115109 20250615115111 20250619010928 20250619074052 20250619075715 20250619075901 20250619080013 20250619080027 20250619082420 20250619113835 20250619114004 20250619114127 20250619114256 20250619114342 20250619114502 20250619114621 20250619114739 20250619115819 20250619115944 20250619120120 20250619120241 20250619120345 20250619120514 20250619120650 20250619120725 20250619120737 20250619120751 20250619120803 20250619121318 20250619121411 20250619121521 20250619121538 20250619121635 20250619121649 20250619121821 20250619121912 20250619122028 20250619122156 20250619122336 20250619122349 20250619122440 20250619122450 20250619122609 20250619122700 20250619122817 20250619123341 20250619123418 20250619123555 20250619123624 20250623020657 20250623045550 20250623094528 20250625111455 20250625111456 20250625112330 20250625112331 20250625112812 20250625112813 20250626080823 20250626080832 20250626081343 20250626081344 20250626081416 20250629012700 20250629015652 20250629020156 20250630090119 20250701045937 20250701114652 20250701114844 20250701114855 20250701114906 20250702013243 20250702013257 20250702013309 20250702013321 20250702013331 20250702013344 20250702013353 20250702013402 20250702013420 20250702013429 20250702013435 20250702013443 20250702013652 20250702013705 20250702013717 20250702013730 20250702013742 20250702013748 20250702013756 20250702013807 20250702013812 20250702013821 20250702013835 20250702013843 20250702013854 20250702013916 20250702013928 20250702013938 20250702121934 20250702121938 20250702121939 20250713100812 20250713101150 20250713101251 20250713101831 20250713102213 20250713104028 20250713104410 20250714083029 20250714083031 20250714094006 20250714094416 20250714094458 20250714094543 20250714094649 20250714094722 20250714094758 20250714094839 20250714094915 20250714094943 20250714095600 20250809101027 20250809101505 20250809104713 20250809110011 20250809112258 20250809112302 20250810015004 20250810015014 20250810015441 20250811102144 20250811102204 20250811102215 20250811102219 20250811102224 20250811102232 20250811102236 20250811102241 20250811102248 20250811102251 20250811102258 20250811102301 20250811102323 20250811102339 20250811102414 20250811103327 20250811103338 20250811103345 20250811103350 20250812083331 20250812084158 20250812094653 20250812094710 20250813104410 20250911053937 20250911053943 20250911053951 20250911053957 20250911054005 20250911054014 20250911054026 20250911054036 20250911054055 20250911054423 20250911061919 20250911062156 20250911062621 20250911062635 20250915041305 20250915041826 20250917031439 20250917031501 20250917032028 20250922105431 20251011012859 20251011115703 20251011115708 20251011115714 20251011115720 20251013050143 20251013050151 20251013050201 20251013050212 20251013082010 20251013115712 20251013115957 20251014120132 20251022150329 20251022150333 20251022150337 20251022150340 20251022150344 20251022150349 20251022150411 20251022152642 20251022152949 20251022153124 20251022170549 20251023004957 20251023005002 20251023005020 20251023212930 20251023212938 20251023212947 20251023213007 20251023213041 20251023213056 20251023213109 20251023213228 20251023213248 20251023213653 20251023213724 20251023213733 20251023213746 20251023231437 20251024001450 20251024180021 20251024234025 20251024234108 20251024234113 20251024234141 20251024234208 20251024234357 20251024234553 20251024235534 20251025224255 20251026004230 20251026004433 20251026150122 20251030165325 20251030165327 20251030171054 20251107202513 20251107215916 20251107220120 20251107222708 20251108202926 20251108212004 20251108224117 20251109230800 20251113154826 20251113170316 20251113170322 20251114145102 20251114162350 20251114191832 20251124213714 20251201172213 20251212132921 20260207214025"

count=0
for v in $VERSIONS; do
  npx supabase migration repair --status reverted "$v" 2>/dev/null || true
  count=$((count + 1))
  [ $((count % 50)) -eq 0 ] && echo "Repaired $count versions..."
done
echo "Repaired $count versions. Running db push..."
npx supabase db push
